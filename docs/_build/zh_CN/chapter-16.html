

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>高级主题和示例 &mdash; py4web 20251209 文档</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/css/toggle.css?v=029c1802" />

  
    <link rel="shortcut icon" href="_static/logo-32x32.ico"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=96e44453"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/translations.js?v=beaddf03"></script>
      <script src="_static/js/toggle.js?v=e1b5a5a1"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="prev" title="从 web2py 迁移到 py4web" href="chapter-15.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            py4web
              <img src="_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">目录</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="chapter-01.html">py4web 是什么？</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-02.html">帮助、资源和提示</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-03.html">安装和启动</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-04.html">Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-05.html">创建一个应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-06.html">夹具（Fixture）</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-07.html">数据库抽象层（DAL）</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-08.html">RestAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-09.html">YATL 模板语言</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-10.html">YATL 中的助手（helpers）</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-11.html">国际化</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-12.html">表单（Forms）</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-13.html">身份验证与授权</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-14.html">表格（Grid）</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-15.html">从 web2py 迁移到 py4web</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">高级主题和示例</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-scheduler">调度程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sending-messages-using-a-background-task">使用后台任务发送消息</a></li>
<li class="toctree-l2"><a class="reference internal" href="#celery">Celery</a></li>
<li class="toctree-l2"><a class="reference internal" href="#py4web-and-asyncio">py4web 和 asyncio</a></li>
<li class="toctree-l2"><a class="reference internal" href="#htmx">htmx</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#htmx-usage-in-form">表单中 htmx 的用法</a></li>
<li class="toctree-l3"><a class="reference internal" href="#htmx-usage-in-grid">在 Grid 中使用 htmlx</a></li>
<li class="toctree-l3"><a class="reference internal" href="#autocomplete-widget-using-htmx">使用 htmx 的自动完成小部件</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#utils-js">utils.js</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#string-format">string.format</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-q-object">Q 对象</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-t-object">T 对象</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#adding-a-captcha-solution-with-altcha">使用 Altcha 添加验证码的解决方案</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#prerequisites">先决条件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#controller-logic">控制器逻辑</a></li>
<li class="toctree-l3"><a class="reference internal" href="#view-templates">视图模板</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#form-altcha-html"><code class="docutils literal notranslate"><span class="pre">form_altcha.html</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#custom-auth-form">自定义 Auth Form</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">py4web</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">高级主题和示例</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/web2py/py4web/blob/master/docs/chapter-16.rst" class="fa fa-github"> 在 GitHub 上编辑</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="advanced-topics-and-examples">
<h1>高级主题和示例<a class="headerlink" href="#advanced-topics-and-examples" title="Link to this heading"></a></h1>
<section id="the-scheduler">
<h2>调度程序<a class="headerlink" href="#the-scheduler" title="Link to this heading"></a></h2>
<p>Py4web 有一个内置的调度程序。您无需安装或配置任何东西就能使其工作。</p>
<p>给定一个任务（只是一个 python 函数），您可以安排该函数的异步运行。运行可以是一次性的，也可以是周期性的。他们可以因超时而停止。它们可以被安排在给定的预定时间运行。</p>
<p>调度器通过创建表 <code class="docutils literal notranslate"><span class="pre">task_run</span></code> 并将预定义任务的运行作为表记录排队来工作。每个 <code class="docutils literal notranslate"><span class="pre">task_run</span></code> 都引用一个任务，并包含要传递给该任务的输入。调度程序将在 <code class="docutils literal notranslate"><span class="pre">db.task_run.log</span></code> 中保存捕获到的任务的 stdout + stderr，并在 <code class="docutils literal notranslate"><span class="pre">db.task_run.output</span></code> 中保存捕获到的任务输出。</p>
<p>py4web 线程循环并找到下一个需要执行的任务。对于每个任务，它都会创建一个工作进程，并将任务分配给该工作进程。您可以指定应同时运行多少个工作进程。工作进程是守护进程，它们只在一个任务运行的生命周期内存在。每个工作进程只负责单独执行一个任务。主循环负责分配任务和超时。</p>
<p>该系统非常强大，因为唯一的真实来源是数据库，其完整性由事务安全保证。即使 py4web 被终止，正在运行的任务也会继续运行，除非它们完成、失败或被明确终止。</p>
<p>除了允许在一个节点上执行多个并发任务外，还可以在不同的计算节点上运行调度器的多个实例，只要它们对 <code class="docutils literal notranslate"><span class="pre">task_run</span></code> 使用相同的客户端/服务器数据库，并且它们都定义了相同的任务。</p>
<p>以下是一个如何使用调度器的示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pydal.tools.scheduler</span><span class="w"> </span><span class="kn">import</span> <span class="n">Scheduler</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">now</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>

<span class="c1"># create and start the scheduler</span>
<span class="n">scheduler</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">sleep_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_concurrent_runs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">scheduler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="c1"># register your tasks</span>
<span class="n">scheduler</span><span class="o">.</span><span class="n">register_task</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">inputs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hi!&quot;</span><span class="p">))</span>
<span class="n">scheduler</span><span class="o">.</span><span class="n">register_task</span><span class="p">(</span><span class="s2">&quot;slow&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">scheduler</span><span class="o">.</span><span class="n">register_task</span><span class="p">(</span><span class="s2">&quot;periodic&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">inputs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I am periodic!&quot;</span><span class="p">))</span>
<span class="n">scheduler</span><span class="o">.</span><span class="n">register_task</span><span class="p">(</span><span class="s2">&quot;fail&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">x</span><span class="p">)</span>

<span class="c1"># enqueue some task runs:</span>

<span class="n">scheduler</span><span class="o">.</span><span class="n">enqueue_run</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
<span class="n">scheduler</span><span class="o">.</span><span class="n">enqueue_run</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="n">scheduled_for</span><span class="o">=</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">delta</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># start in 10 secs</span>
<span class="n">scheduler</span><span class="o">.</span><span class="n">enqueue_run</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;slow&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 1 secs</span>
<span class="n">scheduler</span><span class="o">.</span><span class="n">enqueue_run</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;periodic&quot;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># 10 secs</span>
<span class="n">scheduler</span><span class="o">.</span><span class="n">enqueue_run</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;fail&quot;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
</pre></div>
</div>
<p>请注意，在 scaffolding 应用程序中，如果 <code class="docutils literal notranslate"><span class="pre">settings.py</span></code> 中的 <code class="docutils literal notranslate"><span class="pre">USE_SCHEDULER=True</span></code> ，则会创建并启动调度器。</p>
<p>您可以通过后台管理应用程序或使用 <code class="docutils literal notranslate"><span class="pre">Grid(db.task_run)</span></code> 来管理任务运行。</p>
<p>为了防止数据库锁（特别是 sqlite），我们建议：</p>
<ul class="simple">
<li><p>为调度程序和其他所有内容使用不同的数据库</p></li>
<li><p>每次插入/更新/删除后，都要尽快执行 <code class="docutils literal notranslate"><span class="pre">db.commit()</span></code></p></li>
<li><p>尝试将任务中的数据库逻辑打包到 <code class="docutils literal notranslate"><span class="pre">try...except</span></code> 语句块中，如下：</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">my_task</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># do something</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="sending-messages-using-a-background-task">
<h2>使用后台任务发送消息<a class="headerlink" href="#sending-messages-using-a-background-task" title="Link to this heading"></a></h2>
<p>作为上述应用的一个示例，考虑希望从后台任务异步发送电子邮件的情况。在这个例子中，我们使用 Twilio 的 SendGrid 发送它们 (<a class="reference external" href="https://www.twilio.com/docs/sendgrid/for-developers/sending-email/quickstart-python">https://www.twilio.com/docs/sendgrid/for-developers/sending-email/quickstart-python</a>) 。</p>
<p>以下是发送电子邮件的可能调度任务：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sendgrid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sendgrid.helpers.mail</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mail</span><span class="p">,</span> <span class="n">Email</span><span class="p">,</span> <span class="n">To</span><span class="p">,</span> <span class="n">Content</span>

<span class="k">def</span><span class="w"> </span><span class="nf">sendmail_task</span><span class="p">(</span><span class="n">from_addr</span><span class="p">,</span> <span class="n">to_addrs</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="s2">&quot;&quot;</span>
    <span class="c1"># build the messages using sendgrid API</span>
    <span class="n">from_email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">from_addr</span><span class="p">)</span>  <span class="c1"># Must be your verified sender</span>
    <span class="n">content_type</span> <span class="o">=</span> <span class="s2">&quot;text/plain&quot;</span> <span class="k">if</span> <span class="n">body</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&lt;html&gt;&quot;</span> <span class="k">else</span> <span class="s2">&quot;text/html&quot;</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">Content</span><span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="n">Mail</span><span class="p">(</span><span class="n">from_email</span><span class="p">,</span> <span class="n">To</span><span class="p">(</span><span class="n">to_addrs</span><span class="p">),</span> <span class="n">subject</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="c1"># ask sendgrid to deliver it</span>
    <span class="n">sg</span> <span class="o">=</span> <span class="n">sendgrid</span><span class="o">.</span><span class="n">SendGridAPIClient</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">SENDGRID_API_KEY</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">sg</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">request_body</span><span class="o">=</span><span class="n">mail</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
    <span class="c1"># check if worked</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="s2">&quot;200&quot;</span>

<span class="c1"># register the above task with the scheduler</span>
<span class="n">scheduler</span><span class="o">.</span><span class="n">register_task</span><span class="p">(</span><span class="s2">&quot;sendmail&quot;</span><span class="p">,</span> <span class="n">sendmail_task</span><span class="p">)</span>
</pre></div>
</div>
<p>要安排发送新电子邮件，请执行以下操作：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">email</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;from_addr&quot;</span><span class="p">:</span> <span class="s2">&quot;me@example.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;to_addrs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;me@example.com&quot;</span><span class="p">],</span>
    <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello World&quot;</span><span class="p">,</span>
    <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;I am alive!&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">scheduler</span><span class="o">.</span><span class="n">enqueue_run</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;sendmail&quot;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">scheduled_for</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>电子邮件表示中的 key:value 必须与任务的参数匹配。 <code class="docutils literal notranslate"><span class="pre">scheduled_for</span></code> 参数是可选的，允许您指定何时发送电子邮件。您可以使 Dashboard 查看名为 <code class="docutils literal notranslate"><span class="pre">sendmail</span></code> 的任务的 <code class="docutils literal notranslate"><span class="pre">task_run</span></code>  状态。</p>
<p>您还可以告诉 auth 利用上述机制发送电子邮件：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MySendGridSender</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_addr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_addr</span> <span class="o">=</span> <span class="n">from_adds</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_addr</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="n">email</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;from_addr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_addr</span><span class="p">,</span>
            <span class="s2">&quot;to_addrs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">to_addr</span><span class="p">],</span>
            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="n">subject</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">body</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">scheduler</span><span class="o">.</span><span class="n">enqueue_run</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;sendmail&quot;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>

<span class="n">auth</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="n">MySendGridSender</span><span class="p">(</span><span class="n">from_addr</span><span class="o">=</span><span class="s2">&quot;me@example.com&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>您也可以告诉 auth 访问上述机制。通过上述操作，auth 将不会使用 smtplib 发送电子邮件。相反，它将使用调度程序通过 SendGrid 发送它们。请注意，这里唯一的要求是 <code class="docutils literal notranslate"><span class="pre">auth.sender</span></code> 必须是一个具有与示例中相同签名的 <code class="docutils literal notranslate"><span class="pre">send</span></code> 法的对象。</p>
<p>请注意，也可以发送短信而不是电子邮件，但这需要 1）将电话号码存储在 <code class="docutils literal notranslate"><span class="pre">auth_user</span></code> 中，2）覆盖发送电子邮件的 <code class="docutils literal notranslate"><span class="pre">Auth.send</span></code> 方法：</p>
</section>
<section id="celery">
<h2>Celery<a class="headerlink" href="#celery" title="Link to this heading"></a></h2>
<p>对。您可以使用 Celery 来代替内置调度程序，但它增加了复杂性，而且不那么健壮。然而，内置调度器是为长时间运行的任务而设计的，如果您有数百个任务同时运行，数据库可能会成为瓶颈。如果您有 100 多个并发任务，而且它们是短时间运行的任务，Celery 可能会工作地更好。</p>
</section>
<section id="py4web-and-asyncio">
<h2>py4web 和 asyncio<a class="headerlink" href="#py4web-and-asyncio" title="Link to this heading"></a></h2>
<p>Asyncio 不是严格需要的，至少在大多数正常用例中，由于其并发模型，它会增加问题而不是价值。另一方面，我们认为 py4web 需要一个内置的基于 websocket 异步的解决方案。</p>
<p>如果您打算使用 asyncio ，请注意您还应该处理框架的所有组件：特别是 pydal 不符合 asyncio ，因为并非所有适配器都支持 async。</p>
</section>
<section id="htmx">
<h2>htmx<a class="headerlink" href="#htmx" title="Link to this heading"></a></h2>
<p>目前有许多 javascript 前端框架可供选择 ， 它们使您在设计 web 客户端方面具有极大的灵活性。Vue 、React 和 Angular 只是其中的几个。然而，构建这些系统之一的复杂性阻碍了许多开发人员获得这些好处。再加上生态系统的快速变化，你很快就会拥有一个在一两年后难以维护的应用程序。</p>
<p>因此，越来越需要使用简单的 html 元素来增加网页的交互性。htmx 是在没有 javascript 复杂性的情况下成为页面交互性领导者的工具之一。从技术上讲，htmx 允许您使用属性直接在 HTML 中访问 AJAX 、CSS 转换、Web 套接字和服务器发送事件，因此您可以使用简单性且强大功能的超文本构建现代用户界面。 <a class="reference internal" href="#cit1601" id="id1"><span>[CIT1601]</span></a></p>
<p>在官方网站上阅读有关 htmx 及其功能的所有信息，网址为 <a class="reference external" href="https://htmx.org">https://htmx.org</a> 。如果你愿意，还有一个视频教程： <a class="reference external" href="https://www.youtube.com/watch?v=cBfz4W_KvEI">Simple, Fast Frontends With htmx</a> 。</p>
<p>py4web 通过多种方式支持 htmx 集成。</p>
<ol class="arabic simple">
<li><p>允许您将 htmx 属性添加到表单和按钮中</p></li>
<li><p>包含一个用于 py4web 网格的 htmx 属性插件</p></li>
</ol>
<section id="htmx-usage-in-form">
<h3>表单中 htmx 的用法<a class="headerlink" href="#htmx-usage-in-form" title="Link to this heading"></a></h3>
<p>py4web Form 类允许您将 **kwargs 传递给它，这些 kwargs 将作为属性传递给 html 表单。例如，要将 hx-post 和 hx-target 添加到 &lt;form&gt; 元素中，您将使用：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;_hx-post&quot;</span><span class="p">:</span> <span class="n">URL</span><span class="p">(</span><span class="s2">&quot;url_to_post_to/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">record_id</span><span class="p">),</span>
    <span class="s2">&quot;_hx-target&quot;</span><span class="p">:</span> <span class="s2">&quot;#detail-target&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span>
    <span class="n">db</span><span class="o">.</span><span class="n">tablename</span><span class="p">,</span>
    <span class="n">record</span><span class="o">=</span><span class="n">record_id</span><span class="p">,</span>
    <span class="o">**</span><span class="n">attrs</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>现在，当您的表单被提交时，它将调用 hx-post 属性中的 URL，返回给浏览器的任何内容都将用来替换 id 是 “detail-target” 的元素内的 html。</p>
<p>让我们继续一个完整的例子（从 scaffold 开始）。</p>
<p><strong>controllers.py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>

<span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;htmx_form_demo&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="s2">&quot;htmx_form_demo.html&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">htmx_form_demo</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>


<span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;htmx_list&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="s2">&quot;htmx_list.html&quot;</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">htmx_list</span><span class="p">():</span>
    <span class="n">superheros</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">superhero</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">superheros</span><span class="o">=</span><span class="n">superheros</span><span class="p">)</span>


<span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;htmx_form/&lt;record_id&gt;&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="s2">&quot;htmx_form.html&quot;</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">htmx_form</span><span class="p">(</span><span class="n">record_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;_hx-post&quot;</span><span class="p">:</span> <span class="n">URL</span><span class="p">(</span><span class="s2">&quot;htmx_form/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">record_id</span><span class="p">),</span>
        <span class="s2">&quot;_hx-target&quot;</span><span class="p">:</span> <span class="s2">&quot;#htmx-form-demo&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">superhero</span><span class="p">,</span> <span class="n">record</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">superhero</span><span class="p">(</span><span class="n">record_id</span><span class="p">),</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
        <span class="n">redirect</span><span class="p">(</span><span class="n">URL</span><span class="p">(</span><span class="s2">&quot;htmx_list&quot;</span><span class="p">))</span>

    <span class="n">cancel_attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;_hx-get&quot;</span><span class="p">:</span> <span class="n">URL</span><span class="p">(</span><span class="s2">&quot;htmx_list&quot;</span><span class="p">),</span>
        <span class="s2">&quot;_hx-target&quot;</span><span class="p">:</span> <span class="s2">&quot;#htmx-form-demo&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">form</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">sidecar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="s2">&quot;Cancel&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">cancel_attrs</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>templates/htmx_form_demo.html</strong></p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>[[extend &#39;layout.html&#39;]]

[[=timestamp]]
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;htmx-form-demo&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">hx-get</span><span class="o">=</span><span class="s">&quot;[[=URL(&#39;htmx_list&#39;)]]&quot;</span> <span class="na">hx-trigger</span><span class="o">=</span><span class="s">&quot;load&quot;</span> <span class="na">hx-target</span><span class="o">=</span><span class="s">&quot;#htmx-form-demo&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://unpkg.com/htmx.org@1.3.2&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>
</div>
<p><strong>templates/htmx_list.html</strong></p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
[[for sh in superheros:]]
    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">hx-get</span><span class="o">=</span><span class="s">&quot;[[=URL(&#39;htmx_form/%s&#39; % sh.id)]]&quot;</span> <span class="na">hx-target</span><span class="o">=</span><span class="s">&quot;#htmx-form-demo&quot;</span><span class="p">&gt;</span>[[=sh.name]]<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
[[pass]]
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</pre></div>
</div>
<p><strong>templates/htmx_form.html</strong></p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>[[=form]]
</pre></div>
</div>
<p>我们现在有一个功能强大的维护应用程序来更新我们的 superheros 。在浏览器中导航到新应用程序中的 htmx_form_demo 页面。在 htmx_form_demo.html 页面内的 div 中，hx-trigger=&quot;load&quot; 属性会在 htmx_form_demo 页面加载完成后，将 htmx_list.html 页面加载到 htmx-form-demo 这个 DIV 元素中。</p>
<p>请注意，在  htmx-form-demo 这个 DIV 元素之外添加的时间戳在页面进行过渡（交互）时不会改变。这是因为外部页面永远不会重新加载，只会重新加载 htmx-form-demo 这个 DIV 元素中的内容。</p>
<p>然后，在锚点标签上使用 htmx 的属性 hx-get 和 hx-target 来调用 htmx_form 页面，以将表单加载到 htmx-form-demo 这个 DIV 元素中。</p>
<p>到目前为止，我们刚刚看到了标准的 htmx 处理。这里没有什么花哨的东西，也没有什么特定于 py4web 的东西。然而，在 htmx_form 方法中，我们看到了如何将任何属性传递给 py4web 表单，当我们添加 hx-post 和 hx-target 时，该表单将在 &lt;form&gt; 元素上呈现。这告诉表单允许 htmx 覆盖默认表单行为，并在指定的目标中呈现结果输出。</p>
<p>默认的 py4web 表单不包含取消按钮，以防您想取消编辑表单。但您可以在表单中添加 “sidecar” 元素。您可以在 htmx_form 中看到，我们添加了一个 cancel 选项并添加了所需的 htmx 属性，以确保 htmx_list 页面呈现在 htmx-form-demo DIV 中。</p>
</section>
<section id="htmx-usage-in-grid">
<h3>在 Grid 中使用 htmlx<a class="headerlink" href="#htmx-usage-in-grid" title="Link to this heading"></a></h3>
<p>py4web 的 grid 提供了一个属性插件系统，允许您构建插件，为表单元素、锚元素或确认消息提供自定义属性。py4web 还提供了一个专门针对 htmx 的属性插件。</p>
<p>这是一个基于前面的 htmx 表单示例构建的示例。</p>
<p><strong>controller.py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;htmx_form/&lt;record_id&gt;&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="s2">&quot;htmx_form.html&quot;</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">htmx_form</span><span class="p">(</span><span class="n">record_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;_hx-post&quot;</span><span class="p">:</span> <span class="n">URL</span><span class="p">(</span><span class="s2">&quot;htmx_form/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">record_id</span><span class="p">),</span>
        <span class="s2">&quot;_hx-target&quot;</span><span class="p">:</span> <span class="s2">&quot;#htmx-form-demo&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">superhero</span><span class="p">,</span> <span class="n">record</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">superhero</span><span class="p">(</span><span class="n">record_id</span><span class="p">),</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
        <span class="n">redirect</span><span class="p">(</span><span class="n">URL</span><span class="p">(</span><span class="s2">&quot;htmx_list&quot;</span><span class="p">))</span>

    <span class="n">cancel_attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;_hx-get&quot;</span><span class="p">:</span> <span class="n">URL</span><span class="p">(</span><span class="s2">&quot;htmx_list&quot;</span><span class="p">),</span>
        <span class="s2">&quot;_hx-target&quot;</span><span class="p">:</span> <span class="s2">&quot;#htmx-form-demo&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">form</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">sidecar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="s2">&quot;Cancel&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">cancel_attrs</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

<span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;htmx_grid&quot;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span> <span class="s2">&quot;htmx_grid.html&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">htmx_grid</span><span class="p">():</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">Grid</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">superhero</span><span class="p">,</span> <span class="n">auto_process</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">grid</span><span class="o">.</span><span class="n">attributes_plugin</span> <span class="o">=</span> <span class="n">AttributesPluginHtmx</span><span class="p">(</span><span class="s2">&quot;#htmx-grid-demo&quot;</span><span class="p">)</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;_hx-get&quot;</span><span class="p">:</span> <span class="n">URL</span><span class="p">(</span>
            <span class="s2">&quot;htmx_grid&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="s2">&quot;_hx-target&quot;</span><span class="p">:</span> <span class="s2">&quot;#htmx-grid-demo&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">new_sidecar</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="s2">&quot;Cancel&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">edit_sidecar</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="s2">&quot;Cancel&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>

    <span class="n">grid</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>templates/htmx_form_demo.html</strong></p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>[[extend &#39;layout.html&#39;]]

[[=timestamp]]
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;htmx-form-demo&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">hx-get</span><span class="o">=</span><span class="s">&quot;[[=URL(&#39;htmx_list&#39;)]]&quot;</span> <span class="na">hx-trigger</span><span class="o">=</span><span class="s">&quot;load&quot;</span> <span class="na">hx-target</span><span class="o">=</span><span class="s">&quot;#htmx-form-demo&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;htmx-grid-demo&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">hx-get</span><span class="o">=</span><span class="s">&quot;[[=URL(&#39;htmx_grid&#39;)]]&quot;</span> <span class="na">hx-trigger</span><span class="o">=</span><span class="s">&quot;load&quot;</span> <span class="na">hx-target</span><span class="o">=</span><span class="s">&quot;#htmx-grid-demo&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://unpkg.com/htmx.org@1.3.2&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>注意，我们添加了 id 是 htmx-grid-demo 的 DIV ，其内部调用了 htmx_grid 路由。</p>
<p><strong>templates/htmx_grid.html</strong></p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>[[=grid.render()]]
</pre></div>
</div>
<p>在 htmx_grid 中，我们利用了 grid 上的延迟处理。我们设置了一个标准的 CRUD grid，延迟处理，然后告诉 grid 我们将使用一个替代属性插件来构建我们的导航。现在表单、链接和删除确认都由 htmx 处理。</p>
</section>
<section id="autocomplete-widget-using-htmx">
<h3>使用 htmx 的自动完成小部件<a class="headerlink" href="#autocomplete-widget-using-htmx" title="Link to this heading"></a></h3>
<p>htmx 不仅可以用于 form/grid 格处理。在这个例子中，我们将利用 htmx 和 py4web 表单小部件来构建一个可以在表单中使用的自动补全小部件。 <em>注意：这只是一个示例，py4web 中没有此代码</em></p>
<p>我们将再次使用示例应用程序中定义的 superheros 数据库。</p>
<p>将以下内容添加到你的 controllers.py 中。这段代码将构建你的自动完成下拉菜单，并处理数据库调用以获取数据。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">reduce</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">yatl</span><span class="w"> </span><span class="kn">import</span> <span class="n">DIV</span><span class="p">,</span> <span class="n">INPUT</span><span class="p">,</span> <span class="n">SCRIPT</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">py4web</span><span class="w"> </span><span class="kn">import</span> <span class="n">action</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">URL</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..common</span><span class="w"> </span><span class="kn">import</span> <span class="n">session</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">auth</span>


<span class="nd">@action</span><span class="p">(</span>
    <span class="s2">&quot;htmx/autocomplete&quot;</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span>
    <span class="s2">&quot;htmx/autocomplete.html&quot;</span><span class="p">,</span>
    <span class="n">session</span><span class="p">,</span>
    <span class="n">db</span><span class="p">,</span>
    <span class="n">auth</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">autocomplete</span><span class="p">():</span>
    <span class="n">tablename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">tablename</span>
    <span class="n">fieldname</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fieldname</span>
    <span class="n">autocomplete_query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">query</span>

    <span class="n">field</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">tablename</span><span class="p">][</span><span class="n">fieldname</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">fk_table</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">requires</span><span class="p">:</span>
        <span class="n">fk_table</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">requires</span><span class="o">.</span><span class="n">ktable</span>
        <span class="n">fk_field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">requires</span><span class="o">.</span><span class="n">kfield</span>

        <span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;_autocomplete_search_fields&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sf</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">_autocomplete_search_fields</span><span class="p">:</span>
                <span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">db</span><span class="p">[</span><span class="n">fk_table</span><span class="p">][</span><span class="n">sf</span><span class="p">]</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span>
                        <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tablename</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">fieldname</span><span class="si">}</span><span class="s2">_search&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span> <span class="o">|</span> <span class="n">b</span><span class="p">),</span> <span class="n">queries</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="n">fk_table</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">]:</span>
                    <span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">db</span><span class="p">[</span><span class="n">fk_table</span><span class="p">][</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span>
                            <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tablename</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">fieldname</span><span class="si">}</span><span class="s2">_search&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="n">query</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span> <span class="o">|</span> <span class="n">b</span><span class="p">),</span> <span class="n">queries</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">queries</span> <span class="o">=</span> <span class="p">[</span><span class="n">db</span><span class="p">[</span><span class="n">fk_table</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">b</span><span class="p">),</span> <span class="n">queries</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">autocomplete_query</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">b</span><span class="p">),</span> <span class="p">[</span><span class="n">autocomplete_query</span><span class="p">,</span> <span class="n">query</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">orderby</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">requires</span><span class="o">.</span><span class="n">orderby</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="n">tablename</span><span class="o">=</span><span class="n">tablename</span><span class="p">,</span>
        <span class="n">fieldname</span><span class="o">=</span><span class="n">fieldname</span><span class="p">,</span>
        <span class="n">fk_table</span><span class="o">=</span><span class="n">fk_table</span><span class="p">,</span>
        <span class="n">data_label</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">requires</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
    <span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">HtmxAutocompleteWidget</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simple_query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">simple_query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="k">if</span> <span class="n">url</span> <span class="k">else</span> <span class="n">URL</span><span class="p">(</span><span class="s2">&quot;htmx/autocomplete&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;simple_query&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1">#  TODO: handle readonly parameter</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">DIV</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;_table&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
            <span class="n">tablename</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">_table</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tablename</span> <span class="o">=</span> <span class="s2">&quot;no_table&quot;</span>

        <span class="c1">#  build the div-hidden input field to hold the value</span>
        <span class="n">hidden_input</span> <span class="o">=</span> <span class="n">INPUT</span><span class="p">(</span>
            <span class="n">_type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
            <span class="n">_id</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="n">_name</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">_value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">hidden_div</span> <span class="o">=</span> <span class="n">DIV</span><span class="p">(</span><span class="n">hidden_input</span><span class="p">,</span> <span class="n">_style</span><span class="o">=</span><span class="s2">&quot;display: none;&quot;</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hidden_div</span><span class="p">)</span>

        <span class="c1">#  build the input field to accept the text</span>

        <span class="c1">#  set the htmx attributes</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;tablename&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">tablename</span><span class="p">),</span>
            <span class="s2">&quot;fieldname&quot;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;_hx-post&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
            <span class="s2">&quot;_hx-trigger&quot;</span><span class="p">:</span> <span class="s2">&quot;keyup changed delay:500ms&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_hx-target&quot;</span><span class="p">:</span> <span class="s2">&quot;#</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">_autocomplete_results&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="s2">&quot;_hx-indicator&quot;</span><span class="p">:</span> <span class="s2">&quot;.htmx-indicator&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_hx-vals&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">search_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">requires</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">requires</span><span class="o">.</span><span class="n">ktable</span><span class="p">][</span><span class="n">field</span><span class="o">.</span><span class="n">requires</span><span class="o">.</span><span class="n">kfield</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">()</span>
                <span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
                <span class="n">search_value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">requires</span><span class="o">.</span><span class="n">label</span> <span class="o">%</span> <span class="n">row</span>

        <span class="n">control</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">INPUT</span><span class="p">(</span>
                <span class="n">_type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
                <span class="n">_id</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">_search&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                <span class="n">_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">_search&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                <span class="n">_value</span><span class="o">=</span><span class="n">search_value</span><span class="p">,</span>
                <span class="n">_class</span><span class="o">=</span><span class="s2">&quot;input&quot;</span><span class="p">,</span>
                <span class="n">_placeholder</span><span class="o">=</span><span class="n">placeholder</span> <span class="k">if</span> <span class="n">placeholder</span> <span class="ow">and</span> <span class="n">placeholder</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span>
                <span class="n">_title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                <span class="n">_autocomplete</span><span class="o">=</span><span class="s2">&quot;off&quot;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">attrs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">control</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DIV</span><span class="p">(</span><span class="n">_id</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">_autocomplete_results&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>

        <span class="n">control</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">SCRIPT</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        htmx.onLoad(function(elt) {</span>
<span class="sd">            document.querySelector(&#39;#%(table)s_%(field)s_search&#39;).onkeydown = check_%(table)s_%(field)s_down_key;</span>
<span class="sd">            \n</span>
<span class="sd">            function check_%(table)s_%(field)s_down_key(e) {</span>
<span class="sd">                if (e.keyCode == &#39;40&#39;) {</span>
<span class="sd">                    document.querySelector(&#39;#%(table)s_%(field)s_autocomplete&#39;).focus();</span>
<span class="sd">                    document.querySelector(&#39;#%(table)s_%(field)s_autocomplete&#39;).selectedIndex = 0;</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        })</span>
<span class="sd">            &quot;&quot;&quot;</span>
                <span class="o">%</span> <span class="p">{</span>
                    <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="n">tablename</span><span class="p">,</span>
                    <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">control</span>
</pre></div>
</div>
<p>用法 - 在控制器代码中，此示例使用 bulma 作为基本的 css 格式化程序。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">formstyle</span> <span class="o">=</span> <span class="n">FormStyleFactory</span><span class="p">()</span>
<span class="n">formstyle</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="n">FormStyleBulma</span><span class="o">.</span><span class="n">classes</span>
<span class="n">formstyle</span><span class="o">.</span><span class="n">class_inner_exceptions</span> <span class="o">=</span> <span class="n">FormStyleBulma</span><span class="o">.</span><span class="n">class_inner_exceptions</span>
<span class="n">formstyle</span><span class="o">.</span><span class="n">widgets</span><span class="p">[</span><span class="s2">&quot;vendor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">HtmxAutocompleteWidget</span><span class="p">(</span>
    <span class="n">simple_query</span><span class="o">=</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">vendor</span><span class="o">.</span><span class="n">vendor_type</span> <span class="o">==</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span>
    <span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="p">,</span>
    <span class="n">record</span><span class="o">=</span><span class="n">product_record</span><span class="p">,</span>  <span class="c1"># defined earlier in controller</span>
    <span class="n">formstyle</span><span class="o">=</span><span class="n">formstyle</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>首先，获取 FormStyleFactory 的实例。然后从您想要的任何 css 框架中获取基本的 css 类。在 css 框架中添加类内部异常。设置好后，您可以根据字段的名称覆盖字段的默认小部件。在这种情况下，我们将覆盖 “vendor” 字段的小部件。我们没有将所有 vendors 都包含在选择下拉列表中，而是仅限于其类型等于 “S” 的供应商。</p>
<p>当这在您的页面中呈现时，vendor 字段的默认小部件将被 HtmxAutocompleteWidget 生成的小部件替换。当您向 HtmxAutocompleteWidget 传递一个简单的查询时，该小部件将通过默认路由使用数据填充下拉列表。</p>
<p>如果使用简单查询和默认构建的 url ，则仅限于简单的 DAL 查询。您不能在此简单查询中使用 DAL 子查询。如果下拉列表的数据需要更复杂的 DAL 查询，您可以覆盖默认的数据构建器 URL ，以提供自己的控制器函数来检索数据。</p>
<div role="list" class="citation-list">
<div class="citation" id="cit1601" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">CIT1601</a><span class="fn-bracket">]</span></span>
<p>来自 <a class="reference external" href="https://htmx.org">https://htmx.org</a> 网站</p>
</div>
</div>
</section>
</section>
<section id="utils-js">
<h2>utils.js<a class="headerlink" href="#utils-js" title="Link to this heading"></a></h2>
<p>在本文档中，我们多次提到 scaffolding 应用程序附带的 utils.js，但我们从未明确列出其中的内容。所以，在这里说明。</p>
<section id="string-format">
<h3>string.format<a class="headerlink" href="#string-format" title="Link to this heading"></a></h3>
<p>它扩展了 String 对象原型，允许这样的表达式：</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hello {name}&quot;</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">name</span><span class="o">=</span><span class="s2">&quot;Max&quot;</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="the-q-object">
<h3>Q 对象<a class="headerlink" href="#the-q-object" title="Link to this heading"></a></h3>
<p>Q 对象可以像支持 jQuery 语法的选择器一样使用：</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">element</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Q</span><span class="p">(</span><span class="s2">&quot;#element-id&quot;</span><span class="p">)[</span><span class="mf">0</span><span class="p">];</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">selected_elements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Q</span><span class="p">(</span><span class="s2">&quot;.element-class&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>它支持与 JS <code class="docutils literal notranslate"><span class="pre">querySelectorAll</span></code>  相同的语法，并且始终返回选定元素的数组（可以为空）。</p>
<p>Q 对象也是函数的容器，在 Javascript 编程时非常有用。它是无状态的</p>
<p>例如：</p>
<p><strong>Q.clone</strong></p>
<p>克隆任何对象的函数：</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nx">any</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">}</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Q</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>Q.eval</strong></p>
<p>它计算字符串中的 JS 表达式。它不是沙盒。</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Q</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;2+3+Math.random()&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>Q.ajax</strong></p>
<p>JS fetch 方法的包装器，提供了更好的语法：</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;custom-header-name&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;value&#39;</span><span class="p">}</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;recereived&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">response</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">failure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;recereived&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">response</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="nx">Q</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">headers</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">success</span><span class="p">,</span><span class="w"> </span><span class="nx">failure</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>Q.get_cookie</strong></p>
<p>从当前页面的 cookie 头部按名称提取 cookie：如果 cookie 不存在，则返回 null。可以在页面的 JS 中使用以检索会话 cookie ，以备调用 cookie 的 API。</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Q</span><span class="p">.</span><span class="nx">get_cookie</span><span class="p">(</span><span class="s2">&quot;session&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>Q.register_vue_component</strong></p>
<p>这是 Vue 2 特有的，将来可能会被弃用，但它允许定义一个 Vue 组件，其中模板存储在单独的 HTML 文件中，并且只有在使用该组件时才会延迟加载模板。</p>
<p>例如，与其这样做：</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">Vue</span><span class="p">.</span><span class="nx">component</span><span class="p">(</span><span class="s1">&#39;button-counter&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">},</span>
<span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&lt;button v-on:click=&quot;count++&quot;&gt;You clicked me {{ count }} times.&lt;/button&gt;&#39;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>您可以将模板放入 button-counter.html 中，然后执行以下操作</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">Q</span><span class="p">.</span><span class="nx">register_vue_component</span><span class="p">(</span><span class="s2">&quot;button-counter&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;button-counter.html&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">        </span><span class="p">};</span>
<span class="p">});</span>
</pre></div>
</div>
<p><strong>Q.upload_helper</strong></p>
<p>它允许将 file 类型的输入标签绑定到回调，以便在选择文件时加载所选文件的内容，进行 base64 编码，并传递给回调。</p>
<p>这对于创建包含输入字段选择器的表单很有用，但您希望将所选文件的内容放入变量中，例如对该内容进行 ajax post。</p>
<p>例如：</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;file&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;my-id&quot;</span> <span class="p">/&gt;</span>
</pre></div>
</div>
<p>and</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">file_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">file_content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="nx">Q</span><span class="p">.</span><span class="nx">upload_helper</span><span class="p">(</span><span class="s2">&quot;my_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nx">file_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">name</span><span class="p">;</span>
<span class="w">   </span><span class="nx">file_content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">content</span><span class="p">;</span><span class="w"> </span><span class="c1">// base 64 encoded;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="the-t-object">
<h3>T 对象<a class="headerlink" href="#the-t-object" title="Link to this heading"></a></h3>
<p>这是 Python 中 pluralize 库的 Javascript 重新实现，该库由 py4web 中的 Python T 对象使用。因此，它本质上是一个客户端（浏览器端）的 T 对象。</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">T</span><span class="p">.</span><span class="nx">translations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;dog&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="mf">0</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no cane&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;un case&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;{n} cani&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;tanti cani&#39;</span><span class="p">}};</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">T</span><span class="p">(</span><span class="s1">&#39;dog&#39;</span><span class="p">).</span><span class="nx">format</span><span class="p">({</span><span class="nx">n</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="p">});</span><span class="w"> </span><span class="c1">// &quot;5 cani&quot;</span>
</pre></div>
</div>
<p>预期用途是创建一个服务器端点，该端点可以为客户端接受的语言提供翻译，通过 ajax-get 获得 T 翻译，然后使用 T 在客户端而不是服务器端翻译和多元化所有消息。</p>
<p><strong>Q.debounce</strong></p>
<p>防止函数自身干扰（重复执行冲突）。</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">setInterval</span><span class="p">(</span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="nx">Q</span><span class="p">.</span><span class="nx">debounce</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;hello!&quot;</span><span class="p">)},</span><span class="w"> </span><span class="mf">200</span><span class="p">);</span>
</pre></div>
</div>
<p>并且该函数将每 500 ms 调用一次，但如果前一次调用没有终止，则将跳过。与其他去盎司实现不同，它通过延迟来确保最后一个调用始终被执行（在示例中为 200 ms）</p>
<p><strong>Q.debounce</strong></p>
<p>防止函数被过于频繁地被调用；</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">Q</span><span class="p">(</span><span class="s2">&quot;#element&quot;</span><span class="p">).</span><span class="nx">onclick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Q</span><span class="p">.</span><span class="nx">debounce</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;clicked!&quot;</span><span class="p">)},</span><span class="w"> </span><span class="mf">1000</span><span class="p">);</span>
</pre></div>
</div>
<p>如果元素的点击频率超过每 1000ms 一次，则其他点击将被忽略。</p>
<p><strong>Q.tags_inputs</strong></p>
<p>它将包含以逗分为分隔标签的字符串的常规文本输入转换为标签小部件。例如：</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;browsers&quot;</span><span class="p">/&gt;</span>
</pre></div>
</div>
<p>在 JSL 中</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">Q</span><span class="p">.</span><span class="nx">tags_input</span><span class="p">(</span><span class="s1">&#39;[name=zip_codes]&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>您可以通过以下方式限制选项集：</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">Q</span><span class="p">.</span><span class="nx">tags_input</span><span class="p">(</span><span class="s1">&#39;[name=zip_codes]&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nx">freetext</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">   </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;Chrome&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Firefox&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Safari&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Edge&#39;</span><span class="p">]</span>
<span class="p">});</span>
</pre></div>
</div>
<p>与 datalist 元素配合使用以提供自动补全功能。只需在数据列表 id 前添加 <cite>-list</cite> ：&quot;</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;browsers&quot;</span><span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">datalist</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;browses-list&quot;</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">option</span><span class="p">&gt;</span>Chrome<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">option</span><span class="p">&gt;</span>Firfox<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">option</span><span class="p">&gt;</span>Safari<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">option</span><span class="p">&gt;</span>Edge<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">datalist</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>在 JS 中</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">Q</span><span class="p">.</span><span class="nx">tags_input</span><span class="p">(</span><span class="s1">&#39;[name=zip_codes]&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">freetext</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">});</span>
</pre></div>
</div>
<p>它提供了更多未记录的选项。你需要设计标签的样式。例如：</p>
<div class="highlight-css notranslate"><div class="highlight"><pre><span></span><span class="nt">ul</span><span class="p">.</span><span class="nc">tags-list</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">padding-left</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">ul</span><span class="p">.</span><span class="nc">tags-list</span><span class="w"> </span><span class="nt">li</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">inline-block</span><span class="p">;</span>
<span class="w">  </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="mh">#111111</span><span class="p">;</span>
<span class="w">  </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="kc">white</span><span class="p">;</span>
<span class="w">  </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mf">0.3</span><span class="kt">em</span><span class="w"> </span><span class="mf">0.8</span><span class="kt">em</span><span class="w"> </span><span class="mf">0.2</span><span class="kt">em</span><span class="w"> </span><span class="mf">0.8</span><span class="kt">em</span><span class="p">;</span>
<span class="w">  </span><span class="k">line-height</span><span class="p">:</span><span class="w"> </span><span class="mf">1.2</span><span class="kt">em</span><span class="p">;</span>
<span class="w">  </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="kt">px</span><span class="p">;</span>
<span class="w">  </span><span class="k">cursor</span><span class="p">:</span><span class="w"> </span><span class="kc">pointer</span><span class="p">;</span>
<span class="w">  </span><span class="k">text-transform</span><span class="p">:</span><span class="w"> </span><span class="kc">capitalize</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">ul</span><span class="p">.</span><span class="nc">tags-list</span><span class="w"> </span><span class="nt">li</span><span class="o">[</span><span class="nt">data-selected</span><span class="o">=</span><span class="nt">true</span><span class="o">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">opacity</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>注意，如果输入元素具有 <cite>.type-list-string</cite> 或 <cite>.type-list-integer</cite> ，utils.js 会自动应用 <cite>tag_input</cite> 函数。</p>
<p><strong>Q.score_input</strong></p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">Q</span><span class="p">.</span><span class="nx">score_input</span><span class="p">(</span><span class="nx">Q</span><span class="p">(</span><span class="s1">&#39;input[type=password]&#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]);</span>
</pre></div>
</div>
<p>这将把密码输入变成一个对密码复杂性进行评分的小部件。它会自动应用于名为 “password” 或 “new_password” 的 input 组件。</p>
<p>组件</p>
<p>这是一个简易版的 HTMX。它允许在页面中插入通过 AJAX 加载的 ajax-component 标签，且这些组件中的任何表单都会被拦截（即表单提交的结果也会显示在同一个组件内）。</p>
<p>例如，想象一个 index.html 包含</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">ajax-component</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;component_1&quot;</span> <span class="na">url</span><span class="o">=</span><span class="s">&quot;[[=URL(&#39;mycomponent&#39;)]]&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">blink</span><span class="p">&gt;</span>Loading...<span class="p">&lt;/</span><span class="nt">blink</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ajax-component</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>还有一个为组件服务的不同 action：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;mycomponent&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">flash</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mycomponent</span><span class="p">():</span>
    <span class="n">flash</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;Welcome&quot;</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">([</span><span class="n">Field</span><span class="p">(</span><span class="s2">&quot;your_name&quot;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">DIV</span><span class="p">(</span>
        <span class="s2">&quot;Hello &quot;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">forms</span><span class="p">[</span><span class="s2">&quot;your_name&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">accepted</span> <span class="k">else</span> <span class="n">form</span><span class="p">)</span><span class="o">.</span><span class="n">xml</span><span class="p">()</span>
</pre></div>
</div>
<p>组件 action 是一个常规 action ，除了它应该生成没有 <cite>&lt;html&gt;&lt;body&gt;...&lt;/body&gt;&lt;/html&gt;</cite> 封装的 html，例如，它可以使用模板和 flash 等。</p>
<p>请注意，如果主页支持 flash 消息，则组件中的任何 flash 消息都将由父页面显示。</p>
<p>此外，如果组件返回 <cite>redirect(&quot;other_page&quot;)</cite> ，则不仅是组件的内容，整个页面都将被重定向。</p>
<p>组件 html 的内容可以包含 <cite>&lt;script&gt; ... &lt;/script&gt;</cite> ，它们可以修改全局页面变量以及修改其他组件。</p>
</section>
</section>
<section id="adding-a-captcha-solution-with-altcha">
<span id="altcha-captcha"></span><h2>使用 Altcha 添加验证码的解决方案<a class="headerlink" href="#adding-a-captcha-solution-with-altcha" title="Link to this heading"></a></h2>
<p>本节使用 <strong>Altcha</strong> 库为 py4web 应用程序提供了一个简单的验证码实现。虽然没有经过详尽的测试，但它可以作为集成强大的客户端验证码解决方案的一个实例。更多信息请访问 <a class="reference external" href="https://altcha.org">https://altcha.org</a></p>
<section id="prerequisites">
<h3>先决条件<a class="headerlink" href="#prerequisites" title="Link to this heading"></a></h3>
<p>首先，您需要安装 Altcha 库。你可以使用 pip 来实现这一点：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>altcha
</pre></div>
</div>
<p>您还需要一个密钥来进行 HMAC 验证。建议将其存储在应用程序的设置中。对于这个例子，我们假设你有一个像 <code class="docutils literal notranslate"><span class="pre">.settings.py</span></code> 这样的文件，其中包含以下变量：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># .settings.py</span>
<span class="n">ALTCHA_HMAC_KEY</span> <span class="o">=</span> <span class="s2">&quot;your-very-secret-key-here&quot;</span>
</pre></div>
</div>
</section>
<section id="controller-logic">
<h3>控制器逻辑<a class="headerlink" href="#controller-logic" title="Link to this heading"></a></h3>
<p>接下来，您需要将必要的  actions 添加到控制器文件中。以下代码提供了两个 actions ：一个用于生成验证码挑战（ <code class="docutils literal notranslate"><span class="pre">altcha</span></code> ），另一个用于处理包含该验证码的表单（ <code class="docutils literal notranslate"><span class="pre">some_form</span></code> ）。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># controllers/default.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">altcha</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">create_challenge</span><span class="p">,</span>
    <span class="n">verify_solution</span><span class="p">,</span>
    <span class="n">ChallengeOptions</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">py4web</span><span class="w"> </span><span class="kn">import</span> <span class="n">action</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">URL</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">Form</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">py4web.utils.form</span><span class="w"> </span><span class="kn">import</span> <span class="n">XML</span><span class="p">,</span> <span class="n">T</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">ALTCHA_HMAC_KEY</span>

<span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;altcha&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_altcha</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates and returns an Altcha challenge.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="n">create_challenge</span><span class="p">(</span>
            <span class="n">ChallengeOptions</span><span class="p">(</span>
                <span class="n">hmac_key</span><span class="o">=</span><span class="n">ALTCHA_HMAC_KEY</span><span class="p">,</span>
                <span class="n">max_number</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;application/json&quot;</span>
        <span class="k">return</span> <span class="n">challenge</span><span class="o">.</span><span class="vm">__dict__</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to create challenge: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>

<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="s2">&quot;form_altcha.html&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">flash</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">some_form</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An example form that uses the Altcha captcha.&quot;&quot;&quot;</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Field</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">IS_NOT_EMPTY</span><span class="p">()),</span>
        <span class="n">Field</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">IS_IN_SET</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">])),</span>
    <span class="p">]</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span>
                <span class="n">csrf_session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
                <span class="n">submit_button</span><span class="o">=</span><span class="n">T</span><span class="p">(</span><span class="s2">&quot;Submit&quot;</span><span class="p">))</span>

    <span class="c1"># Insert the Altcha widget HTML before the submit button</span>
    <span class="n">form</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">XML</span><span class="p">(</span><span class="s1">&#39;&lt;altcha-widget&gt;&lt;/altcha-widget&gt;&lt;/br&gt;&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
        <span class="n">altcha_payload</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;altcha&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">altcha_payload</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">400</span>
            <span class="n">flash</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;NO ALTCHA payload&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NO ALTCHA payload&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ok</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">verify_solution</span><span class="p">(</span><span class="n">altcha_payload</span><span class="p">,</span> <span class="n">ALTCHA_HMAC_KEY</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">400</span>
                <span class="n">flash</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ALTCHA verification fail: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ALTCHA verification fail:&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flash</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;ALTCHA verified.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="view-templates">
<h3>视图模板<a class="headerlink" href="#view-templates" title="Link to this heading"></a></h3>
<p>您需要包含 Altcha 的 JavaScript 库，并在 HTML 模板中配置小部件。</p>
<section id="form-altcha-html">
<h4><code class="docutils literal notranslate"><span class="pre">form_altcha.html</span></code><a class="headerlink" href="#form-altcha-html" title="Link to this heading"></a></h4>
<p>此模板与 <code class="docutils literal notranslate"><span class="pre">some_form</span></code> action 配合使用。它加载 Altcha 脚本并设置 <code class="docutils literal notranslate"><span class="pre">challengeurl</span></code> 属性以指向我们的 <code class="docutils literal notranslate"><span class="pre">altcha</span></code> action 。</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>[[extend &#39;layout.html&#39;]]

<span class="p">&lt;</span><span class="nt">script</span> <span class="na">async</span> <span class="na">defer</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://cdn.jsdelivr.net/gh/altcha-org/altcha/dist/altcha.min.js&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;module&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="w">    </span><span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;DOMContentLoaded&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">altchaWidget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;altcha-widget&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">altchaWidget</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">altchaWidget</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;challengeurl&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;[[=URL(&#39;altcha&#39;)]]&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;section&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;vars&quot;</span><span class="p">&gt;</span>[[=form]]<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="custom-auth-form">
<h3>自定义 Auth Form<a class="headerlink" href="#custom-auth-form" title="Link to this heading"></a></h3>
<p>对于自定义身份验证表单，您可以采用类似的方法。确保将 <code class="docutils literal notranslate"><span class="pre">&lt;altcha-widget&gt;</span></code> 标签插入表单的结构中，并包含必要的 JavaScript。</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>[[extend &quot;layout.html&quot;]]
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">async</span> <span class="na">defer</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://cdn.jsdelivr.net/gh/altcha-org/altcha/dist/altcha.min.js&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;module&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="w">    </span><span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;DOMContentLoaded&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">altchaWidget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;altcha-widget&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">altchaWidget</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">altchaWidget</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;challengeurl&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;[[=URL(&#39;altcha&#39;)]]&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">.</span><span class="nc">auth-container</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">max-width</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="kt">%</span><span class="p">;</span>
<span class="w">        </span><span class="k">min-width</span><span class="p">:</span><span class="w"> </span><span class="mi">400</span><span class="kt">px</span><span class="p">;</span>
<span class="w">        </span><span class="k">margin-left</span><span class="p">:</span><span class="w"> </span><span class="kc">auto</span><span class="p">;</span>
<span class="w">        </span><span class="k">margin-right</span><span class="p">:</span><span class="w"> </span><span class="kc">auto</span><span class="p">;</span>
<span class="w">        </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="kt">px</span><span class="w"> </span><span class="kc">solid</span><span class="w"> </span><span class="mh">#e1e1e1</span><span class="p">;</span>
<span class="w">        </span><span class="k">border-radius</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">        </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>

[[form.structure.insert(-1,XML(&#39;<span class="p">&lt;</span><span class="nt">altcha-widget</span><span class="p">&gt;&lt;/</span><span class="nt">altcha-widget</span><span class="p">&gt;&lt;/</span><span class="nt">br</span><span class="p">&gt;</span>&#39;))]]

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;auth-container&quot;</span><span class="p">&gt;</span>[[=form]]<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>要在 auth 表单中启用 Altcha ，您可以使用以下夹具：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AltchaServerFixture</span><span class="p">(</span><span class="n">Fixture</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hmac_key</span><span class="o">=</span><span class="n">ALTCHA_HMAC_KEY</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;altcha_server&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hmac_key</span> <span class="o">=</span> <span class="n">hmac_key</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="c1"># Only verify Altcha for POST requests</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;altcha&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTP</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;ALTCHA payload not received&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">verified</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">verify_solution</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hmac_key</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">verified</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTP</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;Invalid ALTCHA&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Altcha verification passed&quot;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTP</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;Exception in Altcha verification&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
</pre></div>
</div>
<p>确保 <code class="docutils literal notranslate"><span class="pre">AltchaServerFixture</span></code> 可以在实例化 <code class="docutils literal notranslate"><span class="pre">auth</span></code> 的 <code class="docutils literal notranslate"><span class="pre">common.py</span></code> 中访问：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">.fixtures</span><span class="w"> </span><span class="kn">import</span> <span class="n">AltchaServerFixture</span>
<span class="n">auth</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">uses</span><span class="o">=</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">AltchaServerFixture</span><span class="p">()),</span> <span class="n">env</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">))</span>
</pre></div>
</div>
<p>这将确保对身份验证表单中的 POST 请求执行 Altcha 验证</p>
<p>你也可以在表单中使用 <code class="docutils literal notranslate"><span class="pre">AltchaServerFixture</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;other_form&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="s1">&#39;form_altcha.html&#39;</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">AltchaServerFixture</span><span class="p">())</span>
<span class="k">def</span><span class="w"> </span><span class="nf">other_form</span><span class="p">():</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Field</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">IS_NOT_EMPTY</span><span class="p">()),</span>
        <span class="n">Field</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">IS_IN_SET</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">,</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span><span class="s2">&quot;green&quot;</span><span class="p">])),</span>
    <span class="p">]</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span>
                <span class="n">csrf_session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
                <span class="n">submit_button</span><span class="o">=</span><span class="n">T</span><span class="p">(</span><span class="s2">&quot;Submit&quot;</span><span class="p">))</span>
    <span class="n">antes_submit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span>
    <span class="n">form</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">antes_submit</span><span class="p">,</span> <span class="n">XML</span><span class="p">(</span><span class="s1">&#39;&lt;altcha-widget&gt;&lt;/altcha-widget&gt;&lt;/br&gt;&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
        <span class="c1"># You can assume here that the Altcha payload was verified by the fixture</span>
        <span class="n">flash</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;Form and Altcha successfully verified.&quot;</span><span class="p">)</span>
        <span class="c1"># Process the form data here</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="chapter-15.html" class="btn btn-neutral float-left" title="从 web2py 迁移到 py4web" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2020, BSDv3 License。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      
      
     <span class="fa fa-element">
     <input class="container_toggle" type="checkbox" id="switch" name="mode">
     <label for="switch"></label>
     </span>
      
      v: 20251209
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl>
        <dt>语言</dt>
        
           <strong> 
          <dd><a href="../en/index.html">en</a></dd> </strong>
          
        
          
          
          <dd><a href="../pt/index.html">pt</a></dd> 
        
          
          
          <dd><a href="../zh_CN/index.html">zh_CN</a></dd> 
        
      </dl>
      
      
      <dl>
        <dt>版本</dt>
        
          
          <dd><a href="index.html">current</a></dd>
          
        
      </dl>
      
      
      <dl>
        <dt>下载</dt>
        
          <dd><a href="py4web_en.pdf">pdf</a></dd>
        
          <dd><a href="py4web_en.epub">epub</a></dd>
        
      </dl>
      
      
      <hr/>
    </div>
  </div>

 <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
         .wy-nav-content { max-width: none; }
  </style>



</body>
</html>