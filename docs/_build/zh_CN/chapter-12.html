

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>表单（Forms） &mdash; py4web 20251209 文档</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/css/toggle.css?v=029c1802" />

  
    <link rel="shortcut icon" href="_static/logo-32x32.ico"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=96e44453"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/translations.js?v=beaddf03"></script>
      <script src="_static/js/toggle.js?v=e1b5a5a1"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="身份验证与授权" href="chapter-13.html" />
    <link rel="prev" title="国际化" href="chapter-11.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            py4web
              <img src="_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">目录</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="chapter-01.html">py4web 是什么？</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-02.html">帮助、资源和提示</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-03.html">安装和启动</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-04.html">Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-05.html">创建一个应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-06.html">夹具（Fixture）</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-07.html">数据库抽象层（DAL）</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-08.html">RestAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-09.html">YATL 模板语言</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-10.html">YATL 中的助手（helpers）</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-11.html">国际化</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">表单（Forms）</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-form-constructor">Form 的构造函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="#a-minimal-form-example-without-a-database">一个没有数据库的最小表单示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="#basic-form-example">基本的表单示例</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#file-upload-field">文件上传字典</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#widgets">小部件</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#standard-widgets">标准小部件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-widgets">自定义小部件</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#advanced-form-design">高级的表单设计</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#form-structure-manipulation">表单结构操作</a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-forms">自定义表单</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-sidecar-parameter">sidecar 参数</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#form-validation">表单验证</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#text-format-validators">文本格式的验证器</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#is-alphanumeric"><code class="docutils literal notranslate"><span class="pre">IS_ALPHANUMERIC</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-lower"><code class="docutils literal notranslate"><span class="pre">IS_LOWER</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-upper"><code class="docutils literal notranslate"><span class="pre">IS_UPPER</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-email"><code class="docutils literal notranslate"><span class="pre">IS_EMAIL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-match"><code class="docutils literal notranslate"><span class="pre">IS_MATCH</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-length"><code class="docutils literal notranslate"><span class="pre">IS_LENGTH</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-url"><code class="docutils literal notranslate"><span class="pre">IS_URL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-safe"><code class="docutils literal notranslate"><span class="pre">IS_SAFE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-slug"><code class="docutils literal notranslate"><span class="pre">IS_SLUG</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-json"><code class="docutils literal notranslate"><span class="pre">IS_JSON</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#date-and-time-validators">日期和时间的验证器</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#is-time"><code class="docutils literal notranslate"><span class="pre">IS_TIME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-date"><code class="docutils literal notranslate"><span class="pre">IS_DATE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-datetime"><code class="docutils literal notranslate"><span class="pre">IS_DATETIME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-date-in-range"><code class="docutils literal notranslate"><span class="pre">IS_DATE_IN_RANGE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-datetime-in-range"><code class="docutils literal notranslate"><span class="pre">IS_DATETIME_IN_RANGE</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#range-set-and-equality-validators">范围、集合和相等的验证器</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#is-equal-to"><code class="docutils literal notranslate"><span class="pre">IS_EQUAL_TO</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-not-empty"><code class="docutils literal notranslate"><span class="pre">IS_NOT_EMPTY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-null-or"><code class="docutils literal notranslate"><span class="pre">IS_NULL_OR</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-empty-or"><code class="docutils literal notranslate"><span class="pre">IS_EMPTY_OR</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-expr"><code class="docutils literal notranslate"><span class="pre">IS_EXPR</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-decimal-in-range"><code class="docutils literal notranslate"><span class="pre">IS_DECIMAL_IN_RANGE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-float-in-range"><code class="docutils literal notranslate"><span class="pre">IS_FLOAT_IN_RANGE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-int-in-range"><code class="docutils literal notranslate"><span class="pre">IS_INT_IN_RANGE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-in-set"><code class="docutils literal notranslate"><span class="pre">IS_IN_SET</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#checkbox-validation">复选框验证</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dictionaries-and-tuples-with-is-in-set">在 IS_IN_SET 中使用字典和元组</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sorted-options">排序选项</a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-in-set-and-tagging"><code class="docutils literal notranslate"><span class="pre">IS_IN_SET</span></code> 和标记</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#complexity-and-security-validators">复杂性和安全性的验证器</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#is-strong"><code class="docutils literal notranslate"><span class="pre">IS_STRONG</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#crypt"><code class="docutils literal notranslate"><span class="pre">CRYPT</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#special-type-validators">特殊类型的验证器</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#is-list-of"><code class="docutils literal notranslate"><span class="pre">IS_LIST_OF</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-list-of-emails"><code class="docutils literal notranslate"><span class="pre">IS_LIST_OF_EMAILS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#any-of"><code class="docutils literal notranslate"><span class="pre">ANY_OF</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-image"><code class="docutils literal notranslate"><span class="pre">IS_IMAGE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-file"><code class="docutils literal notranslate"><span class="pre">IS_FILE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-upload-filename"><code class="docutils literal notranslate"><span class="pre">IS_UPLOAD_FILENAME</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-ipv4"><code class="docutils literal notranslate"><span class="pre">IS_IPV4</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-ipv6"><code class="docutils literal notranslate"><span class="pre">IS_IPV6</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-ipaddress"><code class="docutils literal notranslate"><span class="pre">IS_IPADDRESS</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#other-validators">其它的验证器</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cleanup"><code class="docutils literal notranslate"><span class="pre">CLEANUP</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#database-validators">数据库验证器</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#is-not-in-db"><code class="docutils literal notranslate"><span class="pre">IS_NOT_IN_DB</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-in-db"><code class="docutils literal notranslate"><span class="pre">IS_IN_DB</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#is-in-db-and-tagging"><code class="docutils literal notranslate"><span class="pre">IS_IN_DB</span></code> 和标记</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#validation-functions">验证函数</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="chapter-13.html">身份验证与授权</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-14.html">表格（Grid）</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-15.html">从 web2py 迁移到 py4web</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-16.html">高级主题和示例</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">py4web</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">表单（Forms）</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/web2py/py4web/blob/master/docs/chapter-12.rst" class="fa fa-github"> 在 GitHub 上编辑</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="forms">
<h1>表单（Forms）<a class="headerlink" href="#forms" title="Link to this heading"></a></h1>
<p>Form 类提供了一个高级 API，用于快速构建 CRUD（创建、读取、更新和删除）表单，尤其是用于处理现有的数据库表。它可以根据所需字段列表和/或现有数据库表生成和处理表单。</p>
<p>有三种形式的表单：</p>
<p>添加数据的 CRUD 表单</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;create_thing&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="s1">&#39;generic.html&#39;</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">flash</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_thing</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
        <span class="n">flash</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;record created&quot;</span><span class="p">)</span>
        <span class="n">redirect</span><span class="p">(</span><span class="n">URL</span><span class="p">(</span><span class="s1">&#39;other_page&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
</pre></div>
</div>
<p>更新数据的 CRUD 表单</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;update_thing/&lt;thing_id:int&gt;&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="s1">&#39;generic.html&#39;</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">flash</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_thing</span><span class="p">(</span><span class="n">thing_id</span><span class="p">):</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">,</span> <span class="n">thing_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
        <span class="n">flash</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;record updated&quot;</span><span class="p">)</span>
        <span class="n">redirect</span><span class="p">(</span><span class="n">URL</span><span class="p">(</span><span class="s1">&#39;other_page&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
</pre></div>
</div>
<p>非 CRUD 表单（与数据库无关联）</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;some_form&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="s1">&#39;generic.html&#39;</span><span class="p">,</span> <span class="n">flash</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">some_form</span><span class="p">():</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Field</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">IS_NOT_EMPTY</span><span class="p">()),</span>
        <span class="n">Field</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="n">IS_IN_SET</span><span class="p">([</span><span class="s2">&quot;red&quot;</span><span class="p">,</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span><span class="s2">&quot;green&quot;</span><span class="p">])),</span>
    <span class="p">]</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
        <span class="n">flash</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;information recorded&quot;</span><span class="p">)</span>
        <span class="n">redirect</span><span class="p">(</span><span class="n">URL</span><span class="p">(</span><span class="s1">&#39;other_page&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
</pre></div>
</div>
<p>用于消息提示的 <code class="docutils literal notranslate"><span class="pre">flash</span></code> 的使用是可选的。 <code class="docutils literal notranslate"><span class="pre">flash</span></code> 是在脚手架应用程序中的 <code class="docutils literal notranslate"><span class="pre">common.py</span></code> 中定义的。它只是将消息存储在 cookie 中，以便在重定向后可以恢复和显示。这是在默认布局中完成的。</p>
<p>在本章中，从现在开始，我们假设有如下的数据模型和一个派生自脚手架程序的应用程序：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span>
    <span class="s1">&#39;thing&#39;</span><span class="p">,</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">IS_NOT_EMPTY</span><span class="p">()),</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">IS_IN_SET</span><span class="p">([</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="s1">&#39;green&#39;</span><span class="p">])),</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;upload&#39;</span><span class="p">,</span> <span class="n">download_url</span><span class="o">=</span><span class="k">lambda</span> <span class="n">name</span><span class="p">:</span> <span class="n">URL</span><span class="p">(</span><span class="s1">&#39;download&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)),</span>
<span class="p">)</span>
</pre></div>
</div>
<section id="the-form-constructor">
<h2>Form 的构造函数<a class="headerlink" href="#the-form-constructor" title="Link to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Form</span></code> 的构造函数接受以下参数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
     <span class="n">table</span><span class="p">,</span>
     <span class="n">record</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
     <span class="n">readonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
     <span class="n">deletable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
     <span class="n">formstyle</span><span class="o">=</span><span class="n">FormStyleDefault</span><span class="p">,</span>
     <span class="n">dbio</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
     <span class="n">keep_values</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
     <span class="n">form_name</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
     <span class="n">hidden</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
     <span class="n">validation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
     <span class="n">csrf_session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
     <span class="n">csrf_protection</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
     <span class="n">lifespan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
     <span class="n">signing_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
     <span class="p">):</span>
</pre></div>
</div>
<p>参数解释：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">table</span></code>: 一个 DAL 数据表或是一个 DAL 字段的列表</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">record</span></code>: 一个 DAL 数据库记录或是记录的 ID</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">readonly</span></code>: 设置为 True 可生成只读的表单</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deletable</span></code>: 设置为 False 可禁用删除记录的功能</p></li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">formstyle</span></code>: 一个使用 helper 渲染表单的函数</dt><dd><p>可以是 <code class="docutils literal notranslate"><span class="pre">FormStyleDefault</span></code> (默认值) 、 <code class="docutils literal notranslate"><span class="pre">FormStyleBulma</span></code> 、 <code class="docutils literal notranslate"><span class="pre">FormStyleBootstrap4</span></code> 或者  <code class="docutils literal notranslate"><span class="pre">FormStyleBootstrap5</span></code></p>
</dd>
</dl>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">dbio</span></code>: 设置为 False 可阻止向数据库写入数据</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">keep_values</span></code>: 如果设置为 True ，那么页面将记住上次提交的表单中各项的值</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">form_name</span></code>: 这个表单的可选名称</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hidden</span></code>: 已经添加给这个表单的要隐藏字段的字典。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validation</span></code>: 一个可选的验证器，请见 <a class="reference internal" href="#validation-functions"><span class="std std-ref">验证函数</span></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">csrf_session</span></code>: 如果为 None，则不添加 csrf 令牌。如果是 session，则添加并验证 CSRF 令牌</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lifespan</span></code>: 以秒为单位的 CSRF 令牌的有效期，用来限制表单有效性。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">signing_info</span></code>: 在 CSRF 令牌签名和验证期间不应被更改的信息</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">FormStyleDefault</span></code> 是一个被每个表单默认使用的对象，它在 <code class="docutils literal notranslate"><span class="pre">py4web.utils.form.FormStyleDefault</span></code> 里被定义。你绝不应该改变它，但你可以对其进行复制后再将副本作为 <code class="docutils literal notranslate"><span class="pre">formstyle</span></code> 传递。</p>
<p>您可以通过更改 FormStyle 的 <code class="docutils literal notranslate"><span class="pre">color</span></code> 属性来更改名为 <code class="docutils literal notranslate"><span class="pre">color</span></code> 的字段的样式。</p>
</section>
<section id="a-minimal-form-example-without-a-database">
<h2>一个没有数据库的最小表单示例<a class="headerlink" href="#a-minimal-form-example-without-a-database" title="Link to this heading"></a></h2>
<p>让我们从一个最小的工作表单示例开始。创建一个名为 <code class="docutils literal notranslate"><span class="pre">form_minimal</span></code> 的新的最小应用程序：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in controllers.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">py4web</span> <span class="n">impot</span> <span class="n">action</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">URL</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">py4web.utils.form</span><span class="w"> </span><span class="kn">import</span> <span class="n">Form</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydal.validators</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="s1">&#39;form_minimal.html&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">IS_NOT_EMPTY</span><span class="p">()),</span>
        <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">IS_IN_SET</span><span class="p">([</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="s1">&#39;green&#39;</span><span class="p">])),</span>
    <span class="p">]</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
        <span class="c1"># Do something with form.vars[&#39;name&#39;] and form.vars[&#39;color&#39;]</span>
        <span class="n">redirect</span><span class="p">(</span><span class="n">URL</span><span class="p">(</span><span class="s1">&#39;accepted&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
        <span class="c1"># do something</span>
        <span class="o">...</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

<span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;accepted&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">accepted</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;form_example accepted&quot;</span>
</pre></div>
</div>
<p>也需要在应用程序里创建一个文件，称其为 <code class="docutils literal notranslate"><span class="pre">templates/form_minimal.html</span></code> ，它仅仅包含下面的行：</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>[[extend &#39;layout.html&#39;]]
[[=form]]
</pre></div>
</div>
<p>然后重启 py4web ，再访问 <a class="reference external" href="http://127.0.0.1:8000/form_minimal">http://127.0.0.1:8000/form_minimal</a> - 你将看到那个 Form 页面：</p>
<img alt="_images/form1.png" src="_images/form1.png" />
<p>注意：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Form</span></code> 是一个包含在模块 <code class="docutils literal notranslate"><span class="pre">py4web.utils.form</span></code> 里面的类</p></li>
<li><p>可以使用 <strong>表单验证器</strong>，比如 <code class="docutils literal notranslate"><span class="pre">IS_NOT_EMPTY</span></code> ，请参见后面的 <a class="reference internal" href="#form-validation"><span class="std std-ref">表单验证</span></a> 。它们来自模块 <code class="docutils literal notranslate"><span class="pre">pydal.validators</span></code> 。</p></li>
<li><p>在有表单的 action 里面，同时使用  <strong>GET</strong> 和 <strong>POST</strong> 方法通常很重要</p></li>
</ul>
<p>这个示例有意的没有使用数据库、模板，也没有使用会话管理。下面的例子将会使用。</p>
</section>
<section id="basic-form-example">
<h2>基本的表单示例<a class="headerlink" href="#basic-form-example" title="Link to this heading"></a></h2>
<p>在下一个基本示例中，我们从数据库生成一个添加数据的 DRUD 表单。创建一个名为 <code class="docutils literal notranslate"><span class="pre">form_basic</span></code> 的新的最小应用程序：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in controllers.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">py4web</span><span class="w"> </span><span class="kn">import</span> <span class="n">action</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">URL</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">py4web.utils.form</span><span class="w"> </span><span class="kn">import</span> <span class="n">Form</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydal.validators</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>

<span class="c1"># controllers definition</span>
<span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;create_form&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="s2">&quot;form_basic.html&quot;</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_form</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">)</span>
</pre></div>
</div>
<p>注意在顶部导入的两个简单的验证器，这是为了稍后它们被当作 <code class="docutils literal notranslate"><span class="pre">requires</span></code> 的参数使用。我们将在 <a class="reference internal" href="#form-validation"><span class="std std-ref">表单验证</span></a> 段落部分详细解释。</p>
<p>你还需要一个模板文件 <code class="docutils literal notranslate"><span class="pre">templates/form_basic.html</span></code> ，它包含下面示例代码：</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>[[extend &quot;layout.html&quot;]]

<span class="p">&lt;</span><span class="nt">h2</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;title&quot;</span><span class="p">&gt;</span>Form Basic example: My Things<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>

[[=form]]

<span class="p">&lt;</span><span class="nt">h2</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;title&quot;</span><span class="p">&gt;</span>Rows<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
[[for row in rows:]]
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>[[=row.id]]: [[=row.name]] has color [[=row.color]]<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
[[pass]]
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>重启 py4web，再访问 <a class="reference external" href="http://127.0.0.1:8000/create_form">http://127.0.0.1:8000/create_form</a> ：结果是一个页面，上面是一个输入表单，下面是以前添加的所有数据记录的列表。</p>
<img alt="_images/form2.png" src="_images/form2.png" />
<p>这是一个简单的示例，你不能更改和不能删除已存在的记录。但如果你想尝试，可以使用 Dashboard 应用程序查看和更改数据库的全部内容。</p>
<p>通过将一个记录或者记录的 ID 当作表单的第二个参数，你能将一个添加数据的表单转换成更新数据的 CRUD 表单：</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span># controllers definition
@action(&quot;update_form/<span class="p">&lt;</span><span class="nt">thing_id:int</span><span class="p">&gt;</span>&quot;, method=[&quot;GET&quot;, &quot;POST&quot;])
@action.uses(&quot;form_basic.html&quot;, db)
def update_form(thing_id):
    form = Form(db.thing, thing_id)
    rows = db(db.thing).select()
    return dict(form=form, rows=rows)
</pre></div>
</div>
<section id="file-upload-field">
<h3>文件上传字典<a class="headerlink" href="#file-upload-field" title="Link to this heading"></a></h3>
<p>我们可以对使用的模型和上传类型的文件进行小幅修改：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span>
    <span class="s1">&#39;thing&#39;</span><span class="p">,</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">IS_NOT_EMPTY</span><span class="p">()),</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">IS_IN_SET</span><span class="p">([</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="s1">&#39;green&#39;</span><span class="p">])),</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;upload&#39;</span><span class="p">,</span> <span class="n">download_url</span><span class="o">=</span><span class="k">lambda</span> <span class="n">image</span><span class="p">:</span> <span class="n">URL</span><span class="p">(</span><span class="s1">&#39;download&#39;</span><span class="p">,</span> <span class="n">image</span><span class="p">)),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>文件上传字段非常特殊。使用它的标准方法（如在 _scaffold 应用程序中）是使用在 common.py 文件中定义的 UPLOAD_FOLDER 。但如果不指定，则将使用默认值的 <code class="docutils literal notranslate"><span class="pre">your_app/upload</span></code> 文件夹（如果需要，还将创建该文件夹）。 <code class="docutils literal notranslate"><span class="pre">download_url</span></code> 是一个回调函数，它给定图像名称，生成要下载的 URL 。 <code class="docutils literal notranslate"><span class="pre">download</span></code> url 在 <code class="docutils literal notranslate"><span class="pre">common.py</span></code> 中预定义。</p>
<p>我们可以修改 <code class="docutils literal notranslate"><span class="pre">form_basic.html</span></code> 以显示已上传的图像：</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">h2</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;title&quot;</span><span class="p">&gt;</span>Form upload example: My Things<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>

[[=form]]

<span class="p">&lt;</span><span class="nt">h2</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;title&quot;</span><span class="p">&gt;</span>Rows<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
[[for row in rows:]]
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>[[=row.id]]: [[=row.name]] has color [[=row.color]]
    <span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;[[=URL(&#39;download&#39;, row.image)]]&quot;</span> <span class="p">/&gt;</span>
[[pass]]
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>已上传的文件（ “thing” 的图像）被存储在 UPLOAD_FOLDER 指定的文件夹中，原始文件名会被哈希处理。关于上传文件的其它内容能在 <a class="reference internal" href="chapter-07.html#field-constructor"><span class="std std-ref">“Field” 的构造函数</span></a> 段落部分中找到，包括一种将文件保存进数据库中的方法。</p>
</section>
</section>
<section id="widgets">
<h2>小部件<a class="headerlink" href="#widgets" title="Link to this heading"></a></h2>
<section id="standard-widgets">
<h3>标准小部件<a class="headerlink" href="#standard-widgets" title="Link to this heading"></a></h3>
<p>Py4web 在 Py4web.utility.form 库中提供了许多小部件。它们是简单的插件，允许您轻松指定表单中输入元素的类型及其一些属性。</p>
<p>这里是完整的列表</p>
<ul class="simple">
<li><p>CheckboxWidget</p></li>
<li><p>DateTimeWidget</p></li>
<li><p>FileUploadWidget</p></li>
<li><p>ListWidget</p></li>
<li><p>PasswordWidget</p></li>
<li><p>RadioWidget</p></li>
<li><p>SelectWidget</p></li>
<li><p>TextareaWidget</p></li>
</ul>
<p>这是一个改进的 “基本表单示例”，带有单选按钮小部件：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in controllers.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">py4web</span><span class="w"> </span><span class="kn">import</span> <span class="n">action</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">URL</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">py4web.utils.form</span><span class="w"> </span><span class="kn">import</span> <span class="n">Form</span><span class="p">,</span> <span class="n">FormStyleDefault</span><span class="p">,</span> <span class="n">RadioWidget</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydal.validators</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>

<span class="c1"># controllers definition</span>
<span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;create_form&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="s2">&quot;form_widgets.html&quot;</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_form</span><span class="p">():</span>
    <span class="n">FormStyleDefault</span><span class="o">.</span><span class="n">widgets</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">RadioWidget</span><span class="p">()</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">,</span> <span class="n">formstyle</span><span class="o">=</span><span class="n">FormStyleDefault</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">)</span>
</pre></div>
</div>
<p>请注意与我们在本章开头看到的 “基本表单示例” 的不同之处：</p>
<ul>
<li><p>您需要从 py4web.utils.form 库导入小部件</p></li>
<li><p>在表单定义之前，您可以使用下面的行定义 <code class="docutils literal notranslate"><span class="pre">color</span></code> 字段表单样式：</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">FormStyleDefault</span><span class="o">.</span><span class="n">widgets</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">RadioWidget</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>结果与之前相同，但现在我们有了一个单选按钮小部件，而不是下拉菜单！</p>
<p>在表单中使用小部件非常简单，它们会让你对表单的各个部分有更多的控制权。</p>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>当使用 py4web 时，使用 py4web 小部件，不要在 Field 对象中使用 pydal 小部件参数（请参阅 <a class="reference internal" href="chapter-07.html#field-constructor"><span class="std std-ref">“Field” 的构造函数</span></a> ）。</p>
</div>
</section>
<section id="custom-widgets">
<h3>自定义小部件<a class="headerlink" href="#custom-widgets" title="Link to this heading"></a></h3>
<p>您还可以通过克隆和修改现有样式来自定义小部件属性。让我们快速浏览一下，再次改进我们的 Superhero 示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in controllers.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">py4web</span><span class="w"> </span><span class="kn">import</span> <span class="n">action</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">URL</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">py4web.utils.form</span><span class="w"> </span><span class="kn">import</span> <span class="n">Form</span><span class="p">,</span> <span class="n">FormStyleDefault</span><span class="p">,</span> <span class="n">RadioWidget</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydal.validators</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>

<span class="c1"># custom widget class definition</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MyCustomWidget</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">placeholder</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">tablename</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">_table</span> <span class="k">if</span> <span class="s2">&quot;_table&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;no_table&quot;</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">INPUT</span><span class="p">(</span>
            <span class="n">_type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
            <span class="n">_id</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="n">_name</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">_value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
            <span class="n">_class</span><span class="o">=</span><span class="s2">&quot;input&quot;</span><span class="p">,</span>
            <span class="n">_placeholder</span><span class="o">=</span><span class="n">placeholder</span> <span class="k">if</span> <span class="n">placeholder</span> <span class="ow">and</span> <span class="n">placeholder</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span>
            <span class="n">_title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">_style</span><span class="o">=</span><span class="s2">&quot;font-size: x-large;color: red; background-color: black;&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">control</span>

<span class="c1"># controllers definition</span>
<span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;create_form&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="s2">&quot;form_custom_widgets.html&quot;</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_form</span><span class="p">():</span>
    <span class="n">MyStyle</span> <span class="o">=</span> <span class="n">FormStyleDefault</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">MyStyle</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="n">FormStyleDefault</span><span class="o">.</span><span class="n">classes</span>
    <span class="n">MyStyle</span><span class="o">.</span><span class="n">widgets</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">MyCustomWidget</span><span class="p">()</span>
    <span class="n">MyStyle</span><span class="o">.</span><span class="n">widgets</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">RadioWidget</span><span class="p">()</span>

    <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">,</span> <span class="n">deletable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">formstyle</span><span class="o">=</span><span class="n">MyStyle</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">)</span>
</pre></div>
</div>
<p>结果与前面的类似，但现在我们有一个自定义输入字段，前景颜色为红色，背景颜色为黑色，</p>
<p>甚至单选按钮小部件也发生了变化，从红色变为蓝色。</p>
</section>
</section>
<section id="advanced-form-design">
<h2>高级的表单设计<a class="headerlink" href="#advanced-form-design" title="Link to this heading"></a></h2>
<section id="form-structure-manipulation">
<h3>表单结构操作<a class="headerlink" href="#form-structure-manipulation" title="Link to this heading"></a></h3>
<p>在 py4web 中，表单由 YATL helpers 呈现。这意味着在表单以 HTML 序列化之前，可以改变表单的树结构。以下是一个如何改变生成 HTML 结构的示例</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;paint&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">))</span>
<span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">paint</span><span class="p">)</span>
<span class="n">form</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;[name=color]&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;my-class&#39;</span>
</pre></div>
</div>
<p>请注意，在访问表单结构之前，表单不会形成 HTML 树。访问后，您可以使用 <code class="docutils literal notranslate"><span class="pre">.find(...)</span></code> 查找匹配的元素。 <code class="docutils literal notranslate"><span class="pre">find</span></code> 的参数是一个遵循 jQuery 过滤语法的字符串。在上述情况下，只有一个匹配的 <code class="docutils literal notranslate"><span class="pre">[0]</span></code> ，我们修改了该元素的 <code class="docutils literal notranslate"><span class="pre">_class</span></code> 属性。HTML 元素的属性名称前面必须加下划线。</p>
</section>
<section id="custom-forms">
<h3>自定义表单<a class="headerlink" href="#custom-forms" title="Link to this heading"></a></h3>
<p>自定义表单允许您精细控制表单的处理方式。在模板文件中，您可以在显示表单之前或提交数据之后执行特定指令，方法是在以下语句中插入代码：</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>[[=form.custom.begin ]]
[[=form.custom.submit ]]
[[=form.custom.end ]]
</pre></div>
</div>
<p>例如，可以使用自定义表单在表单中编辑记录时，不再显示 <code class="docutils literal notranslate"><span class="pre">id</span></code> 字段。</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>[[extend &#39;layout.html&#39;]]
[[=form.custom.begin ]]
    [[for field in DETAIL_FIELDS: ]]
        [[ if field not in [&#39;id&#39;]: ]]
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;select&quot;</span><span class="p">&gt;</span>
                [[=form.custom.widgets[field] ]]
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        [[pass]]
    [[pass]]
[[=form.custom.submit ]]
[[=form.custom.end ]]
</pre></div>
</div>
<p>注意：“custom” 只是一个约定，它可以是任何与已定义对象不冲突的名称。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>使用自定义表单时，如果您有一个不包含在表单中的可写字段，则在保存记录时会将其设置为 null。每当字段不被包含在自定义表单中时，都应将其设置为 field.writed=False，以确保该字段不被更新。</p>
<p>此外，自定义表单只为给定的字段创建元素，而不创建基于 css 框架可能需要的周围元素。例如，如果你使用 Bulma 作为 css 框架，你必须添加一个外部 DIV 才能让选择控件正确显示。</p>
</div>
<p>你也可以更有创意地在模板中使用 HTML，而不是使用小部件：</p>
<div class="highlight-css notranslate"><div class="highlight"><pre><span></span><span class="o">[[</span><span class="nt">extend</span><span class="w"> </span><span class="s1">&#39;layout.html&#39;</span><span class="o">]]</span>

<span class="o">[[</span><span class="nt">for</span><span class="w"> </span><span class="nt">field</span><span class="o">,</span><span class="w"> </span><span class="nt">error</span><span class="w"> </span><span class="nt">form</span><span class="p">.</span><span class="nc">errors</span><span class="p">.</span><span class="nc">items</span><span class="o">:]]</span>
<span class="o">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="nt">class</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="o">&gt;</span><span class="nt">Field</span><span class="w"> </span><span class="o">[[=</span><span class="nt">field</span><span class="o">]]</span><span class="w"> </span><span class="o">[[=</span><span class="nt">error</span><span class="o">]]&lt;/</span><span class="nt">div</span><span class="o">&gt;</span>
<span class="o">[[</span><span class="nt">pass</span><span class="o">]]</span>

<span class="o">[[=</span><span class="nt">form</span><span class="p">.</span><span class="nc">custom</span><span class="p">.</span><span class="nc">begin</span><span class="w"> </span><span class="o">]]</span>

<span class="o">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="nt">class</span><span class="o">=</span><span class="s2">&quot;select&quot;</span><span class="o">&gt;</span>
<span class="w">     </span><span class="o">&lt;</span><span class="nt">input</span><span class="w"> </span><span class="nt">name</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="w"> </span><span class="nt">value</span><span class="o">=</span><span class="s2">&quot;form.vars.get(&#39;name&#39;, &#39;&#39;)&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="nt">div</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="nt">class</span><span class="o">=</span><span class="s2">&quot;select&quot;</span><span class="o">&gt;</span>
<span class="o">[[</span><span class="nt">for</span><span class="w"> </span><span class="nt">color</span><span class="w"> </span><span class="nt">in</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;red&#39;</span><span class="o">,</span><span class="w"> </span><span class="s1">&#39;blue&#39;</span><span class="o">,</span><span class="w"> </span><span class="s1">&#39;green&#39;</span><span class="o">]:]]</span>
<span class="w">     </span><span class="o">&lt;</span><span class="nt">label</span><span class="o">&gt;[[=</span><span class="nt">color</span><span class="o">]]&lt;/</span><span class="nt">label</span><span class="o">&gt;</span>
<span class="w">     </span><span class="o">&lt;</span><span class="nt">input</span><span class="w"> </span><span class="nt">name</span><span class="o">=</span><span class="s2">&quot;color&quot;</span><span class="w"> </span><span class="nt">type</span><span class="o">=</span><span class="s2">&quot;radio&quot;</span><span class="w"> </span><span class="nt">value</span><span class="o">=</span><span class="s2">&quot;[[=color]]&quot;</span>
<span class="w">                </span><span class="o">[[</span><span class="nt">if</span><span class="w"> </span><span class="nt">form</span><span class="p">.</span><span class="nc">vars</span><span class="p">.</span><span class="nc">get</span><span class="o">(</span><span class="s1">&#39;color&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nt">color</span><span class="o">:]]</span><span class="nt">checked</span><span class="o">[[</span><span class="nt">pass</span><span class="o">]]</span>
<span class="w">     </span><span class="o">/&gt;</span>
<span class="o">[[</span><span class="nt">pass</span><span class="o">]]</span>
<span class="o">&lt;/</span><span class="nt">div</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nt">input</span><span class="w"> </span><span class="nt">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span><span class="w"> </span><span class="nt">value</span><span class="o">=</span><span class="s2">&quot;Click me&quot;</span><span class="o">/&gt;</span>
<span class="o">[[=</span><span class="nt">form</span><span class="p">.</span><span class="nc">custom</span><span class="p">.</span><span class="nc">end</span><span class="w"> </span><span class="o">]]</span>
</pre></div>
</div>
</section>
<section id="the-sidecar-parameter">
<h3>sidecar 参数<a class="headerlink" href="#the-sidecar-parameter" title="Link to this heading"></a></h3>
<p>sidecar 是与提交按钮一起被注入到表单中的东西。</p>
<p>例如，您可以使用以下代码在表单中注入一个简单的 <code class="docutils literal notranslate"><span class="pre">click</span> <span class="pre">me</span></code> 按钮：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">form</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">sidecar</span> <span class="o">=</span> <span class="n">DIV</span><span class="p">(</span><span class="n">BUTTON</span><span class="p">(</span><span class="s2">&quot;click me&quot;</span><span class="p">,</span> <span class="n">_onclick</span><span class="o">=</span><span class="s2">&quot;alert(&#39;doh!&#39;)&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>特别是，这通常用于添加 py4web 不提供的 <code class="docutils literal notranslate"><span class="pre">Cancel</span></code> 按钮：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
<span class="s2">&quot;_onclick&quot;</span><span class="p">:</span> <span class="s2">&quot;window.history.back(); return false;&quot;</span><span class="p">,</span>
<span class="s2">&quot;_class&quot;</span><span class="p">:</span> <span class="s2">&quot;button is-default&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">form</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">sidecar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BUTTON</span><span class="p">(</span><span class="s2">&quot;Cancel&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">))</span>
</pre></div>
</div>
</section>
</section>
<section id="form-validation">
<h2>表单验证<a class="headerlink" href="#form-validation" title="Link to this heading"></a></h2>
<p>验证器是用于验证输入字段（包括从数据库表生成的表单）的类。它们通常使用表定义中的 <code class="docutils literal notranslate"><span class="pre">Field</span></code> 对象的 <code class="docutils literal notranslate"><span class="pre">requires</span></code> 属性分配，如 DAL 章节中 <a class="reference internal" href="chapter-07.html#field-constructor"><span class="std std-ref">“Field” 的构造函数</span></a> 段落所示。此外，您可以使用高级验证器来创建小部件，如下拉菜单、单选按钮，甚至从其他表中查找。最后但同样重要的是，您甚至可以显式定义验证函数。</p>
<p>这个示例简单地说明了如何为表定义中的字段添加一个验证器，</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span>
    <span class="s1">&#39;person&#39;</span><span class="p">,</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="n">requires</span><span class="o">=</span><span class="n">IS_NOT_EMPTY</span><span class="p">(),</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;job&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>验证器经常以这种等效语法显式地写在表定义之外：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span>
    <span class="s1">&#39;person&#39;</span><span class="p">,</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;job&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_NOT_EMPTY</span><span class="p">()</span>
</pre></div>
</div>
<p>一个字段可以只有一个单独的验证器，也可以有多个验证器的列表。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">IS_NOT_EMPTY</span><span class="p">(),</span>
    <span class="n">IS_NOT_IN_DB</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;person.name&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>请注意，只能与 <code class="docutils literal notranslate"><span class="pre">list:</span></code> 类型字段一起使用的验证器是：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">IS_IN_DB(...,</span> <span class="pre">multiple=True)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IS_IN_SET(...,</span> <span class="pre">multiple=True)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IS_NOT_EMPTY()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IS_LIST_OF_EMAILS()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IS_LIST_OF(...)</span></code></p></li>
</ul>
<p>最后一个可用于将任何验证器应用于列表中的单个项目。 <code class="docutils literal notranslate"><span class="pre">multiple=(1,</span> <span class="pre">1000)</span></code> 需要选择 1 到 1000 个项目。这强制选择至少一个选项。</p>
<p>内置验证器的构造器有一个 <code class="docutils literal notranslate"><span class="pre">error_message</span></code> 参数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">IS_NOT_EMPTY</span><span class="p">(</span><span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;cannot be empty!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>注意， <code class="docutils literal notranslate"><span class="pre">error_message</span></code> 通常是构造器的第一个可选参数，而且一般不用参数名称。因此，以下语法是等效的： <code class="docutils literal notranslate"><span class="pre">IS_NOT_EMPTY('cannot</span> <span class="pre">be</span> <span class="pre">empty!')</span></code></p>
<p>如果你想像上一章中解释的那样使用国际化，你需要定义自己的消息，并将验证器消息包装在 T 运算符中：</p>
<blockquote>
<div><p>IS_NOT_EMPTY(error_message=T('cannot be empty!'))</p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">IS_NOT_EMPTY</span><span class="p">(</span><span class="s1">&#39;cannot be empty!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>这是一个基于数据库表的验证器示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_NOT_EMPTY</span><span class="p">(</span><span class="n">error_message</span><span class="o">=</span><span class="n">T</span><span class="p">(</span><span class="s1">&#39;fill this!&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>这里，我们使用了翻译运算符 <code class="docutils literal notranslate"><span class="pre">T</span></code> 来实现国际化。注意，默认情况下，error messages 是不被翻译的，除非你明确地使用 <code class="docutils literal notranslate"><span class="pre">T</span></code> 对其进行了定义</p>
<p>还可以为字段显式调用验证器：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>如果 value 有效，验证器会返回一个元组 <code class="docutils literal notranslate"><span class="pre">(value,</span> <span class="pre">error)</span></code>，并且  <code class="docutils literal notranslate"><span class="pre">error</span></code> 是 <code class="docutils literal notranslate"><span class="pre">None</span></code> .</p>
<p>直接使用 Python ，你也能很容易地测试大部分验证器。例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">pydal.validators</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">IS_ALPHANUMERIC</span><span class="p">()(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="go">(&#39;test&#39;, None)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">IS_ALPHANUMERIC</span><span class="p">()(</span><span class="s1">&#39;test!&#39;</span><span class="p">)</span>
<span class="go">(&#39;test!&#39;, &#39;Enter only letters, numbers, and underscore&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">IS_ALPHANUMERIC</span><span class="p">(</span><span class="s1">&#39;this is not alphanumeric&#39;</span><span class="p">)(</span><span class="s1">&#39;test!&#39;</span><span class="p">)</span>
<span class="go">(&#39;test!&#39;, &#39;this is not alphanumeric&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">IS_ALPHANUMERIC</span><span class="p">(</span><span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;this is not alphanumeric&#39;</span><span class="p">)(</span><span class="s1">&#39;test!&#39;</span><span class="p">)</span>
<span class="go">(&#39;test!&#39;, &#39;this is not alphanumeric&#39;)</span>
</pre></div>
</div>
<div class="admonition hint">
<p class="admonition-title">提示</p>
<p>在 python 的源代码中， DAL 验证器有完整的文档。你自己就能很容易地查看验证器的所有详细信息：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pydal</span><span class="w"> </span><span class="kn">import</span> <span class="n">validators</span>
<span class="nb">dir</span><span class="p">(</span><span class="n">validators</span><span class="p">)</span> <span class="c1"># get the list of all validators</span>
<span class="n">help</span><span class="p">(</span><span class="n">validators</span><span class="o">.</span><span class="n">IS_URL</span><span class="p">)</span> <span class="c1"># get specific help for the IS_URL validator</span>
</pre></div>
</div>
</div>
<section id="text-format-validators">
<h3>文本格式的验证器<a class="headerlink" href="#text-format-validators" title="Link to this heading"></a></h3>
<section id="is-alphanumeric">
<h4><code class="docutils literal notranslate"><span class="pre">IS_ALPHANUMERIC</span></code><a class="headerlink" href="#is-alphanumeric" title="Link to this heading"></a></h4>
<p>此验证器检查字段的值是否仅包含 a-z、 A-Z、 0-9 和下划线中的字符。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_ALPHANUMERIC</span><span class="p">(</span><span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;must be alphanumeric!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="is-lower">
<h4><code class="docutils literal notranslate"><span class="pre">IS_LOWER</span></code><a class="headerlink" href="#is-lower" title="Link to this heading"></a></h4>
<p>此验证器不返回错误信息，它只是把值转换为小写。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_LOWER</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="is-upper">
<h4><code class="docutils literal notranslate"><span class="pre">IS_UPPER</span></code><a class="headerlink" href="#is-upper" title="Link to this heading"></a></h4>
<p>此验证器不返回错误信息，它只是把值转换为大写。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_UPPER</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="is-email">
<h4><code class="docutils literal notranslate"><span class="pre">IS_EMAIL</span></code><a class="headerlink" href="#is-email" title="Link to this heading"></a></h4>
<p>它检查字段值是否看起来像电子邮件地址。它不会尝试发送电子邮件进行确认。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_EMAIL</span><span class="p">(</span><span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;invalid email!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="is-match">
<h4><code class="docutils literal notranslate"><span class="pre">IS_MATCH</span></code><a class="headerlink" href="#is-match" title="Link to this heading"></a></h4>
<p>此验证器将值与一个正则表达式进行匹配，如果失败则返回错误信息。这里是一个用来验证美国邮政编码的示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_MATCH</span><span class="p">(</span><span class="s1">&#39;^\d</span><span class="si">{5}</span><span class="s1">(-\d</span><span class="si">{4}</span><span class="s1">)?$&#39;</span><span class="p">,</span>
    <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;not a zip code&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>这是一个用来验证 IPv4 地址的示例（注意：IS_IPV4 验证器会更适合）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_MATCH</span><span class="p">(</span><span class="s1">&#39;^\d{1,3}(\.\d{1,3})</span><span class="si">{3}</span><span class="s1">$&#39;</span><span class="p">,</span>
        <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;not an IP address&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>这是一个用来验证美国电话号码的示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_MATCH</span><span class="p">(</span><span class="s1">&#39;^1?((-)\d</span><span class="si">{3}</span><span class="s1">-?|\(\d</span><span class="si">{3}</span><span class="s1">\))\d</span><span class="si">{3}</span><span class="s1">-?\d</span><span class="si">{4}</span><span class="s1">$&#39;</span><span class="p">,</span>
        <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;not a phone number&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>要更多地了解 Python 正则表达式，请参考 Python 的官方在线文档。</p>
<p>&quot;<code class="docutils literal notranslate"><span class="pre">IS_MATCH</span></code> 有一个可选参数  <code class="docutils literal notranslate"><span class="pre">strict</span></code> ，其值默认为 <code class="docutils literal notranslate"><span class="pre">False</span></code>。如果被设置为 <code class="docutils literal notranslate"><span class="pre">True</span></code> ，验证器仅按整个字符串（从头到尾）进行匹配。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">IS_MATCH</span><span class="p">(</span><span class="s1">&#39;ab&#39;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)(</span><span class="s1">&#39;abc&#39;</span><span class="p">)</span>
<span class="go">(&#39;abc&#39;, None)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">IS_MATCH</span><span class="p">(</span><span class="s1">&#39;ab&#39;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="s1">&#39;abc&#39;</span><span class="p">)</span>
<span class="go">(&#39;abc&#39;, &#39;Invalid expression&#39;)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">IS_MATCH</span></code> 还有一个可选参数 <code class="docutils literal notranslate"><span class="pre">search</span></code> ，其值默认为 <code class="docutils literal notranslate"><span class="pre">False</span></code>。如果被设置为 <code class="docutils literal notranslate"><span class="pre">True</span></code> ，验证器将使用正则方法 <code class="docutils literal notranslate"><span class="pre">search</span></code> 代替 <code class="docutils literal notranslate"><span class="pre">match</span></code> 方法去验证字符串。</p>
<p><code class="docutils literal notranslate"><span class="pre">IS_MATCH('...',</span> <span class="pre">extract=True)</span></code> 过滤并仅提取第一个匹配的子字符串，而不是原始值。</p>
</section>
<section id="is-length">
<h4><code class="docutils literal notranslate"><span class="pre">IS_LENGTH</span></code><a class="headerlink" href="#is-length" title="Link to this heading"></a></h4>
<p>检查字段值的长度是否在给的范围内。适用于 text 和 file 。</p>
<p>它的参数是</p>
<ul class="simple">
<li><p>maxsize: 允许的最大长度/大小（默认为 255）</p></li>
<li><p>minsize: 允许的最小长度/大小</p></li>
</ul>
<p>示例：检查文本字符串是否少于 15 个字符：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">IS_LENGTH</span><span class="p">(</span><span class="mi">15</span><span class="p">)(</span><span class="s1">&#39;example string&#39;</span><span class="p">)</span>
<span class="go">(&#39;example string&#39;, None)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">IS_LENGTH</span><span class="p">(</span><span class="mi">15</span><span class="p">)(</span><span class="s1">&#39;example long string&#39;</span><span class="p">)</span>
<span class="go">(&#39;example long string&#39;, &#39;Enter from 0 to 15 characters&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">IS_LENGTH</span><span class="p">(</span><span class="mi">15</span><span class="p">)(</span><span class="s1">&#39;33&#39;</span><span class="p">)</span>
<span class="go">(&#39;33&#39;, None)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">IS_LENGTH</span><span class="p">(</span><span class="mi">15</span><span class="p">)(</span><span class="mi">33</span><span class="p">)</span>
<span class="go">(&#39;33&#39;, None)</span>
</pre></div>
</div>
<p>检查上传的文件大小是否在 1KB 到 1MB 之间：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">INPUT</span><span class="p">(</span><span class="n">_type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">IS_LENGTH</span><span class="p">(</span><span class="mi">1048576</span><span class="p">,</span> <span class="mi">1024</span><span class="p">))</span>
</pre></div>
</div>
<p>除了文件类型的字段，它检查字段值的长度（字符个数）。在是文件的情况下，值是一个 <code class="docutils literal notranslate"><span class="pre">cgi.FieldStorage</span></code> 对象，因此他检查文件中数据的长度，这是人们直观预期的行为。</p>
</section>
<section id="is-url">
<h4><code class="docutils literal notranslate"><span class="pre">IS_URL</span></code><a class="headerlink" href="#is-url" title="Link to this heading"></a></h4>
<p>如果以下任何一项为真，则不是 URL 字符串：</p>
<ul class="simple">
<li><p>字符串为 空 或者 None</p></li>
<li><p>字符串中使用了 URL 不允许的字符。</p></li>
<li><p>该字符串违反了任何 HTTP 语法规则</p></li>
<li><p>指定了 URL 架构，但不是 'http' 或 'https'</p></li>
<li><p>如果指定了主机名，但顶层域名不存在</p></li>
</ul>
<p>(这些规则基于 <code class="docutils literal notranslate"><span class="pre">RFC</span> <span class="pre">2616</span></code>)</p>
<p>此函数仅按 URL 语法进行检查。它不检查 URL 是否指向了一个真正的文件，或</p>
<ul class="simple">
<li><p>字符串为 空 或者 None</p></li>
<li><p>字符串中使用了 URL 不允许的字符。</p></li>
<li><p>指定的 URL 架构无效</p></li>
</ul>
<p>这些规则基于 <code class="docutils literal notranslate"><span class="pre">RFC</span> <span class="pre">2396</span></code></p>
<p>允许的架构列表可以使用 allowd_schemes 参数进行自定义。如果从列表中排除 None，则缩写 URL（缺少 “http” 等架构）将被视为无效。</p>
<p>默认的预置架构可以使用 prepend_scheme 参数进行自定义。如果将 repend_scheme 设置为 None，则预先添加架构操作将被禁用。仍将接受需要预先添加架构才能解析的 URL，但不会修改返回值。</p>
<p>IS_URL 与 <code class="docutils literal notranslate"><span class="pre">RFC</span> <span class="pre">3490</span></code> 中指定的国际化域名（IDN）标准兼容。因此，URL 可以是常规字符串或 unicode 字符串。如果 URL 的域组件（例如 google.ca）包含非美国 ASCII 字母，则域将转换为 Punycode（在 <code class="docutils literal notranslate"><span class="pre">RFC</span> <span class="pre">3492</span></code> 中定义）。IS_URL 超出了标准，允许非美国 ASCII 字符出现在 URL 的路径和查询组件中。这些非美国 ASCII 字符将被编码。例如，空格将被编码为 “%20”。十六进制代码为 0x4e86 的 unicode 字符将变为 “%4e%86” 。</p>
<p>示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_URL</span><span class="p">())</span>
<span class="n">requires</span> <span class="o">=</span> <span class="n">IS_URL</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;generic&#39;</span><span class="p">)</span>
<span class="n">requires</span> <span class="o">=</span> <span class="n">IS_URL</span><span class="p">(</span><span class="n">allowed_schemes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;https&#39;</span><span class="p">])</span>
<span class="n">requires</span> <span class="o">=</span> <span class="n">IS_URL</span><span class="p">(</span><span class="n">prepend_scheme</span><span class="o">=</span><span class="s1">&#39;https&#39;</span><span class="p">)</span>
<span class="n">requires</span> <span class="o">=</span> <span class="n">IS_URL</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;generic&#39;</span><span class="p">,</span>
                <span class="n">allowed_schemes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ftps&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">],</span>
                <span class="n">prepend_scheme</span><span class="o">=</span><span class="s1">&#39;https&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="is-safe">
<h4><code class="docutils literal notranslate"><span class="pre">IS_SAFE</span></code><a class="headerlink" href="#is-safe" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_SAFE</span><span class="p">(</span><span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;Unsafe Content&#39;</span><span class="p">)</span>
<span class="n">requires</span> <span class="o">=</span> <span class="n">IS_SAFE</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;sanitize&quot;</span><span class="p">)</span>
<span class="n">requires</span> <span class="o">=</span> <span class="n">IS_SAFE</span><span class="p">(</span><span class="n">sanitizer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">XML</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
</pre></div>
</div>
<p>此验证器用于应包含 HTML 且可能包含无效标签（脚本、成员、对象、iframe）的文本字段。它的工作原理是尝试对内容进行净化（去除或编码不安全的内容），并提供错误（mode=&quot;error&quot;）或用净化后的内容替换内容（mode=&quot;sanitize&quot;）。您可以指定错误消息、模式，并提供自己的净化函数。</p>
</section>
<section id="is-slug">
<h4><code class="docutils literal notranslate"><span class="pre">IS_SLUG</span></code><a class="headerlink" href="#is-slug" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_SLUG</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;must be slug&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>如果 <code class="docutils literal notranslate"><span class="pre">check</span></code> 设置为 <code class="docutils literal notranslate"><span class="pre">True</span></code> ，则检查验证值是否符合 slug 规则（只允许字母、数字和不重复的破折号）。</p>
<p>如果 <code class="docutils literal notranslate"><span class="pre">check</span></code> 设置为 <code class="docutils literal notranslate"><span class="pre">False</span></code> （默认），它把输入值转换成符合 slug 规则的内容。</p>
</section>
<section id="is-json">
<h4><code class="docutils literal notranslate"><span class="pre">IS_JSON</span></code><a class="headerlink" href="#is-json" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_JSON</span><span class="p">(</span><span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;Invalid json&#39;</span><span class="p">,</span> <span class="n">native_json</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>此验证器检查字段值是否为 JSON 格式。</p>
<p>如果 <code class="docutils literal notranslate"><span class="pre">native_json</span></code> 设置为 <code class="docutils literal notranslate"><span class="pre">False</span></code> （默认值），则将输入值转换为序列化值，否则输入值保持不变。</p>
</section>
</section>
<section id="date-and-time-validators">
<h3>日期和时间的验证器<a class="headerlink" href="#date-and-time-validators" title="Link to this heading"></a></h3>
<section id="is-time">
<h4><code class="docutils literal notranslate"><span class="pre">IS_TIME</span></code><a class="headerlink" href="#is-time" title="Link to this heading"></a></h4>
<p>此验证器检查字段值是否是符合指定格式的时间</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_TIME</span><span class="p">(</span><span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;must be HH:MM:SS!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="is-date">
<h4><code class="docutils literal notranslate"><span class="pre">IS_DATE</span></code><a class="headerlink" href="#is-date" title="Link to this heading"></a></h4>
<p>此验证器检查字段值是否是符合指定格式的日期。建议指定使用翻译操作符 T 的格式，这样可以在不同区域环境下支持不同的格式。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_DATE</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="n">T</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
    <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;must be YYYY-MM-DD!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>在 <code class="docutils literal notranslate"><span class="pre">IS_DATETIME</span></code> 验证器部分，可以查看 <code class="docutils literal notranslate"><span class="pre">%</span></code> 指令的完整描述。</p>
</section>
<section id="is-datetime">
<h4><code class="docutils literal notranslate"><span class="pre">IS_DATETIME</span></code><a class="headerlink" href="#is-datetime" title="Link to this heading"></a></h4>
<p>此验证器检查字段值是否是符合指定格式的日期时间。建议指定使用翻译操作符 T 的格式，这样可以在不同区域环境下支持不同的格式。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_DATETIME</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="n">T</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">),</span>
                   <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;must be YYYY-MM-DD HH:MM:SS!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>以下符号可用于定义格式的字符串（展示了符号、其含义和示例字符串）：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>%Y  year with century (e.g. &#39;1963&#39;)
%y  year without century (e.g. &#39;63&#39;)
%d  day of the month (e.g. &#39;28&#39;)
%m  month (e.g &#39;08&#39;)
%b  abbreviated month name (e.g.&#39;Aug&#39;)
%B  full month name (e.g. &#39;August&#39;)
%H  hour (24-hour clock, e.g. &#39;14&#39;)
%I  hour (12-hour clock, e.g. &#39;02&#39;)
%p  either &#39;AM&#39; or &#39;PM&#39;
%M  minute (e.g. &#39;30&#39;)
%S  second (e.g. &#39;59&#39;)
</pre></div>
</div>
</section>
<section id="is-date-in-range">
<h4><code class="docutils literal notranslate"><span class="pre">IS_DATE_IN_RANGE</span></code><a class="headerlink" href="#is-date-in-range" title="Link to this heading"></a></h4>
<p>其作用和前面的验证器类似，但需在指定的范围内：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_DATE_IN_RANGE</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="n">T</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
                <span class="n">minimum</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">maximum</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
                <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;must be YYYY-MM-DD!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>在 <code class="docutils literal notranslate"><span class="pre">IS_DATETIME</span></code> 验证器部分，可以查看 <code class="docutils literal notranslate"><span class="pre">%</span></code> 指令的完整描述。</p>
</section>
<section id="is-datetime-in-range">
<h4><code class="docutils literal notranslate"><span class="pre">IS_DATETIME_IN_RANGE</span></code><a class="headerlink" href="#is-datetime-in-range" title="Link to this heading"></a></h4>
<p>其作用和前面的验证器类似，但需在指定的范围内：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_DATETIME_IN_RANGE</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="n">T</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">),</span>
                    <span class="n">minimum</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                    <span class="n">maximum</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span>
                    <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;must be YYYY-MM-DD HH:MM::SS!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>在 <code class="docutils literal notranslate"><span class="pre">IS_DATETIME</span></code> 验证器部分，可以查看 <code class="docutils literal notranslate"><span class="pre">%</span></code> 指令的完整描述。</p>
</section>
</section>
<section id="range-set-and-equality-validators">
<h3>范围、集合和相等的验证器<a class="headerlink" href="#range-set-and-equality-validators" title="Link to this heading"></a></h3>
<section id="is-equal-to">
<h4><code class="docutils literal notranslate"><span class="pre">IS_EQUAL_TO</span></code><a class="headerlink" href="#is-equal-to" title="Link to this heading"></a></h4>
<p>检查被验证的值是否等于已给定的值（可以是一个变量）</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_EQUAL_TO</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
                    <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;passwords do not match&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="is-not-empty">
<h4><code class="docutils literal notranslate"><span class="pre">IS_NOT_EMPTY</span></code><a class="headerlink" href="#is-not-empty" title="Link to this heading"></a></h4>
<p>这个验证器检查字段值的内容是否不是 None 、空字符串或者空列表。一个字符串类型的值会在调用 <code class="docutils literal notranslate"><span class="pre">.strip()</span></code> 之后才被检查。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_NOT_EMPTY</span><span class="p">(</span><span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;cannot be empty!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>您可以提供一个正则表达式来匹配空字符串。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_NOT_EMPTY</span><span class="p">(</span><span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;Enter a value&#39;</span><span class="p">,</span> <span class="n">empty_regex</span><span class="o">=</span><span class="s1">&#39;NULL(?i)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="is-null-or">
<h4><code class="docutils literal notranslate"><span class="pre">IS_NULL_OR</span></code><a class="headerlink" href="#is-null-or" title="Link to this heading"></a></h4>
<p>已弃用，如下所述的 IS_EMPTY_OR 的别名。</p>
</section>
<section id="is-empty-or">
<h4><code class="docutils literal notranslate"><span class="pre">IS_EMPTY_OR</span></code><a class="headerlink" href="#is-empty-or" title="Link to this heading"></a></h4>
<p>有时，需要在一个有其他要求的字段上允许空值。例如，一个要求是日期的字段值也可以为空。 <code class="docutils literal notranslate"><span class="pre">IS_EMPTY_OR</span></code> 验证器允许这样做：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_EMPTY_OR</span><span class="p">(</span><span class="n">IS_DATE</span><span class="p">())</span>
</pre></div>
</div>
<p>一个空值是 None，或者是一个空字符串，还可以是一个空列表。字符串类型的值在调用  <code class="docutils literal notranslate"><span class="pre">.strip()</span></code> 之后才被检查。</p>
<p>您可以为 <code class="docutils literal notranslate"><span class="pre">empty_regex</span></code> 参数提供一个正则表达式，用于将空字符串的匹配（类似 IS_NOT_empty 验证器）。</p>
<p>还可以指定一个用于 “被视为空” 的值。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_EMPTY_OR</span><span class="p">(</span><span class="n">IS_ALPHANUMERIC</span><span class="p">(),</span> <span class="n">null</span><span class="o">=</span><span class="s1">&#39;anonymous&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="is-expr">
<h4><code class="docutils literal notranslate"><span class="pre">IS_EXPR</span></code><a class="headerlink" href="#is-expr" title="Link to this heading"></a></h4>
<p>此验证器允许您通过可调用函数来表达一般条件，该函数接受一个值进行验证并返回错误消息，或返回 <code class="docutils literal notranslate"><span class="pre">None</span></code> 以接受输入值。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_EXPR</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">T</span><span class="p">(</span><span class="s1">&#39;not divisible by 3&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>注意</strong> ，如果您不像上面一样处理，返回的消息将不会被翻译。</p>
<p>为了向后兼容，条件可以表示为包含变量值逻辑表达式的字符串。如果表达式的计算结果为 <code class="docutils literal notranslate"><span class="pre">True</span></code> ，字段值将通过验证。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_EXPR</span><span class="p">(</span><span class="s1">&#39;int(value) % 3 == 0&#39;</span><span class="p">,</span>
               <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;not divisible by 3&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>应该首先确保值是一个整数，以避免发生异常。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="p">[</span><span class="n">IS_INT_IN_RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">IS_EXPR</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">T</span><span class="p">(</span><span class="s1">&#39;not divisible by 3&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">%</span> <span class="mi">3</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)]</span>
</pre></div>
</div>
</section>
<section id="is-decimal-in-range">
<h4><code class="docutils literal notranslate"><span class="pre">IS_DECIMAL_IN_RANGE</span></code><a class="headerlink" href="#is-decimal-in-range" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">INPUT</span><span class="p">(</span><span class="n">_type</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">IS_DECIMAL_IN_RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">dot</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>它将输入转换为 Python 十进制。如果十进制不在指定的包含范围内，则生成错误。使用Python 十进制算法进行比较。</p>
<p>最小和最大限制可以是 None，那分别表示没有下限或上限，</p>
<p><code class="docutils literal notranslate"><span class="pre">dot</span></code> 参数是可选的，允许您将用于分隔小数的符号国际化。</p>
</section>
<section id="is-float-in-range">
<h4><code class="docutils literal notranslate"><span class="pre">IS_FLOAT_IN_RANGE</span></code><a class="headerlink" href="#is-float-in-range" title="Link to this heading"></a></h4>
<p>检查字段值是否为一定范围内的浮点数，在以下示例中为 <code class="docutils literal notranslate"><span class="pre">0</span> <span class="pre">&lt;=</span> <span class="pre">value</span> <span class="pre">&lt;=</span> <span class="pre">100</span></code> ：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_FLOAT_IN_RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">dot</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
                            <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;negative or too large!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">dot</span></code> 参数是可选的，允许您将用于分隔小数的符号国际化。</p>
</section>
<section id="is-int-in-range">
<h4><code class="docutils literal notranslate"><span class="pre">IS_INT_IN_RANGE</span></code><a class="headerlink" href="#is-int-in-range" title="Link to this heading"></a></h4>
<dl>
<dt>检查字段值是否为一定范围内的整数，</dt><dd><p>在以下示例中为 <code class="docutils literal notranslate"><span class="pre">0</span> <span class="pre">&lt;=</span> <span class="pre">value</span> <span class="pre">&lt;</span> <span class="pre">100</span></code> ：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_INT_IN_RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span>
                        <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;negative or too large!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="is-in-set">
<h4><code class="docutils literal notranslate"><span class="pre">IS_IN_SET</span></code><a class="headerlink" href="#is-in-set" title="Link to this heading"></a></h4>
<p>此验证器将自动将表单字段设置为选项字段（即，使用下拉菜单）。</p>
<p><code class="docutils literal notranslate"><span class="pre">IS_IN_SET</span></code> 检查字段值是否在集合中：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IN_SET</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">],</span> <span class="n">zero</span><span class="o">=</span><span class="n">T</span><span class="p">(</span><span class="s1">&#39;choose one&#39;</span><span class="p">),</span>
             <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;must be a or b or c&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">zero</span></code> 参数是可选的，它决定了默认选择的选项的文本， <code class="docutils literal notranslate"><span class="pre">IS_IN_SET</span></code> 验证器本身不接受该选项。如果你不想默认 “选择一个” 选项，请设置为 <code class="docutils literal notranslate"><span class="pre">zero=None</span></code> 。</p>
<p>只要 <code class="docutils literal notranslate"><span class="pre">IS_IN_SET</span></code> 是列表中的第一个，该集合的元素就可以与数字验证器组合。这样做将强制后面的验证器转换为数字类型。因此， <code class="docutils literal notranslate"><span class="pre">S_IN_SET</span></code> 后面可以跟 <code class="docutils literal notranslate"><span class="pre">IS_INT_IN_RANGE</span></code> （将值转换为 INT）或 <code class="docutils literal notranslate"><span class="pre">IS_FLOAT_IN_RANGE</span></code> （将值转化为 FLOAT）。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="p">[</span> <span class="n">IS_IN_SET</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;must be prime and less than 10&#39;</span><span class="p">),</span>
            <span class="n">IS_INT_IN_RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="p">]</span>
</pre></div>
</div>
</section>
<section id="checkbox-validation">
<h4>复选框验证<a class="headerlink" href="#checkbox-validation" title="Link to this heading"></a></h4>
<p>要强制填写表格复选框（例如接受条款和条件），请使用以下命令：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span><span class="o">=</span><span class="n">IS_IN_SET</span><span class="p">([</span><span class="s1">&#39;ON&#39;</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="dictionaries-and-tuples-with-is-in-set">
<h4>在 IS_IN_SET 中使用字典和元组<a class="headerlink" href="#dictionaries-and-tuples-with-is-in-set" title="Link to this heading"></a></h4>
<p>您还可以使用字典或元组列表使下拉列表更具描述性：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dictionary example:</span>
<span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IN_SET</span><span class="p">({</span><span class="s1">&#39;A&#39;</span><span class="p">:</span><span class="s1">&#39;Apple&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span><span class="s1">&#39;Banana&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span><span class="s1">&#39;Cherry&#39;</span><span class="p">},</span> <span class="n">zero</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># List of tuples example:</span>
<span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IN_SET</span><span class="p">([(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;Apple&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;Banana&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;Cherry&#39;</span><span class="p">)])</span>
</pre></div>
</div>
</section>
<section id="sorted-options">
<h4>排序选项<a class="headerlink" href="#sorted-options" title="Link to this heading"></a></h4>
<p>要在下拉列表中按标签的字母顺序排列选项，请在 <code class="docutils literal notranslate"><span class="pre">IS_IN_SET</span></code> 中使用 <code class="docutils literal notranslate"><span class="pre">sort</span></code> 参数。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">IS_IN_SET</span><span class="p">([(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;Hulk&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;Superman&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;Batman&#39;</span><span class="p">)],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="is-in-set-and-tagging">
<h4><code class="docutils literal notranslate"><span class="pre">IS_IN_SET</span></code> 和标记<a class="headerlink" href="#is-in-set-and-tagging" title="Link to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">IS_IN_SET</span></code> 验证器具有可选属性 <code class="docutils literal notranslate"><span class="pre">multiple=False</span></code> 。如果设置为 True，则可以在一个字段中存储多个值。字段的类型应为 <code class="docutils literal notranslate"><span class="pre">list:integer</span></code> 或 <code class="docutils literal notranslate"><span class="pre">list:string</span></code> ，如 <a class="reference internal" href="chapter-07.html#list-type-and-contains"><span class="std std-ref">list:&lt;type&gt; 和 contains</span></a> 中所述。这里讨论了一个明确的标记示例。我们强烈建议使用 jQuery multiselect 插件来呈现多个值的字段。</p>
<p><strong>请注意</strong> ，当 <code class="docutils literal notranslate"><span class="pre">multiple=True</span></code> 时， <code class="docutils literal notranslate"><span class="pre">IS_IN_SET</span></code> 将接受零个或多个值，即当没有选择任何值时，它将接受该字段。 <code class="docutils literal notranslate"><span class="pre">multiple</span></code> 也可以是 <code class="docutils literal notranslate"><span class="pre">(a,</span> <span class="pre">b)</span></code> 形式的元组，其中 <code class="docutils literal notranslate"><span class="pre">a</span></code> 和 <code class="docutils literal notranslate"><span class="pre">b</span></code> 分别是可以选择的最小和（不包括）最大项目数。</p>
</section>
</section>
<section id="complexity-and-security-validators">
<h3>复杂性和安全性的验证器<a class="headerlink" href="#complexity-and-security-validators" title="Link to this heading"></a></h3>
<section id="is-strong">
<h4><code class="docutils literal notranslate"><span class="pre">IS_STRONG</span></code><a class="headerlink" href="#is-strong" title="Link to this heading"></a></h4>
<p>强制对字段执行复杂性要求（通常用于密码字段）。</p>
<p>示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_STRONG</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">special</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>参数：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">min</span></code> 是值的长度的最小值</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">special</span></code> 是需要的特殊字符的最小数目，默认的特殊字符是 <code class="docutils literal notranslate"><span class="pre">^!!&#64;#$%^&amp;*()_+-=?&lt;&gt;,.:;{}[]|</span></code> （你可以使用 <code class="docutils literal notranslate"><span class="pre">specials</span> <span class="pre">=</span> <span class="pre">'...'</span></code> 对其进行自定义）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">upper</span></code> 是值中大写字符的最小数目</p></li>
</ul>
<p>其它可使用的参数是：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">invalid</span></code> 用于禁止使用的字符的列表，默认是 <code class="docutils literal notranslate"><span class="pre">invalid='</span> <span class="pre">&quot;'</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max</span></code> 是值的长度的最大值</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lower</span></code>  是值中小写字符的最小数目</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">number</span></code> 是数字字符的最小数目</p></li>
</ul>
<p>显然，您可以像其他验证器一样提供 <code class="docutils literal notranslate"><span class="pre">error_message</span></code> ，尽管 <code class="docutils literal notranslate"><span class="pre">IS_STRONG</span></code> 足够聪明，可以提供一条清晰的消息来描述验证失败。</p>
<p>您可以使用的一个特殊参数是 <code class="docutils literal notranslate"><span class="pre">entropy</span></code> ，它是要接受的值（一个数字）的复杂性的最小值，请尝试：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">IS_STRONG</span><span class="p">(</span><span class="n">entropy</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="go">(&#39;hello&#39;, Entropy (24.53) less than required (100.0))</span>
</pre></div>
</div>
<p><strong>请注意</strong> ，如果参数 <code class="docutils literal notranslate"><span class="pre">entropy</span></code> 没有给出，则 <code class="docutils literal notranslate"><span class="pre">IS_STRONG</span></code> 隐式设置以下默认值：<code class="docutils literal notranslate"><span class="pre">min</span> <span class="pre">=</span> <span class="pre">8,</span> <span class="pre">upper</span> <span class="pre">=</span> <span class="pre">1,</span> <span class="pre">lower</span> <span class="pre">=</span> <span class="pre">1,</span> <span class="pre">number</span> <span class="pre">=</span> <span class="pre">1,</span> <span class="pre">special</span> <span class="pre">=</span> <span class="pre">1</span></code>，否则都设置为None。</p>
</section>
<section id="crypt">
<h4><code class="docutils literal notranslate"><span class="pre">CRYPT</span></code><a class="headerlink" href="#crypt" title="Link to this heading"></a></h4>
<p>这也是一个过滤器。它对输入执行安全散列，用于防止密码以明文形式传递到数据库</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">CRYPT</span><span class="p">()</span>
</pre></div>
</div>
<p>默认情况下，CRYPT 使用 1000 次迭代的 pbkdf2 算法结合 SHA512 来生成 20 字节长的哈希值。旧版本的 web2py 使用 md5 或 HMAC+SHA512 ，具体取决于是否指定了密钥。</p>
<p>如果指定了密钥（ key 参数），CRYPT 将使用 HMAC 算法。密钥可能包含一个前缀，用于确定与 HMAC一起使用的算法，例如 SHA512 ：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">CRYPT</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;sha512:thisisthekey&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>这是推荐的语法。密钥必须是与所使用的数据库关联的唯一字符串。钥匙永远不能改变。如果你丢失了密钥，之前散列的值将变得无用。默认情况下，CRYPT 使用随机的 salt，因此每个结果都不同。要使用恒定的 salt 值，请指定其值：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">CRYPT</span><span class="p">(</span><span class="n">salt</span><span class="o">=</span><span class="s1">&#39;mysaltvalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>或者，不使用 salt：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">CRYPT</span><span class="p">(</span><span class="n">salt</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>CRYPT 验证器对其输入进行哈希运算，这使得它有点特别。如果需要在散列之前验证密码字段，可以在验证器列表中使用 CRYPT，但必须确保它是列表中的最后一个，以便最后调用它。例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="p">[</span><span class="n">IS_STRONG</span><span class="p">(),</span> <span class="n">CRYPT</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;sha512:thisisthekey&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">CRYPT</span></code> 还接受一个 <code class="docutils literal notranslate"><span class="pre">min_length</span></code> 参数，其默认值为 0</p>
<p>生成的哈希采用 <code class="docutils literal notranslate"><span class="pre">alg$salt$hash</span></code> 的形式，其中 <code class="docutils literal notranslate"><span class="pre">alg</span></code> 是使用的哈希算法， <code class="docutils literal notranslate"><span class="pre">salt</span></code> 是 salt 字符串（可以为空）， <code class="docutils literal notranslate"><span class="pre">hash</span></code> 是算法的输出。因此，哈希是自我识别的，例如，在不使之前的哈希无效的情况下，允许更改算法。然而，密钥必须保持不变。</p>
</section>
</section>
<section id="special-type-validators">
<h3>特殊类型的验证器<a class="headerlink" href="#special-type-validators" title="Link to this heading"></a></h3>
<section id="is-list-of">
<h4><code class="docutils literal notranslate"><span class="pre">IS_LIST_OF</span></code><a class="headerlink" href="#is-list-of" title="Link to this heading"></a></h4>
<p>此验证器可帮助您确保列表类型值的长度限制，为此，请使用其 <code class="docutils literal notranslate"><span class="pre">minimum`</span> <span class="pre">`、</span> <span class="pre">``maximum</span></code> 和 <code class="docutils literal notranslate"><span class="pre">error_message</span></code> 参数，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_LIST_OF</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>列表值可能来自包含多个同名字段的表单或多选框。请注意，此验证器会自动将非列表值转换为单值列表：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">IS_LIST_OF</span><span class="p">()(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="go">([&#39;hello&#39;], None)</span>
</pre></div>
</div>
<p>如果 IS_LIST_OF 的第一个参数是另一个验证器，那么它会将另一个验证器应用于列表的每个元素。一个典型的用法是验证 <code class="docutils literal notranslate"><span class="pre">list:</span></code> 类型字段，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Field</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;list:string&#39;</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">IS_LIST_OF</span><span class="p">(</span><span class="n">IS_EMAIL</span><span class="p">()),</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="is-list-of-emails">
<h4><code class="docutils literal notranslate"><span class="pre">IS_LIST_OF_EMAILS</span></code><a class="headerlink" href="#is-list-of-emails" title="Link to this heading"></a></h4>
<p>此验证器被专门设计以用于以下字段：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Field</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">,</span> <span class="s1">&#39;list:string&#39;</span><span class="p">,</span>
      <span class="n">widget</span><span class="o">=</span><span class="n">SQLFORM</span><span class="o">.</span><span class="n">widgets</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">widget</span><span class="p">,</span>
    <span class="n">requires</span><span class="o">=</span><span class="n">IS_LIST_OF_EMAILS</span><span class="p">(),</span>
    <span class="n">represent</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span>
        <span class="n">XML</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">A</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_href</span><span class="o">=</span><span class="s1">&#39;mailto:&#39;</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">xml</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">v</span> <span class="ow">or</span> <span class="p">[])]))</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>请注意，由于 <code class="docutils literal notranslate"><span class="pre">widget</span></code> 的自定义，此字段将被呈现为 SQLFORM 中的文本区域（请参阅下一节 [[Widgets #Widgets]] ）。这允许您在单个输入字段中插入和编辑多封电子邮件（非常像普通邮件客户端程序），用 <code class="docutils literal notranslate"><span class="pre">,</span></code> 、 <code class="docutils literal notranslate"><span class="pre">;</span></code> 或 空白（空格、换行符或制表符）分隔每个电子邮件地址。因此，现在我们需要一个能够对单个值输入进行操作的验证器，以及一种将验证后的值拆分为 DAL 下一步处理的列表的方法。这是由 <code class="docutils literal notranslate"><span class="pre">requires</span></code> 验证器完成的。作为 <code class="docutils literal notranslate"><span class="pre">filter_in</span></code> 的替代方法，您可以将以下函数传递给表单 <code class="docutils literal notranslate"><span class="pre">accepts</span></code> 、 <code class="docutils literal notranslate"><span class="pre">process</span></code> 或 <code class="docutils literal notranslate"><span class="pre">validate</span></code> 方法的 <code class="docutils literal notranslate"><span class="pre">onvalidation</span></code> 参数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">emails_onvalidation</span><span class="p">(</span><span class="n">form</span><span class="p">):</span>
    <span class="n">form</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">emails</span> <span class="o">=</span> <span class="n">IS_LIST_OF_EMAILS</span><span class="o">.</span><span class="n">split_emails</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">emails</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">represent</span></code> 参数（第6行和第7行）的作用是在 HTML 页面中呈现记录时，为每个电子邮件地址添加一个 “mailto:...” 链接。</p>
</section>
<section id="any-of">
<h4><code class="docutils literal notranslate"><span class="pre">ANY_OF</span></code><a class="headerlink" href="#any-of" title="Link to this heading"></a></h4>
<p>此验证器接受其它验证器组成的列表，如果列表中的任何验证器接受值，则它接受该值（即，它对给定的验证器的行为类似于逻辑 OR ）。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">ANY_OF</span><span class="p">([</span><span class="n">IS_ALPHANUMERIC</span><span class="p">(),</span> <span class="n">IS_EMAIL</span><span class="p">()])</span>
</pre></div>
</div>
<p>当没有验证器接受值时（验证失败），你会得到最后一个验证器的错误消息（列表中的最后一个），您可以像往常一样自定义错误消息：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ANY_OF</span><span class="p">([</span><span class="n">IS_ALPHANUMERIC</span><span class="p">(),</span> <span class="n">IS_EMAIL</span><span class="p">()])(</span><span class="s1">&#39;@ab.co&#39;</span><span class="p">)</span>
<span class="go">(&#39;@ab.co&#39;, &#39;Enter a valid email address&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ANY_OF</span><span class="p">([</span><span class="n">IS_ALPHANUMERIC</span><span class="p">(),</span> <span class="n">IS_EMAIL</span><span class="p">()],</span>
<span class="gp">... </span>       <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;Enter login or email&#39;</span><span class="p">)(</span><span class="s1">&#39;@ab.co&#39;</span><span class="p">)</span>
<span class="go">(&#39;@ab.co&#39;, &#39;Enter login or email&#39;)</span>
</pre></div>
</div>
</section>
<section id="is-image">
<h4><code class="docutils literal notranslate"><span class="pre">IS_IMAGE</span></code><a class="headerlink" href="#is-image" title="Link to this heading"></a></h4>
<p>此验证器检查通过文件输入上传的文件是否以所选图像格式之一保存，并且尺寸（宽度和高度）是否在给定范围内。</p>
<p>它不会检查最大文件大小（使用 IS_LENGTH ）。如果没有上传数据，则返回验证失败。它支持 BMP、GIF、JPEG、PNG 等文件格式，并且不需要 Python 图像库。</p>
<p>代码部分取自 ref.``source1``:cite （？）</p>
<p>它接受以下参数： - extensions:iterable 包含允许的小写图像文件扩展名； - maxsize:iterable 包含图像的最大宽度和高度； - minsize:iterate 包含图像的最小宽度和高度</p>
<p>使用 (-1, -1) 作为最小尺寸来避免图像尺寸检查。</p>
<p>这里有些示例：- 检查已上传的文件是否为任何支持的图像格式：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IMAGE</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><p>检查已上传的文件扩展名是否是  JPEG 或 PNG ：</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IMAGE</span><span class="p">(</span><span class="n">extensions</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">))</span>
</pre></div>
</div>
<ul class="simple">
<li><p>检查已上传的文件扩展名是否是 PNG ，且大小最大为  200x200 像素：</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IMAGE</span><span class="p">(</span><span class="n">extensions</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;png&#39;</span><span class="p">),</span> <span class="n">maxsize</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
</pre></div>
</div>
<p>注意：在显示包含 <code class="docutils literal notranslate"><span class="pre">requires=IS_IMAGE()``的表的编辑表单时，将不会出现</span> <span class="pre">``delete</span></code> 复选框，因为删除文件会导致验证失败。要显示 <code class="docutils literal notranslate"><span class="pre">delete</span></code> 复选框，请使用以下验证：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_EMPTY_OR</span><span class="p">(</span><span class="n">IS_IMAGE</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="is-file">
<h4><code class="docutils literal notranslate"><span class="pre">IS_FILE</span></code><a class="headerlink" href="#is-file" title="Link to this heading"></a></h4>
<p>检查通过文件输入上传的文件的名称和扩展名是否符合给定条件。</p>
<p>不以任何方式确保文件类型。如果没有上传数据，则返回验证失败。</p>
<p>它的参数是</p>
<ul class="simple">
<li><p>filename: 字符串/编译的正则表达式，或有效文件名的字符串/正则表达式列表</p></li>
<li><p>extension: 字符串/编译后的正则表达式，或有效扩展名的字符串/正则表达式列表</p></li>
<li><p>lastdot: 应将哪个点用作文件名/扩展名分隔符：<code class="docutils literal notranslate"><span class="pre">True</span></code> 表示最后一个点（例如，“file.tar.gz” 将被拆分为 “file.tar”+“gz” ），而 <code class="docutils literal notranslate"><span class="pre">False</span></code> 表示第一个点（例如，“file.tar.gz“ 将被拆分为 ”file”+“tar.gz” ）。</p></li>
<li><p>case: 0 表示保留原有的大小写；1 表示将字符串转换为小写（默认）；2 表示将字符串转换为大写。</p></li>
</ul>
<p>如果没有点，将对空字符串进行扩展名检查，并对整个值进行文件名检查。</p>
<p>示例：检查文件是否有 pdf 扩展名（不区分大小写）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">INPUT</span><span class="p">(</span><span class="n">_type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>
        <span class="n">requires</span><span class="o">=</span><span class="n">IS_FILE</span><span class="p">(</span><span class="n">extension</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>检查文件名是否为 'thumbnail' ，同时有 jpg 或 png 扩展名（不区分大小写）</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">INPUT</span><span class="p">(</span><span class="n">_type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>
        <span class="n">requires</span><span class="o">=</span><span class="n">IS_FILE</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;thumbnail&#39;</span><span class="p">,</span>
        <span class="n">extension</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<p>检查文件是否有 tar.gz 扩展名，同时文件名开头是 backup：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">INPUT</span><span class="p">(</span><span class="n">_type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>
        <span class="n">requires</span><span class="o">=</span><span class="n">IS_FILE</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;backup.*&#39;</span><span class="p">),</span>
        <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;tar.gz&#39;</span><span class="p">,</span> <span class="n">lastdot</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
<p>检查文件是否没有扩展名，并且文件名与 README 匹配（区分大小写）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">INPUT</span><span class="p">(</span><span class="n">_type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>
    <span class="n">requires</span><span class="o">=</span><span class="n">IS_FILE</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;README&#39;</span><span class="p">,</span>
    <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="is-upload-filename">
<h4><code class="docutils literal notranslate"><span class="pre">IS_UPLOAD_FILENAME</span></code><a class="headerlink" href="#is-upload-filename" title="Link to this heading"></a></h4>
<p>这是检查文件的旧实现，包括向后的兼容性。对于新应用程序，请使用 <code class="docutils literal notranslate"><span class="pre">IS_FILE()</span></code> 。</p>
<p>此验证器检查通过文件输入上传的文件的名称和扩展名是否符合给定的条件。</p>
<p>它不会以任何方式确保文件类型。如果没有上传数据，则返回验证失败。</p>
<p>它的参数是</p>
<ul class="simple">
<li><p>filename: 文件名（点之前的部分）正则表达式</p></li>
<li><p>extension: 扩展名（点之后的部分）正则表达式</p></li>
<li><p>lastdot: 应将哪个点用作文件名/扩展名分隔符：<code class="docutils literal notranslate"><span class="pre">True</span></code> 表示最后一个点（例如，“file.tar.gz” 将被拆分为 “file.tar”+“gz” ），而 <code class="docutils literal notranslate"><span class="pre">False</span></code> 表示第一个点（例如，“file.tar.gz“ 将被拆分为 ”file”+“tar.gz” ）。</p></li>
<li><p>case: 0 表示保留原有的大小写；1 表示将字符串转换为小写（默认）；2 表示将字符串转换为大写。</p></li>
</ul>
<p>如果没有点，将对空字符串进行扩展名检查，并对整个值进行文件名检查。</p>
<p>示例：</p>
<p>检查文件是否有 pdf 扩展名（不区分大小写）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_UPLOAD_FILENAME</span><span class="p">(</span><span class="n">extension</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>检查文件是否有 tar.gz 扩展名，同时文件名开头是 backup：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_UPLOAD_FILENAME</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;backup.*&#39;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;tar.gz&#39;</span><span class="p">,</span> <span class="n">lastdot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>检查文件是否没有扩展名，并且文件名与 README 匹配（区分大小写）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_UPLOAD_FILENAME</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;^README$&#39;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="is-ipv4">
<h4><code class="docutils literal notranslate"><span class="pre">IS_IPV4</span></code><a class="headerlink" href="#is-ipv4" title="Link to this heading"></a></h4>
<p>此验证器以十进制形式检查字段的值是否为版本 4 的 IP 地址。可以设置以强制地址在特定范围内。</p>
<p>IPv4 正则表达式取自 <code class="docutils literal notranslate"><span class="pre">regexlib</span></code> 。 <code class="docutils literal notranslate"><span class="pre">IS_IPV4</span></code> 构造函数的签名如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">IS_IPV4</span><span class="p">(</span><span class="n">minip</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">maxip</span><span class="o">=</span><span class="s1">&#39;255.255.255.255&#39;</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">is_localhost</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_private</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_automatic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;Enter valid IPv4 address&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>参数解释：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">minip</span></code> 是允许的最低/小地址</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">maxip</span></code> 是允许的最高/大地址</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">invert</span></code> 是一个反转允许地址范围的标志，即如果设置为 True，则只允许来自给定范围之外的地址；请注意，不会匹配范围边界。</p></li>
</ul>
<p>你传递的 IP 地址，可以是一个字符串（例如 “192.168.0.1” ），或是一个有 4 个整数构成的列表或元组（例如 [192, 168, 0, 1]）。</p>
<p>要检查多个地址范围，请向 <code class="docutils literal notranslate"><span class="pre">minip</span></code> 和 <code class="docutils literal notranslate"><span class="pre">maxip</span></code> 传递一个边界地址列表或元组，例如只允许 “192.168.20.10” 和 “192.168.20.19” 之间或 “192.168.30.100” 和 “168.30.199” 之间的地址，请使用：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IPV4</span><span class="p">(</span><span class="n">minip</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;192.168.20.10&#39;</span><span class="p">,</span> <span class="s1">&#39;192.168.30.100&#39;</span><span class="p">),</span>
                <span class="n">maxip</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;192.168.20.19&#39;</span><span class="p">,</span> <span class="s1">&#39;192.168.30.199&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>请注意，只配置了一个同时设置了下限和上限的范围，也就是说，配置的范围的数量由传递给 <code class="docutils literal notranslate"><span class="pre">minip</span></code> 和 <code class="docutils literal notranslate"><span class="pre">maxip</span></code> 的可迭代对象中的较短者决定。</p>
<p>参数 <code class="docutils literal notranslate"><span class="pre">is_localhost</span></code> 、 <code class="docutils literal notranslate"><span class="pre">is_private</span></code> 和 <code class="docutils literal notranslate"><span class="pre">is_automatic</span></code> 接受以下值：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">None</span></code> ：忽略</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code> ： 强制</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code> ： 禁止</p></li>
</ul>
<p>可选参数的含义是：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">is_localhost</span></code>: 匹配本机地址 (127.0.0.1)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">is_private</span></code>: 匹配在 172.16.0.0 - 172.31.255.255 或 192.168.0.0 - 192.168.255.255 范围内的地址</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">is_automatic</span></code>: 匹配 169.254.0.0 - 169.254.255.255 范围内的地址</p></li>
</ul>
<p>示例：</p>
<p>检查 IPv4 地址是否有效：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IPV4</span><span class="p">()</span>
</pre></div>
</div>
<p>检查私有网络 IPv4 地址是否有效：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IPV4</span><span class="p">(</span><span class="n">minip</span><span class="o">=</span><span class="s1">&#39;192.168.0.1&#39;</span><span class="p">,</span> <span class="n">maxip</span><span class="o">=</span><span class="s1">&#39;192.168.255.255&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="is-ipv6">
<h4><code class="docutils literal notranslate"><span class="pre">IS_IPV6</span></code><a class="headerlink" href="#is-ipv6" title="Link to this heading"></a></h4>
<p>此验证器检查字段的值是否为版本 6 的 IP 地址。</p>
<p><code class="docutils literal notranslate"><span class="pre">IS_IPV6</span></code> 构造函数的签名如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">IS_IPV6</span><span class="p">(</span><span class="n">is_private</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">is_link_local</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">is_reserved</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">is_multicast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">is_routeable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">is_6to4</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">is_teredo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">subnets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;Enter valid IPv6 address&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>参数 <code class="docutils literal notranslate"><span class="pre">is_private</span></code> 、 <code class="docutils literal notranslate"><span class="pre">is_link_local</span></code> 、 <code class="docutils literal notranslate"><span class="pre">is_reserved</span></code> 、 <code class="docutils literal notranslate"><span class="pre">is_multicast</span></code> 、 <code class="docutils literal notranslate"><span class="pre">is_routeable</span></code> 、 <code class="docutils literal notranslate"><span class="pre">is_6to4</span></code> 和 <code class="docutils literal notranslate"><span class="pre">is_teredo</span></code> 接受以下值：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">None</span></code> ：忽略</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code> ： 强制</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code> ：禁用该选项，对 <code class="docutils literal notranslate"><span class="pre">is_routeable</span></code> 无效</p></li>
</ul>
<p>可选参数的含义是：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">is_private</span></code>: 匹配为专用网络分配的地址</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">is_link_local</span></code>: 匹配为 link local 保留的地址（即在 fe80::/10 范围内），这也是一个专用网络（也可用上面的 <code class="docutils literal notranslate"><span class="pre">is_private</span></code> 匹配）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">is_reserved</span></code>:  匹配一个地址，否则 IETF 被保留</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">is_multicast</span></code>: 匹配为多播使用保留的地址（即在 ff00::/8 范围内）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">is_6to4</span></code>: 匹配一个似乎包含 6to4 嵌入式地址的地址（即在 2002::/16 范围内）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">is_teredo</span></code>: 匹配 teredo 地址（即在 2001::/32 范围内）</p></li>
</ul>
<p>强制 <code class="docutils literal notranslate"><span class="pre">is_routeable</span></code> （设置为 True）是全部禁止（设置为 False） <code class="docutils literal notranslate"><span class="pre">is_private</span></code> 、 <code class="docutils literal notranslate"><span class="pre">is_reserved</span></code> 和 <code class="docutils literal notranslate"><span class="pre">is_multicast</span></code> 的快捷方式。</p>
<p>使用 <code class="docutils literal notranslate"><span class="pre">subnets</span></code> 参数传递子网或子网列表以检查地址成员资格，这样地址必须是要验证的子网成员。</p>
<p>示例：</p>
<p>检查是否为有效的 IPv6 地址：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IPV6</span><span class="p">()</span>
</pre></div>
</div>
<p>检查是否为有效的专用网络 IPv6 地址：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IPV6</span><span class="p">(</span><span class="n">is_link_local</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>检查是否为子网中的有效 IPv6 地址：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IPV6</span><span class="p">(</span><span class="n">subnets</span><span class="o">=</span><span class="s1">&#39;fb00::/8&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="is-ipaddress">
<h4><code class="docutils literal notranslate"><span class="pre">IS_IPADDRESS</span></code><a class="headerlink" href="#is-ipaddress" title="Link to this heading"></a></h4>
<p>此验证器检查字段的值是否是 IP 地址（版本 4 或版本 6 ）。可以设置为强制地址在特定范围内。使用适当的 <code class="docutils literal notranslate"><span class="pre">IS_IPV4</span></code> 或 <code class="docutils literal notranslate"><span class="pre">IS_IPV6</span></code> 验证器进行检查。</p>
<p><code class="docutils literal notranslate"><span class="pre">IS_IPADDRESS</span></code> 构造函数的签名如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">IS_IPADDRESS</span><span class="p">(</span><span class="n">minip</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">maxip</span><span class="o">=</span><span class="s1">&#39;255.255.255.255&#39;</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">is_localhost</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_private</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_automatic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">is_ipv4</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">is_link_local</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_reserved</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_multicast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">is_routeable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_6to4</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_teredo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">subnets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_ipv6</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;Enter valid IP address&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>对于 <code class="docutils literal notranslate"><span class="pre">IS_IPV4</span></code> 和 <code class="docutils literal notranslate"><span class="pre">IS_IPV6</span></code> 验证器，唯一添加的参数是：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">is_ipv4</span></code>, 设置为 True 强制为版本 4 ,或设置为 False 禁止版本 4</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">is_ipv6</span></code>, 设置为 True 强制为版本 6 ,或设置为 False 禁止版本 6</p></li>
</ul>
<p>有关其他参数的含义，请参阅 IS_IPV4 和 IS_IPV6 验证器。</p>
<p>示例：</p>
<p>检查是否为有效的 IP 地址（IPv4 和 IPv6 ）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IPADDRESS</span><span class="p">()</span>
</pre></div>
</div>
<p>检查是否为有效的 IP 地址（仅限 IPv6）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IPADDRESS</span><span class="p">(</span><span class="n">is_ipv6</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="other-validators">
<h3>其它的验证器<a class="headerlink" href="#other-validators" title="Link to this heading"></a></h3>
<section id="cleanup">
<h4><code class="docutils literal notranslate"><span class="pre">CLEANUP</span></code><a class="headerlink" href="#cleanup" title="Link to this heading"></a></h4>
<p>这是一个过滤器。它从不失败。默认情况下，它只会删除十进制 ASCII 码不在列表 [10，13，32-127] 中的所有字符。它总是对值执行基本的清除（即删除开始和结尾的空白字符）。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">CLEANUP</span><span class="p">()</span>
</pre></div>
</div>
<p>您可以传递一个正则表达式来决定必须删除的内容，例如清除所有非数字字符，请使用：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">CLEANUP</span><span class="p">(</span><span class="s1">&#39;[^</span><span class="se">\\</span><span class="s1">d]&#39;</span><span class="p">)(</span><span class="s1">&#39;Hello 123 world 456&#39;</span><span class="p">)</span>
<span class="go">(&#39;123456&#39;, None)</span>
</pre></div>
</div>
</section>
</section>
<section id="database-validators">
<h3>数据库验证器<a class="headerlink" href="#database-validators" title="Link to this heading"></a></h3>
<section id="is-not-in-db">
<h4><code class="docutils literal notranslate"><span class="pre">IS_NOT_IN_DB</span></code><a class="headerlink" href="#is-not-in-db" title="Link to this heading"></a></h4>
<p>用法简介：<code class="docutils literal notranslate"><span class="pre">IS_NOT_IN_DB(db|set,</span> <span class="pre">'table.field')</span></code></p>
<p>考虑下面的示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_NOT_IN_DB</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;person.name&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>它要求当您插入一个新人的数据时，他/她的名字不在数据库 <code class="docutils literal notranslate"><span class="pre">db</span></code> 的  <code class="docutils literal notranslate"><span class="pre">person.name</span></code> 字段中。</p>
<p>可以使用一个集合替代 <code class="docutils literal notranslate"><span class="pre">db</span></code></p>
<p>与所有其他验证器一样，此要求是在表单处理级别执行的，而不是在数据库级别。这意味着有可能性很小的事情发生，如果两个访问者试图同时插入具有相同 person.name 的记录，则很可能会导致冲突，并且两条记录都被接受。因此，更安全的做法是通知数据库该字段应具有唯一值：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_NOT_IN_DB</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;person.name&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>现在，如果发生冲突的情况，数据库将引发 OperationalError ，两个插入中的一个将被拒绝。</p>
<p><code class="docutils literal notranslate"><span class="pre">IS_NOT_IN_DB</span></code> 的第一个参数可以是数据库连接或 Set。在后一种情况下，将只检查 set 定义的集合。</p>
<p><cite>IS_NOT_IN_DB()`</cite> 的完整的参数列表如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">IS_NOT_IN_DB</span><span class="p">(</span><span class="n">dbset</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">error_message</span><span class="o">=</span><span class="s1">&#39;value already in database or empty&#39;</span><span class="p">,</span>
            <span class="n">allowed_override</span><span class="o">=</span><span class="p">[],</span> <span class="n">ignore_common_filters</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>例如，以下代码不允许在 10 天内注册两个同名人员：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;registration_stamp&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">))</span>
<span class="n">recent</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">registration_stamp</span> <span class="o">&gt;</span> <span class="n">now</span><span class="o">-</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_NOT_IN_DB</span><span class="p">(</span><span class="n">recent</span><span class="p">,</span> <span class="s1">&#39;person.name&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="is-in-db">
<h4><code class="docutils literal notranslate"><span class="pre">IS_IN_DB</span></code><a class="headerlink" href="#is-in-db" title="Link to this heading"></a></h4>
<p>用法简介：<code class="docutils literal notranslate"><span class="pre">IS_IN_DB(db|set,</span> <span class="pre">'table.value_field',</span> <span class="pre">'%(representing_field)s',</span> <span class="pre">zero='choose</span> <span class="pre">one')</span></code> ，这里的第三个和第四个参数是可选的。</p>
<p>如果字段类型是 list，那么可以使用 <code class="docutils literal notranslate"><span class="pre">multiple=</span></code> ，其默认值为 False。可以设置其为 True 或 一个元组  (min, max) 来严格限制选择的数量。因此，  <code class="docutils literal notranslate"><span class="pre">multiple=(1,</span> <span class="pre">10)</span></code> 要求，必须有 1 至 10 个已选择的项目。</p>
<p>其他可选参数将在下面讨论。</p>
<p>考虑以下示例中的表格和要求：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;dog&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">))</span>
<span class="n">db</span><span class="o">.</span><span class="n">dog</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IN_DB</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;person.id&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">zero</span><span class="o">=</span><span class="n">T</span><span class="p">(</span><span class="s1">&#39;choose one&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>IS_IN_DB 的要求也可以写成使用 Set 来替代 DB</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">dog</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IN_DB</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">),</span> <span class="s1">&#39;person.id&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">zero</span><span class="o">=</span><span class="n">T</span><span class="p">(</span><span class="s1">&#39;choose one&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>它在 dog 表的 INSERT/UPDATE/DELETE 表单级别强制执行。此示例要求 <code class="docutils literal notranslate"><span class="pre">dog.owner</span></code> 是数据库 <code class="docutils literal notranslate"><span class="pre">db</span></code> 中 <code class="docutils literal notranslate"><span class="pre">person.id</span></code> 字段中的有效 id。由于这个验证器， <code class="docutils literal notranslate"><span class="pre">dog.owner</span></code> 字段在页面被呈现为下拉列表。验证器的第三个参数是一个描述下拉列表中元素的字符串，它被传递给验证器的 <code class="docutils literal notranslate"><span class="pre">label</span></code> 参数。在示例中，您希望看到人员的 <code class="docutils literal notranslate"><span class="pre">%(name)s</span></code> 而不是人员的 <code class="docutils literal notranslate"><span class="pre">%(id)s</span></code> 。 <code class="docutils literal notranslate"><span class="pre">%(...)s</span></code> 将被每条记录括号中的字段值替换。 <code class="docutils literal notranslate"><span class="pre">label</span></code> 的其他可接受值是 Field 实例（例如，您可以使用 db.person.name 而不是 “%(name)s” ），甚至是一个可调用对象，它接受一行并返回选项的描述。</p>
<p><code class="docutils literal notranslate"><span class="pre">zero</span></code> 选项的工作方式与 <code class="docutils literal notranslate"><span class="pre">IS_IN_SET</span></code> 验证器非常相似。</p>
<p><code class="docutils literal notranslate"><span class="pre">IS_IN_DB</span></code> 接受的其他可选参数有： <code class="docutils literal notranslate"><span class="pre">orderby</span></code> 、 <code class="docutils literal notranslate"><span class="pre">groupby</span></code> 、 <code class="docutils literal notranslate"><span class="pre">distinct</span></code> 、 <code class="docutils literal notranslate"><span class="pre">cache</span></code> 和 <code class="docutils literal notranslate"><span class="pre">left</span></code> ；这些将传递给数据库查询语句（请参阅DAL章节中的 <a class="reference internal" href="chapter-07.html#orderby-groupby-limitby"><span class="std std-ref">their description</span></a> ）。</p>
<p><strong>请注意</strong> ， <code class="docutils literal notranslate"><span class="pre">groupby</span></code> 、 <code class="docutils literal notranslate"><span class="pre">distinct</span></code> 和 <code class="docutils literal notranslate"><span class="pre">left</span></code> 不适用于 Google App Engine。</p>
<p>要按字母顺序对下拉列表中列出的选项进行排序，可以将 <code class="docutils literal notranslate"><span class="pre">sort</span></code> 参数设置为 <code class="docutils literal notranslate"><span class="pre">True</span></code> （排序不区分大小写），当没有可行或实用的排序方式时，这可能会很有用。</p>
<p>验证器的第一个参数可以是数据库连接或一个 DAL 数据集，如 <code class="docutils literal notranslate"><span class="pre">IS_NOT_IN_DB</span></code> 。例如，当希望限制下拉列表中的记录时，这可能很有用。在这个例子中，我们在控制器中使用``IS_IN_DB`` 来动态限制每次调用控制器时的记录：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
    <span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;xyz&#39;</span><span class="p">)</span> <span class="c1"># in practice &#39;xyz&#39; would be a variable</span>
    <span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IN_DB</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">),</span> <span class="o">...</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">process</span><span class="p">()</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span> <span class="o">...</span>
    <span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>如果您希望验证字段，但不希望出现下拉列表，则必须将验证器放入列表中。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">dog</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="p">[</span><span class="n">IS_IN_DB</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;person.id&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>有时您需要下拉列表（因此您不想使用上面的列表语法），但您想使用其他验证器。为此，<code class="docutils literal notranslate"><span class="pre">IS_IN_DB</span></code> 验证器需要一个额外的 <code class="docutils literal notranslate"><span class="pre">_and</span></code> 参数，如果值需要通过 <code class="docutils literal notranslate"><span class="pre">IS_IN_DB</span></code> 验证，该参数可以指向其他要添加的验证器的列表。例如，要验证数据库中不在某个子集中的所有狗主人：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">subset</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">dog</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IN_DB</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;person.id&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">_and</span><span class="o">=</span><span class="n">IS_NOT_IN_DB</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="s1">&#39;person.id&#39;</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="is-in-db-and-tagging">
<h4><code class="docutils literal notranslate"><span class="pre">IS_IN_DB</span></code> 和标记<a class="headerlink" href="#is-in-db-and-tagging" title="Link to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">IS_IN_DB</span></code> 验证器具有可选属性 <code class="docutils literal notranslate"><span class="pre">multiple=False</span></code>。如果设置为 <code class="docutils literal notranslate"><span class="pre">True</span></code> ，则可以在一个字段中存储多个值。此字段的类型应为 <code class="docutils literal notranslate"><span class="pre">list:reference</span></code> ，如 <a class="reference internal" href="chapter-07.html#list-type-and-contains"><span class="std std-ref">list:&lt;type&gt; 和 contains</span></a> 中所述，里面讨论了一个明确的标记示例。在创建和更新表单中会自动处理多个引用，但它们对 DAL 是透明的。我们强烈建议使用 jQuery 的 multiselect 插件来呈现多个字段。</p>
</section>
</section>
<section id="validation-functions">
<h3>验证函数<a class="headerlink" href="#validation-functions" title="Link to this heading"></a></h3>
<p>为了显式定义验证函数，我们向参数 <code class="docutils literal notranslate"><span class="pre">validation</span></code> 传递一个函数，该函数采把表单作为参数并返回一个字典，将字段的名称映射到错误信息中。如果字典非空，则错误将显示给用户，并且不会发生数据库读写操作。</p>
<p>这里是一个示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">py4web</span><span class="w"> </span><span class="kn">import</span> <span class="n">Field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">py4web.utils.form</span><span class="w"> </span><span class="kn">import</span> <span class="n">Form</span><span class="p">,</span> <span class="n">FormStyleBulma</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydal.validators</span><span class="w"> </span><span class="kn">import</span> <span class="n">IS_INT_IN_RANGE</span>

<span class="k">def</span><span class="w"> </span><span class="nf">custom_check</span><span class="p">(</span><span class="n">form</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">errors</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">4</span>
        <span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="p">(</span><span class="s2">&quot;too short&quot;</span><span class="p">)</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;form_example&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="s1">&#39;form_example.html&#39;</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">form_example</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="n">custom_check</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
        <span class="n">redirect</span><span class="p">(</span><span class="n">URL</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="chapter-11.html" class="btn btn-neutral float-left" title="国际化" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="chapter-13.html" class="btn btn-neutral float-right" title="身份验证与授权" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2020, BSDv3 License。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      
      
     <span class="fa fa-element">
     <input class="container_toggle" type="checkbox" id="switch" name="mode">
     <label for="switch"></label>
     </span>
      
      v: 20251209
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl>
        <dt>语言</dt>
        
           <strong> 
          <dd><a href="../en/index.html">en</a></dd> </strong>
          
        
          
          
          <dd><a href="../pt/index.html">pt</a></dd> 
        
          
          
          <dd><a href="../zh_CN/index.html">zh_CN</a></dd> 
        
      </dl>
      
      
      <dl>
        <dt>版本</dt>
        
          
          <dd><a href="index.html">current</a></dd>
          
        
      </dl>
      
      
      <dl>
        <dt>下载</dt>
        
          <dd><a href="py4web_en.pdf">pdf</a></dd>
        
          <dd><a href="py4web_en.epub">epub</a></dd>
        
      </dl>
      
      
      <hr/>
    </div>
  </div>

 <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
         .wy-nav-content { max-width: none; }
  </style>



</body>
</html>