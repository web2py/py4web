

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>数据库抽象层（DAL） &mdash; py4web 20251209 文档</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/css/toggle.css?v=029c1802" />

  
    <link rel="shortcut icon" href="_static/logo-32x32.ico"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=96e44453"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/translations.js?v=beaddf03"></script>
      <script src="_static/js/toggle.js?v=e1b5a5a1"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="RestAPI" href="chapter-08.html" />
    <link rel="prev" title="夹具（Fixture）" href="chapter-06.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            py4web
              <img src="_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">目录</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="chapter-01.html">py4web 是什么？</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-02.html">帮助、资源和提示</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-03.html">安装和启动</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-04.html">Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-05.html">创建一个应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-06.html">夹具（Fixture）</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">数据库抽象层（DAL）</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#dal-introduction">DAL 简介</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#supported-databases">支持的数据库</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-dal-a-quick-tour">DAL: 快速预览</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-dal-stand-alone">单独使用 DAL</a></li>
<li class="toctree-l3"><a class="reference internal" href="#experiment-with-the-py4web-shell">使用 py4web shell 进行实验</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#using-the-dashboard-app-with-databases">使用带有数据的 dashboard 应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dal-constructor">DAL 的构造函数</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#dal-signature">DAL 的签名</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connection-strings-the-uri-parameter">连接字符串（参数 uri）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connection-pooling">连接池</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connection-failures-attempts-parameter">连接失败（attempts 参数）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lazy-tables">懒惰表</a></li>
<li class="toctree-l3"><a class="reference internal" href="#model-less-applications">“无模型” 应用程序</a></li>
<li class="toctree-l3"><a class="reference internal" href="#replicated-databases">多个数据库</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reserved-keywords">保留的关键字</a></li>
<li class="toctree-l3"><a class="reference internal" href="#database-quoting-and-case-settings">数据库中的引号和大小写设置</a></li>
<li class="toctree-l3"><a class="reference internal" href="#making-a-secure-connection">建立安全连接</a></li>
<li class="toctree-l3"><a class="reference internal" href="#other-dal-constructor-parameters">DAL 构造函数的其它参数</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#database-folder-location">数据库文件夹的位置</a></li>
<li class="toctree-l4"><a class="reference internal" href="#default-migration-settings">默认迁移设置</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#commit-and-rollback"><code class="docutils literal notranslate"><span class="pre">commit</span></code> 和 <code class="docutils literal notranslate"><span class="pre">rollback</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#table-constructor">“Table” 的构造函数</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#define-table-signature">define_table 的签名</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id-notes-about-the-primary-key"><code class="docutils literal notranslate"><span class="pre">id</span></code> : 关于主键的说明</a></li>
<li class="toctree-l3"><a class="reference internal" href="#plural-and-singular"><code class="docutils literal notranslate"><span class="pre">plural</span></code> 和 <code class="docutils literal notranslate"><span class="pre">singular</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#redefine"><code class="docutils literal notranslate"><span class="pre">redefine</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#format-record-representation"><code class="docutils literal notranslate"><span class="pre">format</span></code>: 代表记录的显示格式</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rname-real-name"><code class="docutils literal notranslate"><span class="pre">rname</span></code>: 真实名称</a></li>
<li class="toctree-l3"><a class="reference internal" href="#primarykey-support-for-legacy-tables"><code class="docutils literal notranslate"><span class="pre">primarykey</span></code>: 支持已有的旧表</a></li>
<li class="toctree-l3"><a class="reference internal" href="#migrate-fake-migrate"><code class="docutils literal notranslate"><span class="pre">migrate</span></code>, <code class="docutils literal notranslate"><span class="pre">fake_migrate</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#table-class"><code class="docutils literal notranslate"><span class="pre">table_class</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#sequence-name"><code class="docutils literal notranslate"><span class="pre">sequence_name</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#trigger-name"><code class="docutils literal notranslate"><span class="pre">trigger_name</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#polymodel"><code class="docutils literal notranslate"><span class="pre">polymodel</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#on-define"><code class="docutils literal notranslate"><span class="pre">on_define</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-attributes-to-fields-and-tables">向字段和表添加属性</a></li>
<li class="toctree-l3"><a class="reference internal" href="#legacy-databases-and-keyed-tables">已有的数据库和指定主键的表</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#field-constructor">“Field” 的构造函数</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#thread-safety-and-field-attributes">线程安全和字段属性</a></li>
<li class="toctree-l3"><a class="reference internal" href="#field-types-and-validators">字段的类型和验证器</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-time-field-and-table-modification">在运行时修改字段和表</a></li>
<li class="toctree-l3"><a class="reference internal" href="#more-on-uploads">“上传” 的更多内容</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#migrations">迁移</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#fixing-broken-migrations">修复损坏的迁移</a></li>
<li class="toctree-l3"><a class="reference internal" href="#migration-control-summary">迁移控制摘要</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#table-methods">“Table” 的方法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#insert"><code class="docutils literal notranslate"><span class="pre">insert</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#query-set-rows"><code class="docutils literal notranslate"><span class="pre">Query</span></code>, <code class="docutils literal notranslate"><span class="pre">Set</span></code>, <code class="docutils literal notranslate"><span class="pre">Rows</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#update-or-insert"><code class="docutils literal notranslate"><span class="pre">update_or_insert</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#validate-and-insert-validate-and-update"><code class="docutils literal notranslate"><span class="pre">validate_and_insert</span></code>, <code class="docutils literal notranslate"><span class="pre">validate_and_update</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#drop"><code class="docutils literal notranslate"><span class="pre">drop</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#querybuilder">QueryBuilder() 查询生成器</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tagging-records">标记记录（Tagging records）</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#raw-sql">原始的 SQL 语句</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#executesql"><code class="docutils literal notranslate"><span class="pre">executesql</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#lastsql"><code class="docutils literal notranslate"><span class="pre">_lastsql</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#timing-queries">查询的耗时</a></li>
<li class="toctree-l3"><a class="reference internal" href="#indexes">索引</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generating-raw-sql">生成原始的 SQL 语句</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#select-command"><code class="docutils literal notranslate"><span class="pre">select</span></code> 命令</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-an-iterator-based-select-for-lower-memory-use">使用基于迭代器的查询以降低内存使用率</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rendering-rows-using-represent">使用 represent 渲染行</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shortcuts">快捷语法</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fetching-a-row">读取 <code class="docutils literal notranslate"><span class="pre">Row</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#recursive-selects">递归的 <code class="docutils literal notranslate"><span class="pre">select</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#orderby-groupby-limitby-distinct-having-orderby-on-limitby-join-left-cache"><code class="docutils literal notranslate"><span class="pre">orderby</span></code>, <code class="docutils literal notranslate"><span class="pre">groupby</span></code>, <code class="docutils literal notranslate"><span class="pre">limitby</span></code>, <code class="docutils literal notranslate"><span class="pre">distinct</span></code>, <code class="docutils literal notranslate"><span class="pre">having</span></code>, <code class="docutils literal notranslate"><span class="pre">orderby_on_limitby</span></code>, <code class="docutils literal notranslate"><span class="pre">join</span></code>, <code class="docutils literal notranslate"><span class="pre">left</span></code>, <code class="docutils literal notranslate"><span class="pre">cache</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#orderby">orderby</a></li>
<li class="toctree-l4"><a class="reference internal" href="#groupby-having">groupby, having</a></li>
<li class="toctree-l4"><a class="reference internal" href="#distinct">distinct</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limitby">limitby</a></li>
<li class="toctree-l4"><a class="reference internal" href="#orderby-on-limitby">orderby_on_limitby</a></li>
<li class="toctree-l4"><a class="reference internal" href="#join-left">查询中的 “连接，左连接”</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cache-cacheable">cache, cacheable</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#logical-operators">逻辑操作</a></li>
<li class="toctree-l3"><a class="reference internal" href="#count-isempty-delete-update"><code class="docutils literal notranslate"><span class="pre">count</span></code>, <code class="docutils literal notranslate"><span class="pre">isempty</span></code>, <code class="docutils literal notranslate"><span class="pre">delete</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#expressions">表达式</a></li>
<li class="toctree-l3"><a class="reference internal" href="#case"><code class="docutils literal notranslate"><span class="pre">case</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#update-record"><code class="docutils literal notranslate"><span class="pre">update_record</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#inserting-and-updating-from-a-dictionary">从字典&quot;中获取值来插入或更新记</a></li>
<li class="toctree-l3"><a class="reference internal" href="#first-and-last"><code class="docutils literal notranslate"><span class="pre">commit</span></code> 和 <code class="docutils literal notranslate"><span class="pre">rollback</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#as-dict-and-as-list"><code class="docutils literal notranslate"><span class="pre">as_dict</span></code> 和 <code class="docutils literal notranslate"><span class="pre">as_list</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#combining-rows">组合使用多个 rows</a></li>
<li class="toctree-l3"><a class="reference internal" href="#find-exclude-sort"><code class="docutils literal notranslate"><span class="pre">find</span></code>, <code class="docutils literal notranslate"><span class="pre">exclude</span></code>, <code class="docutils literal notranslate"><span class="pre">sort</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#caching-selects">缓存查询</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#computed-and-virtual-fields">计算字段和虚拟字段</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#computed-fields">计算结果字段</a></li>
<li class="toctree-l3"><a class="reference internal" href="#virtual-fields">虚拟字段</a></li>
<li class="toctree-l3"><a class="reference internal" href="#new-style-virtual-fields-experimental">新式虚拟字段（实验）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#old-style-virtual-fields">旧式虚拟字段</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#joins-and-relations">连接和关系</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#one-to-many-relation">一对多关系</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inner-join">内连接</a></li>
<li class="toctree-l3"><a class="reference internal" href="#left-outer-join">左外连接</a></li>
<li class="toctree-l3"><a class="reference internal" href="#grouping-and-counting">分组与计数</a></li>
<li class="toctree-l3"><a class="reference internal" href="#many-to-many-relation">多对多关系</a></li>
<li class="toctree-l3"><a class="reference internal" href="#self-reference-and-aliases">自引用与别名</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#other-operators">其他运算符</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#like-ilike-regexp-startswith-endswith-contains-upper-lower"><code class="docutils literal notranslate"><span class="pre">like</span></code>, <code class="docutils literal notranslate"><span class="pre">ilike</span></code>, <code class="docutils literal notranslate"><span class="pre">regexp</span></code>, <code class="docutils literal notranslate"><span class="pre">startswith</span></code>, <code class="docutils literal notranslate"><span class="pre">endswith</span></code>, <code class="docutils literal notranslate"><span class="pre">contains</span></code>, <code class="docutils literal notranslate"><span class="pre">upper</span></code>, <code class="docutils literal notranslate"><span class="pre">lower</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#year-month-day-hour-minutes-seconds"><code class="docutils literal notranslate"><span class="pre">year</span></code>, <code class="docutils literal notranslate"><span class="pre">month</span></code>, <code class="docutils literal notranslate"><span class="pre">day</span></code>, <code class="docutils literal notranslate"><span class="pre">hour</span></code>, <code class="docutils literal notranslate"><span class="pre">minutes</span></code>, <code class="docutils literal notranslate"><span class="pre">seconds</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#belongs"><code class="docutils literal notranslate"><span class="pre">belongs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#sum-avg-min-max-and-len"><code class="docutils literal notranslate"><span class="pre">sum</span></code>, <code class="docutils literal notranslate"><span class="pre">avg</span></code>, <code class="docutils literal notranslate"><span class="pre">min</span></code>, <code class="docutils literal notranslate"><span class="pre">max</span></code> and <code class="docutils literal notranslate"><span class="pre">len</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#substrings">子字符串</a></li>
<li class="toctree-l3"><a class="reference internal" href="#default-values-with-coalesce-and-coalesce-zero"><code class="docutils literal notranslate"><span class="pre">coalesce</span></code> 和 <code class="docutils literal notranslate"><span class="pre">coalesce_zero</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#exporting-and-importing-data">导出和导入数据</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#csv-one-table-at-a-time">CSV（一次一个表）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#csv-all-tables-at-once">CSV（一次所有表）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#csv-and-remote-database-synchronization">CSV 与远程数据库同步</a></li>
<li class="toctree-l3"><a class="reference internal" href="#html-and-xml-one-table-at-a-time">HTML 和 XML (一次一个表)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-representation">Data representation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#advanced-features">高级功能</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#list-type-and-contains"><code class="docutils literal notranslate"><span class="pre">list:&lt;type&gt;</span></code> 和 <code class="docutils literal notranslate"><span class="pre">contains</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#table-inheritance">“表” 的继承</a></li>
<li class="toctree-l3"><a class="reference internal" href="#filter-in-and-filter-out"><code class="docutils literal notranslate"><span class="pre">filter_in</span></code> 和 <code class="docutils literal notranslate"><span class="pre">filter_out</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#callbacks-on-record-insert-delete-and-update">在记录被 insert、 delete 和 update 时的回调</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#database-cascades">数据库的级联操作</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#record-versioning">记录版本控制</a></li>
<li class="toctree-l3"><a class="reference internal" href="#common-filters">通用的过滤器（Common filters）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-field-types">自定义的 <code class="docutils literal notranslate"><span class="pre">Field</span></code> 类型</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-dal-without-define-tables">使用不定义表的 DAL</a></li>
<li class="toctree-l3"><a class="reference internal" href="#distributed-transaction">分布式事务</a></li>
<li class="toctree-l3"><a class="reference internal" href="#copy-data-from-one-db-into-another">将数据从一个数据库复制到另一个数据库</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#gotchas">陷阱</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#note-on-new-dal-and-adapters">关于新 DAL 和适配器的说明</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sqlite">SQLite</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mysql">MySQL</a></li>
<li class="toctree-l3"><a class="reference internal" href="#google-sql">Google SQL</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mssql-microsoft-sql-server">MSSQL (Microsoft SQL Server)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#oracle">Oracle</a></li>
<li class="toctree-l3"><a class="reference internal" href="#google-nosql-datastore">Google NoSQL (Datastore)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="chapter-08.html">RestAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-09.html">YATL 模板语言</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-10.html">YATL 中的助手（helpers）</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-11.html">国际化</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-12.html">表单（Forms）</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-13.html">身份验证与授权</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-14.html">表格（Grid）</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-15.html">从 web2py 迁移到 py4web</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-16.html">高级主题和示例</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">py4web</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">数据库抽象层（DAL）</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/web2py/py4web/blob/master/docs/chapter-07.rst" class="fa fa-github"> 在 GitHub 上编辑</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="the-database-abstraction-layer-dal">
<h1>数据库抽象层（DAL）<a class="headerlink" href="#the-database-abstraction-layer-dal" title="Link to this heading"></a></h1>
<section id="dal-introduction">
<h2>DAL 简介<a class="headerlink" href="#dal-introduction" title="Link to this heading"></a></h2>
<p>py4web 依赖于数据库抽象层（<strong>DAL</strong>），这是一种将 Python 对象映射到数据库对象（如查询、表和记录）的 API。DAL 使用数据库后端特定的方言实时动态生成 SQL，这样您就不必编写 SQL 代码或学习不同的 SQL 方言（通常使用术语 SQL ），并且应用程序可以在不同类型的数据库之间移植。选用的 DAL 是一个名为 <a class="reference external" href="https://github.com/web2py/pydal">pyDAL</a> 的纯 Python 库。它是在 web2py 项目中构思的，但它是一个标准的 python 模块：你可以在任何 python 环境中使用它。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>pyDAL 与大多数其他 DAL 的不同之处在于语法：它将记录映射到 python 字典，这更简单，更接近 SQL。其他著名的框架严格依赖于 <strong>对象关系映射</strong> （ <strong>ORM</strong> ），如 Django ORM 或 SQL Alchemy ORM，它们将表映射到 Python 类，将行映射到对象。</p>
</div>
<p>pyDAL 的部分特点：</p>
<ul class="simple">
<li><p>事务</p></li>
<li><p>聚合</p></li>
<li><p>内联、外联</p></li>
<li><p>嵌套查询</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>py4web 和 web2py 之间一个重要的区别是，只有少数几个字段属性可以在 actions 中安全地修改。更多信息请参见 <a class="reference internal" href="#thread-safety-and-field-attributes"><span class="std std-ref">线程安全和字段属性</span></a> ，以及从 <a class="reference internal" href="chapter-15.html#from-web2py-to-py4web"><span class="std std-ref">从 web2py 迁移到 py4web</span></a> 的一般差异列表。</p>
</div>
<section id="supported-databases">
<h3>支持的数据库<a class="headerlink" href="#supported-databases" title="Link to this heading"></a></h3>
<p>下面的表格显示了支持的数据库的部分列表。请查看 py4web/pyDAL 网站和邮件列表，以获取更新的适配器信息。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>在任何现代的 Python 发行版中，<strong>SQLite</strong> 实际上成为 Python 的内置库。SQLite 驱动程序 (sqlite3) 也包含在内：您无需安装它。因此，它是用于测试和开发的最常用的数据库。</p>
</div>
<p>Windows 和 Mac 的二进制版本开箱即用，仅支持 SQLite 和 PostgreSQL。在后端，要使用其他数据库，请运行完整的 py4web 发行版，并安装后端所需的相应驱动程序。一旦正确的驱动程序安装完成，启动 py4web，它将自动检测到驱动程序。</p>
<p>这里是一份 py4web 能够使用的驱动列表：</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>数据库</p></th>
<th class="head"><p>驱动程序</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>SQLite</p></td>
<td><p>sqlite3 or pysqlite2 or zxJDBC (on Jython)</p></td>
</tr>
<tr class="row-odd"><td><p>PostgreSQL</p></td>
<td><p>psycopg2 or zxJDBC (on Jython)</p></td>
</tr>
<tr class="row-even"><td><p>MySQL</p></td>
<td><p>pymysql or MySQLdb</p></td>
</tr>
<tr class="row-odd"><td><p>Oracle</p></td>
<td><p>cx_Oracle</p></td>
</tr>
<tr class="row-even"><td><p>MSSQL</p></td>
<td><p>pyodbc or pypyodbc</p></td>
</tr>
<tr class="row-odd"><td><p>FireBird</p></td>
<td><p>kinterbasdb or fdb or pyodbc</p></td>
</tr>
<tr class="row-even"><td><p>DB2</p></td>
<td><p>pyodbc</p></td>
</tr>
<tr class="row-odd"><td><p>Informix</p></td>
<td><p>informixdb</p></td>
</tr>
<tr class="row-even"><td><p>Ingres</p></td>
<td><p>ingresdbi</p></td>
</tr>
<tr class="row-odd"><td><p>Cubrid</p></td>
<td><p>cubriddb</p></td>
</tr>
<tr class="row-even"><td><p>Sybase</p></td>
<td><p>Sybase</p></td>
</tr>
<tr class="row-odd"><td><p>Teradata</p></td>
<td><p>pyodbc</p></td>
</tr>
<tr class="row-even"><td><p>SAPDB</p></td>
<td><p>sapdb</p></td>
</tr>
<tr class="row-odd"><td><p>MongoDB</p></td>
<td><p>pymongo</p></td>
</tr>
<tr class="row-even"><td><p>IMAP</p></td>
<td><p>imaplib</p></td>
</tr>
</tbody>
</table>
<p>对 MongoDB 的支持是实验性的。Google NoSQL 被视为一个特例。本章末尾的 <strong>陷阱</strong> ( <a class="reference internal" href="#gotchas">Gotchas</a> )部分提供了有关特定数据库的更多信息。</p>
</section>
<section id="the-dal-a-quick-tour">
<h3>DAL: 快速预览<a class="headerlink" href="#the-dal-a-quick-tour" title="Link to this heading"></a></h3>
<p>py4web 定义了构成 DAL 的以下类：</p>
<dl>
<dt>DAL</dt><dd><p>表示数据库连接。例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt>Table</dt><dd><p>表示一个数据库 <strong>表</strong> 。你不能直接实例化表， <code class="docutils literal notranslate"><span class="pre">DAL.define_table</span></code> 会实现：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;mytable&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;myfield&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>表</strong> 的非常重要的方法是：</p>
<p><code class="docutils literal notranslate"><span class="pre">insert</span></code> 、 <code class="docutils literal notranslate"><span class="pre">truncate</span></code> 、 <code class="docutils literal notranslate"><span class="pre">drop</span></code> 、 和 <code class="docutils literal notranslate"><span class="pre">import_from_csv_file</span></code> 。</p>
</dd>
<dt>Field</dt><dd><p>表示一个数据库 <strong>字段</strong> 。它可以被实例化，也可以作为  <code class="docutils literal notranslate"><span class="pre">DAL.define_table</span></code> 的参数。</p>
</dd>
<dt>Rows</dt><dd><p>Rows 是数据库查询返回的一个对象。可以认为它是由多个 <code class="docutils literal notranslate"><span class="pre">Row</span></code> 构成的一个列表：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div>
</div>
</dd>
<dt>Row</dt><dd><p>包含字段值</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">myfield</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt>Query</dt><dd><p>Query 是一个表示 SQL “where” 子句的对象</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span> <span class="o">&gt;</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt>Set</dt><dd><p>Set 是一组记录的集合的对象。它最重要的方法是 <code class="docutils literal notranslate"><span class="pre">count</span></code> 、 <code class="docutils literal notranslate"><span class="pre">select</span></code> 、 <code class="docutils literal notranslate"><span class="pre">update</span></code> 和 <code class="docutils literal notranslate"><span class="pre">delete</span></code> 。例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myset</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">myquery</span><span class="p">)</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">myset</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">myset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
<span class="n">myset</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
</dd>
<dt>表达式</dt><dd><p><strong>表达式(expression)</strong> 是用于类似 orderby 或 groupby 使用的东西，它们使用的 Field 来自 <strong>表达式</strong> 。这里有一个例子。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myorder</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">|</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">id</span>
<span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="n">myorder</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="using-the-dal-stand-alone">
<h3>单独使用 DAL<a class="headerlink" href="#using-the-dal-stand-alone" title="Link to this heading"></a></h3>
<p>pyDAL 是一个独立的 python 包。因此，它可以在没有 web2py/py4web 环境的情况下使用；你只需要使用 pip 安装它，然后在需要的地方导入 pydal 模块：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">pydal</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>即使您可以直接从 pydal 导入模块，也不建议在 py4web 的应用程序中导入。记住 <code class="docutils literal notranslate"><span class="pre">py4web.DAL</span></code> 是一个 <strong>夹具</strong> ，而 <code class="docutils literal notranslate"><span class="pre">pydal.DAL</span></code> 不是。在本文中，上面的导入命令因该是：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">py4web</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
</pre></div>
</div>
</div>
</section>
<section id="experiment-with-the-py4web-shell">
<h3>使用 py4web shell 进行实验<a class="headerlink" href="#experiment-with-the-py4web-shell" title="Link to this heading"></a></h3>
<p>你还可以借助 py4web shell 来试验 pyDAL API， <a class="reference internal" href="chapter-03.html#shell-command-option"><span class="std std-ref">shell 命令行选项</span></a> 也可以使用。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>请注意，数据库更改可能是持久的。因此，要小心，要毫不犹豫地创建一个新的应用程序进行测试，而不是篡改现有的应用程序。唯一的例外是 showcase 数据库：如果出现问题，您可以通过删除数据库文件夹并重新启动 py4web 来重新创建它。这将使用所有示例数据重新创建数据库。</p>
</div>
<p>请注意，包含 python 提示符 <code class="docutils literal notranslate"><span class="pre">&gt;&gt;&gt;</span></code> 的大多数代码片段也可以通过 py4web shell 直接执行。</p>
<p>这里是一个简单地示例，它使用 py4web 提供的 <code class="docutils literal notranslate"><span class="pre">showcase</span></code> 应用程序</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">apps.showcase.examples.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">tables</span><span class="p">()</span>
<span class="go">[&#39;auth_user&#39;, &#39;auth_user_tag_groups&#39;, &#39;person&#39;, &#39;superhero&#39;, &#39;superpower&#39;, &#39;tag&#39;, &#39;thing&#39;, &#39;user_token&#39;, &#39;dummy&#39;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">superhero</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="go">&lt;Row {&#39;id&#39;: 1, &#39;tag&#39;: &lt;Set (&quot;tag&quot;.&quot;superhero&quot; = 1)&gt;, &#39;name&#39;: &#39;Superman&#39;, &#39;real_identity&#39;: 1}&gt;</span>
</pre></div>
</div>
<p>您还可以从零开始创建连接。为了简单起见，您可以使用 SQLite。当您切换后端数据库引擎时，数据库中的任何内容都不会改变。</p>
</section>
</section>
<section id="using-the-dashboard-app-with-databases">
<h2>使用带有数据的 dashboard 应用程序<a class="headerlink" href="#using-the-dashboard-app-with-databases" title="Link to this heading"></a></h2>
<p>通常，您可以使用 dashboard 应用程序查看和修改特定应用程序的数据库。然而，这是危险的，因此出于安全原因，默认情况下这不适用于 showcase 应用程序。但是，如果你的 py4web 在本地（不暴露在公共网络中），你可以通过在文件 <code class="docutils literal notranslate"><span class="pre">apps/showcase/__init__.py</span></code> 中简单地添加以下行来启用它：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">.examples.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
</pre></div>
</div>
<p>这允许您以图形方式查看 showcase 应用程序内部的数据库：</p>
<img alt="_images/example_db.png" src="_images/example_db.png" />
</section>
<section id="dal-constructor">
<h2>DAL 的构造函数<a class="headerlink" href="#dal-constructor" title="Link to this heading"></a></h2>
<p>基本用法：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>现在，连接了数据库，并且 <strong>连接</strong> 被存储在全局变量 <code class="docutils literal notranslate"><span class="pre">db</span></code> 中</p>
<p>您可以随时检索连接字符串。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">_uri</span>
<span class="go">sqlite://storage.sqlite</span>
</pre></div>
</div>
<p>也可以获取数据库名称</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">_dbname</span>
<span class="go">sqlite</span>
</pre></div>
</div>
<p>连接字符串称为 <code class="docutils literal notranslate"><span class="pre">_uri</span></code> ，因为它是统一资源标识符的实例。</p>
<p>DAL 允许与同一数据库或不同数据库，甚至不同类型的数据库进行多个连接。目前，我们将假设存在一个数据库，因为这是最常见的情况。</p>
<section id="dal-signature">
<h3>DAL 的签名<a class="headerlink" href="#dal-signature" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DAL</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="s1">&#39;sqlite://dummy.db&#39;</span><span class="p">,</span>
    <span class="n">pool_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">db_codec</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span>
    <span class="n">check_reserved</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">migrate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">fake_migrate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">migrate_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">fake_migrate_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">decode_credentials</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">driver_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">adapter_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">attempts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">auto_import</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">bigint_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">lazy_tables</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">db_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">do_connect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">after_connection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ignore_field_case</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">entity_quoting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">table_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="connection-strings-the-uri-parameter">
<h3>连接字符串（参数 uri）<a class="headerlink" href="#connection-strings-the-uri-parameter" title="Link to this heading"></a></h3>
<p>通过创建 DAL 对象的实例来建立与数据库的连接：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">db</span></code> 不是关键字；它是存储连接对象 <code class="docutils literal notranslate"><span class="pre">DAL</span></code> 的局部变量。你可以自由地给它起一个不同的名字。DAL 的构造函数至少需要一个参数，即连接字符串。连接字符串是唯一依赖于特定后端数据库的 py4web 代码。以下是受支持的特定类型的后端数据库的连接字符串示例（在所有情况下，我们假设数据库以 localhost 方式运行在其默认端口上，并命名为 “test” ）：</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>数据库</p></th>
<th class="head"><p>连接字符串</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>SQLite</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">sqlite://storage.sqlite</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>MySQL</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mysql://username:password&#64;localhost/test?set_encoding=utf8mb4</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>PostgreSQL</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">postgres://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>MSSQL (legacy)</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mssql://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>MSSQL (&gt;=2005)</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mssql3://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>MSSQL (&gt;=2012)</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mssql4://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>FireBird</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">firebird://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Oracle</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">oracle://username/password&#64;test</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>DB2</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">db2://username:password&#64;test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Ingres</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ingres://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>Sybase</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">sybase://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Informix</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">informix://username:password&#64;test</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>Teradata</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">teradata://DSN=dsn;UID=user;PWD=pass;DATABASE=test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Cubrid</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">cubrid://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>SAPDB</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">sapdb://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>IMAP</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">imap://user:password&#64;server:port</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>MongoDB</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mongodb://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Google/SQL</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">google:sql://project:instance/database</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>Google/NoSQL</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">google:datastore</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Google/NoSQL/NDB</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">google:datastore+ndb</span></code></p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>在 SQLite 中，数据库由单个文件组成。如果它不存在，则创建它。每次访问此文件时都会将其锁定。除了一个 sql.log 文件，对于每个表定义，还有一个名为 longhash_tablename.table 的附加文件。表定义文件在迁移过程中使用；如果出现问题，可以删除它们（它们将自动重新创建）。</p></li>
<li><p>对于 MySQL、PostgreSQL、MSSQL、FireBird、Oracle、DB2、Ingres 和 Informix  的情况，必须在 py4web 之外单独创建数据库  “test” 。 连接建立后，py4web 将恰当地创建、更改和删除表。</p></li>
<li><p>默认情况下，MySQL 只能处理由 1 到 3 个字节构成的 Unicode 字符，因此在 MySQL 连接字符串中末尾的  <code class="docutils literal notranslate"><span class="pre">?set_encoding=utf8mb4</span></code> 将编码设置为UTF-8，这将避免在由 4 个字节组成的 Unicode 字符上出现 <code class="docutils literal notranslate"><span class="pre">Invalid</span> <span class="pre">utf8</span> <span class="pre">character</span> <span class="pre">string:</span></code> 错误.</p></li>
<li><p>在 Google/NoSQL 的情况下，选项 <code class="docutils literal notranslate"><span class="pre">+ndb</span></code> 会启用 NDB。NDB 使用 Memcache 缓冲区读取经常访问的数据。这是完全自动的，在数据存储级别完成，而不是在 py4web 级别。</p></li>
<li><p>也可以将连接字符串设置为 <code class="docutils literal notranslate"><span class="pre">None</span></code> 。这种情况下，DAL 不会连接任何后端数据库，但是依然可以访问 DAL 的有关 API 进行测试。</p></li>
</ul>
<p>有时，您可能还需要生成 SQL 语句，就像您有连接但没有实际连接到数据库一样。这可以通过以下方式完成：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">,</span> <span class="n">do_connect</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>在这种情况下，你可以调用 <code class="docutils literal notranslate"><span class="pre">_select</span></code> 、 <code class="docutils literal notranslate"><span class="pre">_insert</span></code> 、 <code class="docutils literal notranslate"><span class="pre">_update</span></code> 和 <code class="docutils literal notranslate"><span class="pre">_delete</span></code> 来生成 SQL 语句，但是不能调用  <code class="docutils literal notranslate"><span class="pre">select</span></code> 、 <code class="docutils literal notranslate"><span class="pre">_insert</span></code> 、 <code class="docutils literal notranslate"><span class="pre">update</span></code> 、 和 <code class="docutils literal notranslate"><span class="pre">delete</span></code> ；有关详细信息，请参阅  <a class="reference internal" href="#generating-raw-sql">Generating raw SQL</a> 。在大多数情况下，即使没有所需的数据库驱动程序，也可以使用 <code class="docutils literal notranslate"><span class="pre">do_connect=False</span></code> 。</p>
<p>请注意，py4web 默认数据库使用 utf8 字符编码。如果你使用编码不同的已有数据库，就必须使用 <code class="docutils literal notranslate"><span class="pre">db_codec</span></code> 参数选项改变设置：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">,</span> <span class="n">db_codec</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>否则，你将收到 UnicodeDecodeError  tickets 。</p>
</section>
<section id="connection-pooling">
<h3>连接池<a class="headerlink" href="#connection-pooling" title="Link to this heading"></a></h3>
<p>DAL 构造函数的一个常用参数是  <code class="docutils literal notranslate"><span class="pre">pool_size</span></code>，其默认值是 0 。</p>
<p>由于为每个请求建立新的数据库连接相当缓慢，所以 py4web 实现了一种连接池机制。一旦建立了一个连接，页面被提供并且事务完成后，这个连接不会被关闭，而是进入池中。当下一个请求到达时，py4web 会尝试从池中回收连接，并将其用于新事务。如果池中没有可用连接，那么再建立新的连接。</p>
<p>py4web 刚启动时，连接池总是空的。池中的连接数量增长到 <code class="docutils literal notranslate"><span class="pre">pool_size</span></code> 的值和并发请求的最大数量中的最小值。这意味着，如果  <code class="docutils literal notranslate"><span class="pre">pool_size=10</span></code> ，但我们的服务器从未收到超过5个并发请求，那么池中实际的连接数量只会增长到 5。如果 <code class="docutils literal notranslate"><span class="pre">pool_size=0</span></code> ，则不使用连接池。</p>
<p>池中的连接在线程之间按顺序共享，也就是说，它们可能由两个不同但不同时的线程使用。每个 py4web 进程只有一个池。</p>
<p><code class="docutils literal notranslate"><span class="pre">pool_size</span></code> 参数会被 SQLite 和 Google App Engine 忽略。SQLite 忽略了连接池，因为连接池对 SQLite 不会产生任何好处。</p>
</section>
<section id="connection-failures-attempts-parameter">
<h3>连接失败（attempts 参数）<a class="headerlink" href="#connection-failures-attempts-parameter" title="Link to this heading"></a></h3>
<p>如果 py4web 无法连接到数据库，它会等待 1 秒后重试，默认情况下会在声明失败之前最多重试 5 次。在有连接池的情况下，数据库端可能会关闭在一段时间内保持打开但未使用 的连接。由于重试功能，py4web 会尝试重新建立这些断开的连接。尝试次数通过 <code class="docutils literal notranslate"><span class="pre">attempts</span></code> 参数设置。</p>
</section>
<section id="lazy-tables">
<h3>懒惰表<a class="headerlink" href="#lazy-tables" title="Link to this heading"></a></h3>
<p>设置 <code class="docutils literal notranslate"><span class="pre">lazy_tables</span> <span class="pre">=</span> <span class="pre">True</span></code> ，可以显著提高性能（但在 py4web 中不会）。这意味着表的创建被推迟，直到表被实际引用。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>你永远不应该在 py4web 中使用懒惰表。那既没优势也没必要，还可能存在并发问题。</p>
</div>
</section>
<section id="model-less-applications">
<h3>“无模型” 应用程序<a class="headerlink" href="#model-less-applications" title="Link to this heading"></a></h3>
<p>在 py4web 中，定义 DAL 表的代码通常位于 models.py 文件中。因为 models.py 在 <strong>actions</strong> 之外，所以只在 py4web 启动时，它才被运行一次。</p>
<p>但是，依然可以在 <strong>actions</strong> 内部按需定义 DAL 表。这被 py4web 社区称为 “无模型” 开发。</p>
<p>使用 “无模型” 方式，您需要负责完成所有内置的管理任务。需要时，调用表定义，并提供数据库连接作为参数传递。此外，请记住可维护性：其他 py4web 开发人员希望在 models.py 文件中找到数据库及表的定义。</p>
</section>
<section id="replicated-databases">
<h3>多个数据库<a class="headerlink" href="#replicated-databases" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">DAL(...)</span></code> 的第一个参数可以是 URI 列表。在这种情况下，py4web 试图连接到每个 URI。其主要目的是处理多个数据库服务器，并在它们之间分配工作负载。以下是一个典型的用例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">([</span><span class="s1">&#39;mysql://...1&#39;</span><span class="p">,</span> <span class="s1">&#39;mysql://...2&#39;</span><span class="p">,</span> <span class="s1">&#39;mysql://...3&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>在这种情况下，DAL 尝试连接到第一个，如果失败，它将尝试第二个和第三个。这也可用于在数据库主从配置中分配负载。</p>
</section>
<section id="reserved-keywords">
<h3>保留的关键字<a class="headerlink" href="#reserved-keywords" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">check_reserved</span></code> 告诉构造函数，根据后端数据库中保留的 SQL 关键字检查表名和列名，其默认值为 None。</p>
<p><code class="docutils literal notranslate"><span class="pre">check_reserved</span></code> 的值是一个包含数据库后端适配器名称的字符串列表。</p>
<p>适配器名称与 DAL 连接字符串中使用的名称相同。因此，如果你想检查 PostgreSQL 和 MSSQ L，那么你的 <code class="docutils literal notranslate"><span class="pre">db</span></code> 定义如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">,</span> <span class="n">check_reserved</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span> <span class="s1">&#39;mssql&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>DAL 将按照列表中的顺序检查关键字。</p>
<p>有两个额外的选项 “all” 和 “common”。如果指定  “all” ，它将检查所有已知的 SQL关键字。如果指定 “common”，它将只检查常见的 SQL 关键字，如 <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> 、 <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> 、 <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code> 等。</p>
<p>对于支持的后端，您还可以指定是否也要检查非保留的 SQL 关键字。在这种情况下，您应该在数据库适配器名称后附加 <code class="docutils literal notranslate"><span class="pre">_nonreserved</span></code> 。例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">check_reserved</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span> <span class="s1">&#39;postgres_nonreserved&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>以下后端数据库支持保留字检查。</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>数据库</p></th>
<th class="head"><p>check_reserved 参数</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>PostgreSQL</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">postgres(_nonreserved)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>MySQL</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mysql</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>FireBird</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">firebird(_nonreserved)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>MSSQL</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mssql</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>Oracle</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">oracle</span></code></p></td>
</tr>
</tbody>
</table>
</section>
<section id="database-quoting-and-case-settings">
<h3>数据库中的引号和大小写设置<a class="headerlink" href="#database-quoting-and-case-settings" title="Link to this heading"></a></h3>
<p>DAL 中默认启用 SQL 实体的引号，即</p>
<p><code class="docutils literal notranslate"><span class="pre">entity_quoting</span> <span class="pre">=</span> <span class="pre">True</span></code></p>
<p>这样，DAL 生成的 SQL 中会自动把标识符放在一对引号内。在 SQL 级别，关键字和未加引号的标识符不区分大小写，因此加引号的 SQL 标识符会使其区分大小写。</p>
<blockquote>
<div><p>请注意，根据 SQL 标准，后端引擎应始终将未引用的标识符处理为小写，但并非所有引擎都符合此标准（例如 PostgreSQL 默认处理为大写）</p>
</div></blockquote>
<p>默认情况下，DAL 也忽略字段大小写，要更改此用法，请如下设置：</p>
<p><code class="docutils literal notranslate"><span class="pre">ignore_field_case</span> <span class="pre">=</span> <span class="pre">False</span></code></p>
<p>为了确保在 python 和 DB 模式中使用相同的名称，您必须做好上述两个设置。以下是一个示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="n">ignore_field_case</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;table1&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;column&#39;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;COLUMN&#39;</span><span class="p">))</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">table1</span><span class="o">.</span><span class="n">COLUMN</span> <span class="o">!=</span> <span class="n">db</span><span class="o">.</span><span class="n">table1</span><span class="o">.</span><span class="n">column</span>
</pre></div>
</div>
</section>
<section id="making-a-secure-connection">
<h3>建立安全连接<a class="headerlink" href="#making-a-secure-connection" title="Link to this heading"></a></h3>
<p>有时，有必要（并建议）使用 <strong>安全连接</strong> 连接到数据库，特别是如果数据库与应用程序不在同一服务器上。在这种情况下，您需要将其他参数传递给数据库驱动程序。有关详细信息，请参阅数据库驱动程序文档。</p>
<p>对于带有 psycopg2 的 PostgreSQL ，它应该看起来像这样：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;postgres://user_name:user_password@server_addr/db_name&#39;</span><span class="p">,</span>
    <span class="n">driver_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sslmode&#39;</span><span class="p">:</span> <span class="s1">&#39;require&#39;</span><span class="p">,</span> <span class="s1">&#39;sslrootcert&#39;</span><span class="p">:</span> <span class="s1">&#39;root.crt&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;sslcert&#39;</span><span class="p">:</span> <span class="s1">&#39;postgresql.crt&#39;</span><span class="p">,</span> <span class="s1">&#39;sslkey&#39;</span><span class="p">:</span> <span class="s1">&#39;postgresql.key&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>其中参数 <code class="docutils literal notranslate"><span class="pre">sslrootcert</span></code> 、 <code class="docutils literal notranslate"><span class="pre">sslcert</span></code> 和 <code class="docutils literal notranslate"><span class="pre">sslkey</span></code> 应包含文件的完整路径。您应该参考 PostgreSQL 文档，了解如何配置 PostgreSQL 服务器以接受安全连接。</p>
</section>
<section id="other-dal-constructor-parameters">
<h3>DAL 构造函数的其它参数<a class="headerlink" href="#other-dal-constructor-parameters" title="Link to this heading"></a></h3>
<section id="database-folder-location">
<h4>数据库文件夹的位置<a class="headerlink" href="#database-folder-location" title="Link to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">folder</span></code> 设置创建迁移文件的位置（有关详细信息，请参阅 <a class="reference internal" href="#migrations">Migrations</a> ）。默认情况下，它在 py4web 中自动设置为数据库自身所在的那个文件夹，但在 py4web 外使用 DAL 时必须指定它。</p>
<p>请注意，这对于 SQLite 数据库通常是必要的，否则您将隐式选择内存中的数据库（其中文件夹和迁移没有任何意义）。因此，下面的构造函数具有相同的含义：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">)</span> <span class="c1"># folder parameter not specified</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite:memory&#39;</span><span class="p">)</span>           <span class="c1"># in memory database</span>
</pre></div>
</div>
</section>
<section id="default-migration-settings">
<h4>默认迁移设置<a class="headerlink" href="#default-migration-settings" title="Link to this heading"></a></h4>
<p>DAL 构造函数的迁移设置是布尔值，会影响默认值和全局行为（详情请参见 <a class="reference internal" href="#migrations">Migrations</a> ）</p>
<p><code class="docutils literal notranslate"><span class="pre">migrate</span> <span class="pre">=</span> <span class="pre">True</span></code> 为所有表设置为开启默认迁移行为</p>
<p><code class="docutils literal notranslate"><span class="pre">fake_migrate</span> <span class="pre">=</span> <span class="pre">False</span></code> 为所有表设置 <strong>模拟迁移</strong> 行为（False ，表示进行“真实迁移”，不仅更新 DAL 结构，也会同步更新数据库的表结构；True ，表示进行 “模拟迁移”，仅更新 DAL 结构，不对数据库进行任何修改）</p>
<p><code class="docutils literal notranslate"><span class="pre">migrate_enabled</span> <span class="pre">=</span> <span class="pre">True</span></code> 设置为 False ，将禁用所有迁移</p>
<p><code class="docutils literal notranslate"><span class="pre">fake_migrate_all</span> <span class="pre">=</span> <span class="pre">False</span></code> 设置为 True，对所有表执行 “模拟迁移”</p>
</section>
</section>
<section id="commit-and-rollback">
<h3><code class="docutils literal notranslate"><span class="pre">commit</span></code> 和 <code class="docutils literal notranslate"><span class="pre">rollback</span></code><a class="headerlink" href="#commit-and-rollback" title="Link to this heading"></a></h3>
<p>在 py4web 发出 commit 命令之前，insert、 truncate、 delete 和 update 操作实际上不会被提交。 create 和 drop 操作可能立即执行，具体取决于数据库引擎。</p>
<p>如果你在 <code class="docutils literal notranslate"><span class="pre">action.uses()</span></code> 装饰器中传递 <code class="docutils literal notranslate"><span class="pre">db</span></code> 参数，那么你不需要在控制器中调用 commit，它会自动为你完成（如果你使用 <code class="docutils literal notranslate"><span class="pre">authenticated</span></code> 或 <code class="docutils literal notranslate"><span class="pre">unauthenticated</span></code> 装饰器，也是一样的。）</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>始终在 <code class="docutils literal notranslate"><span class="pre">action.uses</span></code> 装饰器中添加 <code class="docutils literal notranslate"><span class="pre">db</span></code> 参数（或使用 <code class="docutils literal notranslate"><span class="pre">authenticated</span></code> 或 <code class="docutils literal notranslate"><span class="pre">unauthenticated</span></code> 装饰器时）。否则，您必须在每个 define_table() 中和每个表的操作（insert()、update()、delete()）中添加 <code class="docutils literal notranslate"><span class="pre">db.commit()</span></code></p>
</div>
<p>因此，在 py4web 的 actions 中，通常不需要显式调用 <code class="docutils literal notranslate"><span class="pre">commit</span></code> 或 <code class="docutils literal notranslate"><span class="pre">rollback</span></code> ，除非您需要更精细的控制。</p>
<p>但是，如果你使用 shell 执行命令，就需要手动显示地执行 commit：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<p>要检查它，让我们插入一条新记录：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Bob&quot;</span><span class="p">)</span>
<span class="go">2</span>
</pre></div>
</div>
<p>现在 <strong>回滚</strong>，即忽略自上次提交以来的所有操作：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</pre></div>
</div>
<p>如果重新插入数据，计数器将再次被设置为 2，因为前面地插入被回滚了。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Bob&quot;</span><span class="p">)</span>
<span class="go">2</span>
</pre></div>
</div>
<p>models、 views 和 controllers 中的代码被封装在 py4web 代码中，看起来像这样（伪代码）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">execute</span> <span class="n">models</span><span class="p">,</span> <span class="n">controller</span> <span class="n">function</span> <span class="ow">and</span> <span class="n">view</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">rollback</span> <span class="nb">all</span> <span class="n">connections</span>
    <span class="n">log</span> <span class="n">the</span> <span class="n">traceback</span>
    <span class="n">send</span> <span class="n">a</span> <span class="n">ticket</span> <span class="n">to</span> <span class="n">the</span> <span class="n">visitor</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">commit</span> <span class="nb">all</span> <span class="n">connections</span>
    <span class="n">save</span> <span class="n">cookies</span><span class="p">,</span> <span class="n">sessions</span> <span class="ow">and</span> <span class="k">return</span> <span class="n">the</span> <span class="n">page</span>
</pre></div>
</div>
</section>
</section>
<section id="table-constructor">
<h2>“Table” 的构造函数<a class="headerlink" href="#table-constructor" title="Link to this heading"></a></h2>
<p><strong>表</strong> （Table），由 DAL 中的 <code class="docutils literal notranslate"><span class="pre">define_table()</span></code> 来定义。</p>
<section id="define-table-signature">
<h3>define_table 的签名<a class="headerlink" href="#define-table-signature" title="Link to this heading"></a></h3>
<p>define_table() 的签名是：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">define_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="o">*</span><span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>它接受一个必须有的表名和可选数量的 <code class="docutils literal notranslate"><span class="pre">Field</span></code> 实例（也可以没有）。 除了 <code class="docutils literal notranslate"><span class="pre">Field</span></code> 对象，您还可以传递一个 <code class="docutils literal notranslate"><span class="pre">Table</span></code> （或子类）对象，这将克隆并添加所有字段（但 “id” 除外）到定义的表中。其他可选关键字参数包括： <code class="docutils literal notranslate"><span class="pre">rname</span></code> 、 <code class="docutils literal notranslate"><span class="pre">redefine</span></code> 、 <code class="docutils literal notranslate"><span class="pre">common_filter</span></code> 、 <code class="docutils literal notranslate"><span class="pre">fake_migrate</span></code> 、 <code class="docutils literal notranslate"><span class="pre">fields</span></code> 、 <code class="docutils literal notranslate"><span class="pre">format</span></code> 、 <code class="docutils literal notranslate"><span class="pre">migrate</span></code> 、 <code class="docutils literal notranslate"><span class="pre">on_define</span></code> 、 <code class="docutils literal notranslate"><span class="pre">plural</span></code> 、 <code class="docutils literal notranslate"><span class="pre">polymodel</span></code> 、 <code class="docutils literal notranslate"><span class="pre">primarykey</span></code> 、 <code class="docutils literal notranslate"><span class="pre">sequence_name</span></code> 、 <code class="docutils literal notranslate"><span class="pre">singular</span></code> 、 <code class="docutils literal notranslate"><span class="pre">table_class</span></code> 和 <code class="docutils literal notranslate"><span class="pre">trigger_name</span></code>，下文将对这些进行讨论。</p>
<p>例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
</pre></div>
</div>
<p>这同时定义、存储并返回一个被称为  “person” 的 <code class="docutils literal notranslate"><span class="pre">Table</span></code> 对象，里面包含一个 “name” 字段（列）。这个对象也能够通过 <code class="docutils literal notranslate"><span class="pre">db.person</span></code> 访问，因此不需要捕获 <code class="docutils literal notranslate"><span class="pre">define_table()</span></code> 的返回值。</p>
</section>
<section id="id-notes-about-the-primary-key">
<h3><code class="docutils literal notranslate"><span class="pre">id</span></code> : 关于主键的说明<a class="headerlink" href="#id-notes-about-the-primary-key" title="Link to this heading"></a></h3>
<p>不要声明一个名为 “id” 的字段，因为它是由 py4web 创建的。默认情况下，每个表都有一个名为 “id” 的字段。它是一个自动递增的整数字段（通常从 1 开始），这用于交叉引用和确保每条记录是唯一的，因此 “id” 是主键。（注意：从 1 开始的 id 计数器是由后端数据库决定的。例如，这不适用于 Google App Engine NoSQL。）</p>
<p>您可以选择定义一个类型为 “id” 的字段，py4web 会将此字段用作自动递增的 id 字段。不建议这样做，除非访问的旧数据库表具有名称不是 id 的主键。在某些限制下，您还可以设置 primarykey 参数来使用不同的主键。</p>
</section>
<section id="plural-and-singular">
<h3><code class="docutils literal notranslate"><span class="pre">plural</span></code> 和 <code class="docutils literal notranslate"><span class="pre">singular</span></code><a class="headerlink" href="#plural-and-singular" title="Link to this heading"></a></h3>
<p>由于 pyDAL 是一个通用的 DAL，因此它包括 <code class="docutils literal notranslate"><span class="pre">plural</span></code> 和 <code class="docutils literal notranslate"><span class="pre">singular</span></code> 属性来引用表名，以便外部元素可以使用表的正确名称。</p>
</section>
<section id="redefine">
<h3><code class="docutils literal notranslate"><span class="pre">redefine</span></code><a class="headerlink" href="#redefine" title="Link to this heading"></a></h3>
<p>表只能定义一次，但是您可以强制 py4web 重新定义一个已存在的表：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="n">redefine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>如果表定义有变化，那么 “重新定义表” 会导致 “迁移”。</p>
</section>
<section id="format-record-representation">
<h3><code class="docutils literal notranslate"><span class="pre">format</span></code>: 代表记录的显示格式<a class="headerlink" href="#format-record-representation" title="Link to this heading"></a></h3>
<p>这是可选的，但建议使用 <code class="docutils literal notranslate"><span class="pre">format</span></code> 参数指定代表记录的显示格式。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>或者</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1"> </span><span class="si">%(id)s</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>或者更复杂的情况是使用一个函数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="nb">format</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;anonymous&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">format</span></code> 属性被用于两个目的：</p>
<ul class="simple">
<li><p>在 select/option 下拉菜单中表示引用的记录。</p></li>
<li><p>为引用此表的所有字段设置 <code class="docutils literal notranslate"><span class="pre">db.othertable.otherfield.represent</span></code> 属性。这意味着 <code class="docutils literal notranslate"><span class="pre">Form</span></code> 构造函数不会按 id 显示引用的记录，而是以预设的格式表示。</p></li>
</ul>
</section>
<section id="rname-real-name">
<h3><code class="docutils literal notranslate"><span class="pre">rname</span></code>: 真实名称<a class="headerlink" href="#rname-real-name" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">rname</span></code> 为表设置数据库后端名称。这使得 py4web 中定义的表名成为别名，而 <code class="docutils literal notranslate"><span class="pre">rname</span></code> 是构建后端查询时使用的真实名称。仅举一个例子， <code class="docutils literal notranslate"><span class="pre">rname</span></code> 可用于为 MSSQL 提供完全限定表名，以访问属于服务器上其他数据库的表： <code class="docutils literal notranslate"><span class="pre">rname</span> <span class="pre">=</span> <span class="pre">'db1.dbo.table1'</span></code></p>
</section>
<section id="primarykey-support-for-legacy-tables">
<h3><code class="docutils literal notranslate"><span class="pre">primarykey</span></code>: 支持已有的旧表<a class="headerlink" href="#primarykey-support-for-legacy-tables" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">primarykey</span></code> 有助于支持具有现有主键的遗留表，甚至是多字段组成主键的表。请参见 <a class="reference internal" href="#legacy-databases-and-keyed-tables">Legacy databases and keyed tables</a> 。</p>
</section>
<section id="migrate-fake-migrate">
<h3><code class="docutils literal notranslate"><span class="pre">migrate</span></code>, <code class="docutils literal notranslate"><span class="pre">fake_migrate</span></code><a class="headerlink" href="#migrate-fake-migrate" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">migrate</span></code> 设置 “表” 的 “迁移选项” ，migrate 默认值是 True ，表示 web 应用启动时自动对比模型与数据库中的表结构，自动添加新字段（不会修改已有字段的某些属性，也不会删除已有不用的字段）。fake_migrate 设置是否进行虚拟迁移，默认值是 False ，即不实际修改数据库结构，仅更新应用中的模型数据。详情请参阅 <a class="reference internal" href="#migrations">Migrations</a></p>
</section>
<section id="table-class">
<h3><code class="docutils literal notranslate"><span class="pre">table_class</span></code><a class="headerlink" href="#table-class" title="Link to this heading"></a></h3>
<p>如果定义了一个 pydal.objects.Table 的子类，你可以设置给这个参数；这允许你扩展和重写方法，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pydal.objects</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyTable</span><span class="p">(</span><span class="n">Table</span><span class="p">):</span>
    <span class="o">...</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">table_class</span><span class="o">=</span><span class="n">MyTable</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="sequence-name">
<h3><code class="docutils literal notranslate"><span class="pre">sequence_name</span></code><a class="headerlink" href="#sequence-name" title="Link to this heading"></a></h3>
<p>自定义表序列的名称（如果数据库支持）。可以创建 SEQUENCE（从 1 开始，每次递增 1），也可以将其用于具有自定义序列的旧表。</p>
<blockquote>
<div><p>请注意，默认情况下 py4web 会在必要时自动创建序列。</p>
</div></blockquote>
</section>
<section id="trigger-name">
<h3><code class="docutils literal notranslate"><span class="pre">trigger_name</span></code><a class="headerlink" href="#trigger-name" title="Link to this heading"></a></h3>
<p>与 <code class="docutils literal notranslate"><span class="pre">sequence_name</span></code> 相关。与某些不支持自动递增数字字段的后端相关。</p>
</section>
<section id="polymodel">
<h3><code class="docutils literal notranslate"><span class="pre">polymodel</span></code><a class="headerlink" href="#polymodel" title="Link to this heading"></a></h3>
<p>用于 Google App Engine 。</p>
</section>
<section id="on-define">
<h3><code class="docutils literal notranslate"><span class="pre">on_define</span></code><a class="headerlink" href="#on-define" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">on_define</span></code> 是一个在实例化 lazy_table 时触发的回调，即使表不是 “懒惰” 的，它仍会被调用。这允许对表进行动态更改，而不会失去延迟实例化的优点。</p>
<p>例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="n">lazy_tables</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">),</span>
    <span class="n">on_define</span><span class="o">=</span><span class="k">lambda</span> <span class="n">table</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">set_attributes</span><span class="p">(</span><span class="n">requires</span><span class="o">=</span><span class="n">IS_NOT_EMPTY</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="n">table</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">set_attributes</span><span class="p">(</span><span class="n">requires</span><span class="o">=</span><span class="n">IS_INT_IN_RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="p">])</span>
</pre></div>
</div>
<p>注意，这个例子展示了如何使用 <code class="docutils literal notranslate"><span class="pre">on_define</span></code> ，但实际上是没必要的。简单的 <code class="docutils literal notranslate"><span class="pre">requires</span></code> 参数值可以添加到 Field 的定义中，而表仍会保持 “懒惰”。然而， <code class="docutils literal notranslate"><span class="pre">requires</span></code> 以 Set 对象作为第一个参数的话，如 IS_IN_DB，将发出类似 <code class="docutils literal notranslate"><span class="pre">db.sometable.somefield</span> <span class="pre">==</span> <span class="pre">some_value</span></code> 的查询，这会导致 <code class="docutils literal notranslate"><span class="pre">sometable</span></code> 提前按定义被创建。这种情况下，就要保留 <code class="docutils literal notranslate"><span class="pre">on_define</span></code> 。</p>
</section>
<section id="adding-attributes-to-fields-and-tables">
<h3>向字段和表添加属性<a class="headerlink" href="#adding-attributes-to-fields-and-tables" title="Link to this heading"></a></h3>
<p>如果需要向字段添加自定义的属性，只需简单地这样做：<code class="docutils literal notranslate"><span class="pre">db.table.field.extra</span> <span class="pre">=</span> <span class="pre">{}</span></code></p>
<p>“extra” 不是一个关键字；现在，它是一个被附加到字段对象的自定义的属性。对于表也可以这样处理，但是表的自定义属性必须以下划线开始，以避免与字段发生命名冲突。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">_extra</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
</section>
<section id="legacy-databases-and-keyed-tables">
<h3>已有的数据库和指定主键的表<a class="headerlink" href="#legacy-databases-and-keyed-tables" title="Link to this heading"></a></h3>
<p>在某些情况下，py4web 可以连接到已有的数据库</p>
<p>最简单的方法是满足以下条件：</p>
<ul class="simple">
<li><p>每个表都必须有一个名为 “id” 的唯一自动递增的整数字段。</p></li>
<li><p>必须仅使用 “id” 字段引用记录。</p></li>
</ul>
<p>访问现有表（即不是由 py4web 在当前应用程序中创建的表）时，始终设置参数 <code class="docutils literal notranslate"><span class="pre">migrate=False</span></code>。</p>
<p>如果旧表有一个自动递增的整数字段，但它没有被命名为 “id” ，py4web 仍然可以访问它，但表定义必须用 “id” 类型声明自动递增字段（即使用 <code class="docutils literal notranslate"><span class="pre">Field('...',</span> <span class="pre">'id')</span></code> ）。</p>
<p>最后，如果遗留表使用的主键不是自动递增的 id 字段，则可以使用 “指定主键的表”，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;account&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;accnum&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;acctype&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;accdesc&#39;</span><span class="p">),</span>
                <span class="n">primarykey</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accnum&#39;</span><span class="p">,</span> <span class="s1">&#39;acctype&#39;</span><span class="p">],</span>
                <span class="n">migrate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">primarykey</span></code> 是构成主键的字段名列表。</p></li>
<li><p>即使未指定，所有主键字段都被设置为 <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code> 。</p></li>
<li><p>“指定主键的表” 只能引用其它 “指定主键的表” 。</p></li>
<li><p>引用字段必须使用 <code class="docutils literal notranslate"><span class="pre">reference</span> <span class="pre">tablename.fieldname</span></code> 格式。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">update_record</span></code> 函数不适用于 “指定主键的表” 的数据行。</p></li>
</ul>
<blockquote>
<div><p>目前， “指定主键的表” 仅支持 DB2、MSSQL、Ingres 和 Informix ，但会继续添加其他引擎。</p>
</div></blockquote>
<p>在撰写本文时，我们无法保证 <code class="docutils literal notranslate"><span class="pre">primarykey</span></code> 属性适用于每个现有的遗留表和每个支持的数据库后端。为了简单起见，如果可能的话，我们建议创建一个具有自动递增 id 字段的数据库视图。</p>
</section>
</section>
<section id="field-constructor">
<h2>“Field” 的构造函数<a class="headerlink" href="#field-constructor" title="Link to this heading"></a></h2>
<p>下面是 “Field” 的构造函数的默认值</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Field</span><span class="p">(</span><span class="n">fieldname</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT</span><span class="p">,</span>
      <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">DEFAULT</span><span class="p">,</span>
      <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">,</span> <span class="n">notnull</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
      <span class="n">uploadfield</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">widget</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">writable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">searchable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">listable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
      <span class="n">update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">authorize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autodelete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">represent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">uploadfolder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uploadseparate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uploadfs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">compute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">custom_qualifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">map_none</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rname</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>其中，DEFAULT 是个特殊的值，它允许参数的值是 None。</p>
<p>并非所有的参数对每个字段都有意义。<code class="docutils literal notranslate"><span class="pre">length</span></code> 仅适用于 “string” 类型的字段。<code class="docutils literal notranslate"><span class="pre">uploadfield</span></code> 、 <code class="docutils literal notranslate"><span class="pre">authorize</span></code> 和 <code class="docutils literal notranslate"><span class="pre">autodelete</span></code> 仅适用于 “upload” 类型的字段。<code class="docutils literal notranslate"><span class="pre">ondelete</span></code> 仅适用于 “reference” 或 “upload” 类型的字段。</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">length</span></code> 设置 “string”、 “password” 或 “upload” 字段的最大长度。如果未指定 <code class="docutils literal notranslate"><span class="pre">length</span></code> ，则使用默认值，但不能保证默认值向后兼容。 <em>为了避免升级时产生未知的 “迁移”，我们建议您始终指定 “string”、 “password” 或 “upload” 字段的长度。</em></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default</span></code> 设置字段的 “默认值”。当插入数据但未明确指定字段值的时候，就使用 “默认值”。它还用于使用 <code class="docutils literal notranslate"><span class="pre">Form</span></code> 从 “Table” 构建预填充的表单。请注意，默认值不是固定值，它可以是一个函数（包括 lambda 函数），它为字段返回适当类型的值。在这种情况下，即使在单个事务中插入了多条记录，该函数也会为插入的每条记录调用一次。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">required</span></code> 告知 DAL，如果没有明确指定字段的值，那么不允许在表内插入数据。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">requires</span></code> 一个 <strong>验证器</strong>，或是多个验证器的列表。DAL 中不使用这里指定的验证器，相反，它们在 <code class="docutils literal notranslate"><span class="pre">Form</span></code> 里面被使用。（ <a class="reference internal" href="chapter-12.html#forms"><span class="std std-ref">表单（Forms）</span></a> 章节由更好的解释）在后面的 <a class="reference internal" href="#field-types-and-validators"><span class="std std-ref">字段的类型和验证器</span></a> 部分，给出了各种已知字段类型的默认验证器。详细内容请参考 <a class="reference external" href="https://web2py.com/books/default/chapter/29/07/forms-and-validators#Validators">web2py 框架中 pyDAL 模块的验证器</a></p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">requires=...</span></code> 是在 form 级别被强制执行，而 <code class="docutils literal notranslate"><span class="pre">required=True</span></code> 在 DAL（插入）级别被强制执行。此外，在数据库级别强制执行 <code class="docutils literal notranslate"><span class="pre">notnull</span></code> 、 <code class="docutils literal notranslate"><span class="pre">unique</span></code> 和 <code class="docutils literal notranslate"><span class="pre">ondelete</span></code> 。虽然它们有时看起来是多余的，但在使用 DAL 编程时保持这种区别很重要。</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">rname</span></code> 为字段提供 “真实名称”，一个数据库适配已知的字段名称；当使用字段时，发送到数据库的是 “rname” 值。字段的 py4web 名称会失效，就变成了字段的别名。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ondelete</span></code> 被转换为 “ON DELETE” SQ L语句。默认情况下，它设置为 “CASCADE”。这告诉数据库，当它删除记录时，还应该删除引用它的所有记录。若要禁用此功能，请将 <code class="docutils literal notranslate"><span class="pre">ondelete</span></code> 设置为 “NO ACTION” 或 “set NULL” 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">notnull=True</span></code> 被转换为  “NOT NULL” SQ L语句。这阻止数据库为字段插入 null 值。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique=True</span></code>  被转换为  “UNIQUE”  SQ L语句，它确保字段的值在表里是唯一的。这在数据库级别强制执行。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uploadfield</span></code> 仅适用于 “upload” 类型的字段。“upload” 类型的字段存储已保存在其它地方的文件名，默认是在文件系统中 “应用程序” 的 “uploads/” 目录下。如果 <code class="docutils literal notranslate"><span class="pre">uploadfield</span></code> 设置为 True，那么文件被存储在同一个表的二进制字段内， <code class="docutils literal notranslate"><span class="pre">uploadfield</span></code> 的值是二进制字段的名称。稍后，在 <a class="reference internal" href="#more-on-uploads">More on uploads</a> 中进行更详细地讨论。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uploadfolder</span></code> 必须被设置为一个存储已上传文件的位置。 scaffolding 应用程序定义了一个文件夹 <code class="docutils literal notranslate"><span class="pre">settings.UPLOAD_FOLDER</span></code> ，它指向 <code class="docutils literal notranslate"><span class="pre">apps/{app_name}/uploads</span></code> ，因此，你能这样设置： <code class="docutils literal notranslate"><span class="pre">Field(...</span> <span class="pre">uploadfolder=settings.UPLOAD_FOLDER)</span></code>。</p></li>
<li><p>如果设置 <code class="docutils literal notranslate"><span class="pre">uploadseparate</span></code> 为 True，那么将会把文件上传到  <em>uploadfolder</em> 指定的文件夹下的不同的子文件夹下。这是为了避免同一文件夹/子文件夹下有太多文件而优化的。注意：如果不断开现有已上传的文件链接，则无法将  <code class="docutils literal notranslate"><span class="pre">uploadseparate</span></code>  的值从 True 更改为 False。pydal 要么使用单独的子文件夹，要么不使用。在文件上传后的更改行为将阻止 pydal 检索到这些文件。如果发生这种情况，可以移动文件并修复问题，但这里没有描述。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uploadfs</span></code> 允许你为上传文件指定一个不同的文件系统，包括 Amazon S3 存储系统或者远程 SFTP 存储系统。</p></li>
</ul>
<blockquote>
<div><p>您需要安装 PyFileSystem 才能正常工作。 <code class="docutils literal notranslate"><span class="pre">uploadfs</span></code> 必须指向 PyFileSystem。</p>
</div></blockquote>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">autodelete</span></code> 确定在删除引用文件的记录时是否应删除相应的上传文件，这仅适用于 “upload” 字段。但是，因 CASCADE 操作导致由数据库本身删除记录时不会触发 py4web 的自动删除。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">label</span></code> 是一个字符串（或辅助程序，或可以序列化为字符串的东西，它包含自动生成的表单中用于此字段的标签），该字符串包含与此字段相关联的说明文字，且会显示在自动生成表单的输入框右侧。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">writable</span></code> 声明一个字段的值在表单中是否可写（编辑）。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">readable</span></code> 声明一个字段的值在表单中是否可读（是否显示）。如果一个字段既不可读也不可写，它将不会在 create 或 update 类型的表单中显示。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">update</span></code> 包含更新记录时这个字段的默认更新的值。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compute</span></code> 是一个可选函数。插入或更新记录后，compute 函数将被执行，然后以函数的返回值作为字段的值。当前记录以一个 <code class="docutils literal notranslate"><span class="pre">dict</span></code> 的形式被传给 compute 函数时，被传递的 “字典” 里不包含这个 compute 字段的当前值，也不包含其它 compute 字段。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">authorize</span></code> 可用于要求对相应字段进行访问控制，仅适用于 “upload”  字段。这将在身份验证和授权的部分进行更详细的讨论。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">widget</span></code> 注意，在 py4web 中，字段定义 <strong>不要使用 widget 参数</strong> 。（这是 web2py 的特性，而且在 py4web 里未被使用）请参阅后面的 <a class="reference internal" href="chapter-12.html#widgets"><span class="std std-ref">小部件</span></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">represent</span></code> 可以是 None，也可以指向一个函数，该函数接受字段当前值并返回字段值的替代表示形式。</p></li>
</ul>
<section id="thread-safety-and-field-attributes">
<h3>线程安全和字段属性<a class="headerlink" href="#thread-safety-and-field-attributes" title="Link to this heading"></a></h3>
<p>尽管 py4web 和 web2py 使用相同的 pyDAL，但是由 py4web 的核心架构导致了存在重要差异。在 py4web 中，只有以下 <code class="docutils literal notranslate"><span class="pre">Field</span></code> 属性可以在 action 中更改：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">readable</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">writable</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">filter_in</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">filter_out</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">label</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">update</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">requires</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">widget</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">represent</span></code></p></li>
</ul>
<p>在调用每个 action 之前，这些值都将重置为原始值。所有其他 <code class="docutils literal notranslate"><span class="pre">Field</span></code>、 <code class="docutils literal notranslate"><span class="pre">DAL</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Table</span></code> 都是全局的、非线程安全的。</p>
<p>这种限制的存在是因为 py4web 只在启动时执行表定义，而 web2py 在每次请求时都会重新定义表。这使得 py4web 比 web2py 快得多，但你需要小心，因为修改 actions 中的非线程安全属性可能会导致冲突和错误。</p>
</section>
<section id="field-types-and-validators">
<h3>字段的类型和验证器<a class="headerlink" href="#field-types-and-validators" title="Link to this heading"></a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>类型</p></th>
<th class="head"><p>默认验证器</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">string</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_LENGTH(length)</span></code> 默认长度为 512</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">text</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_LENGTH(length)</span></code> 默认长度为 32768</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">blob</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">None</span></code>  默认长度为 2**31（2 GiB）</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">boolean</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">None</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">integer</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_INT_IN_RANGE(-2**31,</span> <span class="pre">2**31)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">double</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_FLOAT_IN_RANGE(-1e100,</span> <span class="pre">1e100)</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">decimal(n,m)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_DECIMAL_IN_RANGE(-10**10,</span> <span class="pre">10**10)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">date</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_DATE()</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">time</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_TIME()</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">datetime</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_DATETIME()</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">password</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_LENGTH(length)</span></code> 默认长度为 512</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">upload</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">None</span></code> 默认长度是512</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">reference</span> <span class="pre">&lt;table&gt;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_IN_DB(db,</span> <span class="pre">table.field,</span> <span class="pre">format)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">list:string</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">None</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">list:integer</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">None</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">list:reference</span> <span class="pre">&lt;table&gt;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_IN_DB(db,</span> <span class="pre">table._id,</span> <span class="pre">format,</span> <span class="pre">multiple=True)</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">json</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_EMPTY_OR(IS_JSON())</span></code>  默认长度是512</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">bigint</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_INT_IN_RANGE(-2**63,</span> <span class="pre">2**63)</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">big-id</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">None</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">big-reference</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">None</span></code></p></td>
</tr>
</tbody>
</table>
<p>Decimal 要求值是 Decimal 对象，返回值也是，在 Python 的 <code class="docutils literal notranslate"><span class="pre">decimal</span></code> 模块中有定义。SQLite 不处理 <code class="docutils literal notranslate"><span class="pre">decimal</span></code> 类型，因此在 SQLite 内部将其视为 <code class="docutils literal notranslate"><span class="pre">double</span></code>。（n，m）分别是总数和小数点后的位数。</p>
<p><code class="docutils literal notranslate"><span class="pre">big-id</span></code> 和 <code class="docutils literal notranslate"><span class="pre">big-reference</span></code> 仅有一些数据库引擎支持，并且是实验性的。它们通常不用作字段类型，除非用于已有的旧表，但是，DAL 构造函数有一个 <code class="docutils literal notranslate"><span class="pre">bigint_id</span></code> 参数，当设置为 True 时，<code class="docutils literal notranslate"><span class="pre">id</span></code> 字段和 <code class="docutils literal notranslate"><span class="pre">reference</span></code> 字段分别为 <code class="docutils literal notranslate"><span class="pre">big-id</span></code> 和 <code class="docutils literal notranslate"><span class="pre">big-reference</span></code> 。</p>
<p><code class="docutils literal notranslate"><span class="pre">list:&lt;type&gt;</span></code> 字段是特殊的，因为它们被设计为利用 NoSQL 上的某些非规范化特性（在 Google App Engine NoSQL 的情况下，字段类型 <code class="docutils literal notranslate"><span class="pre">ListProperty</span></code> 和 <code class="docutils literal notranslate"><span class="pre">StringListProperty</span></code>），并将它们移植到所有其他支持的关系数据库中。在关系数据库中，列表存储为文本字段。这些项用 <code class="docutils literal notranslate"><span class="pre">|</span></code> 分隔，而字符串项中的每个 <code class="docutils literal notranslate"><span class="pre">|</span></code> 都转义为 <code class="docutils literal notranslate"><span class="pre">||</span></code> 。它们在 <a class="reference internal" href="#list-type-and-contains"><span class="std std-ref">list:&lt;type&gt; 和 contains</span></a> 中讨论。</p>
<p><code class="docutils literal notranslate"><span class="pre">json</span></code> 字段类型的含义相当直观。它可以存储任何可 JSON 序列化的对象。该字段类型专为 MongoDB 设计以实现特定适配，同时为确保可移植性，也反向兼容了其他数据库适配器。</p>
<p><code class="docutils literal notranslate"><span class="pre">blob</span></code> 字段同样具有特殊性。默认情况下，二进制数据在存入实际数据库字段之前会先进行 Base64 编码，提取数据时则会进行解码。这种处理方式的缺点是，会导致 Blob 字段占用比实际所需多 33% 的存储空间；但优点在于，能让数据传输摆脱后端特定转义规则的限制，实现解耦。</p>
</section>
<section id="run-time-field-and-table-modification">
<h3>在运行时修改字段和表<a class="headerlink" href="#run-time-field-and-table-modification" title="Link to this heading"></a></h3>
<p>字段和表的大部分属性都可以在它们的定义后进行修改。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">/</span><span class="si">%(id)s</span><span class="s1">&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="s1">&#39;anonymous&#39;</span>
</pre></div>
</div>
<p>请注意，表的属性通常以下划线作为前缀，以避免与可能的字段名冲突。</p>
<p>您可以由给定数据库连接列出已定义的表：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">tables</span>
<span class="go">[&#39;person&#39;]</span>
</pre></div>
</div>
<p>您可以查询表的类型：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span>
<span class="go">&lt;class &#39;pydal.objects.Table&#39;&gt;</span>
</pre></div>
</div>
<p>你可以使用不同的语法访问表：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span> <span class="ow">is</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;person&#39;</span><span class="p">]</span>
<span class="go">True</span>
</pre></div>
</div>
<p>您还可以由给定的表列出已定义的字段：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">fields</span>
<span class="go">[&#39;id&#39;, &#39;name&#39;]</span>
</pre></div>
</div>
<p>同样，您可以通过多种等效的方式依据字段名称访问字段：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="go">&lt;class &#39;pydal.objects.Field&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
<span class="go">True</span>
</pre></div>
</div>
<p>给定一个字段，您可以访问其定义中的属性集：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">type</span>
<span class="go">string</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">unique</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">notnull</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">length</span>
<span class="go">32</span>
</pre></div>
</div>
<p>包括它所属的表、表名称和所属的连接</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">_table</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">_tablename</span> <span class="o">==</span> <span class="s1">&#39;person&#39;</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">_db</span> <span class="o">==</span> <span class="n">db</span>
<span class="go">True</span>
</pre></div>
</div>
<p>字段也有方法。其中一些用于构建查询，我们稍后会看到它们。字段对象的一种特殊方法是 <code class="docutils literal notranslate"><span class="pre">validate</span></code> ，它调用字段的验证器。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="s1">&#39;John&#39;</span><span class="p">)</span>
<span class="go">(&#39;John&#39;, None)</span>
</pre></div>
</div>
<p>验证器发回一个元组  <code class="docutils literal notranslate"><span class="pre">(value,</span> <span class="pre">error)</span></code>。如果验证成功通过 <code class="docutils literal notranslate"><span class="pre">error</span></code> 的值是 None。</p>
</section>
<section id="more-on-uploads">
<h3>“上传” 的更多内容<a class="headerlink" href="#more-on-uploads" title="Link to this heading"></a></h3>
<p>考虑以下模型：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;myfile&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;upload&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;path/to/file&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>在 “upload” 字段的情况下，可选择将默认值设为一个路径（可以是绝对路径，也可以是相对于当前应用文件夹的相对路径）；对于包含未指定路径的图片的每条新记录，系统会自动为其分配该默认值。</p>
<p>请注意，这样多条记录可能会引用同一个默认图像文件，这在启用了 <code class="docutils literal notranslate"><span class="pre">autodelete</span></code> 的字段上可能会出现问题。当您不想允许图像字段重复（即多个记录引用同一文件），但仍想为 “upload” 设置默认值时，就需要一种方法为每条包含未指路径的图像的新记录复制默认文件。这可以通过使用引用默认文件的 “类文件对象” 作为字段的 <code class="docutils literal notranslate"><span class="pre">default</span></code> 参数值，甚至可以使用：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Field</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;upload&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;&lt;file_content&gt;&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;&lt;file_name&gt;&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>通常，“插入” 是通过 <code class="docutils literal notranslate"><span class="pre">Form</span></code> 自动处理的，但有时您已经在文件系统上拥有该文件，并希望以编程方式上传它。这可以通过以下方式完成：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
</pre></div>
</div>
<p>也可以以更简单的方式插入文件，并使插入方法自动调用 <code class="docutils literal notranslate"><span class="pre">store</span></code> ：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
</pre></div>
</div>
<p>在这种情况下，文件名是从流对象（如果可用）中获得的。</p>
<p>上传字段对象的 <code class="docutils literal notranslate"><span class="pre">store</span></code> 方法接受一个文件流和一个文件名。它使用文件名来确定文件的扩展名（文件类型），为文件创建一个新的临时名称（根据 py4web 上传机制），并将文件内容加载到这个新的临时文件中（若无额外说明，则自动在 uploads 文件夹下保存临时文件）。它返回新的临时名称，然后将其存储在 <code class="docutils literal notranslate"><span class="pre">db.myfile</span></code> 表的 <code class="docutils literal notranslate"><span class="pre">image</span></code> 字段中。</p>
<p>请注意，如果文件要存储在关联的二进制字段而不是文件系统中，则 <code class="docutils literal notranslate"><span class="pre">store</span></code> 方法不会将文件插入二进制字段中（因为 <code class="docutils literal notranslate"><span class="pre">store</span></code> 在插入之前被调用），因此必须将文件显式插入二进制字段：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;myfile&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;upload&#39;</span><span class="p">,</span> <span class="n">uploadfield</span><span class="o">=</span><span class="s1">&#39;image_file&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;image_file&#39;</span><span class="p">,</span> <span class="s1">&#39;blob&#39;</span><span class="p">))</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                     <span class="n">image_file</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">retrieve</span></code> 方法与 <code class="docutils literal notranslate"><span class="pre">store</span></code> 的作用相反。</p>
<p>当上传的文件存储在文件系统中时（如普通的 <code class="docutils literal notranslate"><span class="pre">Field('image',</span> <span class="pre">'upload')</span></code> 情况），代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">fullname</span><span class="p">)</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">nameonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>检索用户在上传时看到的原始文件名（文件名）和存储文件的名称（全名，带有相对于应用程序文件夹的路径）。而一般地调用：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</pre></div>
</div>
<p>将检索原始文件名（文件名）和类文件对象，以准备访问上传文件数据（流）。</p>
<blockquote>
<div><p>请注意，在上传的文件存储在文件系统上的情况下， <code class="docutils literal notranslate"><span class="pre">retrieve</span></code> 返回的流是一个真实的文件对象。在这种情况下，记得在完成后调用  <code class="docutils literal notranslate"><span class="pre">stream.close()</span></code> 关闭文件。</p>
</div></blockquote>
<p>这里的例子是 <code class="docutils literal notranslate"><span class="pre">retrieve</span></code> 的安全用法：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">closing</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">,</span> <span class="n">closing</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="migrations">
<h2>迁移<a class="headerlink" href="#migrations" title="Link to this heading"></a></h2>
<p>使用我们示例的表定义：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">define_table</span></code> 检查相应的表是否存在。如果没有，它将生成创建表的 SQL 语句并执行。如果表确实存在，但与正在定义的表不同，它将生成变更表的 SQL 语句并执行。如果字段的类型发生了变化，但名称没有变化，它将尝试转换数据（如果你不想这样做，你需要重新定义表两次，第一次是让 py4web 删除字段，第二次是添加新定义的字段，以便 py4web 可以创建新类型的同名字段）。如果该表存在并且与当前定义匹配，它将保持原样。在所有情况下，它都会创建表示表的 <code class="docutils literal notranslate"><span class="pre">db.person</span></code> 对象。</p>
<p>我们说的 “迁移” 指的就是这种行为。py4web 在文件 “sql.log” 中记录所有迁移和迁移尝试。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>默认情况下， py4web 的日志文件和用到的所有其它迁移文件都保存在 “app/databases” 目录下。你可以通过设置 DAL 构造函数的 <code class="docutils literal notranslate"><span class="pre">folder</span></code> 参数来改变默认的保存位置。要设置一个不同的日志文件名，例如 “migrate.log” ，你可以设置为 <code class="docutils literal notranslate"><span class="pre">db</span> <span class="pre">=</span> <span class="pre">DAL(...,</span> <span class="pre">adapter_args=dict(logfile='migrate.log'))</span></code> 。</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">define_table</span></code> 的第一个参数始终是表名。其他未命名的参数是字段。该函数还接受一个名为 “migrate” 的可选关键字参数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">migrate</span><span class="o">=</span><span class="s1">&#39;person.table&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>migrate 的值是 py4web 存储此表内部迁移信息的文件名。这些文件非常重要，当相应的表存在时，不应将其删除。如果表已被删除，但相应的文件仍然存在，则可以手动将其删除。默认情况下，migrate 设置为 True。这会导致 py4web 根据连接字符串的哈希生成文件名。如果 migrate 设置为 False，则不执行迁移，py4web 则会假设该表存在于数据存储中，并且它至少包含 <code class="docutils literal notranslate"><span class="pre">define_table</span></code> 中列出的字段。</p>
<p>同一应用程序中不可能有两个表对应同一个迁移文件名。</p>
<p>DAL类也接受一个 “migrate” 参数，该参数决定了调用  <code class="docutils literal notranslate"><span class="pre">define_table</span></code> 时 migrate 的默认值。例如，</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">,</span> <span class="n">migrate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>每当在没有 migrate 参数的情况下调用 <code class="docutils literal notranslate"><span class="pre">db.define_table</span></code> 时，migrate 的默认值将被设置为 False 。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>迁移时，py4web 会添加新列、删除列或改变列的类型（SQLite 除外）。 py4web 不会在迁移时改变其它属性，例如不改变 <code class="docutils literal notranslate"><span class="pre">default</span></code> 、 <code class="docutils literal notranslate"><span class="pre">unique</span></code> 、 <code class="docutils literal notranslate"><span class="pre">notnull</span></code> 或 <code class="docutils literal notranslate"><span class="pre">ondelete</span></code> 的值。</p>
</div>
<p>可以一次禁用所有表的迁移</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">migrate_enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>当两个应用程序共用一个数据库时，建议这样做。两个应用程序中应该只有一个启用执行迁移，另一个应该禁用。</p>
<section id="fixing-broken-migrations">
<h3>修复损坏的迁移<a class="headerlink" href="#fixing-broken-migrations" title="Link to this heading"></a></h3>
<p>迁移会遇到两种常见的问题，下面是一些从中恢复的方法。</p>
<p>SQLite 存在一个特定的问题。SQLite 不强制执行列类型，也不能删除列。这意味着，如果你有一个 string 类型的列并将其删除，那么它并没有真正被删除。如果你用不同的类型（例如 datetime ）再次添加同名的列，你最终会得到一个类型是 string 的列（这不是实际想要的结果）。py4web 不会抱怨这一点，因为它不知道数据库中有什么，直到尝试检索记录时导致失败。</p>
<p>如果在某些解析函数中检索记录时，py4web 返回错误，很可能是由于上述问题导致列中的数据损坏。</p>
<p>这种情况的解决方案包括更新表的所有记录，并将相关列中的值更新为 None。</p>
<p>另一个问题更为普遍，但在 MySQL 中更为常见。MySQL 不允许一个事务中有多个 ALTER TABLE 。这意味着 py4web 必须将复杂的事务分解为更小的事务（一次一个 ALTER TABLE ），并一次提交一个事务。因此，复杂事务的一部分可能被提交，而另一部分失败，导致 py4web 处于错误状态。为什么部分交易会失败？例如，因为它涉及更改表并将 string 列转换为 datetime 列，py4web 会尝试转换数据，但字符串无法转换成日期。py4web 怎么办？它对数据库中实际存储的表结构感到困惑。</p>
<p>这种情况的解决方案包括启用虚假迁移：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="o">....</span><span class="p">,</span> <span class="n">migrate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fake_migrate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>这将依据表定义重建 py4web 中相关表的元数据。尝试多个表定义，看看哪一个有效（一个是在迁移失败之前，另一个是迁移失败之后）。一旦成功，就移除 <code class="docutils literal notranslate"><span class="pre">fake_migrate=True</span></code> 参数。</p>
<p>在尝试修复迁移问题之前，谨慎的做法是复制 “yourapp/databases/*.table” 文件。</p>
<p>也可以一次修复迁移中的所有问题表：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">fake_migrate_all</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>如果模型描述了数据库中不存在的表，这也会失败，但它可以帮助缩小问题的范围。</p>
</section>
<section id="migration-control-summary">
<h3>迁移控制摘要<a class="headerlink" href="#migration-control-summary" title="Link to this heading"></a></h3>
<p>此处的伪代码总结了各种迁移参数的逻辑：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">DAL</span><span class="o">.</span><span class="n">migrate_enabled</span> <span class="ow">and</span> <span class="n">table</span><span class="o">.</span><span class="n">migrate</span><span class="p">:</span>
   <span class="k">if</span> <span class="n">DAL</span><span class="o">.</span><span class="n">fake_migrate_all</span> <span class="ow">or</span> <span class="n">table</span><span class="o">.</span><span class="n">fake_migrate</span><span class="p">:</span>
       <span class="n">perform</span> <span class="n">fake</span> <span class="n">migration</span>
   <span class="k">else</span><span class="p">:</span>
       <span class="n">perform</span> <span class="n">migration</span>
</pre></div>
</div>
</section>
</section>
<section id="table-methods">
<h2>“Table” 的方法<a class="headerlink" href="#table-methods" title="Link to this heading"></a></h2>
<section id="insert">
<h3><code class="docutils literal notranslate"><span class="pre">insert</span></code><a class="headerlink" href="#insert" title="Link to this heading"></a></h3>
<p>给定一个表，你可以插入记录</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Alex&quot;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Bob&quot;</span><span class="p">)</span>
<span class="go">2</span>
</pre></div>
</div>
<p>Insert() 返回唯一表示每条被插入记录的 “id” 。</p>
<p>您可以对表调用 truncate() ，即删除所有记录并重置 id 的计数器。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
</pre></div>
</div>
<p>现在，如果你再插入一条记录，计数器又会重新从 1 开始（这是与后端数据库相关的，不适用于  Google NoSQL）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Alex&quot;</span><span class="p">)</span>
<span class="go">1</span>
</pre></div>
</div>
<p>注意，你可以给 <code class="docutils literal notranslate"><span class="pre">truncate</span></code> 一个参数，例如，你可以告诉 SQLite 让 id 计数器重新开始。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="s1">&#39;RESTART IDENTITY CASCADE&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>参数是原始的 SQL 语句，因此这只对特定引擎有效。</p>
<p>py4web 也提供一个  bulk_insert() 方法</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">([{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Alex&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;John&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Tim&#39;</span><span class="p">}])</span>
<span class="go">[3, 4, 5]</span>
</pre></div>
</div>
<p>它以要插入的字段值的字典组成的列表为参数，并一次执行插入多个记录。它返回插入记录的 “id” 值的列表。在支持的关系数据库上，与循环和执行单个插入操作相比，使用此函数没有优势，但在 Google App Engine NoSQL 上，有一个主要的速度优势。</p>
</section>
<section id="query-set-rows">
<h3><code class="docutils literal notranslate"><span class="pre">Query</span></code>, <code class="docutils literal notranslate"><span class="pre">Set</span></code>, <code class="docutils literal notranslate"><span class="pre">Rows</span></code><a class="headerlink" href="#query-set-rows" title="Link to this heading"></a></h3>
<p>让我们再次考虑借用之前定义（并删除）的表，并插入三条记录：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Alex&quot;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Bob&quot;</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Carl&quot;</span><span class="p">)</span>
<span class="go">3</span>
</pre></div>
</div>
<p>你可以把 “表” 存储到一个变量。例如，使用变量 “person” ，你可以这样：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">person</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span>
</pre></div>
</div>
<p>你也可以把 “字段” 存储到一个变量。例如，使用变量 “name” ，你可以这样：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">name</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>你甚至可以构建一个查询（使用 <code class="docutils literal notranslate"><span class="pre">==</span></code> 、<code class="docutils literal notranslate"><span class="pre">!=</span></code> 、<code class="docutils literal notranslate"><span class="pre">&lt;</span></code> 、 <code class="docutils literal notranslate"><span class="pre">&gt;</span></code> 、 <code class="docutils literal notranslate"><span class="pre">&lt;=</span></code> 、 <code class="docutils literal notranslate"><span class="pre">&gt;=</span></code> 、 <code class="docutils literal notranslate"><span class="pre">.like()</span></code> 、 <code class="docutils literal notranslate"><span class="pre">.belongs()</span></code> 等运算符），然后把这个查询放在一个名为 “q” 的变量里，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">q</span> <span class="o">=</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span>
</pre></div>
</div>
<p>当你使用查询调用 <code class="docutils literal notranslate"><span class="pre">db</span></code> 时，就定义了一个由多个记录组成的集合。你能把它存储在名为 “s” 的变量中，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
<p>请注意，到目前为止还没有执行任何数据库查询。DAL + Query 只是在此数据库中定义一组与查询相匹配的记录。py4web 从查询中确定涉及哪些表，事实上，不需要显示指定表。</p>
</section>
<section id="update-or-insert">
<h3><code class="docutils literal notranslate"><span class="pre">update_or_insert</span></code><a class="headerlink" href="#update-or-insert" title="Link to this heading"></a></h3>
<p>有时，只有当没有与要插入的值相同的记录时，才需要执行插入操作。这可以通过以下方式完成</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;birthplace&#39;</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">update_or_insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="n">birthplace</span><span class="o">=</span><span class="s1">&#39;Chicago&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>只有当数据库中没有出生在 Chicago 且名为 John 的用户时，才会插入该记录。</p>
<p>您可以指定使用哪些值作为键来确定记录是否存在。例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">update_or_insert</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">,</span>
                           <span class="n">birthplace</span><span class="o">=</span><span class="s1">&#39;Chicago&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>如果有姓名为 John 的记录，那么他的出生地将被更新，否则将创建新的记录。</p>
<p>上例中的匹配记录的条件标准是单一的一个字段。它也可以是一个查询，例如</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">update_or_insert</span><span class="p">((</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;John&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">birthplace</span> <span class="o">==</span> <span class="s1">&#39;Chicago&#39;</span><span class="p">),</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">,</span>
                           <span class="n">birthplace</span><span class="o">=</span><span class="s1">&#39;Chicago&#39;</span><span class="p">,</span>
                           <span class="n">pet</span><span class="o">=</span><span class="s1">&#39;Rover&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="validate-and-insert-validate-and-update">
<h3><code class="docutils literal notranslate"><span class="pre">validate_and_insert</span></code>, <code class="docutils literal notranslate"><span class="pre">validate_and_update</span></code><a class="headerlink" href="#validate-and-insert-validate-and-update" title="Link to this heading"></a></h3>
<p>除了在执行插入之前调用字段的验证器，函数</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">validate_and_insert</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>的作用非常像</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>如果验证不通过，则退出。如果验证不合格，则可以在 <code class="docutils literal notranslate"><span class="pre">ret[&quot;errors&quot;]</span></code> 中找到错误。 <code class="docutils literal notranslate"><span class="pre">ret[&quot;errors&quot;]</span></code> 保存了一个键值映射，其中每个键都是验证失败的字段名，键的值是验证错误的结果（很像 <code class="docutils literal notranslate"><span class="pre">form[&quot;errors&quot;]</span></code> ）。如果通过，则新记录的 id 为 <code class="docutils literal notranslate"><span class="pre">ret[&quot;id&quot;]</span></code> 。请注意，通常验证是由表单处理逻辑完成的，因此很少需要单独调用此函数。</p>
<p>类似地，除了在执行更新之前调用字段的验证器。函数</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">validate_and_update</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>的作用非常像</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">num</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>请注意，这仅在查询涉及单个表时有效。更新记录的数量可以在 <code class="docutils literal notranslate"><span class="pre">ret[&quot;updated&quot;]</span></code> 中找到，而错误在 <code class="docutils literal notranslate"><span class="pre">ret[&quot;errors&quot;]</span></code> 中。</p>
</section>
<section id="drop">
<h3><code class="docutils literal notranslate"><span class="pre">drop</span></code><a class="headerlink" href="#drop" title="Link to this heading"></a></h3>
<p>最后，你可以删除表，表中的所有数据也都将丢失：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="querybuilder">
<h3>QueryBuilder() 查询生成器<a class="headerlink" href="#querybuilder" title="Link to this heading"></a></h3>
<p>你能使用自然语言生成 DAL 查询。这可以像下面这样做：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">py4web</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydal</span><span class="w"> </span><span class="kn">import</span> <span class="n">QueryBuilder</span><span class="p">,</span> <span class="n">QueryParseError</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s2">&quot;sqlite:memory&quot;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s2">&quot;thing&quot;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span> <span class="s2">&quot;boolean&quot;</span><span class="p">))</span>
<span class="n">builder</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;name is equal to Chair&#39;</span><span class="p">)</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div>
</div>
<p>合法的表达式示例如下：</p>
<ul class="simple">
<li><p>name is null</p></li>
<li><p>name is not null</p></li>
<li><p>name == Chair</p></li>
<li><p>name is Chair</p></li>
<li><p>name is equal Chair</p></li>
<li><p>name is equal to Chair</p></li>
<li><p>name is equal to &quot;Chair&quot;</p></li>
<li><p>name lower is equal to Chair</p></li>
<li><p>not name lower is equal to Chair</p></li>
<li><p>not (name lower is equal to Chair)</p></li>
<li><p>name == Chair or name == Table</p></li>
<li><p>name starts with C and name contains air</p></li>
<li><p>name in Chair, Table, Glass</p></li>
<li><p>name belongs Chair, Table, &quot;Glass Top&quot;</p></li>
<li><p>solid is true</p></li>
<li><p>solid is false</p></li>
</ul>
<p>请注意，引号是可选的，仅适用于值。您可以使用括号进行分组。失败时，它会抛出QueryParseError 异常。您可以将可选参数传递给 QueryBuilder 以实现国际化（例如意大利语）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">builder</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">,</span>
            <span class="n">field_aliases</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;nome&quot;</span><span class="p">:</span> <span class="s2">&quot;name&quot;</span><span class="p">},</span>
            <span class="n">token_aliases</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;non è nullo&quot;</span><span class="p">:</span> <span class="s2">&quot;is not null&quot;</span><span class="p">,</span> <span class="s2">&quot;è uguale a&quot;</span><span class="p">:</span> <span class="s2">&quot;==&quot;</span><span class="p">})</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;nome non è nullo&#39;</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;nome è uguale a Tavolo&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>如果未提供 field_aliases 参数，只有 readable 字段能被查询到。如果提供了 field_aliases 参数，则只有明确指定的字段能被查询到。</p>
<p>当然，您可以使用翻译运算符 T() ：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">builder</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">,</span>
            <span class="n">field_aliases</span><span class="o">=</span><span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)):</span> <span class="n">field</span> <span class="n">name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">},</span>
            <span class="n">token_aliases</span><span class="o">=</span><span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="n">key</span><span class="p">):</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">QueryBuilder</span><span class="o">.</span><span class="n">token_ops</span><span class="p">})</span>
</pre></div>
</div>
<p>您可以对以下令牌设置别名：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="c1"># boolean tokens</span>
   <span class="s2">&quot;not&quot;</span><span class="p">,</span>
   <span class="s2">&quot;and&quot;</span><span class="p">,</span>
   <span class="s2">&quot;or&quot;</span><span class="p">,</span>
   <span class="c1"># field transformers</span>
   <span class="s2">&quot;upper&quot;</span><span class="p">,</span>
   <span class="s2">&quot;lower&quot;</span><span class="p">,</span>
   <span class="c1"># unary search expressions</span>
   <span class="s2">&quot;is null&quot;</span><span class="p">,</span>
   <span class="s2">&quot;is not null&quot;</span><span class="p">,</span>
   <span class="s2">&quot;is true&quot;</span><span class="p">,</span>
   <span class="s2">&quot;is false&quot;</span><span class="p">,</span>
   <span class="c1"># binary search expressions</span>
   <span class="s2">&quot;==&quot;</span><span class="p">,</span>
   <span class="s2">&quot;!=&quot;</span><span class="p">,</span>
   <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span>
   <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span>
   <span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span>
   <span class="s2">&quot;&gt;=&quot;</span><span class="p">,</span>
   <span class="s2">&quot;contains&quot;</span><span class="p">,</span>
   <span class="s2">&quot;startswith&quot;</span><span class="p">,</span> <span class="c1"># notice &quot;starts with&quot; is an alias!</span>
   <span class="c1"># search in list</span>
   <span class="s2">&quot;belongs&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>查询生成器在 Grid 中使用。在 Grid 中，字段别名是小写的 field.label ，空格被下划线替换。</p>
</section>
<section id="tagging-records">
<h3>标记记录（Tagging records）<a class="headerlink" href="#tagging-records" title="Link to this heading"></a></h3>
<p>标记（Tags）功能可用于为数据库中的记录添加属性，或根据已附加的属性查找记录。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">py4web</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydal.tools.tags</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tags</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s2">&quot;sqlite:memory&quot;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s2">&quot;thing&quot;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
<span class="n">id1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;chair&quot;</span><span class="p">)</span>
<span class="n">id2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;table&quot;</span><span class="p">)</span>
<span class="n">properties</span> <span class="o">=</span> <span class="n">Tags</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span>
<span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="s2">&quot;color/red&quot;</span><span class="p">)</span>
<span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="s2">&quot;style/modern&quot;</span><span class="p">)</span>
<span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="s2">&quot;color/green&quot;</span><span class="p">)</span>
<span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="s2">&quot;material/wood&quot;</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id1</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;color/red&quot;</span><span class="p">,</span> <span class="s2">&quot;style/modern&quot;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id2</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;color/green&quot;</span><span class="p">,</span> <span class="s2">&quot;material/wood&quot;</span><span class="p">]</span>

<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">find</span><span class="p">([</span><span class="s2">&quot;style/modern&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">rows</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">id1</span>

<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">find</span><span class="p">([</span><span class="s2">&quot;material/wood&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">rows</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">id2</span>

<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">find</span><span class="p">([</span><span class="s2">&quot;color&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Tags</span></code> 具有层级结构。例如，执行 <code class="docutils literal notranslate"><span class="pre">find([“color”])</span></code>  时，将返回 id1 和 id2 这两条记录，因为它们的 “标记” 中均包含 “color” 。</p>
<p>该功能在内部通过创建一个额外的表格实现，在本示例中，这个额外表格会是 db.thing_tags_default。出现 “default” 的原因是，在 <code class="docutils literal notranslate"><span class="pre">Tags(table,</span> <span class="pre">tail=“default”)</span></code>  这个构造函数中，上面的例子并未指定自定义的 “tail”（后缀）参数。</p>
<p>py4web 使用 <code class="docutils literal notranslate"><span class="pre">Tags</span></code> 作为一种灵活的机制来管理权限，我们稍后将在  <a class="reference internal" href="chapter-13.html#authorization-using-tags"><span class="std std-ref">使用 Tags 进行授权</span></a> 中看到所有详细信息。</p>
</section>
</section>
<section id="raw-sql">
<h2>原始的 SQL 语句<a class="headerlink" href="#raw-sql" title="Link to this heading"></a></h2>
<section id="executesql">
<h3><code class="docutils literal notranslate"><span class="pre">executesql</span></code><a class="headerlink" href="#executesql" title="Link to this heading"></a></h3>
<p>DAL 允许您使用真正的 SQL 语句。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">executesql</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM person;&#39;</span><span class="p">)</span>
<span class="go">[(1, u&#39;Massimo&#39;), (2, u&#39;Massimo&#39;)]</span>
</pre></div>
</div>
<p>这种情况下，DAL 不会再解析或者转换返回值，而且其格式依赖于特定的数据库驱动。通常不需要在 select 中使用这种用法，但在索引中更常见。</p>
<p><code class="docutils literal notranslate"><span class="pre">executesql</span></code> 有五个可选的参数: <code class="docutils literal notranslate"><span class="pre">placeholders</span></code> 、 <code class="docutils literal notranslate"><span class="pre">as_dict</span></code> 、 <code class="docutils literal notranslate"><span class="pre">fields</span></code> 、 <code class="docutils literal notranslate"><span class="pre">colnames</span></code> 、 和 <code class="docutils literal notranslate"><span class="pre">as_ordered_dict</span></code> 。</p>
<p><code class="docutils literal notranslate"><span class="pre">placeholders</span></code> 是一个可选的值的序列，用于替换 SQL 中的占位符；或者，如果数据库驱动程序支持，也可以是一个字典，其键与 SQL 中的命名占位符相匹配。</p>
<p>如果将 <code class="docutils literal notranslate"><span class="pre">as_dict</span></code> 设置为 True，数据库驱动程序返回的结果游标将被转换为一系列字典，这些字典以数据库字段名为键。 <code class="docutils literal notranslate"><span class="pre">as_dict</span> <span class="pre">=</span> <span class="pre">True</span></code> 时返回的结果与对普通 select 结果应用 as_list () 方法得到的结果相同：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="s1">&#39;field1&#39;</span><span class="p">:</span> <span class="n">val1_row1</span><span class="p">,</span> <span class="s1">&#39;field2&#39;</span><span class="p">:</span> <span class="n">val2_row1</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;field1&#39;</span><span class="p">:</span> <span class="n">val1_row2</span><span class="p">,</span> <span class="s1">&#39;field2&#39;</span><span class="p">:</span> <span class="n">val2_row2</span><span class="p">}]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">as_ordered_dict</span></code> 与 <code class="docutils literal notranslate"><span class="pre">as_dict</span></code> 非常相似，但前者确保结果字段的顺序（OrderedDict 的键的顺序）与数据库驱动程序返回它们的顺序一致：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;field1&#39;</span><span class="p">,</span> <span class="n">val1_row1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;field2&#39;</span><span class="p">,</span> <span class="n">val2_row1</span><span class="p">)]),</span>
 <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;field1&#39;</span><span class="p">,</span> <span class="n">val1_row2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;field2&#39;</span><span class="p">,</span> <span class="n">val2_row2</span><span class="p">)])]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">fields</span></code> 参数是一个 DAL 字段（Field）对象的列表，这些对象与数据库返回的字段相匹配。这些字段对象应当是 DAL 对象上定义的一个或多个表（Table）对象的组成部分。 <code class="docutils literal notranslate"><span class="pre">fields</span></code> 列表除了可以包含字段对象，还可以包含一个或多个 DAL 表对象来补充或替代字段对象，也可以仅仅是一个单独的表（无需放在列表中）。在这种情况下，字段对象会从这些表中提取出来。</p>
<p>除了指定 <code class="docutils literal notranslate"><span class="pre">fields</span></code> 参数，还可以将 <code class="docutils literal notranslate"><span class="pre">colnames</span></code> 参数指定为一个字段名列表，字段名需采用 “tablename.fieldname” 的格式。同样，这些字段名所代表的表和字段应当是在 DAL 对象上定义过的。</p>
<p>也可以同时指定 <code class="docutils literal notranslate"><span class="pre">fields</span></code> 及其关联的 <code class="docutils literal notranslate"><span class="pre">colnames</span></code>。在这种情况下， <code class="docutils literal notranslate"><span class="pre">fields</span></code> 除了可以包含字段对象，还可以包含 DAL 表达式（Expression）对象。对于  <code class="docutils literal notranslate"><span class="pre">fields</span></code> 中的字段对象，其关联的 <code class="docutils literal notranslate"><span class="pre">colnames</span></code> 仍必须采用 “tablename.fieldname” 的格式；对于 <code class="docutils literal notranslate"><span class="pre">fields</span></code> 中的表达式对象，其关联的 <code class="docutils literal notranslate"><span class="pre">colnames</span></code> 可以是任意的标签。</p>
<p>需要注意的是，<code class="docutils literal notranslate"><span class="pre">fields</span></code> 或 <code class="docutils literal notranslate"><span class="pre">colnames</span></code> 所引用的 DAL 表对象可以是虚拟表（dummy tables），不必代表数据库中任何实际存在的表。另外，<code class="docutils literal notranslate"><span class="pre">fields</span></code> 或 <code class="docutils literal notranslate"><span class="pre">colnames</span></code> 的顺序必须与数据库返回的结果游标中的字段顺序一致。</p>
</section>
<section id="lastsql">
<h3><code class="docutils literal notranslate"><span class="pre">_lastsql</span></code><a class="headerlink" href="#lastsql" title="Link to this heading"></a></h3>
<p>无论 SQL 语句是使用 executesql 手动执行的，还是由 DAL 生成的，您都可以用 <code class="docutils literal notranslate"><span class="pre">db._lastsql</span></code> 返回真正的 SQL 语句代码。这对于调试目的很有用：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">_lastsql</span>
<span class="go">SELECT person.id, person.name FROM person;</span>
</pre></div>
</div>
<blockquote>
<div><p>py4web 从不使用 “*” 运算符生成查询。py4web 的查询字段总是需要明确地指定。</p>
</div></blockquote>
</section>
<section id="timing-queries">
<h3>查询的耗时<a class="headerlink" href="#timing-queries" title="Link to this heading"></a></h3>
<p>所有查询都由 py4web 自动计时。变量 <code class="docutils literal notranslate"><span class="pre">db._timings</span></code> 是一个元组列表。每个元组都包含传递给数据库驱动程序的原始 SQL 查询语句以及以秒为单位的执行时间。</p>
</section>
<section id="indexes">
<h3>索引<a class="headerlink" href="#indexes" title="Link to this heading"></a></h3>
<p>目前，DAL API 没有提供在表上创建索引的命令，但这可以使用 executesql 命令来完成。这是因为索引的存在会使迁移变得复杂，最好明确地处理它们。对于那些在查询中频繁使用的字段，可能需要为其创建索引。</p>
<p>这里是一个示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="n">db</span><span class="o">.</span><span class="n">executesql</span><span class="p">(</span><span class="s1">&#39;CREATE INDEX IF NOT EXISTS myidx ON person (name);&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>其他数据库方言具有非常相似的语法，但可能不支持可选的 “IF not EXISTS” 指令。</p>
</section>
<section id="generating-raw-sql">
<h3>生成原始的 SQL 语句<a class="headerlink" href="#generating-raw-sql" title="Link to this heading"></a></h3>
<p>有时您需要生成 SQL 语句，但不需要执行它。使用 py4web 很容易做到这一点，因为执行数据库读写操作的每个命令都有一个不执行的等效命令，并且只返回本应执行的 SQL 语句。这些命令的名称和语法与函数式命令相同，但它们以下划线开头：</p>
<p>下面是 <code class="docutils literal notranslate"><span class="pre">_insert</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Alex&#39;</span><span class="p">))</span>
<span class="go">INSERT INTO &quot;person&quot;(&quot;name&quot;) VALUES (&#39;Alex&#39;);</span>
</pre></div>
</div>
<p>下面是 <code class="docutils literal notranslate"><span class="pre">_count</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_count</span><span class="p">())</span>
<span class="go">SELECT COUNT(*) FROM &quot;person&quot; WHERE (&quot;person&quot;.&quot;name&quot; = &#39;Alex&#39;);</span>
</pre></div>
</div>
<p>下面是 <code class="docutils literal notranslate"><span class="pre">_select</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_select</span><span class="p">())</span>
<span class="go">SELECT &quot;person&quot;.&quot;id&quot;, &quot;person&quot;.&quot;name&quot; FROM &quot;person&quot; WHERE (&quot;person&quot;.&quot;name&quot; = &#39;Alex&#39;);</span>
</pre></div>
</div>
<p>下面是 <code class="docutils literal notranslate"><span class="pre">_delete</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_delete</span><span class="p">())</span>
<span class="go">DELETE FROM &quot;person&quot; WHERE (&quot;person&quot;.&quot;name&quot; = &#39;Alex&#39;);</span>
</pre></div>
</div>
<p>最后，下面是  <code class="docutils literal notranslate"><span class="pre">_update</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Susan&#39;</span><span class="p">))</span>
<span class="go">UPDATE &quot;person&quot; SET &quot;name&quot;=&#39;Susan&#39; WHERE (&quot;person&quot;.&quot;name&quot; = &#39;Alex&#39;);</span>
</pre></div>
</div>
<blockquote>
<div><p>此外，无论是使用 executesql 手动执行还是DAL 生成的 SQL 语句，您始终可以使用 <code class="docutils literal notranslate"><span class="pre">db._lastsql</span></code> 返回最近执行的 SQL 语句代码。</p>
</div></blockquote>
</section>
</section>
<section id="select-command">
<h2><code class="docutils literal notranslate"><span class="pre">select</span></code> 命令<a class="headerlink" href="#select-command" title="Link to this heading"></a></h2>
<p>有一个数据集合 <code class="docutils literal notranslate"><span class="pre">s</span></code> ，使用 <code class="docutils literal notranslate"><span class="pre">select</span></code> 命令能获取数据记录：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div>
</div>
<p>这返回 <code class="docutils literal notranslate"><span class="pre">pydal.objects.Rows</span></code> 类的一个可迭代对象，里面的元素是 <code class="docutils literal notranslate"><span class="pre">Row</span></code> 对象。<code class="docutils literal notranslate"><span class="pre">pydal.objects.Row</span></code> 对象的行为像字典，但是它们的元素可以作为属性来访问。前者不同于后者，因为 <code class="docutils literal notranslate"><span class="pre">Row</span></code> 的元素的值是只读的。</p>
<p>Rows 对象允许循环查询（ select ）的结果，并打印每行中选定的字段值：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">1 Alex</span>
</pre></div>
</div>
<p>您可以在一个语句中完成所有步骤：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
</pre></div>
</div>
<p>select 命令可以接受参数。所有未命名的参数都被解释为要获取的字段的名称。例如，您可以显式获取字段 “id” 和字段 “name” 的值：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
<p>表的 ALL 属性允许你指定全部字段：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">1 Alex</span>
<span class="go">2 Bob</span>
<span class="go">3 Carl</span>
</pre></div>
</div>
<p>请注意，这里没有向 db 传递查询字符串。py4web 会自动识别：若你想获取 person 表的所有字段且无需额外信息，那么你需要的就是该表的所有记录。</p>
<p>等效的替代语法如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">1 Alex</span>
<span class="go">2 Bob</span>
<span class="go">3 Carl</span>
</pre></div>
</div>
<p>而且 py4web 会理解：如果你想要 person 表的所有记录且无需额外信息，那么你需要的就是该表的所有字段。</p>
<p>给定一行</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>您可以使用多个等效表达式提取其值：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">name</span>
<span class="go">Alex</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
<span class="go">Alex</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="p">(</span><span class="s1">&#39;person.name&#39;</span><span class="p">)</span>
<span class="go">Alex</span>
</pre></div>
</div>
<p>当要查询的是表达式而不是列时，后一种语法特别方便。稍后我们将展示这一点。</p>
<p>你也可以这样做</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span><span class="o">.</span><span class="n">compact</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<p>禁用以下形式</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>相反地，启用了不那么紧凑的形式：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>是的，这是不常见，很少需要。</p>
<p>Row 对象也有两个重要地方法：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span><span class="o">.</span><span class="n">delete_record</span><span class="p">()</span>
</pre></div>
</div>
<p>和</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span><span class="o">.</span><span class="n">update_record</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;new value&quot;</span><span class="p">)</span>
</pre></div>
</div>
<section id="using-an-iterator-based-select-for-lower-memory-use">
<h3>使用基于迭代器的查询以降低内存使用率<a class="headerlink" href="#using-an-iterator-based-select-for-lower-memory-use" title="Link to this heading"></a></h3>
<p>Python 的 “iterators” 是一种 “懒惰求值”。它们只为每次迭代 “提供” 那次用到的数据；而传统的 Python 循环，在循环之前就需要在内存中创建整个数据集。</p>
<p>查询的传统做法是：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>但对于大量的数据行，使用基于迭代器的替代方案会大大降低内存使用率：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">iterselect</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>测试表明，即使在具有大内存的机器上，这也快了大约 10%。</p>
</section>
<section id="rendering-rows-using-represent">
<h3>使用 represent 渲染行<a class="headerlink" href="#rendering-rows-using-represent" title="Link to this heading"></a></h3>
<p>您可能希望重写 select 返回的行，以利用字段 represents 设置中包含的格式信息。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">repr_row</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>如果你不指定索引，你会得到一个生成器来迭代所有行：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">render</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">myfield</span><span class="p">)</span>
</pre></div>
</div>
<p>也可以应用切片：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">render</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">myfield</span><span class="p">)</span>
</pre></div>
</div>
<p>如果你只想通过选定字段的 “represent” 属性来转换它们，你可以在 “fields” 参数中列出它们：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">repr_row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="p">])</span>
</pre></div>
</div>
<p>注意，它返回原始行的转换副本，因此没有 update_record （无论如何你都不想要）或 delete_record 。</p>
</section>
<section id="shortcuts">
<h3>快捷语法<a class="headerlink" href="#shortcuts" title="Link to this heading"></a></h3>
<p>DAL 支持各种代码简化的快捷形式，特别地：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myrecord</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
</pre></div>
</div>
<p>如果存在 id 字段与给定 <code class="docutils literal notranslate"><span class="pre">id</span></code> 的值相同的记录，则返回具那个记录。如果 <code class="docutils literal notranslate"><span class="pre">id</span></code> 在数据集中不存在，则返回 <code class="docutils literal notranslate"><span class="pre">None</span></code> 。上面地语句等效于：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myrecord</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div>
</div>
<p>能依据 id 删除记录：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
</pre></div>
</div>
<p>而且这等效于：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
<p>如果给定 <code class="docutils literal notranslate"><span class="pre">id</span></code> 的值存在，则会删除相应记录。</p>
<p>注意：目前，如果激活了 <em>versioning</em> （版本控制），则删除记录的快捷语法不再起作用</p>
<p>您可以插入记录：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>它等效于：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>它使用右侧字典指定的字段值来创建一条新记录。</p>
<p>注意：insert 的快捷语法以前的形式是 <code class="docutils literal notranslate"><span class="pre">db.table[0]</span> <span class="pre">=</span> <span class="pre">...</span></code> 。这在 pyDAL 19.02 中已经更改为可以正常使用 0 作为 id 来表示要插入数据。</p>
<p>你可以更新记录：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>它等效于：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>它使用右侧字典指定的字段值来更新一条已存在的记录。</p>
</section>
<section id="fetching-a-row">
<h3>读取 <code class="docutils literal notranslate"><span class="pre">Row</span></code><a class="headerlink" href="#fetching-a-row" title="Link to this heading"></a></h3>
<p>另一种方便的语法如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<span class="n">record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span>
<span class="n">record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>虽然看着与 <code class="docutils literal notranslate"><span class="pre">db.mytable[id]</span></code> 类似，但是上述语法更灵活、更安全。首先，它检查 <code class="docutils literal notranslate"><span class="pre">id</span></code> 是否为 int（或 <code class="docutils literal notranslate"><span class="pre">str(id)</span></code> 是否为 int ），如果不是，则返回 <code class="docutils literal notranslate"><span class="pre">None</span></code> （它从不引发异常）。它还允许指定记录必须满足的多个条件。如果不满足，它也会返回 <code class="docutils literal notranslate"><span class="pre">None</span></code> 。</p>
</section>
<section id="recursive-selects">
<h3>递归的 <code class="docutils literal notranslate"><span class="pre">select</span></code><a class="headerlink" href="#recursive-selects" title="Link to this heading"></a></h3>
<p>设想还是前面的表 “person” 和一个引用 “person” 的新表 “thing” ：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>表 “thing” 的一个简单查询：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">things</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div>
</div>
<p>它等效于：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">things</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">_id</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div>
</div>
<p>其中 <code class="docutils literal notranslate"><span class="pre">_id</span></code> 是对表的主键的引用。通常是 <code class="docutils literal notranslate"><span class="pre">db.thing._id</span></code> 与 <code class="docutils literal notranslate"><span class="pre">db.thing.id</span></code> 相同，我们将在本书的大部分内容中假设这一点。</p>
<p>对于 “thing” 的每一行内容，不仅可以从表 “thing” 中获取字段，还可以从链接到的表（引用的表）中（递归地）获取：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">things</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>这里的 <code class="docutils literal notranslate"><span class="pre">thing.owner_id.name</span></code> ，需要为 things 中的每个 thing 执行一次数据库查询，因此效率较低。我们建议尽可能使用连接（join）操作，而非递归查询；不过，在访问单个记录时，这种方式既便捷又实用。</p>
<p>你也可以通过选择引用同一条 person 记录的 things 来反向执行：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">person</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">person</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">orderby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;owns&#39;</span><span class="p">,</span> <span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>在这里，表达式 <code class="docutils literal notranslate"><span class="pre">person.thing</span></code> 是下面语法的快捷语法：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">==</span> <span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
<p>即，引用当前 <code class="docutils literal notranslate"><span class="pre">person</span></code> 的一组 <code class="docutils literal notranslate"><span class="pre">thing</span></code> 集合。若引用表（ <code class="docutils literal notranslate"><span class="pre">thing</span></code> ）对被引用表（ <code class="docutils literal notranslate"><span class="pre">person</span></code> ）存在多个引用关系，此语法将无法正常使用。在这种情况下，需要更明确地使用完整的 Query。</p>
</section>
<section id="orderby-groupby-limitby-distinct-having-orderby-on-limitby-join-left-cache">
<span id="orderby-groupby-limitby"></span><h3><code class="docutils literal notranslate"><span class="pre">orderby</span></code>, <code class="docutils literal notranslate"><span class="pre">groupby</span></code>, <code class="docutils literal notranslate"><span class="pre">limitby</span></code>, <code class="docutils literal notranslate"><span class="pre">distinct</span></code>, <code class="docutils literal notranslate"><span class="pre">having</span></code>, <code class="docutils literal notranslate"><span class="pre">orderby_on_limitby</span></code>, <code class="docutils literal notranslate"><span class="pre">join</span></code>, <code class="docutils literal notranslate"><span class="pre">left</span></code>, <code class="docutils literal notranslate"><span class="pre">cache</span></code><a class="headerlink" href="#orderby-groupby-limitby-distinct-having-orderby-on-limitby-join-left-cache" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">select</span></code> 命令接受许多可选参数。</p>
<section id="orderby">
<h4>orderby<a class="headerlink" href="#orderby" title="Link to this heading"></a></h4>
<p>您能获取按 name 升序排序的记录：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
<p>使用波浪号 “~”，您能获取按 name 降序排序的记录：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=~</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Carl</span>
<span class="go">Bob</span>
<span class="go">Alex</span>
</pre></div>
</div>
<p>您可以让要获取的记录以随机顺序显示：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="s1">&#39;&lt;random&gt;&#39;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Carl</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
</pre></div>
</div>
<blockquote>
<div><p>Google NoSQL 不支持使用 <code class="docutils literal notranslate"><span class="pre">orderby='&lt;random&gt;'</span></code> 。为了解决这一限制，可以对查询后的行进行排序：</p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
</pre></div>
</div>
<p>你能对记录按多个字段排序，需要使用 “|” 把多个字段组合到一起。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">|</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
</section>
<section id="groupby-having">
<h4>groupby, having<a class="headerlink" href="#groupby-having" title="Link to this heading"></a></h4>
<p>将 <code class="docutils literal notranslate"><span class="pre">groupby</span></code> 与 <code class="docutils literal notranslate"><span class="pre">orderby</span></code> 一块使用，您可以对指定字段具有相同值的记录进行分组（这是特定于后端数据库的，不适用于 Google NoSQL ）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">orderby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">groupby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
<p>你可以将 <code class="docutils literal notranslate"><span class="pre">having</span></code> 与 <code class="docutils literal notranslate"><span class="pre">groupby</span></code> 结合使用，有条件地分组（只有那些满足 <code class="docutils literal notranslate"><span class="pre">having</span></code> 条件的人才会被分组）。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">query1</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">having</span><span class="o">=</span><span class="n">query2</span><span class="p">)</span>
</pre></div>
</div>
<p>注意，query1 筛选保留查询结果要显示的记录，而 query2 筛选哪些记录会被保留分组。</p>
</section>
<section id="distinct">
<h4>distinct<a class="headerlink" href="#distinct" title="Link to this heading"></a></h4>
<p>使用参数 <code class="docutils literal notranslate"><span class="pre">distinct=True</span></code> ，可以指定查询只保留不重复的记录。除了不需要排序之外，这与使用所有指定字段进行分组具有相同的效果。使用 distinct 时，重要的是，不应选择所有字段，也不要选择 “id” 字段，否则结果将返回所有记录始终。</p>
<p>这里是一个例子：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
<p>注意， <code class="docutils literal notranslate"><span class="pre">distinct</span></code> 也可以是一个表达式，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
</section>
<section id="limitby">
<h4>limitby<a class="headerlink" href="#limitby" title="Link to this heading"></a></h4>
<p>使用 <code class="docutils literal notranslate"><span class="pre">limitby=(min,</span> <span class="pre">max)</span></code> ，能查询记录的一个子集，它从 offset=min 到 offset=max （不包括 max）。在下面的例子中，查询结果是从 0 开始的头两条记录：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">limitby</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
</pre></div>
</div>
</section>
<section id="orderby-on-limitby">
<h4>orderby_on_limitby<a class="headerlink" href="#orderby-on-limitby" title="Link to this heading"></a></h4>
<p>请注意，DAL 默认在使用 limitby 时隐式添加 orderby 。这确保了相同的查询每次返回相同的结果，这对分页很重要。但这可能会导致性能问题。使用 <code class="docutils literal notranslate"><span class="pre">orderby_on_limitby</span> <span class="pre">=</span> <span class="pre">False</span></code> 更改此设置（默认为True）。</p>
</section>
<section id="join-left">
<h4>查询中的 “连接，左连接”<a class="headerlink" href="#join-left" title="Link to this heading"></a></h4>
<p>这些涉及管理 <a class="reference internal" href="#one-to-many-relation">One to many relation</a> 。它们分别在 <a class="reference internal" href="#inner-join">Inner join</a>  和 <a class="reference internal" href="#left-outer-join">Left outer join</a>  部分进行了描述。</p>
</section>
<section id="cache-cacheable">
<h4>cache, cacheable<a class="headerlink" href="#cache-cacheable" title="Link to this heading"></a></h4>
<p>一个提供更快查询的示例用法是：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="mi">3600</span><span class="p">),</span> <span class="n">cacheable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>查看 <a class="reference internal" href="#caching-selects">Caching selects</a> ，了解权衡是什么。</p>
</section>
</section>
<section id="logical-operators">
<h3>逻辑操作<a class="headerlink" href="#logical-operators" title="Link to this heading"></a></h3>
<p>可以使用二进制 AND 运算符 “<code class="docutils literal notranslate"><span class="pre">&amp;</span></code>” 组合查询条件：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">((</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;Alex&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span> <span class="nb">print</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<span class="go">0</span>
</pre></div>
</div>
<p>也可以使用二进制 OR 运算符  “<code class="docutils literal notranslate"><span class="pre">|</span></code>” ：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">((</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span> <span class="nb">print</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
<span class="go">1 Alex</span>
</pre></div>
</div>
<p>您可以通过否定查询来反转运算：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">((</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span> <span class="nb">print</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
<span class="go">2 Bob</span>
<span class="go">3 Carl</span>
</pre></div>
</div>
<p>或者用一元运算符 “<code class="docutils literal notranslate"><span class="pre">~</span></code>” 进行显式否定：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span> <span class="nb">print</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
<span class="go">2 Bob</span>
<span class="go">3 Carl</span>
</pre></div>
</div>
<blockquote>
<div><p>由于 Python 在重载 “<code class="docutils literal notranslate"><span class="pre">and</span></code>” 和 “<code class="docutils literal notranslate"><span class="pre">or</span></code>” 运算符方面的限制，这些运算符不能用于生成查询。必须改用二元运算符 “<code class="docutils literal notranslate"><span class="pre">&amp;</span></code>” 和 “<code class="docutils literal notranslate"><span class="pre">|</span></code>” 。请注意，这些运算符（与 “<code class="docutils literal notranslate"><span class="pre">and</span></code>” 和 “<code class="docutils literal notranslate"><span class="pre">or</span></code>” 不同）的优先级高于比较运算符，因此上述示例中的 “额外” 的括号是强制性的。同样，一元运算符 “<code class="docutils literal notranslate"><span class="pre">~</span></code>” 的优先级高于比较运算符，因此 <code class="docutils literal notranslate"><span class="pre">~</span></code> 否定的内容也必须放在括号内。</p>
</div></blockquote>
<p>也可以使用就地逻辑运算符构建查询：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;Alex&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">&amp;=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">|=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;John&#39;</span>
</pre></div>
</div>
</section>
<section id="count-isempty-delete-update">
<h3><code class="docutils literal notranslate"><span class="pre">count</span></code>, <code class="docutils literal notranslate"><span class="pre">isempty</span></code>, <code class="docutils literal notranslate"><span class="pre">delete</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code><a class="headerlink" href="#count-isempty-delete-update" title="Link to this heading"></a></h3>
<p>您可以对一个数据集中的记录计数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;William&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">3</span>
</pre></div>
</div>
<p>请注意， <code class="docutils literal notranslate"><span class="pre">count</span></code> 接受一个可选的 <code class="docutils literal notranslate"><span class="pre">distinct</span></code> 参数，默认为 False，它的工作原理与 <code class="docutils literal notranslate"><span class="pre">select</span></code> 的相同参数非常相似。 <code class="docutils literal notranslate"><span class="pre">count</span></code> 还有一个 <code class="docutils literal notranslate"><span class="pre">cache</span></code> 参数，其工作原理与 <code class="docutils literal notranslate"><span class="pre">select</span></code> 方法的等效参数非常相似。</p>
<p>有时需要判断一个表是否为空。使用 <code class="docutils literal notranslate"><span class="pre">isempty</span></code> 会比 <code class="docutils literal notranslate"><span class="pre">count</span></code> 更有效：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">isempty</span><span class="p">()</span>
<span class="go">False</span>
</pre></div>
</div>
<p>可以这样删除一个数据集中的记录：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="go">0</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">delete</span></code> 方法返回已被删除的记录的数量。</p>
<p>通过传递与需要更新的字段对应的命名参数，你能更新一个数据集中的全部记录：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Ken&#39;</span><span class="p">)</span>
<span class="go">1</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">update</span></code> 方法返回已被更新的记录的数量。</p>
</section>
<section id="expressions">
<h3>表达式<a class="headerlink" href="#expressions" title="Link to this heading"></a></h3>
<p>为更新语句指定的值可以是表达式。例如，考虑这个模型：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;visits&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Massimo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">visits</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">visits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>查询条件中也可以使用表达式：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;visits&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;clicks&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">visits</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">clicks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="case">
<h3><code class="docutils literal notranslate"><span class="pre">case</span></code><a class="headerlink" href="#case" title="Link to this heading"></a></h3>
<p>表达式可以包含 case 子句，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">condition</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">yes_or_no</span> <span class="o">=</span> <span class="n">condition</span><span class="o">.</span><span class="n">case</span><span class="p">(</span><span class="s1">&#39;Yes&#39;</span><span class="p">,</span> <span class="s1">&#39;No&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">yes_or_no</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">yes_or_no</span><span class="p">])</span>  <span class="c1"># could be row(yes_or_no) too</span>
<span class="gp">...</span>
<span class="go">Alex No</span>
<span class="go">Bob Yes</span>
<span class="go">Ken No</span>
</pre></div>
</div>
</section>
<section id="update-record">
<h3><code class="docutils literal notranslate"><span class="pre">update_record</span></code><a class="headerlink" href="#update-record" title="Link to this heading"></a></h3>
<p>使用 <code class="docutils literal notranslate"><span class="pre">update_record</span></code> ，py4web 也允许更新内存中的单个记录：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">update_record</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Curt&#39;</span><span class="p">)</span>
<span class="go">&lt;Row {&#39;id&#39;: 2, &#39;name&#39;: &#39;Curt&#39;}&gt;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">update_record</span></code> 不能和下面的混淆：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Curt&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>因为对于单独的 row ， <code class="docutils literal notranslate"><span class="pre">update</span></code> 方法虽然像 <code class="docutils literal notranslate"><span class="pre">update_record</span></code> 一样更新 row 对象，但它不会更新数据库中的记录。</p>
<p>也能够先改变一个 row 对象（每次一个 row ）的属性，再调用无参数的 <code class="docutils literal notranslate"><span class="pre">update_record()</span></code> 来保存变化。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Philip&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">update_record</span><span class="p">()</span> <span class="c1"># saves above change</span>
<span class="go">&lt;Row {&#39;id&#39;: 3, &#39;name&#39;: &#39;Philip&#39;}&gt;</span>
</pre></div>
</div>
<blockquote>
<div><p>请注意，当 <code class="docutils literal notranslate"><span class="pre">row</span></code> 对象包含具有 <code class="docutils literal notranslate"><span class="pre">update</span></code> 属性的字段时（例如  <code class="docutils literal notranslate"><span class="pre">Field('modified_on',</span> <span class="pre">update=datetime.datetime.utcnow)</span></code> ），应避免使用没有参数的 <code class="docutils literal notranslate"><span class="pre">row.update_record()</span></code>  。调用 <code class="docutils literal notranslate"><span class="pre">row.update_record()</span></code> 将保留 <code class="docutils literal notranslate"><span class="pre">row</span></code> 对象中的 <em>所有</em> 现有值，因此在这种情况下，任何具有 <code class="docutils literal notranslate"><span class="pre">update</span></code> 属性的字段都将无效。对于包含 <code class="docutils literal notranslate"><span class="pre">auth.signature</span></code> 的表，请特别注意这一点。</p>
</div></blockquote>
<p>只有当表的 <code class="docutils literal notranslate"><span class="pre">id</span></code> 字段包含在查询结果中，并且 <code class="docutils literal notranslate"><span class="pre">cacheable</span></code> 未设置为 <code class="docutils literal notranslate"><span class="pre">True``时，</span> <span class="pre">``update_record</span></code> 方法才可用。</p>
</section>
<section id="inserting-and-updating-from-a-dictionary">
<h3>从字典&quot;中获取值来插入或更新记<a class="headerlink" href="#inserting-and-updating-from-a-dictionary" title="Link to this heading"></a></h3>
<p>一个常见的问题是需要在表中插入或更新记录，其中表的名称、要更新的字段和字段的值都存储在变量中。例如： <code class="docutils literal notranslate"><span class="pre">tablename</span></code>, <code class="docutils literal notranslate"><span class="pre">fieldname</span></code> 和 <code class="docutils literal notranslate"><span class="pre">value</span></code>。</p>
<p>使用下面的语法能够插入新记录：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">fieldname</span><span class="p">:</span><span class="n">value</span><span class="p">})</span>
</pre></div>
</div>
<p>可以这样更新给定 id 的记录：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">_id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">fieldname</span><span class="p">:</span><span class="n">value</span><span class="p">})</span>
</pre></div>
</div>
<p>请注意，我们使用了 <code class="docutils literal notranslate"><span class="pre">table._id</span></code> 而不是 <code class="docutils literal notranslate"><span class="pre">table.id</span></code>。这样，查询甚至适用于主键字段类型不是 “id” 的表。</p>
</section>
<section id="first-and-last">
<h3><code class="docutils literal notranslate"><span class="pre">commit</span></code> 和 <code class="docutils literal notranslate"><span class="pre">rollback</span></code><a class="headerlink" href="#first-and-last" title="Link to this heading"></a></h3>
<p>对于包含记录的 Rows 对象：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">first_row</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">last_row</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
</pre></div>
</div>
<p>等效于：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">first_row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
<span class="n">last_row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
</pre></div>
</div>
<p>请注意， <code class="docutils literal notranslate"><span class="pre">first()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">last()</span></code> 允许您获取查询中存在的第一条和最后一条记录，但这并不意味着这些记录将是第一条或最后一条插入的记录。如果你想在给定的表中读取第一条或最后一条插入的记录，别忘了使用 <code class="docutils literal notranslate"><span class="pre">orderby=db.table_name.id</span></code> 。如果你忘记了，你只会得到查询返回的第一条和最后一条，这些记录通常是由后端查询优化器确定的随机顺序。</p>
</section>
<section id="as-dict-and-as-list">
<h3><code class="docutils literal notranslate"><span class="pre">as_dict</span></code> 和 <code class="docutils literal notranslate"><span class="pre">as_list</span></code><a class="headerlink" href="#as-dict-and-as-list" title="Link to this heading"></a></h3>
<p>使用 <code class="docutils literal notranslate"><span class="pre">as_dict()</span></code> ，一个 Row 对象能够被序列化为一个常规的字典；使用 <code class="docutils literal notranslate"><span class="pre">as_list()</span></code> ，一个 Rows 对象能够被序列化为一个常规的字典列表。下面是示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">rows_list</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">as_list</span><span class="p">()</span>
<span class="n">first_row_dict</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
</pre></div>
</div>
<p>这些方法便于将 Rows 中的数据传递给通用视图或是存储到 sessions 中。（因为 Rows 对象包含对已打开的数据库连接的引用，所以它本身不能被直接序列化为字符串）</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span>  <span class="c1"># not allowed!</span>
<span class="n">session</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">as_list</span><span class="p">()</span>  <span class="c1"># allowed!</span>
</pre></div>
</div>
</section>
<section id="combining-rows">
<h3>组合使用多个 rows<a class="headerlink" href="#combining-rows" title="Link to this heading"></a></h3>
<p>不同的 Rows 对象可以在 Python 中被组合使用。这里，我们假设：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows1</span><span class="p">)</span>
<span class="go">person.name</span>
<span class="go">Max</span>
<span class="go">Tim</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows2</span><span class="p">)</span>
<span class="go">person.name</span>
<span class="go">John</span>
<span class="go">Tim</span>
</pre></div>
</div>
<p>使用 <code class="docutils literal notranslate"><span class="pre">+</span></code> 把两个 rows 集合中的记录直接进行合并：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows3</span> <span class="o">=</span> <span class="n">rows1</span> <span class="o">+</span> <span class="n">rows2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows3</span><span class="p">)</span>
<span class="go">person.name</span>
<span class="go">Max</span>
<span class="go">Tim</span>
<span class="go">John</span>
<span class="go">Tim</span>
</pre></div>
</div>
<p>使用 <code class="docutils literal notranslate"><span class="pre">|</span></code> 把两个 rows 集合中的记录进行无重复的合并：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows3</span> <span class="o">=</span> <span class="n">rows1</span> <span class="o">|</span> <span class="n">rows2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows3</span><span class="p">)</span>
<span class="go">person.name</span>
<span class="go">Max</span>
<span class="go">Tim</span>
<span class="go">John</span>
</pre></div>
</div>
<p>使用 <code class="docutils literal notranslate"><span class="pre">&amp;</span></code> 获取两个 rows 集合中的相同的记录：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows3</span> <span class="o">=</span> <span class="n">rows1</span> <span class="o">&amp;</span> <span class="n">rows2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows3</span><span class="p">)</span>
<span class="go">person.name</span>
<span class="go">Tim</span>
</pre></div>
</div>
</section>
<section id="find-exclude-sort">
<h3><code class="docutils literal notranslate"><span class="pre">find</span></code>, <code class="docutils literal notranslate"><span class="pre">exclude</span></code>, <code class="docutils literal notranslate"><span class="pre">sort</span></code><a class="headerlink" href="#find-exclude-sort" title="Link to this heading"></a></h3>
<p>有时，您需要执行两次查询，其中一次包含前一次查询的子集。在这种情况下，再次访问数据库是没有意义的。 <code class="docutils literal notranslate"><span class="pre">find</span></code>、 <code class="docutils literal notranslate"><span class="pre">exclude</span></code> 和 <code class="docutils literal notranslate"><span class="pre">sort</span></code> 对象允许您操纵 Rows 对象并生成另一个对象，而无需再次访问数据库。更具体地说： - <code class="docutils literal notranslate"><span class="pre">find</span></code> 返回一组按条件筛选的新行，并保持原始行不变。 - <code class="docutils literal notranslate"><span class="pre">exclude</span></code> 返回一组按条件筛选的新行，并将其从原始行中删除。 - <code class="docutils literal notranslate"><span class="pre">sort</span></code> 返回一组按条件排序的新行，并保持原始行不变。</p>
<p>所有这些方法都接受一个参数，一个作用于每一行（ row ）的函数。</p>
<p>这里是用法的示例</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Max&#39;</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Alex&#39;</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;M&#39;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Max</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;M&#39;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Max</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">John</span>
</pre></div>
</div>
<p>它们可以组合在一起：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Max</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">sort</span></code> 接受一个可选的参数  <code class="docutils literal notranslate"><span class="pre">reverse=True</span></code> ，其含义显而易见。</p>
<p><code class="docutils literal notranslate"><span class="pre">find</span></code> 方法有一个可选的 <code class="docutils literal notranslate"><span class="pre">limitby</span></code> 参数，其语法和功能与数据集 set 的 <code class="docutils literal notranslate"><span class="pre">select</span></code> 方法相同。</p>
</section>
<section id="caching-selects">
<h3>缓存查询<a class="headerlink" href="#caching-selects" title="Link to this heading"></a></h3>
<p>select 方法还接受一个 <code class="docutils literal notranslate"><span class="pre">cache</span></code> 参数，默认为 None。出于缓存目的，它应该设置为一个元组，其中第一个元素是带有签名 <cite>(key, callback, expiration)</cite> 的缓存函数（例如 <code class="docutils literal notranslate"><span class="pre">cache.get</span></code> 假设 <code class="docutils literal notranslate"><span class="pre">cache</span></code> 是 py4web 的缓存对象的实例），第二个元素是以秒为单位的过期时间。</p>
<p>在下面的示例中，您会看到一个控制器，它在之前定义的 db.log 表上缓存一个查询结果。实际从后端数据库获取数据的查询频率不超过每60秒一次，并将结果存储在内存中。如果对该控制器的下一次调用发生在距离上次数据库查询操作不到 60 秒的时间内，它只会从内存中获取之前的数据。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">cache_db_select</span><span class="p">():</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">logs</span><span class="o">=</span><span class="n">logs</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">select</span></code> 方法有一个可选的参数 <code class="docutils literal notranslate"><span class="pre">cacheable</span></code> ，通常设置为 False。当设置为 <code class="docutils literal notranslate"><span class="pre">cacheable=True</span></code> 时，生成的 <code class="docutils literal notranslate"><span class="pre">Rows</span></code> 是可序列化的，但这种情况下的 <code class="docutils literal notranslate"><span class="pre">Rows</span></code> 没有 <code class="docutils literal notranslate"><span class="pre">update_record</span></code> 和 <code class="docutils literal notranslate"><span class="pre">delete_record</span></code> 方法。</p>
<p>如果你不需要这些方法，可以通过设置 <code class="docutils literal notranslate"><span class="pre">cacheable</span></code> 属性来大大加快查询速度</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cacheable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>当 <code class="docutils literal notranslate"><span class="pre">cache</span></code> 参数已设置但当 <code class="docutils literal notranslate"><span class="pre">cacheable=False</span></code> （默认值）时，就仅缓存数据库查询结果，而非实际的 Rows 对象。当 <code class="docutils literal notranslate"><span class="pre">cache</span></code> 参数与 <code class="docutils literal notranslate"><span class="pre">cacheable=True</span></code> 结合使用时，整个 Rows 对象会被缓存，从而实现更快的缓存速度：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="mi">3600</span><span class="p">),</span> <span class="n">cacheable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="computed-and-virtual-fields">
<h2>计算字段和虚拟字段<a class="headerlink" href="#computed-and-virtual-fields" title="Link to this heading"></a></h2>
<section id="computed-fields">
<h3>计算结果字段<a class="headerlink" href="#computed-fields" title="Link to this heading"></a></h3>
<p>DAL 字段可能具有 <code class="docutils literal notranslate"><span class="pre">compute</span></code> 属性。这必须是一个函数（或 lambda ），它接受一个 Row 对象并为字段返回计算后的值。当有新的修改记录时，包括插入和更新，如果未提供字段的值，py4web 将尝试使用 <code class="docutils literal notranslate"><span class="pre">compute</span></code> 函数从其他字段值进行计算。以下是一个示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;total_price&#39;</span><span class="p">,</span>
<span class="gp">... </span>                      <span class="n">compute</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;unit_price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]))</span>
<span class="go">&lt;Table item (id, unit_price, quantity, total_price)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">unit_price</span><span class="o">=</span><span class="mf">1.99</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span>
<span class="go">&lt;Row {&#39;total_price&#39;: &#39;9.95&#39;, &#39;unit_price&#39;: 1.99, &#39;id&#39;: 1L, &#39;quantity&#39;: 5}&gt;</span>
</pre></div>
</div>
<p>请注意，计算后的值存储在数据库中，在检索时不会再计算，就像下面描述的虚拟字段的情况一样。计算结果字段的两个典型应用是：</p>
<ul class="simple">
<li><p>在 wiki 应用程序中，将经过处理的输入文本存储为 HTML ，以避免在每个请求时在对其进行重新处理</p></li>
<li><p>在搜索场景下，需为某个字段计算标准化的值，以供搜索功能使用。</p></li>
</ul>
<p>计算结果字段按照在表定义中定义的顺序进行计算。计算结果字段可以使用在它之前定义的计算结果字段的值。</p>
</section>
<section id="virtual-fields">
<h3>虚拟字段<a class="headerlink" href="#virtual-fields" title="Link to this heading"></a></h3>
<p>虚拟字段也是计算结果字段（如前一小节所述），但不同之处是，它们是虚拟的，因为它们不存储在数据库中，所以每次从数据库中提取记录时，它们都会被重新计算。它们可用于简化用户的代码，而无需使用额外的存储空间，但不能用于搜索。</p>
</section>
<section id="new-style-virtual-fields-experimental">
<h3>新式虚拟字段（实验）<a class="headerlink" href="#new-style-virtual-fields-experimental" title="Link to this heading"></a></h3>
<p>py4web 提供了一种新的、更简单的方法来定义虚拟字段和惰性虚拟字段。本节标记为实验性，因为最终的 API 可能仍会与此处描述的有所不同。</p>
<p>在这里，我们将考虑与上一小节中相同的示例。我们特别考虑以下模型：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>可以像这样定义一个名为 <code class="docutils literal notranslate"><span class="pre">total_price</span></code> 的虚拟字段：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">total_price</span> <span class="o">=</span> <span class="n">Field</span><span class="o">.</span><span class="n">Virtual</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="n">row</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
</pre></div>
</div>
<p>即通过简单地将一个新字段 <code class="docutils literal notranslate"><span class="pre">total_price</span></code> 定义为 <code class="docutils literal notranslate"><span class="pre">Field.Virtual</span></code>。虚拟构造函数的唯一参数是一个函数，它接受一个 row 对象并返回计算后的值。</p>
<p>当查询记录时，会自动为所有记录计算如上定义的虚拟字段：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">total_price</span><span class="p">)</span>
</pre></div>
</div>
<p>还可以定义方法字段，这些字段在调用时按需计算。例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">discounted_total</span> <span class="o">=</span> \
    <span class="n">Field</span><span class="o">.</span><span class="n">Method</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">,</span> <span class="n">discount</span><span class="o">=</span><span class="mf">0.0</span><span class="p">:</span>
                 <span class="n">row</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="n">row</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">-</span> <span class="n">discount</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
<p>在这种情况下，<code class="docutils literal notranslate"><span class="pre">row.discounted_total</span></code> 不是一个值，而是一个函数。该函数接受与传递给 <code class="docutils literal notranslate"><span class="pre">Method</span></code> 构造函数的函数相同的参数，除了 <code class="docutils literal notranslate"><span class="pre">row</span></code> 是隐式的（可以将其视为对象的 <code class="docutils literal notranslate"><span class="pre">self</span></code> ）。</p>
<p>上面示例中的懒惰字段允许计算每个 <code class="docutils literal notranslate"><span class="pre">item</span></code> 的总价：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">discounted_total</span><span class="p">())</span>
</pre></div>
</div>
<p>它还允许通过一个可选的 <code class="docutils literal notranslate"><span class="pre">discount</span></code> 百分比（比如 15% ）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">discounted_total</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
</pre></div>
</div>
<p>也可以在表的定义中定义虚拟字段和方法字段。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="o">.</span><span class="n">Virtual</span><span class="p">(</span><span class="s1">&#39;total_price&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="o">...</span><span class="p">),</span>
                <span class="n">Field</span><span class="o">.</span><span class="n">Method</span><span class="p">(</span><span class="s1">&#39;discounted_total&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">,</span> <span class="n">discount</span><span class="o">=</span><span class="mf">0.0</span><span class="p">:</span> <span class="o">...</span><span class="p">))</span>
</pre></div>
</div>
<blockquote>
<div><p>请记住，虚拟字段没有常规字段的属性（ length、default、required 等）。它们不在 <code class="docutils literal notranslate"><span class="pre">db.table.fields</span></code> 的列表里面。</p>
</div></blockquote>
</section>
<section id="old-style-virtual-fields">
<h3>旧式虚拟字段<a class="headerlink" href="#old-style-virtual-fields" title="Link to this heading"></a></h3>
<p>为了定义一个或多个虚拟字段，您还可以定义一个容器类，实例化它并将其链接到一个表或一个查询。例如，考虑下表：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>可以像这样定义一个名为 <code class="docutils literal notranslate"><span class="pre">total_price</span></code> 的虚拟字段：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyVirtualFields</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span>

<span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">virtualfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MyVirtualFields</span><span class="p">())</span>
</pre></div>
</div>
<p>请注意，类中接受单个参数（self）的每个方法都是一个新的虚字段。 <code class="docutils literal notranslate"><span class="pre">self</span></code> 指的是查询中的每个 row 。字段值由 <code class="docutils literal notranslate"><span class="pre">self.item.unit_price</span></code> 中的完整路径引用。通过将类的实例附加到表的 <code class="docutils literal notranslate"><span class="pre">virtualfields</span></code> 属性，将表链接到虚拟字段。</p>
<p>虚拟字段也可以访问递归字段，如</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;order_item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;reference item&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">))</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyVirtualFields</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">quantity</span>

<span class="n">db</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">virtualfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MyVirtualFields</span><span class="p">())</span>
</pre></div>
</div>
<p>请注意，递归字段访问的语句 <code class="docutils literal notranslate"><span class="pre">self.order_item.item.unit_price</span></code> 中， <code class="docutils literal notranslate"><span class="pre">self</span></code> 代表循环中的当前记录。</p>
<p>它们也可以对 JOIN 的结果进行操作。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">item</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyVirtualFields</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">quantity</span>

<span class="n">rows</span><span class="o">.</span><span class="n">setvirtualfields</span><span class="p">(</span><span class="n">order_item</span><span class="o">=</span><span class="n">MyVirtualFields</span><span class="p">())</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">total_price</span><span class="p">)</span>
</pre></div>
</div>
<p>注意在这种情况下，语法有何不同。虚拟字段同时访问 <code class="docutils literal notranslate"><span class="pre">self.item.unit_price</span></code> 和 <code class="docutils literal notranslate"><span class="pre">self.order_item.quantity</span></code> ，它们都属于连接查询（ join ）。虚拟字段通过 rows 对象的 <code class="docutils literal notranslate"><span class="pre">setvirtualfields</span></code> 方法附加到表的 rows 上。该方法接受任意数量的命名参数，可用于设置多个虚拟字段，这些字段可以定义在多个类中，并附加到多个表上：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyVirtualFields1</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">discounted_unit_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="mf">0.90</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyVirtualFields2</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">quantity</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">discounted_total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">discounted_unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">quantity</span>

<span class="n">rows</span><span class="o">.</span><span class="n">setvirtualfields</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">MyVirtualFields1</span><span class="p">(),</span>
                      <span class="n">order_item</span><span class="o">=</span><span class="n">MyVirtualFields2</span><span class="p">())</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">discounted_total_price</span><span class="p">)</span>
</pre></div>
</div>
<p>虚拟字段可以是惰性的；它们所需要做的只是返回一个函数，并通过调用该函数来访问它：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">))</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyVirtualFields</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lazy_total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">lazy</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span>
        <span class="k">return</span> <span class="n">lazy</span>

<span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">virtualfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MyVirtualFields</span><span class="p">())</span>

<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">lazy_total_price</span><span class="p">())</span>
</pre></div>
</div>
<p>或者使用 lambda 函数会更简短：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyVirtualFields</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lazy_total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span>
</pre></div>
</div>
</section>
</section>
<section id="joins-and-relations">
<h2>连接和关系<a class="headerlink" href="#joins-and-relations" title="Link to this heading"></a></h2>
<section id="one-to-many-relation">
<h3>一对多关系<a class="headerlink" href="#one-to-many-relation" title="Link to this heading"></a></h3>
<p>为了演示如何使用数据访问层（DAL）实现一对多关系，请定义另一个名为 “thing” 的表，该表引用我们在这里重新定义的 “person” 表：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Alex&#39;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Bob&#39;</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Carl&#39;</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>
<span class="go">&lt;Table thing (id, name, owner_id)&gt;</span>
</pre></div>
</div>
<p>表 “thing” 有两个字段，即物品的名称和物品的所有者。“owner_id” 字段是一个引用字段，它的作用是通过 ID 引用另一个表。引用类型可以通过两种等效的方式指定，即：<code class="docutils literal notranslate"><span class="pre">Field('owner_id',</span> <span class="pre">'reference</span> <span class="pre">person')</span></code> 或：<code class="docutils literal notranslate"><span class="pre">Field('owner_id',</span> <span class="pre">db.person)</span></code>。</p>
<p>后者总是会被转换为前者。它们是等效的，但在惰性表、自引用或其他类型的循环引用情况下，就只能使用前者。</p>
<p>现在，插入三件物品，其中两件属于 Alex ，一件属于 Bob：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Boat&#39;</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Chair&#39;</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Shoes&#39;</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="go">3</span>
</pre></div>
</div>
<p>您可以像对其他表一样对它进行查询：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Boat</span>
<span class="go">Chair</span>
</pre></div>
</div>
<p>因为 thing 有一个指向 person 的引用，一个 person 可以拥有许多 things，所以 person 表的记录现在获得了一个新的属性 thing，它是一个集合，用于定义某个 person 的所拥有的 things。这允许我们遍历所有的 person 并轻松获取他们的 things：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">person</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="p">,</span> <span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">     Boat</span>
<span class="go">     Chair</span>
<span class="go">Bob</span>
<span class="go">     Shoes</span>
<span class="go">Carl</span>
</pre></div>
</div>
</section>
<section id="inner-join">
<h3>内连接<a class="headerlink" href="#inner-join" title="Link to this heading"></a></h3>
<p>实现类似结果的另一种方式是使用连接，特别是 INNER JOIN。 当查询需要将两个或多个表关联时，py4web 会自动且透明地执行连接，如以下示例所示：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex has Boat</span>
<span class="go">Alex has Chair</span>
<span class="go">Bob has Shoes</span>
</pre></div>
</div>
<p>请注意，py4web 执行了一个连接操作，因此现在每行包含两个记录，每个表各一个，并且它们已连接在一起。由于这两个记录可能具有字段名冲突，在从行中提取字段值时需要指定表。这意味着虽然之前你可以这样做：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>这是指一个 person 的名字还是一个 thing 的，非常显而易见，在连接（join）的结果中，你必须更明确地说明，并且要这样说：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>或：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>这里由 INNER JOIN 的一种替代语法：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">join</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex has Boat</span>
<span class="go">Alex has Chair</span>
<span class="go">Bob has Shoes</span>
</pre></div>
</div>
<p>虽然输出相同，但两种情况下生成的 SQL 可能不同。后一种语法在同一表被连接两次并使用别名时可以消除可能的歧义：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id1&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id2&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>

<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">join</span><span class="o">=</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;owner_id1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id1</span><span class="p">),</span>
              <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;owner_id2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id2</span><span class="p">)])</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">join</span></code>  的值可以是要连接的 <code class="docutils literal notranslate"><span class="pre">db.table.on(...)</span></code> 列表。</p>
</section>
<section id="left-outer-join">
<h3>左外连接<a class="headerlink" href="#left-outer-join" title="Link to this heading"></a></h3>
<p>注意 Carl 没有出现在上面的列表中，因为他没有任何 things。如果你打算查询人员（无论他们是否有事物）及其事物（如果有的话），那么你需要执行 LEFT OUTER JOIN（左外连接）。这是通过在 select 中使用参数 “left” 来完成的。这里是一个示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">left</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex has Boat</span>
<span class="go">Alex has Chair</span>
<span class="go">Bob has Shoes</span>
<span class="go">Carl has None</span>
</pre></div>
</div>
<p>上面的：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">left</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>执行左连接查询。这里 <code class="docutils literal notranslate"><span class="pre">db.thing.on</span></code> 的参数是进行连接所需的条件（与上面内连接中使用的相同）。在进行左连接时，需要明确选择哪些字段。</p>
<p>可以通过将 <code class="docutils literal notranslate"><span class="pre">db.mytable.on(...)</span></code> 的列表或元组传递给 <code class="docutils literal notranslate"><span class="pre">left</span></code> 参数来组合多个左连接。</p>
</section>
<section id="grouping-and-counting">
<h3>分组与计数<a class="headerlink" href="#grouping-and-counting" title="Link to this heading"></a></h3>
<p>在进行连接时，有时你希望根据某些条件对记录进行分组并进行计数。例如，统计每个人拥有的物品数量。py4web 也支持这种操作。首先，你需要一个计数运算符。其次，你需要通过 “拥有” 将 person 表与 thing 表进行连接。第三，你希望选择所有行（person + thing），按 person 分组，并在分组时进行计数:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">count</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span>
<span class="gp">... </span>              <span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">count</span><span class="p">])</span>
<span class="gp">...</span>
<span class="go">Alex 2</span>
<span class="go">Bob 1</span>
</pre></div>
</div>
<p>请注意，<code class="docutils literal notranslate"><span class="pre">count</span></code> 运算符（内置的）是作为一个字段使用的。这里唯一的问题是如何获取信息。每一行显然包含一个人和计数，但计数既不是该人的字段，也不是一个表。那么它应该放在哪里呢？它会放入表示记录的存储对象中，其键等于查询表达式本身。</p>
<p>Field 对象的 <code class="docutils literal notranslate"><span class="pre">count</span></code> 方法有一个可选的  <code class="docutils literal notranslate"><span class="pre">distinct</span></code> 参数。当设置为 True 时，它指定只计算该字段的不同值。</p>
</section>
<section id="many-to-many-relation">
<h3>多对多关系<a class="headerlink" href="#many-to-many-relation" title="Link to this heading"></a></h3>
<p>在前面的例子中，我们允许一个 thing 有一个所有者，但一个 person 可以拥有多个 things。如果 boat 同时属于 Alex 和 Curt 呢？这是多对多的关系，它需要通过一个中间表来实现，该表通过所有关系将人和物品连接起来。</p>
<p>下面是实现方法：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Alex&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Bob&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Carl&#39;</span><span class="p">)])</span>
<span class="go">[1, 2, 3]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table thing (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Boat&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Chair&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Shoes&#39;</span><span class="p">)])</span>
<span class="go">[1, 2, 3]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;ownership&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span> <span class="s1">&#39;reference thing&#39;</span><span class="p">))</span>
<span class="go">&lt;Table ownership (id, person, thing)&gt;</span>
</pre></div>
</div>
<p>现有的所有关系现在可以重写为：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">thing</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Alex owns Boat</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">thing</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Alex owns Chair</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">thing</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># Bob owns Shoes</span>
<span class="go">3</span>
</pre></div>
</div>
<p>现在你可以添加 Curt 也拥有 Boat 的新关系：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">thing</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Curt owns Boat too</span>
<span class="go">4</span>
</pre></div>
</div>
<p>你现在在两个表之间有一个第三方关系，因此定义一个新的集合来执行操作可能会更方便：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">persons_and_things</span> <span class="o">=</span> <span class="n">db</span><span class="p">((</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">person</span><span class="p">)</span> <span class="o">&amp;</span>
<span class="gp">... </span>                        <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">thing</span><span class="p">))</span>
</pre></div>
</div>
<p>现在很容易从新的集合中查询全部的 persons 及他们拥有的物品：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">persons_and_things</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex has Boat</span>
<span class="go">Alex has Chair</span>
<span class="go">Bob has Shoes</span>
<span class="go">Curt has Boat</span>
</pre></div>
</div>
<p>类似地，你能查询 Alex 拥有的全部 things：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">persons_and_things</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Boat</span>
<span class="go">Chair</span>
</pre></div>
</div>
<p>和 boat 的全部拥有者：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">persons_and_things</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Boat&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Curt</span>
</pre></div>
</div>
<p>比多对多关系更轻量的做法是标签化（tagging），请参见 <a class="reference internal" href="chapter-13.html#authorization-using-tags"><span class="std std-ref">使用 Tags 进行授权</span></a> 一章。即使在不支持 JOIN 的数据库后端（如 Google App Engine 的 NoSQL）上，标签化（tagging）也能正常工作。</p>
</section>
<section id="self-reference-and-aliases">
<h3>自引用与别名<a class="headerlink" href="#self-reference-and-aliases" title="Link to this heading"></a></h3>
<p>可以定义包含自引用字段的表，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;father_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;mother_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>注意，在此情况下，如果使用表对象作为字段类型就会失败，因为它在表定义之前就使用了还没定义完整的自身，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;father_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">),</span>  <span class="c1"># wrong!</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;mother_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;person&#39;</span><span class="p">]))</span>  <span class="c1"># wrong!</span>
</pre></div>
</div>
<p>一般来说， <code class="docutils literal notranslate"><span class="pre">db.tablename</span></code> 和 <code class="docutils literal notranslate"><span class="pre">'reference</span> <span class="pre">tablename'</span></code> 是等效的字段类型，但后者是唯一允许自引用的字段类型。</p>
<p>当一个表有自引用并且您必须进行连接接（join）查询时，例如选择一个人及其父亲，您需要一个表的别名。在 SQL 中，别名是一个临时备用的名称，可用于将表/列引用到查询（或其他 SQL 语句）中。</p>
<p>使用 py4web，您可以使用 <code class="docutils literal notranslate"><span class="pre">with_alias</span></code> 方法为表创建别名。这也适用于表达式，这意味着也适用于字段，因为 <code class="docutils literal notranslate"><span class="pre">Field</span></code> 是从 <code class="docutils literal notranslate"><span class="pre">Expression</span></code> 派生出来的。</p>
<p>这里是一个例子：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">fid</span><span class="p">,</span> <span class="n">mid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Massimo&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Claudia&#39;</span><span class="p">)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Marco&#39;</span><span class="p">,</span> <span class="n">father_id</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">mother_id</span><span class="o">=</span><span class="n">mid</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Father</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;father&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Mother</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;mother&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">Father</span><span class="p">)</span>
<span class="go">&lt;class &#39;pydal.objects.Table&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">str</span><span class="p">(</span><span class="n">Father</span><span class="p">)</span>
<span class="go">&#39;person AS father&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">Father</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">Mother</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">left</span><span class="o">=</span><span class="p">(</span><span class="n">Father</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">Father</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">father_id</span><span class="p">),</span>
<span class="gp">... </span>                         <span class="n">Mother</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">Mother</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">mother_id</span><span class="p">)))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">father</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">mother</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Massimo None None</span>
<span class="go">Claudia None None</span>
<span class="go">Marco Massimo Claudia</span>
</pre></div>
</div>
<p>请注意，我们选择做了区分：-“father_id”：表 “person” 中使用的字段名；-“father”：我们想为被上述字段引用的表使用的别名；这被传送到数据库；-“Father”：py4web 使用的变量，用来引用别名对应的对象。</p>
<p>区别是微妙的，对这三个词使用相同的名字并没有错：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;father&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;mother&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name, father, mother)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fid</span><span class="p">,</span> <span class="n">mid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Massimo&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Claudia&#39;</span><span class="p">)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Marco&#39;</span><span class="p">,</span> <span class="n">father</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">mother</span><span class="o">=</span><span class="n">mid</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">father</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;father&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mother</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;mother&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">father</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mother</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">left</span><span class="o">=</span><span class="p">(</span><span class="n">father</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">father</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">father</span><span class="p">),</span>
<span class="gp">... </span>                         <span class="n">mother</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">mother</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">mother</span><span class="p">)))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">father</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">mother</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Massimo None None</span>
<span class="go">Claudia None None</span>
<span class="go">Marco Massimo Claudia</span>
</pre></div>
</div>
<p>但为了构建正确的查询，明确地区分很重要。</p>
</section>
</section>
<section id="other-operators">
<h2>其他运算符<a class="headerlink" href="#other-operators" title="Link to this heading"></a></h2>
<p>py4web 还有其他运算符，它们提供了一个 API 来访问等价的 SQL 运算符。让我们定义另一个表 “log” 来存储安全事件、事件时间和严重性，其中严重性是一个整数。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">),</span>
<span class="gp">... </span>                       <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;event_time&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">),</span>
<span class="gp">... </span>                       <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;severity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">))</span>
<span class="go">&lt;Table log (id, event, event_time, severity)&gt;</span>
</pre></div>
</div>
<p>如前所述，插入一些事件， “port scan” 、“xss injection” 和 “unauthorized login”。为了示例，您可以记录具有相同 event_time 但严重程度不同（分别为 1、2 和 3 ）的事件。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s1">&#39;port scan&#39;</span><span class="p">,</span> <span class="n">event_time</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s1">&#39;xss injection&#39;</span><span class="p">,</span> <span class="n">event_time</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s1">&#39;unauthorized login&#39;</span><span class="p">,</span> <span class="n">event_time</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="go">3</span>
</pre></div>
</div>
<section id="like-ilike-regexp-startswith-endswith-contains-upper-lower">
<h3><code class="docutils literal notranslate"><span class="pre">like</span></code>, <code class="docutils literal notranslate"><span class="pre">ilike</span></code>, <code class="docutils literal notranslate"><span class="pre">regexp</span></code>, <code class="docutils literal notranslate"><span class="pre">startswith</span></code>, <code class="docutils literal notranslate"><span class="pre">endswith</span></code>, <code class="docutils literal notranslate"><span class="pre">contains</span></code>, <code class="docutils literal notranslate"><span class="pre">upper</span></code>, <code class="docutils literal notranslate"><span class="pre">lower</span></code><a class="headerlink" href="#like-ilike-regexp-startswith-endswith-contains-upper-lower" title="Link to this heading"></a></h3>
<p>字段有一个 <code class="docutils literal notranslate"><span class="pre">like</span></code> 运算符，可用于匹配字符串：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;port%&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">port scan</span>
</pre></div>
</div>
<p>这里的 “port%” 表示以 “port” 开头的字符串。 “ % ” 是一个通配符，代表 “任意地字符序列” 。</p>
<p><code class="docutils literal notranslate"><span class="pre">like</span></code> 运算符映射到 ANSI-SQL 中的  LIKE 关键字。在大多数数据库中，LIKE 是区分大小写的，其行为取决于数据库自身的规则。因此，<code class="docutils literal notranslate"><span class="pre">like</span></code> 方法区分大小写，但可以通过以下方式使其不区分大小写：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>其作用和使用 <code class="docutils literal notranslate"><span class="pre">ilike</span></code> 相同：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>py4web 也提供了一些便捷形式：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>它们大致相当于：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;value%&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;%value&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;%value%&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>请记住， <code class="docutils literal notranslate"><span class="pre">contains</span></code> 对 <code class="docutils literal notranslate"><span class="pre">list:&lt;type&gt;</span></code> 字段有特殊含义，如 <a class="reference internal" href="#list-type-and-contains"><span class="std std-ref">list:&lt;type&gt; 和 contains</span></a> 中所述。</p>
<p>也能把一些值组成的列表传递给 <code class="docutils literal notranslate"><span class="pre">contains</span></code> 方法，同时还有一个可选的 boolean 参数  <code class="docutils literal notranslate"><span class="pre">all</span></code> 决定着搜索的字段要包含列表中的每个值：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">contains</span><span class="p">([</span><span class="s1">&#39;value1&#39;</span><span class="p">,</span> <span class="s1">&#39;value2&#39;</span><span class="p">],</span> <span class="nb">all</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>或者包含列表中的任意一个值：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">contains</span><span class="p">([</span><span class="s1">&#39;value1&#39;</span><span class="p">,</span> <span class="s1">&#39;value2&#39;</span><span class="p">],</span> <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>还有一个 <code class="docutils literal notranslate"><span class="pre">regexp</span></code> 方法，其工作方式与 <code class="docutils literal notranslate"><span class="pre">like</span></code> 方法类似，但允许查找表达式使用正则表达式语法。它只支持 MySQL、Oracle、PostgreSQL、SQLite 和 MongoDB （支持程度不同）。</p>
<p><code class="docutils literal notranslate"><span class="pre">upper</span></code> 和 <code class="docutils literal notranslate"><span class="pre">lower</span></code> 方法允许您将字段的值转换为大写或小写，您还可以将它们与 like 运算符组合在一起：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;PORT%&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">port scan</span>
</pre></div>
</div>
</section>
<section id="year-month-day-hour-minutes-seconds">
<h3><code class="docutils literal notranslate"><span class="pre">year</span></code>, <code class="docutils literal notranslate"><span class="pre">month</span></code>, <code class="docutils literal notranslate"><span class="pre">day</span></code>, <code class="docutils literal notranslate"><span class="pre">hour</span></code>, <code class="docutils literal notranslate"><span class="pre">minutes</span></code>, <code class="docutils literal notranslate"><span class="pre">seconds</span></code><a class="headerlink" href="#year-month-day-hour-minutes-seconds" title="Link to this heading"></a></h3>
<p>date 和 datetime 类型的字段有 <code class="docutils literal notranslate"><span class="pre">day</span></code> 、 <code class="docutils literal notranslate"><span class="pre">month</span></code> 和 <code class="docutils literal notranslate"><span class="pre">year</span></code> 方法。datetime 和 time 类型的字段有 <code class="docutils literal notranslate"><span class="pre">hour</span></code> 、 <code class="docutils literal notranslate"><span class="pre">minutes</span></code> 、 <code class="docutils literal notranslate"><span class="pre">seconds</span></code> 方法。这里是一个例子：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event_time</span><span class="o">.</span><span class="n">year</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">2018</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">port scan</span>
<span class="go">xss injection</span>
<span class="go">unauthorized login</span>
</pre></div>
</div>
</section>
<section id="belongs">
<h3><code class="docutils literal notranslate"><span class="pre">belongs</span></code><a class="headerlink" href="#belongs" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">belongs</span></code> 方法实现了 SQL 语法中的 IN 的操作，当字段的值在某个指定的 set（list 或 tuples）中时，它返回 true 。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">severity</span><span class="o">.</span><span class="n">belongs</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">port scan</span>
<span class="go">xss injection</span>
</pre></div>
</div>
<p>DAL 还允许嵌套查询作为 belongs 运算符的参数。唯一需要注意的是，嵌套的查询必须使用 <code class="docutils literal notranslate"><span class="pre">_select</span></code> ，而不是 <code class="docutils literal notranslate"><span class="pre">select</span></code> ，并且只能明确地指定一个要查询的字段，即定义集合的字段。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">bad_days</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">_select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event_time</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event_time</span><span class="o">.</span><span class="n">belongs</span><span class="p">(</span><span class="n">bad_days</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">severity</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">1 port scan</span>
<span class="go">2 xss injection</span>
<span class="go">3 unauthorized login</span>
</pre></div>
</div>
<p>在需要嵌套查询并且查找字段类型是引用的情况下，我们也可以使用 query 作为参数。例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>

<span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="o">.</span><span class="n">belongs</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Jonathan&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div>
</div>
<p>在这个例子中，嵌套地查询只需要被 <code class="docutils literal notranslate"><span class="pre">db.thing.owner_id</span></code> 引用的字段，因此我们不再需要额外多余的 <code class="docutils literal notranslate"><span class="pre">_select</span></code> 。</p>
<p>一个嵌套查询也能够作为 insert/update 的参数值使用，但是在这种情况下的语法有些不同：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lazy</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Jonathan&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">nested_select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">owner_id</span> <span class="o">=</span> <span class="n">lazy</span><span class="p">)</span>
</pre></div>
</div>
<p>在这种情况下， <code class="docutils literal notranslate"><span class="pre">lazy</span></code> 是一个嵌套的表达式，它计算  “Jonathan” 这个人对应的 <code class="docutils literal notranslate"><span class="pre">id</span></code> 。这两行会生成一个单一的 SQL 查询。</p>
</section>
<section id="sum-avg-min-max-and-len">
<h3><code class="docutils literal notranslate"><span class="pre">sum</span></code>, <code class="docutils literal notranslate"><span class="pre">avg</span></code>, <code class="docutils literal notranslate"><span class="pre">min</span></code>, <code class="docutils literal notranslate"><span class="pre">max</span></code> and <code class="docutils literal notranslate"><span class="pre">len</span></code><a class="headerlink" href="#sum-avg-min-max-and-len" title="Link to this heading"></a></h3>
<p>在前面，您使用过 <code class="docutils literal notranslate"><span class="pre">count</span></code> 运算符对记录进行计数。同样，您可以使用 <code class="docutils literal notranslate"><span class="pre">sum</span></code> 运算符将一组记录中特定字段的值相加（求和）。与计数的情况一样，通过存储对象检索 sum 的结果：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">sum</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">severity</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="nb">sum</span><span class="p">])</span>
<span class="go">6</span>
</pre></div>
</div>
<p>您也能使用 <code class="docutils literal notranslate"><span class="pre">avg</span></code> 、 <code class="docutils literal notranslate"><span class="pre">min</span></code> 和 <code class="docutils literal notranslate"><span class="pre">max</span></code> 分别对查询后的记录计算平均值、最小值和最大值。例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">max</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">severity</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">max</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="nb">max</span><span class="p">])</span>
<span class="go">3</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">len</span></code> 计算字段值的长度。它一般被用于 string  或 text 类型的字段。但是在后端数据库支持的情况下，它可能也会用于其他类型 (boolean, integer 等)。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">13</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">unauthorized login</span>
</pre></div>
</div>
<p>表达式能被组合而形成更复杂的表达式。例如，这里我们计算的是日志中事件字符串长度加 1 的总和：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="n">exp</span><span class="p">]</span>
<span class="go">43</span>
</pre></div>
</div>
</section>
<section id="substrings">
<h3>子字符串<a class="headerlink" href="#substrings" title="Link to this heading"></a></h3>
<p>可以构建一个表达式来引用子字符串。例如，我们可以将名称以相同的三个字符开头的事物分组，并从每组中只选择一个：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">distinct</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="default-values-with-coalesce-and-coalesce-zero">
<h3><code class="docutils literal notranslate"><span class="pre">coalesce</span></code> 和 <code class="docutils literal notranslate"><span class="pre">coalesce_zero</span></code><a class="headerlink" href="#default-values-with-coalesce-and-coalesce-zero" title="Link to this heading"></a></h3>
<p>有时，您需要从数据库中提取一个值，但如果记录的值已被设置为 NULL ，则还需要一个默认值。在 SQL 中，有一个函数 <code class="docutils literal notranslate"><span class="pre">COALESCE</span></code> 用于此。py4web 有一个等效的 <code class="docutils literal notranslate"><span class="pre">coalesce</span></code> 方法：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;sysuser&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;fullname&#39;</span><span class="p">))</span>
<span class="go">&lt;Table sysuser (id, username, fullname)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Max Power&#39;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;tim&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">coa</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">fullname</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">coa</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">coa</span><span class="p">])</span>
<span class="gp">...</span>
<span class="go">Max Power</span>
<span class="go">tim</span>
</pre></div>
</div>
<p>其他时候，你需要计算一个数学表达式，但有些字段的值默认被设置为 None ，而实际它应该为零。 <code class="docutils literal notranslate"><span class="pre">coalesce_zero</span></code> 在查询中起到了弥补作用，它将默认的 None 换为零：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;sysuser&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;points&#39;</span><span class="p">))</span>
<span class="go">&lt;Table sysuser (id, username, points)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;tim&#39;</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">coalesce_zero</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="n">exp</span><span class="p">]</span>
<span class="go">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
<span class="go">&lt;class &#39;pydal.objects.Expression&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
<span class="go">SUM(COALESCE(&quot;sysuser&quot;.&quot;points&quot;,&#39;0&#39;))</span>
</pre></div>
</div>
</section>
</section>
<section id="exporting-and-importing-data">
<h2>导出和导入数据<a class="headerlink" href="#exporting-and-importing-data" title="Link to this heading"></a></h2>
<section id="csv-one-table-at-a-time">
<h3>CSV（一次一个表）<a class="headerlink" href="#csv-one-table-at-a-time" title="Link to this heading"></a></h3>
<p>当 Rows 对象被转换为字符串时，它会自动以 CSV 格式序列化：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<span class="go">person.id,person.name,thing.id,thing.name,thing.owner_id</span>
<span class="go">1,Alex,1,Boat,1</span>
<span class="go">1,Alex,2,Chair,1</span>
<span class="go">2,Bob,3,Shoes,2</span>
</pre></div>
</div>
<p>您可以将单个表序列化为 CSV 格式，并将其存储在文件 “test.CSV” 中：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">dumpfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()))</span>
</pre></div>
</div>
<p>将 <code class="docutils literal notranslate"><span class="pre">Rows</span></code> 对象转换为字符串时会生成某种编码的二进制字符串，最好明确指定所使用的编码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">dumpfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()))</span>
</pre></div>
</div>
<p>这等效于</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">rows</span><span class="o">.</span><span class="n">export_to_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>您可以读回 CSV 文件：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">import_from_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>再次说明，你应该明确地指定导出文件的编码</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">rows</span><span class="o">.</span><span class="n">export_to_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>和导入文件的编码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">import_from_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>导入时，py4web 会在 CSV 第一行标头中查找字段名称。在这个例子中，它找到了两列：“person.id” 和 “person.name” 。它忽略了 “person.” 前缀，也忽略了 “id” 字段。然后，所有记录都会被添加并分配新的 id 。</p>
</section>
<section id="csv-all-tables-at-once">
<h3>CSV（一次所有表）<a class="headerlink" href="#csv-all-tables-at-once" title="Link to this heading"></a></h3>
<p>在 py4web 中，您可以使用两个命令备份/还原整个数据库：</p>
<p>要导出：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;somefile.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">export_to_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>要导入：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;somefile.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">import_from_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>即使导入数据库与导出数据库的类型不同，也可以使用此机制。</p>
<p>数据以 csv 文件的形式存储在 “somefile.csv” 中，其中每个表都以一行表示表名，另一行表示字段名：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TABLE tablename
field1,field2,field3,...
</pre></div>
</div>
<p>两个表之间用  <code class="docutils literal notranslate"><span class="pre">\r\n\r\n</span></code> 分隔开（那是两个空行）。整个文件以下面的行结束：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>END
</pre></div>
</div>
<p>如果上传的文件未存储在数据库中，则导出文件不包括那些上传的文件。存储在文件系统上的上传文件必须单独转储，在大多数情况下， 将 “uploads” 文件夹压缩成 zip 文件即可满足需求。</p>
<p>导入时，如果数据不为空，新记录将被添加到数据库中。一般来说，新导入的记录与原始（已保存）记录的记录 id 不同，但 py4web 会恢复引用，即使原记录的 id 值发生变化，引用关系也不会断裂。</p>
<p>如果一个表包含一个名为 <code class="docutils literal notranslate"><span class="pre">uuid</span></code> 的字段，则该字段将用于识别重复项。此外，如果要导入的记录与已有记录具有相同的 <code class="docutils literal notranslate"><span class="pre">uuid</span></code> &quot;，则已有的记录将被更新。</p>
</section>
<section id="csv-and-remote-database-synchronization">
<h3>CSV 与远程数据库同步<a class="headerlink" href="#csv-and-remote-database-synchronization" title="Link to this heading"></a></h3>
<p>再次考虑以下模型：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>

<span class="c1"># usage example</span>
<span class="k">if</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">isempty</span><span class="p">():</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Massimo&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Chair&#39;</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="n">nid</span><span class="p">)</span>
</pre></div>
</div>
<p>每条记录都由一个标识符标识 id ，并由该 id 引用。如果您有两个由不同 py4web 安装使用的数据库副本，则 id 仅在每个数据库内是唯一的，而不是在数据库之间。当合并来自不同数据库的记录时，这是一个问题。</p>
<p>为了使记录在不同数据库中也是唯一的，它们必须：- 具有唯一的 id（UUID）；- 具有最后修改时间来跟踪多个副本中的最新的那个；- 引用 UUID 代替一般的 id。</p>
<p>这可以通过将上述模型更改为：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">64</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;modified_on&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">now</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">64</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;modified_on&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">now</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">64</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

<span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IN_DB</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;person.uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># usage example</span>
<span class="k">if</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">isempty</span><span class="p">():</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">nid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Massimo&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Chair&#39;</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="n">nid</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><p>请注意，在上面的表定义中，两个 <code class="docutils literal notranslate"><span class="pre">uuid</span></code> 字段的默认值被设置为一个 lambda 函数，该函数返回一个 uuid（转换为字符串）。插入的每条记录调用一次 lambda 函数，确保每条记录都有一个唯一的 UUID，即使在单个事务中插入了多条记录。</p>
</div></blockquote>
<p>创建一个控制器 action 以导出数据库：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">py4web</span><span class="w"> </span><span class="kn">import</span> <span class="n">response</span>

<span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">():</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">export_to_csv_file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/csv&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</pre></div>
</div>
<p>创建另一个控制器 action 以导入其他数据库中已保存记录的副本并同步记录：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">yatl.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">FORM</span><span class="p">,</span> <span class="n">INPUT</span>

<span class="k">def</span><span class="w"> </span><span class="nf">import_and_sync</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">FORM</span><span class="p">(</span><span class="n">INPUT</span><span class="p">(</span><span class="n">_type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">),</span> <span class="n">INPUT</span><span class="p">(</span><span class="n">_type</span><span class="o">=</span><span class="s1">&#39;submit&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">process</span><span class="p">()</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">import_from_csv_file</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># for every table</span>
        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
            <span class="c1"># for every uuid, delete all but the latest</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                     <span class="n">orderby</span><span class="o">=~</span><span class="n">table</span><span class="o">.</span><span class="n">modified_on</span><span class="p">,</span>
                                     <span class="n">groupby</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">db</span><span class="p">((</span><span class="n">table</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></div>
</div>
<p>您可以选择手动创建索引，以加快按 uuid 搜索的速度。</p>
<p>或者，您可以使用 XML-RPC 导出/导入文件。</p>
<p>如果记录引用了上传的文件，您还需要导出/导入上传文件夹的内容。请注意，其中的文件已经用 UUID 标记，因此您不必担心命名冲突和引用。</p>
</section>
<section id="html-and-xml-one-table-at-a-time">
<h3>HTML 和 XML (一次一个表)<a class="headerlink" href="#html-and-xml-one-table-at-a-time" title="Link to this heading"></a></h3>
<p>Rows 对象还有一个  <code class="docutils literal notranslate"><span class="pre">xml</span></code> 方法（类似 heplers），它可以将 Rows 对象序列化为XML/HTML：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows</span><span class="o">.</span><span class="n">xml</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">table</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">thead</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;&lt;</span><span class="nt">th</span><span class="p">&gt;</span>person.id<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;&lt;</span><span class="nt">th</span><span class="p">&gt;</span>person.name<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>thing.id<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;&lt;</span><span class="nt">th</span><span class="p">&gt;</span>thing.name<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>thing.owner_id<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">thead</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tbody</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w2p_odd odd&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Alex<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Boat<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w2p_even even&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Alex<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>2<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Chair<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w2p_odd odd&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>2<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Bob<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>3<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Shoes<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>2<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tbody</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>如果你需要使用自定义标签以任何其他 XML 格式序列化 Rows，你可以使用我们稍后将看到的通用 <code class="docutils literal notranslate"><span class="pre">TAG</span></code> XML helper 和函数调用中允许的 Python 语法 <code class="docutils literal notranslate"><span class="pre">*&lt;iterable&gt;</span></code> 轻松完成：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">TAG</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">TAG</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">TAG</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">_name</span><span class="o">=</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">fields</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;result&gt;</span>
<span class="nt">&lt;row&gt;&lt;field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;id&quot;</span><span class="nt">&gt;</span>1<span class="nt">&lt;/field&gt;&lt;field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>Alex<span class="nt">&lt;/field&gt;&lt;/row&gt;</span>
<span class="nt">&lt;row&gt;&lt;field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;id&quot;</span><span class="nt">&gt;</span>2<span class="nt">&lt;/field&gt;&lt;field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>Bob<span class="nt">&lt;/field&gt;&lt;/row&gt;</span>
<span class="nt">&lt;row&gt;&lt;field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;id&quot;</span><span class="nt">&gt;</span>3<span class="nt">&lt;/field&gt;&lt;field</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>Carl<span class="nt">&lt;/field&gt;&lt;/row&gt;</span>
<span class="nt">&lt;/result&gt;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>不要将这里使用的 <cite>TAG</cite> XML helper （请参阅 <a class="reference internal" href="chapter-10.html#tag"><span class="std std-ref">TAG</span></a> 一章）与 <code class="docutils literal notranslate"><span class="pre">Tags</span></code> 方法混淆，后者将在 <a class="reference internal" href="chapter-13.html#authorization-using-tags"><span class="std std-ref">使用 Tags 进行授权</span></a> 一章中详细解释。</p>
</div>
</section>
<section id="data-representation">
<h3>Data representation<a class="headerlink" href="#data-representation" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Rows.export_to_csv_file</span></code> 方法接受一个名为 <code class="docutils literal notranslate"><span class="pre">represent</span></code> 的关键字参数。当设置为 <code class="docutils literal notranslate"><span class="pre">True</span></code> 时，它将在导出数据时使用列的 <code class="docutils literal notranslate"><span class="pre">represent</span></code> 函数，而不是原始数据。</p>
<p>该函数还接受一个名为 <code class="docutils literal notranslate"><span class="pre">colnames</span></code> 的关键字参数，该参数应包含要导出的列名列表。它默认为所有列。</p>
<p><code class="docutils literal notranslate"><span class="pre">export_to_csv_file</span></code> 和 <code class="docutils literal notranslate"><span class="pre">import_from_csv_file</span></code> 都接受关键字参数，这些参数告诉 csv 解析器保存/加载文件的格式：- <code class="docutils literal notranslate"><span class="pre">delimiter</span></code> ：分隔值的分隔符（默认为“，”）；- <code class="docutils literal notranslate"><span class="pre">quotechar</span></code> ：用于引用字符串值的字符（默认为双引号）；- <code class="docutils literal notranslate"><span class="pre">quoting</span></code> ：添加引号的规则（默认为 <code class="docutils literal notranslate"><span class="pre">csv.QUOTE_MINIMAL</span></code>）</p>
<p>以下是一些用法示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/tmp/test.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">oufile</span><span class="p">:</span>
    <span class="n">rows</span><span class="o">.</span><span class="n">export_to_csv_file</span><span class="p">(</span><span class="n">oufile</span><span class="p">,</span>
                            <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span>
                            <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span>
                            <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NONNUMERIC</span><span class="p">)</span>
</pre></div>
</div>
<p>呈现结果类似于</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&quot;hello&quot;|35|&quot;this is the text description&quot;|&quot;2013-03-03&quot;
</pre></div>
</div>
<p>有关更多信息，请参阅 Python 官方文档。</p>
</section>
</section>
<section id="advanced-features">
<h2>高级功能<a class="headerlink" href="#advanced-features" title="Link to this heading"></a></h2>
<section id="list-type-and-contains">
<span id="id1"></span><h3><code class="docutils literal notranslate"><span class="pre">list:&lt;type&gt;</span></code> 和 <code class="docutils literal notranslate"><span class="pre">contains</span></code><a class="headerlink" href="#list-type-and-contains" title="Link to this heading"></a></h3>
<p>py4web 提供以下特殊字段类型：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">:</span><span class="n">string</span>
<span class="nb">list</span><span class="p">:</span><span class="n">integer</span>
<span class="nb">list</span><span class="p">:</span><span class="n">reference</span> <span class="o">&lt;</span><span class="n">table</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>它们可以分别包含字符串列表、整数列表和引用列表。</p>
<p>在 Google App Engine NoSQL <code class="docutils literal notranslate"><span class="pre">list:string</span></code> 被映射到 <code class="docutils literal notranslate"><span class="pre">StringListProperty</span></code> ，另外两个被映射到 <code class="docutils literal notranslate"><span class="pre">ListProperty(int)</span></code> 。在关系数据库中，它们被映射到包含以 <code class="docutils literal notranslate"><span class="pre">|</span></code> 分隔的项目列表的文本字段中。例如，<code class="docutils literal notranslate"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3]</span></code> 被映射到 <code class="docutils literal notranslate"><span class="pre">|1|2|3|</span></code> 。</p>
<p>对于字符串列表，项目被转义，项目中的任何 <code class="docutils literal notranslate"><span class="pre">|</span></code> 都被 <code class="docutils literal notranslate"><span class="pre">||</span></code> 替换。无论如何，这是一个内部表示，对用户是透明的。</p>
<p>例如，您可以按以下方式使用 <code class="docutils literal notranslate"><span class="pre">list:string</span></code> ：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;product&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">,</span> <span class="s1">&#39;list:string&#39;</span><span class="p">))</span>
<span class="go">&lt;Table product (id, name, colors)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IN_SET</span><span class="p">((</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Toy Car&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">])</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">products</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">colors</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Toy Car [&#39;red&#39;, &#39;green&#39;]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">list:integer</span></code> 的工作方式相同，但项目必须是整数。</p>
<p>与往常一样，这些要求是在表单层面执行的，而不是在数据库中调用 <code class="docutils literal notranslate"><span class="pre">insert</span></code> 时。</p>
<blockquote>
<div><p>对于 <code class="docutils literal notranslate"><span class="pre">list:&lt;type&gt;</span></code> 字段， <code class="docutils literal notranslate"><span class="pre">contains(value)</span></code> 运算符映射到一个复制的查询中，该查询检查列表是否包含 <code class="docutils literal notranslate"><span class="pre">value</span></code> 元素。<code class="docutils literal notranslate"><span class="pre">contains</span></code> 运算符也适用于常规的 <code class="docutils literal notranslate"><span class="pre">string</span></code> 字段和 <code class="docutils literal notranslate"><span class="pre">text</span></code> 字段，它映射到 <code class="docutils literal notranslate"><span class="pre">LIKE</span> <span class="pre">'%value%'</span></code> 。</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">list:reference</span></code> 和 <code class="docutils literal notranslate"><span class="pre">contains(value)</span></code> 运算符对于反规范化多对多关系特别有用。以下是一个示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="go">&lt;Table tag (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;product&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;list:reference tag&#39;</span><span class="p">))</span>
<span class="go">&lt;Table product (id, name, tags)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Toy Car&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">])</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">products</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Toy Car [1, 2, 3]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">represent</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">tags</span><span class="p">))</span>
<span class="gp">...</span>
<span class="go">Toy Car red, green, blue</span>
</pre></div>
</div>
<p>请注意，<code class="docutils literal notranslate"><span class="pre">list:reference</span> <span class="pre">tag</span></code> 字段获取到默认约束</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IN_DB</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">_format</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>它在表单中生成一个 <code class="docutils literal notranslate"><span class="pre">SELECT/OPTION</span></code> 多个项目的下拉框。</p>
<p>还要注意，此字段有一个默认的 <code class="docutils literal notranslate"><span class="pre">represent</span></code> 属性，它将引用列表表示为逗号分隔的格式化显示的引用列表。这用于只读的 <code class="docutils literal notranslate"><span class="pre">forms</span></code> 。</p>
<blockquote>
<div><p>虽然 <code class="docutils literal notranslate"><span class="pre">list:reference</span></code> 有一个默认验证器和一个默认表示，但 <code class="docutils literal notranslate"><span class="pre">list:integer</span></code> 和 <code class="docutils literal notranslate"><span class="pre">list:string</span></code> 没有。因此，如果要在表单中使用验证器，则需要给字段添加 <code class="docutils literal notranslate"><span class="pre">IS_IN_SET</span></code> 或 <code class="docutils literal notranslate"><span class="pre">IS_IN_DB</span></code> 验证器。</p>
</div></blockquote>
</section>
<section id="table-inheritance">
<h3>“表” 的继承<a class="headerlink" href="#table-inheritance" title="Link to this heading"></a></h3>
<p>可以创建一个包含另一个表中所有字段的表。将另一个表代替字段传递给 <code class="docutils literal notranslate"><span class="pre">define_table</span></code> 就足够了。例如</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;gender&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name, gender)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;doctor&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;specialization&#39;</span><span class="p">))</span>
<span class="go">&lt;Table doctor (id, name, gender, specialization)&gt;</span>
</pre></div>
</div>
<p>可以定义一个不存储在数据库中的虚拟表，以便在多个其他地方重用它。例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span>

<span class="n">signature</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;signature&#39;</span><span class="p">,</span>
                     <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;is_active&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                     <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;created_on&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">),</span>
                     <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;created_by&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">auth</span><span class="o">.</span><span class="n">user_id</span><span class="p">),</span>
                     <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;modified_on&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">now</span><span class="p">),</span>
                     <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;modified_by&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">auth</span><span class="o">.</span><span class="n">user_id</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;payment&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span> <span class="n">signature</span><span class="p">)</span>
</pre></div>
</div>
<p>此示例假设启用了标准的 py4web 身份验证。</p>
<p>请注意，如果您使用 <code class="docutils literal notranslate"><span class="pre">Auth</span></code> ，py4web 就已经为您创建了一个这样的表：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">auth</span> <span class="o">=</span> <span class="n">Auth</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;payment&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span> <span class="n">auth</span><span class="o">.</span><span class="n">signature</span><span class="p">)</span>
</pre></div>
</div>
<p>使用表继承时，如果希望继承表继承验证器，请务必在定义继承表之前定义父表的验证器。</p>
</section>
<section id="filter-in-and-filter-out">
<span id="id2"></span><h3><code class="docutils literal notranslate"><span class="pre">filter_in</span></code> 和 <code class="docutils literal notranslate"><span class="pre">filter_out</span></code><a class="headerlink" href="#filter-in-and-filter-out" title="Link to this heading"></a></h3>
<p>在将该字段的值插入数据库之前和从数据库检索字段的值之后，可以为每个要处理的字段定义一个过滤器。</p>
<p>例如，想象一下，你想在 JSON格 式的字段中存储一个可序列化的 Python 数据结构。以下是实现这一目标的方法：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;anyobj&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">))</span>
<span class="go">&lt;Table anyobj (id, name, data)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">anyobj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filter_in</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">anyobj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filter_out</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">txt</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">myobj</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="mi">3</span><span class="p">}]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">aid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">anyobj</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;myobjname&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">myobj</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">anyobj</span><span class="p">[</span><span class="n">aid</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">data</span>
<span class="go">[&#39;hello&#39;, &#39;world&#39;, 1, {&#39;2&#39;: 3}]</span>
</pre></div>
</div>
<p>另一种实现此目的的方法是使用 <code class="docutils literal notranslate"><span class="pre">SQLCustomType</span></code> 类型的字段，如 <a class="reference internal" href="#custom-field-types"><span class="std std-ref">自定义的 Field 类型</span></a> 中所述。</p>
</section>
<section id="callbacks-on-record-insert-delete-and-update">
<h3>在记录被 insert、 delete 和 update 时的回调<a class="headerlink" href="#callbacks-on-record-insert-delete-and-update" title="Link to this heading"></a></h3>
<p>PY4WEB 提供了一种机制，用于注册在 insert、 delete 和 update 记录之前和/或之后调用的回调函数。</p>
<p>每个表存储六个回调列表：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>db.mytable._before_insert
db.mytable._after_insert
db.mytable._before_update
db.mytable._after_update
db.mytable._before_delete
db.mytable._after_delete
</pre></div>
</div>
<p>您可以通过将回调函数添加到相应的回调函数列表中来注册它。需要注意的是，根据功能的不同，回调函数需要具有不同的签名。</p>
<p>这最好用例子来解释：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span><span class="w"> </span><span class="nf">pprint</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_before_insert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;before_insert&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_after_insert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;after_insert&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">)</span>
<span class="go">before_insert(&lt;OpRow {&#39;name&#39;: &#39;John&#39;}&gt;,)</span>
<span class="go">after_insert(&lt;OpRow {&#39;name&#39;: &#39;John&#39;}&gt;, 1)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_before_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;before_update&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_after_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;after_update&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Tim&#39;</span><span class="p">)</span>
<span class="go">before_update(&lt;Set (&quot;person&quot;.&quot;id&quot; = 1)&gt;, &lt;OpRow {&#39;name&#39;: &#39;Tim&#39;}&gt;)</span>
<span class="go">after_update(&lt;Set (&quot;person&quot;.&quot;id&quot; = 1)&gt;, &lt;OpRow {&#39;name&#39;: &#39;Tim&#39;}&gt;)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_before_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;before_delete&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_after_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;after_delete&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="go">before_delete(&lt;Set (&quot;person&quot;.&quot;id&quot; = 1)&gt;,)</span>
<span class="go">after_delete(&lt;Set (&quot;person&quot;.&quot;id&quot; = 1)&gt;,)</span>
<span class="go">1</span>
</pre></div>
</div>
<p>如您所见：- <code class="docutils literal notranslate"><span class="pre">f</span></code> 传递 <code class="docutils literal notranslate"><span class="pre">OpRow</span></code> 对象，其中包含插入或更新的数据。 - <code class="docutils literal notranslate"><span class="pre">i</span></code> 传递新插入记录的 id。- <code class="docutils literal notranslate"><span class="pre">s</span></code> 传递用于更新或删除操作的 Set 对象。 <code class="docutils literal notranslate"><span class="pre">OpRow</span></code> 是一个专门用于存储（字段，值）对的辅助对象，您可以将其视为一个普通的字典，甚至可以使用属性表示法的语法来操作（即 <code class="docutils literal notranslate"><span class="pre">f.name</span></code> 和 <code class="docutils literal notranslate"><span class="pre">f['name']</span></code> 是等效的）。</p>
<p>这些回调函数的返回值应该是 <code class="docutils literal notranslate"><span class="pre">None</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">False</span></code> 。如果任意一个 <code class="docutils literal notranslate"><span class="pre">_before_*</span></code> 回调函数返回的值是 <code class="docutils literal notranslate"><span class="pre">True</span></code> ，对应的实际 insert/update/delete 操作将被终止。</p>
<p>有时，回调可能需要在相同或不同的表中执行更新，并且希望避免触发其他回调，这可能会导致无限循环。</p>
<p>为此， <code class="docutils literal notranslate"><span class="pre">Set</span></code> 对象有一个 <code class="docutils literal notranslate"><span class="pre">update_naive</span></code> 方法，其工作方式类似于update，但忽略其执行前后可能触发的其它回调。</p>
<section id="database-cascades">
<h4>数据库的级联操作<a class="headerlink" href="#database-cascades" title="Link to this heading"></a></h4>
<p>数据库模式可以定义触发删除相关记录的关系，称为级联。当记录因级联而被删除时，DAL 不会收到通知。因此，级联导致的删除不会触发 *_delete 回调。</p>
</section>
</section>
<section id="record-versioning">
<h3>记录版本控制<a class="headerlink" href="#record-versioning" title="Link to this heading"></a></h3>
<p>当记录被单独修改时，可以要求 py4web 保存记录的每个副本。有不同的方法可以做到这一点，并且可以使用以下语法一次对所有表完成设置：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">auth</span><span class="o">.</span><span class="n">enable_record_versioning</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</pre></div>
</div>
<p>这种设置需要 <code class="docutils literal notranslate"><span class="pre">Auth</span></code> ，也可以像下面一样对每个单独的表进行设置。</p>
<p>假设有下面的表：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;stored_item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;is_active&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
                      <span class="n">writable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">readable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
<p>请注意，名为 <code class="docutils literal notranslate"><span class="pre">is_active</span></code> 的隐藏布尔字段，其默认值为 True</p>
<p>我们可以让 py4web 创建一个新表（在相同或不同的数据库中），并在修改时将每条记录的所有先前版本存储在表中。</p>
<p>使用下面的方法实现：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">stored_item</span><span class="o">.</span><span class="n">_enable_record_versioning</span><span class="p">()</span>
</pre></div>
</div>
<p>或使用更多参数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">stored_item</span><span class="o">.</span><span class="n">_enable_record_versioning</span><span class="p">(</span><span class="n">archive_db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
                                         <span class="n">archive_name</span><span class="o">=</span><span class="s1">&#39;stored_item_archive&#39;</span><span class="p">,</span>
                                         <span class="n">current_record</span><span class="o">=</span><span class="s1">&#39;current_record&#39;</span><span class="p">,</span>
                                         <span class="n">is_active</span><span class="o">=</span><span class="s1">&#39;is_active&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">archive_db=db</span></code> 命令告诉 py4web 将归档表存储在与 <code class="docutils literal notranslate"><span class="pre">stored_item</span></code> 表相同的数据库中。<code class="docutils literal notranslate"><span class="pre">archive_name</span></code> 设置存档表的名称。存档表具有与原始表 <code class="docutils literal notranslate"><span class="pre">stored_item</span></code> 相同的字段，除了唯一字段不再是唯一的（因为它需要存储多个版本），并且有一个额外的字段，它是对 <code class="docutils literal notranslate"><span class="pre">stored_item</span></code> 表中当前记录的引用，其名称由 <code class="docutils literal notranslate"><span class="pre">current_record</span></code> 指定。</p>
<p>当记录被删除时，它们并没有真正被删除。已删除的记录会被复制到 <code class="docutils literal notranslate"><span class="pre">stored_item_archive</span></code> 表中（就像它被修改时一样），并且 <code class="docutils literal notranslate"><span class="pre">is_active</span></code> 字段被设置为 False。通过启用记录版本控制，py4web 在此表上设置了一个 <code class="docutils literal notranslate"><span class="pre">common_filter</span></code> ，该筛选器隐藏了表 <code class="docutils literal notranslate"><span class="pre">stored_item</span></code> 中 <code class="docutils literal notranslate"><span class="pre">is_active</span></code> 字段设置为 False 的所有记录。 <code class="docutils literal notranslate"><span class="pre">_enable_record_versioning</span></code> 方法中的 <code class="docutils literal notranslate"><span class="pre">is_active</span></code> 参数允许指定 <code class="docutils literal notranslate"><span class="pre">common_filter</span></code> 用于确定字段是否被删除的字段的名称。</p>
</section>
<section id="common-filters">
<h3>通用的过滤器（Common filters）<a class="headerlink" href="#common-filters" title="Link to this heading"></a></h3>
<p>通用过滤器（Common filter）是上述多用户概念的推广。它提供了一种简单的方法来防止重复相同的查询。例如，考虑下表：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;blog_post&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;post_text&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;is_public&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">),</span>
                <span class="n">common_filter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">query</span><span class="p">:</span> <span class="n">db</span><span class="o">.</span><span class="n">blog_post</span><span class="o">.</span><span class="n">is_public</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>此表中的任何查询、删除或更新都将仅包括 “公开” 的博客帖子。该属性也可以在运行时修改：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">blog_post</span><span class="o">.</span><span class="n">_common_filter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">query</span><span class="p">:</span> <span class="o">...</span>
</pre></div>
</div>
<p>它既是一种避免在每次博客文章搜索中重复 “db.blog_post.is_public==True” 短语的方法，也是一种安全增强，可以防止您忘记设置 “禁止查看” 非公开文章。</p>
<p>如果您确实希望查询过滤器遗漏的项目（例如，允许管理员查看非公开帖子），您可以删除过滤器：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">blog_post</span><span class="o">.</span><span class="n">_common_filter</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<p>或者忽略过滤器：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">ignore_common_filters</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><p>请注意，appadmin 接口会自动忽略 common_filters。</p>
</div></blockquote>
</section>
<section id="custom-field-types">
<span id="id3"></span><h3>自定义的 <code class="docutils literal notranslate"><span class="pre">Field</span></code> 类型<a class="headerlink" href="#custom-field-types" title="Link to this heading"></a></h3>
<p>在不使用 <code class="docutils literal notranslate"><span class="pre">filter_in</span></code> 和 <code class="docutils literal notranslate"><span class="pre">filter_out</span></code> 的时候，还可以定义新的自定义字段类型。例如，下面假设你要定义一个存储 IP 地址数据的自定义类型：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span><span class="w"> </span><span class="nf">ip2int</span><span class="p">(</span><span class="n">sv</span><span class="p">):</span>
<span class="gp">... </span>    <span class="s2">&quot;Convert an IPV4 to an integer.&quot;</span>
<span class="gp">... </span>    <span class="n">sp</span> <span class="o">=</span> <span class="n">sv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span> <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="c1"># IPV4 only</span>
<span class="gp">... </span>    <span class="n">iip</span> <span class="o">=</span> <span class="mi">0</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">sp</span><span class="p">):</span> <span class="n">iip</span> <span class="o">=</span> <span class="p">(</span><span class="n">iip</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">iip</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span><span class="w"> </span><span class="nf">int2ip</span><span class="p">(</span><span class="n">iv</span><span class="p">):</span>
<span class="gp">... </span>    <span class="s2">&quot;Convert an integer to an IPV4.&quot;</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="n">iv</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="gp">... </span>    <span class="n">iv</span> <span class="o">=</span> <span class="p">(</span><span class="n">iv</span><span class="p">,);</span> <span class="n">ov</span> <span class="o">=</span> <span class="p">[]</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">iv</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">256</span><span class="p">)</span>
<span class="gp">... </span>        <span class="n">ov</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="gp">... </span>    <span class="n">ov</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ov</span><span class="p">))</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">pydal</span><span class="w"> </span><span class="kn">import</span> <span class="n">SQLCustomType</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ipv4</span> <span class="o">=</span> <span class="n">SQLCustomType</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">native</span><span class="o">=</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span>
<span class="gp">... </span>                     <span class="n">encoder</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">ip2int</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">decoder</span><span class="o">=</span><span class="n">int2ip</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;website&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;ipaddr&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">ipv4</span><span class="p">))</span>
<span class="go">&lt;Table website (id, name, ipaddr)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;wikipedia&#39;</span><span class="p">,</span> <span class="n">ipaddr</span><span class="o">=</span><span class="s1">&#39;91.198.174.192&#39;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;google&#39;</span><span class="p">,</span> <span class="n">ipaddr</span><span class="o">=</span><span class="s1">&#39;172.217.11.174&#39;</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;youtube&#39;</span><span class="p">,</span> <span class="n">ipaddr</span><span class="o">=</span><span class="s1">&#39;74.125.65.91&#39;</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;github&#39;</span><span class="p">,</span> <span class="n">ipaddr</span><span class="o">=</span><span class="s1">&#39;207.97.227.239&#39;</span><span class="p">)</span>
<span class="go">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">ipaddr</span> <span class="o">&gt;</span> <span class="s1">&#39;100.0.0.0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">orderby</span><span class="o">=~</span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">ipaddr</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">ipaddr</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">github 207.97.227.239</span>
<span class="go">google 172.217.11.174</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">SQLCustomType</span></code> 是一个字段类型工厂。参数 <code class="docutils literal notranslate"><span class="pre">type</span></code> 必须是标准的 py4 web 类型之一，它告诉 py4web 将输入的字段的值在 py4web 程序中按哪种类型对待；参数 <code class="docutils literal notranslate"><span class="pre">native</span></code> 是数据库中存储数据的字段类型，允许的名称取决于数据库引擎；参数 <code class="docutils literal notranslate"><span class="pre">encoder</span></code> 是存储数据时应用的可选变换函数；参数 <code class="docutils literal notranslate"><span class="pre">decoder</span></code> 是可选的逆变换函数。</p>
<blockquote>
<div><p>此功能被标记为实验性的，因为它会使您的代码无法在数据库引擎之间移植。</p>
</div></blockquote>
<p>它不适用于 Google App Engine NoSQL。</p>
</section>
<section id="using-dal-without-define-tables">
<h3>使用不定义表的 DAL<a class="headerlink" href="#using-dal-without-define-tables" title="Link to this heading"></a></h3>
<p>DAL 可以从任何 Python 程序中使用，只需执行以下操作：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pydal</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;path/to/app/databases&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>即，导入 DAL，连接并指定包含 .table 文件的文件夹（app/databases 文件夹）。</p>
<p>为了访问数据及其属性，我们仍然需要定义我们将使用 <code class="docutils literal notranslate"><span class="pre">db.define_table</span></code> 访问的所有表。</p>
<p>如果我们只需要访问数据，而不需要访问 py4web 表属性，那么不需要再重新定义表，只需要让 py4web 从 .table 文件中的元数据中读取必要的信息：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">py4web</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;path/to/app/databases&#39;</span><span class="p">,</span> <span class="n">auto_import</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>这允许我们访问任意的  db.table ，而无需再重新定义要访问的表。</p>
</section>
<section id="distributed-transaction">
<h3>分布式事务<a class="headerlink" href="#distributed-transaction" title="Link to this heading"></a></h3>
<blockquote>
<div><p>在撰写本文时，只有 PostgreSQL、MySQL 和 Firebird 支持此功能，因为它们公开了API 用于两阶段的提交。</p>
</div></blockquote>
<p>假设你有两个（或更多）连接到不同的 PostgreSQL 数据库，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db_a</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;postgres://...&#39;</span><span class="p">)</span>
<span class="n">db_b</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;postgres://...&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>在您的模型或控制器中，您可以同时提交它们：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DAL</span><span class="o">.</span><span class="n">distributed_transaction_commit</span><span class="p">(</span><span class="n">db_a</span><span class="p">,</span> <span class="n">db_b</span><span class="p">)</span>
</pre></div>
</div>
<p>如果失败，此函数将回滚并引发 <code class="docutils literal notranslate"><span class="pre">Exception</span></code>。</p>
<p>在控制器中，当一个 action 返回时，如果您有两个不同的数据库连接并且没有调用上述函数，py4web 会分别提交它们。这意味着有可能一个提交成功，另一个提交失败。分布式事务可以防止这种情况发生。</p>
</section>
<section id="copy-data-from-one-db-into-another">
<h3>将数据从一个数据库复制到另一个数据库<a class="headerlink" href="#copy-data-from-one-db-into-another" title="Link to this heading"></a></h3>
<p>假设您一直在使用以下数据库的情况：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>并且您希望使用不同的连接字符串切换到另一个数据库：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;postgres://username:password@localhost/mydb&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>在切换之前，您需要移动数据并为新数据库重建所有元数据。我们假设新数据库存在，但也假设它是空的。</p>
</section>
</section>
<section id="gotchas">
<h2>陷阱<a class="headerlink" href="#gotchas" title="Link to this heading"></a></h2>
<section id="note-on-new-dal-and-adapters">
<h3>关于新 DAL 和适配器的说明<a class="headerlink" href="#note-on-new-dal-and-adapters" title="Link to this heading"></a></h3>
<p>数据库抽象层的源代码在 2010 年被完全重写。虽然它保持向后兼容，但重写使其更加模块化，更容易扩展。这里我们解释一下主要逻辑。</p>
<p>模块 “dal.py” 主要定义了以下类：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ConnectionPool
BaseAdapter extends ConnectionPool
Row
DAL
Reference
Table
Expression
Field
Query
Set
Rows
</pre></div>
</div>
<p>除了 <code class="docutils literal notranslate"><span class="pre">BaseAdapter</span></code> 之外，在前面的章节中已经解释了它们的用法。当 <code class="docutils literal notranslate"><span class="pre">Table</span></code> 或 <code class="docutils literal notranslate"><span class="pre">Set</span></code> 对象的方法需要与数据库通信时，它们将生成 SQL 和/或函数调用的任务委托给适配器的方法。</p>
<p>例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;myvalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>调用</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;myvalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>该命令通过返回以下内容来委派适配器：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">_listify</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;myvalue&#39;</span><span class="p">)))</span>
</pre></div>
</div>
<p>这里 <code class="docutils literal notranslate"><span class="pre">db.mytable._listify</span></code> 将参数的 dict 转换为 <code class="docutils literal notranslate"><span class="pre">(field,value)</span></code> 列表，并调用 <code class="docutils literal notranslate"><span class="pre">adapter</span></code> 的 <code class="docutils literal notranslate"><span class="pre">insert</span></code> 方法。 <code class="docutils literal notranslate"><span class="pre">db._adapter</span></code> 执行以下类似的操作：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">,</span> <span class="n">list_of_fields</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>
</div>
<p>其中第一行构建查询，第二行执行查询。</p>
<p><code class="docutils literal notranslate"><span class="pre">BaseAdapter</span></code> 定义了适配器的所有接口。</p>
<p>在撰写本书时，pyDAL 包含以下适配器：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SQLiteAdapter extends BaseAdapter
JDBCSQLiteAdapter extends SQLiteAdapter
MySQLAdapter extends BaseAdapter
PostgreSQLAdapter extends BaseAdapter
JDBCPostgreSQLAdapter extends PostgreSQLAdapter
OracleAdapter extends BaseAdapter
MSSQLAdapter extends BaseAdapter
MSSQL2Adapter extends MSSQLAdapter
MSSQL3Adapter extends MSSQLAdapter
MSSQL4Adapter extends MSSQLAdapter
FireBirdAdapter extends BaseAdapter
FireBirdEmbeddedAdapter extends FireBirdAdapter
InformixAdapter extends BaseAdapter
DB2Adapter extends BaseAdapter
IngresAdapter extends BaseAdapter
IngresUnicodeAdapter extends IngresAdapter
GoogleSQLAdapter extends MySQLAdapter
NoSQLAdapter extends BaseAdapter
GoogleDatastoreAdapter extends NoSQLAdapter
CubridAdapter extends MySQLAdapter (experimental)
TeradataAdapter extends DB2Adapter (experimental)
SAPDBAdapter extends BaseAdapter (experimental)
CouchDBAdapter extends NoSQLAdapter (experimental)
IMAPAdapter extends NoSQLAdapter (experimental)
MongoDBAdapter extends NoSQLAdapter (experimental)
VerticaAdapter extends MSSQLAdapter (experimental)
SybaseAdapter extends MSSQLAdapter (experimental)
</pre></div>
</div>
<p>它们重写了 <code class="docutils literal notranslate"><span class="pre">BaseAdapter</span></code> 的行为。</p>
<p>每个适配器都有这种类似的结构：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MySQLAdapter</span><span class="p">(</span><span class="n">BaseAdapter</span><span class="p">):</span>

    <span class="c1"># specify a driver to use</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pymysql&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># map py4web types into database types</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;boolean&#39;</span><span class="p">:</span> <span class="s1">&#39;CHAR(1)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="s1">&#39;VARCHAR(</span><span class="si">%(length)s</span><span class="s1">)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;LONGTEXT&#39;</span><span class="p">,</span>
        <span class="o">...</span>
        <span class="p">}</span>

    <span class="c1"># connect to the database using driver</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_codec</span> <span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span>
                 <span class="n">credential_decoder</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">,</span> <span class="n">driver_args</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">adapter_args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="c1"># parse uri string and store parameters in driver_args</span>
        <span class="o">...</span>
        <span class="c1"># define a connection function</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="n">driver_args</span><span class="o">=</span><span class="n">driver_args</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">driver_args</span><span class="p">)</span>
        <span class="c1"># place it in the pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_connection</span><span class="p">(</span><span class="n">connect</span><span class="p">)</span>
        <span class="c1"># set optional parameters (after connection)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SET FOREIGN_KEY_CHECKS=1;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET sql_mode=&#39;NO_BACKSLASH_ESCAPES&#39;;&quot;</span><span class="p">)</span>

   <span class="c1"># override BaseAdapter methods as needed</span>
   <span class="k">def</span><span class="w"> </span><span class="nf">lastrowid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select last_insert_id();&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>以各种适配器为例，应该很容易编写新的适配器。</p>
<p>当创建 <code class="docutils literal notranslate"><span class="pre">db</span></code> 实例时：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;mysql://...&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>DAL() 中 uri 字符串的前缀定义了适配器。在以下字典中定义的映射，在 “dal.py” 中也有定义：</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>couchdb</p></td>
<td><p>pydal.adapters.couchdb.CouchDB</p></td>
</tr>
<tr class="row-even"><td><p>cubrid</p></td>
<td><p>pydal.adapters.mysql.Cubrid</p></td>
</tr>
<tr class="row-odd"><td><p>db2:ibm_db_dbi</p></td>
<td><p>pydal.adapters.db2.DB2IBM</p></td>
</tr>
<tr class="row-even"><td><p>db2:pyodbc</p></td>
<td><p>pydal.adapters.db2.DB2Pyodbc</p></td>
</tr>
<tr class="row-odd"><td><p>firebird</p></td>
<td><p>pydal.adapters.firebird.FireBird</p></td>
</tr>
<tr class="row-even"><td><p>firebird_embedded</p></td>
<td><p>pydal.adapters.firebird.FireBirdEmbedded</p></td>
</tr>
<tr class="row-odd"><td><p>google:MySQLdb</p></td>
<td><p>pydal.adapters.google.GoogleMySQL</p></td>
</tr>
<tr class="row-even"><td><p>google:datastore</p></td>
<td><p>pydal.adapters.google.GoogleDatastore</p></td>
</tr>
<tr class="row-odd"><td><p>google:datastore+ndb</p></td>
<td><p>pydal.adapters.google.GoogleDatastore</p></td>
</tr>
<tr class="row-even"><td><p>google:psycopg2</p></td>
<td><p>pydal.adapters.google.GooglePostgres</p></td>
</tr>
<tr class="row-odd"><td><p>google:sql</p></td>
<td><p>pydal.adapters.google.GoogleSQL</p></td>
</tr>
<tr class="row-even"><td><p>informix</p></td>
<td><p>pydal.adapters.informix.Informix</p></td>
</tr>
<tr class="row-odd"><td><p>informix-se</p></td>
<td><p>pydal.adapters.informix.InformixSE</p></td>
</tr>
<tr class="row-even"><td><p>ingres</p></td>
<td><p>pydal.adapters.ingres.Ingres</p></td>
</tr>
<tr class="row-odd"><td><p>ingresu</p></td>
<td><p>pydal.adapters.ingres.IngresUnicode</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="jdbc:postgres">jdbc:postgres</a></p></td>
<td><p>pydal.adapters.postgres.JDBCPostgre</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="jdbc:sqlite">jdbc:sqlite</a></p></td>
<td><p>pydal.adapters.sqlite.JDBCSQLite</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="jdbc:sqlite:memory">jdbc:sqlite:memory</a></p></td>
<td><p>pydal.adapters.sqlite.JDBCSQLite</p></td>
</tr>
<tr class="row-odd"><td><p>mongodb</p></td>
<td><p>pydal.adapters.mongo.Mongo</p></td>
</tr>
<tr class="row-even"><td><p>mssql</p></td>
<td><p>pydal.adapters.mssql.MSSQL1</p></td>
</tr>
<tr class="row-odd"><td><p>mssql2</p></td>
<td><p>pydal.adapters.mssql.MSSQL1N</p></td>
</tr>
<tr class="row-even"><td><p>mssql3</p></td>
<td><p>pydal.adapters.mssql.MSSQL3</p></td>
</tr>
<tr class="row-odd"><td><p>mssql3n</p></td>
<td><p>pydal.adapters.mssql.MSSQL3N</p></td>
</tr>
<tr class="row-even"><td><p>mssql4</p></td>
<td><p>pydal.adapters.mssql.MSSQL4</p></td>
</tr>
<tr class="row-odd"><td><p>mssql4n</p></td>
<td><p>pydal.adapters.mssql.MSSQL4N</p></td>
</tr>
<tr class="row-even"><td><p>mssqln</p></td>
<td><p>pydal.adapters.mssql.MSSQL1N</p></td>
</tr>
<tr class="row-odd"><td><p>mysql</p></td>
<td><p>pydal.adapters.mysql.MySQL</p></td>
</tr>
<tr class="row-even"><td><p>oracle</p></td>
<td><p>pydal.adapters.oracle.Oracle</p></td>
</tr>
<tr class="row-odd"><td><p>postgres</p></td>
<td><p>pydal.adapters.postgres.Postgre</p></td>
</tr>
<tr class="row-even"><td><p>postgres2</p></td>
<td><p>pydal.adapters.postgres.PostgreNew</p></td>
</tr>
<tr class="row-odd"><td><p>postgres2:psycopg2</p></td>
<td><p>pydal.adapters.postgres.PostgrePsycoNew</p></td>
</tr>
<tr class="row-even"><td><p>postgres3</p></td>
<td><p>pydal.adapters.postgres.PostgreBoolean</p></td>
</tr>
<tr class="row-odd"><td><p>postgres3:psycopg2</p></td>
<td><p>pydal.adapters.postgres.PostgrePsycoBoolean</p></td>
</tr>
<tr class="row-even"><td><p>postgres:psycopg2</p></td>
<td><p>pydal.adapters.postgres.PostgrePsyco</p></td>
</tr>
<tr class="row-odd"><td><p>pytds</p></td>
<td><p>pydal.adapters.mssql.PyTDS</p></td>
</tr>
<tr class="row-even"><td><p>sapdb</p></td>
<td><p>pydal.adapters.sap.SAPDB</p></td>
</tr>
<tr class="row-odd"><td><p>spatialite</p></td>
<td><p>pydal.adapters.sqlite.Spatialite</p></td>
</tr>
<tr class="row-even"><td><p>spatialite:memory</p></td>
<td><p>pydal.adapters.sqlite.Spatialite</p></td>
</tr>
<tr class="row-odd"><td><p>sqlite</p></td>
<td><p>pydal.adapters.sqlite.SQLite</p></td>
</tr>
<tr class="row-even"><td><p>sqlite:memory</p></td>
<td><p>pydal.adapters.sqlite.SQLite</p></td>
</tr>
<tr class="row-odd"><td><p>sybase</p></td>
<td><p>pydal.adapters.mssql.Sybase</p></td>
</tr>
<tr class="row-even"><td><p>teradata</p></td>
<td><p>pydal.adapters.teradata.Teradata</p></td>
</tr>
<tr class="row-odd"><td><p>vertica</p></td>
<td><p>pydal.adapters.mssql.Vertica</p></td>
</tr>
</tbody>
</table>
<p>然后，适配器本身会更详细地解析uri字符串。适配器的更新列表可以通过字典获得。</p>
<p>对于任何适配器，您都可以在全局范围内用不同的驱动程序替换已有的驱动程序（不是线程安全的）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">MySQLdb</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mysqldb</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydal.adapters.mysql</span><span class="w"> </span><span class="kn">import</span> <span class="n">SQLAdapter</span>
<span class="n">SQLAdapter</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">mysqldb</span>
</pre></div>
</div>
<p>即 <code class="docutils literal notranslate"><span class="pre">mysqldb</span></code> 必须是具有 <code class="docutils literal notranslate"><span class="pre">.connect()</span></code> 方法的模块。您可以指定可选的驱动程序参数和适配器参数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">driver_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">adapter_args</span><span class="o">=</span><span class="p">{})</span>
</pre></div>
</div>
<p>对于已识别的适配器，您还可以在 <code class="docutils literal notranslate"><span class="pre">adapter_args</span></code> 中简单地指定名称：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pydal.adapters.mysql</span><span class="w"> </span><span class="kn">import</span> <span class="n">MySQL</span>
<span class="k">assert</span> <span class="s2">&quot;mysqldv&quot;</span> <span class="ow">in</span> <span class="n">MySQL</span><span class="o">.</span><span class="n">drivers</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">driver_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">adapter_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;mysqldb&quot;</span><span class="p">})</span>
</pre></div>
</div>
</section>
<section id="sqlite">
<h3>SQLite<a class="headerlink" href="#sqlite" title="Link to this heading"></a></h3>
<p>SQLite 不支持删除和更改列。这意味着 py4web 迁移在一定程度上是可行的。如果从表中删除字段，该列将保留在数据库中，但对 py4web 不可见。如果您决定恢复该列，py4web 将尝试重新创建它，但会失败。在这种情况下，您必须添加设置 <code class="docutils literal notranslate"><span class="pre">fake_migrate=True</span></code> ，以便在不尝试再次添加列的情况下重建元数据。同样，出于同样的原因，SQLite 不知道列的类型的任何变化。如果在字符串字段中插入一个数字，它将存储为字符串。如果稍后模型的类型 “string” 更改为类型 “integer” ，SQLite 将继续将数字保持为字符串不变，这可能会在您尝试提取数据时导致问题。</p>
<p>SQLite 没有布尔类型。py4web 内部将布尔值映射为 1 个字符串，其中 'T' 和 'F' 分别表示 True 和 False。DAL 完全处理了这一点；真正布尔值的抽象效果很好。但是，如果您直接使用 SQL 更新 SQLite 表，请注意 py4web 实现，并避免使用 0 和 1 值。</p>
</section>
<section id="mysql">
<h3>MySQL<a class="headerlink" href="#mysql" title="Link to this heading"></a></h3>
<p>MySQL 不支持在单个事务中使用多个 ALTER TABLE。这意味着任何迁移过程都被分解为多个提交。如果发生了导致失败的事情，则可能会中断迁移（py4web 元数据不再与数据库中的实际表结构同步）。这很不幸，但可以防止（一次迁移一个表），也可以在之后修复（将 py4web 模型还原为数据库中与表结构相对应的模型，设置 <code class="docutils literal notranslate"><span class="pre">fake_migrate=True</span></code> ，在重建元数据后，设置fake  <code class="docutils literal notranslate"><span class="pre">fake_migrate=False</span></code> 并再次迁移表）。</p>
</section>
<section id="google-sql">
<h3>Google SQL<a class="headerlink" href="#google-sql" title="Link to this heading"></a></h3>
<p>Google SQL 与 MySQL 存在相同的问题，甚至更多。特别是，表元数据本身必须存储在数据库中一个不会被 py4web 迁移的表中。这是因为 Google App Engine 具有只读文件系统。Google SQL 中的 PY4WEB 迁移与上述 MySQL 问题相结合可能会导致元数据损坏。同样，可以防止这种情况（通过一次性迁移表，然后设置 migrate=False，使元数据表不再被访问），也可以在之后修复（通过使用 Google dashboard 访问数据库，并从名为 <code class="docutils literal notranslate"><span class="pre">py4web_filesystem</span></code> 的表中删除任何损坏的条目）。</p>
</section>
<section id="mssql-microsoft-sql-server">
<h3>MSSQL (Microsoft SQL Server)<a class="headerlink" href="#mssql-microsoft-sql-server" title="Link to this heading"></a></h3>
<p>低于 MSSQL 2012 的版本不支持 SQL OFFSET 关键字。因此，数据库无法进行分页。当执行 <code class="docutils literal notranslate"><span class="pre">limitby=(a,</span> <span class="pre">b)</span></code> 时，py4web 将获取前 a+b 行并丢弃前 a 行。与其他数据库引擎相比，这可能会导致相当大的开销。如果您使用 MSSQL 2005 及以上版本，建议使用的前缀是``mssql3://`` ，它提供了一种避免获取整个非分页结果集的方法。如果使用的是 MSSQL 2012 及以上版本，请使用 mssql4://，它采用 <code class="docutils literal notranslate"><span class="pre">OFFSET</span> <span class="pre">...</span> <span class="pre">ROWS</span> <span class="pre">...</span> <span class="pre">FETCH</span> <span class="pre">NEXT</span> <span class="pre">...</span> <span class="pre">ROWS</span> <span class="pre">ONLY</span></code> 结构，以原生方式支持分页，不会像其他后端那样产生性能损耗。  <code class="docutils literal notranslate"><span class="pre">mssql://</span></code> 还强制（出于历史原因）使用 <code class="docutils literal notranslate"><span class="pre">text</span></code> 列，在最近的版本（从 2005 年开始）中，文本列被 <code class="docutils literal notranslate"><span class="pre">varchar(max)</span></code> 取代。如果你不想面对正式弃用的 <code class="docutils literal notranslate"><span class="pre">text</span></code> 列的一些限制，应该使用 <code class="docutils literal notranslate"><span class="pre">mssql3://</span></code> 和 <code class="docutils literal notranslate"><span class="pre">mssql4://</span></code> 。</p>
<p>MSSQL 在使用具有 ONDELITE CASCADE 的表时会有循环引用的问题。这是 MSSQL 一个的漏洞，您可以通过将所有引用字段的 ondelete 属性设置为 “NO ACTION” 来避免问题出现。您也可以在定义表之前一次性完成此操作：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;mssql://....&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">types</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39; ON DELETE </span><span class="si">%(on_delete_action)s</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(on_delete_action)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;NO ACTION&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>MSSQL 在传递给 DISTINCT 关键字的参数方面也存在问题，因此，下面的可以</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">distinct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>这就不行</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">distinct</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="oracle">
<h3>Oracle<a class="headerlink" href="#oracle" title="Link to this heading"></a></h3>
<p>Oracle 也不支持分页。它既不支持 OFFSET 也不支持 LIMIT关 键字。PY4WEB 通过将 <code class="docutils literal notranslate"><span class="pre">db(...).select(limitby=(a,</span> <span class="pre">b))</span></code> 转换为复杂的三层嵌套的 select（如 Oracle 官方文档所建议）来实现分页。这适用于简单的查询，但对于涉及别名字段和/或连接的复杂的查询可能会中断。</p>
</section>
<section id="google-nosql-datastore">
<h3>Google NoSQL (Datastore)<a class="headerlink" href="#google-nosql-datastore" title="Link to this heading"></a></h3>
<p>Google NoSQL (Datastore) 不允许连接、左连接、聚合、表达式或涉及多个表的 OR，“like” 运算符在 “text” 字段中搜索。</p>
<p>事务受到限制，py4web 不会自动提供（您需要使用 Google API <code class="docutils literal notranslate"><span class="pre">run_in_transaction</span></code> ，您可以在 Google App Engine 的在线文档中查找）。</p>
<p>谷歌还限制了您在每个查询中可以检索的记录数量（在撰写本文时为 1000 条）。在 Google 数据存储中，记录 ID 是整数，但它们不是连续的。在 SQL 中， “list:string” 类型被映射为 “text” 类型，而 在Google Datastore 中，它被映射为  <code class="docutils literal notranslate"><span class="pre">ListStringProperty</span></code>。类似地，“list:integer” 和 “list:reference” 被映射到 <code class="docutils literal notranslate"><span class="pre">ListProperty</span></code> 中。这使得在 Google NoSQL 上搜索这些字段类型中的内容比在 SQL 数据库上更高效。</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="chapter-06.html" class="btn btn-neutral float-left" title="夹具（Fixture）" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="chapter-08.html" class="btn btn-neutral float-right" title="RestAPI" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2020, BSDv3 License。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      
      
     <span class="fa fa-element">
     <input class="container_toggle" type="checkbox" id="switch" name="mode">
     <label for="switch"></label>
     </span>
      
      v: 20251209
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl>
        <dt>语言</dt>
        
           <strong> 
          <dd><a href="../en/index.html">en</a></dd> </strong>
          
        
          
          
          <dd><a href="../pt/index.html">pt</a></dd> 
        
          
          
          <dd><a href="../zh_CN/index.html">zh_CN</a></dd> 
        
      </dl>
      
      
      <dl>
        <dt>版本</dt>
        
          
          <dd><a href="index.html">current</a></dd>
          
        
      </dl>
      
      
      <dl>
        <dt>下载</dt>
        
          <dd><a href="py4web_en.pdf">pdf</a></dd>
        
          <dd><a href="py4web_en.epub">epub</a></dd>
        
      </dl>
      
      
      <hr/>
    </div>
  </div>

 <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
         .wy-nav-content { max-width: none; }
  </style>



</body>
</html>