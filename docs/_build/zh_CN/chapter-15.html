

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>从 web2py 迁移到 py4web &mdash; py4web 20251209 文档</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/css/toggle.css?v=029c1802" />

  
    <link rel="shortcut icon" href="_static/logo-32x32.ico"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=96e44453"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/translations.js?v=beaddf03"></script>
      <script src="_static/js/toggle.js?v=e1b5a5a1"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="高级主题和示例" href="chapter-16.html" />
    <link rel="prev" title="表格（Grid）" href="chapter-14.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            py4web
              <img src="_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">目录</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="chapter-01.html">py4web 是什么？</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-02.html">帮助、资源和提示</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-03.html">安装和启动</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-04.html">Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-05.html">创建一个应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-06.html">夹具（Fixture）</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-07.html">数据库抽象层（DAL）</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-08.html">RestAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-09.html">YATL 模板语言</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-10.html">YATL 中的助手（helpers）</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-11.html">国际化</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-12.html">表单（Forms）</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-13.html">身份验证与授权</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-14.html">表格（Grid）</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">从 web2py 迁移到 py4web</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#simple-conversion-examples">简单的转换示例</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#hello-world-example">“Hello world” 示例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#redirect-with-variables-example">“带变量重定向” 的示例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#returning-variables-example">“返回变量” 的示例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#returning-args-example">“返回参数” 的示例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#return-calling-methods-example">“返回调用方法” 的示例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-a-counter-example">“设置计数器” 的示例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#view-example">“视图” 的示例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#form-and-flash-example">“Form 和 flash” 的示例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#grid-example">“grid” 的示例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#accessing-os-files-example">“访问操作系统文件” 的示例</a></li>
<li class="toctree-l3"><a class="reference internal" href="#auth-example">“auth” 的示例</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="chapter-16.html">高级主题和示例</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">py4web</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">从 web2py 迁移到 py4web</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/web2py/py4web/blob/master/docs/chapter-15.rst" class="fa fa-github"> 在 GitHub 上编辑</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="from-web2py-to-py4web">
<h1>从 web2py 迁移到 py4web<a class="headerlink" href="#from-web2py-to-py4web" title="Link to this heading"></a></h1>
<p>本章旨在帮助用户将旧的 web2py 应用程序移植到 py4web。</p>
<p>Web2py 和 py4web 有很多相似之处，也有一些不同之处。例如，它们共享相同的数据库抽象层（pyDAL），这意味着两个框架之间的 pyDAL 的表定义和查询是相同的。它们还共享相同的模板语言，但有一点需要注意，web2py 默认为 <code class="docutils literal notranslate"><span class="pre">{{...}}</span></code> 分隔符，而 py4web 默认为 <code class="docutils literal notranslate"><span class="pre">[[...]]</span></code> 分隔符。它们还共享相同的验证器，pyDAL 的一部分，以及非常相似的 helpers 。py4web 是一个更轻/更快/极简主义的重新实现，但它们具有相同的目的，并支持非常相似的语法。py4web 也提供了一个 Form 对象（相当于 web2py 中的 SQLFORM）和一个 Grid 对象（相当于 web2py 的 SQLFORM.Grid ）。它们均提供一个可清理 HTML 内容的 <cite>XML</cite> 对象，以及一个用于生成 URL 的 URL helper。它们均能通过抛出 <cite>HTTP</cite> 异常来返回非 200 OK 状态码的页面。它们还均提供一个 <cite>Auth</cite> 对象，该对象可生成注册、登录、修改密码、找回密码及编辑个人资料的表单。此外，web2py 和 py4web 这两个框架都会跟踪并记录所有错误。</p>
<p>主要区别如下：</p>
<ul class="simple">
<li><p>web2py 同时适用于 Python 2.6+ 和 3.6+ ，而py4web 仅在 Python 3.7+ 上运行。因此，如果你的旧 web2py 应用程序仍在使用 Python 2，你的第一步是将其迁移到至少 Python 3.7 ，最好是最新的 3.9 。</p></li>
<li><p>web2py 应用程序由在每个 HTTP 请求时执行的文件集合组成（使用自定义导入程序，按预定顺序）。在 py4web 应用程序中，是由框架自动导入的常规 python 模块。顺便说一句，这使得使用标准 python 调试器成为可能（即使在最常用的 IDE 中）。</p></li>
<li><p>在 web2py 中，每个应用程序都有一个固定的文件夹结构。当且仅当它在  <code class="docutils literal notranslate"><span class="pre">controllers/*.py</span></code> 文件中定义时，函数才是一个 action 。py4web 的约束要小得多。在py4web 中，应用程序必须有一个入口点 <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> 和一个 <code class="docutils literal notranslate"><span class="pre">static</span></code> 文件夹。其他所有约定，如模板、上传文件、翻译文件、会话等的位置，都由用户指定的。</p></li>
<li><p>在 web2py 中，scaffolding 应用程序（创建新应用程序的蓝图）被称为 “welcome”。在 py4web 中，它被称为 “_scaffold ”。_scaffold 包含一个 “settings.py” 文件和一个 “common.py” 文件。后者提供了一个如何启用 Auth 并为特定应用程序配置所有选项的示例。_scaffold 还有一个 “model.py” 文件和一个 “controller.py” 文件，但与 web2py 不同，这些文件没有以任何特殊方式处理。它们的名称遵循一个约定（框架没有强制执行），并且与任何常规 python 模块一样，它们由 <cite>__init__.py</cite> 文件导入。</p></li>
<li><p>在 web2py 中， <code class="docutils literal notranslate"><span class="pre">controllers/*.py</span></code> 中的每个函数都是一个  action 。在 py4web 中，如果一个函数有 <code class="docutils literal notranslate"><span class="pre">&#64;action(&quot;...&quot;)</span></code> 装饰符，那么它就是一个动作。这意味着 <code class="docutils literal notranslate"><span class="pre">&#64;action(&quot;...&quot;)</span></code> 可以在任何地方定义。管理界面将帮助您定位特定 action 的定义位置。</p></li>
<li><p>在 web2py 中，URL 和文件/函数名之间的映射是自动的，但可以在 “routes.py” 中被覆盖（就像在 Django 中一样）。在 py4web 中，映射在装饰器 <cite>&#64;action('my_url_path')</cite> 中被指定（就像在 Bottle 和 Flask 中一样）。请注意，如果路径以 “/” 开头，则假定为绝对路径。如果不是，则假定它是相对的，并且前缀为 “/{appname}/” 。此外，如果路径以 “/index” 结尾，则后缀（“/index”）被视为可选。</p></li>
<li><p>在 web2py 中，路径扩展很重要，“<a class="reference external" href="http://*.html">http://*.html</a>“ 预计将返回 HTML，同时 “<a class="reference external" href="http://*.json">http://*.json</a>” 预计将返回 JSON 等。在 py4web 中没有这样的约定。如果 action 返回一个 dict() 并有一个模板，则 dict() 将由模板渲染后呈现，否则将以 JSON 呈现。使用装饰器可以实现更复杂的行为。</p></li>
<li><p>在 web2py 中，每个 action 都有许多包装器，例如，无论 action 是否真的需要，它们都可以处理会话、多元化、数据库连接等。这使得 web2py 的性能很难与其他框架进行比较。在 py4web 中，一切都是可选的，必须使用 <code class="docutils literal notranslate"><span class="pre">&#64;action.uses(...)</span></code> 装饰器为每个操作启用和配置功能。 <code class="docutils literal notranslate"><span class="pre">&#64;action.uses(...)</span></code> 的参数被称为 fixtures 装置，类似于房子里的夹具装置。它们通过为 action 提供预处理和后处理来添加功能。例如， <code class="docutils literal notranslate"><span class="pre">&#64;action.uses(session,</span> <span class="pre">T,</span> <span class="pre">db,</span> <span class="pre">flash)</span></code> 表示该 action 需要在重定向时使用会话、国际化/多元化（T）、数据库（db）和flash 消息的继续状态。</p></li>
<li><p>web2py 使用自己的 request/response 对象。py4web 使用底层Ombott库中的 request/response 对象。虽然这在未来可能会发生变化，但我们致力于保持它们与 web 服务器的接口、路由、部分请求和文件流（如果此后进行了修改）。</p></li>
<li><p>web2py 和 py4web 都使用相同的 pyDAL，因此表使用相同的语法定义，查询也是如此。在 web2py 中，当执行整个模型时，每个 HTTP 请求都会重新定义表。在 py4web 中，每个 HTTP 请求只执行 action 中的代码，而在 action 之外定义的代码只在启动时执行。这使得 py4web 更快，特别是在有很多表的情况下。这种方法的缺点是，开发人员应该小心，永远不要在 action 中或以任何依赖于请求对象内容的方式覆盖 pyDAL 变量，否则代码就不是线程安全的。唯一可以随意更改的变量是以下字段属性：readable 、 writable 、 requires 、 update 和 default 。出于实际目的，所有其他的都被认为是全局和非线程安全的。因此，在 py4web 中使用 <a class="reference internal" href="chapter-07.html#lazy-tables"><span class="std std-ref">懒惰表</span></a> 毫无用处，甚至很危险。</p></li>
<li><p>web2py 和 py4web 都有一个用于相同目的的 Auth 对象。这两个对象都能够以几乎相同的方式生成表单。py4web 的 Auth 被定义为更加模块化和可扩展，并同时支持 Forms 和 API，但它缺少 <cite>auth.requires_*</cite> 装饰器和组成员资格/权限。这并不意味着该功能不可用。事实上，py4web 甚至更强大，这就是语法不同的原因。虽然 web2py Auth 对象试图做所有事情，但相应的 py4web 对象只负责建立用户的身份，而不是用户可以做什么。后者可以通过向用户附加标签来实现。因此，通过用用户所属组的标签标记用户并根据用户标签检查权限来分配组成员资格。Py4web 提供了一种机制，可以有效地为任何对象（包括但不限于用户）分配和检查标签。</p></li>
<li><p>Web2py 附带了 Rocket 网络服务器。在撰写本文时，py4web 默认使用 <a class="reference external" href="https://github.com/web2py/rocket3">Rocket3</a> 服务器，这是 web2py 使用的同一个多线程 web 服务器，去掉了所有 Python2 的逻辑和依赖关系。请注意，这可能会在未来发生变化。</p></li>
</ul>
<section id="simple-conversion-examples">
<h2>简单的转换示例<a class="headerlink" href="#simple-conversion-examples" title="Link to this heading"></a></h2>
<section id="hello-world-example">
<h3>“Hello world” 示例<a class="headerlink" href="#hello-world-example" title="Link to this heading"></a></h3>
<p><strong>web2py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in controllers/default.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
   <span class="k">return</span> <span class="s2">&quot;hello world&quot;</span>
</pre></div>
</div>
<p>--&gt; <strong>py4web</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># file imported by __init__.py</span>
<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;hello world&quot;</span>
</pre></div>
</div>
</section>
<section id="redirect-with-variables-example">
<h3>“带变量重定向” 的示例<a class="headerlink" href="#redirect-with-variables-example" title="Link to this heading"></a></h3>
<p><strong>web2py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">get_vars</span><span class="o">.</span><span class="n">name</span>
<span class="n">request</span><span class="o">.</span><span class="n">post_vars</span><span class="o">.</span><span class="n">name</span>
<span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">name</span>
<span class="k">raise</span> <span class="n">HTTP</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
<span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">URL</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;f&#39;</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="nb">vars</span><span class="o">=</span><span class="p">{})</span>
</pre></div>
</div>
<p>--&gt; <strong>py4web</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
<span class="n">request</span><span class="o">.</span><span class="n">forms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
<span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
<span class="k">raise</span> <span class="n">HTTP</span><span class="p">(</span><span class="mi">301</span><span class="p">)</span>
<span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">URL</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">{})</span>
</pre></div>
</div>
</section>
<section id="returning-variables-example">
<h3>“返回变量” 的示例<a class="headerlink" href="#returning-variables-example" title="Link to this heading"></a></h3>
<p><strong>web2py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
   <span class="n">a</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_vars</span><span class="o">.</span><span class="n">a</span>
   <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
</pre></div>
</div>
<p>--&gt; <strong>py4web</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
   <span class="n">a</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
   <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="returning-args-example">
<h3>“返回参数” 的示例<a class="headerlink" href="#returning-args-example" title="Link to this heading"></a></h3>
<p><strong>web2py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
   <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span>
   <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
   <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
</pre></div>
</div>
<p>--&gt; <strong>py4web</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;index/&lt;a&gt;/&lt;b:int&gt;/&lt;c:int&gt;&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
   <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="return-calling-methods-example">
<h3>“返回调用方法” 的示例<a class="headerlink" href="#return-calling-methods-example" title="Link to this heading"></a></h3>
<p><strong>web2py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
   <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
      <span class="k">return</span> <span class="s2">&quot;GET&quot;</span>
   <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
      <span class="k">return</span> <span class="s2">&quot;POST&quot;</span>
   <span class="k">raise</span> <span class="n">HTTP</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
</pre></div>
</div>
<p>--&gt; <strong>py4web</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
   <span class="k">return</span> <span class="s2">&quot;GET&quot;</span>

<span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
   <span class="k">return</span> <span class="s2">&quot;POST&quot;</span>
</pre></div>
</div>
</section>
<section id="setting-up-a-counter-example">
<h3>“设置计数器” 的示例<a class="headerlink" href="#setting-up-a-counter-example" title="Link to this heading"></a></h3>
<p><strong>web2py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">counter</span><span class="p">():</span>
   <span class="n">session</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">counter</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
   <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">counter</span><span class="p">)</span>
</pre></div>
</div>
<p>--&gt; <strong>py4web</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">counter</span><span class="p">():</span>
   <span class="n">session</span><span class="p">[</span><span class="s1">&#39;counter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
   <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;counter&#39;</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="view-example">
<h3>“视图” 的示例<a class="headerlink" href="#view-example" title="Link to this heading"></a></h3>
<p><strong>web2py</strong></p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>{{ extend &#39;layout.html&#39; }}
<span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
{{ for k in range(1): }}
<span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>{{= k }}<span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>
{{ pass }}
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>--&gt; <strong>py4web</strong></p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>[[ extend &#39;layout.html&#39; ]]
<span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
[[ for k in range(1): ]]
<span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>[[= k ]]<span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>
[[ pass ]]
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
</section>
<section id="form-and-flash-example">
<h3>“Form 和 flash” 的示例<a class="headerlink" href="#form-and-flash-example" title="Link to this heading"></a></h3>
<p><strong>web2py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
   <span class="n">form</span> <span class="o">=</span> <span class="n">SQLFORM</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span>
   <span class="n">form</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
   <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
      <span class="n">flash</span> <span class="o">=</span> <span class="s1">&#39;Done!&#39;</span>
   <span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
   <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
</pre></div>
</div>
<p>--&gt; <strong>py4web</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>

<span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">flash</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
   <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">)</span>
   <span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
   <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
</pre></div>
</div>
<p>在模板中，您可以通过以下方式访问 flash 对象</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;flash&quot;</span><span class="p">&gt;</span>[[=globals().get(&#39;flash&#39;,&#39;&#39;)]]<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>或者使用更复杂的</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">flash-alerts</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;padded &quot;</span> <span class="na">data-alert</span><span class="o">=</span><span class="s">&quot;[[=globals().get( &#39;flash&#39;, &#39;&#39;)]]&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">flash-alerts</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>后者需要 scaffolding 应用程序中的 <code class="docutils literal notranslate"><span class="pre">utils.js</span></code> 将自定义标签呈现为带有关闭功能的 div。</p>
<p>还要注意， <code class="docutils literal notranslate"><span class="pre">Flash</span></code> 很特别：它是一个单例。因此，如果实例化多个 Flash 对象，它们会共享数据。</p>
</section>
<section id="grid-example">
<h3>“grid” 的示例<a class="headerlink" href="#grid-example" title="Link to this heading"></a></h3>
<p><strong>web2py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
   <span class="n">grid</span> <span class="o">=</span> <span class="n">SQLFORM</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
   <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
</pre></div>
</div>
<p>--&gt; <strong>py4web</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">flash</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
   <span class="n">grid</span> <span class="o">=</span> <span class="n">Grid</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span>
   <span class="n">form</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">editable</span> <span class="o">=</span> <span class="kc">True</span>
   <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="accessing-os-files-example">
<h3>“访问操作系统文件” 的示例<a class="headerlink" href="#accessing-os-files-example" title="Link to this heading"></a></h3>
<p><strong>web2py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;file.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>--&gt; <strong>py4web</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">APP_FOLDER</span>
<span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">APP_FOLDER</span><span class="p">,</span> <span class="s1">&#39;file.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="auth-example">
<h3>“auth” 的示例<a class="headerlink" href="#auth-example" title="Link to this heading"></a></h3>
<p><strong>web2py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">auth</span> <span class="o">=</span> <span class="n">Auth</span><span class="p">()</span>
<span class="n">auth</span><span class="o">.</span><span class="n">define_tables</span><span class="p">()</span>

<span class="nd">@requires_login</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
   <span class="n">user_id</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
   <span class="n">user_email</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
   <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">user</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">auth</span><span class="p">())</span>
</pre></div>
</div>
<p>通过 <code class="docutils literal notranslate"><span class="pre">http://.../user/login</span></code> 访问。</p>
<p>--&gt; <strong>py4web</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">auth</span> <span class="o">=</span> <span class="n">Auth</span><span class="p">(</span><span class="n">define_table</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">auth</span><span class="o">.</span><span class="n">define_tables</span><span class="p">()</span>
<span class="n">auth</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">route</span><span class="o">=</span><span class="s1">&#39;auth&#39;</span><span class="p">)</span>

<span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
   <span class="n">user_id</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">user_id</span>
   <span class="n">user_email</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
   <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
</pre></div>
</div>
<p>通过 <code class="docutils literal notranslate"><span class="pre">http://.../auth/login</span></code> 进行访问。请注意，在 web2py 中， <code class="docutils literal notranslate"><span class="pre">auth.user</span></code> 是从会话中检索到的当前登录用户。在 py4web 中， <code class="docutils literal notranslate"><span class="pre">auth.user</span></code> 是一个夹具，其作用与 web2py 中的 <code class="docutils literal notranslate"><span class="pre">&#64;requires_login</span></code> 相同。在 py4web 中，只有 <code class="docutils literal notranslate"><span class="pre">user_id</span></code> 存储在会话中，可以使用 <code class="docutils literal notranslate"><span class="pre">auth.user_id</span></code> 检索。如果你需要更多关于用户的信息，你需要使用 <code class="docutils literal notranslate"><span class="pre">auth.get_user()</span></code> 从数据库中获取记录，它将所有可读字段作为 Python 字典返回。</p>
<p>请注意，以下两者之间存在显著差异：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
</pre></div>
</div>
<p>和</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>
<p>在第一种情况下，被修饰的 action 可以访问 auth 对象，但如果用户未登录，<code class="docutils literal notranslate"><span class="pre">auth.user_id</span></code>  可能为 None。在第二种情况下我们需要一个有效的登录用户，因此能保证 <code class="docutils literal notranslate"><span class="pre">auth.user_id</span></code> 是一个有效用户 id。</p>
<p>还要注意，如果一个操作（action）使用 auth，那么它会自动使用其 session 和 flash 对象。</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="chapter-14.html" class="btn btn-neutral float-left" title="表格（Grid）" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="chapter-16.html" class="btn btn-neutral float-right" title="高级主题和示例" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2020, BSDv3 License。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      
      
     <span class="fa fa-element">
     <input class="container_toggle" type="checkbox" id="switch" name="mode">
     <label for="switch"></label>
     </span>
      
      v: 20251209
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl>
        <dt>语言</dt>
        
           <strong> 
          <dd><a href="../en/index.html">en</a></dd> </strong>
          
        
          
          
          <dd><a href="../pt/index.html">pt</a></dd> 
        
          
          
          <dd><a href="../zh_CN/index.html">zh_CN</a></dd> 
        
      </dl>
      
      
      <dl>
        <dt>版本</dt>
        
          
          <dd><a href="index.html">current</a></dd>
          
        
      </dl>
      
      
      <dl>
        <dt>下载</dt>
        
          <dd><a href="py4web_en.pdf">pdf</a></dd>
        
          <dd><a href="py4web_en.epub">epub</a></dd>
        
      </dl>
      
      
      <hr/>
    </div>
  </div>

 <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
         .wy-nav-content { max-width: none; }
  </style>



</body>
</html>