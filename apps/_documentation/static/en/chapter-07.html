<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Database Abstraction Layer (DAL) &mdash; py4web 1.20220222.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/toggle.css" type="text/css" />
    <link rel="shortcut icon" href="_static/logo-32x32.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/js/toggle.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="The RestAPI" href="chapter-08.html" />
    <link rel="prev" title="Fixtures" href="chapter-06.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> py4web
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.20220222.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="chapter-01.html">What is py4web?</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-02.html">Help, resources and hints</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-03.html">Installation and Startup</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-04.html">The Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-05.html">Creating your first app</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-06.html">Fixtures</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">The Database Abstraction Layer (DAL)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#dal-introduction">DAL introduction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#py4web-model">py4web model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#supported-databases">Supported databases</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-dal-a-quick-tour">The DAL: a quick tour</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-dal-stand-alone">Using the DAL “stand-alone”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#experiment-with-the-py4web-shell">Experiment with the py4web shell</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#dal-constructor">DAL constructor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#dal-signature">DAL signature</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connection-strings-the-uri-parameter">Connection strings (the uri parameter)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connection-pooling">Connection pooling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connection-failures-attempts-parameter">Connection failures (attempts parameter)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lazy-tables">Lazy Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#model-less-applications">Model-less applications</a></li>
<li class="toctree-l3"><a class="reference internal" href="#replicated-databases">Replicated databases</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reserved-keywords">Reserved keywords</a></li>
<li class="toctree-l3"><a class="reference internal" href="#database-quoting-and-case-settings">Database quoting and case settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="#making-a-secure-connection">Making a secure connection</a></li>
<li class="toctree-l3"><a class="reference internal" href="#other-dal-constructor-parameters">Other DAL constructor parameters</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#database-folder-location">Database folder location</a></li>
<li class="toctree-l4"><a class="reference internal" href="#default-migration-settings">Default migration settings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#commit-and-rollback"><code class="docutils literal notranslate"><span class="pre">commit</span></code> and <code class="docutils literal notranslate"><span class="pre">rollback</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#table-constructor">Table constructor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#define-table-signature">define_table signature</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id-notes-about-the-primary-key"><code class="docutils literal notranslate"><span class="pre">id</span></code>: Notes about the primary key</a></li>
<li class="toctree-l3"><a class="reference internal" href="#plural-and-singular"><code class="docutils literal notranslate"><span class="pre">plural</span></code> and <code class="docutils literal notranslate"><span class="pre">singular</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#redefine"><code class="docutils literal notranslate"><span class="pre">redefine</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#format-record-representation"><code class="docutils literal notranslate"><span class="pre">format</span></code>: Record representation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rname-real-name"><code class="docutils literal notranslate"><span class="pre">rname</span></code>: Real name</a></li>
<li class="toctree-l3"><a class="reference internal" href="#primarykey-support-for-legacy-tables"><code class="docutils literal notranslate"><span class="pre">primarykey</span></code>: Support for legacy tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#migrate-fake-migrate"><code class="docutils literal notranslate"><span class="pre">migrate</span></code>, <code class="docutils literal notranslate"><span class="pre">fake_migrate</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#table-class"><code class="docutils literal notranslate"><span class="pre">table_class</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#sequence-name"><code class="docutils literal notranslate"><span class="pre">sequence_name</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#trigger-name"><code class="docutils literal notranslate"><span class="pre">trigger_name</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#polymodel"><code class="docutils literal notranslate"><span class="pre">polymodel</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#on-define"><code class="docutils literal notranslate"><span class="pre">on_define</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-attributes-to-fields-and-tables">Adding attributes to fields and tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#legacy-databases-and-keyed-tables">Legacy databases and keyed tables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#field-constructor">Field constructor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#field-types-and-validators">Field types and validators</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-time-field-and-table-modification">Run-time field and table modification</a></li>
<li class="toctree-l3"><a class="reference internal" href="#more-on-uploads">More on uploads</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#migrations">Migrations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#fixing-broken-migrations">Fixing broken migrations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#migration-control-summary">Migration control summary</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#table-methods">Table methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#insert"><code class="docutils literal notranslate"><span class="pre">insert</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#query-set-rows"><code class="docutils literal notranslate"><span class="pre">Query</span></code>, <code class="docutils literal notranslate"><span class="pre">Set</span></code>, <code class="docutils literal notranslate"><span class="pre">Rows</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#update-or-insert"><code class="docutils literal notranslate"><span class="pre">update_or_insert</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#validate-and-insert-validate-and-update"><code class="docutils literal notranslate"><span class="pre">validate_and_insert</span></code>, <code class="docutils literal notranslate"><span class="pre">validate_and_update</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#drop"><code class="docutils literal notranslate"><span class="pre">drop</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#tagging-records">Tagging records</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#raw-sql">Raw SQL</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#executesql"><code class="docutils literal notranslate"><span class="pre">executesql</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#lastsql"><code class="docutils literal notranslate"><span class="pre">_lastsql</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#timing-queries">Timing queries</a></li>
<li class="toctree-l3"><a class="reference internal" href="#indexes">Indexes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generating-raw-sql">Generating raw SQL</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#select-command"><code class="docutils literal notranslate"><span class="pre">select</span></code> command</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-an-iterator-based-select-for-lower-memory-use">Using an iterator-based select for lower memory use</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rendering-rows-using-represent">Rendering rows using represent</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shortcuts">Shortcuts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fetching-a-row">Fetching a <code class="docutils literal notranslate"><span class="pre">Row</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#recursive-selects">Recursive <code class="docutils literal notranslate"><span class="pre">select</span></code>s</a></li>
<li class="toctree-l3"><a class="reference internal" href="#orderby-groupby-limitby-distinct-having-orderby-on-limitby-join-left-cache"><code class="docutils literal notranslate"><span class="pre">orderby</span></code>, <code class="docutils literal notranslate"><span class="pre">groupby</span></code>, <code class="docutils literal notranslate"><span class="pre">limitby</span></code>, <code class="docutils literal notranslate"><span class="pre">distinct</span></code>, <code class="docutils literal notranslate"><span class="pre">having</span></code>, <code class="docutils literal notranslate"><span class="pre">orderby_on_limitby</span></code>, <code class="docutils literal notranslate"><span class="pre">join</span></code>, <code class="docutils literal notranslate"><span class="pre">left</span></code>, <code class="docutils literal notranslate"><span class="pre">cache</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#orderby">orderby</a></li>
<li class="toctree-l4"><a class="reference internal" href="#groupby-having">groupby, having</a></li>
<li class="toctree-l4"><a class="reference internal" href="#distinct">distinct</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limitby">limitby</a></li>
<li class="toctree-l4"><a class="reference internal" href="#orderby-on-limitby">orderby_on_limitby</a></li>
<li class="toctree-l4"><a class="reference internal" href="#join-left">join, left</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cache-cacheable">cache, cacheable</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#logical-operators">Logical operators</a></li>
<li class="toctree-l3"><a class="reference internal" href="#count-isempty-delete-update"><code class="docutils literal notranslate"><span class="pre">count</span></code>, <code class="docutils literal notranslate"><span class="pre">isempty</span></code>, <code class="docutils literal notranslate"><span class="pre">delete</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#expressions">Expressions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#case"><code class="docutils literal notranslate"><span class="pre">case</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#update-record"><code class="docutils literal notranslate"><span class="pre">update_record</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#inserting-and-updating-from-a-dictionary">Inserting and updating from a dictionary</a></li>
<li class="toctree-l3"><a class="reference internal" href="#first-and-last"><code class="docutils literal notranslate"><span class="pre">first</span></code> and <code class="docutils literal notranslate"><span class="pre">last</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#as-dict-and-as-list"><code class="docutils literal notranslate"><span class="pre">as_dict</span></code> and <code class="docutils literal notranslate"><span class="pre">as_list</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#combining-rows">Combining rows</a></li>
<li class="toctree-l3"><a class="reference internal" href="#find-exclude-sort"><code class="docutils literal notranslate"><span class="pre">find</span></code>, <code class="docutils literal notranslate"><span class="pre">exclude</span></code>, <code class="docutils literal notranslate"><span class="pre">sort</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#caching-selects">Caching selects</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#computed-and-virtual-fields">Computed and Virtual fields</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#computed-fields">Computed fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="#virtual-fields">Virtual fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="#new-style-virtual-fields-experimental">New style virtual fields (experimental)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#old-style-virtual-fields">Old style virtual fields</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#joins-and-relations">Joins and Relations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#one-to-many-relation">One to many relation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inner-join">Inner join</a></li>
<li class="toctree-l3"><a class="reference internal" href="#left-outer-join">Left outer join</a></li>
<li class="toctree-l3"><a class="reference internal" href="#grouping-and-counting">Grouping and counting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#many-to-many-relation">Many to many relation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#self-reference-and-aliases">Self-Reference and aliases</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#other-operators">Other operators</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#like-ilike-regexp-startswith-endswith-contains-upper-lower"><code class="docutils literal notranslate"><span class="pre">like</span></code>, <code class="docutils literal notranslate"><span class="pre">ilike</span></code>, <code class="docutils literal notranslate"><span class="pre">regexp</span></code>, <code class="docutils literal notranslate"><span class="pre">startswith</span></code>, <code class="docutils literal notranslate"><span class="pre">endswith</span></code>, <code class="docutils literal notranslate"><span class="pre">contains</span></code>, <code class="docutils literal notranslate"><span class="pre">upper</span></code>, <code class="docutils literal notranslate"><span class="pre">lower</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#year-month-day-hour-minutes-seconds"><code class="docutils literal notranslate"><span class="pre">year</span></code>, <code class="docutils literal notranslate"><span class="pre">month</span></code>, <code class="docutils literal notranslate"><span class="pre">day</span></code>, <code class="docutils literal notranslate"><span class="pre">hour</span></code>, <code class="docutils literal notranslate"><span class="pre">minutes</span></code>, <code class="docutils literal notranslate"><span class="pre">seconds</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#belongs"><code class="docutils literal notranslate"><span class="pre">belongs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#sum-avg-min-max-and-len"><code class="docutils literal notranslate"><span class="pre">sum</span></code>, <code class="docutils literal notranslate"><span class="pre">avg</span></code>, <code class="docutils literal notranslate"><span class="pre">min</span></code>, <code class="docutils literal notranslate"><span class="pre">max</span></code> and <code class="docutils literal notranslate"><span class="pre">len</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#substrings">Substrings</a></li>
<li class="toctree-l3"><a class="reference internal" href="#default-values-with-coalesce-and-coalesce-zero">Default values with <code class="docutils literal notranslate"><span class="pre">coalesce</span></code> and <code class="docutils literal notranslate"><span class="pre">coalesce_zero</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#exporting-and-importing-data">Exporting and importing data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#csv-one-table-at-a-time">CSV (one Table at a time)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#csv-all-tables-at-once">CSV (all tables at once)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#csv-and-remote-database-synchronization">CSV and remote database synchronization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#html-and-xml-one-table-at-a-time">HTML and XML (one Table at a time)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-representation">Data representation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#advanced-features">Advanced features</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#list-type-and-contains"><code class="docutils literal notranslate"><span class="pre">list:&lt;type&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">contains</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#table-inheritance">Table inheritance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#filter-in-and-filter-out"><code class="docutils literal notranslate"><span class="pre">filter_in</span></code> and <code class="docutils literal notranslate"><span class="pre">filter_out</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#callbacks-on-record-insert-delete-and-update">callbacks on record insert, delete and update</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#database-cascades">Database cascades</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#record-versioning">Record versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="#common-filters">Common filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-field-types">Custom <code class="docutils literal notranslate"><span class="pre">Field</span></code> types</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-dal-without-define-tables">Using DAL without define tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#distributed-transaction">Distributed transaction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#copy-data-from-one-db-into-another">Copy data from one db into another</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#gotchas">Gotchas</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#note-on-new-dal-and-adapters">Note on new DAL and adapters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sqlite">SQLite</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mysql">MySQL</a></li>
<li class="toctree-l3"><a class="reference internal" href="#google-sql">Google SQL</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mssql-microsoft-sql-server">MSSQL (Microsoft SQL Server)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#oracle">Oracle</a></li>
<li class="toctree-l3"><a class="reference internal" href="#google-nosql-datastore">Google NoSQL (Datastore)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="chapter-08.html">The RestAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-09.html">YATL Template Language</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-10.html">YATL helpers</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-11.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-12.html">Forms</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-13.html">Authentication and authorization</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-14.html">Grid</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-15.html">From web2py to py4web</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-16.html">Advanced topics and examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">py4web</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>The Database Abstraction Layer (DAL)</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/web2py/py4web/blob/master/docs/chapter-07.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="the-database-abstraction-layer-dal">
<h1>The Database Abstraction Layer (DAL)<a class="headerlink" href="#the-database-abstraction-layer-dal" title="Permalink to this headline"></a></h1>
<section id="dal-introduction">
<h2>DAL introduction<a class="headerlink" href="#dal-introduction" title="Permalink to this headline"></a></h2>
<p>py4web rely on a database abstraction layer (DAL), an API that maps
Python objects into database objects such as queries, tables, and
records. The DAL dynamically generates the SQL in real time using the
specified dialect for the database back end, so that you do not have to
write SQL code or learn different SQL dialects (the term SQL is used
generically), and the application will be portable among different types
of databases.
The DAL choosen is a pure Python one called <a class="reference external" href="https://github.com/web2py/pydal">pyDAL</a>.
It was conceived in the web2py project but it’s a standard python module:
you can use it in any Python context.</p>
<p>A little taste of pyDAL features:</p>
<ul class="simple">
<li><p>Transactions</p></li>
<li><p>Aggregates</p></li>
<li><p>Inner &amp; Outer Joins</p></li>
<li><p>Nested Selects</p></li>
</ul>
<section id="py4web-model">
<h3>py4web model<a class="headerlink" href="#py4web-model" title="Permalink to this headline"></a></h3>
<p>Even if web2py and py4web use the same pyDAL, there are important differences (see
<a class="reference internal" href="chapter-15.html#from-web2py-to-py4web"><span class="std std-ref">From web2py to py4web</span></a> for details). The main caveat is that in py4web only
the action is executed for every HTTP request, while the code defined outside of
actions is only executed at startup. That makes py4web much faster, in particular
when there are many tables. The downside of this approach is that the developer
should be careful to never override pyDAL variables inside action or in any way
that depends on the content of the request object, else the code is not thread safe.
The only variables that can be changed at will are the following field attributes:
readable, writable, requires, update, and default.
All the others are for practical purposes to be considered global and non thread safe.</p>
</section>
<section id="supported-databases">
<h3>Supported databases<a class="headerlink" href="#supported-databases" title="Permalink to this headline"></a></h3>
<p>A partial list of supported databases is show in the table
below. Please check on the py4web/pyDAL web site and mailing list for more
recent adapters.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In any modern python distribution <strong>SQLite</strong> is actually built-in as a Python library.
The SQLite driver (sqlite3) is also included: you don’t need to install it.
Hence this is the most popular database for testing and development.</p>
</div>
<p>The Windows and the Mac binary distribution work out of the box with SQLite only.
To use any other database back end, run a full py4web
distribution and install the appropriate driver for the required back
end. Once the proper driver is installed, start py4web and it
will automatically find the driver.</p>
<p>Here is a list of the drivers py4web can use:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 81%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Database</p></th>
<th class="head"><p>Drivers (source)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>SQLite</p></td>
<td><p>sqlite3 or pysqlite2 or zxJDBC (on Jython)</p></td>
</tr>
<tr class="row-odd"><td><p>PostgreSQL</p></td>
<td><p>psycopg2 or zxJDBC (on Jython)</p></td>
</tr>
<tr class="row-even"><td><p>MySQL</p></td>
<td><p>pymysql or MySQLdb</p></td>
</tr>
<tr class="row-odd"><td><p>Oracle</p></td>
<td><p>cx_Oracle</p></td>
</tr>
<tr class="row-even"><td><p>MSSQL</p></td>
<td><p>pyodbc or pypyodbc</p></td>
</tr>
<tr class="row-odd"><td><p>FireBird</p></td>
<td><p>kinterbasdb or fdb or pyodbc</p></td>
</tr>
<tr class="row-even"><td><p>DB2</p></td>
<td><p>pyodbc</p></td>
</tr>
<tr class="row-odd"><td><p>Informix</p></td>
<td><p>informixdb</p></td>
</tr>
<tr class="row-even"><td><p>Ingres</p></td>
<td><p>ingresdbi</p></td>
</tr>
<tr class="row-odd"><td><p>Cubrid</p></td>
<td><p>cubriddb</p></td>
</tr>
<tr class="row-even"><td><p>Sybase</p></td>
<td><p>Sybase</p></td>
</tr>
<tr class="row-odd"><td><p>Teradata</p></td>
<td><p>pyodbc</p></td>
</tr>
<tr class="row-even"><td><p>SAPDB</p></td>
<td><p>sapdb</p></td>
</tr>
<tr class="row-odd"><td><p>MongoDB</p></td>
<td><p>pymongo</p></td>
</tr>
<tr class="row-even"><td><p>IMAP</p></td>
<td><p>imaplib</p></td>
</tr>
</tbody>
</table>
<p>Support of MongoDB is experimental. Google NoSQL is treated as a particular case.
The <a class="reference internal" href="#gotchas">Gotchas</a> section at the end of this chapter has some more information
about specific databases.</p>
</section>
<section id="the-dal-a-quick-tour">
<h3>The DAL: a quick tour<a class="headerlink" href="#the-dal-a-quick-tour" title="Permalink to this headline"></a></h3>
<p>py4web defines the following classes that make up the DAL:</p>
<dl>
<dt>DAL</dt><dd><p>represents a database connection. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt>Table</dt><dd><p>represents a database table. You do not directly instantiate
Table; instead, <code class="docutils literal notranslate"><span class="pre">DAL.define_table</span></code> does.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;mytable&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;myfield&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>The most important methods of a Table are:</p>
<p><code class="docutils literal notranslate"><span class="pre">insert</span></code>, <code class="docutils literal notranslate"><span class="pre">truncate</span></code>, <code class="docutils literal notranslate"><span class="pre">drop</span></code>, and <code class="docutils literal notranslate"><span class="pre">import_from_csv_file</span></code>.</p>
</dd>
<dt>Field</dt><dd><p>represents a database field. It can be instantiated and passed
as an argument to <code class="docutils literal notranslate"><span class="pre">DAL.define_table</span></code>.</p>
</dd>
<dt>Rows</dt><dd><p>is the object returned by a database select. It can be
thought of as a list of <code class="docutils literal notranslate"><span class="pre">Row</span></code> rows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div>
</div>
</dd>
<dt>Row</dt><dd><p>contains field values.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
    <span class="nb">print</span> <span class="n">row</span><span class="o">.</span><span class="n">myfield</span>
</pre></div>
</div>
</dd>
<dt>Query</dt><dd><p>is an object that represents a SQL “where” clause:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span> <span class="o">&gt;</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt>Set</dt><dd><p>is an object that represents a set of records. Its most
important methods are <code class="docutils literal notranslate"><span class="pre">count</span></code>, <code class="docutils literal notranslate"><span class="pre">select</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>, and <code class="docutils literal notranslate"><span class="pre">delete</span></code>.
For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myset</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">myquery</span><span class="p">)</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">myset</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">myset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
<span class="n">myset</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
</dd>
<dt>Expression</dt><dd><p>is something like an <code class="docutils literal notranslate"><span class="pre">orderby</span></code> or <code class="docutils literal notranslate"><span class="pre">groupby</span></code>
expression. The Field class is derived from the Expression. Here is an
example.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myorder</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">|</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">id</span>
<span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="n">myorder</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="using-the-dal-stand-alone">
<h3>Using the DAL “stand-alone”<a class="headerlink" href="#using-the-dal-stand-alone" title="Permalink to this headline"></a></h3>
<p>pyDAL is an independent python package. As such, it can be used
without the web2py/py4web environment; you just need to install
it with <code class="docutils literal notranslate"><span class="pre">pip</span></code>. Then import the pydal module when needed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pydal</span> <span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Even if you can import modules directly from pydal, this is not
advisable from within py4web applications. Remember that <code class="docutils literal notranslate"><span class="pre">py4web.DAL</span></code>
is a fixture, <code class="docutils literal notranslate"><span class="pre">pydal.DAL</span></code> is not. In this context, the last command
should better be:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
</pre></div>
</div>
</div>
</section>
<section id="experiment-with-the-py4web-shell">
<h3>Experiment with the py4web shell<a class="headerlink" href="#experiment-with-the-py4web-shell" title="Permalink to this headline"></a></h3>
<p>You can also experiment with the pyDAL API using the py4web shell,
that is available using the <a class="reference internal" href="chapter-03.html#shell-command-option"><span class="std std-ref">shell command option</span></a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Mind that
database changes may be persistent. So be careful and do NOT hesitate
to create a new application for doing testing instead of tampering
with an existing one.</p>
</div>
<p>Note that most of the code snippets that contain the python prompt
<code class="docutils literal notranslate"><span class="pre">&gt;&gt;&gt;</span></code> are also directly executable via a py4web shell.</p>
<p>This is a simple example, using the provided <code class="docutils literal notranslate"><span class="pre">examples</span></code> app:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">apps.examples</span> <span class="kn">import</span> <span class="n">db</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">tables</span><span class="p">()</span>
<span class="go">[&#39;auth_user&#39;, &#39;auth_user_tag_groups&#39;, &#39;person&#39;, &#39;superhero&#39;, &#39;superpower&#39;, &#39;tag&#39;, &#39;product&#39;, &#39;thing&#39;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">superhero</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="go">&lt;Row {&#39;id&#39;: 1, &#39;tag&#39;: &lt;Set (&quot;tag&quot;.&quot;superhero&quot; = 1)&gt;, &#39;name&#39;: &#39;Superman&#39;, &#39;real_identity&#39;: 1}&gt;</span>
</pre></div>
</div>
<p>You can also start by creating a connection from zero. For the sake of simplicity, you
can use SQLite. Nothing in this discussion changes when you switch the back-end
engine.</p>
</section>
</section>
<section id="dal-constructor">
<h2>DAL constructor<a class="headerlink" href="#dal-constructor" title="Permalink to this headline"></a></h2>
<p>Basic use:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The database is now connected and the connection is stored in the global
variable <code class="docutils literal notranslate"><span class="pre">db</span></code>.</p>
<p>At any time you can retrieve the connection string.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">_uri</span>
<span class="go">sqlite://storage.sqlite</span>
</pre></div>
</div>
<p>and the database name</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">_dbname</span>
<span class="go">sqlite</span>
</pre></div>
</div>
<p>The connection string is called <code class="docutils literal notranslate"><span class="pre">_uri</span></code> because it is an instance of
a uniform resource identifier.</p>
<p>The DAL allows multiple connections with the same database or with
different databases, even databases of different types. For now, we will
assume the presence of a single database since this is the most common
situation.</p>
<section id="dal-signature">
<h3>DAL signature<a class="headerlink" href="#dal-signature" title="Permalink to this headline"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DAL</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="s1">&#39;sqlite://dummy.db&#39;</span><span class="p">,</span>
    <span class="n">pool_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">db_codec</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span>
    <span class="n">check_reserved</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">migrate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">fake_migrate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">migrate_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">fake_migrate_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">decode_credentials</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">driver_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">adapter_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">attempts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">auto_import</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">bigint_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">lazy_tables</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">db_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">do_connect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">after_connection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ignore_field_case</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">entity_quoting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">table_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="connection-strings-the-uri-parameter">
<h3>Connection strings (the uri parameter)<a class="headerlink" href="#connection-strings-the-uri-parameter" title="Permalink to this headline"></a></h3>
<p>A connection with the database is established by creating an instance of
the DAL object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">db</span></code> is not a keyword; it is a local variable that stores the
connection object <code class="docutils literal notranslate"><span class="pre">DAL</span></code>. You are free to give it a different name. The
constructor of <code class="docutils literal notranslate"><span class="pre">DAL</span></code> requires a single argument, the connection
string. The connection string is the only py4web code that depends on a
specific back-end database. Here are examples of connection strings for
specific types of supported back-end databases (in all cases, we assume
the database is running from localhost on its default port and is named
“test”):</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 27%" />
<col style="width: 73%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Database</p></th>
<th class="head"><p>Connection string</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>SQLite</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">sqlite://storage.sqlite</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>MySQL</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mysql://username:password&#64;localhost/test?set_encoding</span>
<span class="pre">=utf8mb4</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>PostgreSQL</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">postgres://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>MSSQL (legacy)</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mssql://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>MSSQL (&gt;=2005)</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mssql3://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>MSSQL (&gt;=2012)</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mssql4://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>FireBird</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">firebird://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Oracle</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">oracle://username/password&#64;test</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>DB2</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">db2://username:password&#64;test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Ingres</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ingres://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>Sybase</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">sybase://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Informix</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">informix://username:password&#64;test</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>Teradata</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">teradata://DSN=dsn;UID=user;PWD=pass;DATABASE=test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Cubrid</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">cubrid://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>SAPDB</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">sapdb://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>IMAP</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">imap://user:password&#64;server:port</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>MongoDB</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mongodb://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Google/SQL</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">google:sql://project:instance/database</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>Google/NoSQL</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">google:datastore</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Google/NoSQL/NDB</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">google:datastore+ndb</span></code></p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>in SQLite the database consists of a single file. If it does
not exist, it is created. This file is locked every time it is accessed.</p></li>
<li><p>in the case of MySQL, PostgreSQL, MSSQL, FireBird, Oracle, DB2, Ingres
and Informix the database “test” must be created outside py4web. Once
the connection is established, py4web will create, alter, and drop
tables appropriately.</p></li>
<li><p>in the MySQL connection string, the <code class="docutils literal notranslate"><span class="pre">?set_encoding=utf8mb4</span></code> at the end
sets the encoding to UTF-8 and avoids an
<code class="docutils literal notranslate"><span class="pre">Invalid</span> <span class="pre">utf8</span> <span class="pre">character</span> <span class="pre">string:</span></code> error on Unicode characters that
consist of four bytes, as by default, MySQL can only handle Unicode
characters that consist of one to three bytes.</p></li>
<li><p>in the Google/NoSQL case the <code class="docutils literal notranslate"><span class="pre">+ndb</span></code> option turns on NDB. NDB uses a
Memcache buffer to read data that is accessed often. This is completely
automatic and done at the datastore level, not at the py4web level.</p></li>
<li><p>it is also possible to set the connection string to <code class="docutils literal notranslate"><span class="pre">None</span></code>. In this
case DAL will not connect to any back-end database, but the API can
still be accessed for testing.</p></li>
</ul>
<p>Some times you may also need to generate SQL as if you had a connection but
without actually connecting to the database. This can be done with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">,</span> <span class="n">do_connect</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case you will be able to call <code class="docutils literal notranslate"><span class="pre">_select</span></code>, <code class="docutils literal notranslate"><span class="pre">_insert</span></code>,
<code class="docutils literal notranslate"><span class="pre">_update</span></code>, and <code class="docutils literal notranslate"><span class="pre">_delete</span></code> to generate SQL but not call <code class="docutils literal notranslate"><span class="pre">select</span></code>,
<code class="docutils literal notranslate"><span class="pre">insert</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>, and <code class="docutils literal notranslate"><span class="pre">delete</span></code>; see <a class="reference internal" href="#generating-raw-sql">Generating raw SQL</a>
for details. In most of the cases you can use
<code class="docutils literal notranslate"><span class="pre">do_connect=False</span></code> even without having the required database drivers.</p>
<p>Notice that by default py4web uses utf8 character encoding for
databases. If you work with existing databases that behave differently,
you have to change it with the optional parameter <code class="docutils literal notranslate"><span class="pre">db_codec</span></code> like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">,</span> <span class="n">db_codec</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Otherwise you’ll get UnicodeDecodeError tickets.</p>
</section>
<section id="connection-pooling">
<h3>Connection pooling<a class="headerlink" href="#connection-pooling" title="Permalink to this headline"></a></h3>
<p>A common argument of the DAL constructor is the <code class="docutils literal notranslate"><span class="pre">pool_size</span></code>; it
defaults to zero.</p>
<p>As it is rather slow to establish a new database connection for each
request, py4web implements a mechanism for connection pooling. Once a
connection is established and the page has been served and the
transaction completed, the connection is not closed but goes into a
pool. When the next request arrives, py4web tries to recycle a
connection from the pool and use that for the new transaction. If there
are no available connections in the pool, a new connection is
established.</p>
<p>When py4web starts, the pool is always empty. The pool grows up to the
minimum between the value of <code class="docutils literal notranslate"><span class="pre">pool_size</span></code> and the max number of
concurrent requests. This means that if <code class="docutils literal notranslate"><span class="pre">pool_size=10</span></code> but our server
never receives more than 5 concurrent requests, then the actual pool
size will only grow to 5. If <code class="docutils literal notranslate"><span class="pre">pool_size=0</span></code> then connection pooling is
not used.</p>
<p>Connections in the pools are shared sequentially among threads, in the
sense that they may be used by two different but not simultaneous
threads. There is only one pool for each py4web process.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">pool_size</span></code> parameter is ignored by SQLite and Google App Engine.
Connection pooling is ignored for SQLite, since it would not yield any
benefit.</p>
</section>
<section id="connection-failures-attempts-parameter">
<h3>Connection failures (attempts parameter)<a class="headerlink" href="#connection-failures-attempts-parameter" title="Permalink to this headline"></a></h3>
<p>If py4web fails to connect to the database it waits 1 second and by
default tries again up to 5 times before declaring a failure. In case of
connection pooling it is possible that a pooled connection that stays
open but unused for some time is closed by the database end. Thanks to
the retry feature py4web tries to re-establish these dropped
connections. The number of attempts is set via the attempts parameter.</p>
</section>
<section id="lazy-tables">
<h3>Lazy Tables<a class="headerlink" href="#lazy-tables" title="Permalink to this headline"></a></h3>
<p>Setting <code class="docutils literal notranslate"><span class="pre">lazy_tables</span> <span class="pre">=</span> <span class="pre">True</span></code> provides a major performance boost (but
not with py4web). It means that table creation is deferred until the
table is actually referenced.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You should never use lazy tables in py4web. There is no advantage,
no need, and possibly concurrency problems.</p>
</div>
</section>
<section id="model-less-applications">
<h3>Model-less applications<a class="headerlink" href="#model-less-applications" title="Permalink to this headline"></a></h3>
<p>In py4web the code defined outside of actions (where normally DAL tables
are defined) is only executed at startup.</p>
<p>However, it is possible to define DAL tables on demand inside actions.
This is referred to as “model-less” development by the py4web community.</p>
<p>To use the “model-less” approach, you take responsibility for doing
all the housekeeping tasks. You call the table definitions when you
need them, and provide database connection passed as parameter.
Also, remember maintainability: other py4web developers expect to find
database definitions in the <code class="docutils literal notranslate"><span class="pre">models.py</span></code> file.</p>
</section>
<section id="replicated-databases">
<h3>Replicated databases<a class="headerlink" href="#replicated-databases" title="Permalink to this headline"></a></h3>
<p>The first argument of <code class="docutils literal notranslate"><span class="pre">DAL(...)</span></code> can be a list of URIs. In this case
py4web tries to connect to each of them. The main purpose for this is to
deal with multiple database servers and distribute the workload among
them. Here is a typical use case:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">([</span><span class="s1">&#39;mysql://...1&#39;</span><span class="p">,</span> <span class="s1">&#39;mysql://...2&#39;</span><span class="p">,</span> <span class="s1">&#39;mysql://...3&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>In this case the DAL tries to connect to the first and, on failure, it
will try the second and the third. This can also be used to distribute
load in a database master-slave configuration.</p>
</section>
<section id="reserved-keywords">
<h3>Reserved keywords<a class="headerlink" href="#reserved-keywords" title="Permalink to this headline"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">check_reserved</span></code> tells the constructor to check table names and column
names against reserved SQL keywords in target back-end databases.
<code class="docutils literal notranslate"><span class="pre">check_reserved</span></code> defaults to None.</p>
<p>This is a list of strings that contain the database back-end adapter
names.</p>
<p>The adapter name is the same as used in the DAL connection string. So if
you want to check against PostgreSQL and MSSQL then your db connection
would look as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">,</span> <span class="n">check_reserved</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span> <span class="s1">&#39;mssql&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>The DAL will scan the keywords in the same order as of the list.</p>
<p>There are two extra options “all” and “common”. If you specify all, it
will check against all known SQL keywords. If you specify common, it
will only check against common SQL keywords such as <code class="docutils literal notranslate"><span class="pre">SELECT</span></code>,
<code class="docutils literal notranslate"><span class="pre">INSERT</span></code>, <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code>, etc.</p>
<p>For supported back ends you may also specify if you would like to check
against the non-reserved SQL keywords as well. In this case you would
append <code class="docutils literal notranslate"><span class="pre">_nonreserved</span></code> to the name. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">check_reserved</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span> <span class="s1">&#39;postgres_nonreserved&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>The following database backends support reserved words checking.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 35%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Database</p></th>
<th class="head"><p>check_reserved</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>PostgreSQL</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">postgres(_nonreserved)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>MySQL</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mysql</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>FireBird</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">firebird(_nonreserved)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>MSSQL</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mssql</span></code></p></td>
</tr>
<tr class="row-even"><td><p><strong>Oracle</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">oracle</span></code></p></td>
</tr>
</tbody>
</table>
</section>
<section id="database-quoting-and-case-settings">
<h3>Database quoting and case settings<a class="headerlink" href="#database-quoting-and-case-settings" title="Permalink to this headline"></a></h3>
<p>Quoting of SQL entities are enabled by default in DAL, that is:</p>
<p><code class="docutils literal notranslate"><span class="pre">entity_quoting</span> <span class="pre">=</span> <span class="pre">True</span></code></p>
<p>This way identifiers are automatically quoted in SQL generated by DAL.
At SQL level keywords and unquoted identifiers are case insensitive,
thus quoting an SQL identifier makes it case sensitive.</p>
<blockquote>
<div><p>Notice that unquoted identifiers should always be folded to lower
case by the back-end engine according to SQL standard but not all
engines are compliant with this (for example PostgreSQL default
folding is upper case).</p>
</div></blockquote>
<p>By default DAL ignores field case too, to change this use:</p>
<p><code class="docutils literal notranslate"><span class="pre">ignore_field_case</span> <span class="pre">=</span> <span class="pre">False</span></code></p>
<p>To be sure of using the same names in python and in the DB schema, you
must arrange for both settings above. Here is an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="n">ignore_field_case</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;table1&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;column&#39;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;COLUMN&#39;</span><span class="p">))</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">table1</span><span class="o">.</span><span class="n">COLUMN</span> <span class="o">!=</span> <span class="n">db</span><span class="o">.</span><span class="n">table1</span><span class="o">.</span><span class="n">column</span>
</pre></div>
</div>
</section>
<section id="making-a-secure-connection">
<h3>Making a secure connection<a class="headerlink" href="#making-a-secure-connection" title="Permalink to this headline"></a></h3>
<p>Sometimes it is necessary (and advised) to connect to your database
using secure connection, especially if your database is not on the same
server as your application. In this case you need to pass additional
parameters to the database driver. You should refer to database driver
documentation for details.</p>
<p>For PostgreSQL with psycopg2 it should look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;postgres://user_name:user_password@server_addr/db_name&#39;</span><span class="p">,</span>
    <span class="n">driver_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sslmode&#39;</span><span class="p">:</span> <span class="s1">&#39;require&#39;</span><span class="p">,</span> <span class="s1">&#39;sslrootcert&#39;</span><span class="p">:</span> <span class="s1">&#39;root.crt&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;sslcert&#39;</span><span class="p">:</span> <span class="s1">&#39;postgresql.crt&#39;</span><span class="p">,</span> <span class="s1">&#39;sslkey&#39;</span><span class="p">:</span> <span class="s1">&#39;postgresql.key&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>where parameters <code class="docutils literal notranslate"><span class="pre">sslrootcert</span></code>, <code class="docutils literal notranslate"><span class="pre">sslcert</span></code> and <code class="docutils literal notranslate"><span class="pre">sslkey</span></code> should
contain the full path to the files. You should refer to PostgreSQL
documentation on how to configure PostgreSQL server to accept secure
connections.</p>
</section>
<section id="other-dal-constructor-parameters">
<h3>Other DAL constructor parameters<a class="headerlink" href="#other-dal-constructor-parameters" title="Permalink to this headline"></a></h3>
<section id="database-folder-location">
<h4>Database folder location<a class="headerlink" href="#database-folder-location" title="Permalink to this headline"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">folder</span></code> sets the place where migration files will be created (see
<a class="reference internal" href="#migrations">Migrations</a> for details).
It is also used for SQLite databases. Automatically set within py4web.
Set a path when using DAL outside py4web.</p>
</section>
<section id="default-migration-settings">
<h4>Default migration settings<a class="headerlink" href="#default-migration-settings" title="Permalink to this headline"></a></h4>
<p>The DAL constructor migration settings are booleans affecting defaults
and global behaviour.</p>
<p><code class="docutils literal notranslate"><span class="pre">migrate</span> <span class="pre">=</span> <span class="pre">True</span></code> sets default migrate behavior for all tables</p>
<p><code class="docutils literal notranslate"><span class="pre">fake_migrate</span> <span class="pre">=</span> <span class="pre">False</span></code> sets default fake_migrate behavior for all
tables</p>
<p><code class="docutils literal notranslate"><span class="pre">migrate_enabled</span> <span class="pre">=</span> <span class="pre">True</span></code> If set to False disables ALL migrations</p>
<p><code class="docutils literal notranslate"><span class="pre">fake_migrate_all</span> <span class="pre">=</span> <span class="pre">False</span></code> If set to True fake migrates ALL tables</p>
</section>
</section>
<section id="commit-and-rollback">
<h3><code class="docutils literal notranslate"><span class="pre">commit</span></code> and <code class="docutils literal notranslate"><span class="pre">rollback</span></code><a class="headerlink" href="#commit-and-rollback" title="Permalink to this headline"></a></h3>
<p>The insert, truncate, delete, and update operations aren’t actually
committed until py4web issues the commit command. The create and drop
operations may be executed immediately, depending on the database
engine.</p>
<p>If you pass <code class="docutils literal notranslate"><span class="pre">db</span></code> in an <code class="docutils literal notranslate"><span class="pre">action.uses</span></code> decorator, you don’t need to call
commit in the controller, it is done for you.  (Also, if you use
<code class="docutils literal notranslate"><span class="pre">authenticated</span></code> or <code class="docutils literal notranslate"><span class="pre">unauthenticated</span></code> decorator.)</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>always add <code class="docutils literal notranslate"><span class="pre">db</span></code> in an <code class="docutils literal notranslate"><span class="pre">action.uses</span></code> decorator (or use the
<code class="docutils literal notranslate"><span class="pre">authenticated</span></code> or <code class="docutils literal notranslate"><span class="pre">unauthenticated</span></code> decorator).
Otherwise you have to add <code class="docutils literal notranslate"><span class="pre">db.commit()</span></code> in every define_table and
in every table activities: insert(), update(), delete()</p>
</div>
<p>So in actions there is normally no need to ever call
<code class="docutils literal notranslate"><span class="pre">commit</span></code> or <code class="docutils literal notranslate"><span class="pre">rollback</span></code> explicitly in py4web unless you need more
granular control.</p>
<p>But if you executed commands via the shell, you are required
to manually commit:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<p>To check it let’s insert a new record:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Bob&quot;</span><span class="p">)</span>
<span class="go">2</span>
</pre></div>
</div>
<p>and roll back, i.e., ignore all operations since the last commit:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</pre></div>
</div>
<p>If you now insert again, the counter will again be set to 2, since the
previous insert was rolled back.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Bob&quot;</span><span class="p">)</span>
<span class="go">2</span>
</pre></div>
</div>
<p>Code in models, views and controllers is enclosed in py4web code that
looks like this (pseudo code):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">execute</span> <span class="n">models</span><span class="p">,</span> <span class="n">controller</span> <span class="n">function</span> <span class="ow">and</span> <span class="n">view</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">rollback</span> <span class="nb">all</span> <span class="n">connections</span>
    <span class="n">log</span> <span class="n">the</span> <span class="n">traceback</span>
    <span class="n">send</span> <span class="n">a</span> <span class="n">ticket</span> <span class="n">to</span> <span class="n">the</span> <span class="n">visitor</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">commit</span> <span class="nb">all</span> <span class="n">connections</span>
    <span class="n">save</span> <span class="n">cookies</span><span class="p">,</span> <span class="n">sessions</span> <span class="ow">and</span> <span class="k">return</span> <span class="n">the</span> <span class="n">page</span>
</pre></div>
</div>
</section>
</section>
<section id="table-constructor">
<h2>Table constructor<a class="headerlink" href="#table-constructor" title="Permalink to this headline"></a></h2>
<p>Tables are defined in the DAL via <code class="docutils literal notranslate"><span class="pre">define_table</span></code>.</p>
<section id="define-table-signature">
<h3>define_table signature<a class="headerlink" href="#define-table-signature" title="Permalink to this headline"></a></h3>
<p>The signature for define_table method is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">define_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="o">*</span><span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>It accepts a mandatory table name and an optional number of <code class="docutils literal notranslate"><span class="pre">Field</span></code>
instances (even none). You can also pass a <code class="docutils literal notranslate"><span class="pre">Table</span></code> (or subclass)
object instead of a <code class="docutils literal notranslate"><span class="pre">Field</span></code> one, this clones and adds all the fields
(but the “id”) to the defining table. Other optional keyword args are:
<code class="docutils literal notranslate"><span class="pre">rname</span></code>, <code class="docutils literal notranslate"><span class="pre">redefine</span></code>, <code class="docutils literal notranslate"><span class="pre">common_filter</span></code>, <code class="docutils literal notranslate"><span class="pre">fake_migrate</span></code>,
<code class="docutils literal notranslate"><span class="pre">fields</span></code>, <code class="docutils literal notranslate"><span class="pre">format</span></code>, <code class="docutils literal notranslate"><span class="pre">migrate</span></code>, <code class="docutils literal notranslate"><span class="pre">on_define</span></code>, <code class="docutils literal notranslate"><span class="pre">plural</span></code>,
<code class="docutils literal notranslate"><span class="pre">polymodel</span></code>, <code class="docutils literal notranslate"><span class="pre">primarykey</span></code>, <code class="docutils literal notranslate"><span class="pre">sequence_name</span></code>, <code class="docutils literal notranslate"><span class="pre">singular</span></code>,
<code class="docutils literal notranslate"><span class="pre">table_class</span></code>, and <code class="docutils literal notranslate"><span class="pre">trigger_name</span></code>, which are discussed below.</p>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
</pre></div>
</div>
<p>It defines, stores and returns a <code class="docutils literal notranslate"><span class="pre">Table</span></code> object called “person”
containing a field (column) “name”. This object can also be accessed via
<code class="docutils literal notranslate"><span class="pre">db.person</span></code>, so you do not need to catch the value returned by
define_table.</p>
</section>
<section id="id-notes-about-the-primary-key">
<h3><code class="docutils literal notranslate"><span class="pre">id</span></code>: Notes about the primary key<a class="headerlink" href="#id-notes-about-the-primary-key" title="Permalink to this headline"></a></h3>
<p>Do not declare a field called “id”, because one is created by py4web
anyway. Every table has a field called “id” by default. It is an
auto-increment integer field (usually starting at 1) used for
cross-reference and for making every record unique, so “id” is a primary
key. (Note: the id counter starting at 1 is back-end specific. For
example, this does not apply to the Google App Engine NoSQL.)</p>
<p>Optionally you can define a field of <code class="docutils literal notranslate"><span class="pre">type='id'</span></code> and py4web will use
this field as auto-increment id field. This is not recommended except
when accessing legacy database tables which have a primary key under a
different name. With some limitation, you can also use different primary
keys using the <code class="docutils literal notranslate"><span class="pre">primarykey</span></code> parameter.</p>
</section>
<section id="plural-and-singular">
<h3><code class="docutils literal notranslate"><span class="pre">plural</span></code> and <code class="docutils literal notranslate"><span class="pre">singular</span></code><a class="headerlink" href="#plural-and-singular" title="Permalink to this headline"></a></h3>
<p>As pyDAL is a general DAL, it includes plural and singular attributes to
refer to the table names so that external elements can use the proper
name for a table.</p>
</section>
<section id="redefine">
<h3><code class="docutils literal notranslate"><span class="pre">redefine</span></code><a class="headerlink" href="#redefine" title="Permalink to this headline"></a></h3>
<p>Tables can be defined only once but you can force py4web to redefine an
existing table:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="n">redefine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The redefinition may trigger a migration if table definition changes.</p>
</section>
<section id="format-record-representation">
<h3><code class="docutils literal notranslate"><span class="pre">format</span></code>: Record representation<a class="headerlink" href="#format-record-representation" title="Permalink to this headline"></a></h3>
<p>It is optional but recommended to specify a format representation for
records with the <code class="docutils literal notranslate"><span class="pre">format</span></code> parameter.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1"> </span><span class="si">%(id)s</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>or even more complex ones using a function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="nb">format</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;anonymous&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The format attribute will be used for two purposes:</p>
<ul class="simple">
<li><p>To represent referenced records in select/option drop-downs.</p></li>
<li><p>To set the <code class="docutils literal notranslate"><span class="pre">db.othertable.otherfield.represent</span></code> attribute for all fields
referencing this table. This means that the <code class="docutils literal notranslate"><span class="pre">Form</span></code> constructor will
not show references by id but will use the preferred format
representation instead.</p></li>
</ul>
</section>
<section id="rname-real-name">
<h3><code class="docutils literal notranslate"><span class="pre">rname</span></code>: Real name<a class="headerlink" href="#rname-real-name" title="Permalink to this headline"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">rname</span></code> sets a database backend name for the table. This makes the
py4web table name an alias, and <code class="docutils literal notranslate"><span class="pre">rname</span></code> is the real name used when
constructing the query for the backend. To illustrate just one use,
<code class="docutils literal notranslate"><span class="pre">rname</span></code> can be used to provide MSSQL fully qualified table names
accessing tables belonging to other databases on the server:
<code class="docutils literal notranslate"><span class="pre">rname</span> <span class="pre">=</span> <span class="pre">'db1.dbo.table1'</span></code></p>
</section>
<section id="primarykey-support-for-legacy-tables">
<h3><code class="docutils literal notranslate"><span class="pre">primarykey</span></code>: Support for legacy tables<a class="headerlink" href="#primarykey-support-for-legacy-tables" title="Permalink to this headline"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">primarykey</span></code> helps support legacy tables with existing primary keys,
even multi-part. See <a class="reference internal" href="#legacy-databases-and-keyed-tables">Legacy databases and keyed tables</a>.</p>
</section>
<section id="migrate-fake-migrate">
<h3><code class="docutils literal notranslate"><span class="pre">migrate</span></code>, <code class="docutils literal notranslate"><span class="pre">fake_migrate</span></code><a class="headerlink" href="#migrate-fake-migrate" title="Permalink to this headline"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">migrate</span></code> sets migration options for the table. Refer to
<a class="reference internal" href="#migrations">Migrations</a> for details.</p>
</section>
<section id="table-class">
<h3><code class="docutils literal notranslate"><span class="pre">table_class</span></code><a class="headerlink" href="#table-class" title="Permalink to this headline"></a></h3>
<p>If you define your own table class as a sub-class of
pydal.objects.Table, you can provide it here; this allows you to extend
and override methods. Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pydal.objects</span> <span class="kn">import</span> <span class="n">Table</span>

<span class="k">class</span> <span class="nc">MyTable</span><span class="p">(</span><span class="n">Table</span><span class="p">):</span>
    <span class="o">...</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">table_class</span><span class="o">=</span><span class="n">MyTable</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="sequence-name">
<h3><code class="docutils literal notranslate"><span class="pre">sequence_name</span></code><a class="headerlink" href="#sequence-name" title="Permalink to this headline"></a></h3>
<p>The name of a custom table sequence (if supported by the database). Can
create a SEQUENCE (starting at 1 and incrementing by 1) or use this for
legacy tables with custom sequences.</p>
<blockquote>
<div><p>Note that when necessary, py4web will create sequences automatically
by default.</p>
</div></blockquote>
</section>
<section id="trigger-name">
<h3><code class="docutils literal notranslate"><span class="pre">trigger_name</span></code><a class="headerlink" href="#trigger-name" title="Permalink to this headline"></a></h3>
<p>Relates to <code class="docutils literal notranslate"><span class="pre">sequence_name</span></code>. Relevant for some backends which do not
support auto-increment numeric fields.</p>
</section>
<section id="polymodel">
<h3><code class="docutils literal notranslate"><span class="pre">polymodel</span></code><a class="headerlink" href="#polymodel" title="Permalink to this headline"></a></h3>
<p>For use with Google App Engine.</p>
</section>
<section id="on-define">
<h3><code class="docutils literal notranslate"><span class="pre">on_define</span></code><a class="headerlink" href="#on-define" title="Permalink to this headline"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">on_define</span></code> is a callback triggered when a lazy_table is instantiated,
although it is called anyway if the table is not lazy. This allows
dynamic changes to the table without losing the advantages of delayed
instantiation.</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="n">lazy_tables</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">),</span>
    <span class="n">on_define</span><span class="o">=</span><span class="k">lambda</span> <span class="n">table</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">set_attributes</span><span class="p">(</span><span class="n">requires</span><span class="o">=</span><span class="n">IS_NOT_EMPTY</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="n">table</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">set_attributes</span><span class="p">(</span><span class="n">requires</span><span class="o">=</span><span class="n">IS_INT_IN_RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="p">])</span>
</pre></div>
</div>
<p>Note this example shows how to use <code class="docutils literal notranslate"><span class="pre">on_define</span></code> but it is not actually
necessary. The simple <code class="docutils literal notranslate"><span class="pre">requires</span></code> values could be added to the Field
definitions and the table would still be lazy. However, <code class="docutils literal notranslate"><span class="pre">requires</span></code>
which take a Set object as the first argument, such as IS_IN_DB, will
make a query like <code class="docutils literal notranslate"><span class="pre">db.sometable.somefield</span> <span class="pre">==</span> <span class="pre">some_value</span></code> which would
cause <code class="docutils literal notranslate"><span class="pre">sometable</span></code> to be defined early. This is the situation saved by
<code class="docutils literal notranslate"><span class="pre">on_define</span></code>.</p>
</section>
<section id="adding-attributes-to-fields-and-tables">
<h3>Adding attributes to fields and tables<a class="headerlink" href="#adding-attributes-to-fields-and-tables" title="Permalink to this headline"></a></h3>
<p>If you need to add custom attributes to fields, you can simply do this:
<code class="docutils literal notranslate"><span class="pre">db.table.field.extra</span> <span class="pre">=</span> <span class="pre">{}</span></code></p>
<p>“extra” is not a keyword; it’s a custom attribute now attached to the
field object. You can do it with tables too but they must be preceded by
an underscore to avoid naming conflicts with fields:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">_extra</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
</section>
<section id="legacy-databases-and-keyed-tables">
<h3>Legacy databases and keyed tables<a class="headerlink" href="#legacy-databases-and-keyed-tables" title="Permalink to this headline"></a></h3>
<p>py4web can connect to legacy databases under some conditions.</p>
<p>The easiest way is when these conditions are met:</p>
<ul class="simple">
<li><p>Each table must have a unique auto-increment integer field called “id”.</p></li>
<li><p>Records must be referenced exclusively using the “id” field.</p></li>
</ul>
<p>When accessing an existing table, i.e., a table not created by py4web in
the current application, always set <code class="docutils literal notranslate"><span class="pre">migrate=False</span></code>.</p>
<p>If the legacy table has an auto-increment integer field but it is not
called “id”, py4web can still access it but the table definition must
declare the auto-increment field with ‘id’ type (that is using
<code class="docutils literal notranslate"><span class="pre">FIeld('...',</span> <span class="pre">'id')</span></code>).</p>
<p>Finally if the legacy table uses a primary key that is not an
auto-increment id field it is possible to use a “keyed table”, for
example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;account&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;accnum&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;acctype&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;accdesc&#39;</span><span class="p">),</span>
                <span class="n">primarykey</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accnum&#39;</span><span class="p">,</span> <span class="s1">&#39;acctype&#39;</span><span class="p">],</span>
                <span class="n">migrate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">primarykey</span></code> is a list of the field names that make up the primary
key.</p></li>
<li><p>All primarykey fields have a <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code> set even if not specified.</p></li>
<li><p>Keyed tables can only reference other keyed tables.</p></li>
<li><p>Referencing fields must use the <code class="docutils literal notranslate"><span class="pre">reference</span> <span class="pre">tablename.fieldname</span></code>
format.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">update_record</span></code> function is not available for Rows of keyed
tables.</p></li>
</ul>
<blockquote>
<div><p>Currently keyed tables are only supported for DB2, MSSQL, Ingres and
Informix, but others engines will be added.</p>
</div></blockquote>
<p>At the time of writing, we cannot guarantee that the <code class="docutils literal notranslate"><span class="pre">primarykey</span></code>
attribute works with every existing legacy table and every supported
database backend. For simplicity, we recommend, if possible, creating a
database view that has an auto-increment id field.</p>
</section>
</section>
<section id="field-constructor">
<h2>Field constructor<a class="headerlink" href="#field-constructor" title="Permalink to this headline"></a></h2>
<p>These are the default values of a Field constructor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Field</span><span class="p">(</span><span class="n">fieldname</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT</span><span class="p">,</span>
      <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">DEFAULT</span><span class="p">,</span>
      <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">,</span> <span class="n">notnull</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
      <span class="n">uploadfield</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">widget</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">writable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">searchable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">listable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
      <span class="n">update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">authorize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autodelete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">represent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">uploadfolder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uploadseparate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uploadfs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">compute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">custom_qualifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">map_none</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rname</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>where DEFAULT is a special value used to allow the value None for a
parameter.</p>
<p>Not all of them are relevant for every field. <code class="docutils literal notranslate"><span class="pre">length</span></code> is relevant
only for fields of type “string”. <code class="docutils literal notranslate"><span class="pre">uploadfield</span></code>, <code class="docutils literal notranslate"><span class="pre">authorize</span></code>, and
<code class="docutils literal notranslate"><span class="pre">autodelete</span></code> are relevant only for fields of type “upload”.
<code class="docutils literal notranslate"><span class="pre">ondelete</span></code> is relevant only for fields of type “reference” and
“upload”.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">length</span></code> sets the maximum length of a “string”, “password” or
“upload” field. If <code class="docutils literal notranslate"><span class="pre">length</span></code> is not specified a default value is
used but the default value is not guaranteed to be backward
compatible. <em>To avoid unwanted migrations on upgrades, we recommend
that you always specify the length for string, password and upload
fields.</em></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default</span></code> sets the default value for the field. The default value
is used when performing an insert if a value is not explicitly
specified. It is also used to pre-populate forms built from the table
using <code class="docutils literal notranslate"><span class="pre">Form</span></code>. Note, rather than being a fixed value, the default
can instead be a function (including a lambda function) that returns
a value of the appropriate type for the field. In that case, the
function is called once for each record inserted, even when multiple
records are inserted in a single transaction.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">required</span></code> tells the DAL that no insert should be allowed on this
table if a value for this field is not explicitly specified.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">requires</span></code> is a <strong>validator</strong> or a list of validators. This is not used
by the DAL, but instead it is used by <code class="docutils literal notranslate"><span class="pre">Form</span></code> (this will be explained
better on the <a class="reference internal" href="chapter-12.html#forms"><span class="std std-ref">Forms</span></a> chapter). The default validators for
the given types are shown in the next section
<a class="reference internal" href="#field-types-and-validators"><span class="std std-ref">Field types and validators</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>while <code class="docutils literal notranslate"><span class="pre">requires=...</span></code> is enforced at the level of forms,
<code class="docutils literal notranslate"><span class="pre">required=True</span></code> is enforced at the level of the DAL (insert). In
addition, <code class="docutils literal notranslate"><span class="pre">notnull</span></code>, <code class="docutils literal notranslate"><span class="pre">unique</span></code> and <code class="docutils literal notranslate"><span class="pre">ondelete</span></code> are enforced at
the level of the database. While they sometimes may seem redundant,
it is important to maintain the distinction when programming with the
DAL.</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">rname</span></code> provides the field with a “real name”, a name for the field
known to the database adapter; when the field is used, it is the
rname value which is sent to the database. The py4web name for the
field is then effectively an alias.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ondelete</span></code> translates into the “ON DELETE” SQL statement. By
default it is set to “CASCADE”. This tells the database that when it
deletes a record, it should also delete all records that refer to it.
To disable this feature, set <code class="docutils literal notranslate"><span class="pre">ondelete</span></code> to “NO ACTION” or “SET
NULL”.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">notnull=True</span></code> translates into the “NOT NULL” SQL statement. It
prevents the database from inserting null values for the field.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique=True</span></code> translates into the “UNIQUE” SQL statement and it
makes sure that values of this field are unique within the table. It
is enforced at the database level.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uploadfield</span></code> applies only to fields of type “upload”. A field of
type “upload” stores the name of a file saved somewhere else, by
default on the filesystem under the application “uploads/” folder. If
<code class="docutils literal notranslate"><span class="pre">uploadfield</span></code> is set to True, then the file is stored in a blob
field within the same table and the value of <code class="docutils literal notranslate"><span class="pre">uploadfield</span></code> is the
name of the blob field. This will be discussed in more detail later
in <a class="reference internal" href="#more-on-uploads">More on uploads</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uploadfolder</span></code> must be set to a location where to store uploaded files.
The scaffolding app defines a folder <code class="docutils literal notranslate"><span class="pre">settings.UPLOAD_FOLDER</span></code>
which points to <code class="docutils literal notranslate"><span class="pre">apps/{app_name}/uploads</span></code> so you can
set, for example, <code class="docutils literal notranslate"><span class="pre">Field(...</span> <span class="pre">uploadfolder=settings.UPLOAD_FOLDER)</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uploadseparate</span></code> if set to True will upload files under different
subfolders of the <em>uploadfolder</em> folder. This is optimized to avoid
too many files under the same folder/subfolder. ATTENTION: You cannot
change the value of <code class="docutils literal notranslate"><span class="pre">uploadseparate</span></code> from True to False without
breaking links to existing uploads. pydal either uses the separate
subfolders or it does not. Changing the behavior after files have
been uploaded will prevent pydal from being able to retrieve those
files. If this happens it is possible to move files and fix the
problem but this is not described here.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uploadfs</span></code> allows you specify a different file system where to
upload files, including an Amazon S3 storage or a remote SFTP
storage.</p></li>
</ul>
<blockquote>
<div><p>You need to have PyFileSystem installed for this to work.
<code class="docutils literal notranslate"><span class="pre">uploadfs</span></code> must point to PyFileSystem.</p>
</div></blockquote>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">autodelete</span></code> determines if the corresponding uploaded file should
be deleted when the record referencing the file is deleted. For
“upload” fields only. However, records deleted by the database itself
due to a CASCADE operation will not trigger py4web’s autodelete.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">label</span></code> is a string (or a helper or something that can be
serialized to a string) that contains the label to be used for this
field in auto-generated forms.
serialized to a string) that contains a comment associated with this
field, and will be displayed to the right of the input field in the
autogenerated forms.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">writable</span></code> declares whether a field is writable in forms.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">readable</span></code> declares whether a field is readable in forms. If a
field is neither readable nor writable, it will not be displayed in
create and update forms.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">update</span></code> contains the default value for this field when the record
is updated.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compute</span></code> is an optional function. If a record is inserted or
updated, the compute function will be executed and the field will be
populated with the function result. The record is passed to the
compute function as a <code class="docutils literal notranslate"><span class="pre">dict</span></code>, and the dict will not include the
current value of that, or any other compute field.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">authorize</span></code> can be used to require access control on the
corresponding field, for “upload” fields only. It will be discussed
more in detail in the context of Authentication and Authorization.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">represent</span></code> can be None or can point to a function that takes a
field value and returns an alternate representation for the field
value. Examples:</p></li>
</ul>
<p>Note not all the attributes are thread safe and most of them
should only be set globally for an app. The following are guaranteed to be
thread safe and be set/reset in any action:
<code class="docutils literal notranslate"><span class="pre">default</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>, <code class="docutils literal notranslate"><span class="pre">readable</span></code>, <code class="docutils literal notranslate"><span class="pre">writable</span></code>, <code class="docutils literal notranslate"><span class="pre">requires</span></code>.</p>
<section id="field-types-and-validators">
<h3>Field types and validators<a class="headerlink" href="#field-types-and-validators" title="Permalink to this headline"></a></h3>
<table class="docutils align-default">
<colgroup>
<col style="width: 34%" />
<col style="width: 66%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Default validators</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">string</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_LENGTH(length)</span></code> default length is 512</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">text</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_LENGTH(length)</span></code> default length is 32768</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">blob</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">None</span></code> default length is 2**31 (2 GiB)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">boolean</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">None</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">integer</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_INT_IN_RANGE(-2**31,</span> <span class="pre">2**31)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">double</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_FLOAT_IN_RANGE(-1e100,</span> <span class="pre">1e100)</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">decimal(n,m)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_DECIMAL_IN_RANGE(-10**10,</span> <span class="pre">10**10)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">date</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_DATE()</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">time</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_TIME()</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">datetime</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_DATETIME()</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">password</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_LENGTH(length)</span></code> default length is 512</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">upload</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">None</span></code> default length is 512</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">reference</span> <span class="pre">&lt;table&gt;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_IN_DB(db,</span> <span class="pre">table.field,</span> <span class="pre">format)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">list:string</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">None</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">list:integer</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">None</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">list:reference</span> <span class="pre">&lt;table&gt;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_IN_DB(db,</span> <span class="pre">table._id,</span> <span class="pre">format,</span> <span class="pre">multiple=True)</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">json</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_EMPTY_OR(IS_JSON())</span></code> default length is 512</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">bigint</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_INT_IN_RANGE(-2**63,</span> <span class="pre">2**63)</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">big-id</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">None</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">big-reference</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">None</span></code></p></td>
</tr>
</tbody>
</table>
<p>Decimal requires and returns values as <code class="docutils literal notranslate"><span class="pre">Decimal</span></code> objects, as defined
in the Python <code class="docutils literal notranslate"><span class="pre">decimal</span></code> module. SQLite does not handle the <code class="docutils literal notranslate"><span class="pre">decimal</span></code>
type so internally we treat it as a <code class="docutils literal notranslate"><span class="pre">double</span></code>. The (n,m) are the number
of digits in total and the number of digits after the decimal point
respectively.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">big-id</span></code> and, <code class="docutils literal notranslate"><span class="pre">big-reference</span></code> are only supported by some of the
database engines and are experimental. They are not normally used as
field types unless for legacy tables, however, the DAL constructor has a
<code class="docutils literal notranslate"><span class="pre">bigint_id</span></code> argument that when set to <code class="docutils literal notranslate"><span class="pre">True</span></code> makes the <code class="docutils literal notranslate"><span class="pre">id</span></code> fields
and <code class="docutils literal notranslate"><span class="pre">reference</span></code> fields <code class="docutils literal notranslate"><span class="pre">big-id</span></code> and <code class="docutils literal notranslate"><span class="pre">big-reference</span></code> respectively.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">list:&lt;type&gt;</span></code> fields are special because they are designed to take
advantage of certain denormalization features on NoSQL (in the case of
Google App Engine NoSQL, the field types <code class="docutils literal notranslate"><span class="pre">ListProperty</span></code> and
<code class="docutils literal notranslate"><span class="pre">StringListProperty</span></code>) and back-port them all the other supported
relational databases. On relational databases lists are stored as a
<code class="docutils literal notranslate"><span class="pre">text</span></code> field. The items are separated by a <code class="docutils literal notranslate"><span class="pre">|</span></code> and each <code class="docutils literal notranslate"><span class="pre">|</span></code> in
string item is escaped as a <code class="docutils literal notranslate"><span class="pre">||</span></code>. They are discussed in
<a class="reference internal" href="#list-type-and-contains"><span class="std std-ref">list:&lt;type&gt; and contains</span></a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">json</span></code> field type is pretty much explanatory. It can store any
JSON serializable object. It is designed to work specifically for
MongoDB and backported to the other database adapters for portability.</p>
<p><code class="docutils literal notranslate"><span class="pre">blob</span></code> fields are also special. By default, binary data is encoded in
base64 before being stored into the actual database field, and it is
decoded when extracted. This has the negative effect of using 33% more
storage space than necessary in blob fields, but has the advantage of
making the communication independent of the back-end specific escaping
conventions.</p>
</section>
<section id="run-time-field-and-table-modification">
<h3>Run-time field and table modification<a class="headerlink" href="#run-time-field-and-table-modification" title="Permalink to this headline"></a></h3>
<p>Most attributes of fields and tables can be modified after they are
defined:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">/</span><span class="si">%(id)s</span><span class="s1">&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="s1">&#39;anonymous&#39;</span>
</pre></div>
</div>
<p>notice that attributes of tables are usually prefixed by an underscore
to avoid conflict with possible field names.</p>
<p>You can list the tables that have been defined for a given database
connection:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">tables</span>
<span class="go">[&#39;person&#39;]</span>
</pre></div>
</div>
<p>You can query for the type of a table:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span>
<span class="go">&lt;class &#39;pydal.objects.Table&#39;&gt;</span>
</pre></div>
</div>
<p>You can access a table using different syntaxes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span> <span class="ow">is</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;person&#39;</span><span class="p">]</span>
<span class="go">True</span>
</pre></div>
</div>
<p>You can also list the fields that have been defined for a given table:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">fields</span>
<span class="go">[&#39;id&#39;, &#39;name&#39;]</span>
</pre></div>
</div>
<p>Similarly you can access fields from their name in multiple equivalent
ways:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="go">&lt;class &#39;pydal.objects.Field&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
<span class="go">True</span>
</pre></div>
</div>
<p>Given a field, you can access the attributes set in its definition:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">type</span>
<span class="go">string</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">unique</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">notnull</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">length</span>
<span class="go">32</span>
</pre></div>
</div>
<p>including its parent table, tablename, and parent connection:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">_table</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">_tablename</span> <span class="o">==</span> <span class="s1">&#39;person&#39;</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">_db</span> <span class="o">==</span> <span class="n">db</span>
<span class="go">True</span>
</pre></div>
</div>
<p>A field also has methods. Some of them are used to build queries and we
will see them later. A special method of the field object is
<code class="docutils literal notranslate"><span class="pre">validate</span></code> and it calls the validators for the field.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="s1">&#39;John&#39;</span><span class="p">)</span>
<span class="go">(&#39;John&#39;, None)</span>
</pre></div>
</div>
<p>which returns a tuple <code class="docutils literal notranslate"><span class="pre">(value,</span> <span class="pre">error)</span></code>. <code class="docutils literal notranslate"><span class="pre">error</span></code> is <code class="docutils literal notranslate"><span class="pre">None</span></code> if the
input passes validation.</p>
</section>
<section id="more-on-uploads">
<h3>More on uploads<a class="headerlink" href="#more-on-uploads" title="Permalink to this headline"></a></h3>
<p>Consider the following model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;myfile&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;upload&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;path/to/file&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>In the case of an “upload” field, the default value can optionally be
set to a path (an absolute path or a path relative to the current app
folder), the default value is then assigned to each new record that does
not specify an image.</p>
<p>Notice that this way multiple records may end to reference the same
default image file and this could be a problem on a Field having
<code class="docutils literal notranslate"><span class="pre">autodelete</span></code> enabled. When you do not want to allow duplicates for the
image field (i.e. multiple records referencing the same file) but still
want to set a default value for the “upload” then you need a way to copy
the default file for each new record that does not specify an image.
This can be obtained using a file-like object referencing the default
file as the <code class="docutils literal notranslate"><span class="pre">default</span></code> argument to Field, or even with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Field</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;upload&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;&lt;file_content&gt;&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;&lt;file_name&gt;&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Normally an insert is handled automatically via a <code class="docutils literal notranslate"><span class="pre">Form</span></code> but
occasionally you already have the file on the filesystem and want to
upload it programmatically. This can be done in this way:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
</pre></div>
</div>
<p>It is also possible to insert a file in a simpler way and have the
insert method call <code class="docutils literal notranslate"><span class="pre">store</span></code> automatically:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case the filename is obtained from the stream object if
available.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">store</span></code> method of the upload field object takes a file stream and
a filename. It uses the filename to determine the extension (type) of
the file, creates a new temp name for the file (according to py4web
upload mechanism) and loads the file content in this new temp file
(under the uploads folder unless specified otherwise). It returns the
new temp name, which is then stored in the <code class="docutils literal notranslate"><span class="pre">image</span></code> field of the
<code class="docutils literal notranslate"><span class="pre">db.myfile</span></code> table.</p>
<p>Note, if the file is to be stored in an associated blob field rather
than the file system, the <code class="docutils literal notranslate"><span class="pre">store</span></code> method will not insert the file in
the blob field (because <code class="docutils literal notranslate"><span class="pre">store</span></code> is called before the insert), so the
file must be explicitly inserted into the blob field:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;myfile&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;upload&#39;</span><span class="p">,</span> <span class="n">uploadfield</span><span class="o">=</span><span class="s1">&#39;image_file&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;image_file&#39;</span><span class="p">,</span> <span class="s1">&#39;blob&#39;</span><span class="p">))</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                     <span class="n">image_file</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">retrieve</span></code> method does the opposite of <code class="docutils literal notranslate"><span class="pre">store</span></code>.</p>
<p>When uploaded files are stored on filesystem (as in the case of a plain
<code class="docutils literal notranslate"><span class="pre">Field('image',</span> <span class="pre">'upload')</span></code>) the code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">fullname</span><span class="p">)</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">nameonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>retrieves the original file name (filename) as seen by the user at
upload time and the name of stored file (fullname, with path relative to
application folder). While in general the call:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</pre></div>
</div>
<p>retrieves the original file name (filename) and a file-like object ready
to access uploaded file data (stream).</p>
<blockquote>
<div><p>Notice that the stream returned by <code class="docutils literal notranslate"><span class="pre">retrieve</span></code> is a real file object
in the case that uploaded files are stored on filesystem. In that
case remember to close the file when you are done, calling
<code class="docutils literal notranslate"><span class="pre">stream.close()</span></code>.</p>
</div></blockquote>
<p>Here is an example of safe usage of <code class="docutils literal notranslate"><span class="pre">retrieve</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">,</span> <span class="n">closing</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="migrations">
<h2>Migrations<a class="headerlink" href="#migrations" title="Permalink to this headline"></a></h2>
<p>With our example table definition:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">define_table</span></code> checks whether or not the corresponding table exists.
If it does not, it generates the SQL to create it and executes the SQL.
If the table does exist but differs from the one being defined, it
generates the SQL to alter the table and executes it. If a field has
changed type but not name, it will try to convert the data (If you do
not want this, you need to redefine the table twice, the first time,
letting py4web drop the field by removing it, and the second time adding
the newly defined field so that py4web can create it). If the table
exists and matches the current definition, it will leave it alone. In
all cases it will create the <code class="docutils literal notranslate"><span class="pre">db.person</span></code> object that represents the
table.</p>
<p>We refer to this behavior as a “migration”. py4web logs all migrations
and migration attempts in the file “sql.log”.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>by default py4web uses the “app/databases” folder for the
log file and all other migration files it needs. You can change this
setting by changing the <code class="docutils literal notranslate"><span class="pre">folder</span></code> argument to DAL. To set a different
log file name, for example “migrate.log” you can do
<code class="docutils literal notranslate"><span class="pre">db</span> <span class="pre">=</span> <span class="pre">DAL(...,</span> <span class="pre">adapter_args=dict(logfile='migrate.log'))</span></code></p>
</div>
<p>The first argument of <code class="docutils literal notranslate"><span class="pre">define_table</span></code> is always the table name. The
other unnamed arguments are the fields. The function also takes
an optional keyword argument called “migrate”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">migrate</span><span class="o">=</span><span class="s1">&#39;person.table&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The value of migrate is the filename where py4web stores internal
migration information for this table. These files are very important and
should never be removed while the corresponding tables exist. In cases
where a table has been dropped and the corresponding file still exist,
it can be removed manually. By default, migrate is set to True. This
causes py4web to generate the filename from a hash of the connection
string. If migrate is set to False, the migration is not performed, and
py4web assumes that the table exists in the datastore and it contains
(at least) the fields listed in <code class="docutils literal notranslate"><span class="pre">define_table</span></code>.</p>
<p>There may not be two tables in the same application with the same
migrate filename.</p>
<p>The DAL class also takes a “migrate” argument, which determines the
default value of migrate for calls to <code class="docutils literal notranslate"><span class="pre">define_table</span></code>. For example,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">,</span> <span class="n">migrate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>will set the default value of migrate to False whenever
<code class="docutils literal notranslate"><span class="pre">db.define_table</span></code> is called without a migrate argument.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>py4web only migrates new columns, removed columns, and
changes in column type (except in SQLite). py4web does not migrate
changes in attributes such as changes in the values of <code class="docutils literal notranslate"><span class="pre">default</span></code>,
<code class="docutils literal notranslate"><span class="pre">unique</span></code>, <code class="docutils literal notranslate"><span class="pre">notnull</span></code>, and <code class="docutils literal notranslate"><span class="pre">ondelete</span></code>.</p>
</div>
<p>Migrations can be disabled for all tables at once:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">migrate_enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>This is the recommended behavior when two apps share the same database.
Only one of the two apps should perform migrations, the other should
disable them.</p>
<section id="fixing-broken-migrations">
<h3>Fixing broken migrations<a class="headerlink" href="#fixing-broken-migrations" title="Permalink to this headline"></a></h3>
<p>There are two common problems with migrations and there are ways to
recover from them.</p>
<p>One problem is specific with SQLite. SQLite does not enforce column
types and cannot drop columns. This means that if you have a column of
type string and you remove it, it is not really removed. If you add the
column again with a different type (for example datetime) you end up
with a datetime column that contains strings (junk for practical
purposes). py4web does not complain about this because it does not know
what is in the database, until it tries to retrieve records and fails.</p>
<p>If py4web returns an error in some parse function when selecting
records, most likely this is due to corrupted data in a column because
of the above issue.</p>
<p>The solution consists in updating all records of the table and updating
the values in the column in question with None.</p>
<p>The other problem is more generic but typical with MySQL. MySQL does not
allow more than one ALTER TABLE in a transaction. This means that py4web
must break complex transactions into smaller ones (one ALTER TABLE at
the time) and commit one piece at the time. It is therefore possible
that part of a complex transaction gets committed and one part fails,
leaving py4web in a corrupted state. Why would part of a transaction
fail? Because, for example, it involves altering a table and converting
a string column into a datetime column, py4web tries to convert the
data, but the data cannot be converted. What happens to py4web? It gets
confused about what exactly is the table structure actually stored in
the database.</p>
<p>The solution consists of enabling fake migrations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="o">....</span><span class="p">,</span> <span class="n">migrate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fake_migrate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>This will rebuild py4web metadata about the table according to the table
definition. Try multiple table definitions to see which one works (the
one before the failed migration and the one after the failed migration).
Once successful remove the <code class="docutils literal notranslate"><span class="pre">fake_migrate=True</span></code> parameter.</p>
<p>Before attempting to fix migration problems it is prudent to make a copy
of “yourapp/databases/*.table” files.</p>
<p>Migration problems can also be fixed for all tables at once:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">fake_migrate_all</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>This also fails if the model describes tables that do not exist in the
database, but it can help narrowing down the problem.</p>
</section>
<section id="migration-control-summary">
<h3>Migration control summary<a class="headerlink" href="#migration-control-summary" title="Permalink to this headline"></a></h3>
<p>The logic of the various migration arguments are summarized in this
pseudo-code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">DAL</span><span class="o">.</span><span class="n">migrate_enabled</span> <span class="ow">and</span> <span class="n">table</span><span class="o">.</span><span class="n">migrate</span><span class="p">:</span>
   <span class="k">if</span> <span class="n">DAL</span><span class="o">.</span><span class="n">fake_migrate_all</span> <span class="ow">or</span> <span class="n">table</span><span class="o">.</span><span class="n">fake_migrate</span><span class="p">:</span>
       <span class="n">perform</span> <span class="n">fake</span> <span class="n">migration</span>
   <span class="k">else</span><span class="p">:</span>
       <span class="n">perform</span> <span class="n">migration</span>
</pre></div>
</div>
</section>
</section>
<section id="table-methods">
<h2>Table methods<a class="headerlink" href="#table-methods" title="Permalink to this headline"></a></h2>
<section id="insert">
<h3><code class="docutils literal notranslate"><span class="pre">insert</span></code><a class="headerlink" href="#insert" title="Permalink to this headline"></a></h3>
<p>Given a table, you can insert records</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Alex&quot;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Bob&quot;</span><span class="p">)</span>
<span class="go">2</span>
</pre></div>
</div>
<p>Insert returns the unique “id” value of each record inserted.</p>
<p>You can truncate the table, i.e., delete all records and reset the
counter of the id.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
</pre></div>
</div>
<p>Now, if you insert a record again, the counter starts again at 1 (this
is back-end specific and does not apply to Google NoSQL):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Alex&quot;</span><span class="p">)</span>
<span class="go">1</span>
</pre></div>
</div>
<p>Notice you can pass a parameter to <code class="docutils literal notranslate"><span class="pre">truncate</span></code>, for example you can
tell SQLite to restart the id counter.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="s1">&#39;RESTART IDENTITY CASCADE&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The argument is in raw SQL and therefore engine specific.</p>
<p>py4web also provides a bulk_insert method</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">([{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Alex&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;John&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Tim&#39;</span><span class="p">}])</span>
<span class="go">[3, 4, 5]</span>
</pre></div>
</div>
<p>It takes a list of dictionaries of fields to be inserted and performs
multiple inserts at once. It returns the list of “id” values of the
inserted records. On the supported relational databases there is no
advantage in using this function as opposed to looping and performing
individual inserts but on Google App Engine NoSQL, there is a major
speed advantage.</p>
</section>
<section id="query-set-rows">
<h3><code class="docutils literal notranslate"><span class="pre">Query</span></code>, <code class="docutils literal notranslate"><span class="pre">Set</span></code>, <code class="docutils literal notranslate"><span class="pre">Rows</span></code><a class="headerlink" href="#query-set-rows" title="Permalink to this headline"></a></h3>
<p>Let’s consider again the table defined (and dropped) previously and
insert three records:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Alex&quot;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Bob&quot;</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Carl&quot;</span><span class="p">)</span>
<span class="go">3</span>
</pre></div>
</div>
<p>You can store the table in a variable. For example, with variable
<code class="docutils literal notranslate"><span class="pre">person</span></code>, you could do:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">person</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span>
</pre></div>
</div>
<p>You can also store a field in a variable such as <code class="docutils literal notranslate"><span class="pre">name</span></code>. For example,
you could also do:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">name</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>You can even build a query (using operators like ==, !=, &lt;, &gt;, &lt;=, &gt;=,
like, belongs) and store the query in a variable <code class="docutils literal notranslate"><span class="pre">q</span></code> such as in:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">q</span> <span class="o">=</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span>
</pre></div>
</div>
<p>When you call <code class="docutils literal notranslate"><span class="pre">db</span></code> with a query, you define a set of records. You can
store it in a variable <code class="docutils literal notranslate"><span class="pre">s</span></code> and write:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that no database query has been performed so far. DAL + Query
simply define a set of records in this db that match the query. py4web
determines from the query which table (or tables) are involved and, in
fact, there is no need to specify that.</p>
</section>
<section id="update-or-insert">
<h3><code class="docutils literal notranslate"><span class="pre">update_or_insert</span></code><a class="headerlink" href="#update-or-insert" title="Permalink to this headline"></a></h3>
<p>Some times you need to perform an insert only if there is no record with
the same values as those being inserted. This can be done with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;birthplace&#39;</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">update_or_insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="n">birthplace</span><span class="o">=</span><span class="s1">&#39;Chicago&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The record will be inserted only if there is no other user called John
born in Chicago.</p>
<p>You can specify which values to use as a key to determine if the record
exists. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">update_or_insert</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">,</span>
                           <span class="n">birthplace</span><span class="o">=</span><span class="s1">&#39;Chicago&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>and if there is John his birthplace will be updated else a new record
will be created.</p>
<p>The selection criteria in the example above is a single field. It can
also be a query, such as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">update_or_insert</span><span class="p">((</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;John&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">birthplace</span> <span class="o">==</span> <span class="s1">&#39;Chicago&#39;</span><span class="p">),</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">,</span>
                           <span class="n">birthplace</span><span class="o">=</span><span class="s1">&#39;Chicago&#39;</span><span class="p">,</span>
                           <span class="n">pet</span><span class="o">=</span><span class="s1">&#39;Rover&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="validate-and-insert-validate-and-update">
<h3><code class="docutils literal notranslate"><span class="pre">validate_and_insert</span></code>, <code class="docutils literal notranslate"><span class="pre">validate_and_update</span></code><a class="headerlink" href="#validate-and-insert-validate-and-update" title="Permalink to this headline"></a></h3>
<p>The function</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">validate_and_insert</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>works very much like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>except that it calls the validators for the fields before performing the
insert and bails out if the validation does not pass. If validation does
not pass the errors can be found in <code class="docutils literal notranslate"><span class="pre">ret.errors</span></code>. <code class="docutils literal notranslate"><span class="pre">ret.errors</span></code> holds
a key-value mapping where each key is the field name whose validation
failed, and the value of the key is the result from the validation error
(much like <code class="docutils literal notranslate"><span class="pre">form.errors</span></code>). If it passes, the id of the new record is
in <code class="docutils literal notranslate"><span class="pre">ret.id</span></code>. Mind that normally validation is done by the form
processing logic so this function is rarely needed.</p>
<p>Similarly</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">validate_and_update</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>works very much the same as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">num</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>except that it calls the validators for the fields before performing the
update. Notice that it only works if query involves a single table. The
number of updated records can be found in <code class="docutils literal notranslate"><span class="pre">ret.updated</span></code> and errors
will be in <code class="docutils literal notranslate"><span class="pre">ret.errors</span></code>.</p>
</section>
<section id="drop">
<h3><code class="docutils literal notranslate"><span class="pre">drop</span></code><a class="headerlink" href="#drop" title="Permalink to this headline"></a></h3>
<p>Finally, you can drop tables and all data will be lost:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="tagging-records">
<h3>Tagging records<a class="headerlink" href="#tagging-records" title="Permalink to this headline"></a></h3>
<p>Tags allows to add or find properties attached to records in your
database.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">pydal.tools.tags</span> <span class="kn">import</span> <span class="n">Tags</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s2">&quot;sqlite:memory&quot;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s2">&quot;thing&quot;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
<span class="n">properties</span> <span class="o">=</span> <span class="n">Tags</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span>
<span class="n">id1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;chair&quot;</span><span class="p">)</span>
<span class="n">id2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;table&quot;</span><span class="p">)</span>
<span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="s2">&quot;color/red&quot;</span><span class="p">)</span>
<span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="s2">&quot;style/modern&quot;</span><span class="p">)</span>
<span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="s2">&quot;color/green&quot;</span><span class="p">)</span>
<span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="s2">&quot;material/wood&quot;</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id1</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;color/red&quot;</span><span class="p">,</span> <span class="s2">&quot;style/modern&quot;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id2</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;color/green&quot;</span><span class="p">,</span> <span class="s2">&quot;material/wood&quot;</span><span class="p">]</span>

<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">find</span><span class="p">([</span><span class="s2">&quot;style/modern&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">rows</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">id1</span>

<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">find</span><span class="p">([</span><span class="s2">&quot;material/wood&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">rows</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">id2</span>

<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">find</span><span class="p">([</span><span class="s2">&quot;color&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</pre></div>
</div>
<p>It is internally implemented as a table, which in
this example would be db.thing_tags_default, because no tail was
specified on the Tags(table, tail=“default”) constructor.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">find</span></code> method is doing a search by <code class="docutils literal notranslate"><span class="pre">startswith</span></code> of the
parameter. Then find([“color”]) would return id1 and id2
because both records have tags starting with “color”. py4web uses tags as a
flexible mechanism to manage permissions.</p>
</section>
</section>
<section id="raw-sql">
<h2>Raw SQL<a class="headerlink" href="#raw-sql" title="Permalink to this headline"></a></h2>
<section id="executesql">
<h3><code class="docutils literal notranslate"><span class="pre">executesql</span></code><a class="headerlink" href="#executesql" title="Permalink to this headline"></a></h3>
<p>The DAL allows you to explicitly issue SQL statements.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">executesql</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM person;&#39;</span><span class="p">)</span>
<span class="go">[(1, u&#39;Massimo&#39;), (2, u&#39;Massimo&#39;)]</span>
</pre></div>
</div>
<p>In this case, the return values are not parsed or transformed by the
DAL, and the format depends on the specific database driver. This usage
with selects is normally not needed, but it is more common with indexes.</p>
<p><code class="docutils literal notranslate"><span class="pre">executesql</span></code> takes five optional arguments: <code class="docutils literal notranslate"><span class="pre">placeholders</span></code>,
<code class="docutils literal notranslate"><span class="pre">as_dict</span></code>, <code class="docutils literal notranslate"><span class="pre">fields</span></code>, <code class="docutils literal notranslate"><span class="pre">colnames</span></code>, and <code class="docutils literal notranslate"><span class="pre">as_ordered_dict</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">placeholders</span></code> is an optional sequence of values to be substituted in
or, if supported by the DB driver, a dictionary with keys matching named
placeholders in your SQL.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">as_dict</span></code> is set to True, the results cursor returned by the DB
driver will be converted to a sequence of dictionaries keyed with the db
field names. Results returned with <code class="docutils literal notranslate"><span class="pre">as_dict</span> <span class="pre">=</span> <span class="pre">True</span></code> are the same as
those returned when applying as_list() to a normal select:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="s1">&#39;field1&#39;</span><span class="p">:</span> <span class="n">val1_row1</span><span class="p">,</span> <span class="s1">&#39;field2&#39;</span><span class="p">:</span> <span class="n">val2_row1</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;field1&#39;</span><span class="p">:</span> <span class="n">val1_row2</span><span class="p">,</span> <span class="s1">&#39;field2&#39;</span><span class="p">:</span> <span class="n">val2_row2</span><span class="p">}]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">as_ordered_dict</span></code> is pretty much like <code class="docutils literal notranslate"><span class="pre">as_dict</span></code> but the former
ensures that the order of resulting fields (OrderedDict keys) reflect
the order on which they are returned from DB driver:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;field1&#39;</span><span class="p">,</span> <span class="n">val1_row1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;field2&#39;</span><span class="p">,</span> <span class="n">val2_row1</span><span class="p">)]),</span>
 <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;field1&#39;</span><span class="p">,</span> <span class="n">val1_row2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;field2&#39;</span><span class="p">,</span> <span class="n">val2_row2</span><span class="p">)])]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">fields</span></code> argument is a list of DAL Field objects that match the
fields returned from the DB. The Field objects should be part of one or
more Table objects defined on the DAL object. The <code class="docutils literal notranslate"><span class="pre">fields</span></code> list can
include one or more DAL Table objects in addition to or instead of
including Field objects, or it can be just a single table (not in a
list). In that case, the Field objects will be extracted from the
table(s).</p>
<p>Instead of specifying the <code class="docutils literal notranslate"><span class="pre">fields</span></code> argument, the <code class="docutils literal notranslate"><span class="pre">colnames</span></code> argument
can be specified as a list of field names in tablename.fieldname format.
Again, these should represent tables and fields defined on the DAL
object.</p>
<p>It is also possible to specify both <code class="docutils literal notranslate"><span class="pre">fields</span></code> and the associated
<code class="docutils literal notranslate"><span class="pre">colnames</span></code>. In that case, <code class="docutils literal notranslate"><span class="pre">fields</span></code> can also include DAL Expression
objects in addition to Field objects. For Field objects in “fields”, the
associated <code class="docutils literal notranslate"><span class="pre">colnames</span></code> must still be in tablename.fieldname format. For
Expression objects in <code class="docutils literal notranslate"><span class="pre">fields</span></code>, the associated <code class="docutils literal notranslate"><span class="pre">colnames</span></code> can be any
arbitrary labels.</p>
<p>Notice, the DAL Table objects referred to by <code class="docutils literal notranslate"><span class="pre">fields</span></code> or <code class="docutils literal notranslate"><span class="pre">colnames</span></code>
can be dummy tables and do not have to represent any real tables in the
database. Also, note that the <code class="docutils literal notranslate"><span class="pre">fields</span></code> and <code class="docutils literal notranslate"><span class="pre">colnames</span></code> must be in the
same order as the fields in the results cursor returned from the DB.</p>
</section>
<section id="lastsql">
<h3><code class="docutils literal notranslate"><span class="pre">_lastsql</span></code><a class="headerlink" href="#lastsql" title="Permalink to this headline"></a></h3>
<p>Whether SQL was executed manually using executesql or was SQL generated
by the DAL, you can always find the SQL code in <code class="docutils literal notranslate"><span class="pre">db._lastsql</span></code>. This is
useful for debugging purposes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">_lastsql</span>
<span class="go">SELECT person.id, person.name FROM person;</span>
</pre></div>
</div>
<blockquote>
<div><p>py4web never generates queries using the “*” operator. py4web is
always explicit when selecting fields.</p>
</div></blockquote>
</section>
<section id="timing-queries">
<h3>Timing queries<a class="headerlink" href="#timing-queries" title="Permalink to this headline"></a></h3>
<p>All queries are automatically timed by py4web. The variable
<code class="docutils literal notranslate"><span class="pre">db._timings</span></code> is a list of tuples. Each tuple contains the raw SQL
query as passed to the database driver and the time it took to execute
in seconds.</p>
</section>
<section id="indexes">
<h3>Indexes<a class="headerlink" href="#indexes" title="Permalink to this headline"></a></h3>
<p>Currently the DAL API does not provide a command to create indexes on
tables, but this can be done using the <code class="docutils literal notranslate"><span class="pre">executesql</span></code> command. This is
because the existence of indexes can make migrations complex, and it is
better to deal with them explicitly. Indexes may be needed for those
fields that are used in recurrent queries.</p>
<p>Here is an example of how to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="n">db</span><span class="o">.</span><span class="n">executesql</span><span class="p">(</span><span class="s1">&#39;CREATE INDEX IF NOT EXISTS myidx ON person (name);&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Other database dialects have very similar syntaxes but may not support
the optional “IF NOT EXISTS” directive.</p>
</section>
<section id="generating-raw-sql">
<h3>Generating raw SQL<a class="headerlink" href="#generating-raw-sql" title="Permalink to this headline"></a></h3>
<p>Sometimes you need to generate the SQL but not execute it. This is easy
to do with py4web since every command that performs database IO has an
equivalent command that does not, and simply returns the SQL that would
have been executed. These commands have the same names and syntax as the
functional ones, but they start with an underscore:</p>
<p>Here is <code class="docutils literal notranslate"><span class="pre">_insert</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Alex&#39;</span><span class="p">))</span>
<span class="go">INSERT INTO &quot;person&quot;(&quot;name&quot;) VALUES (&#39;Alex&#39;);</span>
</pre></div>
</div>
<p>Here is <code class="docutils literal notranslate"><span class="pre">_count</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_count</span><span class="p">())</span>
<span class="go">SELECT COUNT(*) FROM &quot;person&quot; WHERE (&quot;person&quot;.&quot;name&quot; = &#39;Alex&#39;);</span>
</pre></div>
</div>
<p>Here is <code class="docutils literal notranslate"><span class="pre">_select</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_select</span><span class="p">())</span>
<span class="go">SELECT &quot;person&quot;.&quot;id&quot;, &quot;person&quot;.&quot;name&quot; FROM &quot;person&quot; WHERE (&quot;person&quot;.&quot;name&quot; = &#39;Alex&#39;);</span>
</pre></div>
</div>
<p>Here is <code class="docutils literal notranslate"><span class="pre">_delete</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_delete</span><span class="p">())</span>
<span class="go">DELETE FROM &quot;person&quot; WHERE (&quot;person&quot;.&quot;name&quot; = &#39;Alex&#39;);</span>
</pre></div>
</div>
<p>And finally, here is <code class="docutils literal notranslate"><span class="pre">_update</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Susan&#39;</span><span class="p">))</span>
<span class="go">UPDATE &quot;person&quot; SET &quot;name&quot;=&#39;Susan&#39; WHERE (&quot;person&quot;.&quot;name&quot; = &#39;Alex&#39;);</span>
</pre></div>
</div>
<blockquote>
<div><p>Moreover you can always use <code class="docutils literal notranslate"><span class="pre">db._lastsql</span></code> to return the most recent
SQL code, whether it was executed manually using executesql or was
SQL generated by the DAL.</p>
</div></blockquote>
</section>
</section>
<section id="select-command">
<h2><code class="docutils literal notranslate"><span class="pre">select</span></code> command<a class="headerlink" href="#select-command" title="Permalink to this headline"></a></h2>
<p>Given a Set, <code class="docutils literal notranslate"><span class="pre">s</span></code>, you can fetch the records with the command
<code class="docutils literal notranslate"><span class="pre">select</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div>
</div>
<p>It returns an iterable object of class <code class="docutils literal notranslate"><span class="pre">pydal.objects.Rows</span></code> whose
elements are Row objects. <code class="docutils literal notranslate"><span class="pre">pydal.objects.Row</span></code> objects act like
dictionaries, but their elements can also be accessed as attributes.
The former differ from the latter because
its values are read-only.</p>
<p>The Rows object allows looping over the result of the select and
printing the selected field values for each row:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">1 Alex</span>
</pre></div>
</div>
<p>You can do all the steps in one statement:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
</pre></div>
</div>
<p>The select command can take arguments. All unnamed arguments are
interpreted as the names of the fields that you want to fetch. For
example, you can be explicit on fetching field “id” and field “name”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
<p>The table attribute ALL allows you to specify all fields:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">1 Alex</span>
<span class="go">2 Bob</span>
<span class="go">3 Carl</span>
</pre></div>
</div>
<p>Notice that there is no query string passed to db. py4web understands
that if you want all fields of the table person without additional
information then you want all records of the table person.</p>
<p>An equivalent alternative syntax is the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">1 Alex</span>
<span class="go">2 Bob</span>
<span class="go">3 Carl</span>
</pre></div>
</div>
<p>and py4web understands that if you ask for all records of the table
person without additional information, then you want all the fields of
table person.</p>
<p>Given one row</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>you can extract its values using multiple equivalent expressions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">name</span>
<span class="go">Alex</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
<span class="go">Alex</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="p">(</span><span class="s1">&#39;person.name&#39;</span><span class="p">)</span>
<span class="go">Alex</span>
</pre></div>
</div>
<p>The latter syntax is particularly handy when selecting an expression
instead of a column. We will show this later.</p>
<p>You can also do</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span><span class="o">.</span><span class="n">compact</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<p>to disable the notation</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>and enable, instead, the less compact notation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>Yes this is unusual and rarely needed.</p>
<p>Row objects also have two important methods:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span><span class="o">.</span><span class="n">delete_record</span><span class="p">()</span>
</pre></div>
</div>
<p>and</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span><span class="o">.</span><span class="n">update_record</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;new value&quot;</span><span class="p">)</span>
</pre></div>
</div>
<section id="using-an-iterator-based-select-for-lower-memory-use">
<h3>Using an iterator-based select for lower memory use<a class="headerlink" href="#using-an-iterator-based-select-for-lower-memory-use" title="Permalink to this headline"></a></h3>
<p>Python “iterators” are a type of “lazy-evaluation”. They ‘feed’ data one
step at time; traditional Python loops create the entire set of data in
memory before looping.</p>
<p>The traditional use of select is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>but for large numbers of rows, using an iterator-based alternative has
dramatically lower memory use:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">iterselect</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Testing shows this is around 10% faster as well, even on machines with
large RAM.</p>
</section>
<section id="rendering-rows-using-represent">
<h3>Rendering rows using represent<a class="headerlink" href="#rendering-rows-using-represent" title="Permalink to this headline"></a></h3>
<p>You may wish to rewrite rows returned by select to take advantage of
formatting information contained in the represents setting of the
fields.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">repr_row</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>If you don’t specify an index, you get a generator to iterate over all
the rows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">render</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">myfield</span><span class="p">)</span>
</pre></div>
</div>
<p>Can also be applied to slices:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">render</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">myfield</span><span class="p">)</span>
</pre></div>
</div>
<p>If you only want to transform selected fields via their “represent”
attribute, you can list them in the “fields” argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">repr_row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="p">])</span>
</pre></div>
</div>
<p>Note, it returns a transformed copy of the original Row, so there’s no
update_record (which you wouldn’t want anyway) or delete_record.</p>
</section>
<section id="shortcuts">
<h3>Shortcuts<a class="headerlink" href="#shortcuts" title="Permalink to this headline"></a></h3>
<p>The DAL supports various code-simplifying shortcuts. In particular:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myrecord</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
</pre></div>
</div>
<p>returns the record with the given <code class="docutils literal notranslate"><span class="pre">id</span></code> if it exists. If the <code class="docutils literal notranslate"><span class="pre">id</span></code>
does not exist, it returns <code class="docutils literal notranslate"><span class="pre">None</span></code>. The above statement is equivalent
to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myrecord</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div>
</div>
<p>You can delete records by id:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
</pre></div>
</div>
<p>and this is equivalent to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
<p>and deletes the record with the given <code class="docutils literal notranslate"><span class="pre">id</span></code>, if it exists.</p>
<p>Note: this delete shortcut syntax does not currently work if
<em>versioning</em> is activated</p>
<p>You can insert records:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>It is equivalent to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>and it creates a new record with field values specified by the
dictionary on the right hand side.</p>
<p>Note: insert shortcut was previously <code class="docutils literal notranslate"><span class="pre">db.table[0]</span> <span class="pre">=</span> <span class="pre">...</span></code>. It has
changed in pyDAL 19.02 to permit normal usage of id 0.</p>
<p>You can update records:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>which is equivalent to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>and it updates an existing record with field values specified by the
dictionary on the right hand side.</p>
</section>
<section id="fetching-a-row">
<h3>Fetching a <code class="docutils literal notranslate"><span class="pre">Row</span></code><a class="headerlink" href="#fetching-a-row" title="Permalink to this headline"></a></h3>
<p>Yet another convenient syntax is the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<span class="n">record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span>
<span class="n">record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Apparently similar to <code class="docutils literal notranslate"><span class="pre">db.mytable[id]</span></code> the above syntax is more
flexible and safer. First of all it checks whether <code class="docutils literal notranslate"><span class="pre">id</span></code> is an int (or
<code class="docutils literal notranslate"><span class="pre">str(id)</span></code> is an int) and returns <code class="docutils literal notranslate"><span class="pre">None</span></code> if not (it never raises an
exception). It also allows to specify multiple conditions that the
record must meet. If they are not met, it also returns <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</section>
<section id="recursive-selects">
<h3>Recursive <code class="docutils literal notranslate"><span class="pre">select</span></code>s<a class="headerlink" href="#recursive-selects" title="Permalink to this headline"></a></h3>
<p>Consider the previous table person and a new table “thing” referencing a
“person”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>and a simple select from this table:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">things</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div>
</div>
<p>which is equivalent to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">things</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">_id</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">_id</span></code> is a reference to the primary key of the table. Normally
<code class="docutils literal notranslate"><span class="pre">db.thing._id</span></code> is the same as <code class="docutils literal notranslate"><span class="pre">db.thing.id</span></code> and we will assume that
in most of this book.</p>
<p>For each Row of things it is possible to fetch not just fields from the
selected table (thing) but also from linked tables (recursively):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">things</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">thing.owner_id.name</span></code> requires one database select for each thing
in things and it is therefore inefficient. We suggest using joins
whenever possible instead of recursive selects, nevertheless this is
convenient and practical when accessing individual records.</p>
<p>You can also do it backwards, by selecting the things referenced by a
person:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">person</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">person</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">orderby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;owns&#39;</span><span class="p">,</span> <span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>In this last expression <code class="docutils literal notranslate"><span class="pre">person.thing</span></code> is a shortcut for</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">==</span> <span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
<p>i.e. the Set of <code class="docutils literal notranslate"><span class="pre">thing</span></code>s referenced by the current <code class="docutils literal notranslate"><span class="pre">person</span></code>. This
syntax breaks down if the referencing table has multiple references to
the referenced table. In this case one needs to be more explicit and use
a full Query.</p>
</section>
<section id="orderby-groupby-limitby-distinct-having-orderby-on-limitby-join-left-cache">
<span id="orderby-groupby-limitby"></span><h3><code class="docutils literal notranslate"><span class="pre">orderby</span></code>, <code class="docutils literal notranslate"><span class="pre">groupby</span></code>, <code class="docutils literal notranslate"><span class="pre">limitby</span></code>, <code class="docutils literal notranslate"><span class="pre">distinct</span></code>, <code class="docutils literal notranslate"><span class="pre">having</span></code>, <code class="docutils literal notranslate"><span class="pre">orderby_on_limitby</span></code>, <code class="docutils literal notranslate"><span class="pre">join</span></code>, <code class="docutils literal notranslate"><span class="pre">left</span></code>, <code class="docutils literal notranslate"><span class="pre">cache</span></code><a class="headerlink" href="#orderby-groupby-limitby-distinct-having-orderby-on-limitby-join-left-cache" title="Permalink to this headline"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">select</span></code> command takes a number of optional arguments.</p>
<section id="orderby">
<h4>orderby<a class="headerlink" href="#orderby" title="Permalink to this headline"></a></h4>
<p>You can fetch the records sorted by name:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
<p>You can fetch the records sorted by name in reverse order (notice the
tilde):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=~</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Carl</span>
<span class="go">Bob</span>
<span class="go">Alex</span>
</pre></div>
</div>
<p>You can have the fetched records appear in random order:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="s1">&#39;&lt;random&gt;&#39;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Carl</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
</pre></div>
</div>
<blockquote>
<div><p>The use of <code class="docutils literal notranslate"><span class="pre">orderby='&lt;random&gt;'</span></code> is not supported on Google NoSQL.
However, to overcome this limit, sorting can be accomplished on
selected rows:</p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
</pre></div>
</div>
<p>You can sort the records according to multiple fields by concatenating
them with a “|”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">|</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
</section>
<section id="groupby-having">
<h4>groupby, having<a class="headerlink" href="#groupby-having" title="Permalink to this headline"></a></h4>
<p>Using <code class="docutils literal notranslate"><span class="pre">groupby</span></code> together with <code class="docutils literal notranslate"><span class="pre">orderby</span></code>, you can group records with
the same value for the specified field (this is back-end specific, and
is not on the Google NoSQL):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">orderby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">groupby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
<p>You can use <code class="docutils literal notranslate"><span class="pre">having</span></code> in conjunction with <code class="docutils literal notranslate"><span class="pre">groupby</span></code> to group
conditionally (only those <code class="docutils literal notranslate"><span class="pre">having</span></code> the condition are grouped).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">query1</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">having</span><span class="o">=</span><span class="n">query2</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that query1 filters records to be displayed, query2 filters
records to be grouped.</p>
</section>
<section id="distinct">
<h4>distinct<a class="headerlink" href="#distinct" title="Permalink to this headline"></a></h4>
<p>With the argument <code class="docutils literal notranslate"><span class="pre">distinct=True</span></code>, you can specify that you only want
to select distinct records. This has the same effect as grouping using
all specified fields except that it does not require sorting. When using
distinct it is important not to select ALL fields, and in particular not
to select the “id” field, else all records will always be distinct.</p>
<p>Here is an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
<p>Notice that <code class="docutils literal notranslate"><span class="pre">distinct</span></code> can also be an expression, for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
</section>
<section id="limitby">
<h4>limitby<a class="headerlink" href="#limitby" title="Permalink to this headline"></a></h4>
<p>With <code class="docutils literal notranslate"><span class="pre">limitby=(min,</span> <span class="pre">max)</span></code>, you can select a subset of the records from
offset=min to but not including offset=max. In the next example we
select the first two records starting at zero:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">limitby</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
</pre></div>
</div>
</section>
<section id="orderby-on-limitby">
<h4>orderby_on_limitby<a class="headerlink" href="#orderby-on-limitby" title="Permalink to this headline"></a></h4>
<p>Note that the DAL defaults to implicitly adding an orderby when using a
limitby. This ensures the same query returns the same results each time,
important for pagination. But it can cause performance problems. use
<code class="docutils literal notranslate"><span class="pre">orderby_on_limitby</span> <span class="pre">=</span> <span class="pre">False</span></code> to change this (this defaults to True).</p>
</section>
<section id="join-left">
<h4>join, left<a class="headerlink" href="#join-left" title="Permalink to this headline"></a></h4>
<p>These are involved in managing <a class="reference internal" href="#one-to-many-relation">One to many relation</a>. They are
described in <a class="reference internal" href="#inner-join">Inner join</a> and <a class="reference internal" href="#left-outer-join">Left outer join</a> sections respectively.</p>
</section>
<section id="cache-cacheable">
<h4>cache, cacheable<a class="headerlink" href="#cache-cacheable" title="Permalink to this headline"></a></h4>
<p>An example use which gives much faster selects is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">ram</span><span class="p">,</span> <span class="mi">3600</span><span class="p">),</span> <span class="n">cacheable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Look at <a class="reference internal" href="#caching-selects">Caching selects</a>, to understand what the trade-offs are.</p>
</section>
</section>
<section id="logical-operators">
<h3>Logical operators<a class="headerlink" href="#logical-operators" title="Permalink to this headline"></a></h3>
<p>Queries can be combined using the binary AND operator “<code class="docutils literal notranslate"><span class="pre">&amp;</span></code>”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">((</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;Alex&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span> <span class="nb">print</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<span class="go">0</span>
</pre></div>
</div>
<p>and the binary OR operator “<code class="docutils literal notranslate"><span class="pre">|</span></code>”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">((</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span> <span class="nb">print</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
<span class="go">1 Alex</span>
</pre></div>
</div>
<p>You can negate a sub-query inverting its operator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">((</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span> <span class="nb">print</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
<span class="go">2 Bob</span>
<span class="go">3 Carl</span>
</pre></div>
</div>
<p>or by explicit negation with the “<code class="docutils literal notranslate"><span class="pre">~</span></code>” unary operator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span> <span class="nb">print</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
<span class="go">2 Bob</span>
<span class="go">3 Carl</span>
</pre></div>
</div>
<blockquote>
<div><p>Due to Python restrictions in overloading “<code class="docutils literal notranslate"><span class="pre">and</span></code>” and “<code class="docutils literal notranslate"><span class="pre">or</span></code>”
operators, these cannot be used in forming queries. The binary
operators “<code class="docutils literal notranslate"><span class="pre">&amp;</span></code>” and “<code class="docutils literal notranslate"><span class="pre">|</span></code>” must be used instead. Note that these
operators (unlike “<code class="docutils literal notranslate"><span class="pre">and</span></code>” and “<code class="docutils literal notranslate"><span class="pre">or</span></code>”) have higher precedence than
comparison operators, so the “extra” parentheses in the above
examples are mandatory. Similarly, the unary operator “<code class="docutils literal notranslate"><span class="pre">~</span></code>” has
higher precedence than comparison operators, so <code class="docutils literal notranslate"><span class="pre">~</span></code>-negated
comparisons must also be parenthesized.</p>
</div></blockquote>
<p>It is also possible to build queries using in-place logical operators:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;Alex&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">&amp;=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">|=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;John&#39;</span>
</pre></div>
</div>
</section>
<section id="count-isempty-delete-update">
<h3><code class="docutils literal notranslate"><span class="pre">count</span></code>, <code class="docutils literal notranslate"><span class="pre">isempty</span></code>, <code class="docutils literal notranslate"><span class="pre">delete</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code><a class="headerlink" href="#count-isempty-delete-update" title="Permalink to this headline"></a></h3>
<p>You can count records in a set:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;William&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">3</span>
</pre></div>
</div>
<p>Notice that <code class="docutils literal notranslate"><span class="pre">count</span></code> takes an optional <code class="docutils literal notranslate"><span class="pre">distinct</span></code> argument which
defaults to False, and it works very much like the same argument for
<code class="docutils literal notranslate"><span class="pre">select</span></code>. <code class="docutils literal notranslate"><span class="pre">count</span></code> has also a <code class="docutils literal notranslate"><span class="pre">cache</span></code> argument that works very much
like the equivalent argument of the <code class="docutils literal notranslate"><span class="pre">select</span></code> method.</p>
<p>Sometimes you may need to check if a table is empty. A more efficient
way than counting is using the <code class="docutils literal notranslate"><span class="pre">isempty</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">isempty</span><span class="p">()</span>
<span class="go">False</span>
</pre></div>
</div>
<p>You can delete records in a set:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="go">0</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">delete</span></code> method returns the number of records that were deleted.</p>
<p>And you can update all records in a set by passing named arguments
corresponding to the fields that need to be updated:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Ken&#39;</span><span class="p">)</span>
<span class="go">1</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">update</span></code> method returns the number of records that were updated.</p>
</section>
<section id="expressions">
<h3>Expressions<a class="headerlink" href="#expressions" title="Permalink to this headline"></a></h3>
<p>The value assigned an update statement can be an expression. For example
consider this model</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;visits&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Massimo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">visits</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">visits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>The values used in queries can also be expressions</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;visits&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;clicks&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">visits</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">clicks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="case">
<h3><code class="docutils literal notranslate"><span class="pre">case</span></code><a class="headerlink" href="#case" title="Permalink to this headline"></a></h3>
<p>An expression can contain a case clause for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">condition</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">yes_or_no</span> <span class="o">=</span> <span class="n">condition</span><span class="o">.</span><span class="n">case</span><span class="p">(</span><span class="s1">&#39;Yes&#39;</span><span class="p">,</span> <span class="s1">&#39;No&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">yes_or_no</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">yes_or_no</span><span class="p">])</span>  <span class="c1"># could be row(yes_or_no) too</span>
<span class="gp">...</span>
<span class="go">Alex No</span>
<span class="go">Bob Yes</span>
<span class="go">Ken No</span>
</pre></div>
</div>
</section>
<section id="update-record">
<h3><code class="docutils literal notranslate"><span class="pre">update_record</span></code><a class="headerlink" href="#update-record" title="Permalink to this headline"></a></h3>
<p>py4web also allows updating a single record that is already in memory
using <code class="docutils literal notranslate"><span class="pre">update_record</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">update_record</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Curt&#39;</span><span class="p">)</span>
<span class="go">&lt;Row {&#39;id&#39;: 2, &#39;name&#39;: &#39;Curt&#39;}&gt;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">update_record</span></code> should not be confused with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Curt&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>because for a single row, the method <code class="docutils literal notranslate"><span class="pre">update</span></code> updates the row object
but not the database record, as in the case of <code class="docutils literal notranslate"><span class="pre">update_record</span></code>.</p>
<p>It is also possible to change the attributes of a row (one at a time)
and then call <code class="docutils literal notranslate"><span class="pre">update_record()</span></code> without arguments to save the changes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Philip&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">update_record</span><span class="p">()</span> <span class="c1"># saves above change</span>
<span class="go">&lt;Row {&#39;id&#39;: 3, &#39;name&#39;: &#39;Philip&#39;}&gt;</span>
</pre></div>
</div>
<blockquote>
<div><p>Note, you should avoid using <code class="docutils literal notranslate"><span class="pre">row.update_record()</span></code> with no
arguments when the <code class="docutils literal notranslate"><span class="pre">row</span></code> object contains fields that have an
<code class="docutils literal notranslate"><span class="pre">update</span></code> attribute (e.g.,
<code class="docutils literal notranslate"><span class="pre">Field('modified_on',</span> <span class="pre">update=datetime.datetime.utcnow)</span></code>). Calling
<code class="docutils literal notranslate"><span class="pre">row.update_record()</span></code> will retain <em>all</em> of the existing values in
the <code class="docutils literal notranslate"><span class="pre">row</span></code> object, so any fields with <code class="docutils literal notranslate"><span class="pre">update</span></code> attributes will
have no effect in this case. Be particularly mindful of this with
tables that include <code class="docutils literal notranslate"><span class="pre">auth.signature</span></code>.</p>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">update_record</span></code> method is available only if the table’s <code class="docutils literal notranslate"><span class="pre">id</span></code>
field is included in the select, and <code class="docutils literal notranslate"><span class="pre">cacheable</span></code> is not set to
<code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
</section>
<section id="inserting-and-updating-from-a-dictionary">
<h3>Inserting and updating from a dictionary<a class="headerlink" href="#inserting-and-updating-from-a-dictionary" title="Permalink to this headline"></a></h3>
<p>A common issue consists of needing to insert or update records in a
table where the name of the table, the field to be updated, and the
value for the field are all stored in variables. For example:
<code class="docutils literal notranslate"><span class="pre">tablename</span></code>, <code class="docutils literal notranslate"><span class="pre">fieldname</span></code>, and <code class="docutils literal notranslate"><span class="pre">value</span></code>.</p>
<p>The insert can be done using the following syntax:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">fieldname</span><span class="p">:</span><span class="n">value</span><span class="p">})</span>
</pre></div>
</div>
<p>The update of record with given id can be done with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">_id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">fieldname</span><span class="p">:</span><span class="n">value</span><span class="p">})</span>
</pre></div>
</div>
<p>Notice we used <code class="docutils literal notranslate"><span class="pre">table._id</span></code> instead of <code class="docutils literal notranslate"><span class="pre">table.id</span></code>. In this way the
query works even for tables with a primary key field with type other
than “id”.</p>
</section>
<section id="first-and-last">
<h3><code class="docutils literal notranslate"><span class="pre">first</span></code> and <code class="docutils literal notranslate"><span class="pre">last</span></code><a class="headerlink" href="#first-and-last" title="Permalink to this headline"></a></h3>
<p>Given a Rows object containing records:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">first_row</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">last_row</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
</pre></div>
</div>
<p>are equivalent to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">first_row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
<span class="n">last_row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
</pre></div>
</div>
<p>Notice, <code class="docutils literal notranslate"><span class="pre">first()</span></code> and <code class="docutils literal notranslate"><span class="pre">last()</span></code> allow you to obtain obviously the
first and last record present in your query, but this won’t mean that
these records are going to be the first or last inserted records. In
case you want the first or last record inputted in a given table don’t
forget to use <code class="docutils literal notranslate"><span class="pre">orderby=db.table_name.id</span></code>. If you forget you will only
get the first and last record returned by your query which are often in
a random order determined by the backend query optimiser.</p>
</section>
<section id="as-dict-and-as-list">
<h3><code class="docutils literal notranslate"><span class="pre">as_dict</span></code> and <code class="docutils literal notranslate"><span class="pre">as_list</span></code><a class="headerlink" href="#as-dict-and-as-list" title="Permalink to this headline"></a></h3>
<p>A Row object can be serialized into a regular dictionary using the
<code class="docutils literal notranslate"><span class="pre">as_dict()</span></code> method and a Rows object can be serialized into a list of
dictionaries using the <code class="docutils literal notranslate"><span class="pre">as_list()</span></code> method. Here are some examples:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">rows_list</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">as_list</span><span class="p">()</span>
<span class="n">first_row_dict</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
</pre></div>
</div>
<p>These methods are convenient for passing Rows to generic views and or to
store Rows in sessions (Rows objects themselves cannot be
serialized because they contain a reference to an open DB connection):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span>  <span class="c1"># not allowed!</span>
<span class="n">session</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">as_list</span><span class="p">()</span>  <span class="c1"># allowed!</span>
</pre></div>
</div>
</section>
<section id="combining-rows">
<h3>Combining rows<a class="headerlink" href="#combining-rows" title="Permalink to this headline"></a></h3>
<p>Rows objects can be combined at the Python level. Here we assume:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows1</span><span class="p">)</span>
<span class="go">person.name</span>
<span class="go">Max</span>
<span class="go">Tim</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows2</span><span class="p">)</span>
<span class="go">person.name</span>
<span class="go">John</span>
<span class="go">Tim</span>
</pre></div>
</div>
<p>You can do union of the records in two sets of rows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows3</span> <span class="o">=</span> <span class="n">rows1</span> <span class="o">+</span> <span class="n">rows2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows3</span><span class="p">)</span>
<span class="go">person.name</span>
<span class="go">Max</span>
<span class="go">Tim</span>
<span class="go">John</span>
<span class="go">Tim</span>
</pre></div>
</div>
<p>You can do union of the records removing duplicates:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows3</span> <span class="o">=</span> <span class="n">rows1</span> <span class="o">|</span> <span class="n">rows2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows3</span><span class="p">)</span>
<span class="go">person.name</span>
<span class="go">Max</span>
<span class="go">Tim</span>
<span class="go">John</span>
</pre></div>
</div>
<p>You can do intersection of the records in two sets of rows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows3</span> <span class="o">=</span> <span class="n">rows1</span> <span class="o">&amp;</span> <span class="n">rows2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows3</span><span class="p">)</span>
<span class="go">person.name</span>
<span class="go">Tim</span>
</pre></div>
</div>
</section>
<section id="find-exclude-sort">
<h3><code class="docutils literal notranslate"><span class="pre">find</span></code>, <code class="docutils literal notranslate"><span class="pre">exclude</span></code>, <code class="docutils literal notranslate"><span class="pre">sort</span></code><a class="headerlink" href="#find-exclude-sort" title="Permalink to this headline"></a></h3>
<p>Some times you need to perform two selects and one contains a subset of
a previous select. In this case it is pointless to access the database
again. The <code class="docutils literal notranslate"><span class="pre">find</span></code>, <code class="docutils literal notranslate"><span class="pre">exclude</span></code> and <code class="docutils literal notranslate"><span class="pre">sort</span></code> objects allow you to
manipulate a Rows object and generate another one without accessing the
database. More specifically: - <code class="docutils literal notranslate"><span class="pre">find</span></code> returns a new set of Rows
filtered by a condition and leaves the original unchanged. - <code class="docutils literal notranslate"><span class="pre">exclude</span></code>
returns a new set of Rows filtered by a condition and removes them from
the original Rows. - <code class="docutils literal notranslate"><span class="pre">sort</span></code> returns a new set of Rows sorted by a
condition and leaves the original unchanged.</p>
<p>All these methods take a single argument, a function that acts on each
individual row.</p>
<p>Here is an example of usage:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Max&#39;</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Alex&#39;</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;M&#39;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Max</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;M&#39;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Max</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">John</span>
</pre></div>
</div>
<p>They can be combined:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Max</span>
</pre></div>
</div>
<p>Sort takes an optional argument <code class="docutils literal notranslate"><span class="pre">reverse=True</span></code> with the obvious
meaning.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">find</span></code> method has an optional <code class="docutils literal notranslate"><span class="pre">limitby</span></code> argument with the same
syntax and functionality as the Set <code class="docutils literal notranslate"><span class="pre">select</span></code> method.</p>
</section>
<section id="caching-selects">
<h3>Caching selects<a class="headerlink" href="#caching-selects" title="Permalink to this headline"></a></h3>
<p>The select method also takes a <code class="docutils literal notranslate"><span class="pre">cache</span></code> argument, which defaults to
None. For caching purposes, it should be set to a tuple where the first
element is the cache model (<code class="docutils literal notranslate"><span class="pre">cache.ram</span></code>, <code class="docutils literal notranslate"><span class="pre">cache.disk</span></code>, etc.), and
the second element is the expiration time in seconds.</p>
<p>In the following example, you see a controller that caches a select on
the previously defined db.log table. The actual select fetches data from
the back-end database no more frequently than once every 60 seconds and
stores the result in memory. If the next call to this controller occurs
in less than 60 seconds since the last database IO, it simply fetches
the previous data from memory.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cache_db_select</span><span class="p">():</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">ram</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">logs</span><span class="o">=</span><span class="n">logs</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">select</span></code> method has an optional <code class="docutils literal notranslate"><span class="pre">cacheable</span></code> argument, normally
set to False. When <code class="docutils literal notranslate"><span class="pre">cacheable=True</span></code> the resulting <code class="docutils literal notranslate"><span class="pre">Rows</span></code> is
serializable but The <code class="docutils literal notranslate"><span class="pre">Row</span></code>s lack <code class="docutils literal notranslate"><span class="pre">update_record</span></code> and
<code class="docutils literal notranslate"><span class="pre">delete_record</span></code> methods.</p>
<p>If you do not need these methods you can speed up selects a lot by
setting the <code class="docutils literal notranslate"><span class="pre">cacheable</span></code> attribute:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cacheable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>When the <code class="docutils literal notranslate"><span class="pre">cache</span></code> argument is set but <code class="docutils literal notranslate"><span class="pre">cacheable=False</span></code> (default)
only the database results are cached, not the actual Rows object. When
the <code class="docutils literal notranslate"><span class="pre">cache</span></code> argument is used in conjunction with <code class="docutils literal notranslate"><span class="pre">cacheable=True</span></code>
the entire Rows object is cached and this results in much faster
caching:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">ram</span><span class="p">,</span> <span class="mi">3600</span><span class="p">),</span> <span class="n">cacheable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="computed-and-virtual-fields">
<h2>Computed and Virtual fields<a class="headerlink" href="#computed-and-virtual-fields" title="Permalink to this headline"></a></h2>
<section id="computed-fields">
<h3>Computed fields<a class="headerlink" href="#computed-fields" title="Permalink to this headline"></a></h3>
<p>DAL fields may have a <code class="docutils literal notranslate"><span class="pre">compute</span></code> attribute. This must be a function (or
lambda) that takes a Row object and returns a value for the field. When
a new record is modified, including both insertions and updates, if a
value for the field is not provided, py4web tries to compute from the
other field values using the <code class="docutils literal notranslate"><span class="pre">compute</span></code> function. Here is an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;total_price&#39;</span><span class="p">,</span>
<span class="gp">... </span>                      <span class="n">compute</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;unit_price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]))</span>
<span class="go">&lt;Table item (id, unit_price, quantity, total_price)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">unit_price</span><span class="o">=</span><span class="mf">1.99</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span>
<span class="go">&lt;Row {&#39;total_price&#39;: &#39;9.95&#39;, &#39;unit_price&#39;: 1.99, &#39;id&#39;: 1L, &#39;quantity&#39;: 5}&gt;</span>
</pre></div>
</div>
<p>Notice that the computed value is stored in the db and it is not
computed on retrieval, as in the case of virtual fields, described next.
Two typical applications of computed fields are:</p>
<ul class="simple">
<li><p>in wiki applications, to store the processed input wiki text as HTML, to
avoid re-processing on every request</p></li>
<li><p>for searching, to compute normalized values for a field, to be used for searching.</p></li>
</ul>
<p>Computed fields are evaluated in the order in which they are defined in
the table definition. A computed field can refer to previously defined
computed fields.</p>
</section>
<section id="virtual-fields">
<h3>Virtual fields<a class="headerlink" href="#virtual-fields" title="Permalink to this headline"></a></h3>
<p>Virtual fields are also computed fields (as in the previous subsection)
but they differ from those because they are <em>virtual</em> in the sense that
they are not stored in the db and they are computed each time records
are extracted from the database. They can be used to simplify the user’s
code without using additional storage but they cannot be used for
searching.</p>
</section>
<section id="new-style-virtual-fields-experimental">
<h3>New style virtual fields (experimental)<a class="headerlink" href="#new-style-virtual-fields-experimental" title="Permalink to this headline"></a></h3>
<p>py4web provides a new and easier way to define virtual fields and lazy
virtual fields. This section is marked experimental because the APIs may
still change a little from what is described here.</p>
<p>Here we will consider the same example as in the previous subsection. In
particular we consider the following model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>One can define a <code class="docutils literal notranslate"><span class="pre">total_price</span></code> virtual field as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">total_price</span> <span class="o">=</span> <span class="n">Field</span><span class="o">.</span><span class="n">Virtual</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="n">row</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
</pre></div>
</div>
<p>i.e. by simply defining a new field <code class="docutils literal notranslate"><span class="pre">total_price</span></code> to be a
<code class="docutils literal notranslate"><span class="pre">Field.Virtual</span></code>. The only argument of the constructor is a function
that takes a row and returns the computed values.</p>
<p>A virtual field defined as the one above is automatically computed for
all records when the records are selected:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">total_price</span><span class="p">)</span>
</pre></div>
</div>
<p>It is also possible to define method fields which are calculated
on-demand, when called. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">discounted_total</span> <span class="o">=</span> \
    <span class="n">Field</span><span class="o">.</span><span class="n">Method</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">,</span> <span class="n">discount</span><span class="o">=</span><span class="mf">0.0</span><span class="p">:</span>
                 <span class="n">row</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="n">row</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">-</span> <span class="n">discount</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
<p>In this case <code class="docutils literal notranslate"><span class="pre">row.discounted_total</span></code> is not a value but a function. The
function takes the same arguments as the function passed to the
<code class="docutils literal notranslate"><span class="pre">Method</span></code> constructor except for <code class="docutils literal notranslate"><span class="pre">row</span></code> which is implicit (think of it
as <code class="docutils literal notranslate"><span class="pre">self</span></code> for objects).</p>
<p>The lazy field in the example above allows one to compute the total
price for each <code class="docutils literal notranslate"><span class="pre">item</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">discounted_total</span><span class="p">())</span>
</pre></div>
</div>
<p>And it also allows to pass an optional <code class="docutils literal notranslate"><span class="pre">discount</span></code> percentage (say
15%):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">discounted_total</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
</pre></div>
</div>
<p>Virtual and Method fields can also be defined in place when a table is
defined:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="o">.</span><span class="n">Virtual</span><span class="p">(</span><span class="s1">&#39;total_price&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="o">...</span><span class="p">),</span>
                <span class="n">Field</span><span class="o">.</span><span class="n">Method</span><span class="p">(</span><span class="s1">&#39;discounted_total&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">,</span> <span class="n">discount</span><span class="o">=</span><span class="mf">0.0</span><span class="p">:</span> <span class="o">...</span><span class="p">))</span>
</pre></div>
</div>
<blockquote>
<div><p>Mind that virtual fields do not have the same attributes as regular
fields (length, default, required, etc). They do not appear in the
list of <code class="docutils literal notranslate"><span class="pre">db.table.fields</span></code>.</p>
</div></blockquote>
</section>
<section id="old-style-virtual-fields">
<h3>Old style virtual fields<a class="headerlink" href="#old-style-virtual-fields" title="Permalink to this headline"></a></h3>
<p>In order to define one or more virtual fields, you can also define a
container class, instantiate it and link it to a table or to a select.
For example, consider the following table:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>One can define a <code class="docutils literal notranslate"><span class="pre">total_price</span></code> virtual field as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyVirtualFields</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span>

<span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">virtualfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MyVirtualFields</span><span class="p">())</span>
</pre></div>
</div>
<p>Notice that each method of the class that takes a single argument (self)
is a new virtual field. <code class="docutils literal notranslate"><span class="pre">self</span></code> refers to each one row of the select.
Field values are referred by full path as in <code class="docutils literal notranslate"><span class="pre">self.item.unit_price</span></code>.
The table is linked to the virtual fields by appending an instance of
the class to the table’s <code class="docutils literal notranslate"><span class="pre">virtualfields</span></code> attribute.</p>
<p>Virtual fields can also access recursive fields as in</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;order_item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;reference item&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">MyVirtualFields</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">quantity</span>

<span class="n">db</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">virtualfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MyVirtualFields</span><span class="p">())</span>
</pre></div>
</div>
<p>Notice the recursive field access <code class="docutils literal notranslate"><span class="pre">self.order_item.item.unit_price</span></code>
where <code class="docutils literal notranslate"><span class="pre">self</span></code> is the looping record.</p>
<p>They can also act on the result of a JOIN</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">item</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">MyVirtualFields</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">quantity</span>

<span class="n">rows</span><span class="o">.</span><span class="n">setvirtualfields</span><span class="p">(</span><span class="n">order_item</span><span class="o">=</span><span class="n">MyVirtualFields</span><span class="p">())</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">total_price</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice how in this case the syntax is different. The virtual field
accesses both <code class="docutils literal notranslate"><span class="pre">self.item.unit_price</span></code> and <code class="docutils literal notranslate"><span class="pre">self.order_item.quantity</span></code>
which belong to the join select. The virtual field is attached to the
rows of the table using the <code class="docutils literal notranslate"><span class="pre">setvirtualfields</span></code> method of the rows
object. This method takes an arbitrary number of named arguments and can
be used to set multiple virtual fields, defined in multiple classes, and
attach them to multiple tables:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyVirtualFields1</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">discounted_unit_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="mf">0.90</span>

<span class="k">class</span> <span class="nc">MyVirtualFields2</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">quantity</span>
    <span class="k">def</span> <span class="nf">discounted_total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">discounted_unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">quantity</span>

<span class="n">rows</span><span class="o">.</span><span class="n">setvirtualfields</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">MyVirtualFields1</span><span class="p">(),</span>
                      <span class="n">order_item</span><span class="o">=</span><span class="n">MyVirtualFields2</span><span class="p">())</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">discounted_total_price</span><span class="p">)</span>
</pre></div>
</div>
<p>Virtual fields can be <em>lazy</em>; all they need to do is return a function
and access it by calling the function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">MyVirtualFields</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">lazy_total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">lazy</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span>
        <span class="k">return</span> <span class="n">lazy</span>

<span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">virtualfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MyVirtualFields</span><span class="p">())</span>

<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">lazy_total_price</span><span class="p">())</span>
</pre></div>
</div>
<p>or shorter using a lambda function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyVirtualFields</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">lazy_total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span>
</pre></div>
</div>
</section>
</section>
<section id="joins-and-relations">
<h2>Joins and Relations<a class="headerlink" href="#joins-and-relations" title="Permalink to this headline"></a></h2>
<section id="one-to-many-relation">
<h3>One to many relation<a class="headerlink" href="#one-to-many-relation" title="Permalink to this headline"></a></h3>
<p>To illustrate how to implement one to many relations with the DAL,
define another table “thing” that refers to the table “person” which we
redefine here:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Alex&#39;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Bob&#39;</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Carl&#39;</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>
<span class="go">&lt;Table thing (id, name, owner_id)&gt;</span>
</pre></div>
</div>
<p>Table “thing” has two fields, the name of the thing and the owner of the
thing. The “owner_id” field is a reference field, it is intended that
the field reference the other table by its id. A reference type can be
specified in two equivalent ways, either:
<code class="docutils literal notranslate"><span class="pre">Field('owner_id',</span> <span class="pre">'reference</span> <span class="pre">person')</span></code> or:
<code class="docutils literal notranslate"><span class="pre">Field('owner_id',</span> <span class="pre">db.person)</span></code>.</p>
<p>The latter is always converted to the former. They are equivalent except
in the case of lazy tables, self references or other types of cyclic
references where the former notation is the only allowed notation.</p>
<p>Now, insert three things, two owned by Alex and one by Bob:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Boat&#39;</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Chair&#39;</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Shoes&#39;</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="go">3</span>
</pre></div>
</div>
<p>You can select as you did for any other table:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Boat</span>
<span class="go">Chair</span>
</pre></div>
</div>
<p>Because a thing has a reference to a person, a person can have many
things, so a record of table person now acquires a new attribute thing,
which is a Set, that defines the things of that person. This allows
looping over all persons and fetching their things easily:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">person</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="p">,</span> <span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">     Boat</span>
<span class="go">     Chair</span>
<span class="go">Bob</span>
<span class="go">     Shoes</span>
<span class="go">Carl</span>
</pre></div>
</div>
</section>
<section id="inner-join">
<h3>Inner join<a class="headerlink" href="#inner-join" title="Permalink to this headline"></a></h3>
<p>Another way to achieve a similar result is by using a join, specifically
an INNER JOIN. py4web performs joins automatically and transparently
when the query links two or more tables as in the following example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex has Boat</span>
<span class="go">Alex has Chair</span>
<span class="go">Bob has Shoes</span>
</pre></div>
</div>
<p>Observe that py4web did a join, so the rows now contain two records, one
from each table, linked together. Because the two records may have
fields with conflicting names, you need to specify the table when
extracting a field value from a row. This means that while before you
could do:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>and it was obvious whether this was the name of a person or a thing, in
the result of a join you have to be more explicit and say:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>There is an alternative syntax for INNER JOINS:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">join</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex has Boat</span>
<span class="go">Alex has Chair</span>
<span class="go">Bob has Shoes</span>
</pre></div>
</div>
<p>While the output is the same, the generated SQL in the two cases can be
different. The latter syntax removes possible ambiguities when the same
table is joined twice and aliased:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id1&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id2&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>

<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">join</span><span class="o">=</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;owner_id1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id1</span><span class="p">),</span>
              <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;owner_id2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id2</span><span class="p">)])</span>
</pre></div>
</div>
<p>The value of <code class="docutils literal notranslate"><span class="pre">join</span></code> can be list of <code class="docutils literal notranslate"><span class="pre">db.table.on(...)</span></code> to join.</p>
</section>
<section id="left-outer-join">
<h3>Left outer join<a class="headerlink" href="#left-outer-join" title="Permalink to this headline"></a></h3>
<p>Notice that Carl did not appear in the list above because he has no
things. If you intend to select on persons (whether they have things or
not) and their things (if they have any), then you need to perform a
LEFT OUTER JOIN. This is done using the argument “left” of the select.
Here is an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">left</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex has Boat</span>
<span class="go">Alex has Chair</span>
<span class="go">Bob has Shoes</span>
<span class="go">Carl has None</span>
</pre></div>
</div>
<p>where:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">left</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>does the left join query. Here the argument of <code class="docutils literal notranslate"><span class="pre">db.thing.on</span></code> is the
condition required for the join (the same used above for the inner
join). In the case of a left join, it is necessary to be explicit about
which fields to select.</p>
<p>Multiple left joins can be combined by passing a list or tuple of
<code class="docutils literal notranslate"><span class="pre">db.mytable.on(...)</span></code> to the <code class="docutils literal notranslate"><span class="pre">left</span></code> parameter.</p>
</section>
<section id="grouping-and-counting">
<h3>Grouping and counting<a class="headerlink" href="#grouping-and-counting" title="Permalink to this headline"></a></h3>
<p>When doing joins, sometimes you want to group rows according to certain
criteria and count them. For example, count the number of things owned
by every person. py4web allows this as well. First, you need a count
operator. Second, you want to join the person table with the thing table
by owner. Third, you want to select all rows (person + thing), group
them by person, and count them while grouping:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">count</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span>
<span class="gp">... </span>              <span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">count</span><span class="p">])</span>
<span class="gp">...</span>
<span class="go">Alex 2</span>
<span class="go">Bob 1</span>
</pre></div>
</div>
<p>Notice the <code class="docutils literal notranslate"><span class="pre">count</span></code> operator (which is built-in) is used as a field.
The only issue here is in how to retrieve the information. Each row
clearly contains a person and the count, but the count is not a field of
a person nor is it a table. So where does it go? It goes into the
storage object representing the record with a key equal to the query
expression itself.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">count</span></code> method of the Field object has an optional <code class="docutils literal notranslate"><span class="pre">distinct</span></code>
argument. When set to <code class="docutils literal notranslate"><span class="pre">True</span></code> it specifies that only distinct values of
the field in question are to be counted.</p>
</section>
<section id="many-to-many-relation">
<h3>Many to many relation<a class="headerlink" href="#many-to-many-relation" title="Permalink to this headline"></a></h3>
<p>In the previous examples, we allowed a thing to have one owner but one
person could have many things. What if Boat was owned by Alex and Curt?
This requires a many-to-many relation, and it is realized via an
intermediate table that links a person to a thing via an ownership
relation.</p>
<p>Here is how to do it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Alex&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Bob&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Carl&#39;</span><span class="p">)])</span>
<span class="go">[1, 2, 3]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table thing (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Boat&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Chair&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Shoes&#39;</span><span class="p">)])</span>
<span class="go">[1, 2, 3]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;ownership&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span> <span class="s1">&#39;reference thing&#39;</span><span class="p">))</span>
<span class="go">&lt;Table ownership (id, person, thing)&gt;</span>
</pre></div>
</div>
<p>the existing ownership relationship can now be rewritten as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">thing</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Alex owns Boat</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">thing</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Alex owns Chair</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">thing</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># Bob owns Shoes</span>
<span class="go">3</span>
</pre></div>
</div>
<p>Now you can add the new relation that Curt co-owns Boat:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">thing</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Curt owns Boat too</span>
<span class="go">4</span>
</pre></div>
</div>
<p>Because you now have a three-way relation between tables, it may be
convenient to define a new set on which to perform operations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">persons_and_things</span> <span class="o">=</span> <span class="n">db</span><span class="p">((</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">person</span><span class="p">)</span> <span class="o">&amp;</span>
<span class="gp">... </span>                        <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">thing</span><span class="p">))</span>
</pre></div>
</div>
<p>Now it is easy to select all persons and their things from the new Set:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">persons_and_things</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex has Boat</span>
<span class="go">Alex has Chair</span>
<span class="go">Bob has Shoes</span>
<span class="go">Curt has Boat</span>
</pre></div>
</div>
<p>Similarly, you can search for all things owned by Alex:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">persons_and_things</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Boat</span>
<span class="go">Chair</span>
</pre></div>
</div>
<p>and all owners of Boat:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">persons_and_things</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Boat&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Curt</span>
</pre></div>
</div>
<p>A lighter alternative to many-to-many relations is tagging, you can
found an example of this in the next section. Tagging works even on
database backends that do not support JOINs like the Google App Engine
NoSQL.</p>
</section>
<section id="self-reference-and-aliases">
<h3>Self-Reference and aliases<a class="headerlink" href="#self-reference-and-aliases" title="Permalink to this headline"></a></h3>
<p>It is possible to define tables with fields that refer to themselves,
here is an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;father_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;mother_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Notice that the alternative notation of using a table object as field
type will fail in this case, because it uses a table before it is
defined:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;father_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">),</span>  <span class="c1"># wrong!</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;mother_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;person&#39;</span><span class="p">]))</span>  <span class="c1"># wrong!</span>
</pre></div>
</div>
<p>In general <code class="docutils literal notranslate"><span class="pre">db.tablename</span></code> and <code class="docutils literal notranslate"><span class="pre">'reference</span> <span class="pre">tablename'</span></code> are equivalent
field types, but the latter is the only one allowed for self-references.</p>
<p>When a table has a self-reference and you have to do join, for example
to select a person and its father, you need an alias for the table. In
SQL an alias is a temporary alternate name you can use to reference a
table/column into a query (or other SQL statement).</p>
<p>With py4web you can make an alias for a table using the <code class="docutils literal notranslate"><span class="pre">with_alias</span></code>
method. This works also for expressions, which means also for fields
since <code class="docutils literal notranslate"><span class="pre">Field</span></code> is derived from <code class="docutils literal notranslate"><span class="pre">Expression</span></code>.</p>
<p>Here is an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">fid</span><span class="p">,</span> <span class="n">mid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Massimo&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Claudia&#39;</span><span class="p">)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Marco&#39;</span><span class="p">,</span> <span class="n">father_id</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">mother_id</span><span class="o">=</span><span class="n">mid</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Father</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;father&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Mother</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;mother&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">Father</span><span class="p">)</span>
<span class="go">&lt;class &#39;pydal.objects.Table&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">str</span><span class="p">(</span><span class="n">Father</span><span class="p">)</span>
<span class="go">&#39;person AS father&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">Father</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">Mother</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">left</span><span class="o">=</span><span class="p">(</span><span class="n">Father</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">Father</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">father_id</span><span class="p">),</span>
<span class="gp">... </span>                         <span class="n">Mother</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">Mother</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">mother_id</span><span class="p">)))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">father</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">mother</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Massimo None None</span>
<span class="go">Claudia None None</span>
<span class="go">Marco Massimo Claudia</span>
</pre></div>
</div>
<p>Notice that we have chosen to make a distinction between: - “father_id”:
the field name used in the table “person”; - “father”: the alias we want
to use for the table referenced by the above field; this is communicated
to the database; - “Father”: the variable used by py4web to refer to
that alias.</p>
<p>The difference is subtle, and there is nothing wrong in using the same
name for the three of them:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;father&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;mother&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name, father, mother)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fid</span><span class="p">,</span> <span class="n">mid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Massimo&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Claudia&#39;</span><span class="p">)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Marco&#39;</span><span class="p">,</span> <span class="n">father</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">mother</span><span class="o">=</span><span class="n">mid</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">father</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;father&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mother</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;mother&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">father</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mother</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">left</span><span class="o">=</span><span class="p">(</span><span class="n">father</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">father</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">father</span><span class="p">),</span>
<span class="gp">... </span>                         <span class="n">mother</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">mother</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">mother</span><span class="p">)))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">father</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">mother</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Massimo None None</span>
<span class="go">Claudia None None</span>
<span class="go">Marco Massimo Claudia</span>
</pre></div>
</div>
<p>But it is important to have the distinction clear in order to build
correct queries.</p>
</section>
</section>
<section id="other-operators">
<h2>Other operators<a class="headerlink" href="#other-operators" title="Permalink to this headline"></a></h2>
<p>py4web has other operators that provide an API to access equivalent SQL
operators. Let’s define another table “log” to store security events,
their event_time and severity, where the severity is an integer number.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">),</span>
<span class="gp">... </span>                       <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;event_time&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">),</span>
<span class="gp">... </span>                       <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;severity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">))</span>
<span class="go">&lt;Table log (id, event, event_time, severity)&gt;</span>
</pre></div>
</div>
<p>As before, insert a few events, a “port scan”, an “xss injection” and an
“unauthorized login”. For the sake of the example, you can log events
with the same event_time but with different severities (1, 2, and 3
respectively).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s1">&#39;port scan&#39;</span><span class="p">,</span> <span class="n">event_time</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s1">&#39;xss injection&#39;</span><span class="p">,</span> <span class="n">event_time</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s1">&#39;unauthorized login&#39;</span><span class="p">,</span> <span class="n">event_time</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="go">3</span>
</pre></div>
</div>
<section id="like-ilike-regexp-startswith-endswith-contains-upper-lower">
<h3><code class="docutils literal notranslate"><span class="pre">like</span></code>, <code class="docutils literal notranslate"><span class="pre">ilike</span></code>, <code class="docutils literal notranslate"><span class="pre">regexp</span></code>, <code class="docutils literal notranslate"><span class="pre">startswith</span></code>, <code class="docutils literal notranslate"><span class="pre">endswith</span></code>, <code class="docutils literal notranslate"><span class="pre">contains</span></code>, <code class="docutils literal notranslate"><span class="pre">upper</span></code>, <code class="docutils literal notranslate"><span class="pre">lower</span></code><a class="headerlink" href="#like-ilike-regexp-startswith-endswith-contains-upper-lower" title="Permalink to this headline"></a></h3>
<p>Fields have a <code class="docutils literal notranslate"><span class="pre">like</span></code> operator that you can use to match strings:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;port%&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">port scan</span>
</pre></div>
</div>
<p>Here “port%” indicates a string starting with “port”. The percent sign
character, “%”, is a wild-card character that means “any sequence of
characters”.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">like</span></code> operator maps to the LIKE word in ANSI-SQL. LIKE is
case-sensitive in most databases, and depends on the collation of the
database itself. The <code class="docutils literal notranslate"><span class="pre">like</span></code> method is hence case-sensitive but it can
be made case-insensitive with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>which is the same as using <code class="docutils literal notranslate"><span class="pre">ilike</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>py4web also provides some shortcuts:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>which are roughly equivalent respectively to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;value%&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;%value&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;%value%&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Remember that <code class="docutils literal notranslate"><span class="pre">contains</span></code> has a special meaning for <code class="docutils literal notranslate"><span class="pre">list:&lt;type&gt;</span></code>
fields, as discussed in <a class="reference internal" href="#list-type-and-contains"><span class="std std-ref">list:&lt;type&gt; and contains</span></a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">contains</span></code> method can also be passed a list of values and an
optional boolean argument <code class="docutils literal notranslate"><span class="pre">all</span></code> to search for records that contain all
values:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">contains</span><span class="p">([</span><span class="s1">&#39;value1&#39;</span><span class="p">,</span> <span class="s1">&#39;value2&#39;</span><span class="p">],</span> <span class="nb">all</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>or any value from the list</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">contains</span><span class="p">([</span><span class="s1">&#39;value1&#39;</span><span class="p">,</span> <span class="s1">&#39;value2&#39;</span><span class="p">],</span> <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>There is a also a <code class="docutils literal notranslate"><span class="pre">regexp</span></code> method that works like the <code class="docutils literal notranslate"><span class="pre">like</span></code> method
but allows regular expression syntax for the look-up expression. It is
only supported by MySQL, Oracle, PostgreSQL, SQLite, and MongoDB (with
different degree of support).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">upper</span></code> and <code class="docutils literal notranslate"><span class="pre">lower</span></code> methods allow you to convert the value of
the field to upper or lower case, and you can also combine them with the
like operator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;PORT%&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">port scan</span>
</pre></div>
</div>
</section>
<section id="year-month-day-hour-minutes-seconds">
<h3><code class="docutils literal notranslate"><span class="pre">year</span></code>, <code class="docutils literal notranslate"><span class="pre">month</span></code>, <code class="docutils literal notranslate"><span class="pre">day</span></code>, <code class="docutils literal notranslate"><span class="pre">hour</span></code>, <code class="docutils literal notranslate"><span class="pre">minutes</span></code>, <code class="docutils literal notranslate"><span class="pre">seconds</span></code><a class="headerlink" href="#year-month-day-hour-minutes-seconds" title="Permalink to this headline"></a></h3>
<p>The date and datetime fields have <code class="docutils literal notranslate"><span class="pre">day</span></code>, <code class="docutils literal notranslate"><span class="pre">month</span></code> and <code class="docutils literal notranslate"><span class="pre">year</span></code>
methods. The datetime and time fields have <code class="docutils literal notranslate"><span class="pre">hour</span></code>, <code class="docutils literal notranslate"><span class="pre">minutes</span></code> and
<code class="docutils literal notranslate"><span class="pre">seconds</span></code> methods. Here is an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event_time</span><span class="o">.</span><span class="n">year</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">2018</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">port scan</span>
<span class="go">xss injection</span>
<span class="go">unauthorized login</span>
</pre></div>
</div>
</section>
<section id="belongs">
<h3><code class="docutils literal notranslate"><span class="pre">belongs</span></code><a class="headerlink" href="#belongs" title="Permalink to this headline"></a></h3>
<p>The SQL IN operator is realized via the <code class="docutils literal notranslate"><span class="pre">belongs</span></code> method which returns
true when the field value belongs to the specified set (list or tuples):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">severity</span><span class="o">.</span><span class="n">belongs</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">port scan</span>
<span class="go">xss injection</span>
</pre></div>
</div>
<p>The DAL also allows a nested select as the argument of the belongs
operator. The only caveat is that the nested select has to be a
<code class="docutils literal notranslate"><span class="pre">_select</span></code>, not a <code class="docutils literal notranslate"><span class="pre">select</span></code>, and only one field has to be selected
explicitly, the one that defines the set.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">bad_days</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">_select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event_time</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event_time</span><span class="o">.</span><span class="n">belongs</span><span class="p">(</span><span class="n">bad_days</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">severity</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">1 port scan</span>
<span class="go">2 xss injection</span>
<span class="go">3 unauthorized login</span>
</pre></div>
</div>
<p>In those cases where a nested select is required and the look-up field
is a reference we can also use a query as argument. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>

<span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="o">.</span><span class="n">belongs</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Jonathan&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div>
</div>
<p>In this case it is obvious that the nested select only needs the field
referenced by the <code class="docutils literal notranslate"><span class="pre">db.thing.owner_id</span></code> field so we do not need the more
verbose <code class="docutils literal notranslate"><span class="pre">_select</span></code> notation.</p>
<p>A nested select can also be used as insert/update value but in this case
the syntax is different:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lazy</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Jonathan&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">nested_select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">owner_id</span> <span class="o">=</span> <span class="n">lazy</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case <code class="docutils literal notranslate"><span class="pre">lazy</span></code> is a nested expression that computes the <code class="docutils literal notranslate"><span class="pre">id</span></code> of
person “Jonathan”. The two lines result in one single SQL query.</p>
</section>
<section id="sum-avg-min-max-and-len">
<h3><code class="docutils literal notranslate"><span class="pre">sum</span></code>, <code class="docutils literal notranslate"><span class="pre">avg</span></code>, <code class="docutils literal notranslate"><span class="pre">min</span></code>, <code class="docutils literal notranslate"><span class="pre">max</span></code> and <code class="docutils literal notranslate"><span class="pre">len</span></code><a class="headerlink" href="#sum-avg-min-max-and-len" title="Permalink to this headline"></a></h3>
<p>Previously, you have used the <code class="docutils literal notranslate"><span class="pre">count</span></code> operator to count records.
Similarly, you can use the <code class="docutils literal notranslate"><span class="pre">sum</span></code> operator to add (sum) the values of a
specific field from a group of records. As in the case of count, the
result of a sum is retrieved via the storage object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">sum</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">severity</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="nb">sum</span><span class="p">])</span>
<span class="go">6</span>
</pre></div>
</div>
<p>You can also use <code class="docutils literal notranslate"><span class="pre">avg</span></code>, <code class="docutils literal notranslate"><span class="pre">min</span></code>, and <code class="docutils literal notranslate"><span class="pre">max</span></code> to the average, minimum,
and maximum value respectively for the selected records. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">max</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">severity</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">max</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="nb">max</span><span class="p">])</span>
<span class="go">3</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">len</span></code> computes the length of field’s value. It is generally used on
string or text fields but depending on the back-end it may still work
for other types too (boolean, integer, etc).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">13</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">unauthorized login</span>
</pre></div>
</div>
<p>Expressions can be combined to form more complex expressions. For
example here we are computing the sum of the length of the event strings
in the logs plus one:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="n">exp</span><span class="p">]</span>
<span class="go">43</span>
</pre></div>
</div>
</section>
<section id="substrings">
<h3>Substrings<a class="headerlink" href="#substrings" title="Permalink to this headline"></a></h3>
<p>One can build an expression to refer to a substring. For example, we can
group things whose name starts with the same three characters and select
only one from each group:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">distinct</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="default-values-with-coalesce-and-coalesce-zero">
<h3>Default values with <code class="docutils literal notranslate"><span class="pre">coalesce</span></code> and <code class="docutils literal notranslate"><span class="pre">coalesce_zero</span></code><a class="headerlink" href="#default-values-with-coalesce-and-coalesce-zero" title="Permalink to this headline"></a></h3>
<p>There are times when you need to pull a value from database but also
need a default values if the value for a record is set to NULL. In SQL
there is a function, <code class="docutils literal notranslate"><span class="pre">COALESCE</span></code>, for this. py4web has an equivalent
<code class="docutils literal notranslate"><span class="pre">coalesce</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;sysuser&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;fullname&#39;</span><span class="p">))</span>
<span class="go">&lt;Table sysuser (id, username, fullname)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Max Power&#39;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;tim&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">coa</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">fullname</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">coa</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">coa</span><span class="p">])</span>
<span class="gp">...</span>
<span class="go">Max Power</span>
<span class="go">tim</span>
</pre></div>
</div>
<p>Other times you need to compute a mathematical expression but some
fields have a value set to None while it should be zero.
<code class="docutils literal notranslate"><span class="pre">coalesce_zero</span></code> comes to the rescue by defaulting None to zero in the
query:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;sysuser&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;points&#39;</span><span class="p">))</span>
<span class="go">&lt;Table sysuser (id, username, points)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;tim&#39;</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">coalesce_zero</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="n">exp</span><span class="p">]</span>
<span class="go">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
<span class="go">&lt;class &#39;pydal.objects.Expression&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
<span class="go">SUM(COALESCE(&quot;sysuser&quot;.&quot;points&quot;,&#39;0&#39;))</span>
</pre></div>
</div>
</section>
</section>
<section id="exporting-and-importing-data">
<h2>Exporting and importing data<a class="headerlink" href="#exporting-and-importing-data" title="Permalink to this headline"></a></h2>
<section id="csv-one-table-at-a-time">
<h3>CSV (one Table at a time)<a class="headerlink" href="#csv-one-table-at-a-time" title="Permalink to this headline"></a></h3>
<p>When a Rows object is converted to a string it is automatically
serialized in CSV:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<span class="go">person.id,person.name,thing.id,thing.name,thing.owner_id</span>
<span class="go">1,Alex,1,Boat,1</span>
<span class="go">1,Alex,2,Chair,1</span>
<span class="go">2,Bob,3,Shoes,2</span>
</pre></div>
</div>
<p>You can serialize a single table in CSV and store it in a file
“test.csv”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">dumpfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()))</span>
</pre></div>
</div>
<p>Converting a <code class="docutils literal notranslate"><span class="pre">Rows</span></code> object into a string produces an encoded binary string
and it’s better to be explicit with the encoding used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">dumpfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()))</span>
</pre></div>
</div>
<p>This is equivalent to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">rows</span><span class="o">.</span><span class="n">export_to_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>You can read the CSV file back with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">import_from_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>Again, you can be explict about the encoding for
the exporting file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">rows</span><span class="o">.</span><span class="n">export_to_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>and the importing one:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">import_from_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>When importing, py4web looks for the field names in the CSV header. In
this example, it finds two columns: “person.id” and “person.name”. It
ignores the “person.” prefix, and it ignores the “id” fields. Then all
records are appended and assigned new ids.</p>
</section>
<section id="csv-all-tables-at-once">
<h3>CSV (all tables at once)<a class="headerlink" href="#csv-all-tables-at-once" title="Permalink to this headline"></a></h3>
<p>In py4web, you can backup/restore an entire database with two commands:</p>
<p>To export:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;somefile.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">export_to_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>To import:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;somefile.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">import_from_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>This mechanism can be used even if the importing database is of a
different type than the exporting database.</p>
<p>The data is stored in “somefile.csv” as a CSV file where each table
starts with one line that indicates the tablename, and another line with
the fieldnames:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TABLE tablename
field1,field2,field3,...
</pre></div>
</div>
<p>Two tables are separated by <code class="docutils literal notranslate"><span class="pre">\r\n\r\n</span></code> (that is two empty lines). The
file ends with the line</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>END
</pre></div>
</div>
<p>The file does not include uploaded files if these are not stored in the
database. The upload files stored on filesystem must be dumped
separately, a zip of the “uploads” folder may suffice in most cases.</p>
<p>When importing, the new records will be appended to the database if it
is not empty. In general the new imported records will not have the same
record id as the original (saved) records but py4web will restore
references so they are not broken, even if the id values may change.</p>
<p>If a table contains a field called <code class="docutils literal notranslate"><span class="pre">uuid</span></code>, this field will be used to
identify duplicates. Also, if an imported record has the same <code class="docutils literal notranslate"><span class="pre">uuid</span></code>
as an existing record, the previous record will be updated.</p>
</section>
<section id="csv-and-remote-database-synchronization">
<h3>CSV and remote database synchronization<a class="headerlink" href="#csv-and-remote-database-synchronization" title="Permalink to this headline"></a></h3>
<p>Consider once again the following model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>

<span class="c1"># usage example</span>
<span class="k">if</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">isempty</span><span class="p">():</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Massimo&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Chair&#39;</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="n">nid</span><span class="p">)</span>
</pre></div>
</div>
<p>Each record is identified by an identifier and referenced by that id. If
you have two copies of the database used by distinct py4web
installations, the id is unique only within each database and not across
the databases. This is a problem when merging records from different
databases.</p>
<p>In order to make records uniquely identifiable across databases, they
must: - have a unique id (UUID), - have a last modification time to
track the most recent among multiple copies, - reference the UUID
instead of the id.</p>
<p>This can be achieved changing the above model into:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">64</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;modified_on&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">now</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">64</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;modified_on&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">now</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">64</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

<span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IN_DB</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;person.uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># usage example</span>
<span class="k">if</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">isempty</span><span class="p">():</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">nid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Massimo&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Chair&#39;</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="n">nid</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><p>Notice that in the above table definitions, the default value for the
two <code class="docutils literal notranslate"><span class="pre">uuid</span></code> fields is set to a lambda function, which returns a UUID
(converted to a string). The lambda function is called once for each
record inserted, ensuring that each record gets a unique UUID, even
if multiple records are inserted in a single transaction.</p>
</div></blockquote>
<p>Create a controller action to export the database:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">export</span><span class="p">():</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">export_to_csv_file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/csv&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</pre></div>
</div>
<p>Create a controller action to import a saved copy of the other database
and sync records:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">yatl.helpers</span> <span class="kn">import</span> <span class="n">FORM</span><span class="p">,</span> <span class="n">INPUT</span>

<span class="k">def</span> <span class="nf">import_and_sync</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">FORM</span><span class="p">(</span><span class="n">INPUT</span><span class="p">(</span><span class="n">_type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">),</span> <span class="n">INPUT</span><span class="p">(</span><span class="n">_type</span><span class="o">=</span><span class="s1">&#39;submit&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">process</span><span class="p">()</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">import_from_csv_file</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># for every table</span>
        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
            <span class="c1"># for every uuid, delete all but the latest</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                     <span class="n">orderby</span><span class="o">=~</span><span class="n">table</span><span class="o">.</span><span class="n">modified_on</span><span class="p">,</span>
                                     <span class="n">groupby</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">db</span><span class="p">((</span><span class="n">table</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></div>
</div>
<p>Optionally you should create an index manually to make the search by
uuid faster.</p>
<p>Alternatively, you can use XML-RPC to export/import the file.</p>
<p>If the records reference uploaded files, you also need to export/import
the content of the uploads folder. Notice that files therein are already
labeled by UUIDs so you do not need to worry about naming conflicts and
references.</p>
</section>
<section id="html-and-xml-one-table-at-a-time">
<h3>HTML and XML (one Table at a time)<a class="headerlink" href="#html-and-xml-one-table-at-a-time" title="Permalink to this headline"></a></h3>
<p>Rows objects also have an <code class="docutils literal notranslate"><span class="pre">xml</span></code> method (like helpers) that serializes
it to XML/HTML:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows</span><span class="o">.</span><span class="n">xml</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">table</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">thead</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;&lt;</span><span class="nt">th</span><span class="p">&gt;</span>person.id<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;&lt;</span><span class="nt">th</span><span class="p">&gt;</span>person.name<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>thing.id<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;&lt;</span><span class="nt">th</span><span class="p">&gt;</span>thing.name<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>thing.owner_id<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">thead</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tbody</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w2p_odd odd&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Alex<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Boat<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w2p_even even&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Alex<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>2<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Chair<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w2p_odd odd&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>2<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Bob<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>3<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Shoes<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>2<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tbody</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>If you need to serialize the Rows in any other XML format with custom
tags, you can easily do that using the universal <a class="reference internal" href="chapter-10.html#tag"><span class="std std-ref">TAG</span></a> helper
that we’ll see later and the Python syntax
<code class="docutils literal notranslate"><span class="pre">*&lt;iterable&gt;</span></code> allowed in function calls:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">TAG</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">TAG</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">TAG</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">_name</span><span class="o">=</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">fields</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;result&gt;</span>
<span class="nt">&lt;row&gt;&lt;field</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span><span class="nt">&gt;</span>1<span class="nt">&lt;/field&gt;&lt;field</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>Alex<span class="nt">&lt;/field&gt;&lt;/row&gt;</span>
<span class="nt">&lt;row&gt;&lt;field</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span><span class="nt">&gt;</span>2<span class="nt">&lt;/field&gt;&lt;field</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>Bob<span class="nt">&lt;/field&gt;&lt;/row&gt;</span>
<span class="nt">&lt;row&gt;&lt;field</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span><span class="nt">&gt;</span>3<span class="nt">&lt;/field&gt;&lt;field</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>Carl<span class="nt">&lt;/field&gt;&lt;/row&gt;</span>
<span class="nt">&lt;/result&gt;</span>
</pre></div>
</div>
</section>
<section id="data-representation">
<h3>Data representation<a class="headerlink" href="#data-representation" title="Permalink to this headline"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Rows.export_to_csv_file</span></code> method accepts a keyword argument named
<code class="docutils literal notranslate"><span class="pre">represent</span></code>. When <code class="docutils literal notranslate"><span class="pre">True</span></code> it will use the columns <code class="docutils literal notranslate"><span class="pre">represent</span></code>
function while exporting the data instead of the raw data.</p>
<p>The function also accepts a keyword argument named <code class="docutils literal notranslate"><span class="pre">colnames</span></code> that
should contain a list of column names one wish to export. It defaults to
all columns.</p>
<p>Both <code class="docutils literal notranslate"><span class="pre">export_to_csv_file</span></code> and <code class="docutils literal notranslate"><span class="pre">import_from_csv_file</span></code> accept keyword
arguments that tell the csv parser the format to save/load the files: -
<code class="docutils literal notranslate"><span class="pre">delimiter</span></code>: delimiter to separate values (default ‘,’) -
<code class="docutils literal notranslate"><span class="pre">quotechar</span></code>: character to use to quote string values (default to
double quotes) - <code class="docutils literal notranslate"><span class="pre">quoting</span></code>: quote system (default
<code class="docutils literal notranslate"><span class="pre">csv.QUOTE_MINIMAL</span></code>)</p>
<p>Here is some example usage:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">csv</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/tmp/test.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">oufile</span><span class="p">:</span>
    <span class="n">rows</span><span class="o">.</span><span class="n">export_to_csv_file</span><span class="p">(</span><span class="n">oufile</span><span class="p">,</span>
                            <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span>
                            <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span>
                            <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NONNUMERIC</span><span class="p">)</span>
</pre></div>
</div>
<p>Which would render something similar to</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&quot;hello&quot;|35|&quot;this is the text description&quot;|&quot;2013-03-03&quot;
</pre></div>
</div>
<p>For more information consult the official Python documentation</p>
</section>
</section>
<section id="advanced-features">
<h2>Advanced features<a class="headerlink" href="#advanced-features" title="Permalink to this headline"></a></h2>
<section id="list-type-and-contains">
<span id="id1"></span><h3><code class="docutils literal notranslate"><span class="pre">list:&lt;type&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">contains</span></code><a class="headerlink" href="#list-type-and-contains" title="Permalink to this headline"></a></h3>
<p>py4web provides the following special field types:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">:</span><span class="n">string</span>
<span class="nb">list</span><span class="p">:</span><span class="n">integer</span>
<span class="nb">list</span><span class="p">:</span><span class="n">reference</span> <span class="o">&lt;</span><span class="n">table</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>They can contain lists of strings, of integers and of references
respectively.</p>
<p>On Google App Engine NoSQL <code class="docutils literal notranslate"><span class="pre">list:string</span></code> is mapped into
<code class="docutils literal notranslate"><span class="pre">StringListProperty</span></code>, the other two are mapped into
<code class="docutils literal notranslate"><span class="pre">ListProperty(int)</span></code>. On relational databases they are mapped into text
fields which contain the list of items separated by <code class="docutils literal notranslate"><span class="pre">|</span></code>. For example
<code class="docutils literal notranslate"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3]</span></code> is mapped into <code class="docutils literal notranslate"><span class="pre">|1|2|3|</span></code>.</p>
<p>For lists of string the items are escaped so that any <code class="docutils literal notranslate"><span class="pre">|</span></code> in the item
is replaced by a <code class="docutils literal notranslate"><span class="pre">||</span></code>. Anyway this is an internal representation and
it is transparent to the user.</p>
<p>You can use <code class="docutils literal notranslate"><span class="pre">list:string</span></code>, for example, in the following way:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;product&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">,</span> <span class="s1">&#39;list:string&#39;</span><span class="p">))</span>
<span class="go">&lt;Table product (id, name, colors)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IN_SET</span><span class="p">((</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Toy Car&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">])</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">products</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">colors</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Toy Car [&#39;red&#39;, &#39;green&#39;]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">list:integer</span></code> works in the same way but the items must be integers.</p>
<p>As usual the requirements are enforced at the level of forms, not at the
level of <code class="docutils literal notranslate"><span class="pre">insert</span></code>.</p>
<blockquote>
<div><p>For <code class="docutils literal notranslate"><span class="pre">list:&lt;type&gt;</span></code> fields the <code class="docutils literal notranslate"><span class="pre">contains(value)</span></code> operator maps into
a non trivial query that checks for lists containing the <code class="docutils literal notranslate"><span class="pre">value</span></code>.
The <code class="docutils literal notranslate"><span class="pre">contains</span></code> operator also works for regular <code class="docutils literal notranslate"><span class="pre">string</span></code> and
<code class="docutils literal notranslate"><span class="pre">text</span></code> fields and it maps into a <code class="docutils literal notranslate"><span class="pre">LIKE</span> <span class="pre">'%value%'</span></code>.</p>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">list:reference</span></code> and the <code class="docutils literal notranslate"><span class="pre">contains(value)</span></code> operator are
particularly useful to de-normalize many-to-many relations. Here is an
example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="go">&lt;Table tag (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;product&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;list:reference tag&#39;</span><span class="p">))</span>
<span class="go">&lt;Table product (id, name, tags)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Toy Car&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">])</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">products</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Toy Car [1, 2, 3]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">represent</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">tags</span><span class="p">))</span>
<span class="gp">...</span>
<span class="go">Toy Car red, green, blue</span>
</pre></div>
</div>
<p>Notice that a <code class="docutils literal notranslate"><span class="pre">list:reference</span> <span class="pre">tag</span></code> field get a default constraint</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IN_DB</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">_format</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>that produces a <code class="docutils literal notranslate"><span class="pre">SELECT/OPTION</span></code> multiple drop-box in forms.</p>
<p>Also notice that this field gets a default <code class="docutils literal notranslate"><span class="pre">represent</span></code> attribute which
represents the list of references as a comma-separated list of formatted
references. This is used in read <code class="docutils literal notranslate"><span class="pre">forms</span></code>.</p>
<blockquote>
<div><p>While <code class="docutils literal notranslate"><span class="pre">list:reference</span></code> has a default validator and a default
representation, <code class="docutils literal notranslate"><span class="pre">list:integer</span></code> and <code class="docutils literal notranslate"><span class="pre">list:string</span></code> do not. So these
two need an <code class="docutils literal notranslate"><span class="pre">IS_IN_SET</span></code> or an <code class="docutils literal notranslate"><span class="pre">IS_IN_DB</span></code> validator if you want to
use them in forms.</p>
</div></blockquote>
</section>
<section id="table-inheritance">
<h3>Table inheritance<a class="headerlink" href="#table-inheritance" title="Permalink to this headline"></a></h3>
<p>It is possible to create a table that contains all the fields from
another table. It is sufficient to pass the other table in place of a
field to <code class="docutils literal notranslate"><span class="pre">define_table</span></code>. For example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;gender&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name, gender)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;doctor&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;specialization&#39;</span><span class="p">))</span>
<span class="go">&lt;Table doctor (id, name, gender, specialization)&gt;</span>
</pre></div>
</div>
<p>It is also possible to define a dummy table that is not stored in a
database in order to reuse it in multiple other places. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span>

<span class="n">signature</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;signature&#39;</span><span class="p">,</span>
                     <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;is_active&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                     <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;created_on&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">),</span>
                     <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;created_by&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">auth</span><span class="o">.</span><span class="n">user_id</span><span class="p">),</span>
                     <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;modified_on&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">now</span><span class="p">),</span>
                     <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;modified_by&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">auth</span><span class="o">.</span><span class="n">user_id</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;payment&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span> <span class="n">signature</span><span class="p">)</span>
</pre></div>
</div>
<p>This example assumes that standard py4web authentication is enabled.</p>
<p>Notice that if you use <code class="docutils literal notranslate"><span class="pre">Auth</span></code> py4web already creates one such table
for you:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">auth</span> <span class="o">=</span> <span class="n">Auth</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;payment&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span> <span class="n">auth</span><span class="o">.</span><span class="n">signature</span><span class="p">)</span>
</pre></div>
</div>
<p>When using table inheritance, if you want the inheriting table to
inherit validators, be sure to define the validators of the parent table
before defining the inheriting table.</p>
</section>
<section id="filter-in-and-filter-out">
<span id="id2"></span><h3><code class="docutils literal notranslate"><span class="pre">filter_in</span></code> and <code class="docutils literal notranslate"><span class="pre">filter_out</span></code><a class="headerlink" href="#filter-in-and-filter-out" title="Permalink to this headline"></a></h3>
<p>It is possible to define a filter for each field to be called before a
value is inserted into the database for that field and after a value is
retrieved from the database.</p>
<p>Imagine for example that you want to store a serializable Python data
structure in a field in the JSON format. Here is how it could be
accomplished:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">json</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;anyobj&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">))</span>
<span class="go">&lt;Table anyobj (id, name, data)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">anyobj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filter_in</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">anyobj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filter_out</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">txt</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">myobj</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="mi">3</span><span class="p">}]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">aid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">anyobj</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;myobjname&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">myobj</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">anyobj</span><span class="p">[</span><span class="n">aid</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">data</span>
<span class="go">[&#39;hello&#39;, &#39;world&#39;, 1, {&#39;2&#39;: 3}]</span>
</pre></div>
</div>
<p>Another way to accomplish the same is by using a Field of type
<code class="docutils literal notranslate"><span class="pre">SQLCustomType</span></code>, as discussed in <a class="reference internal" href="#custom-field-types"><span class="std std-ref">Custom Field types</span></a>.</p>
</section>
<section id="callbacks-on-record-insert-delete-and-update">
<h3>callbacks on record insert, delete and update<a class="headerlink" href="#callbacks-on-record-insert-delete-and-update" title="Permalink to this headline"></a></h3>
<p>PY4WEB provides a mechanism to register callbacks to be called before
and/or after insert, update and delete of records.</p>
<p>Each table stores six lists of callbacks:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>db.mytable._before_insert
db.mytable._after_insert
db.mytable._before_update
db.mytable._after_update
db.mytable._before_delete
db.mytable._after_delete
</pre></div>
</div>
<p>You can register a callback function by appending it to the
corresponding list. The caveat is that depending on the functionality,
the callback has different signature.</p>
<p>This is best explained by examples.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">pprint</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_before_insert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;before_insert&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_after_insert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;after_insert&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">)</span>
<span class="go">before_insert(&lt;OpRow {&#39;name&#39;: &#39;John&#39;}&gt;,)</span>
<span class="go">after_insert(&lt;OpRow {&#39;name&#39;: &#39;John&#39;}&gt;, 1)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_before_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;before_update&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_after_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;after_update&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Tim&#39;</span><span class="p">)</span>
<span class="go">before_update(&lt;Set (&quot;person&quot;.&quot;id&quot; = 1)&gt;, &lt;OpRow {&#39;name&#39;: &#39;Tim&#39;}&gt;)</span>
<span class="go">after_update(&lt;Set (&quot;person&quot;.&quot;id&quot; = 1)&gt;, &lt;OpRow {&#39;name&#39;: &#39;Tim&#39;}&gt;)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_before_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;before_delete&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_after_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;after_delete&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="go">before_delete(&lt;Set (&quot;person&quot;.&quot;id&quot; = 1)&gt;,)</span>
<span class="go">after_delete(&lt;Set (&quot;person&quot;.&quot;id&quot; = 1)&gt;,)</span>
<span class="go">1</span>
</pre></div>
</div>
<p>As you can see: - <code class="docutils literal notranslate"><span class="pre">f</span></code> gets passed the <code class="docutils literal notranslate"><span class="pre">OpRow</span></code> object with data for
insert or update. - <code class="docutils literal notranslate"><span class="pre">i</span></code> gets passed the id of the newly inserted
record. - <code class="docutils literal notranslate"><span class="pre">s</span></code> gets passed the <code class="docutils literal notranslate"><span class="pre">Set</span></code> object used for update or
delete. <code class="docutils literal notranslate"><span class="pre">OpRow</span></code> is an helper object specialized in storing (field,
value) pairs, you can think of it as a normal dictionary that you can
use even with the syntax of attribute notation (that is <code class="docutils literal notranslate"><span class="pre">f.name</span></code> and
<code class="docutils literal notranslate"><span class="pre">f['name']</span></code> are equivalent).</p>
<p>The return values of these callback should be <code class="docutils literal notranslate"><span class="pre">None</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code>. If
any of the <code class="docutils literal notranslate"><span class="pre">_before_*</span></code> callback returns a <code class="docutils literal notranslate"><span class="pre">True</span></code> value it will abort
the actual insert/update/delete operation.</p>
<p>Some times a callback may need to perform an update in the same or a
different table and one wants to avoid firing other callbacks, which
could cause an infinite loop.</p>
<p>For this purpose there the <code class="docutils literal notranslate"><span class="pre">Set</span></code> objects have an <code class="docutils literal notranslate"><span class="pre">update_naive</span></code>
method that works like <code class="docutils literal notranslate"><span class="pre">update</span></code> but ignores before and after
callbacks.</p>
<section id="database-cascades">
<h4>Database cascades<a class="headerlink" href="#database-cascades" title="Permalink to this headline"></a></h4>
<p>Database schema can define relationships which trigger deletions of
related records, known as cascading. The DAL is not informed when a
record is deleted due to a cascade. So no *_delete callback will ever
be called as consequence of a cascade-deletion.</p>
</section>
</section>
<section id="record-versioning">
<h3>Record versioning<a class="headerlink" href="#record-versioning" title="Permalink to this headline"></a></h3>
<p>It is possible to ask py4web to save every copy of a record when the
record is individually modified. There are different ways to do it and
it can be done for all tables at once using the syntax:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">auth</span><span class="o">.</span><span class="n">enable_record_versioning</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</pre></div>
</div>
<p>this requires <code class="docutils literal notranslate"><span class="pre">Auth</span></code>. It can also be done for each individual table as
discussed below.</p>
<p>Consider the following table:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;stored_item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;is_active&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
                      <span class="n">writable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">readable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
<p>Notice the hidden boolean field called <code class="docutils literal notranslate"><span class="pre">is_active</span></code> and defaulting to
True.</p>
<p>We can tell py4web to create a new table (in the same or a different
database) and store all previous versions of each record in the table,
when modified.</p>
<p>This is done in the following way:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">stored_item</span><span class="o">.</span><span class="n">_enable_record_versioning</span><span class="p">()</span>
</pre></div>
</div>
<p>or in a more verbose syntax:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">stored_item</span><span class="o">.</span><span class="n">_enable_record_versioning</span><span class="p">(</span><span class="n">archive_db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
                                         <span class="n">archive_name</span><span class="o">=</span><span class="s1">&#39;stored_item_archive&#39;</span><span class="p">,</span>
                                         <span class="n">current_record</span><span class="o">=</span><span class="s1">&#39;current_record&#39;</span><span class="p">,</span>
                                         <span class="n">is_active</span><span class="o">=</span><span class="s1">&#39;is_active&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">archive_db=db</span></code> tells py4web to store the archive table in the
same database as the <code class="docutils literal notranslate"><span class="pre">stored_item</span></code> table. The <code class="docutils literal notranslate"><span class="pre">archive_name</span></code> sets
the name for the archive table. The archive table has the same fields as
the original table <code class="docutils literal notranslate"><span class="pre">stored_item</span></code> except that unique fields are no
longer unique (because it needs to store multiple versions) and has an
extra field which name is specified by <code class="docutils literal notranslate"><span class="pre">current_record</span></code> and which is a
reference to the current record in the <code class="docutils literal notranslate"><span class="pre">stored_item</span></code> table.</p>
<p>When records are deleted, they are not really deleted. A deleted record
is copied in the <code class="docutils literal notranslate"><span class="pre">stored_item_archive</span></code> table (like when it is
modified) and the <code class="docutils literal notranslate"><span class="pre">is_active</span></code> field is set to False. By enabling
record versioning py4web sets a <code class="docutils literal notranslate"><span class="pre">common_filter</span></code> on this table that
hides all records in table <code class="docutils literal notranslate"><span class="pre">stored_item</span></code> where the <code class="docutils literal notranslate"><span class="pre">is_active</span></code> field
is set to False. The <code class="docutils literal notranslate"><span class="pre">is_active</span></code> parameter in the
<code class="docutils literal notranslate"><span class="pre">_enable_record_versioning</span></code> method allows to specify the name of the
field used by the <code class="docutils literal notranslate"><span class="pre">common_filter</span></code> to determine if the field was
deleted or not.</p>
</section>
<section id="common-filters">
<h3>Common filters<a class="headerlink" href="#common-filters" title="Permalink to this headline"></a></h3>
<p>A common filter is a generalization of the above multi-tenancy idea. It
provides an easy way to prevent repeating of the same query. Consider
for example the following table:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;blog_post&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;post_text&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;is_public&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">),</span>
                <span class="n">common_filter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">query</span><span class="p">:</span> <span class="n">db</span><span class="o">.</span><span class="n">blog_post</span><span class="o">.</span><span class="n">is_public</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Any select, delete or update in this table, will include only public
blog posts. The attribute can also be modified at runtime:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">blog_post</span><span class="o">.</span><span class="n">_common_filter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">query</span><span class="p">:</span> <span class="o">...</span>
</pre></div>
</div>
<p>It serves both as a way to avoid repeating the
“db.blog_post.is_public==True” phrase in each blog post search, and also
as a security enhancement, that prevents you from forgetting to disallow
viewing of non-public posts.</p>
<p>In case you actually do want items left out by the common filter (for
example, allowing the admin to see non-public posts), you can either
remove the filter:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">blog_post</span><span class="o">.</span><span class="n">_common_filter</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<p>or ignore it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">ignore_common_filters</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><p>Note that common_filters are ignored by the appadmin interface.</p>
</div></blockquote>
</section>
<section id="custom-field-types">
<span id="id3"></span><h3>Custom <code class="docutils literal notranslate"><span class="pre">Field</span></code> types<a class="headerlink" href="#custom-field-types" title="Permalink to this headline"></a></h3>
<p>Aside for using <code class="docutils literal notranslate"><span class="pre">filter_in</span></code> and <code class="docutils literal notranslate"><span class="pre">filter_out</span></code>, it is possible to
define new/custom field types. For example, suppose that you want to
define a custom type to store an IP address:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">ip2int</span><span class="p">(</span><span class="n">sv</span><span class="p">):</span>
<span class="gp">... </span>    <span class="s2">&quot;Convert an IPV4 to an integer.&quot;</span>
<span class="gp">... </span>    <span class="n">sp</span> <span class="o">=</span> <span class="n">sv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span> <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="c1"># IPV4 only</span>
<span class="gp">... </span>    <span class="n">iip</span> <span class="o">=</span> <span class="mi">0</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">sp</span><span class="p">):</span> <span class="n">iip</span> <span class="o">=</span> <span class="p">(</span><span class="n">iip</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">iip</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">int2ip</span><span class="p">(</span><span class="n">iv</span><span class="p">):</span>
<span class="gp">... </span>    <span class="s2">&quot;Convert an integer to an IPV4.&quot;</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="n">iv</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="gp">... </span>    <span class="n">iv</span> <span class="o">=</span> <span class="p">(</span><span class="n">iv</span><span class="p">,);</span> <span class="n">ov</span> <span class="o">=</span> <span class="p">[]</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">iv</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">256</span><span class="p">)</span>
<span class="gp">... </span>        <span class="n">ov</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="gp">... </span>    <span class="n">ov</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ov</span><span class="p">))</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pydal</span> <span class="kn">import</span> <span class="n">SQLCustomType</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ipv4</span> <span class="o">=</span> <span class="n">SQLCustomType</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">native</span><span class="o">=</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span>
<span class="gp">... </span>                     <span class="n">encoder</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">ip2int</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">decoder</span><span class="o">=</span><span class="n">int2ip</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;website&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;ipaddr&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">ipv4</span><span class="p">))</span>
<span class="go">&lt;Table website (id, name, ipaddr)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;wikipedia&#39;</span><span class="p">,</span> <span class="n">ipaddr</span><span class="o">=</span><span class="s1">&#39;91.198.174.192&#39;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;google&#39;</span><span class="p">,</span> <span class="n">ipaddr</span><span class="o">=</span><span class="s1">&#39;172.217.11.174&#39;</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;youtube&#39;</span><span class="p">,</span> <span class="n">ipaddr</span><span class="o">=</span><span class="s1">&#39;74.125.65.91&#39;</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;github&#39;</span><span class="p">,</span> <span class="n">ipaddr</span><span class="o">=</span><span class="s1">&#39;207.97.227.239&#39;</span><span class="p">)</span>
<span class="go">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">ipaddr</span> <span class="o">&gt;</span> <span class="s1">&#39;100.0.0.0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">orderby</span><span class="o">=~</span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">ipaddr</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">ipaddr</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">github 207.97.227.239</span>
<span class="go">google 172.217.11.174</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">SQLCustomType</span></code> is a field type factory. Its <code class="docutils literal notranslate"><span class="pre">type</span></code> argument must be
one of the standard py4web types. It tells py4web how to treat the field
values at the py4web level. <code class="docutils literal notranslate"><span class="pre">native</span></code> is the type of the field as far
as the database is concerned. Allowed names depend on the database
engine. <code class="docutils literal notranslate"><span class="pre">encoder</span></code> is an optional transformation function applied when
the data is stored and <code class="docutils literal notranslate"><span class="pre">decoder</span></code> is the optional reverse
transformation function.</p>
<blockquote>
<div><p>This feature is marked as experimental because can make your code not
portable across database engines.</p>
</div></blockquote>
<p>It does not work on Google App Engine NoSQL.</p>
</section>
<section id="using-dal-without-define-tables">
<h3>Using DAL without define tables<a class="headerlink" href="#using-dal-without-define-tables" title="Permalink to this headline"></a></h3>
<p>The DAL can be used from any Python program simply by doing this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pydal</span> <span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;path/to/app/databases&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>i.e. import the DAL, connect and specify the folder which contains the
.table files (the app/databases folder).</p>
<p>To access the data and its attributes we still have to define all the
tables we are going to access with <code class="docutils literal notranslate"><span class="pre">db.define_table</span></code>.</p>
<p>If we just need access to the data but not to the py4web table
attributes, we get away without re-defining the tables but simply asking
py4web to read the necessary info from the metadata in the .table files:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;path/to/app/databases&#39;</span><span class="p">,</span> <span class="n">auto_import</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>This allows us to access any db.table without need to re-define it.</p>
</section>
<section id="distributed-transaction">
<h3>Distributed transaction<a class="headerlink" href="#distributed-transaction" title="Permalink to this headline"></a></h3>
<blockquote>
<div><p>At the time of writing this feature is only supported by PostgreSQL,
MySQL and Firebird, since they expose API for two-phase commits.</p>
</div></blockquote>
<p>Assuming you have two (or more) connections to distinct PostgreSQL
databases, for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db_a</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;postgres://...&#39;</span><span class="p">)</span>
<span class="n">db_b</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;postgres://...&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In your models or controllers, you can commit them concurrently with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DAL</span><span class="o">.</span><span class="n">distributed_transaction_commit</span><span class="p">(</span><span class="n">db_a</span><span class="p">,</span> <span class="n">db_b</span><span class="p">)</span>
</pre></div>
</div>
<p>On failure, this function rolls back and raises an <code class="docutils literal notranslate"><span class="pre">Exception</span></code>.</p>
<p>In controllers, when one action returns, if you have two distinct
connections and you do not call the above function, py4web commits them
separately. This means there is a possibility that one of the commits
succeeds and one fails. The distributed transaction prevents this from
happening.</p>
</section>
<section id="copy-data-from-one-db-into-another">
<h3>Copy data from one db into another<a class="headerlink" href="#copy-data-from-one-db-into-another" title="Permalink to this headline"></a></h3>
<p>Consider the situation in which you have been using the following
database:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>and you wish to move to another database using a different connection
string:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;postgres://username:password@localhost/mydb&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Before you switch, you want to move the data and rebuild all the
metadata for the new database. We assume the new database to exist but
we also assume it is empty.</p>
</section>
</section>
<section id="gotchas">
<h2>Gotchas<a class="headerlink" href="#gotchas" title="Permalink to this headline"></a></h2>
<section id="note-on-new-dal-and-adapters">
<h3>Note on new DAL and adapters<a class="headerlink" href="#note-on-new-dal-and-adapters" title="Permalink to this headline"></a></h3>
<p>The source code of the Database Abstraction Layer was completely
rewritten in 2010. While it stays backward compatible, the rewrite made
it more modular and easier to extend. Here we explain the main logic.</p>
<p>The module “dal.py” defines, among other, the following classes.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ConnectionPool
BaseAdapter extends ConnectionPool
Row
DAL
Reference
Table
Expression
Field
Query
Set
Rows
</pre></div>
</div>
<p>Their use has been explained in the previous sections, except for
<code class="docutils literal notranslate"><span class="pre">BaseAdapter</span></code>. When the methods of a <code class="docutils literal notranslate"><span class="pre">Table</span></code> or <code class="docutils literal notranslate"><span class="pre">Set</span></code> object need
to communicate with the database they delegate to methods of the adapter
the task to generate the SQL and or the function call.</p>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;myvalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>calls</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;myvalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>which delegates the adapter by returning:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">_listify</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;myvalue&#39;</span><span class="p">)))</span>
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">db.mytable._listify</span></code> converts the dict of arguments into a list
of <code class="docutils literal notranslate"><span class="pre">(field,value)</span></code> and calls the <code class="docutils literal notranslate"><span class="pre">insert</span></code> method of the <code class="docutils literal notranslate"><span class="pre">adapter</span></code>.
<code class="docutils literal notranslate"><span class="pre">db._adapter</span></code> does more or less the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">,</span> <span class="n">list_of_fields</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>
</div>
<p>where the first line builds the query and the second executes it.</p>
<p><code class="docutils literal notranslate"><span class="pre">BaseAdapter</span></code> defines the interface for all adapters.</p>
<p>pyDAL at the moment of writing this book, contains the
following adapters:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SQLiteAdapter extends BaseAdapter
JDBCSQLiteAdapter extends SQLiteAdapter
MySQLAdapter extends BaseAdapter
PostgreSQLAdapter extends BaseAdapter
JDBCPostgreSQLAdapter extends PostgreSQLAdapter
OracleAdapter extends BaseAdapter
MSSQLAdapter extends BaseAdapter
MSSQL2Adapter extends MSSQLAdapter
MSSQL3Adapter extends MSSQLAdapter
MSSQL4Adapter extends MSSQLAdapter
FireBirdAdapter extends BaseAdapter
FireBirdEmbeddedAdapter extends FireBirdAdapter
InformixAdapter extends BaseAdapter
DB2Adapter extends BaseAdapter
IngresAdapter extends BaseAdapter
IngresUnicodeAdapter extends IngresAdapter
GoogleSQLAdapter extends MySQLAdapter
NoSQLAdapter extends BaseAdapter
GoogleDatastoreAdapter extends NoSQLAdapter
CubridAdapter extends MySQLAdapter (experimental)
TeradataAdapter extends DB2Adapter (experimental)
SAPDBAdapter extends BaseAdapter (experimental)
CouchDBAdapter extends NoSQLAdapter (experimental)
IMAPAdapter extends NoSQLAdapter (experimental)
MongoDBAdapter extends NoSQLAdapter (experimental)
VerticaAdapter extends MSSQLAdapter (experimental)
SybaseAdapter extends MSSQLAdapter (experimental)
</pre></div>
</div>
<p>which override the behavior of the <code class="docutils literal notranslate"><span class="pre">BaseAdapter</span></code>.</p>
<p>Each adapter has more or less this structure:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MySQLAdapter</span><span class="p">(</span><span class="n">BaseAdapter</span><span class="p">):</span>

    <span class="c1"># specify a driver to use</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pymysql&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># map py4web types into database types</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;boolean&#39;</span><span class="p">:</span> <span class="s1">&#39;CHAR(1)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="s1">&#39;VARCHAR(</span><span class="si">%(length)s</span><span class="s1">)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;LONGTEXT&#39;</span><span class="p">,</span>
        <span class="o">...</span>
        <span class="p">}</span>

    <span class="c1"># connect to the database using driver</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_codec</span> <span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span>
                 <span class="n">credential_decoder</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">,</span> <span class="n">driver_args</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">adapter_args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="c1"># parse uri string and store parameters in driver_args</span>
        <span class="o">...</span>
        <span class="c1"># define a connection function</span>
        <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">driver_args</span><span class="o">=</span><span class="n">driver_args</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">driver_args</span><span class="p">)</span>
        <span class="c1"># place it in the pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_connection</span><span class="p">(</span><span class="n">connect</span><span class="p">)</span>
        <span class="c1"># set optional parameters (after connection)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SET FOREIGN_KEY_CHECKS=1;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET sql_mode=&#39;NO_BACKSLASH_ESCAPES&#39;;&quot;</span><span class="p">)</span>

   <span class="c1"># override BaseAdapter methods as needed</span>
   <span class="k">def</span> <span class="nf">lastrowid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select last_insert_id();&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>Looking at the various adapters as example should be easy to write new
ones.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">db</span></code> instance is created:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;mysql://...&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>the prefix in the uri string defines the adapter. The mapping is defined
in the following dictionary also in “dal.py”:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>couchdb</p></td>
<td><p>pydal.adapters.couchdb.CouchDB</p></td>
</tr>
<tr class="row-even"><td><p>cubrid</p></td>
<td><p>pydal.adapters.mysql.Cubrid</p></td>
</tr>
<tr class="row-odd"><td><p>db2:ibm_db_dbi</p></td>
<td><p>pydal.adapters.db2.DB2IBM</p></td>
</tr>
<tr class="row-even"><td><p>db2:pyodbc</p></td>
<td><p>pydal.adapters.db2.DB2Pyodbc</p></td>
</tr>
<tr class="row-odd"><td><p>firebird</p></td>
<td><p>pydal.adapters.firebird.FireBird</p></td>
</tr>
<tr class="row-even"><td><p>firebird_embedded</p></td>
<td><p>pydal.adapters.firebird.FireBirdEmbedded</p></td>
</tr>
<tr class="row-odd"><td><p>google:MySQLdb</p></td>
<td><p>pydal.adapters.google.GoogleMySQL</p></td>
</tr>
<tr class="row-even"><td><p>google:datastore</p></td>
<td><p>pydal.adapters.google.GoogleDatastore</p></td>
</tr>
<tr class="row-odd"><td><p>google:datastore+ndb</p></td>
<td><p>pydal.adapters.google.GoogleDatastore</p></td>
</tr>
<tr class="row-even"><td><p>google:psycopg2</p></td>
<td><p>pydal.adapters.google.GooglePostgres</p></td>
</tr>
<tr class="row-odd"><td><p>google:sql</p></td>
<td><p>pydal.adapters.google.GoogleSQL</p></td>
</tr>
<tr class="row-even"><td><p>informix</p></td>
<td><p>pydal.adapters.informix.Informix</p></td>
</tr>
<tr class="row-odd"><td><p>informix-se</p></td>
<td><p>pydal.adapters.informix.InformixSE</p></td>
</tr>
<tr class="row-even"><td><p>ingres</p></td>
<td><p>pydal.adapters.ingres.Ingres</p></td>
</tr>
<tr class="row-odd"><td><p>ingresu</p></td>
<td><p>pydal.adapters.ingres.IngresUnicode</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="jdbc:postgres">jdbc:postgres</a></p></td>
<td><p>pydal.adapters.postgres.JDBCPostgre</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="jdbc:sqlite">jdbc:sqlite</a></p></td>
<td><p>pydal.adapters.sqlite.JDBCSQLite</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="jdbc:sqlite:memory">jdbc:sqlite:memory</a></p></td>
<td><p>pydal.adapters.sqlite.JDBCSQLite</p></td>
</tr>
<tr class="row-odd"><td><p>mongodb</p></td>
<td><p>pydal.adapters.mongo.Mongo</p></td>
</tr>
<tr class="row-even"><td><p>mssql</p></td>
<td><p>pydal.adapters.mssql.MSSQL1</p></td>
</tr>
<tr class="row-odd"><td><p>mssql2</p></td>
<td><p>pydal.adapters.mssql.MSSQL1N</p></td>
</tr>
<tr class="row-even"><td><p>mssql3</p></td>
<td><p>pydal.adapters.mssql.MSSQL3</p></td>
</tr>
<tr class="row-odd"><td><p>mssql3n</p></td>
<td><p>pydal.adapters.mssql.MSSQL3N</p></td>
</tr>
<tr class="row-even"><td><p>mssql4</p></td>
<td><p>pydal.adapters.mssql.MSSQL4</p></td>
</tr>
<tr class="row-odd"><td><p>mssql4n</p></td>
<td><p>pydal.adapters.mssql.MSSQL4N</p></td>
</tr>
<tr class="row-even"><td><p>mssqln</p></td>
<td><p>pydal.adapters.mssql.MSSQL1N</p></td>
</tr>
<tr class="row-odd"><td><p>mysql</p></td>
<td><p>pydal.adapters.mysql.MySQL</p></td>
</tr>
<tr class="row-even"><td><p>oracle</p></td>
<td><p>pydal.adapters.oracle.Oracle</p></td>
</tr>
<tr class="row-odd"><td><p>postgres</p></td>
<td><p>pydal.adapters.postgres.Postgre</p></td>
</tr>
<tr class="row-even"><td><p>postgres2</p></td>
<td><p>pydal.adapters.postgres.PostgreNew</p></td>
</tr>
<tr class="row-odd"><td><p>postgres2:psycopg2</p></td>
<td><p>pydal.adapters.postgres.PostgrePsycoNew</p></td>
</tr>
<tr class="row-even"><td><p>postgres3</p></td>
<td><p>pydal.adapters.postgres.PostgreBoolean</p></td>
</tr>
<tr class="row-odd"><td><p>postgres3:psycopg2</p></td>
<td><p>pydal.adapters.postgres.PostgrePsycoBoolean</p></td>
</tr>
<tr class="row-even"><td><p>postgres:psycopg2</p></td>
<td><p>pydal.adapters.postgres.PostgrePsyco</p></td>
</tr>
<tr class="row-odd"><td><p>pytds</p></td>
<td><p>pydal.adapters.mssql.PyTDS</p></td>
</tr>
<tr class="row-even"><td><p>sapdb</p></td>
<td><p>pydal.adapters.sap.SAPDB</p></td>
</tr>
<tr class="row-odd"><td><p>spatialite</p></td>
<td><p>pydal.adapters.sqlite.Spatialite</p></td>
</tr>
<tr class="row-even"><td><p>spatialite:memory</p></td>
<td><p>pydal.adapters.sqlite.Spatialite</p></td>
</tr>
<tr class="row-odd"><td><p>sqlite</p></td>
<td><p>pydal.adapters.sqlite.SQLite</p></td>
</tr>
<tr class="row-even"><td><p>sqlite:memory</p></td>
<td><p>pydal.adapters.sqlite.SQLite</p></td>
</tr>
<tr class="row-odd"><td><p>sybase</p></td>
<td><p>pydal.adapters.mssql.Sybase</p></td>
</tr>
<tr class="row-even"><td><p>teradata</p></td>
<td><p>pydal.adapters.teradata.Teradata</p></td>
</tr>
<tr class="row-odd"><td><p>vertica</p></td>
<td><p>pydal.adapters.mssql.Vertica</p></td>
</tr>
</tbody>
</table>
<p>the uri string is then parsed in more detail by the adapter itself.
An updated list of adapters can be obtained as dictionary with</p>
<p>For any adapter you can replace the driver with a different one
globally (not thread safe):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">MySQLdb</span> <span class="k">as</span> <span class="nn">mysqldb</span>
<span class="kn">from</span> <span class="nn">pydal.adapters.mysql</span> <span class="kn">import</span> <span class="n">SQLAdapter</span>
<span class="n">SQLAdapter</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">mysqldb</span>
</pre></div>
</div>
<p>i.e. <code class="docutils literal notranslate"><span class="pre">mysqldb</span></code> has to be <em>that module</em> with a .connect() method. You
can specify optional driver arguments and adapter arguments:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">driver_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">adapter_args</span><span class="o">=</span><span class="p">{})</span>
</pre></div>
</div>
<p>For recognized adapters you can also simply specify the name in the
<code class="docutils literal notranslate"><span class="pre">adapter_args</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pydal.adapters.mysql</span> <span class="kn">import</span> <span class="n">MySQL</span>
<span class="k">assert</span> <span class="s2">&quot;mysqldv&quot;</span> <span class="ow">in</span> <span class="n">MySQL</span><span class="o">.</span><span class="n">drivers</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">driver_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">adapter_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;mysqldb&quot;</span><span class="p">})</span>
</pre></div>
</div>
</section>
<section id="sqlite">
<h3>SQLite<a class="headerlink" href="#sqlite" title="Permalink to this headline"></a></h3>
<p>SQLite does not support dropping and altering columns. That means that
py4web migrations will work up to a point. If you delete a field from a
table, the column will remain in the database but will be invisible to
py4web. If you decide to reinstate the column, py4web will try re-create
it and fail. In this case you must set <code class="docutils literal notranslate"><span class="pre">fake_migrate=True</span></code> so that
metadata is rebuilt without attempting to add the column again. Also,
for the same reason, SQLite is not aware of any change of column
type. If you insert a number in a string field, it will be stored as
string. If you later change the model and replace the type “string” with
type “integer”, SQLite will continue to keep the number as a string and
this may cause problem when you try to extract the data.</p>
<p>SQLite doesn’t have a boolean type. py4web internally maps booleans to a
1 character string, with ‘T’ and ‘F’ representing True and False. The
DAL handles this completely; the abstraction of a true boolean value
works well. But if you are updating the SQLite table with SQL directly,
be aware of the py4web implementation, and avoid using 0 and 1 values.</p>
</section>
<section id="mysql">
<h3>MySQL<a class="headerlink" href="#mysql" title="Permalink to this headline"></a></h3>
<p>MySQL does not support multiple ALTER TABLE within a single transaction.
This means that any migration process is broken into multiple commits.
If something happens that causes a failure it is possible to break a
migration (the py4web metadata are no longer in sync with the actual
table structure in the database). This is unfortunate but it can be
prevented (migrate one table at the time) or it can be fixed in the
aftermath (revert the py4web model to what corresponds to the table
structure in database, set <code class="docutils literal notranslate"><span class="pre">fake_migrate=True</span></code> and after the metadata
has been rebuilt, set <code class="docutils literal notranslate"><span class="pre">fake_migrate=False</span></code> and migrate the table
again).</p>
</section>
<section id="google-sql">
<h3>Google SQL<a class="headerlink" href="#google-sql" title="Permalink to this headline"></a></h3>
<p>Google SQL has the same problems as MySQL and more. In particular table
metadata itself must be stored in the database in a table that is not
migrated by py4web. This is because Google App Engine has a read-only
file system. PY4WEB migrations in Google SQL combined with the MySQL
issue described above can result in metadata corruption. Again, this can
be prevented (by migrating the table at once and then setting
migrate=False so that the metadata table is not accessed any more) or it
can fixed in the aftermath (by accessing the database using the Google
dashboard and deleting any corrupted entry from the table called
<code class="docutils literal notranslate"><span class="pre">py4web_filesystem</span></code>.</p>
</section>
<section id="mssql-microsoft-sql-server">
<h3>MSSQL (Microsoft SQL Server)<a class="headerlink" href="#mssql-microsoft-sql-server" title="Permalink to this headline"></a></h3>
<p>MSSQL &lt; 2012 does not support the SQL OFFSET keyword. Therefore the
database cannot do pagination. When doing a <code class="docutils literal notranslate"><span class="pre">limitby=(a,</span> <span class="pre">b)</span></code> py4web
will fetch the first <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span></code> rows and discard the first <code class="docutils literal notranslate"><span class="pre">a</span></code>. This
may result in a considerable overhead when compared with other database
engines. If you’re using MSSQL &gt;= 2005, the recommended prefix to use is
<code class="docutils literal notranslate"><span class="pre">mssql3://</span></code> which provides a method to avoid the issue of fetching the
entire non-paginated resultset. If you’re on MSSQL &gt;= 2012, use
<code class="docutils literal notranslate"><span class="pre">mssql4://</span></code> that uses the
<code class="docutils literal notranslate"><span class="pre">OFFSET</span> <span class="pre">...</span> <span class="pre">ROWS</span> <span class="pre">...</span> <span class="pre">FETCH</span> <span class="pre">NEXT</span> <span class="pre">...</span> <span class="pre">ROWS</span> <span class="pre">ONLY</span></code> construct to support
natively pagination without performance hits like other backends. The
<code class="docutils literal notranslate"><span class="pre">mssql://</span></code> uri also enforces (for historical reasons) the use of
<code class="docutils literal notranslate"><span class="pre">text</span></code> columns, that are superseeded in more recent versions (from
2005 onwards) by <code class="docutils literal notranslate"><span class="pre">varchar(max)</span></code>. <code class="docutils literal notranslate"><span class="pre">mssql3://</span></code> and <code class="docutils literal notranslate"><span class="pre">mssql4://</span></code>
should be used if you don’t want to face some limitations of the -
officially deprecated - <code class="docutils literal notranslate"><span class="pre">text</span></code> columns.</p>
<p>MSSQL has problems with circular references in tables that have ONDELETE
CASCADE. This is an MSSQL bug and you work around it by setting the
ondelete attribute for all reference fields to “NO ACTION”. You can also
do it once and for all before you define tables:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;mssql://....&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">types</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39; ON DELETE </span><span class="si">%(on_delete_action)s</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(on_delete_action)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;NO ACTION&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>MSSQL also has problems with arguments passed to the DISTINCT keyword
and therefore while this works,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">distinct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>this does not</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">distinct</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="oracle">
<h3>Oracle<a class="headerlink" href="#oracle" title="Permalink to this headline"></a></h3>
<p>Oracle also does not support pagination. It does not support neither the
OFFSET nor the LIMIT keywords. PY4WEB achieves pagination by translating
a <code class="docutils literal notranslate"><span class="pre">db(...).select(limitby=(a,</span> <span class="pre">b))</span></code> into a complex three-way nested
select (as suggested by official Oracle documentation). This works for
simple select but may break for complex selects involving aliased fields
and or joins.</p>
</section>
<section id="google-nosql-datastore">
<h3>Google NoSQL (Datastore)<a class="headerlink" href="#google-nosql-datastore" title="Permalink to this headline"></a></h3>
<p>Google NoSQL (Datastore) does not allow joins, left joins, aggregates,
expression, OR involving more than one table, the ‘like’ operator
searches in “text” fields.</p>
<p>Transactions are limited and not provided automatically by py4web (you
need to use the Google API <code class="docutils literal notranslate"><span class="pre">run_in_transaction</span></code> which you can look up
in the Google App Engine documentation online).</p>
<p>Google also limits the number of records you can retrieve in each one
query (1000 at the time of writing). On the Google datastore record IDs
are integer but they are not sequential. While on SQL the “list:string”
type is mapped into a “text” type, on the Google Datastore it is mapped
into a <code class="docutils literal notranslate"><span class="pre">ListStringProperty</span></code>. Similarly “list:integer” and
“list:reference” are mapped into <code class="docutils literal notranslate"><span class="pre">ListProperty</span></code>. This makes searches
for content inside these fields types more efficient on Google NoSQL
than on SQL databases.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="chapter-06.html" class="btn btn-neutral float-left" title="Fixtures" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="chapter-08.html" class="btn btn-neutral float-right" title="The RestAPI" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, BSDv3 License.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      
      
     <span class="fa fa-element">
     <input class="container_toggle" type="checkbox" id="switch" name="mode">
     <label for="switch"></label>
     </span>
      
      v: 1.20220222.1
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl>
        <dt>Languages</dt>
        
           <strong> 
          <dd><a href="../en/index.html">en</a></dd> </strong>
          
        
          
          
          <dd><a href="../pt/index.html">pt</a></dd> 
        
      </dl>
      
      
      <dl>
        <dt>Versions</dt>
        
          
          <dd><a href="index.html">current</a></dd>
          
        
      </dl>
      
      
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="py4web_en.pdf">pdf</a></dd>
        
          <dd><a href="py4web_en.epub">epub</a></dd>
        
      </dl>
      
      
      <hr/>
    </div>
  </div>

 <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
         .wy-nav-content { max-width: none; }
  </style>



</body>
</html>