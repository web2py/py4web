

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Fixtures &mdash; py4web 1.20201112.1
 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/toggle.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/js/toggle.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="The database abstraction layer (DAL)" href="chapter-07.html" />
    <link rel="prev" title="Creating your first app" href="chapter-05.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> py4web
          

          
          </a>

          
            
            
              <div class="version">
                1.20201112.1

              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="chapter-01.html">What is py4web?</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-02.html">Help, resources and hints</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-03.html">Installation and Startup</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-04.html">The Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-05.html">Creating your first app</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Fixtures</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#important-about-fixtures">Important about Fixtures</a></li>
<li class="toctree-l2"><a class="reference internal" href="#py4web-templates">Py4web templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sessions">Sessions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#session-in-memcache">Session in memcache</a></li>
<li class="toctree-l3"><a class="reference internal" href="#session-in-redis">Session in redis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#session-in-database">Session in database</a></li>
<li class="toctree-l3"><a class="reference internal" href="#session-anywhere">Session anywhere</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#translator">Translator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-flash-fixture">The Flash fixture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-dal-fixture">The DAL fixture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#caveats-about-fixtures">Caveats about Fixtures</a></li>
<li class="toctree-l2"><a class="reference internal" href="#custom-fixtures">Custom fixtures</a></li>
<li class="toctree-l2"><a class="reference internal" href="#auth-and-auth-user">Auth and Auth.user</a></li>
<li class="toctree-l2"><a class="reference internal" href="#caching-and-memoize">Caching and Memoize</a></li>
<li class="toctree-l2"><a class="reference internal" href="#convenience-decorators">Convenience Decorators</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="chapter-07.html">The database abstraction layer (DAL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-08.html">The RESTAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-09.html">YATL Template Language</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-10.html">YATL helpers</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-11.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-12.html">Forms</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-13.html">Authentication and Access control</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-14.html">Grid</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-15.html">From web2py to py4web</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">py4web</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Fixtures</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/web2py/py4web/blob/master/docs/chapter-06.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="fixtures">
<h1>Fixtures<a class="headerlink" href="#fixtures" title="Permalink to this headline">¶</a></h1>
<p>A fixture is defined as “a piece of equipment or furniture which is
fixed in position in a building or vehicle”. In our case a fixture is
something attached to the action that processes an HTTP request in order
to produce a response.</p>
<p>When processing any HTTP requests there are some optional operations we
may want to perform. For example parse the cookie to look for session
information, commit a database transaction, determine the preferred
language from the HTTP header and lookup proper internationalization,
etc. These operations are optional. Some actions need them and some
actions do not. They may also depend on each other. For example, if
sessions are stored in the database and our action needs it, we may need
to parse the session cookie from the header, pick up a connection from
the database connection pool, and - after the action has been executed -
save the session back in the database if data has changed.</p>
<p>PY4WEB fixtures provide a mechanism to specify what an action needs so
that py4web can accomplish the required tasks (and skip non required
ones) in the most efficient manner. Fixtures make the code efficient and
reduce the need for boilerplate code.</p>
<p>PY4WEB fixtures are similar to WSGI middleware and BottlePy plugin
except that they apply to individual actions, not to all of them, and
can depend on each other.</p>
<p>PY4WEB comes with some pre-defined fixtures for actions that need
sessions, database connections, internationalization, authentication,
and templates. Their usage will be explained in this chapter. The
Developer is also free to add fixtures, for example, to handle a third
party template language or third party session logic.</p>
<div class="section" id="important-about-fixtures">
<h2>Important about Fixtures<a class="headerlink" href="#important-about-fixtures" title="Permalink to this headline">¶</a></h2>
<p>In the examples below we will explain how to apply individual fixtures.
In practice fixtures can be applied in groups. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">preferred</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">Session</span><span class="p">,</span> <span class="n">Auth</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Flash</span><span class="p">)</span>
</pre></div>
</div>
<p>Then you can apply all of the at once with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">)</span>
<span class="nd">@preferred</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="py4web-templates">
<h2>Py4web templates<a class="headerlink" href="#py4web-templates" title="Permalink to this headline">¶</a></h2>
<p>PY4WEB, by default uses the yatl template language and provides a
fixture for it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">action</span>
<span class="kn">from</span> <span class="nn">py4web.core</span> <span class="kn">import</span> <span class="n">Template</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">delimiters</span><span class="o">=</span><span class="s1">&#39;[[ ]]&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Hello world&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note: This example assumes that you created the application from the
scaffolding app, so that the template index.html is already created for
you.</p>
<p>The Template object is a Fixture. It transforms the <code class="docutils literal notranslate"><span class="pre">dict()</span></code> returned
by the action into a string by using the <code class="docutils literal notranslate"><span class="pre">index.html</span></code> template file.
In a later chapter we will provide an example of how to define a custom
fixture to use a different template language, for example Jinja2.</p>
<p>Notice that since the use of templates is very common and since, most
likely, every action uses a different template, we provide some
syntactic sugar, and the two following lines are equivalent:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">delimiters</span><span class="o">=</span><span class="s1">&#39;[[ ]]&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that py4web template files are cached in RAM. The py4web caching
object is described later.</p>
</div>
<div class="section" id="sessions">
<h2>Sessions<a class="headerlink" href="#sessions" title="Permalink to this headline">¶</a></h2>
<p>The session object is also a Fixture. Here is a typical example of usage
to implement a counter.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">action</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">secret</span><span class="o">=</span><span class="s1">&#39;my secret key&#39;</span><span class="p">)</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;counter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter</span>
    <span class="k">return</span> <span class="s2">&quot;counter = </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">counter</span>
</pre></div>
</div>
<p>Notice that the session object has the same interface as a Python
dictionary.</p>
<p>By default the session object is stored in a cookie called, signed and
encrypted, using the provided secret. If the secret changes existing
sessions are invalidated. If the user switches from HTTP to HTTPS or
vice versa, the user session is invalidated. Session in cookies have a
small size limit (4Kbytes after being serialized and encrypted) so do
not put too much into them.</p>
<p>In py4web sessions are dictionaries but they are stored using JSON (JWT
specifically) therefore you should only store objects that are JSON
serializable. If the object is not JSON serializable, it will be
serialized using the <code class="docutils literal notranslate"><span class="pre">__str__</span></code> operator and some information may be
lost.</p>
<p>By default py4web sessions never expire (unless they contain login
information, but that is another story) even if an expiration can be
set. Other parameters can be specified as well:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">secret</span><span class="o">=</span><span class="s1">&#39;my secret key&#39;</span><span class="p">,</span>
                  <span class="n">expiration</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>
                  <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;HS256&#39;</span><span class="p">,</span>
                  <span class="n">storage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">same_site</span><span class="o">=</span><span class="s1">&#39;Lax&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Here <code class="docutils literal notranslate"><span class="pre">algorithm</span></code> is the algorithm to be used for the JWT token
signature.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">storage</span></code> is a parameter that allows to specify an alternate
session storage method (for example redis, or database).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">same_site</span></code> is an option that prevents CSRF attacks and is enabled
by default. You can read more about it
<a class="reference external" href="https://www.owasp.org/index.php/SameSite">here</a>.</p></li>
</ul>
<div class="section" id="session-in-memcache">
<h3>Session in memcache<a class="headerlink" href="#session-in-memcache" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">memcache</span><span class="o">,</span> <span class="nn">time</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">memcache</span><span class="o">.</span><span class="n">Client</span><span class="p">([</span><span class="s1">&#39;127.0.0.1:11211&#39;</span><span class="p">],</span> <span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that a secret is not required when storing cookies in memcache
because in this case the cookie only contains the UUID of the session.</p>
</div>
<div class="section" id="session-in-redis">
<h3>Session in redis<a class="headerlink" href="#session-in-redis" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">redis</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">set</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">cs</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">set</span><span class="p">,</span> <span class="n">ct</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">ttl</span><span class="p">:</span> <span class="p">(</span><span class="n">cs</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="n">e</span> <span class="ow">and</span> <span class="n">ct</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice: a storage object must have <code class="docutils literal notranslate"><span class="pre">get</span></code> and <code class="docutils literal notranslate"><span class="pre">set</span></code> methods and the
<code class="docutils literal notranslate"><span class="pre">set</span></code> method must allow to specify an expiration. The redis connection
object has a <code class="docutils literal notranslate"><span class="pre">ttl</span></code> method to specify the expiration, hence we monkey
patch the <code class="docutils literal notranslate"><span class="pre">set</span></code> method to have the expected signature and
functionality.</p>
</div>
<div class="section" id="session-in-database">
<h3>Session in database<a class="headerlink" href="#session-in-database" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">DAL</span>
<span class="kn">from</span> <span class="nn">py4web.utils.dbstore</span> <span class="kn">import</span> <span class="n">DBStore</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite:memory&#39;</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span>  <span class="n">Session</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">DBStore</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
</pre></div>
</div>
<p>A secret is not required when storing cookies in the database because in
this case the cookie only contains the UUID of the session.</p>
<p>Also this is one case when the a fixture (session) requires another
fixture (db). This is handled automatically by py4web and the following
are equivalent:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="session-anywhere">
<h3>Session anywhere<a class="headerlink" href="#session-anywhere" title="Permalink to this headline">¶</a></h3>
<p>You can easily store sessions in any place you want. All you need to do
is provide to the <code class="docutils literal notranslate"><span class="pre">Session</span></code> object a <code class="docutils literal notranslate"><span class="pre">storage</span></code> object with both
<code class="docutils literal notranslate"><span class="pre">get</span></code> and <code class="docutils literal notranslate"><span class="pre">set</span></code> methods. For example, imagine you want to store
sessions on your local filesystem:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">class</span> <span class="nc">FSStorage</span><span class="p">:</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="n">folder</span>
   <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
       <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
       <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
           <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
              <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
       <span class="k">return</span> <span class="kc">None</span>
   <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">expiration</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
       <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
       <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
           <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">FSStorage</span><span class="p">(</span><span class="s1">&#39;/tmp/sessions&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>We leave to you as an exercise to implement expiration, limit the number
of files per folder by using subfolders, and implement file locking. Yet
we do not recomment storing sessions on the filesystem: it is
inefficient and does not scale well.</p>
</div>
</div>
<div class="section" id="translator">
<h2>Translator<a class="headerlink" href="#translator" title="Permalink to this headline">¶</a></h2>
<p>Here is an example of usage:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">action</span><span class="p">,</span> <span class="n">Translator</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">T_FOLDER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;translations&#39;</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">Translator</span><span class="p">(</span><span class="n">T_FOLDER</span><span class="p">)</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="s1">&#39;Hello world&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>The string ’hello world` will be translated based on the
internationalization file in the specified “translations” folder that
best matches the HTTP <code class="docutils literal notranslate"><span class="pre">accept-language</span></code> header.</p>
<p>Here <code class="docutils literal notranslate"><span class="pre">Translator</span></code> is a py4web class that extends
<code class="docutils literal notranslate"><span class="pre">pluralize.Translator</span></code> and also implements the <code class="docutils literal notranslate"><span class="pre">Fixture</span></code> interface.</p>
<p>We can easily combine multiple fixtures. Here, as example, we make
action with a counter that counts “visits”.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">action</span><span class="p">,</span> <span class="n">Session</span><span class="p">,</span> <span class="n">Translator</span><span class="p">,</span> <span class="n">DAL</span>
<span class="kn">from</span> <span class="nn">py4web.utils.dbstore</span> <span class="kn">import</span> <span class="n">DBStore</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite:memory&#39;</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span>  <span class="n">Session</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">DBStore</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
<span class="n">T_FOLDER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;translations&#39;</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">Translator</span><span class="p">(</span><span class="n">T_FOLDER</span><span class="p">)</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;counter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="s2">&quot;You have been here </span><span class="si">{n}</span><span class="s2"> times&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">counter</span><span class="p">))</span>
</pre></div>
</div>
<p>Now create the following translation file <code class="docutils literal notranslate"><span class="pre">translations/en.json</span></code>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;You have been here {n} times&quot;</span><span class="p">:</span>
  <span class="p">{</span>
    <span class="nt">&quot;0&quot;</span><span class="p">:</span> <span class="s2">&quot;This your first time here&quot;</span><span class="p">,</span>
    <span class="nt">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;You have been here once before&quot;</span><span class="p">,</span>
    <span class="nt">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;You have been here twice before&quot;</span><span class="p">,</span>
    <span class="nt">&quot;3&quot;</span><span class="p">:</span> <span class="s2">&quot;You have been here {n} times&quot;</span><span class="p">,</span>
    <span class="nt">&quot;6&quot;</span><span class="p">:</span> <span class="s2">&quot;You have been here more than 5 times&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When visiting this site with the browser language preference set to
english and reloading multiple times you will get the following
messages:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">This</span> <span class="n">your</span> <span class="n">first</span> <span class="n">time</span> <span class="n">here</span>
<span class="n">You</span> <span class="n">have</span> <span class="n">been</span> <span class="n">here</span> <span class="n">once</span> <span class="n">before</span>
<span class="n">You</span> <span class="n">have</span> <span class="n">been</span> <span class="n">here</span> <span class="n">twice</span> <span class="n">before</span>
<span class="n">You</span> <span class="n">have</span> <span class="n">been</span> <span class="n">here</span> <span class="mi">3</span> <span class="n">times</span>
<span class="n">You</span> <span class="n">have</span> <span class="n">been</span> <span class="n">here</span> <span class="mi">4</span> <span class="n">times</span>
<span class="n">You</span> <span class="n">have</span> <span class="n">been</span> <span class="n">here</span> <span class="mi">5</span> <span class="n">times</span>
<span class="n">You</span> <span class="n">have</span> <span class="n">been</span> <span class="n">here</span> <span class="n">more</span> <span class="n">than</span> <span class="mi">5</span> <span class="n">times</span>
</pre></div>
</div>
<p>Now try create a file called <code class="docutils literal notranslate"><span class="pre">translations/it.json</span></code> which contains:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;You have been here {n} times&quot;</span><span class="p">:</span>
  <span class="p">{</span>
    <span class="nt">&quot;0&quot;</span><span class="p">:</span> <span class="s2">&quot;Non ti ho mai visto prima&quot;</span><span class="p">,</span>
    <span class="nt">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;Ti ho gia&#39; visto&quot;</span><span class="p">,</span>
    <span class="nt">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;Ti ho gia&#39; visto 2 volte&quot;</span><span class="p">,</span>
    <span class="nt">&quot;3&quot;</span><span class="p">:</span> <span class="s2">&quot;Ti ho visto {n} volte&quot;</span><span class="p">,</span>
    <span class="nt">&quot;6&quot;</span><span class="p">:</span> <span class="s2">&quot;Ti ho visto piu&#39; di 5 volte&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and set your browser preference to Italian.</p>
</div>
<div class="section" id="the-flash-fixture">
<h2>The Flash fixture<a class="headerlink" href="#the-flash-fixture" title="Permalink to this headline">¶</a></h2>
<p>It is common to want to display “alerts” to the suers. Here we refer to
them as flash messeges. There is a little more to it than just
displaying a message to the view because flash messages can have state
that must be preserved after redirection. Also they can be generated
both server side and client side, there can be only one at the time,
they may have a type, and they should be dismissible.</p>
<p>The Flash helper handles the server side of them. Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">Flash</span>

<span class="n">flash</span> <span class="o">=</span> <span class="n">Flash</span><span class="p">()</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">Flash</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">flash</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;Hello World&quot;</span><span class="p">,</span> <span class="n">_class</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">sanitize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>
</pre></div>
</div>
<p>and in the template:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;py4web-flash&quot;</span><span class="o">&gt;&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="o">...</span>
<span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;js/utils.js&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="p">[[</span><span class="k">if</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flash&#39;</span><span class="p">):]]</span><span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span><span class="n">utils</span><span class="o">.</span><span class="n">flash</span><span class="p">([[</span><span class="o">=</span><span class="n">XML</span><span class="p">(</span><span class="n">flash</span><span class="p">)]]);</span><span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span><span class="p">[[</span><span class="k">pass</span><span class="p">]]</span>
</pre></div>
</div>
<p>By setting the value of the message in the flash helper, a flash
variable is returned by the action and this trigger the JS in the
template to inject the message in the <code class="docutils literal notranslate"><span class="pre">#py4web-flash</span></code> DIV which you
can position at your convenience. Also the optional class is applied to
the injected HTML.</p>
<p>If a page is redirected after a flash is set, the flash is remembered.
This is achieved by asking the browser to keep the message temporarily
in a one-time cookie. After redirection the message is sent back by the
browser to the server and the server sets it again automatically before
returning content, unless it is overwritten by another set.</p>
<p>The client can also set/add flash messages by calling:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">utils</span><span class="o">.</span><span class="n">flash</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;hello world&#39;</span><span class="p">,</span> <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;info&#39;</span><span class="p">});</span>
</pre></div>
</div>
<p>py4web defaults to an alert class called <code class="docutils literal notranslate"><span class="pre">default</span></code> and most CSS
frameworks define classes for alerts called <code class="docutils literal notranslate"><span class="pre">success</span></code>, <code class="docutils literal notranslate"><span class="pre">error</span></code>,
<code class="docutils literal notranslate"><span class="pre">warning</span></code>, <code class="docutils literal notranslate"><span class="pre">default</span></code>, and <code class="docutils literal notranslate"><span class="pre">info</span></code>. Yet, there is nothing in py4web
that hardcodes those names. You can use your own class names.</p>
</div>
<div class="section" id="the-dal-fixture">
<h2>The DAL fixture<a class="headerlink" href="#the-dal-fixture" title="Permalink to this headline">¶</a></h2>
<p>We have already used the <code class="docutils literal notranslate"><span class="pre">DAL</span></code> fixture in the context of sessions but
maybe you want direct access to the DAL object for the purpose of
accessing the database, not just sessions.</p>
<p>PY4WEB, by default, uses the PyDAL (Python Database Abstraction Layer)
which is documented in a later chapter. Here is an example, please
remember to create the <code class="docutils literal notranslate"><span class="pre">databases</span></code> folder under your project in case
it doesn’t exist:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">action</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">DB_FOLDER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;databases&#39;</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.db&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">DB_FOLDER</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;visit_log&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;client_ip&#39;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">))</span>
<span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">client_ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">visit_log</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">client_ip</span><span class="o">=</span><span class="n">client_ip</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
    <span class="k">return</span> <span class="s2">&quot;Your visit was stored in database&quot;</span>
</pre></div>
</div>
<p>Notice that the database fixture defines (creates/re-creates tables)
automatically when py4web starts (and every time it reloads this app)
and picks a connection from the connection pool at every HTTP request.
Also each call to the <code class="docutils literal notranslate"><span class="pre">index()</span></code> action is wrapped into a transaction
and it commits <code class="docutils literal notranslate"><span class="pre">on_success</span></code> and rolls back <code class="docutils literal notranslate"><span class="pre">on_error</span></code>.</p>
</div>
<div class="section" id="caveats-about-fixtures">
<h2>Caveats about Fixtures<a class="headerlink" href="#caveats-about-fixtures" title="Permalink to this headline">¶</a></h2>
<p>Since fixtures are shared by multiple actions you are not allowed to
change their state because it would not be thread safe. There is one
exception to this rule. Actions can change some attributes of database
fields:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">Field</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">py4web.utils.form</span> <span class="kn">import</span> <span class="n">Form</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">DB_FOLDER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;databases&#39;</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.db&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">DB_FOLDER</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">writable</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;generic.html&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">writable</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Note thas this code will only be able to display a form, to process it
after submit, additional code needs to be added, as we will see later
on. This example is assuming that you created the application from the
scaffolding app, so that a generic.html is already created for you.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">readable</span></code>, <code class="docutils literal notranslate"><span class="pre">writable</span></code>, <code class="docutils literal notranslate"><span class="pre">default</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>, and <code class="docutils literal notranslate"><span class="pre">require</span></code>
attributes of <code class="docutils literal notranslate"><span class="pre">db.{table}.{field}</span></code> are special objects of class
<code class="docutils literal notranslate"><span class="pre">ThreadSafeVariable</span></code> defined the <code class="docutils literal notranslate"><span class="pre">threadsafevariable</span></code> module. These
objects are very much like Python thread local objects but they are
re-initialized at every request using the value specified outside of the
action. This means that actions can safely change the values of these
attributes.</p>
</div>
<div class="section" id="custom-fixtures">
<h2>Custom fixtures<a class="headerlink" href="#custom-fixtures" title="Permalink to this headline">¶</a></h2>
<p>A fixture is an object with the following minimal structure:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">Fixture</span>

<span class="k">class</span> <span class="nc">MyFixture</span><span class="p">(</span><span class="n">Fixture</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">on_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">on_success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span> <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
<p>if an action uses this fixture:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">MyFixture</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span> <span class="k">return</span> <span class="s1">&#39;hello world&#39;</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">on_request()</span></code> is guaranteed to be called before the <code class="docutils literal notranslate"><span class="pre">index()</span></code>
function is called. The <code class="docutils literal notranslate"><span class="pre">on_success()</span></code> is guaranteed to be called if
the <code class="docutils literal notranslate"><span class="pre">index()</span></code> function returns successfully or raises <code class="docutils literal notranslate"><span class="pre">HTTP</span></code> or
performs a <code class="docutils literal notranslate"><span class="pre">redirect</span></code>. The <code class="docutils literal notranslate"><span class="pre">on_error()</span></code> is guaranteed to be called
when the <code class="docutils literal notranslate"><span class="pre">index()</span></code> function raises any exception other than <code class="docutils literal notranslate"><span class="pre">HTTP</span></code>.
The <code class="docutils literal notranslate"><span class="pre">transform</span></code> function is called to perform any desired
transformation of the value returned by the <code class="docutils literal notranslate"><span class="pre">index()</span></code> function.</p>
</div>
<div class="section" id="auth-and-auth-user">
<h2>Auth and Auth.user<a class="headerlink" href="#auth-and-auth-user" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">auth</span></code> and <code class="docutils literal notranslate"><span class="pre">auth.user</span></code> are both fixtures. They depend on
<code class="docutils literal notranslate"><span class="pre">session</span></code>. The role of access is to provide the action with
authentication information. It is used as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">action</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">Session</span><span class="p">,</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">URL</span>
<span class="kn">from</span> <span class="nn">py4web.utils.auth</span> <span class="kn">import</span> <span class="n">Auth</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">secret</span><span class="o">=</span><span class="s1">&#39;my secret key&#39;</span><span class="p">)</span>
<span class="n">DB_FOLDER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;databases&#39;</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.db&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">DB_FOLDER</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">auth</span> <span class="o">=</span> <span class="n">Auth</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
<span class="n">auth</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span> <span class="ow">or</span> <span class="n">redirect</span><span class="p">(</span><span class="n">URL</span><span class="p">(</span><span class="s1">&#39;auth/login&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;Welcome </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;first_name&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The constructor of the <code class="docutils literal notranslate"><span class="pre">Auth</span></code> object defines the <code class="docutils literal notranslate"><span class="pre">auth_user</span></code> table
with the following fields: username, email, password, first_name,
last_name, sso_id, and action_token (the last two are mostly for
internal use).</p>
<p><code class="docutils literal notranslate"><span class="pre">auth.enable()</span></code> registers multiple actions including
<code class="docutils literal notranslate"><span class="pre">{appname}/auth/login</span></code> and it requires the presence of the
<code class="docutils literal notranslate"><span class="pre">auth.html</span></code> template and the <code class="docutils literal notranslate"><span class="pre">auth</span></code> value component provided by the
<code class="docutils literal notranslate"><span class="pre">_scaffold</span></code> app.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">auth</span></code> object is the fixture. It manages the user information. It
exposes a single method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">auth</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
</pre></div>
</div>
<p>which returns a python dictionary containing the information of the
currently logged in user. If the user is not logged-in, it returns
<code class="docutils literal notranslate"><span class="pre">None</span></code>. The code of the example redirects to the ‘auth/login’ page if
there is no user.</p>
<p>Since this check is very common, py4web provides an additional fixture
<code class="docutils literal notranslate"><span class="pre">auth.user</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;Welcome </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;first_name&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This fixture automatically redirects to the <code class="docutils literal notranslate"><span class="pre">auth/login</span></code> page if user
is not logged-in. It depends on <code class="docutils literal notranslate"><span class="pre">auth</span></code>, which depends on <code class="docutils literal notranslate"><span class="pre">db</span></code> and
<code class="docutils literal notranslate"><span class="pre">session</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Auth</span></code> fixture is plugin based and supports multiple plugin
methods. They include Oauth2 (Google, Facebook, Twitter), PAM, LDAP, and
SMAL2.</p>
<p>Here is an example of using the Google Oauth2 plugin:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web.utils.auth_plugins.oauth2google</span> <span class="kn">import</span> <span class="n">OAuth2Google</span>
<span class="n">auth</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="n">OAuth2Google</span><span class="p">(</span>
    <span class="n">client_id</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="p">,</span>
    <span class="n">client_secret</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="p">,</span>
    <span class="n">callback_url</span><span class="o">=</span><span class="s1">&#39;auth/plugin/oauth2google/callback&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">client_id</span></code> and <code class="docutils literal notranslate"><span class="pre">client_secret</span></code> are provided by google. The
callback url is the default option for py4web and it must be whitelisted
with Google. All <code class="docutils literal notranslate"><span class="pre">Auth</span></code> plugins are objects. Different plugins are
configured in different ways but they are registered using
<code class="docutils literal notranslate"><span class="pre">auth.register_plugin(...)</span></code>. Examples are provided in
<code class="docutils literal notranslate"><span class="pre">_scaffold/common.py</span></code>.</p>
</div>
<div class="section" id="caching-and-memoize">
<h2>Caching and Memoize<a class="headerlink" href="#caching-and-memoize" title="Permalink to this headline">¶</a></h2>
<p>py4web provides a cache in ram object that implements the Last Recently
Used (LRU) Algorithm. It can be used to cache any function via a
decorator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">Cache</span><span class="p">,</span> <span class="n">action</span>
<span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;hello/&lt;name&gt;&#39;</span><span class="p">)</span>
<span class="nd">@cache</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">expiration</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;Hello </span><span class="si">%s</span><span class="s2"> your code is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</pre></div>
</div>
<p>It will cache (memoize) the return value of the <code class="docutils literal notranslate"><span class="pre">hello</span></code> function, as
function of the input <code class="docutils literal notranslate"><span class="pre">name</span></code>, for up to 60 seconds. It will store in
cache the 1000 most recently used values. The data is always stored in
ram.</p>
<p>The Cache object is not a fixture and it should not and cannot be
registered using the <code class="docutils literal notranslate"><span class="pre">&#64;action.uses</span></code> object but we mention it here
because some of the fixtures use this object internally. For example,
template files are cached in ram to avoid accessing the file system
every time a template needs to be rendered.</p>
</div>
<div class="section" id="convenience-decorators">
<h2>Convenience Decorators<a class="headerlink" href="#convenience-decorators" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">_scaffold</span></code> application, in <code class="docutils literal notranslate"><span class="pre">common.py</span></code> defines two special
conveniennce decorators:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@unauthenticated</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>
</pre></div>
</div>
<p>and</p>
<p>`<code class="docutils literal notranslate"><span class="pre">&#64;authenticated</span> <span class="pre">def</span> <span class="pre">index():</span>&#160;&#160;&#160;&#160; <span class="pre">return</span> <span class="pre">dict()</span></code></p>
<p>They apply all of the decorators below, use a template with the same
name as the function (.html), and also register a route with the name of
action followed the number of arguments of the action separated by a
slash (/).</p>
<p>&#64;unauthenticated does not require the user to be logged in.
&#64;authenticated required the user to be logged in.</p>
<p>If can be combined with (and precede) other <code class="docutils literal notranslate"><span class="pre">&#64;action.uses(...)</span></code> but
they should not be combined with <code class="docutils literal notranslate"><span class="pre">&#64;action(...)</span></code> because they perform
that function automatically.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="chapter-07.html" class="btn btn-neutral float-right" title="The database abstraction layer (DAL)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="chapter-05.html" class="btn btn-neutral float-left" title="Creating your first app" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, BSDv3 License

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      
      
     <span class="fa fa-element">
     <input class="container_toggle" type="checkbox" id="switch" name="mode">
     <label for="switch"></label>
     </span>
      
      v: 1.20201112.1

      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl>
        <dt>Languages</dt>
        
           <strong> 
          <dd><a href="../en/index.html">en</a></dd> </strong>
          
        
          
          
          <dd><a href="../pt/index.html">pt</a></dd> 
        
      </dl>
      
      
      <dl>
        <dt>Versions</dt>
        
          
          <dd><a href="index.html">current</a></dd>
          
        
      </dl>
      
      
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="py4web_en.pdf">pdf</a></dd>
        
          <dd><a href="py4web_en.epub">epub</a></dd>
        
      </dl>
      
      
      <hr/>
    </div>
  </div>

 

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    

  <style>
         .wy-nav-content { max-width: none; }
  </style>



</body>
</html>