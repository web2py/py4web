<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Authentication and authorization &mdash; py4web 20240915 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/tabs.css?v=a5c4661c" />
      <link rel="stylesheet" type="text/css" href="_static/css/toggle.css?v=029c1802" />

  
    <link rel="shortcut icon" href="_static/logo-32x32.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=78bb2521"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/js/toggle.js?v=e1b5a5a1"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Grid" href="chapter-14.html" />
    <link rel="prev" title="Forms" href="chapter-12.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            py4web
              <img src="_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                20240915
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="chapter-01.html">What is py4web?</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-02.html">Help, resources and hints</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-03.html">Installation and Startup</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-04.html">The Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-05.html">Creating an app</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-06.html">Fixtures</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-07.html">The Database Abstraction Layer (DAL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-08.html">The RestAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-09.html">YATL Template Language</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-10.html">YATL helpers</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-11.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-12.html">Forms</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Authentication and authorization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#authentication-using-auth">Authentication using Auth</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#auth-ui">Auth UI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-auth-inside-actions">Using Auth inside actions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#two-factor-authentication">Two Factor Authentication</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#two-factor-required">two_factor_required</a></li>
<li class="toctree-l4"><a class="reference internal" href="#two-factor-send">two_factor_send</a></li>
<li class="toctree-l4"><a class="reference internal" href="#two-factor-validate">two_factor_validate</a></li>
<li class="toctree-l4"><a class="reference internal" href="#two-factor-tries">two_factor_tries</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#auth-plugins">Auth Plugins</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pam">PAM</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ldap">LDAP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oauth2-with-google">OAuth2 with Google</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oauth2-with-facebook">OAuth2 with Facebook</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oauth2-with-discord">OAuth2 with Discord</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#authorization-using-tags">Authorization using Tags</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#tags-and-permissions">Tags and Permissions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multiple-tags-objects">Multiple Tags objects</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user-impersonation">User Impersonation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="chapter-14.html">Grid</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-15.html">From web2py to py4web</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-16.html">Advanced topics and examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">py4web</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Authentication and authorization</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/web2py/py4web/blob/master/docs/chapter-13.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="authentication-and-authorization">
<h1>Authentication and authorization<a class="headerlink" href="#authentication-and-authorization" title="Link to this heading"></a></h1>
<p>Strong authentication and authorization methods are
vital for a modern, multiuser web application.
While they are often used interchangeably, authentication and authorization
are separate processes:</p>
<ul class="simple">
<li><p>Authentication confirms that users are who they say they are</p></li>
<li><p>Authorization gives those users permission to access a resource</p></li>
</ul>
<section id="authentication-using-auth">
<h2>Authentication using Auth<a class="headerlink" href="#authentication-using-auth" title="Link to this heading"></a></h2>
<p>py4web comes with a an object <code class="docutils literal notranslate"><span class="pre">Auth</span></code> and a system of plugins for user
authentication. It has the same name as the
corresponding web2py one and serves the same purpose but the API and
internal design is very different.</p>
<p>The _scaffold application provides a guideline for its standard usage. By
default it uses a local SQLite database and allows creating new users,
login and logout. Notice that if you don’t configure it, you have to manually
approve new users (by visiting the link logged on the console or
by directly editing the database).</p>
<p>To use the Auth object, first of all you need to import it, instantiate it, configure
it, and enable it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web.utils.auth</span> <span class="kn">import</span> <span class="n">Auth</span>
<span class="n">auth</span> <span class="o">=</span> <span class="n">Auth</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
<span class="c1"># (configure here)</span>
<span class="n">auth</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
</pre></div>
</div>
<p>The import step is obvious. The second step does not perform any
operation other than telling the Auth object which session object to use
and which database to use. Auth data is stored in <code class="docutils literal notranslate"><span class="pre">session['user']</span></code>
and, if a user is logged in, the user id is stored in
session[‘user’][‘id’]. The db object is used to store persistent info
about the user in a table <code class="docutils literal notranslate"><span class="pre">auth_user</span></code> which is created if missing.
The <code class="docutils literal notranslate"><span class="pre">auth_user</span></code> table has the following fields:</p>
<ul class="simple">
<li><p>username</p></li>
<li><p>email</p></li>
<li><p>password</p></li>
<li><p>first_name</p></li>
<li><p>last_name</p></li>
<li><p>sso_id (used for single sign on, see later)</p></li>
<li><p>action_token (used to verify email, block users, and other tasks,
also see later).</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">auth.enable()</span></code> step creates and exposes the following RESTful
APIs:</p>
<ul class="simple">
<li><p>{appname}/auth/api/register (POST)</p></li>
<li><p>{appname}/auth/api/login (POST)</p></li>
<li><p>{appname}/auth/api/request_reset_password (POST)</p></li>
<li><p>{appname}/auth/api/reset_password (POST)</p></li>
<li><p>{appname}/auth/api/verify_email (GET, POST)</p></li>
<li><p>{appname}/auth/api/logout (GET, POST) (+)</p></li>
<li><p>{appname}/auth/api/profile (GET, POST) (+)</p></li>
<li><p>{appname}/auth/api/change_password (POST) (+)</p></li>
<li><p>{appname}/auth/api/change_email (POST) (+)</p></li>
</ul>
<p>Those marked with a (+) require a logged in user.</p>
<section id="auth-ui">
<h3>Auth UI<a class="headerlink" href="#auth-ui" title="Link to this heading"></a></h3>
<p>You can create your own web UI to login users using the above APIs but
py4web provides one as an example, implemented in the following files:</p>
<ul class="simple">
<li><p>_scaffold/templates/auth.html</p></li>
<li><p>_scaffold/templates/layout.html</p></li>
</ul>
<p>The key section is in <code class="docutils literal notranslate"><span class="pre">layout.html</span></code> where (using the no.css framework) the menu actions are defined:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="linenos"> 2</span>   [[if globals().get(&#39;user&#39;):]]
<span class="linenos"> 3</span>   <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="linenos"> 4</span>   <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-link is-primary&quot;</span><span class="p">&gt;</span>
<span class="linenos"> 5</span>      [[=globals().get(&#39;user&#39;,{}).get(&#39;email&#39;)]]
<span class="linenos"> 6</span>   <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="linenos"> 7</span>   <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="linenos"> 8</span>      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;[[=URL(&#39;auth/profile&#39;)]]&quot;</span><span class="p">&gt;</span>Edit Profile<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="linenos"> 9</span>      [[if &#39;change_password&#39; in globals().get(&#39;actions&#39;,{}).get(&#39;allowed_actions&#39;,{}):]]
<span class="linenos">10</span>         <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;[[=URL(&#39;auth/change_password&#39;)]]&quot;</span><span class="p">&gt;</span>Change Password<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="linenos">11</span>      [[pass]]
<span class="linenos">12</span>      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;[[=URL(&#39;auth/logout&#39;)]]&quot;</span><span class="p">&gt;</span>Logout<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="linenos">13</span>   <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="linenos">14</span>   <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="linenos">15</span>   [[else:]]
<span class="linenos">16</span>   <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="linenos">17</span>   Login
<span class="linenos">18</span>   <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="linenos">19</span>      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;[[=URL(&#39;auth/register&#39;)]]&quot;</span><span class="p">&gt;</span>Sign up<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="linenos">20</span>      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;[[=URL(&#39;auth/login&#39;)]]&quot;</span><span class="p">&gt;</span>Log in<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="linenos">21</span>   <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="linenos">22</span>   <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="linenos">23</span>   [[pass]]
<span class="linenos">24</span><span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>The menu is dynamic: on line 2 there is a check if the user is already defined
(i.e. if the user has already logged on). In this case the email is shown in the
top menu, plus the menu options <code class="docutils literal notranslate"><span class="pre">Edit</span> <span class="pre">Profile</span></code>, <code class="docutils literal notranslate"><span class="pre">Change</span> <span class="pre">Password</span></code> (optional) and
<code class="docutils literal notranslate"><span class="pre">Logout</span></code>.
Instead, if the user is not already logged on, from line 15 there are
only the corresponding menu options allowed: <code class="docutils literal notranslate"><span class="pre">Sign</span> <span class="pre">up</span></code> and <code class="docutils literal notranslate"><span class="pre">Log</span> <span class="pre">in</span></code>.</p>
<p>Every menu option then redirects the user to the corresponding standard URL,
which in turn activates the Auth action.</p>
</section>
<section id="using-auth-inside-actions">
<h3>Using Auth inside actions<a class="headerlink" href="#using-auth-inside-actions" title="Link to this heading"></a></h3>
<p>There two ways to use the Auth object in an action.</p>
<p>The first one does not force a login.  With <code class="docutils literal notranslate"><span class="pre">&#64;action.uses(auth)</span></code>
we tell py4web that this action should have information about the user,
trying to parse the session for a user session.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;hello </span><span class="si">{first_name}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">user</span><span class="p">)</span> <span class="k">if</span> <span class="n">user</span> <span class="k">else</span> <span class="s1">&#39;not logged in&#39;</span>
</pre></div>
</div>
<p>The second one forces the login if needed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;hello </span><span class="si">{first_name}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">&#64;action.uses(auth.user)</span></code> tells py4web that this action requires
a logged in user and should redirect to login if no user is logged in.</p>
</section>
<section id="two-factor-authentication">
<h3>Two Factor Authentication<a class="headerlink" href="#two-factor-authentication" title="Link to this heading"></a></h3>
<p>Two factor authentication (or Two-step verification) is a way of improving authentication security. When activated an extra step is added in the login
process. In the first step, users are shown the standard username/password form. If they successfully pass this challenge by submitting the correct
username and password, and two factor authentication is enabled for the user, the server will present a second form before logging them in.</p>
<p>There are a few Auth settings available to control how two factor authentication works.</p>
<p>The following can be specified on Auth instantiation:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">two_factor_required</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">two_factor_send</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">two_factor_validate</span></code></p></li>
</ul>
<section id="two-factor-required">
<h4>two_factor_required<a class="headerlink" href="#two-factor-required" title="Link to this heading"></a></h4>
<p>When you pass a method name to the <code class="docutils literal notranslate"><span class="pre">two_factor_required</span></code> parameter you are telling py4web to call that method to determine whether or not this login should
be use or bypass two factor authentication.  If your method returns True, then this login requires two factor.  If it returns False, two factor authentication
is bypassed for this login.</p>
<p>Sample <code class="docutils literal notranslate"><span class="pre">two_factor_required</span></code> method</p>
<p>This example shows how to allow users that are on a specific network.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">user_outside_network</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">ipaddress</span>

    <span class="n">networks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;10.10.0.0/22&quot;</span><span class="p">]</span>

    <span class="n">ip_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nb">range</span> <span class="ow">in</span> <span class="n">networks</span><span class="p">:</span>
        <span class="n">ip_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ipaddress</span><span class="o">.</span><span class="n">IPv4Network</span><span class="p">(</span><span class="nb">range</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">IPv4Address</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ip_list</span><span class="p">:</span>
        <span class="c1">#  if the client address is in the network address list, then do NOT require MFA</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</section>
<section id="two-factor-send">
<h4>two_factor_send<a class="headerlink" href="#two-factor-send" title="Link to this heading"></a></h4>
<p>When two factor authentication is active, py4web can generate a 6 digit code (using random.randint) and makes it possible to send it to the user. How this code is
sent, is up to you. The <code class="docutils literal notranslate"><span class="pre">two_factor_send</span></code> argument to the Auth class allows you to specify the method that sends the two factor code to the user.</p>
<p>This example shows how to send an email with the two factor code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">send_two_factor_email</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">auth</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
            <span class="n">to</span><span class="o">=</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">],</span>
            <span class="n">subject</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Two factor login verification code&quot;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;You&#39;re verification code is </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">sender</span><span class="o">=</span><span class="s2">&quot;from_address@youremail.com&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">code</span>
</pre></div>
</div>
<p>Notice that this method takes two arguments: the current user, and the code to be sent.
Also notice this method can override the code and return a new one.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">auth</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">two_factor_required</span> <span class="o">=</span> <span class="n">user_outside_network</span>
<span class="n">auth</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">two_factor_send</span> <span class="o">=</span> <span class="n">send_two_factor_email</span>
</pre></div>
</div>
</section>
<section id="two-factor-validate">
<h4>two_factor_validate<a class="headerlink" href="#two-factor-validate" title="Link to this heading"></a></h4>
<p>By default, py4web will validate the user input in the two factor form by comparing the code entered by the user with the code generated and sent using
<code class="docutils literal notranslate"><span class="pre">two_factor_send</span></code>. However, sometimes it may be useful to define a custom validation of this user-entered code. For instance, if one would like to use the
TOTP (or the Time-Based One-Time-Passwords) as the two factor authentication method, the validation requires comparing the code entered by the user with the
value generated at the same time at the server side. Hence, it is not sufficient to generate that value earlier when showing the form (using for instance
<code class="docutils literal notranslate"><span class="pre">two_factor_send</span></code> method), because by the time the user submits the form, the current valid value may already be different. Instead, this value should be
generated when validating the form submitted by the user.</p>
<p>To accomplish such custom validation, the <code class="docutils literal notranslate"><span class="pre">two_factor_validate</span></code> method is available. It takes two arguments - the current user and the code that was entered
by the user into the two factor authentication form. The primary use-case for this method is validation of time-based passwords.</p>
<p>This example shows how to validate a time-based two factor code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">validate_code</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
   <span class="k">try</span><span class="p">:</span>
      <span class="c1"># get the correct code from an external function</span>
      <span class="n">correct_code</span> <span class="o">=</span> <span class="n">generate_time_based_code</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
   <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="c1"># return None to indicate that validation could not be performed</span>
      <span class="k">return</span> <span class="kc">None</span>

   <span class="c1"># compare the value entered in the auth form with the correct code</span>
   <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="n">correct_code</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">True</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">validate_code</span></code> method must return one of three values:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code> - if the validation succeded,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code> - if the validation failed,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">None</span></code> - if the validation was not possible for any reason</p></li>
</ul>
<p>Notice that - if defined - this method is _always_ called to validate the two factor authentication form. It is up to you to decide what kind of validation it
does. If the returned value is <code class="docutils literal notranslate"><span class="pre">True</span></code>, the user input will be accepted as valid. If the returned value is <code class="docutils literal notranslate"><span class="pre">False</span></code> then the user input will be rejected as
invalid, number of tries will be decresed by one, and user will be asked to try again. If the returned value is <code class="docutils literal notranslate"><span class="pre">None</span></code> the user input will be checked against
the code generated with the use of <code class="docutils literal notranslate"><span class="pre">two_factor_send</span></code> method and the final result will depend on that comparison. In this case authentication will fail if <code class="docutils literal notranslate"><span class="pre">two_factor_send</span></code>
method was not defined, and hence no code was sent to the user.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">auth</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">two_factor_validate</span> <span class="o">=</span> <span class="n">validate_code</span>
</pre></div>
</div>
</section>
<section id="two-factor-tries">
<h4>two_factor_tries<a class="headerlink" href="#two-factor-tries" title="Link to this heading"></a></h4>
<p>By default, the user has 3 attempts to pass two factor authentication. You can override this after using:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">auth</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">two_factor_tries</span> <span class="o">=</span> <span class="mi">5</span>
</pre></div>
</div>
<p>Once this is all setup, the flow for two factor authentication is:</p>
<ul class="simple">
<li><p>present the login page</p></li>
<li><dl class="simple">
<dt>upon successful login and user passes two_factor_required</dt><dd><ul>
<li><p>redirect to py4web auth/two_factor endpoint</p></li>
<li><dl class="simple">
<dt>if <code class="docutils literal notranslate"><span class="pre">two_factor_send</span></code> method has been defined:</dt><dd><ul>
<li><p>generate 6 digit verification code</p></li>
<li><p>call <code class="docutils literal notranslate"><span class="pre">two_factor_send</span></code> to send the verification code to the user</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>display verification page where user can enter their code</p></li>
<li><p>if <code class="docutils literal notranslate"><span class="pre">two_factor_validate</span></code> method has been defined - call it to validate the user-entered code</p></li>
<li><p>upon successful verification, take user to _next_url that was passed to the login page</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>Important! If you filtered <code class="docutils literal notranslate"><span class="pre">ALLOWED_ACTIONS</span></code> in your app, make sure to whitelist the “two_factor” action so not to block the two factor API.</p>
</section>
</section>
<section id="auth-plugins">
<h3>Auth Plugins<a class="headerlink" href="#auth-plugins" title="Link to this heading"></a></h3>
<p>Plugins are defined in “py4web/utils/auth_plugins” and they have a
hierarchical structure. Some are exclusive and some are not. For example,
default, LDAP, PAM, and SAML are exclusive (the developer has to pick
one). Default, Google, Facebook, and Twitter OAuth are not exclusive
(the developer can pick them all and the user gets to choose using the
UI).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">&lt;auth/&gt;</span></code> components will automatically adapt to display login
forms as required by the installed plugins.</p>
<p>In the _scaffold/settings.py and _scaffold/common.py files you can see
the default settings for the supported plugins.</p>
<section id="pam">
<h4>PAM<a class="headerlink" href="#pam" title="Link to this heading"></a></h4>
<p>Configuring PAM is the easiest:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web.utils.auth_plugins.pam_plugin</span> <span class="kn">import</span> <span class="n">PamPlugin</span>
<span class="n">auth</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="n">PamPlugin</span><span class="p">())</span>
</pre></div>
</div>
<p>This one like all plugins must be imported and registered.
The constructor of this plugins does not require any
arguments (where other plugins do).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">auth.register_plugin(...)</span></code> <strong>must</strong> come before the
<code class="docutils literal notranslate"><span class="pre">auth.enable()</span></code> since it makes no sense to expose APIs before desired
plugins are mounted.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>by design PAM authentication using local users works fine only if py4web is run by root.
Otherwise you can only authenticate the specific user that runs the py4web process.</p>
</div>
</section>
<section id="ldap">
<h4>LDAP<a class="headerlink" href="#ldap" title="Link to this heading"></a></h4>
<p>This is a common authentication method, especially using Microsoft Active Directory in enterprises.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web.utils.auth_plugins.ldap_plugin</span> <span class="kn">import</span> <span class="n">LDAPPlugin</span>
<span class="n">LDAP_SETTING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;ad&#39;</span><span class="p">,</span>
    <span class="s1">&#39;server&#39;</span><span class="p">:</span> <span class="s1">&#39;my.domain.controller&#39;</span><span class="p">,</span>
    <span class="s1">&#39;base_dn&#39;</span><span class="p">:</span> <span class="s1">&#39;cn=Users,dc=domain,dc=com&#39;</span>
<span class="p">}</span>
<span class="n">auth</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="n">LDAPPlugin</span><span class="p">(</span><span class="o">**</span><span class="n">LDAP_SETTINGS</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>it needs the python-ldap module. On Ubuntu, you should also install some developer’s libraries
in advance with <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">libldap2-dev</span> <span class="pre">libsasl2-dev</span></code>.</p>
</div>
</section>
<section id="oauth2-with-google">
<h4>OAuth2 with Google<a class="headerlink" href="#oauth2-with-google" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web.utils.auth_plugins.oauth2google</span> <span class="kn">import</span> <span class="n">OAuth2Google</span> <span class="c1"># TESTED</span>
<span class="n">auth</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="n">OAuth2Google</span><span class="p">(</span>
    <span class="n">client_id</span><span class="o">=</span><span class="n">CLIENT_ID</span><span class="p">,</span>
    <span class="n">client_secret</span><span class="o">=</span><span class="n">CLIENT_SECRET</span><span class="p">,</span>
    <span class="n">callback_url</span><span class="o">=</span><span class="s1">&#39;auth/plugin/oauth2google/callback&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>The client id and client secret must be provided by Google.</p>
</section>
<section id="oauth2-with-facebook">
<h4>OAuth2 with Facebook<a class="headerlink" href="#oauth2-with-facebook" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web.utils.auth_plugins.oauth2facebook</span> <span class="kn">import</span> <span class="n">OAuth2Facebook</span> <span class="c1"># UNTESTED</span>
<span class="n">auth</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="n">OAuth2Facebook</span><span class="p">(</span>
    <span class="n">client_id</span><span class="o">=</span><span class="n">CLIENT_ID</span><span class="p">,</span>
    <span class="n">client_secret</span><span class="o">=</span><span class="n">CLIENT_SECRET</span><span class="p">,</span>
    <span class="n">callback_url</span><span class="o">=</span><span class="s1">&#39;auth/plugin/oauth2google/callback&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>The client id and client secret must be provided by Facebook.</p>
</section>
<section id="oauth2-with-discord">
<h4>OAuth2 with Discord<a class="headerlink" href="#oauth2-with-discord" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web.utils.auth_plugins.oauth2discord</span> <span class="kn">import</span> <span class="n">OAuth2Discord</span>
<span class="n">auth</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="n">OAuth2Discord</span><span class="p">(</span>
    <span class="n">client_id</span><span class="o">=</span><span class="n">DISCORD_CLIENT_ID</span><span class="p">,</span>
    <span class="n">client_secret</span><span class="o">=</span><span class="n">DISCORD_CLIENT_SECRET</span><span class="p">,</span>
    <span class="n">callback_url</span><span class="o">=</span><span class="s2">&quot;auth/plugin/oauth2discord/callback&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>To obtain a Discord client ID and secret, create an application at <a class="reference external" href="https://discord.com/developers/applications">https://discord.com/developers/applications</a>.
You will also have to register your OAuth2 redirect URI in your created application, in the form of
<code class="docutils literal notranslate"><span class="pre">http(s)://&lt;your</span> <span class="pre">host&gt;/&lt;your</span> <span class="pre">app</span> <span class="pre">name&gt;/auth/plugin/oauth2discord/callback</span></code></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As Discord users have no concept of first/last name, the user in the auth table will contain the
Discord username as the first name and discriminator as the last name.</p>
</div>
</section>
</section>
</section>
<section id="authorization-using-tags">
<h2>Authorization using Tags<a class="headerlink" href="#authorization-using-tags" title="Link to this heading"></a></h2>
<p>As already mentioned, authorization is the process of verifying what specific
applications, files, and data a user has access to. This is accomplished
in py4web using <code class="docutils literal notranslate"><span class="pre">Tags</span></code>, that we’ve already discovered on <a class="reference internal" href="chapter-07.html#tagging-records"><span class="std std-ref">Tagging records</span></a>
in the DAL chapter.</p>
<section id="tags-and-permissions">
<h3>Tags and Permissions<a class="headerlink" href="#tags-and-permissions" title="Link to this heading"></a></h3>
<p>Py4web provides a general purpose tagging
mechanism that allows the developer to tag any record of any table,
check for the existence of tags, as well as checking for records
containing a tag. Group membership can be thought of a type of tag that
we apply to users. Permissions can also be tags. Developers are free to
create their own logic on top of the tagging system.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Py4web does not have the concept of groups as web2py does. Experience
showed that while that mechanism is powerful it suffers from two
problems: it is overkill for most apps, and it is not flexible enough
for very complex apps.</p>
</div>
<p>To use the tagging system you first need to import the Tags module
from <code class="docutils literal notranslate"><span class="pre">pydal.tools</span></code>. Then create a Tags object to tag a table:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pydal.tools.tags</span> <span class="kn">import</span> <span class="n">Tags</span>
<span class="n">groups</span> <span class="o">=</span> <span class="n">Tags</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="p">,</span> <span class="s1">&#39;groups&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The tail_name parameter is optional and if not specified the ‘default’
value will be used. If you look at the database level, a new table will
be created with a name equals to <code class="docutils literal notranslate"><span class="pre">tagged_db</span> <span class="pre">+</span> <span class="pre">'_tag_'</span> <span class="pre">+</span> <span class="pre">tail_name</span></code>,
in this case <code class="docutils literal notranslate"><span class="pre">auth_user_tag_groups</span></code>:</p>
<img alt="_images/tags_db.png" src="_images/tags_db.png" />
<p>Then you can add one or more tags to records of the table as well as
remove existing tags:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;manager&#39;</span><span class="p">)</span>
<span class="n">groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;dancer&#39;</span><span class="p">,</span> <span class="s1">&#39;teacher&#39;</span><span class="p">])</span>
<span class="n">groups</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;dancer&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>On the <code class="docutils literal notranslate"><span class="pre">auth_user_tagged_groups</span></code> this will produce two records
with different groups assigned to the same user.id (the “Record ID” field):</p>
<img alt="_images/tags2.png" src="_images/tags2.png" />
<p>Slashes at the
beginning or the end of a tag are optional. All other chars are allowed
on equal footing.</p>
<p>A common use case is <strong>group based access control</strong>. Here the developer
first checks if a user is a member of the <code class="docutils literal notranslate"><span class="pre">'manager'</span></code> group, if the
user is not a manager (or no one is logged in) py4web redirects to the
<code class="docutils literal notranslate"><span class="pre">'not</span> <span class="pre">authorized</span> <span class="pre">url'</span></code>. Else the user is in the correct group and then
py4web displays ‘hello manager’:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;manager&#39;</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">get_user</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]):</span>
        <span class="n">redirect</span><span class="p">(</span><span class="n">URL</span><span class="p">(</span><span class="s1">&#39;not_authorized&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;hello manager&#39;</span>
</pre></div>
</div>
<p>Here the developer queries the db for all records having the desired
tag(s):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;find_by_tag/</span><span class="si">{group_name}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="n">group_name</span><span class="p">):</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">find</span><span class="p">([</span><span class="n">group_name</span><span class="p">]))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">orderby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="o">.</span><span class="n">first_name</span> <span class="o">|</span> <span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="n">users</span><span class="p">}</span>
</pre></div>
</div>
<p>We’ve already seen a simple <code class="docutils literal notranslate"><span class="pre">requires_membership</span></code> fixture on :ref:<code class="docutils literal notranslate"><span class="pre">The</span> <span class="pre">Condition</span> <span class="pre">fixture</span></code>. It
enables the following syntax:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">groups</span> <span class="o">=</span> <span class="n">Tags</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">requires_membership</span><span class="p">(</span><span class="n">Fixture</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__prerequisites__</span> <span class="o">=</span> <span class="p">[</span><span class="n">auth</span><span class="o">.</span><span class="n">user</span><span class="p">]</span> <span class="c1"># you must have a user before you can check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span>  <span class="o">=</span> <span class="n">group</span> <span class="c1"># store the group when action defined</span>
    <span class="k">def</span> <span class="nf">on_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span> <span class="c1"># will be called if the action is called</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">user_id</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HTTP</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span> <span class="c1"># check and do something</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">requires_membership</span><span class="p">(</span><span class="s1">&#39;teacher&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;hello teacher&#39;</span>
</pre></div>
</div>
<p>We leave it to you as an exercise to create a fixture <code class="docutils literal notranslate"><span class="pre">has_membership</span></code>
to enable the following syntax:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">has_membership</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="s1">&#39;teacher&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;hello teacher&#39;</span>
</pre></div>
</div>
<p><strong>Important:</strong> <code class="docutils literal notranslate"><span class="pre">Tags</span></code> are automatically hierarchical. For example, if
a user has a group tag ‘teacher/high-school/physics’, then all the
following searches will return the user:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">groups.find('teacher/high-school/physics')</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">groups.find('teacher/high-school')</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">groups.find('teacher')</span></code></p></li>
</ul>
<p>This means that slashes have a special meaning for tags.</p>
</section>
<section id="multiple-tags-objects">
<h3>Multiple Tags objects<a class="headerlink" href="#multiple-tags-objects" title="Link to this heading"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>One table can have multiple associated <code class="docutils literal notranslate"><span class="pre">Tags</span></code> objects. The
name ‘groups’ here is completely arbitrary but has a specific semantic
meaning. Different <code class="docutils literal notranslate"><span class="pre">Tags</span></code> objects are independent to each other. The
limit to their use is your creativity.</p>
</div>
<p>For example you could create a table <code class="docutils literal notranslate"><span class="pre">auth_group</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;auth_group&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>and two Tags attached to it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">groups</span> <span class="o">=</span> <span class="n">Tags</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="p">)</span>
<span class="n">permissions</span> <span class="o">=</span> <span class="n">Tags</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">auth_groups</span><span class="p">)</span>
</pre></div>
</div>
<p>Then create a ‘zapper’ record in <code class="docutils literal notranslate"><span class="pre">auth_group</span></code>, give it a permission, and make a user member
of the group:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">zap_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">auth_group</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;zapper&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;can zap database&#39;</span><span class="p">)</span>
<span class="n">permissions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">zap_id</span><span class="p">,</span> <span class="s1">&#39;zap database&#39;</span><span class="p">)</span>
<span class="n">groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;zapper&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>And you can check for a user permission via an explicit join:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;zap&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">zap</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
    <span class="n">permission</span> <span class="o">=</span> <span class="s1">&#39;zap database&#39;</span>
    <span class="k">if</span> <span class="n">db</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">permission</span><span class="p">))(</span>
          <span class="n">db</span><span class="o">.</span><span class="n">auth_group</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">belongs</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
          <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
        <span class="c1"># zap db</span>
        <span class="k">return</span> <span class="s1">&#39;database zapped&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;you do not belong to any group with permission to zap db&#39;</span>
</pre></div>
</div>
<p>Notice here <code class="docutils literal notranslate"><span class="pre">permissions.find(permission)</span></code> generates a query for all
groups with the permission and we further filter those groups for those
the current user is member of. We count them and if we find any, then
the user has the permission.</p>
</section>
<section id="user-impersonation">
<h3>User Impersonation<a class="headerlink" href="#user-impersonation" title="Link to this heading"></a></h3>
<p>Auth provides API that allow you to impersonate another user.
Here is an example of an action to start impersonating and stop impersonating another user.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;impersonate/{user_id:int}&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">start_impersonating</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">auth</span><span class="o">.</span><span class="n">is_impersonating</span><span class="p">()</span> <span class="ow">and</span>
        <span class="n">user_id</span> <span class="ow">and</span>
        <span class="n">user_id</span> <span class="o">!=</span> <span class="n">auth</span><span class="o">.</span><span class="n">user_id</span> <span class="ow">and</span>
        <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()):</span>
        <span class="n">auth</span><span class="o">.</span><span class="n">start_impersonating</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">URL</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">))</span>
    <span class="k">raise</span> <span class="n">HTTP</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

 <span class="nd">@action</span><span class="p">(</span><span class="s2">&quot;stop_impersonating&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">)</span>
 <span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">stop_impersonating</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">auth</span> <span class="ow">and</span> <span class="n">auth</span><span class="o">.</span><span class="n">is_impersonating</span><span class="p">():</span>
        <span class="n">auth</span><span class="o">.</span><span class="n">stop_impersonating</span><span class="p">(</span><span class="n">URL</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">))</span>
    <span class="n">redirect</span><span class="p">(</span><span class="n">URL</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">))</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="chapter-12.html" class="btn btn-neutral float-left" title="Forms" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="chapter-14.html" class="btn btn-neutral float-right" title="Grid" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, BSDv3 License.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      
      
     <span class="fa fa-element">
     <input class="container_toggle" type="checkbox" id="switch" name="mode">
     <label for="switch"></label>
     </span>
      
      v: 20240915
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl>
        <dt>Languages</dt>
        
           <strong> 
          <dd><a href="../en/index.html">en</a></dd> </strong>
          
        
          
          
          <dd><a href="../pt/index.html">pt</a></dd> 
        
      </dl>
      
      
      <dl>
        <dt>Versions</dt>
        
          
          <dd><a href="index.html">current</a></dd>
          
        
      </dl>
      
      
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="py4web_en.pdf">pdf</a></dd>
        
          <dd><a href="py4web_en.epub">epub</a></dd>
        
      </dl>
      
      
      <hr/>
    </div>
  </div>

 <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
         .wy-nav-content { max-width: none; }
  </style>



</body>
</html>