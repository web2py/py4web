<!DOCTYPE html>
<html class="writer-html5" lang="pt" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Database Abstraction Layer (DAL) &mdash; Documentação py4web 1.20220222.1</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/toggle.css" type="text/css" />
    <link rel="shortcut icon" href="_static/logo-32x32.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/translations.js"></script>
        <script src="_static/js/toggle.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Índice" href="genindex.html" />
    <link rel="search" title="Pesquisar" href="search.html" />
    <link rel="next" title="The RestAPI" href="chapter-08.html" />
    <link rel="prev" title="Fixures" href="chapter-06.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> py4web
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.20220222.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Pesquisar docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Menu de navegação">
              <p class="caption" role="heading"><span class="caption-text">Conteúdo:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="chapter-01.html">O que é py4web?</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-02.html">Ajuda, recursos e dicas</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-03.html">Instalação e colocação em funcionamento</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-04.html">O Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-05.html">Criando seu primeiro aplicativo</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-06.html">Fixures</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">The Database Abstraction Layer (DAL)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#dal-introduction">DAL introduction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#py4web-model">py4web model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#supported-databases">Supported databases</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-dal-a-quick-tour">The DAL: a quick tour</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-dal-stand-alone">Usando o DAL “stand-alone”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#experiment-with-the-py4web-shell">Experimentar com o shell py4web</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#dal-constructor">Construtor DAL</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#dal-signature">Assinatura da DAL</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connection-strings-the-uri-parameter">Strings de conexão (o parâmetro uri)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connection-pooling">O pool de conexões</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connection-failures-attempts-parameter">Falhas de conexão (parâmetro tentativas)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lazy-tables">Tabelas preguiçosos</a></li>
<li class="toctree-l3"><a class="reference internal" href="#model-less-applications">Aplicativos de modelo-less</a></li>
<li class="toctree-l3"><a class="reference internal" href="#replicated-databases">Bancos de dados replicados</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reserved-keywords">Palavras-chave reservadas</a></li>
<li class="toctree-l3"><a class="reference internal" href="#database-quoting-and-case-settings">Configurações de quoting e case e do  banco de dados</a></li>
<li class="toctree-l3"><a class="reference internal" href="#making-a-secure-connection">Fazendo uma conexão segura</a></li>
<li class="toctree-l3"><a class="reference internal" href="#other-dal-constructor-parameters">Outros parâmetros do construtor DAL</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#database-folder-location">Local de pasta do banco de dados</a></li>
<li class="toctree-l4"><a class="reference internal" href="#default-migration-settings">Configurações padrão de migração</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#commit-and-rollback">`` `` commit`` e rollback``</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#table-constructor">Construtor Table</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#define-table-signature">assinatura define_table</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id-notes-about-the-primary-key">`` Id``: Notas sobre a chave primária</a></li>
<li class="toctree-l3"><a class="reference internal" href="#plural-and-singular">`` `` Plural`` e singular``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#redefine">`` Redefine``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#format-record-representation">`` Format``: representação da ficha</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rname-real-name">`` Rname``: nome real</a></li>
<li class="toctree-l3"><a class="reference internal" href="#primarykey-support-for-legacy-tables">`` Primarykey``: Suporte para tabelas legadas</a></li>
<li class="toctree-l3"><a class="reference internal" href="#migrate-fake-migrate">`` Migrate``, `` fake_migrate``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#table-class">`` Table_class``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sequence-name">`` Sequence_name``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#trigger-name">`` Trigger_name``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#polymodel">`` polymodel``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#on-define">`` On_define``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-attributes-to-fields-and-tables">Adicionando atributos para campos e tabelas</a></li>
<li class="toctree-l3"><a class="reference internal" href="#legacy-databases-and-keyed-tables">Bancos de dados legados e tabelas com chave</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#field-constructor">Construtor Field</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#field-types-and-validators">Field types and validators</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-time-field-and-table-modification">modificação da tabela e campo em tempo de execução</a></li>
<li class="toctree-l3"><a class="reference internal" href="#more-on-uploads">Mais sobre envios</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#migrations">Migrações</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#fixing-broken-migrations">Fixação migrações quebrados</a></li>
<li class="toctree-l3"><a class="reference internal" href="#migration-control-summary">Migração resumo controle</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#table-methods">Table methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#insert">`` Insert``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#query-set-rows">`` Query``, `` Set``, `` Rows``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#update-or-insert">`` Update_or_insert``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#validate-and-insert-validate-and-update">`` Validate_and_insert``, `` validate_and_update``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#drop">`` Drop``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tagging-records">Marcação de registros</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#raw-sql">Raw SQL</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#executesql">`` executesql``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lastsql">`` _Lastsql``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#timing-queries">Temporização de consultas</a></li>
<li class="toctree-l3"><a class="reference internal" href="#indexes">Índices</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generating-raw-sql">Generating raw SQL</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#select-command">`` Comando SELECT``</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-an-iterator-based-select-for-lower-memory-use">Usando um seleto para uso de memória inferior à base de iterador</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rendering-rows-using-represent">Renderizando Rows com represent</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shortcuts">Atalhos</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fetching-a-row">A obtenção de um `` row``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#recursive-selects">Recursivas `` s SELECT``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#orderby-groupby-limitby-distinct-having-orderby-on-limitby-join-left-cache">`` Orderby``, `` groupby``, `` limitby``, `` distinct``, `` having``, `` orderby_on_limitby``, `` join``, `` left``, `` cache``</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#orderby">ordenar por</a></li>
<li class="toctree-l4"><a class="reference internal" href="#groupby-having">groupby, tendo</a></li>
<li class="toctree-l4"><a class="reference internal" href="#distinct">distinto</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limitby">limitby</a></li>
<li class="toctree-l4"><a class="reference internal" href="#orderby-on-limitby">orderby_on_limitby</a></li>
<li class="toctree-l4"><a class="reference internal" href="#join-left">juntar-se, deixou</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cache-cacheable">cache, em cache</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#logical-operators">Operadores lógicos</a></li>
<li class="toctree-l3"><a class="reference internal" href="#count-isempty-delete-update">`` Count``, `` isempty``, `` DELETE``, `` update``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#expressions">Expressões</a></li>
<li class="toctree-l3"><a class="reference internal" href="#case">`` case``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#update-record">`` Update_record``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inserting-and-updating-from-a-dictionary">Inserir e atualizar a partir de um dicionário</a></li>
<li class="toctree-l3"><a class="reference internal" href="#first-and-last">`` `` First`` e last``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#as-dict-and-as-list">`` `` As_dict`` e as_list``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#combining-rows">Combinando Rows</a></li>
<li class="toctree-l3"><a class="reference internal" href="#find-exclude-sort">`` Find``, `` exclude``, `` sort``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#caching-selects">Selects com cache</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#computed-and-virtual-fields">Computed and Virtual fields</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#computed-fields">Campos computados</a></li>
<li class="toctree-l3"><a class="reference internal" href="#virtual-fields">Campos virtuais</a></li>
<li class="toctree-l3"><a class="reference internal" href="#new-style-virtual-fields-experimental">Campos virtuais novo estilo (experimental)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#old-style-virtual-fields">Campos virtuais velho antigo</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#joins-and-relations">Joins and Relations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#one-to-many-relation">Um para muitos relação</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inner-join">Inner join</a></li>
<li class="toctree-l3"><a class="reference internal" href="#left-outer-join">Left outer join</a></li>
<li class="toctree-l3"><a class="reference internal" href="#grouping-and-counting">Agrupamento e contando</a></li>
<li class="toctree-l3"><a class="reference internal" href="#many-to-many-relation">Many to many relation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#self-reference-and-aliases">A auto-referência e aliases</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#other-operators">Outros operadores</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#like-ilike-regexp-startswith-endswith-contains-upper-lower">`` Like``, `` ilike``, `` regexp``, `` startswith``, `` endswith``, `` contains``, `` upper``, `` lower``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#year-month-day-hour-minutes-seconds">`` Year``, `` month``, `` day``, `` hour``, `` minutes``, `` seconds``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#belongs">`` Belongs``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sum-avg-min-max-and-len">`` Sum``, `` avg``, `` min``, `` `` max`` e len``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#substrings">Substrings</a></li>
<li class="toctree-l3"><a class="reference internal" href="#default-values-with-coalesce-and-coalesce-zero">Os valores por defeito com `` `` coalesce`` e coalesce_zero``</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#exporting-and-importing-data">Exportar e importar dados</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#csv-one-table-at-a-time">CSV (uma tabela de cada vez)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#csv-all-tables-at-once">CSV (todas as tabelas ao mesmo tempo)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#csv-and-remote-database-synchronization">CSV e sincronização de banco de dados remoto</a></li>
<li class="toctree-l3"><a class="reference internal" href="#html-and-xml-one-table-at-a-time">HTML e XML (uma tabela de cada vez)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-representation">Representação de dados</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#advanced-features">Características avançadas</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#list-type-and-contains">`` Lista: &lt;type&gt; `` e `` contains``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#table-inheritance">Herança de tabela</a></li>
<li class="toctree-l3"><a class="reference internal" href="#filter-in-and-filter-out">`` `` Filter_in`` e filter_out``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#callbacks-on-record-insert-delete-and-update">retornos de chamada no registro de inserção, exclusão e atualização</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#database-cascades">Cascades no banco de dados</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#record-versioning">versionamento recorde</a></li>
<li class="toctree-l3"><a class="reference internal" href="#common-filters">filtros comuns</a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-field-types">Personalizados `` tipos Field``</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-dal-without-define-tables">Usando DAL sem definir tabelas</a></li>
<li class="toctree-l3"><a class="reference internal" href="#distributed-transaction">Transação distribuída</a></li>
<li class="toctree-l3"><a class="reference internal" href="#copy-data-from-one-db-into-another">Copiar dados de um para outro db</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#gotchas">Pegadinhas</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#note-on-new-dal-and-adapters">Nota sobre novo DAL e adaptadores</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sqlite">SQLite</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mysql">MySQL</a></li>
<li class="toctree-l3"><a class="reference internal" href="#google-sql">Google SQL</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mssql-microsoft-sql-server">MSSQL (Microsoft SQL Server)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#oracle">Oráculo</a></li>
<li class="toctree-l3"><a class="reference internal" href="#google-nosql-datastore">Google NoSQL (Datastore)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="chapter-08.html">The RestAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-09.html">Linguagem de template YATL</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-10.html">Helpers YATL</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-11.html">Internacionalização</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-12.html">Forumlários</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-13.html">Authentication and authorization</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-14.html">Rede</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-15.html">De web2py para py4web</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-16.html">Advanced topics and examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Menu de navegação móvel" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">py4web</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Navegação da página">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>The Database Abstraction Layer (DAL)</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/web2py/py4web/blob/master/docs/chapter-07.rst" class="fa fa-github"> Editar no GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="the-database-abstraction-layer-dal">
<h1>The Database Abstraction Layer (DAL)<a class="headerlink" href="#the-database-abstraction-layer-dal" title="Link permanente para este título"></a></h1>
<section id="dal-introduction">
<h2>DAL introduction<a class="headerlink" href="#dal-introduction" title="Link permanente para este título"></a></h2>
<p>py4web rely on a database abstraction layer (DAL), an API that maps
Python objects into database objects such as queries, tables, and
records. The DAL dynamically generates the SQL in real time using the
specified dialect for the database back end, so that you do not have to
write SQL code or learn different SQL dialects (the term SQL is used
generically), and the application will be portable among different types
of databases.
The DAL choosen is a pure Python one called <a class="reference external" href="https://github.com/web2py/pydal">pyDAL</a>.
It was conceived in the web2py project but it’s a standard python module:
you can use it in any Python context.</p>
<p>A little taste of pyDAL features:</p>
<ul class="simple">
<li><p>Transactions</p></li>
<li><p>Aggregates</p></li>
<li><p>Inner &amp; Outer Joins</p></li>
<li><p>Nested Selects</p></li>
</ul>
<section id="py4web-model">
<h3>py4web model<a class="headerlink" href="#py4web-model" title="Link permanente para este título"></a></h3>
<p>Even if web2py and py4web use the same pyDAL, there are important differences (see
<a class="reference internal" href="chapter-15.html#from-web2py-to-py4web"><span class="std std-ref">De web2py para py4web</span></a> for details). The main caveat is that in py4web only
the action is executed for every HTTP request, while the code defined outside of
actions is only executed at startup. That makes py4web much faster, in particular
when there are many tables. The downside of this approach is that the developer
should be careful to never override pyDAL variables inside action or in any way
that depends on the content of the request object, else the code is not thread safe.
The only variables that can be changed at will are the following field attributes:
readable, writable, requires, update, and default.
All the others are for practical purposes to be considered global and non thread safe.</p>
</section>
<section id="supported-databases">
<h3>Supported databases<a class="headerlink" href="#supported-databases" title="Link permanente para este título"></a></h3>
<p>A partial list of supported databases is show in the table
below. Please check on the py4web/pyDAL web site and mailing list for more
recent adapters.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>In any modern python distribution <strong>SQLite</strong> is actually built-in as a Python library.
The SQLite driver (sqlite3) is also included: you don’t need to install it.
Hence this is the most popular database for testing and development.</p>
</div>
<p>The Windows and the Mac binary distribution work out of the box with SQLite only.
To use any other database back end, run a full py4web
distribution and install the appropriate driver for the required back
end. Once the proper driver is installed, start py4web and it
will automatically find the driver.</p>
<p>Here is a list of the drivers py4web can use:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 81%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Database</p></th>
<th class="head"><p>Drivers (source)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>SQLite</p></td>
<td><p>sqlite3 ou pySqlite2 ou zxJDBC (em Jython)</p></td>
</tr>
<tr class="row-odd"><td><p>PostgreSQL</p></td>
<td><p>psycopg2 ou zxJDBC (em Jython)</p></td>
</tr>
<tr class="row-even"><td><p>MySQL</p></td>
<td><p>pymysql ou MySQLdb</p></td>
</tr>
<tr class="row-odd"><td><p>Oráculo</p></td>
<td><p>cx_Oracle</p></td>
</tr>
<tr class="row-even"><td><p>MSSQL</p></td>
<td><p>pyodbc ou pypyodbc</p></td>
</tr>
<tr class="row-odd"><td><p>FireBird</p></td>
<td><p>KInterbasDB ou FDB ou pyodbc</p></td>
</tr>
<tr class="row-even"><td><p>DB2</p></td>
<td><p>pyodbc</p></td>
</tr>
<tr class="row-odd"><td><p>Informix</p></td>
<td><p>informixdb</p></td>
</tr>
<tr class="row-even"><td><p>Ingres</p></td>
<td><p>ingresdbi</p></td>
</tr>
<tr class="row-odd"><td><p>CUBRID</p></td>
<td><p>cubriddb</p></td>
</tr>
<tr class="row-even"><td><p>Sybase</p></td>
<td><p>Sybase</p></td>
</tr>
<tr class="row-odd"><td><p>Teradata</p></td>
<td><p>pyodbc</p></td>
</tr>
<tr class="row-even"><td><p>SAPDB</p></td>
<td><p>sapdb</p></td>
</tr>
<tr class="row-odd"><td><p>MongoDB</p></td>
<td><p>pymongo</p></td>
</tr>
<tr class="row-even"><td><p>IMAP</p></td>
<td><p>imaplib</p></td>
</tr>
</tbody>
</table>
<p>Support of MongoDB is experimental. Google NoSQL is treated as a particular case.
The <a class="reference internal" href="#gotchas">Gotchas</a> section at the end of this chapter has some more information
about specific databases.</p>
</section>
<section id="the-dal-a-quick-tour">
<h3>The DAL: a quick tour<a class="headerlink" href="#the-dal-a-quick-tour" title="Link permanente para este título"></a></h3>
<p>define py4web as seguintes classes que compõem o DAL:</p>
<dl>
<dt>DAL</dt><dd><p>represents a database connection. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt>Table</dt><dd><p>represents a database table. You do not directly instantiate
Table; instead, <code class="docutils literal notranslate"><span class="pre">DAL.define_table</span></code> does.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;mytable&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;myfield&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Os métodos mais importantes de uma tabela são:</p>
<p>`` Insert``, `` truncate``, `` drop``, e `` import_from_csv_file``.</p>
</dd>
<dt>Field</dt><dd><p>represents a database field. It can be instantiated and passed
as an argument to <code class="docutils literal notranslate"><span class="pre">DAL.define_table</span></code>.</p>
</dd>
<dt>Rows</dt><dd><p>is the object returned by a database select. It can be
thought of as a list of <code class="docutils literal notranslate"><span class="pre">Row</span></code> rows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div>
</div>
</dd>
<dt>Row</dt><dd><p>contains field values.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
    <span class="nb">print</span> <span class="n">row</span><span class="o">.</span><span class="n">myfield</span>
</pre></div>
</div>
</dd>
<dt>Query</dt><dd><p>is an object that represents a SQL “where” clause:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span> <span class="o">&gt;</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd>
<dt>Set</dt><dd><p>is an object that represents a set of records. Its most
important methods are <code class="docutils literal notranslate"><span class="pre">count</span></code>, <code class="docutils literal notranslate"><span class="pre">select</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>, and <code class="docutils literal notranslate"><span class="pre">delete</span></code>.
For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myset</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">myquery</span><span class="p">)</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">myset</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">myset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
<span class="n">myset</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
</dd>
<dt>Expression</dt><dd><p>is something like an <code class="docutils literal notranslate"><span class="pre">orderby</span></code> or <code class="docutils literal notranslate"><span class="pre">groupby</span></code>
expression. The Field class is derived from the Expression. Here is an
example.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myorder</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">|</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">id</span>
<span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="n">myorder</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</section>
<section id="using-the-dal-stand-alone">
<h3>Usando o DAL “stand-alone”<a class="headerlink" href="#using-the-dal-stand-alone" title="Link permanente para este título"></a></h3>
<p>pyDAL is an independent python package. As such, it can be used
without the web2py/py4web environment; you just need to install
it with <code class="docutils literal notranslate"><span class="pre">pip</span></code>. Then import the pydal module when needed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pydal</span> <span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Even if you can import modules directly from pydal, this is not
advisable from within py4web applications. Remember that <code class="docutils literal notranslate"><span class="pre">py4web.DAL</span></code>
is a fixture, <code class="docutils literal notranslate"><span class="pre">pydal.DAL</span></code> is not. In this context, the last command
should better be:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
</pre></div>
</div>
</div>
</section>
<section id="experiment-with-the-py4web-shell">
<h3>Experimentar com o shell py4web<a class="headerlink" href="#experiment-with-the-py4web-shell" title="Link permanente para este título"></a></h3>
<p>You can also experiment with the pyDAL API using the py4web shell,
that is available using the <a class="reference internal" href="chapter-03.html#shell-command-option"><span class="std std-ref">Opção `` comando shell``</span></a>.</p>
<div class="admonition warning">
<p class="admonition-title">Aviso</p>
<p>Mind that
database changes may be persistent. So be careful and do NOT hesitate
to create a new application for doing testing instead of tampering
with an existing one.</p>
</div>
<p>Note that most of the code snippets that contain the python prompt
<code class="docutils literal notranslate"><span class="pre">&gt;&gt;&gt;</span></code> are also directly executable via a py4web shell.</p>
<p>This is a simple example, using the provided <code class="docutils literal notranslate"><span class="pre">examples</span></code> app:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">apps.examples</span> <span class="kn">import</span> <span class="n">db</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">tables</span><span class="p">()</span>
<span class="go">[&#39;auth_user&#39;, &#39;auth_user_tag_groups&#39;, &#39;person&#39;, &#39;superhero&#39;, &#39;superpower&#39;, &#39;tag&#39;, &#39;product&#39;, &#39;thing&#39;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">superhero</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="go">&lt;Row {&#39;id&#39;: 1, &#39;tag&#39;: &lt;Set (&quot;tag&quot;.&quot;superhero&quot; = 1)&gt;, &#39;name&#39;: &#39;Superman&#39;, &#39;real_identity&#39;: 1}&gt;</span>
</pre></div>
</div>
<p>You can also start by creating a connection from zero. For the sake of simplicity, you
can use SQLite. Nothing in this discussion changes when you switch the back-end
engine.</p>
</section>
</section>
<section id="dal-constructor">
<h2>Construtor DAL<a class="headerlink" href="#dal-constructor" title="Link permanente para este título"></a></h2>
<p>Uso básico:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>O banco de dados agora está conectado e a conexão é armazenado na variável global `` db``.</p>
<p>A qualquer momento você pode recuperar a string de conexão.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">_uri</span>
<span class="go">sqlite://storage.sqlite</span>
</pre></div>
</div>
<p>e o nome do banco</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">_dbname</span>
<span class="go">sqlite</span>
</pre></div>
</div>
<p>The connection string is called <code class="docutils literal notranslate"><span class="pre">_uri</span></code> because it is an instance of
a uniform resource identifier.</p>
<p>A DAL permite várias ligações com o mesmo banco de dados ou com diferentes bases de dados, mesmo bases de dados de diferentes tipos. Por enquanto, vamos supor a presença de um único banco de dados uma vez que esta é a situação mais comum.</p>
<section id="dal-signature">
<h3>Assinatura da DAL<a class="headerlink" href="#dal-signature" title="Link permanente para este título"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DAL</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="s1">&#39;sqlite://dummy.db&#39;</span><span class="p">,</span>
    <span class="n">pool_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">db_codec</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span>
    <span class="n">check_reserved</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">migrate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">fake_migrate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">migrate_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">fake_migrate_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">decode_credentials</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">driver_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">adapter_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">attempts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">auto_import</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">bigint_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">lazy_tables</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">db_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">do_connect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">after_connection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ignore_field_case</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">entity_quoting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">table_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="connection-strings-the-uri-parameter">
<h3>Strings de conexão (o parâmetro uri)<a class="headerlink" href="#connection-strings-the-uri-parameter" title="Link permanente para este título"></a></h3>
<p>Uma ligação com o banco de dados é estabelecida através da criação de uma instância do objecto DAL:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>`` Db`` não é uma palavra-chave; é uma variável local que armazena o objeto de conexão `` DAL``. Você é livre para dar-lhe um nome diferente. O construtor de `` DAL`` requer um único argumento, a string de conexão. A seqüência de conexão é o único código py4web que depende de um banco de dados específico back-end. Aqui estão alguns exemplos de strings de conexão para tipos específicos de bancos de dados de back-end suportados (em todos os cases, assumimos o banco de dados está sendo executado a partir de localhost na sua porta padrão e é chamado de “teste”):</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 27%" />
<col style="width: 73%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Database</p></th>
<th class="head"><p>Connection string</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>** ** SQLite</p></td>
<td><p>`` SQLite: // storage.sqlite``</p></td>
</tr>
<tr class="row-odd"><td><p>** ** MySQL</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mysql://username:password&#64;localhost/test?set_encoding</span>
<span class="pre">=utf8mb4</span></code></p></td>
</tr>
<tr class="row-even"><td><p>** ** PostgreSQL</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">postgres://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>** MSSQL (legado) **</p></td>
<td><p>`` Mssql: // username: password &#64; localhost / test``</p></td>
</tr>
<tr class="row-even"><td><p>** MSSQL (&gt; = 2005) **</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mssql3://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>** MSSQL (&gt; = 2012) **</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mssql4://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-even"><td><p>** ** FireBird</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">firebird://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Oráculo</strong></p></td>
<td><p>`` Oracle: // username / password &#64; test``</p></td>
</tr>
<tr class="row-even"><td><p>** ** DB2</p></td>
<td><p>`` Db2: // username: password &#64; test``</p></td>
</tr>
<tr class="row-odd"><td><p>** ** Ingres</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ingres://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-even"><td><p>** ** Sybase</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">sybase://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>** ** Informix</p></td>
<td><p>`` Informix: // username: password &#64; test``</p></td>
</tr>
<tr class="row-even"><td><p>** ** Teradata</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">teradata://DSN=dsn;UID=user;PWD=pass;DATABASE=test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>** ** CUBRID</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">cubrid://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-even"><td><p>** ** SAPDB</p></td>
<td><p>`` Sapdb: // username: password &#64; localhost / test``</p></td>
</tr>
<tr class="row-odd"><td><p>** ** IMAP</p></td>
<td><p>`` Imap: // utilizador: senha &#64; servidor: port``</p></td>
</tr>
<tr class="row-even"><td><p>** ** MongoDB</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">mongodb://username:password&#64;localhost/test</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>** Google / SQL **</p></td>
<td><p>`` Google: sql: // projecto: instance / database``</p></td>
</tr>
<tr class="row-even"><td><p>** Google / NoSQL **</p></td>
<td><p>`` Google: datastore``</p></td>
</tr>
<tr class="row-odd"><td><p>** Google / NoSQL / NDB **</p></td>
<td><p>`` Google: armazenamento de dados + ndb``</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>in SQLite the database consists of a single file. If it does
not exist, it is created. This file is locked every time it is accessed.</p></li>
<li><p>in the case of MySQL, PostgreSQL, MSSQL, FireBird, Oracle, DB2, Ingres
and Informix the database “test” must be created outside py4web. Once
the connection is established, py4web will create, alter, and drop
tables appropriately.</p></li>
<li><p>in the MySQL connection string, the <code class="docutils literal notranslate"><span class="pre">?set_encoding=utf8mb4</span></code> at the end
sets the encoding to UTF-8 and avoids an
<code class="docutils literal notranslate"><span class="pre">Invalid</span> <span class="pre">utf8</span> <span class="pre">character</span> <span class="pre">string:</span></code> error on Unicode characters that
consist of four bytes, as by default, MySQL can only handle Unicode
characters that consist of one to three bytes.</p></li>
<li><p>in the Google/NoSQL case the <code class="docutils literal notranslate"><span class="pre">+ndb</span></code> option turns on NDB. NDB uses a
Memcache buffer to read data that is accessed often. This is completely
automatic and done at the datastore level, not at the py4web level.</p></li>
<li><p>it is also possible to set the connection string to <code class="docutils literal notranslate"><span class="pre">None</span></code>. In this
case DAL will not connect to any back-end database, but the API can
still be accessed for testing.</p></li>
</ul>
<p>Some times you may also need to generate SQL as if you had a connection but
without actually connecting to the database. This can be done with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">,</span> <span class="n">do_connect</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case you will be able to call <code class="docutils literal notranslate"><span class="pre">_select</span></code>, <code class="docutils literal notranslate"><span class="pre">_insert</span></code>,
<code class="docutils literal notranslate"><span class="pre">_update</span></code>, and <code class="docutils literal notranslate"><span class="pre">_delete</span></code> to generate SQL but not call <code class="docutils literal notranslate"><span class="pre">select</span></code>,
<code class="docutils literal notranslate"><span class="pre">insert</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>, and <code class="docutils literal notranslate"><span class="pre">delete</span></code>; see <a class="reference internal" href="#generating-raw-sql">Generating raw SQL</a>
for details. In most of the cases you can use
<code class="docutils literal notranslate"><span class="pre">do_connect=False</span></code> even without having the required database drivers.</p>
<p>Observe que, por padrão py4web usos utf8 codificação de caracteres para bancos de dados. Se você trabalha com bancos de dados que se comportam de forma diferente existente, você tem que mudá-lo com o parâmetro opcional `` db_codec`` como</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">,</span> <span class="n">db_codec</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Caso contrário, você vai ter bilhetes UnicodeDecodeError.</p>
</section>
<section id="connection-pooling">
<h3>O pool de conexões<a class="headerlink" href="#connection-pooling" title="Link permanente para este título"></a></h3>
<p>Um argumento comum do construtor DAL é a `` pool_size``; o padrão é zero.</p>
<p>As it is rather slow to establish a new database connection for each
request, py4web implements a mechanism for connection pooling. Once a
connection is established and the page has been served and the
transaction completed, the connection is not closed but goes into a
pool. When the next request arrives, py4web tries to recycle a
connection from the pool and use that for the new transaction. If there
are no available connections in the pool, a new connection is
established.</p>
<p>Quando py4web começa, a piscina é sempre vazio. A piscina cresce até o mínimo entre o valor de `` pool_size`` e o número máximo de solicitações simultâneas. Isto significa que se `` POOL_SIZE = 10`` mas o nosso servidor nunca recebe mais de 5 solicitações simultâneas, em seguida, o tamanho real piscina só vai crescer a 5. Se `` POOL_SIZE = 0`` então o pool de conexão não é usada.</p>
<p>Conexões nas piscinas são compartilhados sequencialmente entre threads, no sentido de que eles podem ser usados ​​por dois tópicos diferentes, mas não simultâneas. Há apenas uma piscina para cada processo py4web.</p>
<p>O parâmetro `` pool_size`` é ignorado pelo SQLite e Google App Engine. pool de conexão é ignorado para SQLite, uma vez que não daria qualquer benefício.</p>
</section>
<section id="connection-failures-attempts-parameter">
<h3>Falhas de conexão (parâmetro tentativas)<a class="headerlink" href="#connection-failures-attempts-parameter" title="Link permanente para este título"></a></h3>
<p>Se py4web não consegue se conectar ao banco de dados que espera 1 segundo e por tentativas padrão novamente até 5 vezes antes de declarar um fracasso. No case do pool de conexão, é possível que uma conexão em pool que permanece aberta, mas sem uso por algum tempo está fechado até o final de banco de dados. Graças à py4web recurso repetição tenta restabelecer essas ligações interrompidas. O número de tentativas é definido através do parâmetro tentativas.</p>
</section>
<section id="lazy-tables">
<h3>Tabelas preguiçosos<a class="headerlink" href="#lazy-tables" title="Link permanente para este título"></a></h3>
<p>Setting <code class="docutils literal notranslate"><span class="pre">lazy_tables</span> <span class="pre">=</span> <span class="pre">True</span></code> provides a major performance boost (but
not with py4web). It means that table creation is deferred until the
table is actually referenced.</p>
<div class="admonition warning">
<p class="admonition-title">Aviso</p>
<p>You should never use lazy tables in py4web. There is no advantage,
no need, and possibly concurrency problems.</p>
</div>
</section>
<section id="model-less-applications">
<h3>Aplicativos de modelo-less<a class="headerlink" href="#model-less-applications" title="Link permanente para este título"></a></h3>
<p>In py4web the code defined outside of actions (where normally DAL tables
are defined) is only executed at startup.</p>
<p>However, it is possible to define DAL tables on demand inside actions.
This is referred to as “model-less” development by the py4web community.</p>
<p>To use the “model-less” approach, you take responsibility for doing
all the housekeeping tasks. You call the table definitions when you
need them, and provide database connection passed as parameter.
Also, remember maintainability: other py4web developers expect to find
database definitions in the <code class="docutils literal notranslate"><span class="pre">models.py</span></code> file.</p>
</section>
<section id="replicated-databases">
<h3>Bancos de dados replicados<a class="headerlink" href="#replicated-databases" title="Link permanente para este título"></a></h3>
<p>The first argument of <code class="docutils literal notranslate"><span class="pre">DAL(...)</span></code> can be a list of URIs. In this case
py4web tries to connect to each of them. The main purpose for this is to
deal with multiple database servers and distribute the workload among
them. Here is a typical use case:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">([</span><span class="s1">&#39;mysql://...1&#39;</span><span class="p">,</span> <span class="s1">&#39;mysql://...2&#39;</span><span class="p">,</span> <span class="s1">&#39;mysql://...3&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Neste case, as tentativas DAL para conectar-se a primeira e, em case de falha, ele vai tentar o segundo eo terceiro. Isto também pode ser utilizado para distribuir a carga em uma configuração de banco de dados mestre-escravo.</p>
</section>
<section id="reserved-keywords">
<h3>Palavras-chave reservadas<a class="headerlink" href="#reserved-keywords" title="Link permanente para este título"></a></h3>
<p>`` Check_reserved`` diz o construtor para verificar nomes de tabela e nomes de coluna contra palavras-chave reservada SQL em bancos de dados de back-end-alvo. `` padrões check_reserved`` a nenhum.</p>
<p>Esta é uma lista de strings que contêm os nomes de adaptador de banco de dados back-end.</p>
<p>The adapter name is the same as used in the DAL connection string. So if
you want to check against PostgreSQL and MSSQL then your db connection
would look as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">,</span> <span class="n">check_reserved</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span> <span class="s1">&#39;mssql&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>A DAL irá analisar as palavras-chave na mesma ordem da lista.</p>
<p>Existem duas opções extras “todos” e “comum”. Se você especificar tudo, ele irá verificar contra todas as palavras-chave SQL conhecidos. Se você especificar comum, ele só irá verificar contra palavras-chave SQL comuns, tais como `` SELECT``, `` INSERT``, `` update``, etc.</p>
<p>For supported back ends you may also specify if you would like to check
against the non-reserved SQL keywords as well. In this case you would
append <code class="docutils literal notranslate"><span class="pre">_nonreserved</span></code> to the name. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">check_reserved</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span> <span class="s1">&#39;postgres_nonreserved&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Os seguintes backends de banco de dados suportar palavras reservadas verificação.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 35%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Database</p></th>
<th class="head"><p>check_reserved</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>** ** PostgreSQL</p></td>
<td><p>`` Postgres (_nonreserved) ``</p></td>
</tr>
<tr class="row-odd"><td><p>** ** MySQL</p></td>
<td><p>`` Mysql``</p></td>
</tr>
<tr class="row-even"><td><p>** ** FireBird</p></td>
<td><p>`` Firebird (_nonreserved) ``</p></td>
</tr>
<tr class="row-odd"><td><p>** ** MSSQL</p></td>
<td><p>`` mssql``</p></td>
</tr>
<tr class="row-even"><td><p><strong>Oráculo</strong></p></td>
<td><p>`` oracle``</p></td>
</tr>
</tbody>
</table>
</section>
<section id="database-quoting-and-case-settings">
<h3>Configurações de quoting e case e do  banco de dados<a class="headerlink" href="#database-quoting-and-case-settings" title="Link permanente para este título"></a></h3>
<p>Citando de entidades SQL são ativadas por padrão em DAL, isto é:</p>
<p>`` Entity_quoting = True``</p>
<p>Desta forma, os identificadores são automaticamente citado em SQL gerado pelo DAL. No SQL palavras-chave de nível e identificadores não cotadas são maiúsculas e minúsculas, quoting assim uma SQL identificador torna maiúsculas de minúsculas.</p>
<blockquote>
<div><p>Note-se que os identificadores não indicada deve sempre ser dobrado para minúsculas pelo motor de back-end acordo com a norma SQL, mas nem todos os motores estão em conformidade com o presente (por exemplo de dobragem PostgreSQL padrão é maiúsculas).</p>
</div></blockquote>
<p>Por DAL padrão ignora case de campo também, para mudar este uso:</p>
<p>`` Ignore_field_case = False``</p>
<p>Para ter certeza de usar os mesmos nomes em python e no esquema DB, você deve organizar para ambas as configurações acima. Aqui está um exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="n">ignore_field_case</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;table1&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;column&#39;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;COLUMN&#39;</span><span class="p">))</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">table1</span><span class="o">.</span><span class="n">COLUMN</span> <span class="o">!=</span> <span class="n">db</span><span class="o">.</span><span class="n">table1</span><span class="o">.</span><span class="n">column</span>
</pre></div>
</div>
</section>
<section id="making-a-secure-connection">
<h3>Fazendo uma conexão segura<a class="headerlink" href="#making-a-secure-connection" title="Link permanente para este título"></a></h3>
<p>Às vezes é necessário (e recomendado) para se conectar ao seu banco de dados usando conexão segura, especialmente se o seu banco de dados não está no mesmo servidor como a sua aplicação. Neste case, você precisa passar parâmetros adicionais para o driver de banco de dados. Você deve consultar a documentação do driver de banco de dados para obter detalhes.</p>
<p>Para PostgreSQL com psycopg2 ele deve ser parecido com isto:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;postgres://user_name:user_password@server_addr/db_name&#39;</span><span class="p">,</span>
    <span class="n">driver_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sslmode&#39;</span><span class="p">:</span> <span class="s1">&#39;require&#39;</span><span class="p">,</span> <span class="s1">&#39;sslrootcert&#39;</span><span class="p">:</span> <span class="s1">&#39;root.crt&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;sslcert&#39;</span><span class="p">:</span> <span class="s1">&#39;postgresql.crt&#39;</span><span class="p">,</span> <span class="s1">&#39;sslkey&#39;</span><span class="p">:</span> <span class="s1">&#39;postgresql.key&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>onde os parâmetros `` sslrootcert``, `` sslcert`` e `` sslkey`` deve conter o caminho completo para os arquivos. Você deve consultar a documentação do PostgreSQL sobre como configurar o servidor PostgreSQL para aceitar conexões seguras.</p>
</section>
<section id="other-dal-constructor-parameters">
<h3>Outros parâmetros do construtor DAL<a class="headerlink" href="#other-dal-constructor-parameters" title="Link permanente para este título"></a></h3>
<section id="database-folder-location">
<h4>Local de pasta do banco de dados<a class="headerlink" href="#database-folder-location" title="Link permanente para este título"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">folder</span></code> sets the place where migration files will be created (see
<a class="reference internal" href="#migrations">Migrations</a> for details).
It is also used for SQLite databases. Automatically set within py4web.
Set a path when using DAL outside py4web.</p>
</section>
<section id="default-migration-settings">
<h4>Configurações padrão de migração<a class="headerlink" href="#default-migration-settings" title="Link permanente para este título"></a></h4>
<p>As configurações de migração construtor DAL são booleans que afetam padrões e comportamento global.</p>
<p>`` Migrar = True`` define o comportamento de migração padrão para todas as tabelas</p>
<p>`` Fake_migrate = False`` define o comportamento fake_migrate padrão para todas as tabelas</p>
<p>`` Migrate_enabled = True`` se definido como desativa falsas todas as migrações</p>
<p>`` Fake_migrate_all = False`` Se definido como falso migra Verdadeiros todas as tabelas</p>
</section>
</section>
<section id="commit-and-rollback">
<h3>`` `` commit`` e rollback``<a class="headerlink" href="#commit-and-rollback" title="Link permanente para este título"></a></h3>
<p>The insert, truncate, delete, and update operations aren’t actually
committed until py4web issues the commit command. The create and drop
operations may be executed immediately, depending on the database
engine.</p>
<p>If you pass <code class="docutils literal notranslate"><span class="pre">db</span></code> in an <code class="docutils literal notranslate"><span class="pre">action.uses</span></code> decorator, you don’t need to call
commit in the controller, it is done for you.  (Also, if you use
<code class="docutils literal notranslate"><span class="pre">authenticated</span></code> or <code class="docutils literal notranslate"><span class="pre">unauthenticated</span></code> decorator.)</p>
<div class="admonition tip">
<p class="admonition-title">Dica</p>
<p>always add <code class="docutils literal notranslate"><span class="pre">db</span></code> in an <code class="docutils literal notranslate"><span class="pre">action.uses</span></code> decorator (or use the
<code class="docutils literal notranslate"><span class="pre">authenticated</span></code> or <code class="docutils literal notranslate"><span class="pre">unauthenticated</span></code> decorator).
Otherwise you have to add <code class="docutils literal notranslate"><span class="pre">db.commit()</span></code> in every define_table and
in every table activities: insert(), update(), delete()</p>
</div>
<p>So in actions there is normally no need to ever call
<code class="docutils literal notranslate"><span class="pre">commit</span></code> or <code class="docutils literal notranslate"><span class="pre">rollback</span></code> explicitly in py4web unless you need more
granular control.</p>
<p>But if you executed commands via the shell, you are required
to manually commit:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<p>Para verificar isso, vamos inserir um novo registro:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Bob&quot;</span><span class="p">)</span>
<span class="go">2</span>
</pre></div>
</div>
<p>and roll de volta, ou seja, ignorar todas as operações desde o último commit:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</pre></div>
</div>
<p>Se você agora inserir novamente, o contador voltará a ser definido para 2, desde a inserção anterior foi revertida.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Bob&quot;</span><span class="p">)</span>
<span class="go">2</span>
</pre></div>
</div>
<p>Code in models, views and controllers is enclosed in py4web code that
looks like this (pseudo code):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">execute</span> <span class="n">models</span><span class="p">,</span> <span class="n">controller</span> <span class="n">function</span> <span class="ow">and</span> <span class="n">view</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">rollback</span> <span class="nb">all</span> <span class="n">connections</span>
    <span class="n">log</span> <span class="n">the</span> <span class="n">traceback</span>
    <span class="n">send</span> <span class="n">a</span> <span class="n">ticket</span> <span class="n">to</span> <span class="n">the</span> <span class="n">visitor</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">commit</span> <span class="nb">all</span> <span class="n">connections</span>
    <span class="n">save</span> <span class="n">cookies</span><span class="p">,</span> <span class="n">sessions</span> <span class="ow">and</span> <span class="k">return</span> <span class="n">the</span> <span class="n">page</span>
</pre></div>
</div>
</section>
</section>
<section id="table-constructor">
<h2>Construtor Table<a class="headerlink" href="#table-constructor" title="Link permanente para este título"></a></h2>
<p>As tabelas são definidos na DAL via `` define_table``.</p>
<section id="define-table-signature">
<h3>assinatura define_table<a class="headerlink" href="#define-table-signature" title="Link permanente para este título"></a></h3>
<p>A assinatura para o método define_table é:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">define_table</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="o">*</span><span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>Ele aceita um nome de tabela de preenchimento obrigatório e um número opcional de `` cases Field`` (mesmo nenhum). Você também pode passar um Table`` objeto (ou subclasse) `` em vez de um `` Field`` um, este clones e adiciona todos os campos (mas o “id”) com a tabela de definição. Outros argumentos de palavra-chave opcionais são: `` rname``, `` redefine``, `` common_filter``, `` fake_migrate``, `` fields``, `` format``, `` migrate``, `` on_define``, `` plural``, `` polymodel``, `` primarykey``, `` sequence_name``, `` singular``, `` table_class``, e `` trigger_name``, que são discutidos abaixo.</p>
<p>Por exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
</pre></div>
</div>
<p>Ele define, lojas e retorna um objeto `` Table`` chamado “pessoa” contendo um campo (coluna) “nome”. Este objeto também pode ser acessado via `` db.person``, assim você não precisa pegar o valor retornado pelo define_table.</p>
</section>
<section id="id-notes-about-the-primary-key">
<h3>`` Id``: Notas sobre a chave primária<a class="headerlink" href="#id-notes-about-the-primary-key" title="Link permanente para este título"></a></h3>
<p>Não declare um campo chamado “id”, porque um é criado por py4web de qualquer maneira. Cada tabela tem um campo chamado “id” por padrão. É um campo inteiro de auto-incremento (geralmente a partir de 1) utilizados para referência cruzada e para fazer cada registro original, assim que “id” é uma chave primária. (Nota: o contador id a partir de 1 é específico back-end Por exemplo, isto não se aplica ao Google App Engine NoSQL..)</p>
<p>Opcionalmente, você pode definir um campo de “type =” id”`` <cite>e py4web usará este campo como campo id auto-incremento. Isso não é recomendado, exceto quando acessar as tabelas de banco de dados legado que têm uma chave primária com um nome diferente. Com alguma limitação, você também pode usar diferentes chaves primárias usando o parâmetro `</cite> primarykey``.</p>
</section>
<section id="plural-and-singular">
<h3>`` `` Plural`` e singular``<a class="headerlink" href="#plural-and-singular" title="Link permanente para este título"></a></h3>
<p>As pyDAL is a general DAL, it includes plural and singular attributes to
refer to the table names so that external elements can use the proper
name for a table.</p>
</section>
<section id="redefine">
<h3>`` Redefine``<a class="headerlink" href="#redefine" title="Link permanente para este título"></a></h3>
<p>As tabelas podem ser definidas apenas uma vez, mas você pode forçar py4web redefinir uma tabela existente:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="n">redefine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>A redefinição pode provocar uma migração se definição tabela muda.</p>
</section>
<section id="format-record-representation">
<h3>`` Format``: representação da ficha<a class="headerlink" href="#format-record-representation" title="Link permanente para este título"></a></h3>
<p>É opcional, mas recomendado para especificar uma representação formato para registros com o parâmetro `` format``.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>ou</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1"> </span><span class="si">%(id)s</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>ou mesmo os mais complexos usando uma função:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="nb">format</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;anonymous&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The format attribute will be used for two purposes:</p>
<ul class="simple">
<li><p>To represent referenced records in select/option drop-downs.</p></li>
<li><p>To set the <code class="docutils literal notranslate"><span class="pre">db.othertable.otherfield.represent</span></code> attribute for all fields
referencing this table. This means that the <code class="docutils literal notranslate"><span class="pre">Form</span></code> constructor will
not show references by id but will use the preferred format
representation instead.</p></li>
</ul>
</section>
<section id="rname-real-name">
<h3>`` Rname``: nome real<a class="headerlink" href="#rname-real-name" title="Link permanente para este título"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">rname</span></code> sets a database backend name for the table. This makes the
py4web table name an alias, and <code class="docutils literal notranslate"><span class="pre">rname</span></code> is the real name used when
constructing the query for the backend. To illustrate just one use,
<code class="docutils literal notranslate"><span class="pre">rname</span></code> can be used to provide MSSQL fully qualified table names
accessing tables belonging to other databases on the server:
<code class="docutils literal notranslate"><span class="pre">rname</span> <span class="pre">=</span> <span class="pre">'db1.dbo.table1'</span></code></p>
</section>
<section id="primarykey-support-for-legacy-tables">
<h3>`` Primarykey``: Suporte para tabelas legadas<a class="headerlink" href="#primarykey-support-for-legacy-tables" title="Link permanente para este título"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">primarykey</span></code> helps support legacy tables with existing primary keys,
even multi-part. See <a class="reference internal" href="#legacy-databases-and-keyed-tables">Legacy databases and keyed tables</a>.</p>
</section>
<section id="migrate-fake-migrate">
<h3>`` Migrate``, `` fake_migrate``<a class="headerlink" href="#migrate-fake-migrate" title="Link permanente para este título"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">migrate</span></code> sets migration options for the table. Refer to
<a class="reference internal" href="#migrations">Migrations</a> for details.</p>
</section>
<section id="table-class">
<h3>`` Table_class``<a class="headerlink" href="#table-class" title="Link permanente para este título"></a></h3>
<p>If you define your own table class as a sub-class of
pydal.objects.Table, you can provide it here; this allows you to extend
and override methods. Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pydal.objects</span> <span class="kn">import</span> <span class="n">Table</span>

<span class="k">class</span> <span class="nc">MyTable</span><span class="p">(</span><span class="n">Table</span><span class="p">):</span>
    <span class="o">...</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">table_class</span><span class="o">=</span><span class="n">MyTable</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="sequence-name">
<h3>`` Sequence_name``<a class="headerlink" href="#sequence-name" title="Link permanente para este título"></a></h3>
<p>O nome de uma seqüência tabela personalizada (se suportado pelo banco de dados). Pode criar uma seqüência (a partir de 1 e incrementando por 1) ou usar isso para tabelas legadas com seqüências personalizadas.</p>
<blockquote>
<div><p>Observe que, quando necessário, py4web vai criar seqüências automaticamente por padrão.</p>
</div></blockquote>
</section>
<section id="trigger-name">
<h3>`` Trigger_name``<a class="headerlink" href="#trigger-name" title="Link permanente para este título"></a></h3>
<p>Refere-se a `` sequence_name``. Relevante para alguns backends que não suportam campos numéricos auto-incremento.</p>
</section>
<section id="polymodel">
<h3>`` polymodel``<a class="headerlink" href="#polymodel" title="Link permanente para este título"></a></h3>
<p>For use with Google App Engine.</p>
</section>
<section id="on-define">
<h3>`` On_define``<a class="headerlink" href="#on-define" title="Link permanente para este título"></a></h3>
<p>`` On_define`` é uma chamada de retorno acionado quando um lazy_table é instanciado, embora ela é chamada de qualquer maneira, se a tabela não é preguiçoso. Isso permite que mudanças dinâmicas para a mesa sem perder as vantagens de instanciação adiada.</p>
<p>Exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="n">lazy_tables</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
    <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">),</span>
    <span class="n">on_define</span><span class="o">=</span><span class="k">lambda</span> <span class="n">table</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">set_attributes</span><span class="p">(</span><span class="n">requires</span><span class="o">=</span><span class="n">IS_NOT_EMPTY</span><span class="p">(),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="n">table</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">set_attributes</span><span class="p">(</span><span class="n">requires</span><span class="o">=</span><span class="n">IS_INT_IN_RANGE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="p">])</span>
</pre></div>
</div>
<p>Nota Este exemplo mostra como usar `` on_define`` mas não é realmente necessário. O simples `` valores requires`` poderiam ser adicionados às definições de campo ea mesa ainda seria preguiçoso. No entanto, `` requires`` que tomar um objeto definido como o primeiro argumento, como IS_IN_DB, vai fazer uma consulta como `` db.sometable.somefield == some_value`` que causaria `` sometable`` a ser definido no início . Esta é a situação salvos por `` on_define``.</p>
</section>
<section id="adding-attributes-to-fields-and-tables">
<h3>Adicionando atributos para campos e tabelas<a class="headerlink" href="#adding-attributes-to-fields-and-tables" title="Link permanente para este título"></a></h3>
<p>Se você precisa adicionar atributos personalizados aos campos, você pode simplesmente fazer isso: `` db.table.field.extra = {} ``</p>
<p>“extra” is not a keyword; it’s a custom attribute now attached to the
field object. You can do it with tables too but they must be preceded by
an underscore to avoid naming conflicts with fields:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">_extra</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
</section>
<section id="legacy-databases-and-keyed-tables">
<h3>Bancos de dados legados e tabelas com chave<a class="headerlink" href="#legacy-databases-and-keyed-tables" title="Link permanente para este título"></a></h3>
<p>py4web pode se conectar a bancos de dados legados sob algumas condições.</p>
<p>The easiest way is when these conditions are met:</p>
<ul class="simple">
<li><p>Each table must have a unique auto-increment integer field called “id”.</p></li>
<li><p>Records must be referenced exclusively using the “id” field.</p></li>
</ul>
<p>Ao acessar uma tabela existente, isto é, uma tabela não criado por py4web no aplicativo atual, sempre definir `` migrar = False``.</p>
<p>Se a tabela de legado tem um campo inteiro de auto-incremento, mas não é chamado de “id”, py4web ainda pode acessá-lo, mas a definição da tabela deve declarar o campo de incremento automático com o tipo de “id” (que está usando campo `` (” … “, “id”) <a href="#id1"><span class="problematic" id="id2">``</span></a>).</p>
<p>Finalmente se a tabela de legado usa uma chave primária que não é um campo id auto-incremento é possível usar uma “mesa com chave”, por exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;account&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;accnum&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;acctype&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;accdesc&#39;</span><span class="p">),</span>
                <span class="n">primarykey</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accnum&#39;</span><span class="p">,</span> <span class="s1">&#39;acctype&#39;</span><span class="p">],</span>
                <span class="n">migrate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>`` Primarykey`` é uma lista dos nomes de campo que compõem a chave primária.</p></li>
<li><p>Todos os campos PrimaryKey tem um `` NÃO NULL`` definido, mesmo se não especificado.</p></li>
<li><p>Tabelas com chave só podem referenciar outras tabelas com chave.</p></li>
<li><p>Campos de referência devem usar o <code class="docutils literal notranslate"><span class="pre">reference</span> <span class="pre">tablename.fieldname</span></code>.</p></li>
<li><p>A `` função update_record`` não está disponível para filas de mesas com chave.</p></li>
</ul>
<blockquote>
<div><p>Atualmente tabelas chaveadas são suportadas apenas para DB2, MSSQL, Ingres e Informix, mas serão adicionados outros engines.</p>
</div></blockquote>
<p>No momento da escrita, não podemos garantir que os `` obras de atributos primarykey`` com cada mesa legado existente e cada backend de banco de dados suportado. Para simplificar, recomendamos, se possível, criando uma visão do banco de dados que tem um campo id auto-incremento.</p>
</section>
</section>
<section id="field-constructor">
<h2>Construtor Field<a class="headerlink" href="#field-constructor" title="Link permanente para este título"></a></h2>
<p>Estes são os valores padrão de um construtor de campo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Field</span><span class="p">(</span><span class="n">fieldname</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT</span><span class="p">,</span>
      <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">DEFAULT</span><span class="p">,</span>
      <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">,</span> <span class="n">notnull</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
      <span class="n">uploadfield</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">widget</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">writable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">searchable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">listable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
      <span class="n">update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">authorize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autodelete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">represent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">uploadfolder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uploadseparate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uploadfs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">compute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">custom_qualifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">map_none</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rname</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>onde padrão é um valor especial usado para permitir que o valor Nenhum para um parâmetro.</p>
<p>Nem todos eles são relevantes para todos os campos. `` Length`` é relevante apenas para campos do tipo “string”. `` Uploadfield``, `` authorize``, e `` autodelete`` são relevantes apenas para campos do tipo “Upload”. `` Ondelete`` é relevante apenas para campos do tipo “referência” e “Upload”.</p>
<ul>
<li><p>`` Length`` define o comprimento máximo de uma “string”, “password” ou campo “Upload”. Se `` length`` não for especificado um valor padrão é usado, mas o valor padrão não é garantido para ser compatível. * Para evitar migrações indesejadas em upgrades, recomendamos que você sempre especificar o comprimento de campos de cordas, senha e upload. *</p></li>
<li><p>`` Default`` define o valor padrão para o campo. O valor padrão é utilizada quando se realiza uma inserção se um valor não for especificado explicitamente. É também usado para formas construídas a partir da tabela usando `` Form``-preencher previamente. Note, em vez de ser um valor fixo, o padrão em vez disso pode ser uma função (incluindo uma função lambda) que retorna um valor do tipo apropriado para o campo. Nesse case, a função é chamada uma vez para cada registro inserido, mesmo quando vários registros são inseridos em uma única transação.</p></li>
<li><p>`` Required`` conta a DAL que nenhuma inserção deve ser permitido nesta tabela se um valor para este campo não é especificado explicitamente.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">requires</span></code> is a <strong>validator</strong> or a list of validators. This is not used
by the DAL, but instead it is used by <code class="docutils literal notranslate"><span class="pre">Form</span></code> (this will be explained
better on the <a class="reference internal" href="chapter-12.html#forms"><span class="std std-ref">Forumlários</span></a> chapter). The default validators for
the given types are shown in the next section
<a class="reference internal" href="#field-types-and-validators"><span class="std std-ref">Field types and validators</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>while <code class="docutils literal notranslate"><span class="pre">requires=...</span></code> is enforced at the level of forms,
<code class="docutils literal notranslate"><span class="pre">required=True</span></code> is enforced at the level of the DAL (insert). In
addition, <code class="docutils literal notranslate"><span class="pre">notnull</span></code>, <code class="docutils literal notranslate"><span class="pre">unique</span></code> and <code class="docutils literal notranslate"><span class="pre">ondelete</span></code> are enforced at
the level of the database. While they sometimes may seem redundant,
it is important to maintain the distinction when programming with the
DAL.</p>
</div>
</li>
<li><p>`` Rname`` fornece o campo com um “nome real”, um nome para o campo conhecido para o adaptador de banco de dados; quando o campo é usado, ele é o valor rname que é enviado para o banco de dados. O nome py4web para o campo é então efetivamente um alias.</p></li>
<li><p>`` Ondelete`` traduz na “ON DELETE” instrução SQL. Por padrão, ele é definido como “em cascata”. Isso diz ao banco de dados que quando se exclui um registro, ele também deve excluir todos os registros que se referem a ele. Para desativar este recurso, conjunto de `` ondelete`` a “nenhuma acção” ou “NULL SET”.</p></li>
<li><p>`` Notnull = True`` se traduz na “NOT NULL” instrução SQL. Ela impede que a banco de dados a partir da inserção de valores nulos para o campo.</p></li>
<li><p>`` Unique = True`` se traduz na instrução SQL “único” e ele garante que os valores deste campo são exclusivos dentro da tabela. Ela é aplicada no nível de banco de dados.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uploadfield</span></code> applies only to fields of type “upload”. A field of
type “upload” stores the name of a file saved somewhere else, by
default on the filesystem under the application “uploads/” folder. If
<code class="docutils literal notranslate"><span class="pre">uploadfield</span></code> is set to True, then the file is stored in a blob
field within the same table and the value of <code class="docutils literal notranslate"><span class="pre">uploadfield</span></code> is the
name of the blob field. This will be discussed in more detail later
in <a class="reference internal" href="#more-on-uploads">More on uploads</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uploadfolder</span></code> must be set to a location where to store uploaded files.
The scaffolding app defines a folder <code class="docutils literal notranslate"><span class="pre">settings.UPLOAD_FOLDER</span></code>
which points to <code class="docutils literal notranslate"><span class="pre">apps/{app_name}/uploads</span></code> so you can
set, for example, <code class="docutils literal notranslate"><span class="pre">Field(...</span> <span class="pre">uploadfolder=settings.UPLOAD_FOLDER)</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uploadseparate</span></code> if set to True will upload files under different
subfolders of the <em>uploadfolder</em> folder. This is optimized to avoid
too many files under the same folder/subfolder. ATTENTION: You cannot
change the value of <code class="docutils literal notranslate"><span class="pre">uploadseparate</span></code> from True to False without
breaking links to existing uploads. pydal either uses the separate
subfolders or it does not. Changing the behavior after files have
been uploaded will prevent pydal from being able to retrieve those
files. If this happens it is possible to move files and fix the
problem but this is not described here.</p></li>
<li><p>`` Uploadfs`` permite que você especificar um sistema de arquivos diferente, onde fazer o upload de arquivos, incluindo um armazenamento Amazon S3 ou um armazenamento de SFTP remoto.</p></li>
</ul>
<blockquote>
<div><p>Você precisa ter PyFileSystem instalado para que isso funcione. `` Uploadfs`` deve apontar para PyFileSystem.</p>
</div></blockquote>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">autodelete</span></code> determines if the corresponding uploaded file should
be deleted when the record referencing the file is deleted. For
“upload” fields only. However, records deleted by the database itself
due to a CASCADE operation will not trigger py4web’s autodelete.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">label</span></code> is a string (or a helper or something that can be
serialized to a string) that contains the label to be used for this
field in auto-generated forms.
serialized to a string) that contains a comment associated with this
field, and will be displayed to the right of the input field in the
autogenerated forms.</p></li>
<li><p>`` Writable`` declara se um campo é gravável em formulários.</p></li>
<li><p>`` Readable`` declara se um campo é legível em formulários. Se um campo não é nem legível, nem gravável, não será exibido em criar e atualizar formas.</p></li>
<li><p>`` Update`` contém o valor padrão para este campo quando o registro é atualizado.</p></li>
<li><p>`` Compute`` é uma função opcional. Se um registro é inserido ou atualizado, a função de computação será executado eo campo será preenchido com o resultado da função. O registro é passado para a função de computação como um `` dict``, eo dict não incluirá o valor atual de que, ou qualquer outro campo de computação.</p></li>
<li><p>`` Authorize`` pode ser usado para exigir o controle de acesso no campo correspondente, para apenas os campos “Upload”. Ele será discutido mais em detalhe no contexto de autenticação e autorização.</p></li>
<li><p>`` Represent`` pode ser Nenhum ou pode apontar para uma função que recebe um valor de campo e retorna uma representação alternativa para o valor do campo. Exemplos:</p></li>
</ul>
<p>Note not all the attributes are thread safe and most of them
should only be set globally for an app. The following are guaranteed to be
thread safe and be set/reset in any action:
<code class="docutils literal notranslate"><span class="pre">default</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>, <code class="docutils literal notranslate"><span class="pre">readable</span></code>, <code class="docutils literal notranslate"><span class="pre">writable</span></code>, <code class="docutils literal notranslate"><span class="pre">requires</span></code>.</p>
<section id="field-types-and-validators">
<h3>Field types and validators<a class="headerlink" href="#field-types-and-validators" title="Link permanente para este título"></a></h3>
<table class="docutils align-default">
<colgroup>
<col style="width: 34%" />
<col style="width: 66%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Default validators</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>`` String``</p></td>
<td><p>`` IS_LENGTH (comprimento) `` comprimento padrão é 512</p></td>
</tr>
<tr class="row-odd"><td><p>`` text``</p></td>
<td><p>`` IS_LENGTH (comprimento) `` comprimento padrão é 32.768</p></td>
</tr>
<tr class="row-even"><td><p>`` blob``</p></td>
<td><p>`` Comprimento padrão None`` é 2 ** 31 (2 GIB)</p></td>
</tr>
<tr class="row-odd"><td><p>`` boolean``</p></td>
<td><p>`` None``</p></td>
</tr>
<tr class="row-even"><td><p>`` integer``</p></td>
<td><p>`` IS_INT_IN_RANGE (** -2 31, 2 ** 31) ``</p></td>
</tr>
<tr class="row-odd"><td><p>`` Double``</p></td>
<td><p>`` IS_FLOAT_IN_RANGE (-1e100, 1e100) ``</p></td>
</tr>
<tr class="row-even"><td><p>`` Decimal (n, m) ``</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_DECIMAL_IN_RANGE(-10**10,</span> <span class="pre">10**10)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>`` date``</p></td>
<td><p>`` IS_DATE () ``</p></td>
</tr>
<tr class="row-even"><td><p>`` Time``</p></td>
<td><p>`` IS_TIME () ``</p></td>
</tr>
<tr class="row-odd"><td><p>`` datetime``</p></td>
<td><p>`` IS_DATETIME () ``</p></td>
</tr>
<tr class="row-even"><td><p>`` password``</p></td>
<td><p>`` IS_LENGTH (comprimento) `` comprimento padrão é 512</p></td>
</tr>
<tr class="row-odd"><td><p>`` Upload``</p></td>
<td><p>`` Comprimento padrão é 512 None``</p></td>
</tr>
<tr class="row-even"><td><p>`` Referência &lt;table&gt; ``</p></td>
<td><p>`` IS_IN_DB (db, table.field, formato) ``</p></td>
</tr>
<tr class="row-odd"><td><p>`` Lista: string``</p></td>
<td><p>`` None``</p></td>
</tr>
<tr class="row-even"><td><p>`` Lista: integer``</p></td>
<td><p>`` None``</p></td>
</tr>
<tr class="row-odd"><td><p>`` Lista: referência &lt;table&gt; ``</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">IS_IN_DB(db,</span> <span class="pre">table._id,</span> <span class="pre">format,</span> <span class="pre">multiple=True)</span></code></p></td>
</tr>
<tr class="row-even"><td><p>`` json``</p></td>
<td><p>`` IS_EMPTY_OR (IS_JSON ()) `` comprimento padrão é 512</p></td>
</tr>
<tr class="row-odd"><td><p>`` bigint``</p></td>
<td><p>`` IS_INT_IN_RANGE (** -2 63, 2 ** 63) ``</p></td>
</tr>
<tr class="row-even"><td><p>`` Grande-id``</p></td>
<td><p>`` None``</p></td>
</tr>
<tr class="row-odd"><td><p>`` Grande-reference``</p></td>
<td><p>`` None``</p></td>
</tr>
</tbody>
</table>
<p>Decimal requer e devolve valores como `` objectos Decimal``, como definidos na Python `` decimal`` módulo. SQLite não lidar com o `` decimal`` tipo assim internamente que tratá-lo como um `` double``. O (n, m) são o número de dígitos no total e o número de dígitos após o ponto decimal, respectivamente.</p>
<p>A `` grande-id`` e, `` grande-reference`` são suportados apenas por alguns dos mecanismos de bases de dados e são experimentais. Eles não são normalmente usados ​​como tipos de campo a menos de tabelas legadas, no entanto, o construtor DAL tem um argumento `` bigint_id`` que, quando definido para `` True`` faz com que os `` campos id`` e `` campos reference`` `` grande-id`` e `` grande-reference`` respectivamente.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">list:&lt;type&gt;</span></code> fields are special because they are designed to take
advantage of certain denormalization features on NoSQL (in the case of
Google App Engine NoSQL, the field types <code class="docutils literal notranslate"><span class="pre">ListProperty</span></code> and
<code class="docutils literal notranslate"><span class="pre">StringListProperty</span></code>) and back-port them all the other supported
relational databases. On relational databases lists are stored as a
<code class="docutils literal notranslate"><span class="pre">text</span></code> field. The items are separated by a <code class="docutils literal notranslate"><span class="pre">|</span></code> and each <code class="docutils literal notranslate"><span class="pre">|</span></code> in
string item is escaped as a <code class="docutils literal notranslate"><span class="pre">||</span></code>. They are discussed in
<a class="reference internal" href="#list-type-and-contains"><span class="std std-ref">`` Lista: &lt;type&gt; `` e `` contains``</span></a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">json</span></code> field type is pretty much explanatory. It can store any
JSON serializable object. It is designed to work specifically for
MongoDB and backported to the other database adapters for portability.</p>
<p><code class="docutils literal notranslate"><span class="pre">blob</span></code> fields are also special. By default, binary data is encoded in
base64 before being stored into the actual database field, and it is
decoded when extracted. This has the negative effect of using 33% more
storage space than necessary in blob fields, but has the advantage of
making the communication independent of the back-end specific escaping
conventions.</p>
</section>
<section id="run-time-field-and-table-modification">
<h3>modificação da tabela e campo em tempo de execução<a class="headerlink" href="#run-time-field-and-table-modification" title="Link permanente para este título"></a></h3>
<p>A maioria dos atributos de campos e tabelas podem ser modificados depois que eles são definidos:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">/</span><span class="si">%(id)s</span><span class="s1">&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="s1">&#39;anonymous&#39;</span>
</pre></div>
</div>
<p>aviso de que os atributos de tabelas são geralmente precedido por um sublinhado para evitar conflitos com possíveis nomes de campo.</p>
<p>Você pode listar as tabelas que foram definidos para uma determinada conexão com o banco:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">tables</span>
<span class="go">[&#39;person&#39;]</span>
</pre></div>
</div>
<p>Você pode consultar para o tipo de uma tabela:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span>
<span class="go">&lt;class &#39;pydal.objects.Table&#39;&gt;</span>
</pre></div>
</div>
<p>Você pode acessar uma tabela utilizando diferentes sintaxes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span> <span class="ow">is</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;person&#39;</span><span class="p">]</span>
<span class="go">True</span>
</pre></div>
</div>
<p>Você também pode listar os campos que foram definidos para uma determinada tabela:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">fields</span>
<span class="go">[&#39;id&#39;, &#39;name&#39;]</span>
</pre></div>
</div>
<p>Da mesma forma você pode acessar campos de seu nome de várias maneiras equivalentes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="go">&lt;class &#39;pydal.objects.Field&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
<span class="go">True</span>
</pre></div>
</div>
<p>Dado um campo, você pode acessar os atributos definidos em sua definição:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">type</span>
<span class="go">string</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">unique</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">notnull</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">length</span>
<span class="go">32</span>
</pre></div>
</div>
<p>incluindo a sua tabela pai, tablename, e ligação parent:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">_table</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">_tablename</span> <span class="o">==</span> <span class="s1">&#39;person&#39;</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">_db</span> <span class="o">==</span> <span class="n">db</span>
<span class="go">True</span>
</pre></div>
</div>
<p>Um campo também tem métodos. Alguns deles são utilizados para consultas de construção e vamos vê-los mais tarde. Um método especial do objeto de campo é `` validate`` e chama os validadores para o campo.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="s1">&#39;John&#39;</span><span class="p">)</span>
<span class="go">(&#39;John&#39;, None)</span>
</pre></div>
</div>
<p>que retorna um tuplo `` (valor, erro) <code class="docutils literal notranslate"><span class="pre">.</span> <span class="pre">``</span> <span class="pre">``</span> <span class="pre">Error</span></code> é None`` se a entrada passa a validação.</p>
</section>
<section id="more-on-uploads">
<h3>Mais sobre envios<a class="headerlink" href="#more-on-uploads" title="Link permanente para este título"></a></h3>
<p>Considere o seguinte modelo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;myfile&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;upload&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;path/to/file&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>No case de um campo de “carregamento”, o valor padrão pode, opcionalmente, ser definida como um caminho (um caminho absoluto ou um caminho relativo para a pasta aplicativo atual), o valor padrão é então atribuído a cada novo registro que não especifica um imagem.</p>
<p>Observe que desta forma vários registros podem acabar com referência ao mesmo arquivo de imagem padrão e isso poderia ser um problema em um campo ter `` autodelete`` habilitado. Quando você não quer permitir duplicatas para o campo de imagem (ou seja, vários registros referenciando o mesmo arquivo), mas ainda quer definir um valor padrão para o “carregamento”, então você precisa de uma forma de copiar o arquivo padrão para cada novo registro que faz não especificar uma imagem. Isto pode ser obtido usando um arquivo-como objeto referenciando o arquivo padrão como o argumento `` default`` ao campo, ou mesmo com:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Field</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;upload&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;&lt;file_content&gt;&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;&lt;file_name&gt;&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Normalmente uma inserção é feita automaticamente através de um `` Form`` mas ocasionalmente você já tem o arquivo no sistema de arquivos e quer enviá-lo por meio de programação. Isso pode ser feito da seguinte maneira:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
</pre></div>
</div>
<p>Também é possível inserir um arquivo de uma forma mais simples e tem a chamada de método de inserção `` store`` automaticamente:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
</pre></div>
</div>
<p>Neste case, o nome do ficheiro é obtido a partir do objecto corrente, se disponível.</p>
<p>O método <cite>store`</cite> do objeto campo carregamento leva um fluxo de arquivo e um nome de arquivo. Ele usa o nome do arquivo para determinar a extensão (tipo) do arquivo, cria um novo nome temporário para o arquivo (de acordo com mecanismo de upload py4web) e carrega o conteúdo do arquivo neste novo arquivo temporário (sob os envios de pasta salvo indicação em contrário). Ele retorna o novo nome temp, que é então armazenada no campo `` image`` da tabela `` db.myfile``.</p>
<p>Note, se o arquivo deve ser armazenado em um campo blob associado ao invés do sistema de arquivos, o método <cite>store`</cite> não irá inserir o arquivo no campo blob (porque` <cite>store`</cite> é chamado antes da inserção), portanto, o arquivo deve ser explicitamente inserido no campo blob:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;myfile&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;upload&#39;</span><span class="p">,</span> <span class="n">uploadfield</span><span class="o">=</span><span class="s1">&#39;image_file&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;image_file&#39;</span><span class="p">,</span> <span class="s1">&#39;blob&#39;</span><span class="p">))</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                     <span class="n">image_file</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
<p>O método <cite>retrieve`</cite> faz o oposto do` <cite>store`</cite>.</p>
<p>Quando os arquivos enviados são armazenados no sistema de arquivos (como no case de um `` Field ( “imagem” simples, “upload”) <a href="#id1"><span class="problematic" id="id2">``</span></a>) o código:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">fullname</span><span class="p">)</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">nameonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>recupera o nome do arquivo original (filename) como visto pelo usuário em tempo de upload e o nome do arquivo armazenado (fullname, com caminho relativo para a pasta da aplicação). Embora, em geral, a chamada:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</pre></div>
</div>
<p>recupera o nome original do arquivo (filename) e um arquivo-como objeto pronto para dados de arquivo de acesso carregado (stream).</p>
<blockquote>
<div><p>Observe que o fluxo retornado por `` retrieve`` é um objeto de arquivo real no case de que os arquivos enviados são armazenados no sistema de arquivos. Nesse case, lembre-se de fechar o arquivo quando você é feito, chamando `` stream.close () <a href="#id1"><span class="problematic" id="id2">``</span></a>.</p>
</div></blockquote>
<p>Aqui está um exemplo de uso seguro do `` retrieve``:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
<span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">,</span> <span class="n">closing</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="migrations">
<h2>Migrações<a class="headerlink" href="#migrations" title="Link permanente para este título"></a></h2>
<p>With our example table definition:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">define_table</span></code> checks whether or not the corresponding table exists.
If it does not, it generates the SQL to create it and executes the SQL.
If the table does exist but differs from the one being defined, it
generates the SQL to alter the table and executes it. If a field has
changed type but not name, it will try to convert the data (If you do
not want this, you need to redefine the table twice, the first time,
letting py4web drop the field by removing it, and the second time adding
the newly defined field so that py4web can create it). If the table
exists and matches the current definition, it will leave it alone. In
all cases it will create the <code class="docutils literal notranslate"><span class="pre">db.person</span></code> object that represents the
table.</p>
<p>Referimo-nos a esse comportamento como uma “migração”. py4web registra todas as migrações e migração tentativas no arquivo “Sql.log”.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>by default py4web uses the “app/databases” folder for the
log file and all other migration files it needs. You can change this
setting by changing the <code class="docutils literal notranslate"><span class="pre">folder</span></code> argument to DAL. To set a different
log file name, for example “migrate.log” you can do
<code class="docutils literal notranslate"><span class="pre">db</span> <span class="pre">=</span> <span class="pre">DAL(...,</span> <span class="pre">adapter_args=dict(logfile='migrate.log'))</span></code></p>
</div>
<p>The first argument of <code class="docutils literal notranslate"><span class="pre">define_table</span></code> is always the table name. The
other unnamed arguments are the fields. The function also takes
an optional keyword argument called “migrate”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">migrate</span><span class="o">=</span><span class="s1">&#39;person.table&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>O valor de migrar é o nome do arquivo onde as informações lojas py4web migração interna para esta tabela. Esses arquivos são muito importantes e nunca deve ser removido enquanto existirem as tabelas correspondentes. Nos cases em que uma tabela foi descartado eo arquivo correspondente ainda existem, ele pode ser removido manualmente. Por padrão, migre é definida como True. Este causas py4web para gerar o nome do arquivo a partir de um hash da string de conexão. Se migre é definida como falso, a migração não é realizada, e py4web assume que a tabela existe no armazenamento de dados e que contém (pelo menos) os campos listados no `` define_table``.</p>
<p>Não pode haver duas tabelas no mesmo aplicativo com o mesmo nome migrar.</p>
<p>A classe DAL também leva um argumento “migrar”, que determina o valor padrão de migrar para chamadas para `` define_table``. Por exemplo,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">,</span> <span class="n">migrate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>irá definir o valor padrão de migrar para Falso quando `` db.define_table`` é chamado sem um argumento migrar.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>py4web only migrates new columns, removed columns, and
changes in column type (except in SQLite). py4web does not migrate
changes in attributes such as changes in the values of <code class="docutils literal notranslate"><span class="pre">default</span></code>,
<code class="docutils literal notranslate"><span class="pre">unique</span></code>, <code class="docutils literal notranslate"><span class="pre">notnull</span></code>, and <code class="docutils literal notranslate"><span class="pre">ondelete</span></code>.</p>
</div>
<p>As migrações podem ser desativado para todas as tabelas de uma só vez:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">migrate_enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>This is the recommended behavior when two apps share the same database.
Only one of the two apps should perform migrations, the other should
disable them.</p>
<section id="fixing-broken-migrations">
<h3>Fixação migrações quebrados<a class="headerlink" href="#fixing-broken-migrations" title="Link permanente para este título"></a></h3>
<p>Há dois problemas comuns com as migrações e existem formas de recuperar a partir deles.</p>
<p>Um problema é específico com SQLite. SQLite não impor tipos de coluna e não pode soltar colunas. Isto significa que se você tiver uma coluna do tipo string e você removê-lo, não é realmente removido. Se você adicionar a coluna novamente com um tipo diferente (por exemplo, data e hora) você acaba com uma coluna de data e hora que contém strings (lixo para fins práticos). não py4web não reclamar sobre isso, porque ele não sabe o que está no banco de dados, até que ele tenta recuperar registros e falha.</p>
<p>Se py4web retorna um erro em alguma função de análise ao selecionar registros, muito provavelmente isso é devido a dados corrompidos em uma coluna por causa da questão acima.</p>
<p>A solução consiste em actualizar todos os registos da tabela e a actualização dos valores na coluna em questão com Nenhum.</p>
<p>O outro problema é mais genérico, mas típico com MySQL. O MySQL não permitem mais de um ALTER TABLE em uma transação. Isto significa que py4web deve quebrar transações complexas em partes menores (um ALTER TABLE na época) e cometem uma peça no momento. Por isso, é possível que parte de uma transação complexa fica comprometida e uma parte falhar, deixando py4web em um estado corrompido. Por que parte de uma transação falhar? Uma vez que, por exemplo, envolve a alteração de uma tabela de conversão e uma coluna de strings dentro de uma coluna de data e hora, tentativas py4web para converter os dados, mas os dados não podem ser convertidos. O que acontece com py4web? Ele fica confuso sobre o que exatamente é a estrutura da tabela realmente armazenados no banco de dados.</p>
<p>A solução consiste em permitir migrações falsos:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="o">....</span><span class="p">,</span> <span class="n">migrate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fake_migrate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Isto irá reconstruir metadados py4web sobre a tabela de acordo com a definição da tabela. Tente várias definições de tabela para ver qual delas funciona (aquele antes da migração falhou ea uma após a migração falhou). Uma vez que remove sucesso do `` fake_migrate = True`` parâmetro.</p>
<p>Before attempting to fix migration problems it is prudent to make a copy
of “yourapp/databases/*.table” files.</p>
<p>Migração problemas também pode ser fixada para todas as tabelas de uma só vez:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">fake_migrate_all</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Isso também falhará se o modelo descreve tabelas que não existem no banco de dados, mas pode ajudar a estreitar o problema.</p>
</section>
<section id="migration-control-summary">
<h3>Migração resumo controle<a class="headerlink" href="#migration-control-summary" title="Link permanente para este título"></a></h3>
<p>A lógica dos vários argumentos de migração estão resumidos neste pseudo-código:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">DAL</span><span class="o">.</span><span class="n">migrate_enabled</span> <span class="ow">and</span> <span class="n">table</span><span class="o">.</span><span class="n">migrate</span><span class="p">:</span>
   <span class="k">if</span> <span class="n">DAL</span><span class="o">.</span><span class="n">fake_migrate_all</span> <span class="ow">or</span> <span class="n">table</span><span class="o">.</span><span class="n">fake_migrate</span><span class="p">:</span>
       <span class="n">perform</span> <span class="n">fake</span> <span class="n">migration</span>
   <span class="k">else</span><span class="p">:</span>
       <span class="n">perform</span> <span class="n">migration</span>
</pre></div>
</div>
</section>
</section>
<section id="table-methods">
<h2>Table methods<a class="headerlink" href="#table-methods" title="Link permanente para este título"></a></h2>
<section id="insert">
<h3>`` Insert``<a class="headerlink" href="#insert" title="Link permanente para este título"></a></h3>
<p>Dada uma tabela, você pode inserir registros</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Alex&quot;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Bob&quot;</span><span class="p">)</span>
<span class="go">2</span>
</pre></div>
</div>
<p>Inserir retorna o valor único “id” de cada registro inserido.</p>
<p>Você pode truncar a tabela, ou seja, excluir todos os registros e reinicie o contador do id.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
</pre></div>
</div>
<p>Agora, se você inserir um registro novo, o contador recomeça a 1 (isto é específico back-end e não se aplica ao Google NoSQL):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Alex&quot;</span><span class="p">)</span>
<span class="go">1</span>
</pre></div>
</div>
<p>Observe que você pode passar um parâmetro para `` truncate``, por exemplo, você pode dizer SQLite para reiniciar o contador id.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="s1">&#39;RESTART IDENTITY CASCADE&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>O argumento é em SQL puro e, portanto, específico do motor.</p>
<p>py4web também fornece um método bulk_insert</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">([{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Alex&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;John&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Tim&#39;</span><span class="p">}])</span>
<span class="go">[3, 4, 5]</span>
</pre></div>
</div>
<p>É preciso uma lista de dicionários de campos a serem inseridas e executa várias inserções ao mesmo tempo. Ele retorna a lista de valores “id” dos registros inseridos. Nos bancos de dados relacionais suportadas não há nenhuma vantagem em usar esta função ao invés de looping e realizando inserções individuais, mas no Google App Engine NoSQL, há uma grande vantagem de velocidade.</p>
</section>
<section id="query-set-rows">
<h3>`` Query``, `` Set``, `` Rows``<a class="headerlink" href="#query-set-rows" title="Link permanente para este título"></a></h3>
<p>Vamos considerar novamente a tabela definida (e caiu) anteriormente e inserir três registros:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Alex&quot;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Bob&quot;</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Carl&quot;</span><span class="p">)</span>
<span class="go">3</span>
</pre></div>
</div>
<p>Você pode armazenar a tabela em uma variável. Por exemplo, com variável `` Person``, você poderia fazer:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">person</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span>
</pre></div>
</div>
<p>Você também pode armazenar um campo em uma variável como `` name``. Por exemplo, você também pode fazer:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">name</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>Você pode até criar uma consulta (usando operadores como ==, =, &lt;,&gt;, &lt;=,&gt; =, como, pertence!) E armazenar a consulta em uma variável `` q`` tal como em:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">q</span> <span class="o">=</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span>
</pre></div>
</div>
<p>Quando você chamar `` db`` com uma consulta, você define um conjunto de registros. Você pode armazená-lo em uma variável `` s`` e escreve:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
<p>Observe que nenhuma consulta de banco de dados foi realizada até agora. DAL + consulta simplesmente definir um conjunto de registros neste db que correspondem a consulta. py4web determina a partir da consulta que tabela (ou tabelas) estão envolvidos e, de fato, não há necessidade de especificar isso.</p>
</section>
<section id="update-or-insert">
<h3>`` Update_or_insert``<a class="headerlink" href="#update-or-insert" title="Link permanente para este título"></a></h3>
<p>Algumas vezes você precisa executar uma inserção somente se não há nenhum registro com os mesmos valores como aqueles que estão sendo inseridos. Isso pode ser feito com</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;birthplace&#39;</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">update_or_insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">,</span> <span class="n">birthplace</span><span class="o">=</span><span class="s1">&#39;Chicago&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>O registro será inserido somente se não houver nenhum outro usuário chamado John nascido em Chicago.</p>
<p>Você pode especificar quais valores usar como uma chave para determinar se existe o registro. Por exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">update_or_insert</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">,</span>
                           <span class="n">birthplace</span><span class="o">=</span><span class="s1">&#39;Chicago&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>e se houver John sua terra natal será atualizado então um novo registro será criado.</p>
<p>Os critérios de selecção no exemplo acima é um único campo. Ele também pode ser uma consulta, tais como</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">update_or_insert</span><span class="p">((</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;John&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">birthplace</span> <span class="o">==</span> <span class="s1">&#39;Chicago&#39;</span><span class="p">),</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">,</span>
                           <span class="n">birthplace</span><span class="o">=</span><span class="s1">&#39;Chicago&#39;</span><span class="p">,</span>
                           <span class="n">pet</span><span class="o">=</span><span class="s1">&#39;Rover&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="validate-and-insert-validate-and-update">
<h3>`` Validate_and_insert``, `` validate_and_update``<a class="headerlink" href="#validate-and-insert-validate-and-update" title="Link permanente para este título"></a></h3>
<p>A função</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">validate_and_insert</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>funciona muito bem como</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>exceto que ele chama os validadores para os campos antes de realizar a inserção e fianças se a validação não passa. Se a validação não passa os erros podem ser encontradas em `` ret.errors``. `` Ret.errors`` mantém um mapeamento de valores-chave, onde cada chave é o nome do campo cuja validação falhou, e o valor da chave é o resultado do erro de validação (muito parecido com `` form.errors``). Se passar, o ID do novo registro é em `` ret.id``. Mente que normalmente validação é feita pela lógica de processamento de formulário para essa função é raramente necessária.</p>
<p>Similarmente</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">validate_and_update</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>funciona muito da mesma forma como</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">num</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>exceto que ele chama os validadores para os campos antes de realizar a atualização. Note que ele só funciona se consulta envolve uma única tabela. O número de registros atualizados podem ser encontrados em `` ret.updated`` e erros será no `` ret.errors``.</p>
</section>
<section id="drop">
<h3>`` Drop``<a class="headerlink" href="#drop" title="Link permanente para este título"></a></h3>
<p>Finalmente, você pode soltar tabelas e todos os dados serão perdidos:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="tagging-records">
<h3>Marcação de registros<a class="headerlink" href="#tagging-records" title="Link permanente para este título"></a></h3>
<p>Etiquetas permite adicionar ou encontrar propriedades anexadas aos registros em seu banco de dados.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">pydal.tools.tags</span> <span class="kn">import</span> <span class="n">Tags</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s2">&quot;sqlite:memory&quot;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s2">&quot;thing&quot;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
<span class="n">properties</span> <span class="o">=</span> <span class="n">Tags</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span>
<span class="n">id1</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;chair&quot;</span><span class="p">)</span>
<span class="n">id2</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;table&quot;</span><span class="p">)</span>
<span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="s2">&quot;color/red&quot;</span><span class="p">)</span>
<span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="s2">&quot;style/modern&quot;</span><span class="p">)</span>
<span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="s2">&quot;color/green&quot;</span><span class="p">)</span>
<span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="s2">&quot;material/wood&quot;</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id1</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;color/red&quot;</span><span class="p">,</span> <span class="s2">&quot;style/modern&quot;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id2</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;color/green&quot;</span><span class="p">,</span> <span class="s2">&quot;material/wood&quot;</span><span class="p">]</span>

<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">find</span><span class="p">([</span><span class="s2">&quot;style/modern&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">rows</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">id1</span>

<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">find</span><span class="p">([</span><span class="s2">&quot;material/wood&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">rows</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">id2</span>

<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">find</span><span class="p">([</span><span class="s2">&quot;color&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</pre></div>
</div>
<p>It is internally implemented as a table, which in
this example would be db.thing_tags_default, because no tail was
specified on the Tags(table, tail=“default”) constructor.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">find</span></code> method is doing a search by <code class="docutils literal notranslate"><span class="pre">startswith</span></code> of the
parameter. Then find([“color”]) would return id1 and id2
because both records have tags starting with “color”. py4web uses tags as a
flexible mechanism to manage permissions.</p>
</section>
</section>
<section id="raw-sql">
<h2>Raw SQL<a class="headerlink" href="#raw-sql" title="Link permanente para este título"></a></h2>
<section id="executesql">
<h3>`` executesql``<a class="headerlink" href="#executesql" title="Link permanente para este título"></a></h3>
<p>A DAL permite emitir explicitamente instruções SQL.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">executesql</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM person;&#39;</span><span class="p">)</span>
<span class="go">[(1, u&#39;Massimo&#39;), (2, u&#39;Massimo&#39;)]</span>
</pre></div>
</div>
<p>Neste case, os valores de retorno não são analisados ​​ou transformados pela DAL, eo formato depende do driver de banco de dados específico. Este uso com selecciona normalmente não é necessário, mas é mais comum com índices.</p>
<p>`` Executesql`` leva cinco argumentos opcionais: `` placeholders``, `` as_dict``, `` fields``, `` colnames``, e `` as_ordered_dict``.</p>
<p>`` Placeholders`` é uma seqüência opcional de valores a serem substituídos ou, se suportado pelo driver DB, um dicionário com chaves correspondentes chamado espaços reservados no seu SQL.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">as_dict</span></code> is set to True, the results cursor returned by the DB
driver will be converted to a sequence of dictionaries keyed with the db
field names. Results returned with <code class="docutils literal notranslate"><span class="pre">as_dict</span> <span class="pre">=</span> <span class="pre">True</span></code> are the same as
those returned when applying as_list() to a normal select:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="s1">&#39;field1&#39;</span><span class="p">:</span> <span class="n">val1_row1</span><span class="p">,</span> <span class="s1">&#39;field2&#39;</span><span class="p">:</span> <span class="n">val2_row1</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;field1&#39;</span><span class="p">:</span> <span class="n">val1_row2</span><span class="p">,</span> <span class="s1">&#39;field2&#39;</span><span class="p">:</span> <span class="n">val2_row2</span><span class="p">}]</span>
</pre></div>
</div>
<p>`` As_ordered_dict`` é muito bonito como `` as_dict`` mas os antigos garante que a ordem dos resultando campos (teclas OrderedDict) refletem a ordem em que eles são retornados de DB motorista:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;field1&#39;</span><span class="p">,</span> <span class="n">val1_row1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;field2&#39;</span><span class="p">,</span> <span class="n">val2_row1</span><span class="p">)]),</span>
 <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;field1&#39;</span><span class="p">,</span> <span class="n">val1_row2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;field2&#39;</span><span class="p">,</span> <span class="n">val2_row2</span><span class="p">)])]</span>
</pre></div>
</div>
<p>O argumento `` fields`` é uma lista de objetos DAL de campo que correspondem aos campos retornados da DB. Os objectos de campo devem ser parte de um ou mais objectos Tabela definido no objecto DAL. A `` lista fields`` pode incluir um ou mais DAL Tabela objetos em adição a ou em vez de incluir Campo objetos, ou pode ser apenas uma única tabela (não de uma lista). Nesse case, os objectos de campo vai ser extraído da tabela (s).</p>
<p>Em vez de especificar o argumento `` fields``, o argumento `` colnames`` pode ser especificado como uma lista de nomes de campos em formato tabela.campo. Novamente, estes devem representar tabelas e campos definidos no objeto DAL.</p>
<p>Também é possível especificar `` fields`` eo associado `` colnames``. Nesse case, `` fields`` pode também incluir objetos Expressão DAL, além de objetos de campo. Para objetos de campo em “campos”, o associado `` colnames`` ainda deve estar no formato tabela.campo. Para Expression objetos em `` fields``, o associado `` colnames`` podem ser quaisquer rótulos arbitrários.</p>
<p>Observe, a Tabela DAL objectos referidos por `` fields`` ou `` colnames`` pode ser fictícios mesas e não têm para representar todas as tabelas reais no banco de dados. Além disso, nota que o `` fields`` e `` colnames`` devem estar na mesma ordem que os campos nos resultados cursor retornado do DB.</p>
</section>
<section id="lastsql">
<h3>`` _Lastsql``<a class="headerlink" href="#lastsql" title="Link permanente para este título"></a></h3>
<p>Se SQL foi executado manualmente usando ExecuteSQL ou foi SQL gerado pelo DAL, você sempre pode encontrar o código SQL em `` db._lastsql``. Isso é útil para fins de depuração:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">_lastsql</span>
<span class="go">SELECT person.id, person.name FROM person;</span>
</pre></div>
</div>
<blockquote>
<div><p>py4web never generates queries using the “*” operator. py4web is
always explicit when selecting fields.</p>
</div></blockquote>
</section>
<section id="timing-queries">
<h3>Temporização de consultas<a class="headerlink" href="#timing-queries" title="Link permanente para este título"></a></h3>
<p>All queries are automatically timed by py4web. The variable
<code class="docutils literal notranslate"><span class="pre">db._timings</span></code> is a list of tuples. Each tuple contains the raw SQL
query as passed to the database driver and the time it took to execute
in seconds.</p>
</section>
<section id="indexes">
<h3>Índices<a class="headerlink" href="#indexes" title="Link permanente para este título"></a></h3>
<p>Atualmente, a API DAL não fornece um comando para criar índices em tabelas, mas isso pode ser feito usando o comando `` executesql``. Isso ocorre porque a existência de índices pode fazer migrações complexa, e é melhor para lidar com eles de forma explícita. Os índices podem ser necessários para esses campos que são usados ​​em consultas recorrentes.</p>
<p>Aqui está um exemplo de como:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="n">db</span><span class="o">.</span><span class="n">executesql</span><span class="p">(</span><span class="s1">&#39;CREATE INDEX IF NOT EXISTS myidx ON person (name);&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Outros dialetos banco de dados têm sintaxes muito semelhantes, mas pode não suportar o opcional “SE NÃO EXISTE” directiva.</p>
</section>
<section id="generating-raw-sql">
<h3>Generating raw SQL<a class="headerlink" href="#generating-raw-sql" title="Link permanente para este título"></a></h3>
<p>Às vezes você precisa para gerar o SQL, mas não executá-lo. Isso é fácil de fazer com py4web uma vez que cada comando que executa banco de dados IO tem um comando equivalente que não, e simplesmente retorna o SQL que teriam sido executados. Estes comandos têm os mesmos nomes e sintaxe como os funcionais, mas eles começam com um sublinhado:</p>
<p>Aqui é `` _insert``</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Alex&#39;</span><span class="p">))</span>
<span class="go">INSERT INTO &quot;person&quot;(&quot;name&quot;) VALUES (&#39;Alex&#39;);</span>
</pre></div>
</div>
<p>Aqui é `` _count``</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_count</span><span class="p">())</span>
<span class="go">SELECT COUNT(*) FROM &quot;person&quot; WHERE (&quot;person&quot;.&quot;name&quot; = &#39;Alex&#39;);</span>
</pre></div>
</div>
<p>Aqui é `` _select``</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_select</span><span class="p">())</span>
<span class="go">SELECT &quot;person&quot;.&quot;id&quot;, &quot;person&quot;.&quot;name&quot; FROM &quot;person&quot; WHERE (&quot;person&quot;.&quot;name&quot; = &#39;Alex&#39;);</span>
</pre></div>
</div>
<p>Aqui é `` _delete``</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_delete</span><span class="p">())</span>
<span class="go">DELETE FROM &quot;person&quot; WHERE (&quot;person&quot;.&quot;name&quot; = &#39;Alex&#39;);</span>
</pre></div>
</div>
<p>E, finalmente, aqui é `` _update``</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Susan&#39;</span><span class="p">))</span>
<span class="go">UPDATE &quot;person&quot; SET &quot;name&quot;=&#39;Susan&#39; WHERE (&quot;person&quot;.&quot;name&quot; = &#39;Alex&#39;);</span>
</pre></div>
</div>
<blockquote>
<div><p>Além disso, você sempre pode usar `` db._lastsql`` para retornar o código SQL mais recente, se foi executada manualmente usando ExecuteSQL ou foi SQL gerado pelo DAL.</p>
</div></blockquote>
</section>
</section>
<section id="select-command">
<h2>`` Comando SELECT``<a class="headerlink" href="#select-command" title="Link permanente para este título"></a></h2>
<p>Dado um conjunto, `` s``, você pode buscar os registros com o comando `` SELECT``:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div>
</div>
<p>It returns an iterable object of class <code class="docutils literal notranslate"><span class="pre">pydal.objects.Rows</span></code> whose
elements are Row objects. <code class="docutils literal notranslate"><span class="pre">pydal.objects.Row</span></code> objects act like
dictionaries, but their elements can also be accessed as attributes.
The former differ from the latter because
its values are read-only.</p>
<p>O objecto Fileiras permite loop sobre o resultado do seleccionar e imprimindo os valores dos campos seleccionados para cada linha:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">1 Alex</span>
</pre></div>
</div>
<p>Você pode fazer todas as etapas em uma declaração:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
</pre></div>
</div>
<p>O comando select pode tomar argumentos. Todos os argumentos sem nome são interpretados como os nomes dos campos que você deseja buscar. Por exemplo, você pode ser explícita no campo “id” e no campo “nome” buscar:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
<p>O atributo mesa ALL permite especificar todos os campos:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">1 Alex</span>
<span class="go">2 Bob</span>
<span class="go">3 Carl</span>
</pre></div>
</div>
<p>Observe que não há nenhuma strings de consulta passada para db. py4web entende que se você quiser todos os campos da pessoa mesa sem informações adicionais, então você quer todos os registros da pessoa mesa.</p>
<p>Uma sintaxe alternativa equivalente é o seguinte:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">1 Alex</span>
<span class="go">2 Bob</span>
<span class="go">3 Carl</span>
</pre></div>
</div>
<p>e py4web entende que se você perguntar para todos os registros da pessoa mesa sem informações adicionais, então você quer todos os campos da tabela pessoa.</p>
<p>Dada uma linha</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>você pode extrair seus valores usando várias expressões equivalentes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">name</span>
<span class="go">Alex</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
<span class="go">Alex</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="p">(</span><span class="s1">&#39;person.name&#39;</span><span class="p">)</span>
<span class="go">Alex</span>
</pre></div>
</div>
<p>The latter syntax is particularly handy when selecting an expression
instead of a column. We will show this later.</p>
<p>Você também pode fazer</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span><span class="o">.</span><span class="n">compact</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<p>desativar a notação</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>e permitir que, em vez disso, a notação menos compacto:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>Sim isso é incomum e raramente necessário.</p>
<p>Row objetos também tem dois métodos importantes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span><span class="o">.</span><span class="n">delete_record</span><span class="p">()</span>
</pre></div>
</div>
<p>e</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span><span class="o">.</span><span class="n">update_record</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;new value&quot;</span><span class="p">)</span>
</pre></div>
</div>
<section id="using-an-iterator-based-select-for-lower-memory-use">
<h3>Usando um seleto para uso de memória inferior à base de iterador<a class="headerlink" href="#using-an-iterator-based-select-for-lower-memory-use" title="Link permanente para este título"></a></h3>
<p>Python “iterators” são um tipo de “preguiçoso-avaliação”. Eles dados ‘alimentar’ um passo de tempo; laços tradicionais Python criar todo o conjunto de dados na memória antes de looping.</p>
<p>O uso tradicional de selecionar é:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>mas para um grande número de linhas, usando uma alternativa à base de iterador tem uso de memória dramaticamente inferior:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">iterselect</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Testes mostram que  isto é de cerca de 10% mais rápido, mesmo em máquinas com muita RAM.</p>
</section>
<section id="rendering-rows-using-represent">
<h3>Renderizando Rows com represent<a class="headerlink" href="#rendering-rows-using-represent" title="Link permanente para este título"></a></h3>
<p>Você pode querer reescrever linhas retornadas por seleção para tirar proveito de informações de formatação contida na representa a criação dos campos.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">repr_row</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Se você não especificar um índice, você tem um gerador para iterar sobre todas as linhas:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">render</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">myfield</span><span class="p">)</span>
</pre></div>
</div>
<p>Também pode ser aplicada a fatias:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">render</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">myfield</span><span class="p">)</span>
</pre></div>
</div>
<p>Se você só quer transformar campos selecionados através do seu atributo “representar”, você pode incluí-los no argumento “campos”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">repr_row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="p">])</span>
</pre></div>
</div>
<p>Note, it returns a transformed copy of the original Row, so there’s no
update_record (which you wouldn’t want anyway) or delete_record.</p>
</section>
<section id="shortcuts">
<h3>Atalhos<a class="headerlink" href="#shortcuts" title="Link permanente para este título"></a></h3>
<p>A DAL suporta vários atalhos-simplificando código. Em particular:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myrecord</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
</pre></div>
</div>
<p>retorna o registro com o dado `` id`` se ele existir. Se o `` id`` não existe, ele retorna `` None``. A declaração acima é equivalente a</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myrecord</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div>
</div>
<p>Você pode excluir registros por id:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
</pre></div>
</div>
<p>e isto é equivalente a</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
<p>e exclui o registro com o dado `` id``, se ele existir.</p>
<p>Nota: esta sintaxe de atalho de exclusão actualmente não trabalha se * versionamento * é ativado</p>
<p>Você pode inserir registros:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>É equivalente a</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>e cria um novo registro com valores de campos especificados pelo dicionário sobre o lado direito.</p>
<p>Note: insert shortcut was previously <code class="docutils literal notranslate"><span class="pre">db.table[0]</span> <span class="pre">=</span> <span class="pre">...</span></code>. It has
changed in pyDAL 19.02 to permit normal usage of id 0.</p>
<p>Você pode atualizar os registros:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>o qual é equivalente a</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>e atualiza um registro existente com os valores dos campos especificados pelo dicionário sobre o lado direito.</p>
</section>
<section id="fetching-a-row">
<h3>A obtenção de um `` row``<a class="headerlink" href="#fetching-a-row" title="Link permanente para este título"></a></h3>
<p>No entanto, outra sintaxe conveniente é o seguinte:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<span class="n">record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span>
<span class="n">record</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;somevalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Aparentemente semelhante a `` db.mytable [id] `` a sintaxe acima é mais flexível e mais seguro. Antes de tudo, verifica se `` id`` é um int (ou `` str (id) `` é um int) e retorna `` None`` se não (nunca levanta uma exceção). Ele também permite especificar várias condições que o registro deve atender. Se eles não forem atendidas, ele também retorna `` None``.</p>
</section>
<section id="recursive-selects">
<h3>Recursivas `` s SELECT``<a class="headerlink" href="#recursive-selects" title="Link permanente para este título"></a></h3>
<p>Considere a pessoa tabela anterior e uma nova tabela “coisa” fazendo referência a uma “pessoa”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>e um simples selecionar a partir desta tabela:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">things</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div>
</div>
<p>o qual é equivalente a</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">things</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">_id</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div>
</div>
<p>onde `` _id`` é uma referência para a chave principal da tabela. Normalmente `` db.thing._id`` é o mesmo que `` db.thing.id`` e vamos supor que na maior parte deste livro.</p>
<p>Para cada linha de coisas é possível buscar não apenas campos da tabela selecionada (coisa), mas também a partir de tabelas vinculadas (de forma recursiva):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">things</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>Aqui `` thing.owner_id.name`` requer um banco de dados escolha para cada coisa em coisas e por isso é ineficiente. Sugerimos usando junta sempre que possível, em vez de seleciona recursiva, no entanto, este é conveniente e prático ao acessar registros individuais.</p>
<p>Você também pode fazê-lo para trás, escolhendo os coisas referenciados por uma pessoa:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">person</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">person</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">orderby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;owns&#39;</span><span class="p">,</span> <span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>Nesta última expressão `` person.thing`` é um atalho para</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">==</span> <span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
<p>isto é, o conjunto de thing`` `` s referenciados pelos actuais `` Person``. Esta sintaxe se decompõe se a tabela referenciando tem várias referências à tabela referenciada. Neste case é preciso ser mais explícito e usar uma consulta completa.</p>
</section>
<section id="orderby-groupby-limitby-distinct-having-orderby-on-limitby-join-left-cache">
<span id="orderby-groupby-limitby"></span><h3>`` Orderby``, `` groupby``, `` limitby``, `` distinct``, `` having``, `` orderby_on_limitby``, `` join``, `` left``, `` cache``<a class="headerlink" href="#orderby-groupby-limitby-distinct-having-orderby-on-limitby-join-left-cache" title="Link permanente para este título"></a></h3>
<p>O comando `` SELECT`` leva uma série de argumentos opcionais.</p>
<section id="orderby">
<h4>ordenar por<a class="headerlink" href="#orderby" title="Link permanente para este título"></a></h4>
<p>Você pode buscar os registros classificados pelo nome:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
<p>Você pode buscar os registros classificados pelo nome em ordem inversa (aviso o til):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=~</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Carl</span>
<span class="go">Bob</span>
<span class="go">Alex</span>
</pre></div>
</div>
<p>Você pode ter os registros obtida aparecem em ordem aleatória:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="s1">&#39;&lt;random&gt;&#39;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Carl</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
</pre></div>
</div>
<blockquote>
<div><p>O uso de `` orderby = “&lt;random&gt;” `` não é suportada no Google NoSQL. No entanto, para superar esse limite, a classificação pode ser feito em linhas selecionadas:</p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
</pre></div>
</div>
<p>Você pode classificar os registros de acordo com vários campos concatenando-los com um “<a href="#id1"><span class="problematic" id="id2">|</span></a>”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">|</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
</section>
<section id="groupby-having">
<h4>groupby, tendo<a class="headerlink" href="#groupby-having" title="Link permanente para este título"></a></h4>
<p>Usando `` groupby`` juntamente com `` orderby``, você pode agrupar registros com o mesmo valor para o campo especificado (isto é back-end específico, e não é sobre o Google NoSQL):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">orderby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">groupby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
<p>Pode usar `` having`` em conjunto com `` groupby`` ao grupo condicionalmente (apenas aqueles `` having`` a condição estão agrupados).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">query1</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">having</span><span class="o">=</span><span class="n">query2</span><span class="p">)</span>
</pre></div>
</div>
<p>Observe que os registros filtros Consulta1 a ser exibido, registros filtros Query2 ser agrupados.</p>
</section>
<section id="distinct">
<h4>distinto<a class="headerlink" href="#distinct" title="Link permanente para este título"></a></h4>
<p>Com o argumento `` distinta = True``, você pode especificar que você só quer selecionar registros distintos. Isto tem o mesmo efeito que o agrupamento usando todos os campos especificados, exceto que ele não necessita de classificação. Ao usar distinta é importante não para selecionar todos os campos, e em particular para não selecionar o campo “id”, senão todos os registros serão sempre distintas.</p>
<p>Aqui está um exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
<p>Note que `` distinct`` também pode ser uma expressão, por exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
<span class="go">Carl</span>
</pre></div>
</div>
</section>
<section id="limitby">
<h4>limitby<a class="headerlink" href="#limitby" title="Link permanente para este título"></a></h4>
<p>Com `` limitby = (min, max) <a href="#id1"><span class="problematic" id="id2">``</span></a>, pode seleccionar um subconjunto dos registos de deslocamento = min, mas não incluindo offset = máx. No próximo exemplo nós selecionamos os dois primeiros registros a partir de zero:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">limitby</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Bob</span>
</pre></div>
</div>
</section>
<section id="orderby-on-limitby">
<h4>orderby_on_limitby<a class="headerlink" href="#orderby-on-limitby" title="Link permanente para este título"></a></h4>
<p>Note-se que os padrões DAL de adicionar implicitamente um orderby ao usar um limitby. Isso garante a mesma consulta retorna os mesmos resultados de cada vez, importante para a paginação. Mas pode causar problemas de desempenho. use `` orderby_on_limitby = False`` para mudar isso (isso o padrão é True).</p>
</section>
<section id="join-left">
<h4>juntar-se, deixou<a class="headerlink" href="#join-left" title="Link permanente para este título"></a></h4>
<p>These are involved in managing <a class="reference internal" href="#one-to-many-relation">One to many relation</a>. They are
described in <a class="reference internal" href="#inner-join">Inner join</a> and <a class="reference internal" href="#left-outer-join">Left outer join</a> sections respectively.</p>
</section>
<section id="cache-cacheable">
<h4>cache, em cache<a class="headerlink" href="#cache-cacheable" title="Link permanente para este título"></a></h4>
<p>An example use which gives much faster selects is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">ram</span><span class="p">,</span> <span class="mi">3600</span><span class="p">),</span> <span class="n">cacheable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Look at <a class="reference internal" href="#caching-selects">Caching selects</a>, to understand what the trade-offs are.</p>
</section>
</section>
<section id="logical-operators">
<h3>Operadores lógicos<a class="headerlink" href="#logical-operators" title="Link permanente para este título"></a></h3>
<p>As consultas podem ser combinados usando o binário operador AND “` <cite>&amp;</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">((</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;Alex&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span> <span class="nb">print</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<span class="go">0</span>
</pre></div>
</div>
<p>eo binário operador OR “` <cite>|</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">((</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span> <span class="nb">print</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
<span class="go">1 Alex</span>
</pre></div>
</div>
<p>Você pode negar uma sub-consulta invertendo o seu operador:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">((</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span> <span class="nb">print</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
<span class="go">2 Bob</span>
<span class="go">3 Carl</span>
</pre></div>
</div>
<p>ou pela negação explícita com o “` <cite>~</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>” operador unário:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span> <span class="nb">print</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
<span class="go">2 Bob</span>
<span class="go">3 Carl</span>
</pre></div>
</div>
<blockquote>
<div><p>Devido a restrições de Python em sobrecarga “` <cite>and`</cite>” e “` <cite>or`</cite>” operadores, estes não podem ser utilizados na formação de consultas. Os operadores binários “` <cite>&amp;</cite> <cite>” e “</cite> <cite>|</cite> <cite>” deve ser usado em seu lugar. Note-se que estes operadores (ao contrário de “</cite> <cite>and`</cite>” e “` <cite>or`</cite>”) tem precedência maior do que os operadores de comparação, de modo que os parênteses “extra” nos exemplos acima são de preenchimento obrigatório. Da mesma forma, o operador unitário “~` `` <cite>” tem precedência mais elevada do que os operadores de comparação, de modo ~ `</cite> `` comparações -negated também deve estar entre parênteses.</p>
</div></blockquote>
<p>Também é possível consultas construir usando in-place operadores lógicos:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;Alex&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">&amp;=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">|=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;John&#39;</span>
</pre></div>
</div>
</section>
<section id="count-isempty-delete-update">
<h3>`` Count``, `` isempty``, `` DELETE``, `` update``<a class="headerlink" href="#count-isempty-delete-update" title="Link permanente para este título"></a></h3>
<p>Você pode contar registros em um conjunto:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;William&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="go">3</span>
</pre></div>
</div>
<p>Note que `` count`` leva um opcional `` distinct`` argumento que o padrão é falso, e ele funciona muito parecido com o mesmo argumento para `` SELECT``. `` Count`` tem também um argumento `` cache`` que funciona muito parecido com o argumento equivalente do método <cite>SELECT`</cite>.</p>
<p>Às vezes você pode precisar verificar se uma tabela está vazia. Uma maneira mais eficiente do que a contagem está a utilizar o método <cite>isempty`</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">isempty</span><span class="p">()</span>
<span class="go">False</span>
</pre></div>
</div>
<p>Você pode excluir registros em um jogo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="go">0</span>
</pre></div>
</div>
<p>A `` DELETE`` método devolve o número de registos que foram eliminados.</p>
<p>E você pode atualizar todos os registros em um conjunto, passando argumentos nomeados correspondentes aos campos que precisam ser atualizados:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Ken&#39;</span><span class="p">)</span>
<span class="go">1</span>
</pre></div>
</div>
<p>O método <cite>update`</cite> retorna o número de registros que foram atualizados.</p>
</section>
<section id="expressions">
<h3>Expressões<a class="headerlink" href="#expressions" title="Link permanente para este título"></a></h3>
<p>O valor atribuído uma instrução de atualização pode ser uma expressão. Por exemplo, considere este modelo</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;visits&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Massimo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">visits</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">visits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Os valores usados ​​em consultas também podem ser expressões</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;visits&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;clicks&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">visits</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">clicks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="case">
<h3>`` case``<a class="headerlink" href="#case" title="Link permanente para este título"></a></h3>
<p>Uma expressão pode conter uma cláusula case, por exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">condition</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">yes_or_no</span> <span class="o">=</span> <span class="n">condition</span><span class="o">.</span><span class="n">case</span><span class="p">(</span><span class="s1">&#39;Yes&#39;</span><span class="p">,</span> <span class="s1">&#39;No&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">yes_or_no</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">yes_or_no</span><span class="p">])</span>  <span class="c1"># could be row(yes_or_no) too</span>
<span class="gp">...</span>
<span class="go">Alex No</span>
<span class="go">Bob Yes</span>
<span class="go">Ken No</span>
</pre></div>
</div>
</section>
<section id="update-record">
<h3>`` Update_record``<a class="headerlink" href="#update-record" title="Link permanente para este título"></a></h3>
<p>py4web também permite actualizar um único registro que já está na memória usando `` update_record``</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">update_record</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Curt&#39;</span><span class="p">)</span>
<span class="go">&lt;Row {&#39;id&#39;: 2, &#39;name&#39;: &#39;Curt&#39;}&gt;</span>
</pre></div>
</div>
<p>`` Update_record`` não deve ser confundido com</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Curt&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>porque para uma única linha, o método `` update`` atualiza o objeto de linha, mas não o registro de banco de dados, como no case de `` update_record``.</p>
<p>Também é possível alterar os atributos de uma linha (um de cada vez) e, em seguida, chamar `` update_record () `` sem argumentos para salvar as alterações:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Philip&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">update_record</span><span class="p">()</span> <span class="c1"># saves above change</span>
<span class="go">&lt;Row {&#39;id&#39;: 3, &#39;name&#39;: &#39;Philip&#39;}&gt;</span>
</pre></div>
</div>
<blockquote>
<div><p>Note, you should avoid using <code class="docutils literal notranslate"><span class="pre">row.update_record()</span></code> with no
arguments when the <code class="docutils literal notranslate"><span class="pre">row</span></code> object contains fields that have an
<code class="docutils literal notranslate"><span class="pre">update</span></code> attribute (e.g.,
<code class="docutils literal notranslate"><span class="pre">Field('modified_on',</span> <span class="pre">update=datetime.datetime.utcnow)</span></code>). Calling
<code class="docutils literal notranslate"><span class="pre">row.update_record()</span></code> will retain <em>all</em> of the existing values in
the <code class="docutils literal notranslate"><span class="pre">row</span></code> object, so any fields with <code class="docutils literal notranslate"><span class="pre">update</span></code> attributes will
have no effect in this case. Be particularly mindful of this with
tables that include <code class="docutils literal notranslate"><span class="pre">auth.signature</span></code>.</p>
</div></blockquote>
<p>O método <cite>update_record`</cite> está disponível apenas se campo` <cite>id`</cite> da tabela está incluído no seleto, e` <cite>cacheable`</cite> não está definido para` <cite>True`</cite>.</p>
</section>
<section id="inserting-and-updating-from-a-dictionary">
<h3>Inserir e atualizar a partir de um dicionário<a class="headerlink" href="#inserting-and-updating-from-a-dictionary" title="Link permanente para este título"></a></h3>
<p>Um problema comum é composto de precisar inserir ou atualizar registros em uma tabela onde o nome da tabela, o campo para ser atualizado, eo valor para o campo são armazenados em variáveis. Por exemplo: `` tablename``, `` fieldname``, e `` value``.</p>
<p>A inserção pode ser feito usando a seguinte sintaxe:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">fieldname</span><span class="p">:</span><span class="n">value</span><span class="p">})</span>
</pre></div>
</div>
<p>A atualização do registro com dado id pode ser feito com:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span><span class="o">.</span><span class="n">_id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">fieldname</span><span class="p">:</span><span class="n">value</span><span class="p">})</span>
</pre></div>
</div>
<p>Observe que usamos `` table._id`` ao invés de `` table.id``. Desta forma, a consulta funciona mesmo para tabelas com um campo de chave primária com o tipo diferente de “id”.</p>
</section>
<section id="first-and-last">
<h3>`` `` First`` e last``<a class="headerlink" href="#first-and-last" title="Link permanente para este título"></a></h3>
<p>Dado um objecto linhas contendo registos:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">first_row</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">last_row</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
</pre></div>
</div>
<p>são equivalentes às</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">first_row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
<span class="n">last_row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
</pre></div>
</div>
<p>Observe, `` primeiro () `` e `` última () `` permitem obter, obviamente, o primeiro e último registro presente em sua consulta, mas isso não significa que esses registros estão indo para ser o primeiro ou o último inserido registros. No case de pretender o primeiro ou último registro inserido em uma determinada tabela não se esqueça de usar `` orderby = db.table_name.id``. Se você esquecer você só vai conseguir o primeiro eo último registro retornado pela consulta, que são muitas vezes em uma ordem aleatória determinada pelo otimizador de consulta backend.</p>
</section>
<section id="as-dict-and-as-list">
<h3>`` `` As_dict`` e as_list``<a class="headerlink" href="#as-dict-and-as-list" title="Link permanente para este título"></a></h3>
<p>Fila objecto pode ser serializados em um dicionário normal usando a `` as_dict () `` método e um objecto de linhas pode ser serializados em uma lista de dicionários usando a `` as_list () `` método. aqui estão alguns exemplos:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">rows_list</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">as_list</span><span class="p">()</span>
<span class="n">first_row_dict</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
</pre></div>
</div>
<p>These methods are convenient for passing Rows to generic views and or to
store Rows in sessions (Rows objects themselves cannot be
serialized because they contain a reference to an open DB connection):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span>  <span class="c1"># not allowed!</span>
<span class="n">session</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">as_list</span><span class="p">()</span>  <span class="c1"># allowed!</span>
</pre></div>
</div>
</section>
<section id="combining-rows">
<h3>Combinando Rows<a class="headerlink" href="#combining-rows" title="Link permanente para este título"></a></h3>
<p>Fileiras objectos podem ser combinadas no nível Python. Aqui assumimos:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows1</span><span class="p">)</span>
<span class="go">person.name</span>
<span class="go">Max</span>
<span class="go">Tim</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows2</span><span class="p">)</span>
<span class="go">person.name</span>
<span class="go">John</span>
<span class="go">Tim</span>
</pre></div>
</div>
<p>Você pode fazer a união dos registros em dois conjuntos de linhas:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows3</span> <span class="o">=</span> <span class="n">rows1</span> <span class="o">+</span> <span class="n">rows2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows3</span><span class="p">)</span>
<span class="go">person.name</span>
<span class="go">Max</span>
<span class="go">Tim</span>
<span class="go">John</span>
<span class="go">Tim</span>
</pre></div>
</div>
<p>Você pode fazer a união dos registros remoção de duplicatas:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows3</span> <span class="o">=</span> <span class="n">rows1</span> <span class="o">|</span> <span class="n">rows2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows3</span><span class="p">)</span>
<span class="go">person.name</span>
<span class="go">Max</span>
<span class="go">Tim</span>
<span class="go">John</span>
</pre></div>
</div>
<p>Você pode fazer intersecção dos registros em dois conjuntos de linhas:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows3</span> <span class="o">=</span> <span class="n">rows1</span> <span class="o">&amp;</span> <span class="n">rows2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows3</span><span class="p">)</span>
<span class="go">person.name</span>
<span class="go">Tim</span>
</pre></div>
</div>
</section>
<section id="find-exclude-sort">
<h3>`` Find``, `` exclude``, `` sort``<a class="headerlink" href="#find-exclude-sort" title="Link permanente para este título"></a></h3>
<p>Algumas vezes você precisa executar duas seleciona e um contém um subconjunto de um seleto anterior. Neste case, é inútil para acessar o banco de dados novamente. Os `` find``, `` exclude`` e `` objetos sort`` permitem manipular fileiras objeto e gerar outro sem acessar o banco de dados. Mais especificamente: - `` retorna find`` um novo conjunto de linhas filtradas por uma condição e deixa o inalterados originais. - `` retornos exclude`` um novo conjunto de linhas filtrados por uma condição e remove-los das linhas originais. - `` retorna sort`` um novo conjunto de linhas classificadas por uma condição e deixa o inalterados originais.</p>
<p>Todos estes métodos dar um único argumento, uma função que age em cada linha individual.</p>
<p>Aqui está um exemplo de uso:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Max&#39;</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Alex&#39;</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;M&#39;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Max</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;M&#39;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Max</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">John</span>
</pre></div>
</div>
<p>Eles podem ser combinados:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Max</span>
</pre></div>
</div>
<p>Tipo leva um argumento opcional `` reversa = True`` com o significado óbvio.</p>
<p>O método <cite>find`</cite> tem um argumento` <cite>limitby`</cite> opcional com a mesma sintaxe e funcionalidade como o conjunto` <cite>método SELECT`</cite>.</p>
</section>
<section id="caching-selects">
<h3>Selects com cache<a class="headerlink" href="#caching-selects" title="Link permanente para este título"></a></h3>
<p>O método de seleção também leva um argumento cache`` <code class="docutils literal notranslate"><span class="pre">,</span> <span class="pre">cujo</span> <span class="pre">padrão</span> <span class="pre">é</span> <span class="pre">None.</span> <span class="pre">Para</span> <span class="pre">fins</span> <span class="pre">de</span> <span class="pre">armazenamento</span> <span class="pre">em</span> <span class="pre">cache,</span> <span class="pre">deve</span> <span class="pre">ser</span> <span class="pre">definido</span> <span class="pre">como</span> <span class="pre">um</span> <span class="pre">tuplo</span> <span class="pre">em</span> <span class="pre">que</span> <span class="pre">o</span> <span class="pre">primeiro</span> <span class="pre">elemento</span> <span class="pre">é</span> <span class="pre">o</span> <span class="pre">modelo</span> <span class="pre">do</span> <span class="pre">cache</span> <span class="pre">(</span> <span class="pre">``</span> <span class="pre">cache.ram</span></code>, `` cache.disk``, etc), e o segundo elemento é o tempo de validade em segundo .</p>
<p>No exemplo a seguir, você vê um controlador que armazena em cache um seleto sobre a mesa db.log previamente definido. As buscas reais dados selecionados do banco de dados back-end não mais do que uma vez a cada 60 segundos e armazena o resultado na memória. Se a próxima chamada para este controlador ocorre em menos de 60 segundos desde o último banco de dados IO, ele simplesmente vai buscar os dados anteriores da memória.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cache_db_select</span><span class="p">():</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">ram</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">logs</span><span class="o">=</span><span class="n">logs</span><span class="p">)</span>
</pre></div>
</div>
<p>O método <cite>SELECT`</cite> tem um argumento` <cite>cacheable`</cite> opcional, normalmente definido como False. Quando `` cacheável = True`` o resultante `` Rows`` Serializável mas `` A falta row`` s `` `` update_record`` e métodos delete_record``.</p>
<p>Se você não precisar destes métodos você pode acelerar seleciona um lote, definindo o atributo `` cacheable``:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cacheable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Quando o argumento `` cache`` está definido, mas `` cacheable = False`` (default), apenas os resultados de banco de dados são armazenados em cache, não as linhas reais objeto. Quando o argumento `` cache`` é usado em conjunto com `` cacheável = True`` as linhas inteiras objecto é cache e isso resulta em muito mais rápido cache:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">ram</span><span class="p">,</span> <span class="mi">3600</span><span class="p">),</span> <span class="n">cacheable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="computed-and-virtual-fields">
<h2>Computed and Virtual fields<a class="headerlink" href="#computed-and-virtual-fields" title="Link permanente para este título"></a></h2>
<section id="computed-fields">
<h3>Campos computados<a class="headerlink" href="#computed-fields" title="Link permanente para este título"></a></h3>
<p>Campos DAL podem ter um atributo `` compute``. Esta deve ser uma função (ou lambda) que recebe um objeto Row e retorna um valor para o campo. Quando um novo registo é modificado, incluindo inserções e atualizações, se um valor para o campo não é fornecido, py4web tenta calcular a partir dos outros valores de campo utilizando a função `` compute``. Aqui está um exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;total_price&#39;</span><span class="p">,</span>
<span class="gp">... </span>                      <span class="n">compute</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;unit_price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]))</span>
<span class="go">&lt;Table item (id, unit_price, quantity, total_price)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">unit_price</span><span class="o">=</span><span class="mf">1.99</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span>
<span class="go">&lt;Row {&#39;total_price&#39;: &#39;9.95&#39;, &#39;unit_price&#39;: 1.99, &#39;id&#39;: 1L, &#39;quantity&#39;: 5}&gt;</span>
</pre></div>
</div>
<p>Notice that the computed value is stored in the db and it is not
computed on retrieval, as in the case of virtual fields, described next.
Two typical applications of computed fields are:</p>
<ul class="simple">
<li><p>in wiki applications, to store the processed input wiki text as HTML, to
avoid re-processing on every request</p></li>
<li><p>for searching, to compute normalized values for a field, to be used for searching.</p></li>
</ul>
<p>Computed fields are evaluated in the order in which they are defined in
the table definition. A computed field can refer to previously defined
computed fields.</p>
</section>
<section id="virtual-fields">
<h3>Campos virtuais<a class="headerlink" href="#virtual-fields" title="Link permanente para este título"></a></h3>
<p>Campos virtuais também são computados campos (como na subseção anterior), mas eles diferem daquelas porque são * * virtual no sentido de que não são armazenadas no db e eles são calculados a cada vez registros são extraídos do banco de dados. Eles podem ser usados ​​para simplificar o código do usuário sem usar armazenamento adicional, mas eles não podem ser usados ​​para pesquisa.</p>
</section>
<section id="new-style-virtual-fields-experimental">
<h3>Campos virtuais novo estilo (experimental)<a class="headerlink" href="#new-style-virtual-fields-experimental" title="Link permanente para este título"></a></h3>
<p>py4web fornece uma nova e mais fácil maneira de definir campos virtuais e campos virtuais preguiçosos. Esta seção é marcado experimental porque as APIs ainda podem mudar um pouco do que é descrito aqui.</p>
<p>Aqui vamos considerar o mesmo exemplo na subseção anterior. Em particular, considere o seguinte modelo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Pode-se definir um `` total_price`` campo virtual como</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">total_price</span> <span class="o">=</span> <span class="n">Field</span><span class="o">.</span><span class="n">Virtual</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="n">row</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
</pre></div>
</div>
<p>isto é, simplesmente definindo um novo campo `` total_price`` ser um `` Field.Virtual``. O único argumento do construtor é uma função que recebe uma linha e retorna os valores calculados.</p>
<p>Um campo virtual definido como o descrito acima é calculado automaticamente para todos os registros quando os registros são selecionados:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">total_price</span><span class="p">)</span>
</pre></div>
</div>
<p>Também é possível definir campos de métodos que são calculados on-demand, quando chamado. Por exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">discounted_total</span> <span class="o">=</span> \
    <span class="n">Field</span><span class="o">.</span><span class="n">Method</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">,</span> <span class="n">discount</span><span class="o">=</span><span class="mf">0.0</span><span class="p">:</span>
                 <span class="n">row</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="n">row</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span> <span class="o">*</span> <span class="p">(</span><span class="mf">100.0</span> <span class="o">-</span> <span class="n">discount</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
<p>Neste case, `` row.discounted_total`` não é um valor, mas uma função. A função usa os mesmos argumentos que a função passada para o `` construtor Method`` exceto `` row`` que está implícito (pense nisso como `` self`` para objetos).</p>
<p>O campo preguiçoso no exemplo acima permite uma para calcular o valor total para cada `` item``:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">discounted_total</span><span class="p">())</span>
</pre></div>
</div>
<p>E também permite passar um `` percentual discount`` opcional (digamos 15%):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">discounted_total</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
</pre></div>
</div>
<p>Campos virtuais e de método também podem ser definidos no lugar quando uma tabela é definida:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="o">.</span><span class="n">Virtual</span><span class="p">(</span><span class="s1">&#39;total_price&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="o">...</span><span class="p">),</span>
                <span class="n">Field</span><span class="o">.</span><span class="n">Method</span><span class="p">(</span><span class="s1">&#39;discounted_total&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">,</span> <span class="n">discount</span><span class="o">=</span><span class="mf">0.0</span><span class="p">:</span> <span class="o">...</span><span class="p">))</span>
</pre></div>
</div>
<blockquote>
<div><p>Mind that virtual fields do not have the same attributes as regular
fields (length, default, required, etc). They do not appear in the
list of <code class="docutils literal notranslate"><span class="pre">db.table.fields</span></code>.</p>
</div></blockquote>
</section>
<section id="old-style-virtual-fields">
<h3>Campos virtuais velho antigo<a class="headerlink" href="#old-style-virtual-fields" title="Link permanente para este título"></a></h3>
<p>A fim de definir um ou mais virtuais campos, você também pode definir uma classe de contêiner, instanciá-lo e vinculá-lo a uma tabela ou a um seleto. Por exemplo, considere a seguinte tabela:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Pode-se definir um `` total_price`` campo virtual como</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyVirtualFields</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span>

<span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">virtualfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MyVirtualFields</span><span class="p">())</span>
</pre></div>
</div>
<p>Observe que cada método da classe que recebe um único argumento (auto) é um novo campo virtual. `` Self`` refere-se a cada linha de uma select. valores de campo são referidos pelo caminho completo como em `` self.item.unit_price``. A tabela está ligada aos campos virtuais anexando uma instância da classe para atributo `` virtualfields`` da tabela.</p>
<p>Campos virtuais também podem acessar campos recursivos como em</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;order_item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;reference item&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">MyVirtualFields</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">quantity</span>

<span class="n">db</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">virtualfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MyVirtualFields</span><span class="p">())</span>
</pre></div>
</div>
<p>Observe o acesso de campo recursiva `` self.order_item.item.unit_price`` onde `` self`` é o registro looping.</p>
<p>Eles também podem agir sobre o resultado de um JOIN</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">item</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">MyVirtualFields</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">quantity</span>

<span class="n">rows</span><span class="o">.</span><span class="n">setvirtualfields</span><span class="p">(</span><span class="n">order_item</span><span class="o">=</span><span class="n">MyVirtualFields</span><span class="p">())</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">total_price</span><span class="p">)</span>
</pre></div>
</div>
<p>Note como neste case, a sintaxe é diferente. O campo virtual acessa tanto `` self.item.unit_price`` e `` self.order_item.quantity`` que pertencem ao juntar-se selecionar. O campo virtual é anexado para as linhas da tabela usando o método <cite>setvirtualfields`</cite> do objecto linhas. Este método leva um número arbitrário de argumentos nomeados e pode ser usado para definir vários campos virtuais, definidos em várias classes, e anexá-los a várias tabelas:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyVirtualFields1</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">discounted_unit_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="mf">0.90</span>

<span class="k">class</span> <span class="nc">MyVirtualFields2</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">quantity</span>
    <span class="k">def</span> <span class="nf">discounted_total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">discounted_unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">quantity</span>

<span class="n">rows</span><span class="o">.</span><span class="n">setvirtualfields</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">MyVirtualFields1</span><span class="p">(),</span>
                      <span class="n">order_item</span><span class="o">=</span><span class="n">MyVirtualFields2</span><span class="p">())</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">order_item</span><span class="o">.</span><span class="n">discounted_total_price</span><span class="p">)</span>
</pre></div>
</div>
<p>Campos virtuais podem ser * lazy* ; tudo que eles precisam fazer é retornar uma função e acessá-lo chamando a função:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">MyVirtualFields</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">lazy_total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">lazy</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span>
        <span class="k">return</span> <span class="n">lazy</span>

<span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">virtualfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MyVirtualFields</span><span class="p">())</span>

<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">lazy_total_price</span><span class="p">())</span>
</pre></div>
</div>
<p>ou mais curto utilizando uma função lambda:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyVirtualFields</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">lazy_total_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span>
</pre></div>
</div>
</section>
</section>
<section id="joins-and-relations">
<h2>Joins and Relations<a class="headerlink" href="#joins-and-relations" title="Link permanente para este título"></a></h2>
<section id="one-to-many-relation">
<h3>Um para muitos relação<a class="headerlink" href="#one-to-many-relation" title="Link permanente para este título"></a></h3>
<p>Para ilustrar como implementar um para muitos relação com a DAL, definir outra mesa “coisa” que refere-se à mesa “pessoa” que redefinir aqui:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Alex&#39;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Bob&#39;</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Carl&#39;</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>
<span class="go">&lt;Table thing (id, name, owner_id)&gt;</span>
</pre></div>
</div>
<p>Table “thing” has two fields, the name of the thing and the owner of the
thing. The “owner_id” field is a reference field, it is intended that
the field reference the other table by its id. A reference type can be
specified in two equivalent ways, either:
<code class="docutils literal notranslate"><span class="pre">Field('owner_id',</span> <span class="pre">'reference</span> <span class="pre">person')</span></code> or:
<code class="docutils literal notranslate"><span class="pre">Field('owner_id',</span> <span class="pre">db.person)</span></code>.</p>
<p>Este último é sempre convertido para o ex. Eles são equivalentes, exceto no case de tabelas preguiçosos, referências auto ou outros tipos de referências cíclicas onde o ex-notação é a notação só é permitido.</p>
<p>Agora, insira três coisas, duas de propriedade de Alex e um por Bob:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Boat&#39;</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Chair&#39;</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Shoes&#39;</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="go">3</span>
</pre></div>
</div>
<p>Você pode selecionar como você fez para qualquer outra tabela:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Boat</span>
<span class="go">Chair</span>
</pre></div>
</div>
<p>Porque uma coisa tem uma referência a uma pessoa, uma pessoa pode ter muitas coisas, assim que um registro da tabela pessoa agora adquire uma coisa nova atributo, que é um conjunto, que define as coisas dessa pessoa. Isso permite que um loop sobre todas as pessoas e buscar as suas coisas com facilidade:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">person</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="p">,</span> <span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">     Boat</span>
<span class="go">     Chair</span>
<span class="go">Bob</span>
<span class="go">     Shoes</span>
<span class="go">Carl</span>
</pre></div>
</div>
</section>
<section id="inner-join">
<h3>Inner join<a class="headerlink" href="#inner-join" title="Link permanente para este título"></a></h3>
<p>Outra forma de conseguir um resultado semelhante é usando uma junção, especificamente um INNER JOIN. executa py4web junta-se automaticamente e de forma transparente quando a consulta liga dois ou mais tabelas como no exemplo a seguir:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex has Boat</span>
<span class="go">Alex has Chair</span>
<span class="go">Bob has Shoes</span>
</pre></div>
</div>
<p>Observe que py4web fez uma junção, então as linhas agora contêm dois registros, um de cada mesa, ligados entre si. Porque os dois registros podem ter campos com nomes conflitantes, você precisa especificar a tabela quando se extrai um valor de campo de uma linha. Isto significa que enquanto antes que você poderia fazer:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>e era óbvio que se este era o nome de uma pessoa ou uma coisa, em resultado de uma junção que você tem que ser mais explícito e dizer:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>ou:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>Há uma sintaxe alternativa para associações internas:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">join</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex has Boat</span>
<span class="go">Alex has Chair</span>
<span class="go">Bob has Shoes</span>
</pre></div>
</div>
<p>Enquanto a saída é o mesmo, o SQL gerado nos dois cases, pode ser diferente. O último sintaxe remove as ambiguidades possíveis quando a mesma tabela é unidas duas vezes e alias:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id1&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id2&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>

<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">join</span><span class="o">=</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;owner_id1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id1</span><span class="p">),</span>
              <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;owner_id2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id2</span><span class="p">)])</span>
</pre></div>
</div>
<p>O valor de `` join`` pode ser lista de `` db.table.on (…) `` para participar.</p>
</section>
<section id="left-outer-join">
<h3>Left outer join<a class="headerlink" href="#left-outer-join" title="Link permanente para este título"></a></h3>
<p>Observe que Carl não aparecer na lista acima, porque ele não tem as coisas. Se você pretende selecionar sobre as pessoas (se eles têm coisas ou não) e as suas coisas (se tiver algum), então você precisa para realizar um LEFT OUTER JOIN. Isso é feito usando o argumento de “esquerda” da seleção. Aqui está um exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">left</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex has Boat</span>
<span class="go">Alex has Chair</span>
<span class="go">Bob has Shoes</span>
<span class="go">Carl has None</span>
</pre></div>
</div>
<p>Where:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">left</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>é que a esquerda se juntar a consulta. Aqui o argumento de `` db.thing.on`` é a condição necessária para a junção (o mesmo utilizado acima para a junção interna). No case de uma associação à esquerda, é necessário ser explícito sobre quais campos para selecionar.</p>
<p>Multiple esquerda junções podem ser combinados, passando uma lista ou tupla de `` db.mytable.on (…) `` para o parâmetro `` left``.</p>
</section>
<section id="grouping-and-counting">
<h3>Agrupamento e contando<a class="headerlink" href="#grouping-and-counting" title="Link permanente para este título"></a></h3>
<p>Ao fazer junta-se, às vezes você quer agrupar linhas de acordo com certos critérios e contá-los. Por exemplo, contar o número de coisas pertencentes a cada pessoa. py4web permite isso também. Primeiro, você precisa de um operador de contagem. Em segundo lugar, você quer se juntar a tabela a pessoa com o quadro de coisa pelo proprietário. Terceiro, você quer selecionar todas as linhas (pessoa + coisa), agrupá-los por pessoa, e contá-los enquanto agrupamento:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">count</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span>
<span class="gp">... </span>              <span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">count</span><span class="p">])</span>
<span class="gp">...</span>
<span class="go">Alex 2</span>
<span class="go">Bob 1</span>
</pre></div>
</div>
<p>Observe a `` operador count`` (que é incorporado) é usado como um campo. O único problema aqui é em como recuperar a informação. Cada linha contém claramente uma pessoa e a contagem, mas a contagem não é um campo de uma pessoa nem é uma mesa. Então, onde ela vai? Ele vai para o objeto de armazenamento representando o registro com uma chave igual ao próprio expressão de consulta.</p>
<p>O método <cite>count`</cite> do objeto campo tem um argumento` <cite>distinct`</cite> opcional. Quando ajustado para `` True`` especifica que apenas os valores distintos de campo em questão estão a ser contadas.</p>
</section>
<section id="many-to-many-relation">
<h3>Many to many relation<a class="headerlink" href="#many-to-many-relation" title="Link permanente para este título"></a></h3>
<p>Nos exemplos anteriores, que permitiram uma coisa para ter um proprietário, mas uma pessoa pode ter muitas coisas. E se barco era propriedade de Alex e Curt? Isso requer uma relação muitos-para-muitos, e é realizada através de uma tabela intermediária que liga uma pessoa a uma coisa através de uma relação de propriedade.</p>
<p>Aqui está como fazê-lo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Alex&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Bob&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Carl&#39;</span><span class="p">)])</span>
<span class="go">[1, 2, 3]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table thing (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Boat&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Chair&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Shoes&#39;</span><span class="p">)])</span>
<span class="go">[1, 2, 3]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;ownership&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span> <span class="s1">&#39;reference thing&#39;</span><span class="p">))</span>
<span class="go">&lt;Table ownership (id, person, thing)&gt;</span>
</pre></div>
</div>
<p>a relação de propriedade existente pode agora ser reescrita como:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">thing</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Alex owns Boat</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">thing</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Alex owns Chair</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">thing</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># Bob owns Shoes</span>
<span class="go">3</span>
</pre></div>
</div>
<p>Agora você pode adicionar a nova relação que Curt co-proprietária Barco:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">thing</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Curt owns Boat too</span>
<span class="go">4</span>
</pre></div>
</div>
<p>Porque agora você tem uma relação de três vias entre as mesas, pode ser conveniente para definir um novo conjunto no qual executar as operações:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">persons_and_things</span> <span class="o">=</span> <span class="n">db</span><span class="p">((</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">person</span><span class="p">)</span> <span class="o">&amp;</span>
<span class="gp">... </span>                        <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">ownership</span><span class="o">.</span><span class="n">thing</span><span class="p">))</span>
</pre></div>
</div>
<p>Agora é fácil para selecionar todas as pessoas e suas coisas da nova Set:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">persons_and_things</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex has Boat</span>
<span class="go">Alex has Chair</span>
<span class="go">Bob has Shoes</span>
<span class="go">Curt has Boat</span>
</pre></div>
</div>
<p>Da mesma forma, você pode procurar por todas as coisas pertencentes a Alex:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">persons_and_things</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Alex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Boat</span>
<span class="go">Chair</span>
</pre></div>
</div>
<p>e todos os proprietários de barco:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">persons_and_things</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Boat&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Alex</span>
<span class="go">Curt</span>
</pre></div>
</div>
<p>Uma alternativa mais leve para muitos-para-muitos relações é a marcação, encontram-se um exemplo disso na próxima seção. Marcação de obras, mesmo em backends de banco de dados que não suportam JOINs como o Google App Engine NoSQL.</p>
</section>
<section id="self-reference-and-aliases">
<h3>A auto-referência e aliases<a class="headerlink" href="#self-reference-and-aliases" title="Link permanente para este título"></a></h3>
<p>É possível definir tabelas com campos que se referem a si mesmos, aqui está um exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;father_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;mother_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Observe que a notação alternativa de usar um objeto de tabela como tipo de campo irá falhar neste case, porque ele usa uma tabela antes de ser definido:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;father_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">),</span>  <span class="c1"># wrong!</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;mother_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;person&#39;</span><span class="p">]))</span>  <span class="c1"># wrong!</span>
</pre></div>
</div>
<p>Em geral `` <cite>db.tablename`</cite> e “` referência tablename”`` são tipos de campo equivalentes, mas o último é o único que tem permissão para auto-referências.</p>
<p>Quando uma tabela tem uma auto-referência e você tem que fazer se juntar, por exemplo, para selecionar uma pessoa e seu pai, você precisa de um alias para a tabela. Em SQL um alias é um nome alternativo temporário que você pode usar para fazer referência a uma tabela / coluna em uma consulta (ou outra instrução SQL).</p>
<p>Com py4web você pode fazer um alias para uma tabela usando o método <cite>with_alias`</cite>. Isso funciona também para expressões, o que significa também para campos desde `` Field`` é derivada de `` Expression``.</p>
<p>Aqui está um exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">fid</span><span class="p">,</span> <span class="n">mid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Massimo&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Claudia&#39;</span><span class="p">)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Marco&#39;</span><span class="p">,</span> <span class="n">father_id</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">mother_id</span><span class="o">=</span><span class="n">mid</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Father</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;father&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Mother</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;mother&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">Father</span><span class="p">)</span>
<span class="go">&lt;class &#39;pydal.objects.Table&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">str</span><span class="p">(</span><span class="n">Father</span><span class="p">)</span>
<span class="go">&#39;person AS father&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">Father</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">Mother</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">left</span><span class="o">=</span><span class="p">(</span><span class="n">Father</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">Father</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">father_id</span><span class="p">),</span>
<span class="gp">... </span>                         <span class="n">Mother</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">Mother</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">mother_id</span><span class="p">)))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">father</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">mother</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Massimo None None</span>
<span class="go">Claudia None None</span>
<span class="go">Marco Massimo Claudia</span>
</pre></div>
</div>
<p>Observe que optámos por fazer uma distinção entre: - “father_id”: o nome do campo usado na “pessoa” mesa; - “pai”: o alias que deseja usar para a tabela referenciada pelo campo acima; esta é comunicada ao banco de dados; - “Pai”: a variável usada por py4web para se referir a esse alias.</p>
<p>A diferença é sutil, e não há nada de errado em usar o mesmo nome para os três:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;father&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;mother&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name, father, mother)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fid</span><span class="p">,</span> <span class="n">mid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Massimo&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Claudia&#39;</span><span class="p">)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Marco&#39;</span><span class="p">,</span> <span class="n">father</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">mother</span><span class="o">=</span><span class="n">mid</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">father</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;father&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mother</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">with_alias</span><span class="p">(</span><span class="s1">&#39;mother&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">father</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mother</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">left</span><span class="o">=</span><span class="p">(</span><span class="n">father</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">father</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">father</span><span class="p">),</span>
<span class="gp">... </span>                         <span class="n">mother</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">mother</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">mother</span><span class="p">)))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">father</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">mother</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Massimo None None</span>
<span class="go">Claudia None None</span>
<span class="go">Marco Massimo Claudia</span>
</pre></div>
</div>
<p>Mas é importante ter a distinção clara, a fim de construir perguntas corretas.</p>
</section>
</section>
<section id="other-operators">
<h2>Outros operadores<a class="headerlink" href="#other-operators" title="Link permanente para este título"></a></h2>
<p>py4web tem outros operadores que fornecem uma API para operadores SQL equivalentes de acesso. Vamos definir outra mesa “log” para eventos loja de segurança, sua event_time e gravidade, onde a gravidade é um número inteiro.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">),</span>
<span class="gp">... </span>                       <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;event_time&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">),</span>
<span class="gp">... </span>                       <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;severity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">))</span>
<span class="go">&lt;Table log (id, event, event_time, severity)&gt;</span>
</pre></div>
</div>
<p>Como antes, inserir alguns eventos, a “varredura de portas”, uma “injeção de XSS” e um “login não autorizado”. Por causa do exemplo, você pode registrar eventos com o mesmo event_time mas com diferentes gravidades (1, 2, e 3, respectivamente).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s1">&#39;port scan&#39;</span><span class="p">,</span> <span class="n">event_time</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s1">&#39;xss injection&#39;</span><span class="p">,</span> <span class="n">event_time</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s1">&#39;unauthorized login&#39;</span><span class="p">,</span> <span class="n">event_time</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="go">3</span>
</pre></div>
</div>
<section id="like-ilike-regexp-startswith-endswith-contains-upper-lower">
<h3>`` Like``, `` ilike``, `` regexp``, `` startswith``, `` endswith``, `` contains``, `` upper``, `` lower``<a class="headerlink" href="#like-ilike-regexp-startswith-endswith-contains-upper-lower" title="Link permanente para este título"></a></h3>
<p>Campos tem um `` operador like`` que você pode usar para combinar strings:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;port%&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">port scan</span>
</pre></div>
</div>
<p>Aqui “porta%” indica uma partida string com “porta”. O personagem por cento sinal, “%”, é um personagem wild-card que significa “qualquer sequência de caracteres”.</p>
<p>O `` operador like`` mapeia para a palavra como em ANSI-SQL. COMO é sensível a maiúsculas na maioria dos bancos de dados, e depende do agrupamento do próprio banco de dados. O método <cite>like`</cite> é, portanto, case-sensível, mas ele pode ser feito de maiúsculas e minúsculas com</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>que é o mesmo que usar `` ilike``</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>py4web também fornece alguns atalhos:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>que são aproximadamente equivalentes, respectivamente, a</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;value%&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;%value&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;%value%&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Remember that <code class="docutils literal notranslate"><span class="pre">contains</span></code> has a special meaning for <code class="docutils literal notranslate"><span class="pre">list:&lt;type&gt;</span></code>
fields, as discussed in <a class="reference internal" href="#list-type-and-contains"><span class="std std-ref">`` Lista: &lt;type&gt; `` e `` contains``</span></a>.</p>
<p>O método <cite>contains`</cite> também pode ser passada uma lista de valores e um argumento booleano opcional` <cite>all`</cite> para procurar registros que contêm todos os valores:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">contains</span><span class="p">([</span><span class="s1">&#39;value1&#39;</span><span class="p">,</span> <span class="s1">&#39;value2&#39;</span><span class="p">],</span> <span class="nb">all</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>ou qualquer valor a partir da lista</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="o">.</span><span class="n">contains</span><span class="p">([</span><span class="s1">&#39;value1&#39;</span><span class="p">,</span> <span class="s1">&#39;value2&#39;</span><span class="p">],</span> <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Há um também um `` método regexp`` que funciona como o método <cite>like`</cite> mas permite sintaxe de expressão regular para a expressão look-up. Ele só é suportado pelo MySQL, Oracle, PostgreSQL, SQLite, e MongoDB (com diferente grau de apoio).</p>
<p>O `` upper`` e `` métodos lower`` permitem converter o valor do campo para maiúsculas ou minúsculas, e você também pode combiná-los com o gosto do operador:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;PORT%&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">port scan</span>
</pre></div>
</div>
</section>
<section id="year-month-day-hour-minutes-seconds">
<h3>`` Year``, `` month``, `` day``, `` hour``, `` minutes``, `` seconds``<a class="headerlink" href="#year-month-day-hour-minutes-seconds" title="Link permanente para este título"></a></h3>
<p>A data ea data e hora campos têm `` day``, `` month`` e `` métodos year``. Os campos de data e hora e de tempo têm `` hour``, `` `` minutes`` e métodos seconds``. Aqui está um exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event_time</span><span class="o">.</span><span class="n">year</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">2018</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">port scan</span>
<span class="go">xss injection</span>
<span class="go">unauthorized login</span>
</pre></div>
</div>
</section>
<section id="belongs">
<h3>`` Belongs``<a class="headerlink" href="#belongs" title="Link permanente para este título"></a></h3>
<p>O operador IN SQL é realizado através do método <cite>belongs`</cite> que devolve verdadeiro quando o valor do campo pertence ao conjunto especificado (lista ou tuplos):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">severity</span><span class="o">.</span><span class="n">belongs</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">port scan</span>
<span class="go">xss injection</span>
</pre></div>
</div>
<p>A DAL também permite que um SELECT aninhada como o argumento do operador pertence. A única limitação é que o seleccione aninhada tem de ser um `` _select``, não um `` SELECT``, e apenas um campo tem de ser seleccionada explicitamente, o que define o conjunto.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">bad_days</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">_select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event_time</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event_time</span><span class="o">.</span><span class="n">belongs</span><span class="p">(</span><span class="n">bad_days</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">severity</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">1 port scan</span>
<span class="go">2 xss injection</span>
<span class="go">3 unauthorized login</span>
</pre></div>
</div>
<p>Nos cases em que um seleto aninhada é necessária e o campo look-up é uma referência também podemos usar uma consulta como argumento. Por exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>

<span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="o">.</span><span class="n">belongs</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Jonathan&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
</pre></div>
</div>
<p>Neste case, é óbvio que o SELECT aninhada só precisa do campo referenciado pelo campo `` db.thing.owner_id`` por isso não precisa do `` notação mais detalhado _select``.</p>
<p>A selecção pode aninhada também ser usado como insert valor / atualização, mas, neste case, a sintaxe é diferente:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lazy</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Jonathan&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">nested_select</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">owner_id</span> <span class="o">=</span> <span class="n">lazy</span><span class="p">)</span>
</pre></div>
</div>
<p>Neste case, `` lazy`` é uma expressão aninhada que calcula o `` id`` de pessoa “Jonathan”. As duas linhas resultar em uma consulta SQL única.</p>
</section>
<section id="sum-avg-min-max-and-len">
<h3>`` Sum``, `` avg``, `` min``, `` `` max`` e len``<a class="headerlink" href="#sum-avg-min-max-and-len" title="Link permanente para este título"></a></h3>
<p>Anteriormente, você usou o `` operador count`` para contar registros. Da mesma forma, você pode usar o `` operador sum`` para adicionar (soma) os valores de um campo específico de um grupo de registros. Tal como no case de contagem, o resultado de uma soma é recuperado através do objecto de armazenamento:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">sum</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">severity</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="nb">sum</span><span class="p">])</span>
<span class="go">6</span>
</pre></div>
</div>
<p>Você também pode usar `` avg``, `` min``, e `` max`` à média, mínimo e valor máximo, respectivamente, para os registros selecionados. Por exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">max</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">severity</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">max</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="nb">max</span><span class="p">])</span>
<span class="go">3</span>
</pre></div>
</div>
<p>`` Len`` calcula o comprimento do valor do campo. Ele é geralmente usado em cordas ou texto campos, mas dependendo do back-end que ainda pode funcionar para outros tipos também (boolean, integer, etc).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">13</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">unauthorized login</span>
</pre></div>
</div>
<p>As expressões podem ser combinados para formar expressões mais complexas. Por exemplo, aqui estamos calculando a soma do comprimento das strings de eventos nos logs de mais um:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="n">exp</span><span class="p">]</span>
<span class="go">43</span>
</pre></div>
</div>
</section>
<section id="substrings">
<h3>Substrings<a class="headerlink" href="#substrings" title="Link permanente para este título"></a></h3>
<p>Pode-se construir uma expressão para se referir a uma substring. Por exemplo, podemos agrupar as coisas cujo nome começa com os mesmos três personagens e selecione apenas um de cada grupo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">distinct</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="default-values-with-coalesce-and-coalesce-zero">
<h3>Os valores por defeito com `` `` coalesce`` e coalesce_zero``<a class="headerlink" href="#default-values-with-coalesce-and-coalesce-zero" title="Link permanente para este título"></a></h3>
<p>Há momentos em que você precisa para puxar um valor de banco de dados, mas também precisa de valores padrão se o valor para um registro é definido como NULL. Em SQL existe uma função, `` COALESCE``, para isso. py4web tem um método <cite>coalesce`</cite> equivalente:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;sysuser&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;fullname&#39;</span><span class="p">))</span>
<span class="go">&lt;Table sysuser (id, username, fullname)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Max Power&#39;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;tim&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">coa</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">fullname</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">coa</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">coa</span><span class="p">])</span>
<span class="gp">...</span>
<span class="go">Max Power</span>
<span class="go">tim</span>
</pre></div>
</div>
<p>Outras vezes você precisa para calcular uma expressão matemática, mas alguns campos têm um valor definido para Nenhum quando deveria ser zero. `` Coalesce_zero`` vem para o resgate por falta Nada a zero na consulta:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;sysuser&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;points&#39;</span><span class="p">))</span>
<span class="go">&lt;Table sysuser (id, username, points)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;tim&#39;</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exp</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">sysuser</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">coalesce_zero</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="n">exp</span><span class="p">]</span>
<span class="go">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
<span class="go">&lt;class &#39;pydal.objects.Expression&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
<span class="go">SUM(COALESCE(&quot;sysuser&quot;.&quot;points&quot;,&#39;0&#39;))</span>
</pre></div>
</div>
</section>
</section>
<section id="exporting-and-importing-data">
<h2>Exportar e importar dados<a class="headerlink" href="#exporting-and-importing-data" title="Link permanente para este título"></a></h2>
<section id="csv-one-table-at-a-time">
<h3>CSV (uma tabela de cada vez)<a class="headerlink" href="#csv-one-table-at-a-time" title="Link permanente para este título"></a></h3>
<p>Quando um objeto linhas é convertido para uma string é automaticamente serializado na CSV:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<span class="go">person.id,person.name,thing.id,thing.name,thing.owner_id</span>
<span class="go">1,Alex,1,Boat,1</span>
<span class="go">1,Alex,2,Chair,1</span>
<span class="go">2,Bob,3,Shoes,2</span>
</pre></div>
</div>
<p>Você pode serializar uma única tabela em formato CSV e armazená-lo em um arquivo “test.csv”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">dumpfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()))</span>
</pre></div>
</div>
<p>Converting a <code class="docutils literal notranslate"><span class="pre">Rows</span></code> object into a string produces an encoded binary string
and it’s better to be explicit with the encoding used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">dumpfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()))</span>
</pre></div>
</div>
<p>Isto é equivalente a</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">rows</span><span class="o">.</span><span class="n">export_to_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>Você pode ler o arquivo de volta CSV com:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">import_from_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>Again, you can be explict about the encoding for
the exporting file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">rows</span><span class="o">.</span><span class="n">export_to_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>ea importação de um:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">import_from_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>When importing, py4web looks for the field names in the CSV header. In
this example, it finds two columns: “person.id” and “person.name”. It
ignores the “person.” prefix, and it ignores the “id” fields. Then all
records are appended and assigned new ids.</p>
</section>
<section id="csv-all-tables-at-once">
<h3>CSV (todas as tabelas ao mesmo tempo)<a class="headerlink" href="#csv-all-tables-at-once" title="Link permanente para este título"></a></h3>
<p>Em py4web, você pode backup / restaurar um banco de dados inteiro com dois comandos:</p>
<p>Exportar:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;somefile.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">export_to_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>Importar:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;somefile.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dumpfile</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">import_from_csv_file</span><span class="p">(</span><span class="n">dumpfile</span><span class="p">)</span>
</pre></div>
</div>
<p>Este mecanismo pode ser utilizado mesmo se a banco de dados de importação é de um tipo diferente do que a banco de dados de exportação.</p>
<p>Os dados são armazenados em “somefile.csv” como um arquivo CSV, onde cada mesa começa com uma linha que indica o nome da tabela, e outra linha com os nomes de campos:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TABLE tablename
field1,field2,field3,...
</pre></div>
</div>
<p>Duas tabelas são separados por `` r n r n`` (que é duas linhas vazias). As extremidades de arquivos com a linha</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>END
</pre></div>
</div>
<p>O arquivo não inclui os arquivos enviados, se estes não são armazenados no banco de dados. Os upload de arquivos armazenados no sistema de arquivos deve ser despejado em separado, um zip dos “uploads” pasta pode ser suficiente na maioria dos cases.</p>
<p>Ao importar, os novos registros serão anexados ao banco de dados se não está vazio. Em geral, os novos registros importados não terão o mesmo ID de registro como os registros originais (salvos), mas py4web irá restaurar referências para que eles não estão quebrados, mesmo que os valores id podem mudar.</p>
<p>Se uma tabela contém um campo chamado `` uuid``, este campo será utilizado para identificar duplicatas. Além disso, se um registro importado tem o mesmo `` uuid`` como um registro existente, o recorde anterior será atualizada.</p>
</section>
<section id="csv-and-remote-database-synchronization">
<h3>CSV e sincronização de banco de dados remoto<a class="headerlink" href="#csv-and-remote-database-synchronization" title="Link permanente para este título"></a></h3>
<p>Considere mais uma vez o seguinte modelo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference person&#39;</span><span class="p">))</span>

<span class="c1"># usage example</span>
<span class="k">if</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">isempty</span><span class="p">():</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Massimo&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Chair&#39;</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="n">nid</span><span class="p">)</span>
</pre></div>
</div>
<p>Cada registro é identificado por um identificador e referenciado por esse id. Se você tem duas cópias do banco de dados usado por instalações py4web distintas, o id é único apenas dentro de cada banco de dados e não através das bases de dados. Este é um problema ao mesclar registros de bancos de dados diferentes.</p>
<p>A fim de fazer registros exclusivamente identificável através de bases de dados, eles devem: - ter um ID único (UUID), - ter uma última modificação para acompanhar o mais recente entre várias cópias, - referência o UUID em vez do id.</p>
<p>Isto pode ser conseguido mudando o modelo acima para:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">64</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;modified_on&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">now</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">64</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;modified_on&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">now</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;owner_id&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">64</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">uuid</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

<span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IN_DB</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;person.uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># usage example</span>
<span class="k">if</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">isempty</span><span class="p">():</span>
    <span class="n">nid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">nid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Massimo&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Chair&#39;</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="n">nid</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><p>Note-se que nas definições da tabela acima, o valor padrão para os dois campos `` uuid`` é definida como uma função de lambda, que retorna um UUID (convertido para uma strings). A função lambda é chamado uma vez para cada registro inserido, garantindo que cada registro recebe um UUID único, mesmo que vários registros são inseridos em uma única transação.</p>
</div></blockquote>
<p>Criar uma ação de controlador para exportar o banco de dados:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">export</span><span class="p">():</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">export_to_csv_file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/csv&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</pre></div>
</div>
<p>Criar uma ação de controlador para importar uma cópia salva dos outros registros de dados e sincronização:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">yatl.helpers</span> <span class="kn">import</span> <span class="n">FORM</span><span class="p">,</span> <span class="n">INPUT</span>

<span class="k">def</span> <span class="nf">import_and_sync</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">FORM</span><span class="p">(</span><span class="n">INPUT</span><span class="p">(</span><span class="n">_type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">_name</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">),</span> <span class="n">INPUT</span><span class="p">(</span><span class="n">_type</span><span class="o">=</span><span class="s1">&#39;submit&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">process</span><span class="p">()</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">import_from_csv_file</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># for every table</span>
        <span class="k">for</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
            <span class="c1"># for every uuid, delete all but the latest</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                     <span class="n">orderby</span><span class="o">=~</span><span class="n">table</span><span class="o">.</span><span class="n">modified_on</span><span class="p">,</span>
                                     <span class="n">groupby</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">db</span><span class="p">((</span><span class="n">table</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></div>
</div>
<p>Opcionalmente, você deve criar um índice manualmente para fazer a busca por uuid mais rápido.</p>
<p>Alternativamente, você pode usar XML-RPC para exportar / importar o arquivo.</p>
<p>Se os registros referência a arquivos enviados, você também precisa exportar / importar o conteúdo da pasta uploads. Observe que os arquivos nele já são rotulados por UUIDs para que você não precisa se preocupar com conflitos de nomes e referências.</p>
</section>
<section id="html-and-xml-one-table-at-a-time">
<h3>HTML e XML (uma tabela de cada vez)<a class="headerlink" href="#html-and-xml-one-table-at-a-time" title="Link permanente para este título"></a></h3>
<p>Linhas objetos também têm um método <cite>xml`</cite> (como ajudantes) que serializa-lo para XML / HTML:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">owner_id</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">rows</span><span class="o">.</span><span class="n">xml</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">table</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">thead</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;&lt;</span><span class="nt">th</span><span class="p">&gt;</span>person.id<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;&lt;</span><span class="nt">th</span><span class="p">&gt;</span>person.name<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>thing.id<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;&lt;</span><span class="nt">th</span><span class="p">&gt;</span>thing.name<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>thing.owner_id<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">thead</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tbody</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w2p_odd odd&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Alex<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Boat<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w2p_even even&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Alex<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>2<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Chair<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>1<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w2p_odd odd&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>2<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Bob<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>3<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Shoes<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>2<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tbody</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>If you need to serialize the Rows in any other XML format with custom
tags, you can easily do that using the universal <a class="reference internal" href="chapter-10.html#tag"><span class="std std-ref">`` TAG``</span></a> helper
that we’ll see later and the Python syntax
<code class="docutils literal notranslate"><span class="pre">*&lt;iterable&gt;</span></code> allowed in function calls:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">TAG</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">TAG</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">TAG</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">_name</span><span class="o">=</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">fields</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;result&gt;</span>
<span class="nt">&lt;row&gt;&lt;field</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span><span class="nt">&gt;</span>1<span class="nt">&lt;/field&gt;&lt;field</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>Alex<span class="nt">&lt;/field&gt;&lt;/row&gt;</span>
<span class="nt">&lt;row&gt;&lt;field</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span><span class="nt">&gt;</span>2<span class="nt">&lt;/field&gt;&lt;field</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>Bob<span class="nt">&lt;/field&gt;&lt;/row&gt;</span>
<span class="nt">&lt;row&gt;&lt;field</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span><span class="nt">&gt;</span>3<span class="nt">&lt;/field&gt;&lt;field</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>Carl<span class="nt">&lt;/field&gt;&lt;/row&gt;</span>
<span class="nt">&lt;/result&gt;</span>
</pre></div>
</div>
</section>
<section id="data-representation">
<h3>Representação de dados<a class="headerlink" href="#data-representation" title="Link permanente para este título"></a></h3>
<p>O método <cite>Rows.export_to_csv_file`</cite> aceita um argumento de palavra-chave chamada` <cite>represent`</cite>. Quando `` True`` ele usará as colunas função `` represent`` ao exportar os dados, em vez dos dados brutos.</p>
<p>A função também aceita um argumento de palavra-chave chamada `` colnames`` que deve conter uma lista de nomes de colunas um desejo para exportação. O padrão é todas as colunas.</p>
<p>Ambos `` export_to_csv_file`` e `` import_from_csv_file`` aceitar argumentos de palavra-chave que contam o analisador CSV o formato para salvar / carregar os arquivos: - `` delimiter``: delimitador para separar valores (padrão “”) - `` quotechar <code class="docutils literal notranslate"><span class="pre">:</span> <span class="pre">personagem</span> <span class="pre">para</span> <span class="pre">usar</span> <span class="pre">para</span> <span class="pre">citar</span> <span class="pre">valores</span> <span class="pre">String</span> <span class="pre">(default</span> <span class="pre">para</span> <span class="pre">aspas)</span> <span class="pre">-</span> <span class="pre">``</span> <span class="pre">quoting</span></code>: sistema de cotação (padrão `` csv.QUOTE_MINIMAL``)</p>
<p>Aqui estão algumas Exemplo de uso:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">csv</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/tmp/test.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">oufile</span><span class="p">:</span>
    <span class="n">rows</span><span class="o">.</span><span class="n">export_to_csv_file</span><span class="p">(</span><span class="n">oufile</span><span class="p">,</span>
                            <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span>
                            <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span>
                            <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NONNUMERIC</span><span class="p">)</span>
</pre></div>
</div>
<p>O que tornaria algo semelhante a</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&quot;hello&quot;|35|&quot;this is the text description&quot;|&quot;2013-03-03&quot;
</pre></div>
</div>
<p>Para mais informações consulte a documentação oficial do Python</p>
</section>
</section>
<section id="advanced-features">
<h2>Características avançadas<a class="headerlink" href="#advanced-features" title="Link permanente para este título"></a></h2>
<section id="list-type-and-contains">
<span id="id1"></span><h3>`` Lista: &lt;type&gt; `` e `` contains``<a class="headerlink" href="#list-type-and-contains" title="Link permanente para este título"></a></h3>
<p>py4web fornece os seguintes tipos de campos especiais:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">:</span><span class="n">string</span>
<span class="nb">list</span><span class="p">:</span><span class="n">integer</span>
<span class="nb">list</span><span class="p">:</span><span class="n">reference</span> <span class="o">&lt;</span><span class="n">table</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Eles podem conter listas de cordas, de inteiros e de referências, respectivamente.</p>
<p>No Google App Engine NoSQL `` lista: string`` é mapeado em `` StringListProperty``, os outros dois são mapeados em `` ListProperty (int) <a href="#id1"><span class="problematic" id="id2">``</span></a>. Em bancos de dados relacionais são mapeados em campos de texto que contém a lista de itens separados por `` | <a href="#id3"><span class="problematic" id="id4">``</span></a>. Por exemplo `` [1, 2, 3] `` é mapeado para `` | 1 | 2 | 3 | <a href="#id5"><span class="problematic" id="id6">``</span></a>.</p>
<p>Para listas de corda os itens são escapou de modo que qualquer `` | `` no item é substituído por um `` || <a href="#id1"><span class="problematic" id="id2">``</span></a>. De qualquer forma esta é uma representação interna e é transparente para o usuário.</p>
<p>Você pode usar `` lista: string``, por exemplo, da seguinte maneira:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;product&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">,</span> <span class="s1">&#39;list:string&#39;</span><span class="p">))</span>
<span class="go">&lt;Table product (id, name, colors)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IN_SET</span><span class="p">((</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Toy Car&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">])</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">products</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">colors</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Toy Car [&#39;red&#39;, &#39;green&#39;]</span>
</pre></div>
</div>
<p>`` Lista: obras integer`` da mesma forma, mas os itens devem ser inteiros.</p>
<p>Como de costume, os requisitos são aplicadas ao nível das formas, não no nível de `` insert``.</p>
<blockquote>
<div><p>Por `` lista: &lt;type&gt; `` campos de `` contém (valor) `` operador de mapas em uma consulta não trivial que verifica a existência de listas contendo o `` value``. O `` operador contains`` também funciona para regular, `` string`` e `` campos text`` e ele mapeia para um `` LIKE “% value%” <a href="#id1"><span class="problematic" id="id2">``</span></a>.</p>
</div></blockquote>
<p>O `` lista: reference`` eo `` contém (valor) `` operador são particularmente úteis para de-normalize muitos-para-muitos relações. Aqui está um exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="go">&lt;Table tag (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;product&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;list:reference tag&#39;</span><span class="p">))</span>
<span class="go">&lt;Table product (id, name, tags)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Toy Car&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">])</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">products</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">Toy Car [1, 2, 3]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">represent</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">tags</span><span class="p">))</span>
<span class="gp">...</span>
<span class="go">Toy Car red, green, blue</span>
</pre></div>
</div>
<p>Observe que um `` lista: Campo tag`` referência obter uma restrição padrão</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">requires</span> <span class="o">=</span> <span class="n">IS_IN_DB</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">_format</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>que produz um `` / OPTION`` gota-caixa múltipla SELECT formas.</p>
<p>Além disso, observe que este campo recebe um atributo <cite>represent`</cite> que representa a lista de referências como uma lista separada por vírgulas de referências formatados` padrão. Isto é usado em leitura `` forms``.</p>
<blockquote>
<div><p>Enquanto `` lista: reference`` tem um validador padrão e uma representação padrão, `` lista: integer`` e `` lista: string`` não. Então, esses dois precisam de um `` IS_IN_SET`` ou um `` validador IS_IN_DB`` se você quiser usá-los em formas.</p>
</div></blockquote>
</section>
<section id="table-inheritance">
<h3>Herança de tabela<a class="headerlink" href="#table-inheritance" title="Link permanente para este título"></a></h3>
<p>É possível criar uma tabela que contém todos os campos de outra tabela. É suficiente para passar a outra tabela no lugar de um campo para `` define_table``. Por exemplo</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;gender&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name, gender)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;doctor&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;specialization&#39;</span><span class="p">))</span>
<span class="go">&lt;Table doctor (id, name, gender, specialization)&gt;</span>
</pre></div>
</div>
<p>Também é possível definir uma tabela fictícia que não está armazenado em um banco de dados, a fim de reutilizá-la em vários outros lugares. Por exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span>

<span class="n">signature</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;signature&#39;</span><span class="p">,</span>
                     <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;is_active&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                     <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;created_on&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">),</span>
                     <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;created_by&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">auth</span><span class="o">.</span><span class="n">user_id</span><span class="p">),</span>
                     <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;modified_on&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">now</span><span class="p">),</span>
                     <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;modified_by&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">auth</span><span class="o">.</span><span class="n">user_id</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;payment&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span> <span class="n">signature</span><span class="p">)</span>
</pre></div>
</div>
<p>Este exemplo parte do princípio que a autenticação py4web padrão está activada.</p>
<p>Note que se você usar `` Auth`` py4web já cria uma tal mesa para você:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">auth</span> <span class="o">=</span> <span class="n">Auth</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;payment&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span> <span class="n">auth</span><span class="o">.</span><span class="n">signature</span><span class="p">)</span>
</pre></div>
</div>
<p>Ao usar herança de tabela, se você deseja que a tabela herdar a validadores herdar, certifique-se de definir os validadores de tabela pai antes de definir a tabela herdar.</p>
</section>
<section id="filter-in-and-filter-out">
<span id="id2"></span><h3>`` `` Filter_in`` e filter_out``<a class="headerlink" href="#filter-in-and-filter-out" title="Link permanente para este título"></a></h3>
<p>É possível definir um filtro para cada campo a ser chamada antes de um valor é inserido na banco de dados para esse campo e depois de um valor é recuperado a partir da banco de dados.</p>
<p>Imagine for example that you want to store a serializable Python data
structure in a field in the JSON format. Here is how it could be
accomplished:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">json</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;anyobj&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">))</span>
<span class="go">&lt;Table anyobj (id, name, data)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">anyobj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filter_in</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">anyobj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filter_out</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">txt</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">myobj</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="mi">3</span><span class="p">}]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">aid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">anyobj</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;myobjname&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">myobj</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">anyobj</span><span class="p">[</span><span class="n">aid</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="o">.</span><span class="n">data</span>
<span class="go">[&#39;hello&#39;, &#39;world&#39;, 1, {&#39;2&#39;: 3}]</span>
</pre></div>
</div>
<p>Another way to accomplish the same is by using a Field of type
<code class="docutils literal notranslate"><span class="pre">SQLCustomType</span></code>, as discussed in <a class="reference internal" href="#custom-field-types"><span class="std std-ref">Personalizados `` tipos Field``</span></a>.</p>
</section>
<section id="callbacks-on-record-insert-delete-and-update">
<h3>retornos de chamada no registro de inserção, exclusão e atualização<a class="headerlink" href="#callbacks-on-record-insert-delete-and-update" title="Link permanente para este título"></a></h3>
<p>PY4WEB fornece um mecanismo para registrar retornos de chamada para ser chamado antes e / ou após a inserção, atualização e exclusão de registros.</p>
<p>Cada tabela armazena seis listas de chamadas de retorno:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>db.mytable._before_insert
db.mytable._after_insert
db.mytable._before_update
db.mytable._after_update
db.mytable._before_delete
db.mytable._after_delete
</pre></div>
</div>
<p>Você pode registrar uma função de retorno de chamada, acrescentando-o à lista correspondente. A ressalva é que, dependendo da funcionalidade, o retorno tem assinatura diferente.</p>
<p>This is best explained by examples.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
<span class="go">&lt;Table person (id, name)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">pprint</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_before_insert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;before_insert&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_after_insert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;after_insert&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;John&#39;</span><span class="p">)</span>
<span class="go">before_insert(&lt;OpRow {&#39;name&#39;: &#39;John&#39;}&gt;,)</span>
<span class="go">after_insert(&lt;OpRow {&#39;name&#39;: &#39;John&#39;}&gt;, 1)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_before_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;before_update&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_after_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;after_update&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Tim&#39;</span><span class="p">)</span>
<span class="go">before_update(&lt;Set (&quot;person&quot;.&quot;id&quot; = 1)&gt;, &lt;OpRow {&#39;name&#39;: &#39;Tim&#39;}&gt;)</span>
<span class="go">after_update(&lt;Set (&quot;person&quot;.&quot;id&quot; = 1)&gt;, &lt;OpRow {&#39;name&#39;: &#39;Tim&#39;}&gt;)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_before_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;before_delete&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">_after_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;after_delete&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="go">before_delete(&lt;Set (&quot;person&quot;.&quot;id&quot; = 1)&gt;,)</span>
<span class="go">after_delete(&lt;Set (&quot;person&quot;.&quot;id&quot; = 1)&gt;,)</span>
<span class="go">1</span>
</pre></div>
</div>
<p>Como você pode ver: - `` f`` é passado o objeto `` OpRow`` com os dados para inserção ou atualização. - `` i`` é passado o id do registro recém-inserido. - `` s`` é passado o objeto `` Set`` usado para atualizar ou excluir. `` OpRow`` é um objeto auxiliar especializada em armazenamento (campo, valor) pares, você pode pensar nisso como um dicionário normal que você pode usar até mesmo com a sintaxe da notação atributo (que é `` f.name`` e `` f [ “nome”] `` são equivalentes).</p>
<p>Os valores de retorno destes callback deve ser `` None`` ou `` False``. Se qualquer um dos `` _antes_ * `` retorno de chamada retorna um `` valor True`` ele irá abortar a / update / operação de exclusão real de inserção.</p>
<p>Algumas vezes uma chamada de retorno pode precisar executar uma atualização na mesma ou em uma tabela diferente e se quer evitar disparar outras chamadas de retorno, o que poderia causar um loop infinito.</p>
<p>Para este efeito, há os objetos `` Set`` tem um método <cite>update_naive`</cite> que funciona como` <cite>update`</cite> mas ignora antes e depois de retornos de chamada.</p>
<section id="database-cascades">
<h4>Cascades no banco de dados<a class="headerlink" href="#database-cascades" title="Link permanente para este título"></a></h4>
<p>Database schema can define relationships which trigger deletions of
related records, known as cascading. The DAL is not informed when a
record is deleted due to a cascade. So no *_delete callback will ever
be called as consequence of a cascade-deletion.</p>
</section>
</section>
<section id="record-versioning">
<h3>versionamento recorde<a class="headerlink" href="#record-versioning" title="Link permanente para este título"></a></h3>
<p>É possível pedir py4web para salvar cada cópia de um registro quando o registro é modificado individualmente. Existem diferentes maneiras de fazer isso e que pode ser feito para todas as tabelas ao mesmo tempo usando a sintaxe:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">auth</span><span class="o">.</span><span class="n">enable_record_versioning</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</pre></div>
</div>
<p>isso requer `` Auth``. Ele também pode ser feito para cada mesa, como discutido abaixo.</p>
<p>Considere a seguinte tabela:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;stored_item&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;is_active&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
                      <span class="n">writable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">readable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
<p>Observe o campo booleano oculto chamado `` is_active`` e padronizando para True.</p>
<p>Podemos dizer py4web para criar uma nova tabela (no mesmo ou em outro banco de dados) e armazenar todas as versões anteriores de cada registro na tabela, quando modificado.</p>
<p>Isso é feito da seguinte maneira:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">stored_item</span><span class="o">.</span><span class="n">_enable_record_versioning</span><span class="p">()</span>
</pre></div>
</div>
<p>ou em uma sintaxe mais detalhado:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">stored_item</span><span class="o">.</span><span class="n">_enable_record_versioning</span><span class="p">(</span><span class="n">archive_db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
                                         <span class="n">archive_name</span><span class="o">=</span><span class="s1">&#39;stored_item_archive&#39;</span><span class="p">,</span>
                                         <span class="n">current_record</span><span class="o">=</span><span class="s1">&#39;current_record&#39;</span><span class="p">,</span>
                                         <span class="n">is_active</span><span class="o">=</span><span class="s1">&#39;is_active&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>O `` archive_db = db`` diz py4web para armazenar a tabela de arquivo no mesmo banco de dados como o `` tabela stored_item``. O `` archive_name`` define o nome para a tabela de arquivo. A tabela de arquivo tem os mesmos campos como a tabela original `` stored_item`` exceto que campos exclusivos não são mais exclusivo (porque ele precisa para armazenar várias versões) e tem um campo extra que nome é especificado por `` current_record`` e que é uma referência para o registo atual na tabela `` stored_item``.</p>
<p>Quando os registros são excluídos, eles não são realmente excluídos. Um registro excluído é copiado na tabela `` stored_item_archive`` (como quando ele é modificado) e do campo `` is_active`` é definido como False. Ao permitir gravar versões conjuntos py4web um `` common_filter`` nesta tabela que esconde todos os registros na tabela `` stored_item`` onde o campo `` is_active`` é definida como falsa. O parâmetro `` is_active`` no método <cite>_enable_record_versioning`</cite> permite especificar o nome do campo usado pelo` <cite>common_filter`</cite> para determinar se o campo foi excluído ou não.</p>
</section>
<section id="common-filters">
<h3>filtros comuns<a class="headerlink" href="#common-filters" title="Link permanente para este título"></a></h3>
<p>Um filtro comum é uma generalização da ideia multi-tenancy acima. Ele fornece uma maneira fácil de evitar a repetição da mesma consulta. Considere, por exemplo, a tabela a seguir:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;blog_post&#39;</span><span class="p">,</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;post_text&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">),</span>
                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;is_public&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">),</span>
                <span class="n">common_filter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">query</span><span class="p">:</span> <span class="n">db</span><span class="o">.</span><span class="n">blog_post</span><span class="o">.</span><span class="n">is_public</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Qualquer select, DELETE ou UPDATE nesta tabela, vai incluir posts única públicos. O atributo também pode ser modificado em tempo de execução:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">blog_post</span><span class="o">.</span><span class="n">_common_filter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">query</span><span class="p">:</span> <span class="o">...</span>
</pre></div>
</div>
<p>Ela serve tanto como uma forma de evitar a repetição do “db.blog_post.is_public == True” frase em cada blog pesquisa post, e também como uma melhoria de segurança, que o impede de esquecer para não permitir a visualização de mensagens não-públicas.</p>
<p>No case de você realmente quer itens deixados de fora pelo filtro comum (por exemplo, permitindo que o administrador para ver mensagens não-públicas), você pode remover o filtro:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">blog_post</span><span class="o">.</span><span class="n">_common_filter</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<p>ou ignorá-lo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">ignore_common_filters</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<blockquote>
<div><p>Note-se que common_filters são ignorados pela interface AppAdmin.</p>
</div></blockquote>
</section>
<section id="custom-field-types">
<span id="id3"></span><h3>Personalizados `` tipos Field``<a class="headerlink" href="#custom-field-types" title="Link permanente para este título"></a></h3>
<p>Além de usar o `` filter_in`` e `` filter_out``, é possível definir novos tipos de campos / personalizados. Por exemplo, suponha que você deseja definir um tipo personalizado para armazenar um endereço IP:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">ip2int</span><span class="p">(</span><span class="n">sv</span><span class="p">):</span>
<span class="gp">... </span>    <span class="s2">&quot;Convert an IPV4 to an integer.&quot;</span>
<span class="gp">... </span>    <span class="n">sp</span> <span class="o">=</span> <span class="n">sv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span> <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="c1"># IPV4 only</span>
<span class="gp">... </span>    <span class="n">iip</span> <span class="o">=</span> <span class="mi">0</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">sp</span><span class="p">):</span> <span class="n">iip</span> <span class="o">=</span> <span class="p">(</span><span class="n">iip</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">iip</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">int2ip</span><span class="p">(</span><span class="n">iv</span><span class="p">):</span>
<span class="gp">... </span>    <span class="s2">&quot;Convert an integer to an IPV4.&quot;</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="n">iv</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="gp">... </span>    <span class="n">iv</span> <span class="o">=</span> <span class="p">(</span><span class="n">iv</span><span class="p">,);</span> <span class="n">ov</span> <span class="o">=</span> <span class="p">[]</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">iv</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">256</span><span class="p">)</span>
<span class="gp">... </span>        <span class="n">ov</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="gp">... </span>    <span class="n">ov</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ov</span><span class="p">))</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pydal</span> <span class="kn">import</span> <span class="n">SQLCustomType</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ipv4</span> <span class="o">=</span> <span class="n">SQLCustomType</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">native</span><span class="o">=</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span>
<span class="gp">... </span>                     <span class="n">encoder</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">ip2int</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">decoder</span><span class="o">=</span><span class="n">int2ip</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;website&#39;</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="gp">... </span>                <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;ipaddr&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">ipv4</span><span class="p">))</span>
<span class="go">&lt;Table website (id, name, ipaddr)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;wikipedia&#39;</span><span class="p">,</span> <span class="n">ipaddr</span><span class="o">=</span><span class="s1">&#39;91.198.174.192&#39;</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;google&#39;</span><span class="p">,</span> <span class="n">ipaddr</span><span class="o">=</span><span class="s1">&#39;172.217.11.174&#39;</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;youtube&#39;</span><span class="p">,</span> <span class="n">ipaddr</span><span class="o">=</span><span class="s1">&#39;74.125.65.91&#39;</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;github&#39;</span><span class="p">,</span> <span class="n">ipaddr</span><span class="o">=</span><span class="s1">&#39;207.97.227.239&#39;</span><span class="p">)</span>
<span class="go">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">ipaddr</span> <span class="o">&gt;</span> <span class="s1">&#39;100.0.0.0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">orderby</span><span class="o">=~</span><span class="n">db</span><span class="o">.</span><span class="n">website</span><span class="o">.</span><span class="n">ipaddr</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">ipaddr</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">github 207.97.227.239</span>
<span class="go">google 172.217.11.174</span>
</pre></div>
</div>
<p>`` SQLCustomType`` é uma fábrica tipo de campo. Seu argumento `` type`` deve ser um dos tipos py4web padrão. Diz py4web como tratar os valores de campo no nível py4web. `` Native`` é o tipo do campo, tanto quanto a banco de dados está em causa. nomes permitidos dependem do mecanismo de banco de dados. `` Encoder`` é uma transformação opcional função aplicada quando os dados são armazenados e `` decoder`` é a função de transformação inversa opcional.</p>
<blockquote>
<div><p>This feature is marked as experimental because can make your code not
portable across database engines.</p>
</div></blockquote>
<p>Ele não funciona no Google App Engine NoSQL.</p>
</section>
<section id="using-dal-without-define-tables">
<h3>Usando DAL sem definir tabelas<a class="headerlink" href="#using-dal-without-define-tables" title="Link permanente para este título"></a></h3>
<p>A DAL pode ser usado a partir de qualquer programa Python simplesmente fazendo isso:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pydal</span> <span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;path/to/app/databases&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>ou seja, importar a DAL, conexão e especificar a pasta que contém os arquivos .table (a pasta app / bancos de dados).</p>
<p>Para acessar os dados e seus atributos ainda temos que definir todas as tabelas que vão de acesso com `` db.define_table``.</p>
<p>Se nós apenas precisam de acesso aos dados, mas não para os atributos da tabela py4web, nós fugir sem re-definir as tabelas, mas simplesmente pedindo py4web para ler as informações necessárias a partir dos metadados nos ficheiros .table:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;path/to/app/databases&#39;</span><span class="p">,</span> <span class="n">auto_import</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Isso nos permite acessar qualquer db.table sem necessidade de re definir-lo.</p>
</section>
<section id="distributed-transaction">
<h3>Transação distribuída<a class="headerlink" href="#distributed-transaction" title="Link permanente para este título"></a></h3>
<blockquote>
<div><p>No momento da escrita deste recurso só é suportado pelo PostgreSQL, MySQL e Firebird, uma vez que expõem API para commits de duas fases.</p>
</div></blockquote>
<p>Supondo que você tenha dois (ou mais) conexões com bancos de dados PostgreSQL distintas, por exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db_a</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;postgres://...&#39;</span><span class="p">)</span>
<span class="n">db_b</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;postgres://...&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Em seus modelos ou controladores, você pode cometê-los simultaneamente com:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DAL</span><span class="o">.</span><span class="n">distributed_transaction_commit</span><span class="p">(</span><span class="n">db_a</span><span class="p">,</span> <span class="n">db_b</span><span class="p">)</span>
</pre></div>
</div>
<p>Em case de falha, esta função desfaz e levanta uma `` Exception``.</p>
<p>Em controladores, quando uma ação retornos, se você tiver duas ligações distintas e você não chamar a função acima, py4web compromete-los separadamente. Isto significa que há uma possibilidade de que um dos commits sucede e uma falha. A transação distribuída impede que isso aconteça.</p>
</section>
<section id="copy-data-from-one-db-into-another">
<h3>Copiar dados de um para outro db<a class="headerlink" href="#copy-data-from-one-db-into-another" title="Link permanente para este título"></a></h3>
<p>Considere a situação em que você estiver usando o seguinte banco de dados:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.sqlite&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>e você deseja mover para outro banco de dados usando uma seqüência de conexão diferente:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;postgres://username:password@localhost/mydb&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Antes de mudar, você quer mover os dados e reconstruir todos os metadados para o novo banco de dados. Assumimos o novo banco de dados a existir, mas nós também assumir que é vazio.</p>
</section>
</section>
<section id="gotchas">
<h2>Pegadinhas<a class="headerlink" href="#gotchas" title="Link permanente para este título"></a></h2>
<section id="note-on-new-dal-and-adapters">
<h3>Nota sobre novo DAL e adaptadores<a class="headerlink" href="#note-on-new-dal-and-adapters" title="Link permanente para este título"></a></h3>
<p>O código fonte do Banco de Dados Camada de Abstração foi completamente reescrito em 2010. Enquanto ele permanece compatível com versões anteriores, a reescrita tornou mais modular e mais fácil de estender. Aqui nós explicamos a lógica principal.</p>
<p>The module “dal.py” defines, among other, the following classes.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ConnectionPool
BaseAdapter extends ConnectionPool
Row
DAL
Reference
Table
Expression
Field
Query
Set
Rows
</pre></div>
</div>
<p>Seu uso tem sido explicado nas seções anteriores, exceto para `` BaseAdapter``. Quando os métodos de um `` Table`` ou `` necessidade objeto Set`` para se comunicar com o banco de dados que confiam aos métodos do adaptador a tarefa para gerar o SQL e ou a chamada de função.</p>
<p>Por exemplo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;myvalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>chamadas</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;myvalue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>que delega o adaptador de voltar:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">_listify</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">myfield</span><span class="o">=</span><span class="s1">&#39;myvalue&#39;</span><span class="p">)))</span>
</pre></div>
</div>
<p>Aqui `` convertidos db.mytable._listify`` o dict dos argumentos em uma lista de `` (campo, valor) `` e chama o método <cite>insert`</cite> do` <cite>adapter`</cite>. `` Db._adapter`` faz mais ou menos o seguinte:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="p">,</span> <span class="n">list_of_fields</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>
</div>
<p>onde a primeira linha constrói a consulta e o segundo executa.</p>
<p>`` BaseAdapter`` define a interface para todas as placas.</p>
<p>pyDAL at the moment of writing this book, contains the
following adapters:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SQLiteAdapter extends BaseAdapter
JDBCSQLiteAdapter extends SQLiteAdapter
MySQLAdapter extends BaseAdapter
PostgreSQLAdapter extends BaseAdapter
JDBCPostgreSQLAdapter extends PostgreSQLAdapter
OracleAdapter extends BaseAdapter
MSSQLAdapter extends BaseAdapter
MSSQL2Adapter extends MSSQLAdapter
MSSQL3Adapter extends MSSQLAdapter
MSSQL4Adapter extends MSSQLAdapter
FireBirdAdapter extends BaseAdapter
FireBirdEmbeddedAdapter extends FireBirdAdapter
InformixAdapter extends BaseAdapter
DB2Adapter extends BaseAdapter
IngresAdapter extends BaseAdapter
IngresUnicodeAdapter extends IngresAdapter
GoogleSQLAdapter extends MySQLAdapter
NoSQLAdapter extends BaseAdapter
GoogleDatastoreAdapter extends NoSQLAdapter
CubridAdapter extends MySQLAdapter (experimental)
TeradataAdapter extends DB2Adapter (experimental)
SAPDBAdapter extends BaseAdapter (experimental)
CouchDBAdapter extends NoSQLAdapter (experimental)
IMAPAdapter extends NoSQLAdapter (experimental)
MongoDBAdapter extends NoSQLAdapter (experimental)
VerticaAdapter extends MSSQLAdapter (experimental)
SybaseAdapter extends MSSQLAdapter (experimental)
</pre></div>
</div>
<p>que substituir o comportamento dos `` BaseAdapter``.</p>
<p>Cada adaptador tem mais ou menos a seguinte estrutura:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MySQLAdapter</span><span class="p">(</span><span class="n">BaseAdapter</span><span class="p">):</span>

    <span class="c1"># specify a driver to use</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pymysql&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># map py4web types into database types</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;boolean&#39;</span><span class="p">:</span> <span class="s1">&#39;CHAR(1)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="s1">&#39;VARCHAR(</span><span class="si">%(length)s</span><span class="s1">)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;LONGTEXT&#39;</span><span class="p">,</span>
        <span class="o">...</span>
        <span class="p">}</span>

    <span class="c1"># connect to the database using driver</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db_codec</span> <span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span>
                 <span class="n">credential_decoder</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">,</span> <span class="n">driver_args</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">adapter_args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="c1"># parse uri string and store parameters in driver_args</span>
        <span class="o">...</span>
        <span class="c1"># define a connection function</span>
        <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">driver_args</span><span class="o">=</span><span class="n">driver_args</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">driver_args</span><span class="p">)</span>
        <span class="c1"># place it in the pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_connection</span><span class="p">(</span><span class="n">connect</span><span class="p">)</span>
        <span class="c1"># set optional parameters (after connection)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SET FOREIGN_KEY_CHECKS=1;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET sql_mode=&#39;NO_BACKSLASH_ESCAPES&#39;;&quot;</span><span class="p">)</span>

   <span class="c1"># override BaseAdapter methods as needed</span>
   <span class="k">def</span> <span class="nf">lastrowid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select last_insert_id();&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>Olhando para os vários adaptadores como exemplo deve ser fácil de escrever novos.</p>
<p>Quando `` db`` exemplo é criado:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;mysql://...&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>the prefix in the uri string defines the adapter. The mapping is defined
in the following dictionary also in “dal.py”:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>couchdb</p></td>
<td><p>pydal.adapters.couchdb.CouchDB</p></td>
</tr>
<tr class="row-even"><td><p>cubrid</p></td>
<td><p>pydal.adapters.mysql.Cubrid</p></td>
</tr>
<tr class="row-odd"><td><p>db2:ibm_db_dbi</p></td>
<td><p>pydal.adapters.db2.DB2IBM</p></td>
</tr>
<tr class="row-even"><td><p>db2:pyodbc</p></td>
<td><p>pydal.adapters.db2.DB2Pyodbc</p></td>
</tr>
<tr class="row-odd"><td><p>firebird</p></td>
<td><p>pydal.adapters.firebird.FireBird</p></td>
</tr>
<tr class="row-even"><td><p>firebird_embedded</p></td>
<td><p>pydal.adapters.firebird.FireBirdEmbedded</p></td>
</tr>
<tr class="row-odd"><td><p>google:MySQLdb</p></td>
<td><p>pydal.adapters.google.GoogleMySQL</p></td>
</tr>
<tr class="row-even"><td><p>google:datastore</p></td>
<td><p>pydal.adapters.google.GoogleDatastore</p></td>
</tr>
<tr class="row-odd"><td><p>google:datastore+ndb</p></td>
<td><p>pydal.adapters.google.GoogleDatastore</p></td>
</tr>
<tr class="row-even"><td><p>google:psycopg2</p></td>
<td><p>pydal.adapters.google.GooglePostgres</p></td>
</tr>
<tr class="row-odd"><td><p>google:sql</p></td>
<td><p>pydal.adapters.google.GoogleSQL</p></td>
</tr>
<tr class="row-even"><td><p>informix</p></td>
<td><p>pydal.adapters.informix.Informix</p></td>
</tr>
<tr class="row-odd"><td><p>informix-se</p></td>
<td><p>pydal.adapters.informix.InformixSE</p></td>
</tr>
<tr class="row-even"><td><p>ingres</p></td>
<td><p>pydal.adapters.ingres.Ingres</p></td>
</tr>
<tr class="row-odd"><td><p>ingresu</p></td>
<td><p>pydal.adapters.ingres.IngresUnicode</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="jdbc:postgres">jdbc:postgres</a></p></td>
<td><p>pydal.adapters.postgres.JDBCPostgre</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="jdbc:sqlite">jdbc:sqlite</a></p></td>
<td><p>pydal.adapters.sqlite.JDBCSQLite</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="jdbc:sqlite:memory">jdbc:sqlite:memory</a></p></td>
<td><p>pydal.adapters.sqlite.JDBCSQLite</p></td>
</tr>
<tr class="row-odd"><td><p>mongodb</p></td>
<td><p>pydal.adapters.mongo.Mongo</p></td>
</tr>
<tr class="row-even"><td><p>mssql</p></td>
<td><p>pydal.adapters.mssql.MSSQL1</p></td>
</tr>
<tr class="row-odd"><td><p>mssql2</p></td>
<td><p>pydal.adapters.mssql.MSSQL1N</p></td>
</tr>
<tr class="row-even"><td><p>mssql3</p></td>
<td><p>pydal.adapters.mssql.MSSQL3</p></td>
</tr>
<tr class="row-odd"><td><p>mssql3n</p></td>
<td><p>pydal.adapters.mssql.MSSQL3N</p></td>
</tr>
<tr class="row-even"><td><p>mssql4</p></td>
<td><p>pydal.adapters.mssql.MSSQL4</p></td>
</tr>
<tr class="row-odd"><td><p>mssql4n</p></td>
<td><p>pydal.adapters.mssql.MSSQL4N</p></td>
</tr>
<tr class="row-even"><td><p>mssqln</p></td>
<td><p>pydal.adapters.mssql.MSSQL1N</p></td>
</tr>
<tr class="row-odd"><td><p>mysql</p></td>
<td><p>pydal.adapters.mysql.MySQL</p></td>
</tr>
<tr class="row-even"><td><p>oracle</p></td>
<td><p>pydal.adapters.oracle.Oracle</p></td>
</tr>
<tr class="row-odd"><td><p>postgres</p></td>
<td><p>pydal.adapters.postgres.Postgre</p></td>
</tr>
<tr class="row-even"><td><p>postgres2</p></td>
<td><p>pydal.adapters.postgres.PostgreNew</p></td>
</tr>
<tr class="row-odd"><td><p>postgres2:psycopg2</p></td>
<td><p>pydal.adapters.postgres.PostgrePsycoNew</p></td>
</tr>
<tr class="row-even"><td><p>postgres3</p></td>
<td><p>pydal.adapters.postgres.PostgreBoolean</p></td>
</tr>
<tr class="row-odd"><td><p>postgres3:psycopg2</p></td>
<td><p>pydal.adapters.postgres.PostgrePsycoBoolean</p></td>
</tr>
<tr class="row-even"><td><p>postgres:psycopg2</p></td>
<td><p>pydal.adapters.postgres.PostgrePsyco</p></td>
</tr>
<tr class="row-odd"><td><p>pytds</p></td>
<td><p>pydal.adapters.mssql.PyTDS</p></td>
</tr>
<tr class="row-even"><td><p>sapdb</p></td>
<td><p>pydal.adapters.sap.SAPDB</p></td>
</tr>
<tr class="row-odd"><td><p>spatialite</p></td>
<td><p>pydal.adapters.sqlite.Spatialite</p></td>
</tr>
<tr class="row-even"><td><p>spatialite:memory</p></td>
<td><p>pydal.adapters.sqlite.Spatialite</p></td>
</tr>
<tr class="row-odd"><td><p>sqlite</p></td>
<td><p>pydal.adapters.sqlite.SQLite</p></td>
</tr>
<tr class="row-even"><td><p>sqlite:memory</p></td>
<td><p>pydal.adapters.sqlite.SQLite</p></td>
</tr>
<tr class="row-odd"><td><p>sybase</p></td>
<td><p>pydal.adapters.mssql.Sybase</p></td>
</tr>
<tr class="row-even"><td><p>teradata</p></td>
<td><p>pydal.adapters.teradata.Teradata</p></td>
</tr>
<tr class="row-odd"><td><p>vertica</p></td>
<td><p>pydal.adapters.mssql.Vertica</p></td>
</tr>
</tbody>
</table>
<p>the uri string is then parsed in more detail by the adapter itself.
An updated list of adapters can be obtained as dictionary with</p>
<p>For any adapter you can replace the driver with a different one
globally (not thread safe):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">MySQLdb</span> <span class="k">as</span> <span class="nn">mysqldb</span>
<span class="kn">from</span> <span class="nn">pydal.adapters.mysql</span> <span class="kn">import</span> <span class="n">SQLAdapter</span>
<span class="n">SQLAdapter</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">mysqldb</span>
</pre></div>
</div>
<p>isto é `` mysqldb`` tem de ser * que * módulo com um método .Connect (). Você pode especificar argumentos motorista opcionais e argumentos adaptador:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">driver_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">adapter_args</span><span class="o">=</span><span class="p">{})</span>
</pre></div>
</div>
<p>For recognized adapters you can also simply specify the name in the
<code class="docutils literal notranslate"><span class="pre">adapter_args</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pydal.adapters.mysql</span> <span class="kn">import</span> <span class="n">MySQL</span>
<span class="k">assert</span> <span class="s2">&quot;mysqldv&quot;</span> <span class="ow">in</span> <span class="n">MySQL</span><span class="o">.</span><span class="n">drivers</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">driver_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">adapter_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;mysqldb&quot;</span><span class="p">})</span>
</pre></div>
</div>
</section>
<section id="sqlite">
<h3>SQLite<a class="headerlink" href="#sqlite" title="Link permanente para este título"></a></h3>
<p>SQLite does not support dropping and altering columns. That means that
py4web migrations will work up to a point. If you delete a field from a
table, the column will remain in the database but will be invisible to
py4web. If you decide to reinstate the column, py4web will try re-create
it and fail. In this case you must set <code class="docutils literal notranslate"><span class="pre">fake_migrate=True</span></code> so that
metadata is rebuilt without attempting to add the column again. Also,
for the same reason, SQLite is not aware of any change of column
type. If you insert a number in a string field, it will be stored as
string. If you later change the model and replace the type “string” with
type “integer”, SQLite will continue to keep the number as a string and
this may cause problem when you try to extract the data.</p>
<p>SQLite não tem um tipo booleano. py4web mapeia internamente booleans para uma strings de 1 carácter, com ‘T’ e ‘F’ representar Verdadeiro e Falso. A DAL lida com isso completamente; a abstração de um verdadeiro valor booleano funciona bem. Mas se você estiver atualizando a tabela SQLite com o SQL diretamente, estar ciente da implementação py4web, e evitar o uso de 0 e 1 valores.</p>
</section>
<section id="mysql">
<h3>MySQL<a class="headerlink" href="#mysql" title="Link permanente para este título"></a></h3>
<p>MySQL does not support multiple ALTER TABLE within a single transaction.
This means that any migration process is broken into multiple commits.
If something happens that causes a failure it is possible to break a
migration (the py4web metadata are no longer in sync with the actual
table structure in the database). This is unfortunate but it can be
prevented (migrate one table at the time) or it can be fixed in the
aftermath (revert the py4web model to what corresponds to the table
structure in database, set <code class="docutils literal notranslate"><span class="pre">fake_migrate=True</span></code> and after the metadata
has been rebuilt, set <code class="docutils literal notranslate"><span class="pre">fake_migrate=False</span></code> and migrate the table
again).</p>
</section>
<section id="google-sql">
<h3>Google SQL<a class="headerlink" href="#google-sql" title="Link permanente para este título"></a></h3>
<p>Google SQL has the same problems as MySQL and more. In particular table
metadata itself must be stored in the database in a table that is not
migrated by py4web. This is because Google App Engine has a read-only
file system. PY4WEB migrations in Google SQL combined with the MySQL
issue described above can result in metadata corruption. Again, this can
be prevented (by migrating the table at once and then setting
migrate=False so that the metadata table is not accessed any more) or it
can fixed in the aftermath (by accessing the database using the Google
dashboard and deleting any corrupted entry from the table called
<code class="docutils literal notranslate"><span class="pre">py4web_filesystem</span></code>.</p>
</section>
<section id="mssql-microsoft-sql-server">
<h3>MSSQL (Microsoft SQL Server)<a class="headerlink" href="#mssql-microsoft-sql-server" title="Link permanente para este título"></a></h3>
<p>não MSSQL &lt;2012 não suporta o SQL OFFSET palavra-chave. Portanto, o banco de dados não pode fazer a paginação. Ao fazer um `` limitby = (a, b) `` py4web vai buscar a primeira `` a + b`` linhas e descartar o primeiro `` a``. Isto pode resultar numa sobrecarga considerável quando comparado com outros bancos de dados. Se você estiver usando MSSQL&gt; = 2005, o prefixo recomendado para uso é `` mssql3: // `` que fornece um método para evitar o problema de buscar todo o conjunto de resultados não-paginado. Se você estiver em MSSQL&gt; = 2012, use `` mssql4: // `` que usa o `` OFFSET … ROWS … FETCH PRÓXIMO … ROWS ONLY`` construção para apoiar a paginação nativamente, sem sucessos de desempenho como outros backends. O `` mssql: // `` uri também reforça (por razões históricas) o uso de `` colunas text``, que são superseeded em versões mais recentes (a partir de 2005) por `` varchar (max) <code class="docutils literal notranslate"><span class="pre">.</span> <span class="pre">``</span> <span class="pre">Mssql3:</span> <span class="pre">//</span> <span class="pre">``</span> <span class="pre">e</span> <span class="pre">``</span> <span class="pre">mssql4:</span> <span class="pre">//</span> <span class="pre">``</span> <span class="pre">deve</span> <span class="pre">ser</span> <span class="pre">usado</span> <span class="pre">se</span> <span class="pre">você</span> <span class="pre">não</span> <span class="pre">quer</span> <span class="pre">enfrentar</span> <span class="pre">algumas</span> <span class="pre">limitações</span> <span class="pre">do</span> <span class="pre">-</span> <span class="pre">oficialmente</span> <span class="pre">obsoleto</span> <span class="pre">-</span> <span class="pre">``</span> <span class="pre">colunas</span> <span class="pre">text</span></code>.</p>
<p>MSSQL tem problemas com referências circulares em tabelas que têm onDelete CASCADE. Este é um bug MSSQL e você trabalhar em torno dele, definindo o atributo onDelete para todos os campos de referência a “nenhuma acção”. Você também pode fazê-lo uma vez por todas, antes de definir tabelas:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;mssql://....&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">types</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39; ON DELETE </span><span class="si">%(on_delete_action)s</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_adapter</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(on_delete_action)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;NO ACTION&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>MSSQL também tem problemas com argumentos passados ​​para a palavra-chave DISTINCT e, portanto Enquanto isso funciona,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">distinct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>isso não faz</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">distinct</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">mytable</span><span class="o">.</span><span class="n">myfield</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="oracle">
<h3>Oráculo<a class="headerlink" href="#oracle" title="Link permanente para este título"></a></h3>
<p>A Oracle também não suporta a paginação. Ele não suporta nem a OFFSET nem as palavras-chave limite. PY4WEB alcança a paginação, traduzindo um `` db (…). Select (limitby = (a, b)) `` em um complexo de três vias SELECT aninhada (como sugerido por documentação oficial Oracle). Isso funciona para simples escolha, mas pode quebrar para seleciona complexos envolvendo campos e ou junta alias.</p>
</section>
<section id="google-nosql-datastore">
<h3>Google NoSQL (Datastore)<a class="headerlink" href="#google-nosql-datastore" title="Link permanente para este título"></a></h3>
<p>Google NoSQL (Datastore) não permite que se junta, deixou junta, agregados, expressão ou envolvendo mais de uma tabela, o ‘como’ pesquisas operador em campos “texto”.</p>
<p>As transações são limitados e não fornecida automaticamente pelo py4web (você precisa usar a API do Google `` run_in_transaction`` que você pode procurar na documentação do Google App Engine online).</p>
<p>O Google também limita o número de registros que você pode recuperar em cada uma consulta (1000, no momento da escrita). No Google armazenamento de dados IDs de registro são inteiro, mas eles não são seqüenciais. Enquanto em SQL “lista: string” tipo é mapeado em um tipo de “texto”, no Google Datastore é mapeado em um `` ListStringProperty``. Da mesma forma “lista: número inteiro” e “lista: referência” são mapeados para `` ListProperty``. Isso faz buscas por conteúdo dentro desses campos tipos mais eficientes no Google NoSQL que em bancos de dados SQL.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Rodapé">
        <a href="chapter-06.html" class="btn btn-neutral float-left" title="Fixures" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Anterior</a>
        <a href="chapter-08.html" class="btn btn-neutral float-right" title="The RestAPI" accesskey="n" rel="next">Seguinte <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, BSDv3 License.</p>
  </div>

  Compilado com <a href="https://www.sphinx-doc.org/">Sphinx</a> usando um
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">tema</a>
    fornecido por <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      
      
     <span class="fa fa-element">
     <input class="container_toggle" type="checkbox" id="switch" name="mode">
     <label for="switch"></label>
     </span>
      
      v: 1.20220222.1
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl>
        <dt>Idiomas</dt>
        
          
          
          <dd><a href="../en/index.html">en</a></dd> 
        
           <strong> 
          <dd><a href="../pt/index.html">pt</a></dd> </strong>
          
        
      </dl>
      
      
      <dl>
        <dt>Versões</dt>
        
          
          <dd><a href="index.html">current</a></dd>
          
        
      </dl>
      
      
      <dl>
        <dt>Transferências</dt>
        
          <dd><a href="py4web_pt.pdf">pdf</a></dd>
        
          <dd><a href="py4web_pt.epub">epub</a></dd>
        
      </dl>
      
      
      <hr/>
    </div>
  </div>

 <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
         .wy-nav-content { max-width: none; }
  </style>



</body>
</html>