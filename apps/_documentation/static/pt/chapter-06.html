

<!DOCTYPE html>
<html class="writer-html5" lang="pt" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Fixures &mdash; Documentação py4web 1.20210119.1&#34;
</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/toggle.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/js/toggle.js"></script>
        <script src="_static/translations.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Índice" href="genindex.html" />
    <link rel="search" title="Pesquisar" href="search.html" />
    <link rel="next" title="The Database Abstraction Layer (DAL)" href="chapter-07.html" />
    <link rel="prev" title="Criando seu primeiro aplicativo" href="chapter-05.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> py4web
          

          
          </a>

          
            
            
              <div class="version">
                1.20210119.1"

              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Conteúdo:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="chapter-01.html">O que é py4web?</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-02.html">Ajuda, recursos e dicas</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-03.html">Instalação e colocação em funcionamento</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-04.html">O Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-05.html">Criando seu primeiro aplicativo</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Fixures</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#important-about-fixtures">Importante sobre Fixures</a></li>
<li class="toctree-l2"><a class="reference internal" href="#py4web-templates">Templates Py4web</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-session-fixture">The Session fixture</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#session-in-memcache">Sessão em memcache</a></li>
<li class="toctree-l3"><a class="reference internal" href="#session-in-redis">Sessão em Redis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#session-in-database">Sessão no banco de dados</a></li>
<li class="toctree-l3"><a class="reference internal" href="#session-anywhere">Sessão em qualquer lugar</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#the-translator-fixture">The Translator fixture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-flash-fixture">O fixture flash</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-dal-fixture">O fixture DAL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#caveats-about-fixtures">Caveats about fixtures</a></li>
<li class="toctree-l2"><a class="reference internal" href="#custom-fixtures">Fixtures personalizados</a></li>
<li class="toctree-l2"><a class="reference internal" href="#auth-and-auth-user-fixture">auth and auth.user fixture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#caching-and-memoize">Caching e Memoize</a></li>
<li class="toctree-l2"><a class="reference internal" href="#convenience-decorators">Decoradores de conveniência</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="chapter-07.html">The Database Abstraction Layer (DAL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-08.html">A RESTAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-09.html">Linguagem de template YATL</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-10.html">Helpers YATL</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-11.html">Internacionalização</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-12.html">Forumlários</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-13.html">Autenticação e controle de acesso</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-14.html">Rede</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-15.html">De web2py para py4web</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">py4web</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Fixures</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/web2py/py4web/blob/master/docs/chapter-06.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="fixtures">
<h1>Fixures<a class="headerlink" href="#fixtures" title="Link permanente para este título">¶</a></h1>
<p>Um fixture é definido como “uma peça de equipamento ou de mobiliário, que é fixa em posição num edifício ou veículo”. No nosso caso, um dispositivo elétrico é algo ligado à ação que processa um pedido HTTP, a fim de produzir uma resposta.</p>
<p>Ao processar qualquer solicitações HTTP existem algumas operações opcionais que pode desejar executar. Por exemplo parse o cookie para procurar informações sessão, confirmar uma transação de banco de dados, determinar o idioma preferido do cabeçalho HTTP e lookup internacionalização adequada, etc. Essas operações são opcionais. Algumas ações precisam deles e algumas ações não. Eles também podem depender um do outro. Por exemplo, se as sessões são armazenadas no banco de dados e nossa ação precisa dele, talvez seja necessário analisar o cookie de sessão a partir do cabeçalho, pegar uma conexão do pool de conexão do banco de dados, e - após a ação foi executada - salvar a sessão de volta no banco de dados se os dados foram alterados.</p>
<p>Fixtures PY4WEB fornecem um mecanismo para especificar o que uma ação necessidades para que py4web pode realizar as tarefas necessárias (e ignorar os não necessários) da maneira mais eficiente. Fixures tornar o código eficiente e reduzir a necessidade de código clichê.</p>
<p>Fixtures PY4WEB são semelhantes aos middleware WSGI e BottlePy plug-in, exceto que eles se aplicam a ações individuais, não para todos eles, e pode dependem uns dos outros.</p>
<p>PY4WEB vem com alguns jogos pré-definidos para as ações que precisam sessões, conexões de banco de dados, internacionalização, autenticação e templates. A sua utilização será explicado neste capítulo. O desenvolvedor também é livre para adicionar Fixtures, por exemplo, para lidar com uma terceira língua template do partido ou a lógica sessão de terceiros.</p>
<div class="section" id="important-about-fixtures">
<h2>Importante sobre Fixures<a class="headerlink" href="#important-about-fixtures" title="Link permanente para este título">¶</a></h2>
<p>As we’ve seen in the previous chapter, fixtures are the arguments of the decorator
<code class="docutils literal notranslate"><span class="pre">&#64;action.uses(...)</span></code>. You can specify
multiple fixtures in one decorator or you can have multiple decorators.</p>
<p>Also, fixtures can be applied in groups. For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>preferred = action.uses(session, auth, T, flash)
</pre></div>
</div>
<p>Então você pode aplicar todo o ao mesmo tempo com:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>@action(&#39;index.html&#39;)
@preferred
def index():
    return dict()
</pre></div>
</div>
</div>
<div class="section" id="py4web-templates">
<h2>Templates Py4web<a class="headerlink" href="#py4web-templates" title="Link permanente para este título">¶</a></h2>
<p>PY4WEB by default uses the yatl template language and provides a
fixture for it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">action</span>
<span class="kn">from</span> <span class="nn">py4web.core</span> <span class="kn">import</span> <span class="n">Template</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">delimiters</span><span class="o">=</span><span class="s1">&#39;[[ ]]&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Hello world&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Nota: Este exemplo assume que você criou o aplicativo da App andaimes, para que o index.html template já é criado para você.</p>
<p>O objeto template é um dispositivo elétrico. Ele transforma o `` dict () “ <cite>retornado pela ação em uma string usando o arquivo</cite> <cite>template index.html`</cite>. Em um capítulo posterior iremos fornecer um exemplo de como definir um fixture personalizado para usar uma linguagem de template diferente, por exemplo Jinja2.</p>
<p>Tenha em conta que uma vez que o uso de templates é muito comum e uma vez que, muito provavelmente, cada ação usa um template diferente, nós fornecemos um pouco de açúcar sintático, e as duas linhas a seguir são equivalentes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">Template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">delimiters</span><span class="o">=</span><span class="s1">&#39;[[ ]]&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Observe que arquivos de template py4web são armazenados em cache na memória RAM. O objecto py4web cache é descrito mais tarde.</p>
</div>
<div class="section" id="the-session-fixture">
<h2>The Session fixture<a class="headerlink" href="#the-session-fixture" title="Link permanente para este título">¶</a></h2>
<p>Simply speaking, a session can be defined as a way to preserve information that is
desired to persist throughout the user’s interaction with the web site or web application.
In other words, sessions render the stateless HTTP connection a stateful one.
It can be implemented server-side or client-side (by using cookies).</p>
<p>In py4web, the session object is also a Fixture. Here is a typical example of usage
to implement a counter.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>from py4web import Session, action
session = Session(secret=&#39;my secret key&#39;)

@action(&#39;index&#39;)
@action.uses(session)
def index():
    counter = session.get(&#39;counter&#39;, -1)
    counter += 1
    session[&#39;counter&#39;] = counter
    return &quot;counter = %i&quot; % counter
</pre></div>
</div>
<p>Observe que o objeto da sessão tem a mesma interface como um dicionário Python.</p>
<p>By default the session object is stored in a cookie called, signed and
encrypted, using the provided secret. If the secret changes existing
sessions are invalidated. If the user switches from HTTP to HTTPS or
vice versa, the user session is invalidated. Session in cookies have a
small size limit (4 kbytes after being serialized and encrypted) so do
not put too much into them.</p>
<p>Em py4web sessões são dicionários, mas eles são armazenados usando JSON (JWT especificamente), portanto, você só deve armazenar objetos que são JSON serializado. Se o objeto não é JSON serializado, ele vai ser serializado usando o `` operador __str__`` e algumas informações podem ser perdidas.</p>
<p>Por padrão sessões py4web nunca expiram (a menos que contenham informações de login, mas isso é outra história), mesmo se uma expiração pode ser definido. Outros parâmetros podem ser especificados, bem como:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>session = Session(secret=&#39;my secret key&#39;,
                  expiration=3600,
                  algorithm=&#39;HS256&#39;,
                  storage=None,
                  same_site=&#39;Lax&#39;)
</pre></div>
</div>
<ul class="simple">
<li><p>Aqui `` algorithm`` é o algoritmo a ser usado para a assinatura de token JWT.</p></li>
<li><p>`` Storage`` é um parâmetro que permite especificar um método alternativo de armazenamento de sessão (por exemplo, redis, ou base de dados).</p></li>
<li><p>`` Same_site`` é uma opção que impede CSRF ataques e é ativado por padrão. Você pode ler mais sobre ele <cite>aqui &lt;https://www.owasp.org/index.php/SameSite&gt;</cite> __.</p></li>
</ul>
<div class="section" id="session-in-memcache">
<h3>Sessão em memcache<a class="headerlink" href="#session-in-memcache" title="Link permanente para este título">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">memcache</span><span class="o">,</span> <span class="nn">time</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">memcache</span><span class="o">.</span><span class="n">Client</span><span class="p">([</span><span class="s1">&#39;127.0.0.1:11211&#39;</span><span class="p">],</span> <span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span>
</pre></div>
</div>
<p>Observe que um segredo não é necessária quando o armazenamento de cookies no memcache porque neste caso o cookie contém apenas o UUID da sessão.</p>
</div>
<div class="section" id="session-in-redis">
<h3>Sessão em Redis<a class="headerlink" href="#session-in-redis" title="Link permanente para este título">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">redis</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">set</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">cs</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">set</span><span class="p">,</span> <span class="n">ct</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">ttl</span><span class="p">:</span> <span class="p">(</span><span class="n">cs</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="n">e</span> <span class="ow">and</span> <span class="n">ct</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span>
</pre></div>
</div>
<p>Aviso: um objecto de armazenamento deve ter `` `` GET`` e métodos set`` e do método <cite>set`</cite> deve permitir especificar uma expiração. O objecto de ligação redis tem um método <cite>ttl`</cite> para especificar a expiração, remendo, portanto, que o macaco` <cite>método set`</cite> ter a assinatura esperada e funcionalidade.</p>
</div>
<div class="section" id="session-in-database">
<h3>Sessão no banco de dados<a class="headerlink" href="#session-in-database" title="Link permanente para este título">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">DAL</span>
<span class="kn">from</span> <span class="nn">py4web.utils.dbstore</span> <span class="kn">import</span> <span class="n">DBStore</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite:memory&#39;</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span>  <span class="n">Session</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">DBStore</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Caution:</strong> Keep in mind that <code class="docutils literal notranslate"><span class="pre">'sqlite:memory'</span></code> <strong>cannot be used in multiprocess environment</strong>, the quirk is that your application will still work but in non-deterministic and unsafe mode, since each process/worker will have its own independent in-memory database.</p>
<p>Um segredo não é necessária quando o armazenamento de cookies no banco de dados porque, neste caso, o cookie contém apenas o UUID da sessão.</p>
<p>Also this is one case when a fixture (session) requires another
fixture (db). This is handled automatically by py4web and the following
are equivalent:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="session-anywhere">
<h3>Sessão em qualquer lugar<a class="headerlink" href="#session-anywhere" title="Link permanente para este título">¶</a></h3>
<p>Você pode facilmente armazenar sessões em qualquer lugar que você quer. Tudo que você precisa fazer é fornecer ao objeto `` Session`` um objeto `` storage`` com ambos os `` GET`` e `` métodos set``. Por exemplo, imagine que você deseja armazenar sessões no seu sistema de arquivos local:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">class</span> <span class="nc">FSStorage</span><span class="p">:</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="n">folder</span>
   <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
       <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
       <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
           <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
              <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
       <span class="k">return</span> <span class="kc">None</span>
   <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">expiration</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
       <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
       <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
           <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">FSStorage</span><span class="p">(</span><span class="s1">&#39;/tmp/sessions&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Deixamos-lhe como um exercício para implementar validade, limitar o número de arquivos por pasta usando subpastas, e implementar o bloqueio de arquivos. No entanto, nós não recomment armazenar sessões no sistema de arquivos: é ineficiente e não escala bem.</p>
</div>
</div>
<div class="section" id="the-translator-fixture">
<h2>The Translator fixture<a class="headerlink" href="#the-translator-fixture" title="Link permanente para este título">¶</a></h2>
<p>Aqui está um exemplo de uso:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">action</span><span class="p">,</span> <span class="n">Translator</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">T_FOLDER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;translations&#39;</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">Translator</span><span class="p">(</span><span class="n">T_FOLDER</span><span class="p">)</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="s1">&#39;Hello world&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>A string ‘Olá mundo ` será traduzido com base no arquivo de internacionalização em ‘traduções’ especificados pasta que melhor corresponde ao HTTP `` aceitar-language`` cabeçalho.</p>
<p>Aqui `` Translator`` é uma classe py4web que se estende `` pluralize.Translator`` e também implementa a interface de `` Fixture``.</p>
<p>Podemos facilmente combinar vários Fixtures. Aqui, como exemplo, podemos tornar a acção com um contador que conta “visitas”.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">action</span><span class="p">,</span> <span class="n">Session</span><span class="p">,</span> <span class="n">Translator</span><span class="p">,</span> <span class="n">DAL</span>
<span class="kn">from</span> <span class="nn">py4web.utils.dbstore</span> <span class="kn">import</span> <span class="n">DBStore</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite:memory&#39;</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span>  <span class="n">Session</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">DBStore</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
<span class="n">T_FOLDER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;translations&#39;</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">Translator</span><span class="p">(</span><span class="n">T_FOLDER</span><span class="p">)</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;counter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="s2">&quot;You have been here </span><span class="si">{n}</span><span class="s2"> times&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">counter</span><span class="p">))</span>
</pre></div>
</div>
<p>Agora crie o seguinte arquivo de tradução `` traduções / en.json``:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;You have been here {n} times&quot;</span><span class="p">:</span>
  <span class="p">{</span>
    <span class="nt">&quot;0&quot;</span><span class="p">:</span> <span class="s2">&quot;This your first time here&quot;</span><span class="p">,</span>
    <span class="nt">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;You have been here once before&quot;</span><span class="p">,</span>
    <span class="nt">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;You have been here twice before&quot;</span><span class="p">,</span>
    <span class="nt">&quot;3&quot;</span><span class="p">:</span> <span class="s2">&quot;You have been here {n} times&quot;</span><span class="p">,</span>
    <span class="nt">&quot;6&quot;</span><span class="p">:</span> <span class="s2">&quot;You have been here more than 5 times&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Ao visitar este site com o navegador preferência de idioma definida para Inglês e recarregar várias vezes você receberá as seguintes mensagens:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>This your first time here
You have been here once before
You have been here twice before
You have been here 3 times
You have been here 4 times
You have been here 5 times
You have been here more than 5 times
</pre></div>
</div>
<p>Agora tente criar um arquivo chamado `` traduções / it.json`` que contém:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;You have been here {n} times&quot;</span><span class="p">:</span>
  <span class="p">{</span>
    <span class="nt">&quot;0&quot;</span><span class="p">:</span> <span class="s2">&quot;Non ti ho mai visto prima&quot;</span><span class="p">,</span>
    <span class="nt">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;Ti ho gia&#39; visto&quot;</span><span class="p">,</span>
    <span class="nt">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;Ti ho gia&#39; visto 2 volte&quot;</span><span class="p">,</span>
    <span class="nt">&quot;3&quot;</span><span class="p">:</span> <span class="s2">&quot;Ti ho visto {n} volte&quot;</span><span class="p">,</span>
    <span class="nt">&quot;6&quot;</span><span class="p">:</span> <span class="s2">&quot;Ti ho visto piu&#39; di 5 volte&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>e definir preferência seu navegador para Italiano.</p>
</div>
<div class="section" id="the-flash-fixture">
<h2>O fixture flash<a class="headerlink" href="#the-flash-fixture" title="Link permanente para este título">¶</a></h2>
<p>It is common to want to display “alerts” to the users. Here we refer to
them as <strong>flash messages</strong>. There is a little more to it than just
displaying a message to the view because flash messages can have state
that must be preserved after redirection. Also they can be generated
both server side and client side, there can be only one at the time,
they may have a type, and they should be dismissible.</p>
<p>O auxiliar o Flash lida com o lado do servidor deles. Aqui está um exemplo:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>from py4web import Flash

flash = Flash()

@action(&#39;index&#39;)
@action.uses(flash)
def index():
    flash.set(&quot;Hello World&quot;, _class=&quot;info&quot;, sanitize=True)
    return dict()
</pre></div>
</div>
<p>e no template:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>...
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;py4web-flash&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
...
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;js/utils.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
[[if globals().get(&#39;flash&#39;):]]<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="nx">utils</span><span class="p">.</span><span class="nx">flash</span><span class="p">([[</span><span class="o">=</span><span class="nx">XML</span><span class="p">(</span><span class="nx">flash</span><span class="p">)]]);&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>[[pass]]
</pre></div>
</div>
<p>By setting the value of the message in the flash helper, a flash
variable is returned by the action and this trigger the JS in the
template to inject the message in the <code class="docutils literal notranslate"><span class="pre">py4web-flash</span></code> DIV which you
can position at your convenience. Also the optional class is applied to
the injected HTML.</p>
<p>Se uma página é redirecionada depois de um flash está definido, o flash é lembrado. Isto é conseguido por pedir o navegador para manter a mensagem temporariamente em um cookie de uma só vez. Depois de redirecionamento a mensagem é enviada de volta pelo navegador para o servidor e os conjuntos de servidor ele novamente automaticamente antes de retornar o conteúdo, a menos que seja substituído por um outro conjunto.</p>
<p>O cliente também pode definir / adicionar mensagens flash chamando:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>utils.flash({&#39;message&#39;: &#39;hello world&#39;, &#39;class&#39;: &#39;info&#39;});
</pre></div>
</div>
<p>py4web defaults to an alert class called <code class="docutils literal notranslate"><span class="pre">info</span></code> and most CSS
frameworks define classes for alerts called <code class="docutils literal notranslate"><span class="pre">success</span></code>, <code class="docutils literal notranslate"><span class="pre">error</span></code>,
<code class="docutils literal notranslate"><span class="pre">warning</span></code>, <code class="docutils literal notranslate"><span class="pre">default</span></code>, and <code class="docutils literal notranslate"><span class="pre">info</span></code>. Yet, there is nothing in py4web
that hardcodes those names. You can use your own class names.</p>
</div>
<div class="section" id="the-dal-fixture">
<h2>O fixture DAL<a class="headerlink" href="#the-dal-fixture" title="Link permanente para este título">¶</a></h2>
<p>Nós já usou o `` dispositivo elétrico DAL`` no contexto das sessões, mas talvez você queira ter acesso direto ao objeto DAL com a finalidade de acessar o banco de dados, e não apenas sessões.</p>
<p>PY4WEB, by default, uses the PyDAL (Python Database Abstraction Layer)
which is documented in the next chapter. Here is an example, please
remember to create the <code class="docutils literal notranslate"><span class="pre">databases</span></code> folder under your project in case
it doesn’t exist:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">action</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">DB_FOLDER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;databases&#39;</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.db&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">DB_FOLDER</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;visit_log&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;client_ip&#39;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">))</span>
<span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">client_ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">visit_log</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">client_ip</span><span class="o">=</span><span class="n">client_ip</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
    <span class="k">return</span> <span class="s2">&quot;Your visit was stored in database&quot;</span>
</pre></div>
</div>
<p>Notice that the database fixture defines (creates/re-creates) tables
automatically when py4web starts (and every time it reloads this app)
and picks a connection from the connection pool at every HTTP request.
Also each call to the <code class="docutils literal notranslate"><span class="pre">index()</span></code> action is wrapped into a transaction
and it commits <code class="docutils literal notranslate"><span class="pre">on_success</span></code> and rolls back <code class="docutils literal notranslate"><span class="pre">on_error</span></code>.</p>
</div>
<div class="section" id="caveats-about-fixtures">
<h2>Caveats about fixtures<a class="headerlink" href="#caveats-about-fixtures" title="Link permanente para este título">¶</a></h2>
<p>Desde fixtures são compartilhados por várias ações que você não tem permissão para alterar seu estado, porque não seria seguro para threads. Há uma exceção a esta regra. As ações podem alterar alguns atributos de campos de banco de dados:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">action</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">py4web.utils.form</span> <span class="kn">import</span> <span class="n">Form</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">DB_FOLDER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;databases&#39;</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.db&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">DB_FOLDER</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;thing&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">writable</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;generic.html&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">writable</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">thing</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></div>
</div>
<p>Nota thas este código só será capaz de exibir um formulário, para processá-lo depois de apresentar, necessidades código adicional para ser adicionado, como veremos mais tarde. Este exemplo supõe que você criou o aplicativo da App andaimes, de modo que um generic.html já é criado para você.</p>
<p>A `` readable``, `` writable``, `` default``, `` update``, e atributos `` `` require`` de db. {Tabela}. {Campo} `` são objectos especiais de classe `` ThreadSafeVariable`` definido a `` threadsafevariable`` módulo. Esses objetos são muito parecidos com Python rosca objetos locais, mas eles estão em todos os pedidos utilizando o valor fora da ação especificada inicializado-re. Isto significa que as ações podem mudar com segurança os valores desses atributos.</p>
</div>
<div class="section" id="custom-fixtures">
<h2>Fixtures personalizados<a class="headerlink" href="#custom-fixtures" title="Link permanente para este título">¶</a></h2>
<p>Um fixture é um objecto com a seguinte estrutura mínima:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">Fixture</span>

<span class="k">class</span> <span class="nc">MyFixture</span><span class="p">(</span><span class="n">Fixture</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">on_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">on_success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span> <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
<p>If an action uses this fixture:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>@action(&#39;index&#39;)
@action.uses(MyFixture())
def index(): return &#39;hello world&#39;
</pre></div>
</div>
<p>then:</p>
<ul class="simple">
<li><p>the <code class="docutils literal notranslate"><span class="pre">on_request()</span></code> function is guaranteed to be called before the <code class="docutils literal notranslate"><span class="pre">index()</span></code>
function is called</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">on_success()</span></code> function is guaranteed to be called if
the <code class="docutils literal notranslate"><span class="pre">index()</span></code> function returns successfully or raises <code class="docutils literal notranslate"><span class="pre">HTTP</span></code> or
performs a <code class="docutils literal notranslate"><span class="pre">redirect</span></code></p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">on_error()</span></code> function is guaranteed to be called
when the <code class="docutils literal notranslate"><span class="pre">index()</span></code> function raises any exception other than <code class="docutils literal notranslate"><span class="pre">HTTP</span></code>.</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">transform</span></code> function is called to perform any desired
transformation of the value returned by the <code class="docutils literal notranslate"><span class="pre">index()</span></code> function.</p></li>
</ul>
</div>
<div class="section" id="auth-and-auth-user-fixture">
<h2>auth and auth.user fixture<a class="headerlink" href="#auth-and-auth-user-fixture" title="Link permanente para este título">¶</a></h2>
<p>`` Auth`` e `` auth.user`` são ambos os jogos. Eles dependem de `` session``. O papel do acesso é fornecer a ação com informações de autenticação. Ele é utilizado como segue:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">action</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">Session</span><span class="p">,</span> <span class="n">DAL</span><span class="p">,</span> <span class="n">URL</span>
<span class="kn">from</span> <span class="nn">py4web.utils.auth</span> <span class="kn">import</span> <span class="n">Auth</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">secret</span><span class="o">=</span><span class="s1">&#39;my secret key&#39;</span><span class="p">)</span>
<span class="n">DB_FOLDER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;databases&#39;</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DAL</span><span class="p">(</span><span class="s1">&#39;sqlite://storage.db&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">DB_FOLDER</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">auth</span> <span class="o">=</span> <span class="n">Auth</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
<span class="n">auth</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span> <span class="ow">or</span> <span class="n">redirect</span><span class="p">(</span><span class="n">URL</span><span class="p">(</span><span class="s1">&#39;auth/login&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;Welcome </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;first_name&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>O construtor do objeto `` Auth`` define a tabela `` auth_user`` com os seguintes campos: nome de usuário, e-mail, senha, first_name, last_name, sso_id e action_token (os dois últimos são principalmente para uso interno).</p>
<p>`` Auth.enable () `` registadoras múltiplas acções incluindo `` {nomeaplic} / auth / login`` e que exige a presença de a `` auth.html`` molde e a `` auth`` componente valor fornecido pela o `` aplicativo _scaffold``.</p>
<p>O objeto `` auth`` é a fixure. Ele gerencia as informações do usuário. Ela expõe um único método:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>auth.get_user()
</pre></div>
</div>
<p>which returns a python dictionary containing the information of the
currently logged in user. If the user is not logged-in, it returns
<code class="docutils literal notranslate"><span class="pre">None</span></code> and in this case the code of the example redirects to the
<code class="docutils literal notranslate"><span class="pre">auth/login</span></code> page.</p>
<p>Desde essa verificação é muito comum, py4web fornece um fixture adicional `` auth.user``:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;Welcome </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;first_name&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Este fixture redireciona automaticamente para a página login`` `` auth / se o usuário não está conectado. Depende de `` auth``, que depende `` db`` e `` session``.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">auth</span></code> fixture is plugin based and supports multiple plugin
methods. They include OAuth2 (Google, Facebook, Twitter), PAM, LDAP, and
SMAL2.</p>
<p>Here is an example of using the Google OAuth2 plugin:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web.utils.auth_plugins.oauth2google</span> <span class="kn">import</span> <span class="n">OAuth2Google</span>
<span class="n">auth</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="n">OAuth2Google</span><span class="p">(</span>
    <span class="n">client_id</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="p">,</span>
    <span class="n">client_secret</span><span class="o">=</span><span class="s1">&#39;...&#39;</span><span class="p">,</span>
    <span class="n">callback_url</span><span class="o">=</span><span class="s1">&#39;auth/plugin/oauth2google/callback&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">client_id</span></code> and <code class="docutils literal notranslate"><span class="pre">client_secret</span></code> are provided by Google. The
callback url is the default option for py4web and it must be whitelisted
with Google.
All <code class="docutils literal notranslate"><span class="pre">auth</span></code> plugins are objects. Different plugins are
configured in different ways but they are registered using
<code class="docutils literal notranslate"><span class="pre">auth.register_plugin(...)</span></code>. Examples are provided in
<code class="docutils literal notranslate"><span class="pre">_scaffold/common.py</span></code>.</p>
</div>
<div class="section" id="caching-and-memoize">
<h2>Caching e Memoize<a class="headerlink" href="#caching-and-memoize" title="Link permanente para este título">¶</a></h2>
<p>py4web provides a cache in RAM object that implements the last recently
used (LRU) algorithm. It can be used to cache any function via a
decorator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">py4web</span> <span class="kn">import</span> <span class="n">Cache</span><span class="p">,</span> <span class="n">action</span>
<span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;hello/&lt;name&gt;&#39;</span><span class="p">)</span>
<span class="nd">@cache</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">expiration</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;Hello </span><span class="si">%s</span><span class="s2"> your code is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</pre></div>
</div>
<p>It will cache (memoize) the return value of the <code class="docutils literal notranslate"><span class="pre">hello</span></code> function, as
function of the input <code class="docutils literal notranslate"><span class="pre">name</span></code>, for up to 60 seconds. It will store in
cache the 1000 most recently used values. The data is always stored in
RAM.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">cache</span></code> object is not a fixture and it should not and cannot be
registered using the <code class="docutils literal notranslate"><span class="pre">&#64;action.uses</span></code> decorator but we mention it here
because some of the fixtures use this object internally. For example,
template files are cached in RAM to avoid accessing the file system
every time a template needs to be rendered.</p>
</div>
<div class="section" id="convenience-decorators">
<h2>Decoradores de conveniência<a class="headerlink" href="#convenience-decorators" title="Link permanente para este título">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">_scaffold</span></code> application, in <code class="docutils literal notranslate"><span class="pre">common.py</span></code> defines two special
convenience decorators:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>@unauthenticated
def index():
    return dict()
</pre></div>
</div>
<p>e</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>@authenticated
def index():
    return dict()
</pre></div>
</div>
<p>They apply all of the decorators below, use a template with the same
name as the function (.html), and also register a route with the name of
action followed by the number of arguments of the action separated by a
slash (/).</p>
<p>&#64;unauthenticated não requer que o usuário seja identificado. &#64;authenticated necessário que o usuário estar logado.</p>
<p>They can be combined with (and precede) other <code class="docutils literal notranslate"><span class="pre">&#64;action.uses(...)</span></code> but
they should not be combined with <code class="docutils literal notranslate"><span class="pre">&#64;action(...)</span></code> because they perform
that function automatically.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="chapter-07.html" class="btn btn-neutral float-right" title="The Database Abstraction Layer (DAL)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="chapter-05.html" class="btn btn-neutral float-left" title="Criando seu primeiro aplicativo" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, BSDv3 License

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      
      
     <span class="fa fa-element">
     <input class="container_toggle" type="checkbox" id="switch" name="mode">
     <label for="switch"></label>
     </span>
      
      v: 1.20210119.1"

      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl>
        <dt>Idiomas</dt>
        
          
          
          <dd><a href="../en/index.html">en</a></dd> 
        
           <strong> 
          <dd><a href="../pt/index.html">pt</a></dd> </strong>
          
        
      </dl>
      
      
      <dl>
        <dt>Versões</dt>
        
          
          <dd><a href="index.html">current</a></dd>
          
        
      </dl>
      
      
      <dl>
        <dt>Transferências</dt>
        
          <dd><a href="py4web_pt.pdf">pdf</a></dd>
        
          <dd><a href="py4web_pt.epub">epub</a></dd>
        
      </dl>
      
      
      <hr/>
    </div>
  </div>

 

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    

  <style>
         .wy-nav-content { max-width: none; }
  </style>



</body>
</html>