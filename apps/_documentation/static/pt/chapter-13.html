

<!DOCTYPE html>
<html class="writer-html5" lang="pt" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Autenticação e controle de acesso &mdash; Documentação py4web 1.20210119.1&#34;
</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/toggle.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/js/toggle.js"></script>
        <script src="_static/translations.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Índice" href="genindex.html" />
    <link rel="search" title="Pesquisar" href="search.html" />
    <link rel="next" title="Rede" href="chapter-14.html" />
    <link rel="prev" title="Forumlários" href="chapter-12.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> py4web
          

          
          </a>

          
            
            
              <div class="version">
                1.20210119.1"

              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Conteúdo:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="chapter-01.html">O que é py4web?</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-02.html">Ajuda, recursos e dicas</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-03.html">Instalação e colocação em funcionamento</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-04.html">O Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-05.html">Criando seu primeiro aplicativo</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-06.html">Fixures</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-07.html">The Database Abstraction Layer (DAL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-08.html">A RESTAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-09.html">Linguagem de template YATL</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-10.html">Helpers YATL</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-11.html">Internacionalização</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-12.html">Forumlários</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Autenticação e controle de acesso</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#auth-ui">Interface de autenticação</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-auth">Usando o Auth</a></li>
<li class="toctree-l2"><a class="reference internal" href="#auth-plugins">Plugins de Autenticação</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pam">PAM</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ldap">LDAP</a></li>
<li class="toctree-l3"><a class="reference internal" href="#oauth2-with-google-tested-ok">OAuth2 com Google (testado OK)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#oauth2-with-facebook-tested-ok">OAuth2 com Facebook (testado OK)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tags-and-permissions">Etiquetas e permissões</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="chapter-14.html">Rede</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter-15.html">De web2py para py4web</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">py4web</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Autenticação e controle de acesso</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/web2py/py4web/blob/master/docs/chapter-13.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="authentication-and-access-control">
<h1>Autenticação e controle de acesso<a class="headerlink" href="#authentication-and-access-control" title="Link permanente para este título">¶</a></h1>
<p>** Atenção: a API descrito neste capítulo é novo e sujeitas a alterações. Certifique-se de manter seu código atualizado **</p>
<p>py4web vem com um um objecto Auth e um sistema de encaixes para a autenticação do utilizador e de controlo de acesso. Ele tem o mesmo nome que o web2py correspondente e tem a mesma finalidade, mas a API e design interno é muito diferente.</p>
<p>Para usá-lo, em primeiro lugar você precisa importá-lo, instanciá-lo, configurá-lo, e habilitá-lo.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web.utils.auth</span> <span class="kn">import</span> <span class="n">Auth</span>
<span class="n">auth</span> <span class="o">=</span> <span class="n">Auth</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
<span class="c1"># (configure here)</span>
<span class="n">auth</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
</pre></div>
</div>
<p>A etapa de importação é óbvia. A segunda etapa não executar qualquer operação que não dizendo o objeto Auth qual objeto sessão para usar e qual banco de dados para uso. Auth dados são armazenados em `` sessão [ “user”] `` e, se um usuário estiver logado, o ID do usuário é armazenado na sessão [ ‘user’] [ ‘id’]. O objecto dB é utilizado para armazenar informação sobre o utilizador persistente numa tabela `` auth_user`` com os seguintes campos:</p>
<ul class="simple">
<li><p>nome do usuário</p></li>
<li><p>o email</p></li>
<li><p>senha</p></li>
<li><p>primeiro nome</p></li>
<li><p>último nome</p></li>
<li><p>sso_id (usado para single sign on, ver mais adiante)</p></li>
<li><p>action_token (usado para verificar e-mail, bloquear usuários e outras tarefas, também ver mais adiante).</p></li>
</ul>
<p>Se o `` auth_user`` tabela não existir ele será criado.</p>
<p>A etapa de configuração é opcional e discutida mais tarde.</p>
<p>A `` auth.enable () `` passo cria e expõe os seguintes APIs RESTful:</p>
<ul class="simple">
<li><p>{Nomeaplic} / auth / api / registo (POST)</p></li>
<li><p>{Nomeaplic} / auth / api / Login (POST)</p></li>
<li><p>{Nomeaplic} / auth / api / request_reset_password (POST)</p></li>
<li><p>{Nomeaplic} / auth / api / reset_password (POST)</p></li>
<li><p>{Appname} / auth / api / verify_email (GET, POST)</p></li>
<li><p>{Nomeaplic} / auth / api / Sair (GET, POST) (+)</p></li>
<li><p>{Nomeaplic} / auth / api / perfil (GET, POST) (+)</p></li>
<li><p>{Nomeaplic} / auth / api / change_password (POST) (+)</p></li>
<li><p>{Nomeaplic} / auth / api / change_email (POST) (+)</p></li>
</ul>
<p>Os que estão marcados com um (+) requerem um usuário conectado.</p>
<div class="section" id="auth-ui">
<h2>Interface de autenticação<a class="headerlink" href="#auth-ui" title="Link permanente para este título">¶</a></h2>
<p>Você pode criar sua própria interface do usuário da web para usuários de login usando as APIs acima, mas py4web fornece um como exemplo, implementada nos seguintes arquivos:</p>
<ul class="simple">
<li><p>_Scaffold / templates / auth.html</p></li>
<li><p>_scaffold / static / componentes / auth.js</p></li>
<li><p>_Scaffold / static / componentes / auth.html</p></li>
</ul>
<p>Os arquivos do componente (js / html) definem um componente Vue `` &lt;auth /&gt; `` que é usado na auth.html arquivo de modelo da seguinte forma:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>[[extend &quot;layout.html&quot;]]
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;vue&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;columns&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;column is-half is-offset-one-quarter&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;border : 1px solid #e1e1e1; border-radius: 10px&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">auth</span> <span class="na">plugins</span><span class="o">=</span><span class="s">&quot;local,oauth2google,oauth2facebook&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">auth</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
[[block page_scripts]]
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;js/utils.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;components/auth.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="nx">utils</span><span class="p">.</span><span class="nx">app</span><span class="p">().</span><span class="nx">start</span><span class="p">();&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
[[end]]
</pre></div>
</div>
<p>Você pode muito bem usar esse arquivo modificado-un. Estende-se o layout atual e incorpora o `` &lt;auth /&gt; `` componente na página. Em seguida, usa `` utils.app () start ();. `` (Magia py4web) para processar o conteúdo de `` &lt;div id = «vue»&gt; … &lt;/ div&gt; `` usando Vue.js. `` componentes / auth.js`` também carrega automaticamente `` componentes / auth.html`` para o espaço reservado componente (mais mágicas py4web). O componente é responsável para render o login / registo / etc formas usando reactivo html e Geting / dados de lançamento com a API de serviço de autenticação.</p>
<p>Se você precisa mudar o estilo do componente que você pode editar “componentes / auth.html” para atender às suas necessidades. É principalmente HTML com algum especial Vue `` v- * `` tags.</p>
</div>
<div class="section" id="using-auth">
<h2>Usando o Auth<a class="headerlink" href="#using-auth" title="Link permanente para este título">¶</a></h2>
<p>Há duas maneiras de usar o objeto Auth em uma ação:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;hello </span><span class="si">{first_name}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">user</span><span class="p">)</span> <span class="k">if</span> <span class="n">user</span> <span class="k">else</span> <span class="s1">&#39;not logged in&#39;</span>
</pre></div>
</div>
<p>Com `` &#64; action.uses (auth) `` nós dizemos py4web que esta ação precisa ter informações sobre o usuário, em seguida, tentar analisar a sessão para uma sessão de usuário.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;hello </span><span class="si">{first_name}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">user</span><span class="p">)</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>Aqui `` &#64; action.uses (auth.user) `` diz py4web que essa ação requer um usuário conectado e deve redirecionar para login se nenhum usuário está logado.</p>
</div>
<div class="section" id="auth-plugins">
<h2>Plugins de Autenticação<a class="headerlink" href="#auth-plugins" title="Link permanente para este título">¶</a></h2>
<p>Plugins são definidos no “py4web / utils / auth_plugins” e eles têm uma estrutura hierárquica. Alguns são exclusivos e alguns não são. Por exemplo, padrão, LDAP, PAM, e SAML são exclusivos (o desenvolvedor tem que escolher um). Padrão, o Google, Facebook e Twitter OAuth não são exclusivos (o desenvolvedor pode pegar todos eles e que o usuário começa a escolher usando a interface do usuário).</p>
<p>O `` &lt;auth /&gt; `` componentes irá se adaptar automaticamente para formulários de login de exibição, conforme exigido pelos plugins instalados.</p>
<p>** Neste momento, não podemos garantir que os seguintes plugins funcionam bem. Eles foram portados de web2py onde eles não funcionam, mas o teste ainda é necessária **</p>
<div class="section" id="pam">
<h3>PAM<a class="headerlink" href="#pam" title="Link permanente para este título">¶</a></h3>
<p>Configurando PAM é o mais fácil:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web.utils.auth_plugins.pam_plugin</span> <span class="kn">import</span> <span class="n">PamPlugin</span>
<span class="n">auth</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="n">PamPlugin</span><span class="p">())</span>
</pre></div>
</div>
<p>Este, como todos os plugins deve ser importado e registrado. Uma vez registrado o UI (componentes / auth) e as APIs RESTful sabe como lidar com isso. O construtor desta plugins não requer quaisquer argumentos (onde outros plugins fazer).</p>
<p>O `` auth.register_plugin (…) `` must ** ** vir antes do `` auth.enable () <a href="#id1"><span class="problematic" id="id2">``</span></a>, uma vez que não faz sentido para expor APIs antes de plugins desejados são montados.</p>
</div>
<div class="section" id="ldap">
<h3>LDAP<a class="headerlink" href="#ldap" title="Link permanente para este título">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web.utils.auth_plugins.ldap_plugin</span> <span class="kn">import</span> <span class="n">LDAPPlugin</span>
<span class="n">LDAP_SETTING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;ad&#39;</span><span class="p">,</span>
    <span class="s1">&#39;server&#39;</span><span class="p">:</span> <span class="s1">&#39;my.domain.controller&#39;</span><span class="p">,</span>
    <span class="s1">&#39;base_dn&#39;</span><span class="p">:</span> <span class="s1">&#39;ou=Users,dc=domain,dc=com&#39;</span>
<span class="p">}</span>
<span class="n">auth</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="n">LDAPPlugin</span><span class="p">(</span><span class="o">**</span><span class="n">LDAP_SETTINGS</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="oauth2-with-google-tested-ok">
<h3>OAuth2 com Google (testado OK)<a class="headerlink" href="#oauth2-with-google-tested-ok" title="Link permanente para este título">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web.utils.auth_plugins.oauth2google</span> <span class="kn">import</span> <span class="n">OAuth2Google</span> <span class="c1"># TESTED</span>
<span class="n">auth</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="n">OAuth2Google</span><span class="p">(</span>
    <span class="n">client_id</span><span class="o">=</span><span class="n">CLIENT_ID</span><span class="p">,</span>
    <span class="n">client_secret</span><span class="o">=</span><span class="n">CLIENT_SECRET</span><span class="p">,</span>
    <span class="n">callback_url</span><span class="o">=</span><span class="s1">&#39;auth/plugin/oauth2google/callback&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>O ID de cliente e segredo do cliente deve ser fornecido pelo Google.</p>
</div>
<div class="section" id="oauth2-with-facebook-tested-ok">
<h3>OAuth2 com Facebook (testado OK)<a class="headerlink" href="#oauth2-with-facebook-tested-ok" title="Link permanente para este título">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">py4web.utils.auth_plugins.oauth2facebook</span> <span class="kn">import</span> <span class="n">OAuth2Facebook</span> <span class="c1"># UNTESTED</span>
<span class="n">auth</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="n">OAuth2Facebook</span><span class="p">(</span>
    <span class="n">client_id</span><span class="o">=</span><span class="n">CLIENT_ID</span><span class="p">,</span>
    <span class="n">client_secret</span><span class="o">=</span><span class="n">CLIENT_SECRET</span><span class="p">,</span>
    <span class="n">callback_url</span><span class="o">=</span><span class="s1">&#39;auth/plugin/oauth2google/callback&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>O ID de cliente e segredo do cliente deve ser fornecido pelo Facebook.</p>
</div>
</div>
<div class="section" id="tags-and-permissions">
<h2>Etiquetas e permissões<a class="headerlink" href="#tags-and-permissions" title="Link permanente para este título">¶</a></h2>
<p>O Py4web não tem o conceito de grupos como web2py. A experiência mostrou que, enquanto esse mecanismo é poderoso ele sofre de dois problemas: é um exagero para a maioria dos aplicativos, e não é suficiente flexível para aplicativos muito complexos. Py4web fornece um mecanismo de marcação de uso geral que permite ao desenvolvedor tag qualquer registro de qualquer tabela, verificar a existência de marcas, bem como a verificação de registros contendo uma tag. associação de grupo pode ser considerado um tipo de tag que se aplicam aos usuários. As permissões também pode ser tags. Desenvolvedor é livre para criar sua própria lógica no topo do sistema de marcação.</p>
<p>Para usar o sistema de marcação, você precisa criar um objeto para marcar uma tabela:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">groups</span> <span class="o">=</span> <span class="n">Tags</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="p">)</span>
</pre></div>
</div>
<p>Então você pode adicionar uma ou mais marcas de registros da tabela, bem como remover existente tags:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;manager&#39;</span><span class="p">)</span>
<span class="n">groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;dancer&#39;</span><span class="p">,</span> <span class="s1">&#39;teacher&#39;</span><span class="p">])</span>
<span class="n">groups</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;dancer&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Aqui, o caso de uso é o controle de acesso baseado em grupo, onde o desenvolvedor primeiro verifica se um usuário é um membro do «grupo` <cite>manager”`</cite>, se o usuário não é um administrador (ou ninguém está logado) redirecionamentos py4web ao `` “não autorizada url”<a href="#id1"><span class="problematic" id="id2">``</span></a>. Se o usuário estiver no grupo correto, então manager Olá “py4web exibe:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;manager&#39;</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">get_user</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]):</span>
        <span class="n">redirect</span><span class="p">(</span><span class="n">URL</span><span class="p">(</span><span class="s1">&#39;not_authorized&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;hello manager&#39;</span>
</pre></div>
</div>
<p>Aqui o desenvolvedor consulta o banco de dados para todos os registros que têm a tag desejada (s):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;find_by_tag/</span><span class="si">{group_name}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="n">group_name</span><span class="p">):</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">find</span><span class="p">([</span><span class="n">group_name</span><span class="p">]))</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">orderby</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="o">.</span><span class="n">first_name</span> <span class="o">|</span> <span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="n">users</span><span class="p">}</span>
</pre></div>
</div>
<p>Deixamos para você como um exercício para criar um dispositivo elétrico `` has_membership`` para permitir a seguinte sintaxe:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">has_membership</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="s1">&#39;teacher&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;hello teacher&#39;</span>
</pre></div>
</div>
<p>** Importante: ** `` Tags`` são automaticamente hierárquica. Por exemplo, se um usuário tem um grupo tag ‘professor /-ensino médio / física’, em seguida, todas as seguintes seaches retornará o usuário:</p>
<ul class="simple">
<li><p>`` Groups.find ( “professor /-ensino médio / física”) ``</p></li>
<li><p>`` Groups.find ( “professor /-colegial”) ``</p></li>
<li><p>`` Groups.find ( “professor”) ``</p></li>
</ul>
<p>Isto significa que as barras têm um significado especial para tags. Slahes no início ou no final de uma tag são opcionais. Todos os outros caracteres são permitidos em pé de igualdade.</p>
<p>Observe que uma tabela pode ter vários associados `` Tags`` objetos. Os grupos nome aqui é completamente arbitrária, mas tem um significado semântico específico. Diferentes `` objectos Tags`` são ortogonais entre si. O limite para o seu uso é a sua criatividade.</p>
<p>Por exemplo, você poderia criar um grupos de mesa:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">define_table</span><span class="p">(</span><span class="s1">&#39;auth_group&#39;</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>e Tags:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">groups</span> <span class="o">=</span> <span class="n">Tags</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">auth_user</span><span class="p">)</span>
<span class="n">permissions</span> <span class="o">=</span> <span class="n">Tags</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">auth_groups</span><span class="p">)</span>
</pre></div>
</div>
<p>Em seguida, crie um grupo zapper, dar-lhe uma permissão, e tornar um membro do usuário do grupo:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">zap_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">auth_group</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;zapper&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;can zap database&#39;</span><span class="p">)</span>
<span class="n">permissions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">zap_id</span><span class="p">,</span> <span class="s1">&#39;zap database&#39;</span><span class="p">)</span>
<span class="n">groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;zapper&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>E você pode verificar se há uma permissão de utilizador através de uma junção explícita:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;zap&#39;</span><span class="p">)</span>
<span class="nd">@action</span><span class="o">.</span><span class="n">uses</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">zap</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
    <span class="n">permission</span> <span class="o">=</span> <span class="s1">&#39;zap database&#39;</span>
    <span class="k">if</span> <span class="n">db</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">permission</span><span class="p">))(</span>
          <span class="n">db</span><span class="o">.</span><span class="n">auth_group</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">belongs</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
          <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
        <span class="c1"># zap db</span>
        <span class="k">return</span> <span class="s1">&#39;database zapped&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;you do not belong to any group with permission to zap db&#39;</span>
</pre></div>
</div>
<p>Aviso aqui `` permissions.find (permissão) `` gera uma consulta para todos os grupos com a permissão e que ainda filtro desses grupos para aqueles do utilizador actual é membro da. Contamos eles e se encontrarmos qualquer, então o usuário tem a permissão.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="chapter-14.html" class="btn btn-neutral float-right" title="Rede" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="chapter-12.html" class="btn btn-neutral float-left" title="Forumlários" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, BSDv3 License

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      
      
     <span class="fa fa-element">
     <input class="container_toggle" type="checkbox" id="switch" name="mode">
     <label for="switch"></label>
     </span>
      
      v: 1.20210119.1"

      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl>
        <dt>Idiomas</dt>
        
          
          
          <dd><a href="../en/index.html">en</a></dd> 
        
           <strong> 
          <dd><a href="../pt/index.html">pt</a></dd> </strong>
          
        
      </dl>
      
      
      <dl>
        <dt>Versões</dt>
        
          
          <dd><a href="index.html">current</a></dd>
          
        
      </dl>
      
      
      <dl>
        <dt>Transferências</dt>
        
          <dd><a href="py4web_pt.pdf">pdf</a></dd>
        
          <dd><a href="py4web_pt.epub">epub</a></dd>
        
      </dl>
      
      
      <hr/>
    </div>
  </div>

 

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    

  <style>
         .wy-nav-content { max-width: none; }
  </style>



</body>
</html>